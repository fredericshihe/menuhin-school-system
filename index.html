<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>青岛梅纽因音乐学校练琴跟踪系统</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
/* ===============================================
   青岛梅纽因音乐学校练琴跟踪系统 - 完整样式文件
   =============================================== */

/* ===== 1. CSS变量定义 ===== */
:root {
    /* 主色调 */
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --success-color: #27ae60;
    
    /* 背景和文本 */
    --background-color: #f8f9fa;
    --card-bg: #ffffff;
    --card-hover-bg: #f8f9fa;
    --text-color: #2c3e50;
    --text-secondary: #6c757d;
    --text-muted: #adb5bd;
    --border-color: #dee2e6;
    --light-gray: #f1f3f4;
    --medium-gray: #6c757d;
    --dark-gray: #495057;
    --shadow-color: rgba(0,0,0,0.1);
    
    /* 阴影和圆角 */
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-hover: 0 5px 20px rgba(0,0,0,0.15);
    --radius: 12px;
    --radius-small: 6px;
    --radius-large: 20px;
    
    /* 移动端适配 */
    --mobile-padding: 15px;
    --mobile-font-size: 16px;
    --touch-target-size: 44px;
    
    /* 渐变色 */
    --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    --gradient-card: linear-gradient(135deg, #f8f9fa, #ffffff);
}


/* ===== 2. 基础重置和全局样式 ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    overflow-x: hidden;
}

/* ===== 3. 容器和布局 ===== */
/* 确保两个 metric-item 容器大小一致 */
.status-metrics .metric-item {
    flex: 1;
    min-width: 0;
}

/* 或者给练琴状态容器添加相同的样式类 */
.metric-item.practice-status-container {
    /* 与时间段容器相同的样式 */
}

.container {
    width: 100%;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom);
    box-sizing: border-box;
}

/* 🔥 新增：确保实时练琴状态区域没有额外的内边距 */
.container .card {
    margin-left: 0;
    margin-right: 0;
}

/* 🔥 新增：确保学生网格从最左侧开始 */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(12px, 2vw, 20px);
    width: 100%;
    padding: 0;
    margin: 0; /* 确保没有外边距 */
    padding-left: 0 !important; /* 强制去除左内边距 */
}



/* 响应式容器 */
@media (min-width: 1500px) {
    .container {
        max-width: none;
        padding: 20px 40px;
    }
}

@media (min-width: 1800px) {
    .container {
        padding: 20px 60px;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 10px;
    }
}
/* ===== 练琴状态紧凑布局样式 - 四行显示 ===== */
/* ===== 确保时间段和练琴状态容器大小完全一致 ===== */
.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: stretch; /* 🔥 改为 stretch，让所有项目高度一致 */
}

.metric-item {
    display: flex;
    align-items: flex-start; /* 🔥 顶部对齐 */
    gap: 12px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    height: 100%; /* 🔥 新增：占满容器高度 */
    box-sizing: border-box; /* 🔥 新增：确保padding计算正确 */
}

.metric-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    height: 100%; /* 🔥 新增：占满父容器高度 */
}

.metric-label {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-bottom: 6px;
    color: var(--medium-gray);
    flex-shrink: 0; /* 🔥 新增：标签不收缩 */
}

.metric-value {
    flex: 1; /* 🔥 新增：内容区域占满剩余空间 */
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* 🔥 新增：内容从顶部开始 */
}

/* ===== 练琴状态紧凑布局样式优化 ===== */
.metric-value.practice-status-compact {
    line-height: 1.4; /* 🔥 从 1.3 增加到 1.4 */
    font-size: 15px; /* 🔥 从 14px 增加到 15px */
    min-height: 95px; /* 🔥 从 80px 增加到 95px，容纳更大间距 */
    padding: 4px 0; /* 🔥 新增：上下内边距 */
}

.practice-info-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px; /* 🔥 从 4px 增加到 8px，更宽的行间距 */
    min-height: 22px; /* 🔥 从 18px 增加到 22px，更高的行高 */
    justify-content: flex-start;
    padding: 2px 0; /* 🔥 新增：每行上下内边距 */
}

.practice-info-row:last-child {
    margin-bottom: 0;
}

.practice-info-item {
    display: flex;
    align-items: center;
    gap: 6px; /* 🔥 从 4px 增加到 6px */
}

.practice-label {
    color: #666;
    font-size: 13px; /* 🔥 从 12px 增加到 13px */
    font-weight: 500; /* 🔥 从 400 增加到 500，更清晰 */
    white-space: nowrap;
    min-width: 60px; /* 🔥 从 55px 增加到 60px */
}

.practice-value {
    font-weight: 600;
    font-size: 14px; /* 🔥 从 13px 增加到 14px */
    color: var(--text-color);
}

.practice-value.current-practice {
    color: #2196F3;
    font-size: 14px; /* 🔥 保持与其他值一致 */
}

.practice-value.total-practice {
    color: var(--primary-color);
    font-size: 15px; /* 🔥 从 13px 增加到 15px，突出显示 */
    font-weight: 700; /* 🔥 增加字重，更突出 */
}

/* ===== 时间段容器对齐优化 ===== */
.time-slots-container .metric-value {
    margin-top: 0;
    line-height: 1.4; /* 🔥 从 1.3 增加到 1.4 */
    min-height: 95px; /* 🔥 从 80px 增加到 95px，与练琴状态容器保持一致 */
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding: 4px 0; /* 🔥 新增：与练琴状态保持一致的内边距 */
}

.time-slots-wrapper {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    gap: 4px; /* 🔥 从 0 增加到 4px，增加时间段标签间距 */
    margin-top: 4px; /* 🔥 从 2px 增加到 4px */
    flex: 1;
}

/* 移动端优化 */
@media (max-width: 768px) {
    .status-metrics {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .metric-value.practice-status-compact {
        min-height: 85px; /* 🔥 从 70px 增加到 85px */
        font-size: 14px; /* 🔥 保持较大字体 */
        padding: 3px 0;
    }
    
    .time-slots-container .metric-value {
        min-height: 85px; /* 🔥 从 70px 增加到 85px */
        padding: 3px 0;
    }
    
    .practice-info-row {
        margin-bottom: 6px; /* 🔥 从 3px 增加到 6px */
        min-height: 20px; /* 🔥 从 16px 增加到 20px */
        padding: 1px 0;
    }
    
    .practice-label {
        font-size: 12px; /* 🔥 从 11px 增加到 12px */
        min-width: 55px; /* 🔥 从 50px 增加到 55px */
        font-weight: 500;
    }
    
    .practice-value {
        font-size: 13px; /* 🔥 从 12px 增加到 13px */
    }
    
    .practice-value.total-practice {
        font-size: 14px; /* 🔥 从 12px 增加到 14px */
        font-weight: 700;
    }
    
    .metric-item {
        padding: 12px;
    }
    
    .metric-label {
        margin-bottom: 4px;
    }
    
    .time-slots-wrapper {
        gap: 3px; /* 🔥 移动端时间段间距 */
        margin-top: 3px;
    }
}

@media (max-width: 480px) {
    .metric-value.practice-status-compact {
        min-height: 75px; /* 🔥 从 60px 增加到 75px */
        font-size: 13px; /* 🔥 保持可读性 */
        padding: 2px 0;
    }
    
    .time-slots-container .metric-value {
        min-height: 75px; /* 🔥 从 60px 增加到 75px */
        padding: 2px 0;
    }
    
    .practice-info-row {
        margin-bottom: 5px; /* 🔥 从 2px 增加到 5px */
        min-height: 18px; /* 🔥 从 14px 增加到 18px */
    }
    
    .practice-label {
        font-size: 11px; /* 🔥 从 10px 增加到 11px */
        min-width: 50px; /* 🔥 从 45px 增加到 50px */
        font-weight: 500;
    }
    
    .practice-value {
        font-size: 12px; /* 🔥 从 11px 增加到 12px */
    }
    
    .practice-value.total-practice {
        font-size: 13px; /* 🔥 从 11px 增加到 13px */
        font-weight: 700;
    }
    
    .metric-item {
        padding: 10px;
    }
    
    .time-slots-wrapper {
        gap: 2px;
        margin-top: 2px;
    }
}

/* 深色模式适配 */
@media (prefers-color-scheme: dark) {
    .practice-label {
        color: var(--medium-gray);
        font-weight: 500; /* 🔥 确保深色模式下也有足够字重 */
    }
    
    .practice-value {
        color: var(--text-color);
    }
    
    .practice-value.current-practice {
        color: #58a6ff;
    }
    
    .practice-value.total-practice {
        color: var(--primary-color);
        font-weight: 700; /* 🔥 确保深色模式下也保持粗体 */
    }
}

/* 🔥 新增：为了更好的视觉效果，可以添加一些微妙的样式 */
.practice-info-row {
    transition: all 0.2s ease; /* 🔥 平滑过渡效果 */
}

.practice-info-row:hover {
    transform: translateX(2px); /* 🔥 悬停时轻微移动 */
}

.practice-value.total-practice {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); /* 🔥 文字阴影，增强可读性 */
}

/* 🔥 为当前练习时长添加一些视觉强调 */
.practice-value.current-practice {
    position: relative;
}

.practice-value.current-practice::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #2196F3, rgba(33, 150, 243, 0.3));
    border-radius: 1px;
    animation: pulse-underline 2s infinite;
}

@keyframes pulse-underline {
    0%, 100% {
        opacity: 0.6;
        transform: scaleX(1);
    }
    50% {
        opacity: 1;
        transform: scaleX(1.05);
    }
}

/* ===== 4. 语言切换器 ===== */
.language-switcher {
    position: fixed;
    bottom: max(20px, env(safe-area-inset-bottom) + 10px);
    left: 20px;
    z-index: 1001;
    display: flex;
    background: white;
    border-radius: var(--radius-large);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.lang-btn {
    padding: 8px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 40px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lang-btn.active {
    background: var(--primary-color);
    color: white;
}

.lang-btn:hover:not(.active) {
    background: rgba(52, 152, 219, 0.1);
}

/* 移动端语言切换器 */
@media (max-width: 768px) {
    .language-switcher {
        bottom: max(10px, env(safe-area-inset-bottom) + 5px);
        left: 10px;
        border-radius: 16px;
    }
    
    .lang-btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 35px;
        height: 28px;
    }
}

/* ===== 5. 头部样式 ===== */
.header {
    background: var(--gradient-primary);
    color: white;
    padding: max(30px, env(safe-area-inset-top) + 20px) 20px 30px 20px;
    margin-bottom: 30px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
}

.header h1 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    margin-bottom: 10px;
    font-weight: 300;
    line-height: 1.2;
}

.header .subtitle {
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    opacity: 0.9;
    line-height: 1.3;
}

@media (max-width: 768px) {
    .header {
        padding: max(25px, env(safe-area-inset-top) + 15px) 15px 25px 15px;
        margin-bottom: 20px;
    }
}

/* ===== 6. 连接状态指示器 ===== */
.connection-status {
    position: fixed;
    top: max(20px, env(safe-area-inset-top) + 10px);
    right: 20px;
    padding: 8px 12px;
    border-radius: var(--radius-large);
    font-size: 13px;
    font-weight: 600;
    z-index: 1000;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.connection-status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--danger-color);
}

.connection-status.online::before {
    background: var(--success-color);
}

.connection-status.syncing::before {
    background: var(--warning-color);
    animation: pulse 1.5s infinite;
}

.connection-status.online {
    background: white;
    color: var(--success-color);
    border: 1px solid var(--success-color);
}

.connection-status.offline {
    background: white;
    color: var(--danger-color);
    border: 1px solid var(--danger-color);
}

.connection-status.syncing {
    background: white;
    color: var(--warning-color);
    border: 1px solid var(--warning-color);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@media (max-width: 768px) {
    .connection-status {
        top: max(15px, env(safe-area-inset-top) + 5px);
        right: 15px;
        padding: 6px 10px;
        font-size: 12px;
        min-height: 36px;
    }
}

/* ===== 7. 主导航标签 ===== */
.nav-tabs {
    display: flex;
    background: white;
    border-radius: var(--radius);
    padding: 5px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.nav-tabs::-webkit-scrollbar {
    display: none;
}

.nav-tab {
    flex: 1;
    padding: 12px 16px;
    text-align: center;
    background: transparent;
    border: none;
    border-radius: calc(var(--radius) - 5px);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: clamp(14px, 3vw, 16px);
    font-weight: 500;
    white-space: nowrap;
    min-width: 120px;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
}

.nav-tab:hover {
    background: rgba(52, 152, 219, 0.1);
}

.nav-tab.active {
    background: var(--primary-color);
    color: white;
}

@media (max-width: 768px) {
    .nav-tabs {
        margin-bottom: 20px;
        padding: 3px;
    }
    
    .nav-tab {
        padding: 10px 12px;
        font-size: 14px;
        min-width: 100px;
        min-height: 40px;
    }
}

/* ===== 8. 卡片容器基础样式 ===== */
.card {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.card.success {
    border-left-color: var(--success-color);
}

.card.warning {
    border-left-color: var(--warning-color);
}

.card.danger {
    border-left-color: var(--danger-color);
}

@media (max-width: 768px) {
    .card {
        padding: 20px 15px;
        margin-bottom: 20px;
    }
}

/* ===== 9. 统计面板 ===== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.stat-card:hover::before {
    left: 100%;
}

.stat-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 10px;
    line-height: 1;
}

.stat-label {
    font-size: 1.1rem;
    color: var(--medium-gray);
    margin-bottom: 5px;
    font-weight: 600;
}

.stat-description {
    font-size: 0.9rem;
    color: #999;
    line-height: 1.3;
}

/* 统计卡片颜色主题 */
.stat-card.present .stat-number { color: var(--success-color); }
.stat-card.absent .stat-number { color: var(--danger-color); }
.stat-card.excused .stat-number { color: var(--warning-color); }
.stat-card.total .stat-number { color: var(--primary-color); }
.stat-card.unscheduled .stat-number { color: #9b59b6; }
.stat-card.weekend .stat-number { color: #95a5a6; }

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        padding: 20px 15px;
    }
    
    .stat-number {
        font-size: 2.2rem;
    }
    
    .stat-label {
        font-size: 1rem;
    }
    
    .stat-description {
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        gap: 8px;
    }
    
    .stat-card {
        padding: 15px 10px;
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
}

/* ===== 10. 学生网格布局系统 ===== */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(12px, 2vw, 20px);
    width: 100%;
    padding: 0;
}

/* 限制最大列数为4列 */
@media (min-width: 1400px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
        margin: 0 auto;
        gap: 24px;
    }
}

/* 不同屏幕宽度的响应式设置 */
@media (max-width: 1399px) and (min-width: 1100px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }
}

@media (max-width: 1099px) and (min-width: 800px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
}

@media (max-width: 799px) {
    .student-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

/* 小屏幕优化 */
@media (max-width: 599px) {
    .student-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (max-width: 360px) {
    .student-grid {
        gap: 8px;
    }
}

/* 大屏幕优化 */
@media (min-width: 1600px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
        gap: 24px;
    }
}


/* ===== 11. 学生卡片和练琴状态卡片 ===== */
.student-card,
.practice-status-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    border-left: 4px solid var(--border-color);
    cursor: pointer;
    width: 100%;
    max-width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    height: auto;
    min-height: 280px;
    box-sizing: border-box;
    justify-self: stretch;
    align-self: stretch;
    color: var(--text-color);
}

.student-card:hover,
.practice-status-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
    background: var(--card-hover-bg);
}

.practice-status-card.compact {
    min-height: 120px;
    padding: 10px 12px;
    margin-bottom: 8px;
}
/* 待考勤状态样式 */
.student-status.pending,
.student-status-compact.pending,
.table-status-badge.pending,
.status-badge.pending {
    background: #e9ecef;
    color: #6c757d;
    border-color: #dee2e6;
}

.practice-status-card.pending,
.student-card.pending {
    border-left-color: #6c757d;
}

/* 待考勤状态的卡片 */
.practice-status-card.pending,
.student-card.pending {
    background: var(--card-bg);
    border-left-color: var(--medium-gray);
}


.compact-content {
    display: flex;
    flex-direction: column;
    gap: 4px;                     /* 从6px改为4px */
    flex: 1;
}


.student-name-compact {
    font-size: 1.2rem;              /* 🔥 从1rem增加到1.2rem */
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 2px;
}



.student-info-row {
    display: flex;
    align-items: center;
    gap: 6px;                     /* 从8px改为6px */
    font-size: 0.75rem;           /* 从0.8rem改为0.75rem */
    color: var(--medium-gray);
    flex-wrap: wrap;
}


.info-item {
    display: flex;
    align-items: center;
    gap: 2px;
}

.info-divider {
    opacity: 0.6;
    margin: 0 2px;
}

.status-duration-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
    gap: 10px;
}

.practice-duration-large {
    font-size: 1rem;              /* 从1.1rem改为1rem */
    font-weight: 600;
    color: var(--primary-color);
    background: rgba(52, 152, 219, 0.1);
    padding: 3px 6px;             /* 从4px 8px改为3px 6px */
    border-radius: var(--radius-small);
}



/* 移动端卡片优化 */
@media (max-width: 768px) {
    .student-card,
    .practice-status-card {
        min-height: 140px;
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .practice-status-card.compact {
        min-height: 120px;
        padding: 10px;
    }
    
    .student-name-compact {
        font-size: 1rem;
    }
    
    .student-info-row {
        font-size: 0.75rem;
        gap: 6px;
    }
    
    .practice-duration-large {
        font-size: 1rem;
        padding: 3px 6px;
    }
}

@media (max-width: 480px) {
    .student-card,
    .practice-status-card {
        min-height: 120px;
        padding: 8px;
    }
    
    .practice-status-card.compact {
        min-height: 100px;
        padding: 8px;
    }
    
    .student-name-compact {
        font-size: 0.95rem;
    }
    
    .student-info-row {
        font-size: 0.7rem;
        gap: 4px;
    }
    
    .practice-duration-large {
        font-size: 0.9rem;
        padding: 2px 4px;
    }
}

/* ===== 12. 卡片边框颜色 ===== */
.practice-status-card { 
    border-left-color: #9b59b6; 
    background: white;
}

.student-card.weekend,
.practice-status-card.weekend { 
    border-left-color: #95a5a6; 
    background: var(--gradient-card);
}

.practice-status-card.present,
.student-card.present { 
    border-left-color: var(--success-color); 
}

.practice-status-card.absent,
.student-card.absent { 
    border-left-color: var(--danger-color); 
}

.practice-status-card.excused,
.student-card.excused { 
    border-left-color: var(--warning-color); 
}

.practice-status-card.low-efficiency,
.student-card.low-efficiency { 
    border-left-color: #f39c12; 
}

.practice-status-card.practicing-unscheduled,
.student-card.practicing-unscheduled { 
    border-left-color: #9b59b6; 
}

/* ===== 13. 卡片内容样式 ===== */
.student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.student-name {
    font-size: 1.5rem;              /* 🔥 从1.3rem增加到1.5rem */
    font-weight: 600;
    color: var(--text-color);
    line-height: 1.2;
}



.student-details,
.practice-details {
    width: 100%;
    margin-bottom: 15px;
}

/* 在更大屏幕上使用两列，但学生区域仍然全宽 */
@media (min-width: 1200px) {
    .student-details,
    .practice-details {
        grid-template-columns: 1fr 1fr;
    }
    
    /* 学生卡片区域跨越两列 */
    .student-grid,
    .department-section,
    .room-section {
        grid-column: 1 / -1;
    }
}


.detail-item {
    display: flex;
    flex-direction: column;
    padding: 4px 0;
}

.detail-label {
    font-size: 0.75rem;
    color: var(--medium-gray);
    margin-bottom: 2px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-color);
    line-height: 1.3;
}

/* 状态标签样式 */
.student-status,
.student-status-compact,
.practice-duration {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    white-space: nowrap;
    text-align: center;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    transition: all 0.15s ease-in-out;
}

/* 学生状态颜色 */
.student-status.present,
.student-status-compact.present { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb;
}

.student-status.absent,
.student-status-compact.absent { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}

.student-status.excused,
.student-status-compact.excused { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.student-status.low-efficiency,
.student-status-compact.low-efficiency { 
    background: #ffeaa7; 
    color: #b06000; 
    border-color: #ffdc7a;
}

.student-status.practicing-unscheduled,
.student-status-compact.practicing-unscheduled { 
    background: #e8d5f2; 
    color: #6a1b9a; 
    border-color: #dcc7e8;
}

.student-status.weekend,
.student-status-compact.weekend { 
    background: #ecf0f1; 
    color: #2c3e50; 
    border-color: #d5dbdb;
}

/* 练琴时长标签颜色 */
.practice-duration {
    background: #e8d5f2;
    color: #6a1b9a;
    border-color: #dcc7e8;
}

@media (max-width: 768px) {
    .student-header {
        margin-bottom: 8px;
    }
    
    .student-name {
        font-size: 1.3rem;
    }
    
    .student-details,
    .practice-details {
        grid-template-columns: 1fr;
        gap: 6px;
        margin-bottom: 10px;
    }
    
    .detail-label {
        font-size: 0.7rem;
    }
    
    .detail-value {
        font-size: 0.8rem;
    }
    
    .student-status,
    .student-status-compact,
    .practice-duration {
        padding: 3px 8px;
        font-size: 0.7rem;
        border-radius: 12px;
    }
}

/* ===== 14. 实时练琴指示器 ===== */
.practice-indicator {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    background: var(--success-color);
    border-radius: 50%;
    animation: pulse 2s infinite;
    box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
}

.practice-status-card.compact .practice-indicator {
    top: 12px;
    right: 12px;
    width: 10px;
    height: 10px;
}

@keyframes pulse {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
    }
    
    70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(39, 174, 96, 0);
    }
    
    100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0);
    }
}

@media (max-width: 768px) {
    .practice-indicator {
        width: 8px;
        height: 8px;
        top: 10px;
        right: 10px;
    }
    
    .practice-status-card.compact .practice-indicator {
        width: 6px;
        height: 6px;
        top: 8px;
        right: 8px;
    }
}

/* ===== 15. 考勤历史时间轴 ===== */
.attendance-history {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.history-title {
    font-size: 0.9rem;
    color: var(--medium-gray);
    margin-bottom: 10px;
    font-weight: 500;
}

.history-timeline {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px 0;
    justify-content: center;
}

.history-timeline-container {
    padding: 15px 0;
}

.history-day {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    border: 2px solid transparent;
}

.history-day:hover {
    transform: scale(1.15);
    z-index: 1;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.history-day.present { 
    background: var(--success-color); 
    color: white; 
    border-color: var(--success-color);
}

.history-day.absent { 
    background: var(--danger-color); 
    color: white; 
    border-color: var(--danger-color);
}

.history-day.excused { 
    background: var(--warning-color); 
    color: white; 
    border-color: var(--warning-color);
}

.history-day.no-data { 
    background: var(--light-gray); 
    color: var(--medium-gray); 
    border-color: var(--border-color);
}

.history-day.low-efficiency {
    background: #f39c12;
    border-color: #f39c12;
    color: white;
}

.history-day.practicing-unscheduled {
    background: #9b59b6;
    border-color: #9b59b6;
    color: white;
}

.history-day.weekend {
    background: #95a5a6;
    border-color: #95a5a6;
    color: white;
}

/* 移动端考勤历史优化 */
@media (max-width: 768px) {
    .attendance-history {
        margin-top: 10px;
        padding-top: 10px;
    }
    
    .history-timeline {
        gap: 6px;
    }
    
    .history-day {
        width: 35px;
        height: 35px;
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .history-timeline {
        gap: 4px;
    }
    
    .history-day {
        width: 30px;
        height: 30px;
        font-size: 0.75rem;
    }
}

/* ===== 16. 空状态样式 ===== */
.practice-empty-state,
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--medium-gray);
}

.practice-empty-state-icon,
.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.practice-empty-state-title,
.empty-state-title {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--text-color);
    font-weight: 600;
}

.practice-empty-state-description,
.empty-state-description {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--medium-gray);
}

.empty-state {
    padding: 60px 20px;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.empty-state-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
}

.empty-state-description {
    font-size: 1rem;
    line-height: 1.6;
}

/* 移动端空状态优化 */
@media (max-width: 768px) {
    .empty-state {
        padding: 40px 15px;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .empty-state-title {
        font-size: 1.2rem;
        margin-bottom: 8px;
    }
    
    .empty-state-description {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .practice-empty-state {
        padding: 30px 15px;
    }
    
    .practice-empty-state-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
    }
    
    .practice-empty-state-title {
        font-size: 1.1rem;
        margin-bottom: 6px;
    }
    
    .practice-empty-state-description {
        font-size: 0.85rem;
    }
}

/* ===== 17. 筛选器样式 ===== */
.filters,
.practice-filters {
    background: white;
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 25px;
    box-shadow: var(--shadow);
}

.filter-row,
.practice-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
}

.practice-filter-row {
    gap: 12px;
}

.filter-group,
.practice-filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
    flex: 1;
}

.practice-filter-group {
    min-width: 120px;
}

.filter-label,
.practice-filter-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    margin-bottom: 5px;
    font-weight: 500;
}

.practice-filter-label {
    font-size: 0.85rem;
    margin-bottom: 4px;
}

.filter-select, 
.filter-input,
.practice-filter-select,
.practice-filter-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-small);
    font-size: 14px;
    transition: all 0.3s ease;
    background: white;
    color: var(--text-color);
}

.practice-filter-select,
.practice-filter-input {
    padding: 8px 10px;
}

.filter-select:focus, 
.filter-input:focus,
.practice-filter-select:focus,
.practice-filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

.filter-select:hover,
.filter-input:hover,
.practice-filter-select:hover,
.practice-filter-input:hover {
    border-color: var(--primary-color);
}

/* 快速筛选标签 */
.quick-filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
    justify-content: flex-start;
}

.quick-filter-tag {
    padding: 8px 16px;           /* 统一内边距 */
    font-size: 14px;             /* 统一字体大小 */
    font-weight: 500;            /* 统一字重 */
    border-radius: 20px;         /* 统一圆角 */
    height: 36px;                /* 统一高度 */
    display: inline-flex;        /* 统一对齐方式 */
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    background: var(--light-gray);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    min-width: auto;
}

.quick-filter-tag:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.quick-filter-tag.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}


/* 移动端筛选器优化 */
@media (max-width: 768px) {
    .filters {
        padding: 15px;
        margin: 0 -5px 20px -5px;
    }
    
    .practice-filters {
        padding: 12px;
        margin: 0 -5px 15px -5px;
    }
    
    .filter-row,
    .practice-filter-row {
        flex-direction: column;
        gap: 12px;
    }
    
    .practice-filter-row {
        gap: 10px;
    }
    
    .filter-group,
    .practice-filter-group {
        min-width: auto;
        width: 100%;
    }
    
    .filter-select,
    .filter-input,
    .practice-filter-select,
    .practice-filter-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }
    
    .practice-filter-select,
    .practice-filter-input {
        padding: 10px 12px;
    }
    
    .filter-select:focus,
    .filter-input:focus,
    .practice-filter-select:focus,
    .practice-filter-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .quick-filter-tags {
        justify-content: center;
        margin-top: 12px;
    }
    
    .quick-filter-tag {
        padding: 6px 12px;
        font-size: 13px;
        height: 32px;
    }
}
/* 确保考勤快照筛选器与实时练琴筛选器样式完全一致 */
#todaySnapshot .practice-filters,
#practiceStatusContainer .practice-filters {
    background: white;
    padding: 20px;
    border-radius: var(--radius);
    margin: 0 0 25px 0;  /* 统一外边距 */
    box-shadow: var(--shadow);
    width: 100%;         /* 确保宽度一致 */
    box-sizing: border-box;
}

/* 移动端也要保持一致 */
@media (max-width: 768px) {
    #todaySnapshot .practice-filters,
    #practiceStatusContainer .practice-filters {
        padding: 15px;
        margin: 0 0 20px 0;
    }
}
/* 今日考勤快照容器的内边距控制筛选器两侧距离 */
#todaySnapshot {
    padding: 0 0px;  /* 左右内边距控制筛选器两侧距离 */
    /* 或者根据需要调整，比如：*/
    /* padding: 0 15px;  减少两侧距离 */
    /* padding: 0 30px;  增加两侧距离 */
}

/* 移动端调整 */
@media (max-width: 768px) {
    #todaySnapshot {
        padding: 0 0px;  /* 移动端的左右内边距 */
    }
}
/* 筛选器内的学生网格样式调整 */
.practice-filters .student-grid {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

/* 移动端优化 */
@media (max-width: 768px) {
    .practice-filters .student-grid {
        margin-top: 15px;
        padding-top: 15px;
    }
}


/* ===== 18. 操作按钮样式 ===== */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: var(--mobile-font-size);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: var(--touch-target-size);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    -webkit-appearance: none;
    text-decoration: none;
    line-height: 1;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.btn:active {
    transform: scale(0.95);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* 按钮颜色变体 */
.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-warning {
    background: var(--warning-color);
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-secondary {
    background: var(--medium-gray);
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-outline {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

/* 导出选项 */
.export-options {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

/* 移动端按钮优化 */
@media (max-width: 768px) {
    .action-buttons {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 15px;
        margin: 20px -15px -15px -15px;
        border-top: 1px solid #eee;
        z-index: 10;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .export-options {
        flex-direction: column;
        gap: 8px;
        margin-top: 15px;
    }
    
    .export-options .btn {
        width: 100%;
    }
    
    .btn {
        padding: 14px 20px;
        font-size: 16px;
        border-radius: 10px;
    }
}

/* ===== 19. 模态框样式优化 ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    backdrop-filter: blur(4px);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
}

.modal-content {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    max-width: min(600px, 95vw);
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    margin: env(safe-area-inset-top) auto env(safe-area-inset-bottom) auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: translateY(-20px);
    transition: transform 0.3s ease, opacity 0.3s ease;
    opacity: 0;
}

.modal.show .modal-content {
    transform: translateY(0);
    opacity: 1;
}
/* 模态框头部样式 */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 20px 15px 20px;  /* 增加底部内边距 */
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 10px;  /* 增加下边距 */
}

.modal-title {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
    flex: 1;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--medium-gray);
    padding: 5px;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    margin-left: 15px;
    flex-shrink: 0;
}

.modal-close:hover {
    background: var(--danger-color);
    color: white;
    transform: scale(1.1);
}

/* 移动端模态框头部优化 */
@media (max-width: 768px) {
    .modal-header {
        padding: 15px 15px 12px 15px;  /* 移动端也相应调整 */
        margin-bottom: 8px;
    }
}
    
    .modal-title {
        font-size: 1.1rem;
    }
    
    .modal-close {
        font-size: 20px;
        width: 28px;
        height: 28px;
    }
}

/* 考勤详情模态框渐隐动画 */
#attendanceDetailModal {
    transition: opacity 0.3s ease;
}

#attendanceDetailModal .modal-content {
    transition: none; /* 移除内容的变换动画，只保留整体透明度动画 */
}

/* 淡出动画 */
.modal.hiding {
    opacity: 0;
}

.modal.hiding .modal-content {
    transform: translateY(-20px);
    opacity: 0;
}
/* 考勤详情模态框特殊处理 */
#attendanceDetailModal.hiding .modal-content {
    transform: translateY(-20px);
    opacity: 0;
}

/* 移动端考勤详情模态框 */
@media (max-width: 768px) {
    #attendanceDetailModal.hiding .modal-content {
        transform: translateY(100%);
        opacity: 0;
    }
}

/* 移动端模态框优化 */
@media (max-width: 768px) {
    .modal {
        padding: 0;
        align-items: flex-end;
    }
    
    .modal-content {
        width: 100%;
        max-width: 100%;
        max-height: 90vh;
        border-radius: var(--radius-large) var(--radius-large) 0 0;
        margin: 0;
        transform: translateY(100%);
    }
    
    .modal.show .modal-content {
        transform: translateY(0);
    }
    
    .modal.hiding .modal-content {
        transform: translateY(100%);
    }
}


/* ===== 20. 表格样式 ===== */
.data-table,
.detail-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    font-size: 0.9rem;
}

.detail-table {
    margin: 0;
}

.data-table th,
.data-table td,
.detail-table th,
.detail-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    min-width: 80px;
    vertical-align: middle;
}

.data-table th,
.detail-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
}

.detail-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.data-table tr:hover,
.detail-table tr:hover {
    background: var(--light-gray);
}

.detail-table tr:last-child td {
    border-bottom: none;
}

/* 表格容器 */
.data-table-container,
.table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-radius: var(--radius);
}

.history-table-card .table-container {
    max-height: 300px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

/* 表格单元格样式 */
.date-cell {
    font-weight: 500;
    color: var(--dark-gray);
    min-width: 100px;
}

.table-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    display: inline-block;
    border: 1px solid transparent;
}

.table-status-badge.present { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb;
}

.table-status-badge.absent { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}

.table-status-badge.excused { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.table-status-badge.low-efficiency { 
    background: #ffeaa7; 
    color: #b06000; 
    border-color: #ffdc7a;
}

.table-status-badge.practicing-unscheduled { 
    background: #e8d5f2; 
    color: #6a1b9a; 
    border-color: #dcc7e8;
}

.table-status-badge.weekend { 
    background: #ecf0f1; 
    color: #2c3e50; 
    border-color: #d5dbdb;
}

.table-status-badge.no-data { 
    background: var(--light-gray); 
    color: var(--medium-gray); 
    border-color: var(--border-color);
}

.duration-cell {
    color: var(--medium-gray);
    font-weight: 500;
    text-align: right;
    min-width: 80px;
}

.total-duration-cell {
    font-weight: 600;
    color: var(--primary-color);
    text-align: right;
    min-width: 90px;
}

/* 表格滚动提示 */
.table-scroll-hint {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 5;
}

.table-container:hover .table-scroll-hint {
    opacity: 1;
}

/* 表格空状态 */
.table-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--medium-gray);
}

.table-empty-state-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    opacity: 0.5;
}

.table-empty-state-title {
    font-size: 1rem;
    margin-bottom: 5px;
    color: var(--text-color);
    font-weight: 600;
}

.table-empty-state-description {
    font-size: 0.85rem;
    line-height: 1.4;
}

/* 移动端表格优化 */
@media (max-width: 768px) {
    .data-table-container {
        margin: 0 -20px;
        padding: 0 20px;
    }
    
    .data-table {
        min-width: 600px;
    }
    
    .data-table th,
    .data-table td {
        padding: 10px 8px;
        font-size: 13px;
    }
    
    .history-table-card .table-container {
        max-height: 250px;
        margin: 0 -10px;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    .detail-table {
        font-size: 0.8rem;
        min-width: 500px;
    }
    
    .detail-table th,
    .detail-table td {
        padding: 8px 10px;
    }
    
    .detail-table th {
        font-size: 0.75rem;
        background: var(--light-gray);
    }
    
    .history-table-card .table-container::-webkit-scrollbar {
        width: 3px;
        height: 3px;
    }
}

@media (max-width: 480px) {
    .history-table-card .table-container {
        max-height: 200px;
    }
    
    .detail-table {
        font-size: 0.75rem;
        min-width: 450px;
    }
    
    .detail-table th,
    .detail-table td {
        padding: 6px 8px;
    }
}
/* 今日行样式 */
.today-row {
    background: #f0f8ff;
}

/* 深色模式下的今日行 */
@media (prefers-color-scheme: dark) {
    .today-row {
        background: rgba(88, 166, 255, 0.15) !important;
    }
    
    .today-row .date-cell {
        color: var(--text-color);
    }
    
    .today-row .date-cell small {
        color: var(--primary-color) !important;
    }
}


/* ===== 21. 加载动画 ===== */
.loading {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--light-gray);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 15px;
    color: var(--medium-gray);
    font-size: 0.9rem;
}

/* 移动端加载动画优化 */
@media (max-width: 768px) {
    .loading {
        padding: 30px 20px;
    }
    
    .spinner {
        width: 35px;
        height: 35px;
        border-width: 3px;
    }
    
    .loading-text {
        margin-top: 12px;
        font-size: 0.85rem;
    }
}

/* ===== 22. 日期选择器样式 ===== */
.date-picker {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.date-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-small);
    font-size: 14px;
    color: var(--text-color);
    background: white;
    transition: all 0.3s ease;
}

.date-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

/* 移动端日期选择器优化 */
@media (max-width: 768px) {
    .date-picker {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 15px;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-bottom: 20px;
    }
    
    .date-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
    }
    
    .date-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}

/* ===== 23. 学生详情页面特殊样式 ===== */
.student-detail-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 800px;
    margin: 0 auto;
}

/* 学生档案卡片 */
.student-profile-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: var(--radius-large);
    text-align: center;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.profile-info {
    width: 100%;
}

.profile-name {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 15px 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    line-height: 1.1;
}

.profile-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-size: 1.1rem;
    opacity: 0.9;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.meta-icon {
    font-size: 1rem;
}

.meta-divider {
    opacity: 0.6;
    margin: 0 4px;
    font-size: 1.2rem;
}

/* 今日状态卡片 */
.today-status-card {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border-left: 5px solid var(--primary-color);
}

.today-status-card.present { border-left-color: var(--success-color); }
.today-status-card.absent { border-left-color: var(--danger-color); }
.today-status-card.excused { border-left-color: var(--warning-color); }
.today-status-card.low-efficiency { border-left-color: #f39c12; }
.today-status-card.practicing-unscheduled { border-left-color: #9b59b6; }
.today-status-card.weekend { border-left-color: #95a5a6; }

.status-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.status-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.status-badge {
    padding: 8px 16px;
    border-radius: var(--radius-large);
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid transparent;
}

.status-badge.present { background: #d4edda; color: #155724; border-color: #c3e6cb; }
.status-badge.absent { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
.status-badge.excused { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
.status-badge.low-efficiency { background: #ffeaa7; color: #b06000; border-color: #ffdc7a; }
.status-badge.practicing-unscheduled { background: #e8d5f2; color: #6a1b9a; border-color: #dcc7e8; }
.status-badge.weekend { background: #ecf0f1; color: #2c3e50; border-color: #d5dbdb; }

.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.metric-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
}

.metric-item:hover {
    transform: translateY(-2px);
}

.metric-icon {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
}

.metric-content {
    flex: 1;
}

.metric-label {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-bottom: 2px;
    color: var(--medium-gray);
}

.metric-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-color);
}
/* 请假信息 */
.excuse-info {
    margin-top: 20px;
    padding: 16px;
    background: rgba(243, 156, 18, 0.1);
    border-radius: var(--radius);
    border-left: 4px solid #f39c12;
}

.excuse-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.excuse-icon {
    font-size: 1.2rem;
}

.excuse-title {
    font-weight: 600;
    color: #b06000;
}

.excuse-content {
    padding-left: 28px;
}

.excuse-reason {
    margin: 0 0 4px 0;
    color: #856404;
    font-weight: 500;
}

.excuse-approver {
    margin: 0;
    font-size: 0.9rem;
    color: #6c5700;
}

/* 通用卡片样式 */
.card-header {
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--light-gray);
}

.card-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.title-icon {
    font-size: 1.3rem;
}

.title-subtitle {
    font-size: 0.85rem;
    font-weight: 400;
    color: var(--medium-gray);
    margin-left: 4px;
}

/* 统计网格详细版 */
.stats-grid-detailed {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    max-width: 100%;
}

.stats-grid-detailed .stat-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px;
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    min-height: 80px;
}

.stats-grid-detailed .stat-item:hover {
    transform: translateY(-3px);
}

.stats-grid-detailed .stat-item.present { 
    background: linear-gradient(135deg, #d4edda, #c3e6cb); 
}

.stats-grid-detailed .stat-item.absent { 
    background: linear-gradient(135deg, #f8d7da, #f5c6cb); 
}

.stats-grid-detailed .stat-item.excused { 
    background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
}

.stats-grid-detailed .stat-item.rate { 
    background: linear-gradient(135deg, #cce7ff, #b3d9ff); 
}

.stats-grid-detailed .stat-icon {
    font-size: 1.5rem;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 50%;
    flex-shrink: 0;
}

.stats-grid-detailed .stat-content {
    flex: 1;
    min-width: 0;
}

.stats-grid-detailed .stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
    color: var(--text-color);
}

.stats-grid-detailed .stat-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    font-weight: 500;
    line-height: 1.2;
}

/* 移动端学生详情页面优化 */
@media (max-width: 768px) {
    .student-detail-content {
        gap: 16px;
    }
    
    .student-profile-card {
        padding: 25px 20px;
    }
    
    .profile-name {
        font-size: 2rem;
    }
    
    .profile-meta {
        font-size: 1rem;
        gap: 10px;
    }
    
    .status-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .status-metrics {
        grid-template-columns: 1fr;
    }
    
    .stats-grid-detailed {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 16px;
        min-height: 70px;
    }
    
    .stats-grid-detailed .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1.3rem;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.5rem;
    }
    
    .stats-grid-detailed .stat-label {
        font-size: 0.85rem;
    }
}

@media (max-width: 480px) {
    .student-detail-content {
        gap: 16px;
    }
    
    .card {
        padding: 20px 16px;
    }
    
    .profile-name {
        font-size: 1.8rem;
    }
    
    .profile-meta {
        font-size: 0.9rem;
        gap: 8px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 14px;
        min-height: 60px;
        gap: 10px;
    }
    
    .stats-grid-detailed .stat-icon {
        width: 35px;
        height: 35px;
        font-size: 1.2rem;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.3rem;
    }
    
    .stats-grid-detailed .stat-label {
        font-size: 0.8rem;
    }
}

/* 中等屏幕统计网格优化 */
@media (min-width: 769px) and (max-width: 1024px) {
    .stats-grid-detailed {
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 18px;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.6rem;
    }
}

/* 大屏幕统计网格优化 */
@media (min-width: 1200px) {
    .stats-grid-detailed {
        max-width: 600px;
        margin: 0 auto;
    }
}

/* ===== 24. 加载更多提示 ===== */
.load-more-hint {
    text-align: center;
    padding: 15px;
    color: var(--medium-gray);
    font-size: 0.85rem;
    border-top: 1px solid #eee;
    background: var(--light-gray);
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.load-more-hint:hover {
    background: #e9ecef;
}

.load-more-hint.loading {
    color: var(--primary-color);
    cursor: not-allowed;
}

/* ===== 25. 触摸优化 ===== */
.student-card, 
.practice-status-card, 
.stat-card, 
.btn, 
.nav-tab,
.quick-filter-tag,
.history-day {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
    tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.student-card:active, 
.practice-status-card:active, 
.stat-card:active {
    transform: scale(0.98);
}

.btn:active {
    transform: scale(0.95);
}

.quick-filter-tag:active,
.history-day:active {
    transform: scale(0.95);
}

/* ===== 26. iOS安全区域适配 ===== */
@supports (padding: max(0px)) {
    .container {
        padding-left: max(20px, env(safe-area-inset-left));
        padding-right: max(20px, env(safe-area-inset-right));
    }
    
    @media (max-width: 768px) {
        .container {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }
    }
}

/* ===== 27. 横屏模式优化 ===== */
@media (max-width: 768px) and (orientation: landscape) {
    .header {
        padding: max(15px, env(safe-area-inset-top) + 10px) 20px 15px 20px;
    }
    
    .header h1 {
        font-size: 1.8rem;
        margin-bottom: 5px;
    }
    
    .header .subtitle {
        font-size: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .modal-content {
        max-height: 80vh;
    }
    
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* ===== 28. iOS Safari 特殊优化 ===== */
@supports (-webkit-touch-callout: none) {
    .nav-tabs {
        -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
        -webkit-overflow-scrolling: touch;
    }
    
    input, select, textarea {
        -webkit-appearance: none;
        border-radius: 8px;
    }
    
    .btn {
        -webkit-appearance: none;
    }
}

/* ===== 29. 滚动条样式 ===== */
* {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

*::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

*::-webkit-scrollbar-track {
    background: transparent;
}

*::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

*::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0, 0, 0, 0.4);
}

/* 移动端滚动条 */
@media (max-width: 768px) {
    *::-webkit-scrollbar {
        width: 3px;
        height: 3px;
    }
}

/* ===== 30. 可访问性优化 ===== */
.student-card:focus,
.practice-status-card:focus,
.btn:focus,
.nav-tab:focus,
.quick-filter-tag:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

button:focus,
input:focus,
select:focus,
textarea:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 1px;
}

/* 高对比度模式支持 */
@media (prefers-contrast: high) {
    :root {
        --border-color: #000;
        --text-color: #000;
        --background-color: #fff;
    }
    
    .card {
        border: 2px solid #000;
    }
    
    .btn {
        border: 2px solid currentColor;
    }
}

/* 减少动画偏好 */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .practice-indicator {
        animation: none;
    }
    
    .spinner {
        animation: none;
    }
}

/* ===== 31. 打印样式优化 ===== */
@media print {
    .language-switcher,
    .connection-status,
    .nav-tabs,
    .action-buttons,
    .btn,
    .modal,
    .practice-indicator {
        display: none !important;
    }
    
    .container {
        max-width: none;
        padding: 0;
    }
    
    .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
        margin-bottom: 15px;
    }
    
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .student-card,
    .practice-status-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .header {
        background: none !important;
        color: #000 !important;
        box-shadow: none;
    }
    
    body {
        background: white !important;
        color: black !important;
    }
}

/* ===== 32. 统一的状态颜色系统 ===== */
.present, 
.student-status.present, 
.student-status-compact.present, 
.table-status-badge.present,
.status-badge.present { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb;
}

.absent, 
.student-status.absent, 
.student-status-compact.absent, 
.table-status-badge.absent,
.status-badge.absent { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}

.pending,
.student-status.pending,
.student-status-compact.pending,
.table-status-badge.pending,
.status-badge.pending {
    background: #f8f9fa;
    color: #6c757d;
    border-color: #dee2e6;
}


.excused, 
.student-status.excused, 
.student-status-compact.excused, 
.table-status-badge.excused,
.status-badge.excused { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.low-efficiency, 
.student-status.low-efficiency, 
.student-status-compact.low-efficiency, 
.table-status-badge.low-efficiency,
.status-badge.low-efficiency { 
    background: #ffeaa7; 
    color: #b06000; 
    border-color: #ffdc7a;
}

.practicing-unscheduled, 
.student-status.practicing-unscheduled, 
.student-status-compact.practicing-unscheduled, 
.table-status-badge.practicing-unscheduled,
.status-badge.practicing-unscheduled { 
    background: #e8d5f2; 
    color: #6a1b9a; 
    border-color: #dcc7e8;
}

.weekend, 
.student-status.weekend, 
.student-status-compact.weekend, 
.table-status-badge.weekend,
.status-badge.weekend { 
    background: #ecf0f1; 
    color: #2c3e50; 
    border-color: #d5dbdb;
}

/* ===== 33. 文本和排版优化 ===== */
p, div, span {
    line-height: 1.5;
}

h1, h2, h3, h4, h5, h6 {
    line-height: 1.2;
    margin-bottom: 0.5em;
    font-weight: 600;
}

/* 确保所有文本输入框在iOS上不会被缩放 */
input, select, textarea, button {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

/* 确保触摸目标足够大 */
.nav-tab,
.btn,
.lang-btn,
.connection-status,
.student-card,
.practice-status-card,
.history-day,
.quick-filter-tag {
    min-height: 44px;
    min-width: 44px;
}

/* 小屏幕下的触摸目标调整 */
@media (max-width: 480px) {
    .nav-tab,
    .btn {
        min-height: 40px;
    }
    
    .lang-btn {
        min-height: 32px;
        min-width: 32px;
    }
    
    .history-day {
        min-height: 32px;
        min-width: 32px;
    }
}

/* ===== 34. 特殊内容处理 ===== */
.detail-item[style*="grid-column: 1 / -1"] .detail-value {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-top: 2px;
}

.detail-item .detail-value[style*="color: #f39c12"] {
    background: rgba(243, 156, 18, 0.1);
    padding: 6px 8px;
    border-radius: var(--radius-small);
    font-size: 0.8rem;
    line-height: 1.3;
}
/* ===== 时间段标签美化样式 - 增大文字并左对齐 ===== */
.time-slot-tag {
    display: inline-block;
    background: transparent;
    color: #6c757d;
    border: none;
    padding: 2px 4px;
    margin: 2px 4px 2px 0;
    border-radius: 0;
    font-size: 0.9rem;         /* 🔥 从 0.8rem 增加到 0.9rem */
    font-weight: 500;          /* 🔥 从 400 增加到 500 */
    box-shadow: none;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.time-slot-tag:hover {
    color: #495057;
    transform: none;
    box-shadow: none;
    background: transparent;
}

.time-slots-wrapper {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;     /* 🔥 改为 flex-start，顶部对齐 */
    justify-content: flex-start; /* 🔥 强制左对齐 */
    gap: 0;
    margin-top: 4px;
    width: 100%;                 /* 🔥 确保占满宽度 */
    margin-left: 0;              /* 🔥 新增：确保没有左边距 */
    padding-left: 0;             /* 🔥 新增：确保没有左内边距 */
}

.time-slots-container {
    width: 100%;                 /* 🔥 容器占满宽度 */
}

.time-slots-container .metric-value {
    line-height: 1.4;            /* 🔥 从 1.2 增加到 1.4 */
    text-align: left;            /* 🔥 文本左对齐 */
    width: 100%;                 /* 🔥 占满宽度 */
    margin-left: 0;              /* 🔥 新增：确保没有左边距 */
    padding-left: 0;             /* 🔥 新增：确保没有左内边距 */
}

/* 🔥 新增：确保时间段容器在网格中左对齐 */
.time-slots-container.metric-item {
    justify-content: flex-start;
    align-items: flex-start;
}

.time-slots-container .metric-content {
    width: 100%;
    text-align: left;
    margin-left: 0;              /* 🔥 新增：确保没有左边距 */
    padding-left: 0;             /* 🔥 新增：确保没有左内边距 */
}

/* 🔥 新增：确保标签行与标题完全左对齐 */
.metric-content .metric-label {
    margin-left: 0;
    padding-left: 0;
    text-align: left;
}

.metric-content .metric-value.time-slots-wrapper {
    margin-left: 0 !important;   /* 🔥 强制去除左边距 */
    padding-left: 0 !important;  /* 🔥 强制去除左内边距 */
    text-align: left;
    justify-content: flex-start !important;
}

/* 当前时间段高亮 - 只有这个状态才有背景和形状 */
.time-slot-tag.current {
    background: linear-gradient(135deg, #d1ecf1, #bee5eb);
    color: #0c5460;
    border: 1px solid #b8daff;
    padding: 6px 14px;         /* 🔥 从 4px 12px 增加到 6px 14px */
    border-radius: 18px;       /* 🔥 从 16px 增加到 18px */
    font-weight: 600;          /* 🔥 从 500 增加到 600 */
    font-size: 0.95rem;        /* 🔥 新增：当前时间段字体更大 */
    box-shadow: 0 1px 3px rgba(12, 84, 96, 0.2);
    animation: pulse-glow 2s infinite;
}

.time-slot-tag.current:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(12, 84, 96, 0.3);
}

@keyframes pulse-glow {
    0%, 100% { 
        box-shadow: 0 1px 3px rgba(12, 84, 96, 0.2);
    }
    50% { 
        box-shadow: 0 2px 8px rgba(12, 84, 96, 0.3);
    }
}

/* 🔥 新增：确保状态指标网格中的对齐 */
.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: start;
}

.status-metrics .metric-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    text-align: left;            /* 🔥 确保内容左对齐 */
}

/* 🔥 新增：特别针对时间段容器的对齐处理 */
.status-metrics .time-slots-container.metric-item .metric-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;     /* 🔥 内容左对齐 */
    width: 100%;
}

.status-metrics .time-slots-container.metric-item .metric-label {
    align-self: flex-start;      /* 🔥 标签左对齐 */
    margin-left: 0;
    padding-left: 0;
}

.status-metrics .time-slots-container.metric-item .metric-value {
    align-self: flex-start;      /* 🔥 值左对齐 */
    width: 100%;
    margin-left: 0;
    padding-left: 0;
}

/* 移动端优化 */
@media (max-width: 768px) {
    .time-slot-tag {
        font-size: 0.85rem;      /* 🔥 从 0.75rem 增加到 0.85rem */
        padding: 3px 4px;        /* 🔥 从 2px 3px 增加到 3px 4px */
        margin: 1px 3px 1px 0;
        font-weight: 500;        /* 🔥 确保移动端也有足够字重 */
    }
    
    .time-slot-tag.current {
        padding: 5px 12px;       /* 🔥 从 3px 10px 增加到 5px 12px */
        font-size: 0.9rem;       /* 🔥 移动端当前时间段也增大 */
    }
    
    .time-slots-container .metric-value {
        line-height: 1.5;        /* 🔥 移动端行高也增加 */
        text-align: left;        /* 🔥 确保移动端也左对齐 */
        margin-left: 0;
        padding-left: 0;
    }
    
    .time-slots-wrapper {
        justify-content: flex-start; /* 🔥 移动端也强制左对齐 */
        margin-left: 0;
        padding-left: 0;
    }
    
    .status-metrics {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (max-width: 480px) {
    .time-slot-tag {
        font-size: 0.8rem;       /* 🔥 超小屏幕适当调整 */
        padding: 2px 3px;
        margin: 1px 2px 1px 0;
    }
    
    .time-slot-tag.current {
        padding: 4px 10px;
        font-size: 0.85rem;
    }
    
    .time-slots-wrapper {
        margin-top: 2px;
        justify-content: flex-start; /* 🔥 超小屏幕也左对齐 */
        margin-left: 0;
        padding-left: 0;
    }
    
    .time-slots-container .metric-value {
        margin-left: 0;
        padding-left: 0;
    }
}

/* 深色模式适配 */
@media (prefers-color-scheme: dark) {
    .time-slot-tag {
        background: transparent;
        color: #8b949e;
        border: none;
        box-shadow: none;
        font-weight: 500;        /* 🔥 确保深色模式也有足够字重 */
    }
    
    .time-slot-tag:hover {
        color: #f0f6fc;
        background: transparent;
        box-shadow: none;
    }
    
    .time-slot-tag.current {
        background: linear-gradient(135deg, #1f2937, #374151);
        color: #93c5fd;
        border: 1px solid #60a5fa;
        box-shadow: 0 1px 3px rgba(147, 197, 253, 0.2);
        font-weight: 600;        /* 🔥 深色模式当前时间段保持粗体 */
    }
    
    .time-slot-tag.current:hover {
        box-shadow: 0 2px 6px rgba(147, 197, 253, 0.3);
    }
    
    @keyframes pulse-glow {
        0%, 100% { 
            box-shadow: 0 1px 3px rgba(147, 197, 253, 0.2);
        }
        50% { 
            box-shadow: 0 2px 8px rgba(147, 197, 253, 0.3);
        }
    }
}

/* 🔥 新增：RTL语言支持时的对齐 */
[dir="rtl"] .time-slots-wrapper {
    justify-content: flex-end;
}

[dir="rtl"] .time-slots-container .metric-value {
    text-align: right;
}

[dir="rtl"] .time-slot-tag {
    margin: 2px 0 2px 4px;
}

/* ===== 35. 动画和过渡效果 ===== */
.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

.slide-up {
    animation: slideUp 0.5s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.bounce-in {
    animation: bounceIn 0.6s ease-out;
}

@keyframes bounceIn {
    0% {
        transform: scale(0.3);
        opacity: 0;
    }
    50% {
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.9);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}
/* ===== 36. 深色模式 ===== */
/* ===== 深色模式变量定义和完美适配 ===== */
@media (prefers-color-scheme: dark) {
    :root {
        /* 深色模式颜色变量重定义 */
        --background-color: #0d1117;
        --card-bg: #21262d;
        --card-hover-bg: #30363d;
        --text-color: #f0f6fc;
        --text-secondary: #8b949e;
        --text-muted: #6e7681;
        --border-color: #30363d;
        --light-gray: #21262d;
        --medium-gray: #8b949e;
        --dark-gray: #f0f6fc;
        --shadow-color: rgba(0,0,0,0.4);
        
        /* 深色模式下的主色调调整 */
        --primary-color: #58a6ff;
        --secondary-color: #3fb950;
        --warning-color: #d29922;
        --danger-color: #f85149;
        --success-color: #3fb950;
        
        /* 深色模式渐变色 */
        --gradient-primary: linear-gradient(135deg, #58a6ff, #3fb950);
        --gradient-card: linear-gradient(135deg, #21262d, #30363d);
        
        /* 深色模式阴影 */
        --shadow: 0 2px 10px rgba(0,0,0,0.4);
        --shadow-hover: 0 5px 20px rgba(0,0,0,0.6);
    }
    
    /* 基础元素深色适配 */
    body {
        background: var(--background-color);
        color: var(--text-color);
    }
    
    /* 卡片和容器深色适配 */
    .card,
    .student-card,
    .practice-status-card,
    .stat-card,
    .today-status-card {
        background: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .card:hover,
    .student-card:hover,
    .practice-status-card:hover {
        background: var(--card-hover-bg);
    }
    
    /* 导航和标签深色适配 */
    .nav-tabs {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .nav-tab {
        color: var(--medium-gray);
    }
    
    .nav-tab:hover {
        background: rgba(88, 166, 255, 0.1);
        color: var(--primary-color);
    }
    
    .nav-tab.active {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 语言切换器深色适配 */
    .language-switcher {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .lang-btn {
        color: var(--medium-gray);
    }
    
    .lang-btn:hover:not(.active) {
        background: rgba(88, 166, 255, 0.1);
        color: var(--primary-color);
    }
    
    .lang-btn.active {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 连接状态指示器深色适配 */
    .connection-status.online {
        background: var(--card-bg);
        color: var(--success-color);
        border-color: var(--success-color);
    }
    
    .connection-status.offline {
        background: var(--card-bg);
        color: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .connection-status.syncing {
        background: var(--card-bg);
        color: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    /* 筛选器深色适配 */
    .filters,
    .practice-filters {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    /* 🔥 新增：特定容器的筛选器深色适配 */
    #todaySnapshot .practice-filters,
    #practiceStatusContainer .practice-filters {
        background: var(--card-bg) !important;
        border: 1px solid var(--border-color) !important;
    }
    
    /* 筛选器内的网格容器深色适配 */
    .practice-filters .student-grid {
        border-top-color: var(--border-color);
    }
    
    /* 筛选器标签和输入框深色适配 */
    .practice-filter-label,
    .filter-label {
        color: var(--medium-gray);
    }
    /* 移动端筛选器深色适配 */
    @media (max-width: 768px) {
        .filters {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        
        .practice-filters {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        
        #todaySnapshot .practice-filters,
        #practiceStatusContainer .practice-filters {
            background: var(--card-bg) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        .date-picker {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }
    }    
    .filter-select,
    .filter-input,
    .practice-filter-select,
    .practice-filter-input,
    .date-input {
        background: var(--background-color);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .filter-select:focus,
    .filter-input:focus,
    .practice-filter-select:focus,
    .practice-filter-input:focus,
    .date-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3);
    }
    
    .filter-select:hover,
    .filter-input:hover,
    .practice-filter-select:hover,
    .practice-filter-input:hover,
    .date-input:hover {
        border-color: var(--primary-color);
    }
    
    /* 快速筛选标签深色适配 */
    .quick-filter-tag {
        background: var(--card-hover-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .quick-filter-tag:hover {
        background: #484f58;
        transform: translateY(-1px);
    }
    
    .quick-filter-tag.active {
        background: var(--primary-color);
        color: #0d1117;
        border-color: var(--primary-color);
    }

    
    /* 按钮深色适配 */
    .btn-primary {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    .btn-primary:hover {
        background: #1f6feb;
    }
    
    .btn-success {
        background: var(--success-color);
        color: #0d1117;
    }
    
    .btn-success:hover {
        background: #2ea043;
    }
    
    .btn-warning {
        background: var(--warning-color);
        color: #0d1117;
    }
    
    .btn-warning:hover {
        background: #bb8009;
    }
    
    .btn-danger {
        background: var(--danger-color);
        color: #0d1117;
    }
    
    .btn-danger:hover {
        background: #da3633;
    }
    
    .btn-secondary {
        background: var(--medium-gray);
        color: #0d1117;
    }
    
    .btn-secondary:hover {
        background: #6e7681;
    }
    
    .btn-outline {
        background: transparent;
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-outline:hover {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 模态框深色适配 */
    .modal {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .modal-content {
        background: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    .modal-close {
        background: var(--card-hover-bg);
        color: var(--medium-gray);
    }
    
    .modal-close:hover {
        background: var(--danger-color);
        color: #0d1117;
    }
    
    /* 表格深色适配 */
    .data-table,
    .detail-table {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .data-table th,
    .data-table td,
    .detail-table th,
    .detail-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    .data-table th,
    .detail-table th {
        background: var(--card-hover-bg);
        color: var(--text-color);
        border-bottom-color: var(--border-color);
    }
    
    .data-table tr:hover,
    .detail-table tr:hover {
        background: var(--card-hover-bg);
    }
    
    .history-table-card .table-container {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
    /* 状态标签深色模式适配 */
    .student-status.present,
    .student-status-compact.present,
    .table-status-badge.present,
    .status-badge.present {
        background: #238636;
        color: #aff5b4;
        border-color: #2ea043;
    }
    
    .student-status.absent,
    .student-status-compact.absent,
    .table-status-badge.absent,
    .status-badge.absent {
        background: #da3633;
        color: #ffdcd7;
        border-color: #f85149;
    }
    
    .student-status.excused,
    .student-status-compact.excused,
    .table-status-badge.excused,
    .status-badge.excused {
        background: #bb8009;
        color: #f2cc60;
        border-color: #d29922;
    }
    
    .student-status.low-efficiency,
    .student-status-compact.low-efficiency,
    .table-status-badge.low-efficiency,
    .status-badge.low-efficiency {
        background: #9a6700;
        color: #f2cc60;
        border-color: #bb8009;
    }
    
    .student-status.practicing-unscheduled,
    .student-status-compact.practicing-unscheduled,
    .table-status-badge.practicing-unscheduled,
    .status-badge.practicing-unscheduled {
        background: #8250df;
        color: #d2a8ff;
        border-color: #a475f9;
    }
    
    .student-status.weekend,
    .student-status-compact.weekend,
    .table-status-badge.weekend,
    .status-badge.weekend {
        background: #6e7681;
        color: #f0f6fc;
        border-color: #8b949e;
    }
    
    .student-status.pending,
    .student-status-compact.pending,
    .table-status-badge.pending,
    .status-badge.pending {
        background: #30363d;
        color: #8b949e;
        border-color: #484f58;
    }
    
    /* 练琴时长标签深色适配 */
    .practice-duration,
    .practice-duration-large {
        background: #8250df;
        color: #d2a8ff;
        border-color: #a475f9;
    }
    
    /* 考勤历史时间轴深色适配 */
    .history-day.present {
        background: var(--success-color);
        border-color: var(--success-color);
    }
    
    .history-day.absent {
        background: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .history-day.excused {
        background: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    .history-day.no-data {
        background: var(--card-hover-bg);
        color: var(--medium-gray);
        border-color: var(--border-color);
    }
    
    .history-day.low-efficiency {
        background: #9a6700;
        border-color: #bb8009;
    }
    
    .history-day.practicing-unscheduled {
        background: #8250df;
        border-color: #a475f9;
    }
    
    .history-day.weekend {
        background: #6e7681;
        border-color: #8b949e;
    }
    
    /* 卡片边框颜色深色适配 */
    .practice-status-card.present,
    .student-card.present {
        border-left-color: var(--success-color);
    }
    
    .practice-status-card.absent,
    .student-card.absent {
        border-left-color: var(--danger-color);
    }
    
    .practice-status-card.excused,
    .student-card.excused {
        border-left-color: var(--warning-color);
    }
    
    .practice-status-card.low-efficiency,
    .student-card.low-efficiency {
        border-left-color: #bb8009;
    }
    
    .practice-status-card.practicing-unscheduled,
    .student-card.practicing-unscheduled {
        border-left-color: #8250df;
    }
    
    .practice-status-card.weekend,
    .student-card.weekend {
        border-left-color: #6e7681;
        background: var(--gradient-card);
    }
    
    .practice-status-card.pending,
    .student-card.pending {
        border-left-color: var(--medium-gray);
    }
    
    /* 统计卡片深色适配 */
    .stats-grid-detailed .stat-item.present {
        background: linear-gradient(135deg, #0d2818, #238636);
    }
    
    .stats-grid-detailed .stat-item.absent {
        background: linear-gradient(135deg, #2c0e0e, #da3633);
    }
    
    .stats-grid-detailed .stat-item.excused {
        background: linear-gradient(135deg, #2d1b00, #bb8009);
    }
    
    .stats-grid-detailed .stat-item.rate {
        background: linear-gradient(135deg, #0c1929, #1f6feb);
    }
    
    /* 统计图标背景深色适配 */
    .stats-grid-detailed .stat-icon,
    .metric-icon {
        background: rgba(240, 246, 252, 0.1);
    }
    
    /* 请假信息深色适配 */
    .excuse-info {
        background: rgba(187, 128, 9, 0.15);
        border-left-color: var(--warning-color);
    }
    
    .excuse-title {
        color: var(--warning-color);
    }
    
    .excuse-reason {
        color: #f2cc60;
    }
    
    .excuse-approver {
        color: #d29922;
    }
    
    /* 空状态深色适配 */
    .empty-state,
    .practice-empty-state,
    .table-empty-state {
        color: var(--medium-gray);
    }
    
    .empty-state-title,
    .practice-empty-state-title,
    .table-empty-state-title {
        color: var(--text-color);
    }
    
    /* 加载动画深色适配 */
    .spinner {
        border-color: var(--card-hover-bg);
        border-top-color: var(--primary-color);
    }
    
    .loading-text {
        color: var(--medium-gray);
    }
    
    /* 滚动条深色适配 */
    *::-webkit-scrollbar-track {
        background: var(--background-color);
    }
    
    *::-webkit-scrollbar-thumb {
        background-color: var(--card-hover-bg);
    }
    
    *::-webkit-scrollbar-thumb:hover {
        background-color: #484f58;
    }
    
    /* 表格滚动提示深色适配 */
    .table-scroll-hint {
        background: rgba(13, 17, 23, 0.9);
        color: var(--text-color);
    }
    
    /* 详情标签深色适配 */
    .detail-label {
        color: var(--medium-gray);
    }
    
    .detail-value {
        color: var(--text-color);
    }
    
    /* 特殊内容处理深色适配 */
    .detail-item .detail-value[style*="color: #f39c12"] {
        background: rgba(187, 128, 9, 0.15) !important;
        color: #f2cc60 !important;
    }
    
    /* 同步日志深色适配 */
    #syncLogs {
        background: var(--background-color) !important;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    /* 日期选择器深色适配 */
    .date-picker {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    /* 学生档案卡片深色渐变 */
    .student-profile-card {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    }
    
    /* 今日状态卡片深色适配 */
    .today-status-card.present { border-left-color: var(--success-color); }
    .today-status-card.absent { border-left-color: var(--danger-color); }
    .today-status-card.excused { border-left-color: var(--warning-color); }
    .today-status-card.low-efficiency { border-left-color: #bb8009; }
    .today-status-card.practicing-unscheduled { border-left-color: #8250df; }
    .today-status-card.weekend { border-left-color: #6e7681; }
    
    /* 指标项深色适配 */
    .metric-item {
        background: var(--card-hover-bg);
    }
    
    .metric-content {
        color: var(--text-color);
    }
    
    .metric-label {
        color: var(--medium-gray);
    }
    
    .metric-value {
        color: var(--text-color);
    }
    
    /* 卡片标题深色适配 */
    .card-title,
    .status-title,
    .modal-title {
        color: var(--text-color);
    }
    
    .title-subtitle {
        color: var(--medium-gray);
    }
    
    /* 考勤历史边框深色适配 */
    .attendance-history {
        border-top-color: var(--border-color);
    }
    
    /* 头部深色适配 */
    .header {
        background: var(--gradient-primary);
    }
    
    /* 移动端按钮背景深色适配 */
    @media (max-width: 768px) {
        .action-buttons {
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
        }
    }
    
    /* 高对比度模式下的深色适配 */
    @media (prefers-contrast: high) {
        :root {
            --border-color: #58a6ff;
            --text-color: #ffffff;
            --background-color: #000000;
        }
        
        .card {
            border: 2px solid var(--primary-color);
        }
        
        .btn {
            border: 2px solid currentColor;
        }
    }
}

/* ===== 37. 优化和清理 ===== */
/* 确保所有交互元素都有合适的过渡效果 */
button,
input,
select,
textarea,
.card,
.student-card,
.practice-status-card,
.stat-card,
.btn,
.nav-tab,
.quick-filter-tag,
.history-day {
    transition: all 0.3s ease;
}

/* 防止文本选择在某些交互元素上 */
.nav-tab,
.btn,
.student-status,
.student-status-compact,
.practice-duration,
.quick-filter-tag,
.history-day,
.stat-card {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

/* 确保图标和emoji正确显示 */
.title-icon,
.meta-icon,
.metric-icon,
.excuse-icon,
.stat-icon,
.practice-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* 最终的响应式优化 */
@media (max-width: 320px) {
    .container {
        padding: 8px;
    }
    
    .card {
        padding: 15px 10px;
    }
    
    .student-card,
    .practice-status-card {
        padding: 10px 8px;
        min-height: 100px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
}
/* ===== 考勤详情模态框优化 ===== */
#attendanceDetailModal .modal-content {
    max-width: 800px;
    width: 95%;
}

/* 响应式优化 */
@media (max-width: 768px) {
    #attendanceDetailModal .stats-grid-detailed {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px;
    }
    
    #attendanceDetailModal .stat-item {
        padding: 12px;
        min-height: 60px;
    }
    
    #attendanceDetailModal .stat-number {
        font-size: 1.2rem;
    }
    
    #attendanceDetailModal .stat-label {
        font-size: 0.8rem;
    }
}

/* 点击提示 */
.history-day {
    cursor: pointer;
    transition: all 0.3s ease;
}

.history-day:hover {
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* ===== 防止模态框背景滚动 ===== */
body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
}

/* 移动端防滚动优化 */
@media (max-width: 768px) {
    body.modal-open {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        -webkit-overflow-scrolling: none;
    }
}
/* ===== 考勤详情模态框表格滚动修复 ===== */
#attendanceDetailModal .data-table-container {
    max-height: 300px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    /* 🔥 新增：确保滚动容器不超出边界 */
    width: 100%;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

#attendanceDetailModal .data-table {
    width: 100%;
    min-width: 500px; /* 🔥 设置最小宽度确保表格可读性 */
    border-collapse: collapse;
    margin: 0;
    background: white;
    border-radius: 0; /* 🔥 移除表格圆角，由容器控制 */
    overflow: hidden;
    box-shadow: none; /* 🔥 移除表格阴影，由容器控制 */
    font-size: 0.85rem; /* 🔥 稍微减小字体以适应更多内容 */
}

#attendanceDetailModal .data-table th,
#attendanceDetailModal .data-table td {
    padding: 10px 12px; /* 🔥 减少内边距 */
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    vertical-align: middle;
    /* 🔥 新增：设置最小和最大宽度 */
    min-width: 80px;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
}

#attendanceDetailModal .data-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.75rem; /* 🔥 表头字体更小 */
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10;
}

/* 🔥 新增：特定列宽度控制 */
#attendanceDetailModal .data-table th:nth-child(1),
#attendanceDetailModal .data-table td:nth-child(1) {
    min-width: 120px; /* 时间段列 */
    max-width: 150px;
}

#attendanceDetailModal .data-table th:nth-child(2),
#attendanceDetailModal .data-table td:nth-child(2) {
    min-width: 80px; /* 状态列 */
    max-width: 100px;
}

#attendanceDetailModal .data-table th:nth-child(3),
#attendanceDetailModal .data-table td:nth-child(3) {
    min-width: 90px; /* 练琴时长列 */
    max-width: 120px;
}

#attendanceDetailModal .data-table th:nth-child(4),
#attendanceDetailModal .data-table td:nth-child(4) {
    min-width: 80px; /* 琴房列 */
    max-width: 100px;
}

#attendanceDetailModal .data-table th:nth-child(5),
#attendanceDetailModal .data-table td:nth-child(5) {
    min-width: 100px; /* 备注列 */
    max-width: 200px;
}

/* 🔥 新增：表格行悬停效果优化 */
#attendanceDetailModal .data-table tr:hover {
    background: var(--light-gray);
}

#attendanceDetailModal .data-table tr:last-child td {
    border-bottom: none;
}

/* 🔥 新增：状态标签在表格中的样式调整 */
#attendanceDetailModal .table-status-badge {
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    white-space: nowrap;
    display: inline-block;
    border: 1px solid transparent;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 🔥 新增：滚动条样式优化 */
#attendanceDetailModal .data-table-container::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

#attendanceDetailModal .data-table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#attendanceDetailModal .data-table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#attendanceDetailModal .data-table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 🔥 新增：移动端优化 */
@media (max-width: 768px) {
    #attendanceDetailModal .data-table-container {
        max-height: 250px;
        margin: 0 -10px; /* 🔥 移动端扩展到边缘 */
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    #attendanceDetailModal .data-table {
        min-width: 450px; /* 🔥 移动端最小宽度 */
        font-size: 0.8rem;
    }
    
    #attendanceDetailModal .data-table th,
    #attendanceDetailModal .data-table td {
        padding: 8px 6px; /* 🔥 移动端更紧凑的内边距 */
        min-width: 60px;
    }
    
    #attendanceDetailModal .data-table th {
        font-size: 0.7rem;
    }
    
    #attendanceDetailModal .table-status-badge {
        padding: 2px 6px;
        font-size: 0.6rem;
        border-radius: 8px;
    }
    
    /* 🔥 移动端列宽调整 */
    #attendanceDetailModal .data-table th:nth-child(1),
    #attendanceDetailModal .data-table td:nth-child(1) {
        min-width: 100px;
        max-width: 120px;
    }
    
    #attendanceDetailModal .data-table th:nth-child(2),
    #attendanceDetailModal .data-table td:nth-child(2) {
        min-width: 70px;
        max-width: 80px;
    }
    
    #attendanceDetailModal .data-table th:nth-child(3),
    #attendanceDetailModal .data-table td:nth-child(3) {
        min-width: 80px;
        max-width: 100px;
    }
    
    #attendanceDetailModal .data-table th:nth-child(4),
    #attendanceDetailModal .data-table td:nth-child(4) {
        min-width: 70px;
        max-width: 90px;
    }
    
    #attendanceDetailModal .data-table th:nth-child(5),
    #attendanceDetailModal .data-table td:nth-child(5) {
        min-width: 90px;
        max-width: 150px;
    }
}

@media (max-width: 480px) {
    #attendanceDetailModal .data-table-container {
        max-height: 200px;
    }
    
    #attendanceDetailModal .data-table {
        min-width: 400px;
        font-size: 0.75rem;
    }
    
    #attendanceDetailModal .data-table th,
    #attendanceDetailModal .data-table td {
        padding: 6px 4px;
        min-width: 50px;
    }
    
    #attendanceDetailModal .data-table th {
        font-size: 0.65rem;
    }
    
    #attendanceDetailModal .table-status-badge {
        padding: 1px 4px;
        font-size: 0.55rem;
        border-radius: 6px;
    }
}

/* 🔥 新增：滚动提示 */
#attendanceDetailModal .data-table-container::after {
    content: '← 左右滑动查看更多 →';
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 5;
}

#attendanceDetailModal .data-table-container:hover::after {
    opacity: 1;
}

/* 🔥 移动端滚动提示 */
@media (max-width: 768px) {
    #attendanceDetailModal .data-table-container::after {
        content: '← 滑动 →';
        font-size: 0.65rem;
        padding: 3px 6px;
        bottom: 6px;
        right: 6px;
    }
}

/* 🔥 新增：深色模式适配 */
@media (prefers-color-scheme: dark) {
    #attendanceDetailModal .data-table-container {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
    #attendanceDetailModal .data-table {
        background: var(--card-bg);
    }
    
    #attendanceDetailModal .data-table th,
    #attendanceDetailModal .data-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    #attendanceDetailModal .data-table th {
        background: var(--card-hover-bg);
        color: var(--text-color);
    }
    
    #attendanceDetailModal .data-table tr:hover {
        background: var(--card-hover-bg);
    }
    
    #attendanceDetailModal .data-table-container::-webkit-scrollbar-track {
        background: var(--card-hover-bg);
    }
    
    #attendanceDetailModal .data-table-container::-webkit-scrollbar-thumb {
        background: var(--medium-gray);
    }
    
    #attendanceDetailModal .data-table-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }
    
    #attendanceDetailModal .data-table-container::after {
        background: rgba(13, 17, 23, 0.9);
        color: var(--text-color);
    }
}
/* ===== 学生详情模态框表格滚动修复 ===== */
#studentDetailModal .data-table-container {
    max-height: 230px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    /* 🔥 新增：确保滚动容器不超出边界 */
    width: 100%;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

#studentDetailModal .data-table {
    width: 100%;
    min-width: 400px; /* 🔥 设置最小宽度确保表格可读性 */
    border-collapse: collapse;
    margin: 0;
    background: white;
    border-radius: 0; /* 🔥 移除表格圆角，由容器控制 */
    overflow: hidden;
    box-shadow: none; /* 🔥 移除表格阴影，由容器控制 */
    font-size: 0.85rem; /* 🔥 稍微减小字体以适应更多内容 */
}

#studentDetailModal .data-table th,
#studentDetailModal .data-table td {
    padding: 8px 10px; /* 🔥 减少内边距 */
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    vertical-align: middle;
    /* 🔥 新增：设置最小和最大宽度 */
    min-width: 70px;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
}

#studentDetailModal .data-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.75rem; /* 🔥 表头字体更小 */
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10;
}

/* 🔥 新增：练琴明细表格特定列宽度控制 */
#studentDetailModal .data-table th:nth-child(1),
#studentDetailModal .data-table td:nth-child(1) {
    min-width: 120px; /* 日期列 */
    max-width: 140px;
}

#studentDetailModal .data-table th:nth-child(2),
#studentDetailModal .data-table td:nth-child(2) {
    min-width: 60px; /* 段内列 */
    max-width: 80px;
    text-align: center;
}

#studentDetailModal .data-table th:nth-child(3),
#studentDetailModal .data-table td:nth-child(3) {
    min-width: 60px; /* 段外列 */
    max-width: 80px;
    text-align: center;
}

#studentDetailModal .data-table th:nth-child(4),
#studentDetailModal .data-table td:nth-child(4) {
    min-width: 70px; /* 总计列 */
    max-width: 90px;
    text-align: center;
    font-weight: 600;
}

/* 🔥 新增：表格行悬停效果优化 */
#studentDetailModal .data-table tr:hover {
    background: var(--light-gray);
}

#studentDetailModal .data-table tr:last-child td {
    border-bottom: none;
}

/* 🔥 新增：今日行特殊样式保持 */
#studentDetailModal .data-table .today-row {
    background: #f0f8ff;
}

#studentDetailModal .data-table .today-row:hover {
    background: #e6f3ff;
}

/* 🔥 新增：滚动条样式优化 */
#studentDetailModal .data-table-container::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

#studentDetailModal .data-table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#studentDetailModal .data-table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#studentDetailModal .data-table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 🔥 新增：移动端优化 */
@media (max-width: 768px) {
    #studentDetailModal .data-table-container {
        max-height: 200px;
        margin: 0 -15px; /* 🔥 移动端扩展到边缘 */
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    #studentDetailModal .data-table {
        min-width: 350px; /* 🔥 移动端最小宽度 */
        font-size: 0.8rem;
    }
    
    #studentDetailModal .data-table th,
    #studentDetailModal .data-table td {
        padding: 6px 8px; /* 🔥 移动端更紧凑的内边距 */
        min-width: 50px;
    }
    
    #studentDetailModal .data-table th {
        font-size: 0.7rem;
    }
    
    /* 🔥 移动端列宽调整 */
    #studentDetailModal .data-table th:nth-child(1),
    #studentDetailModal .data-table td:nth-child(1) {
        min-width: 100px;
        max-width: 120px;
    }
    
    #studentDetailModal .data-table th:nth-child(2),
    #studentDetailModal .data-table td:nth-child(2) {
        min-width: 50px;
        max-width: 60px;
    }
    
    #studentDetailModal .data-table th:nth-child(3),
    #studentDetailModal .data-table td:nth-child(3) {
        min-width: 50px;
        max-width: 60px;
    }
    
    #studentDetailModal .data-table th:nth-child(4),
    #studentDetailModal .data-table td:nth-child(4) {
        min-width: 60px;
        max-width: 70px;
    }
}

@media (max-width: 480px) {
    #studentDetailModal .data-table-container {
        max-height: 180px;
    }
    
    #studentDetailModal .data-table {
        min-width: 320px;
        font-size: 0.75rem;
    }
    
    #studentDetailModal .data-table th,
    #studentDetailModal .data-table td {
        padding: 5px 6px;
        min-width: 45px;
    }
    
    #studentDetailModal .data-table th {
        font-size: 0.65rem;
    }
    
    /* 🔥 超小屏幕列宽调整 */
    #studentDetailModal .data-table th:nth-child(1),
    #studentDetailModal .data-table td:nth-child(1) {
        min-width: 90px;
        max-width: 100px;
    }
    
    #studentDetailModal .data-table th:nth-child(2),
    #studentDetailModal .data-table td:nth-child(2) {
        min-width: 45px;
        max-width: 50px;
    }
    
    #studentDetailModal .data-table th:nth-child(3),
    #studentDetailModal .data-table td:nth-child(3) {
        min-width: 45px;
        max-width: 50px;
    }
    
    #studentDetailModal .data-table th:nth-child(4),
    #studentDetailModal .data-table td:nth-child(4) {
        min-width: 50px;
        max-width: 60px;
    }
}

/* 🔥 新增：滚动提示 */
#studentDetailModal .data-table-container::after {
    content: '← 左右滑动查看更多 →';
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 5;
}

#studentDetailModal .data-table-container:hover::after {
    opacity: 1;
}

/* 🔥 移动端滚动提示 */
@media (max-width: 768px) {
    #studentDetailModal .data-table-container::after {
        content: '← 滑动 →';
        font-size: 0.65rem;
        padding: 3px 6px;
        bottom: 6px;
        right: 6px;
    }
}

/* 🔥 新增：深色模式适配 */
@media (prefers-color-scheme: dark) {
    #studentDetailModal .data-table-container {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
    #studentDetailModal .data-table {
        background: var(--card-bg);
    }
    
    #studentDetailModal .data-table th,
    #studentDetailModal .data-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    #studentDetailModal .data-table th {
        background: var(--card-hover-bg);
        color: var(--text-color);
    }
    
    #studentDetailModal .data-table tr:hover {
        background: var(--card-hover-bg);
    }
    
    #studentDetailModal .data-table .today-row {
        background: rgba(88, 166, 255, 0.15) !important;
    }
    
    #studentDetailModal .data-table .today-row:hover {
        background: rgba(88, 166, 255, 0.25) !important;
    }
    
    #studentDetailModal .data-table .today-row .date-cell small {
        color: var(--primary-color) !important;
    }
    
    #studentDetailModal .data-table-container::-webkit-scrollbar-track {
        background: var(--card-hover-bg);
    }
    
    #studentDetailModal .data-table-container::-webkit-scrollbar-thumb {
        background: var(--medium-gray);
    }
    
    #studentDetailModal .data-table-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }
    
    #studentDetailModal .data-table-container::after {
        background: rgba(13, 17, 23, 0.9);
        color: var(--text-color);
    }
}
/* ===== 报告页面表格滚动修复 ===== */
#reportsTab .data-table-container {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    /* 🔥 新增：确保滚动容器不超出边界 */
    width: 100%;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

#reportsTab .data-table {
    width: 100%;
    min-width: 500px; /* 🔥 设置最小宽度确保表格可读性 */
    border-collapse: collapse;
    margin: 0;
    background: white;
    border-radius: 0; /* 🔥 移除表格圆角，由容器控制 */
    overflow: hidden;
    box-shadow: none; /* 🔥 移除表格阴影，由容器控制 */
    font-size: 0.85rem; /* 🔥 稍微减小字体以适应更多内容 */
}

#reportsTab .data-table th,
#reportsTab .data-table td {
    padding: 8px 10px; /* 🔥 减少内边距 */
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    vertical-align: middle;
    /* 🔥 新增：设置最小和最大宽度 */
    min-width: 70px;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
}

#reportsTab .data-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.75rem; /* 🔥 表头字体更小 */
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10;
}

/* 🔥 新增：每日考勤趋势表格列宽控制 */
#reportsTab .data-table.daily-trend th:nth-child(1),
#reportsTab .data-table.daily-trend td:nth-child(1) {
    min-width: 100px; /* 日期列 */
    max-width: 120px;
}

#reportsTab .data-table.daily-trend th:nth-child(2),
#reportsTab .data-table.daily-trend td:nth-child(2) {
    min-width: 60px; /* 合计列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.daily-trend th:nth-child(3),
#reportsTab .data-table.daily-trend td:nth-child(3) {
    min-width: 60px; /* 出勤列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.daily-trend th:nth-child(4),
#reportsTab .data-table.daily-trend td:nth-child(4) {
    min-width: 60px; /* 缺勤列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.daily-trend th:nth-child(5),
#reportsTab .data-table.daily-trend td:nth-child(5) {
    min-width: 60px; /* 请假列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.daily-trend th:nth-child(6),
#reportsTab .data-table.daily-trend td:nth-child(6) {
    min-width: 80px; /* 出勤率列 */
    max-width: 100px;
    text-align: center;
    font-weight: 600;
}

/* 🔥 新增：学生考勤统计表格列宽控制 */
#reportsTab .data-table.student-stats th:nth-child(1),
#reportsTab .data-table.student-stats td:nth-child(1) {
    min-width: 100px; /* 姓名列 */
    max-width: 150px;
}

#reportsTab .data-table.student-stats th:nth-child(2),
#reportsTab .data-table.student-stats td:nth-child(2) {
    min-width: 80px; /* 专业列 */
    max-width: 120px;
}

#reportsTab .data-table.student-stats th:nth-child(3),
#reportsTab .data-table.student-stats td:nth-child(3) {
    min-width: 60px; /* 出勤列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.student-stats th:nth-child(4),
#reportsTab .data-table.student-stats td:nth-child(4) {
    min-width: 60px; /* 缺勤列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.student-stats th:nth-child(5),
#reportsTab .data-table.student-stats td:nth-child(5) {
    min-width: 60px; /* 请假列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.student-stats th:nth-child(6),
#reportsTab .data-table.student-stats td:nth-child(6) {
    min-width: 80px; /* 出勤率列 */
    max-width: 100px;
    text-align: center;
    font-weight: 600;
}

/* 🔥 新增：表格行悬停效果优化 */
#reportsTab .data-table tr:hover {
    background: var(--light-gray);
}

#reportsTab .data-table tr:last-child td {
    border-bottom: none;
}

/* 🔥 新增：滚动条样式优化 */
#reportsTab .data-table-container::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

#reportsTab .data-table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#reportsTab .data-table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#reportsTab .data-table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 🔥 新增：移动端优化 */
@media (max-width: 768px) {
    #reportsTab .data-table-container {
        margin: 0 -15px; /* 🔥 移动端扩展到边缘 */
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    /* 每日考勤趋势表格移动端优化 */
    #reportsTab .data-table-container:first-of-type {
        max-height: 250px;
    }
    
    /* 学生考勤统计表格移动端优化 */
    #reportsTab .data-table-container:last-of-type {
        max-height: 300px;
    }
    
    #reportsTab .data-table {
        font-size: 0.8rem;
    }
    
    #reportsTab .data-table th,
    #reportsTab .data-table td {
        padding: 6px 8px; /* 🔥 移动端更紧凑的内边距 */
        min-width: 50px;
    }
    
    #reportsTab .data-table th {
        font-size: 0.7rem;
    }
    
    /* 🔥 移动端每日趋势表格列宽调整 */
    #reportsTab .data-table.daily-trend {
        min-width: 450px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(1),
    #reportsTab .data-table.daily-trend td:nth-child(1) {
        min-width: 90px;
        max-width: 100px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(2),
    #reportsTab .data-table.daily-trend td:nth-child(2),
    #reportsTab .data-table.daily-trend th:nth-child(3),
    #reportsTab .data-table.daily-trend td:nth-child(3),
    #reportsTab .data-table.daily-trend th:nth-child(4),
    #reportsTab .data-table.daily-trend td:nth-child(4),
    #reportsTab .data-table.daily-trend th:nth-child(5),
    #reportsTab .data-table.daily-trend td:nth-child(5) {
        min-width: 50px;
        max-width: 60px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(6),
    #reportsTab .data-table.daily-trend td:nth-child(6) {
        min-width: 70px;
        max-width: 80px;
    }
    
    /* 🔥 移动端学生统计表格列宽调整 */
    #reportsTab .data-table.student-stats {
        min-width: 480px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(1),
    #reportsTab .data-table.student-stats td:nth-child(1) {
        min-width: 80px;
        max-width: 100px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(2),
    #reportsTab .data-table.student-stats td:nth-child(2) {
        min-width: 70px;
        max-width: 90px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(3),
    #reportsTab .data-table.student-stats td:nth-child(3),
    #reportsTab .data-table.student-stats th:nth-child(4),
    #reportsTab .data-table.student-stats td:nth-child(4),
    #reportsTab .data-table.student-stats th:nth-child(5),
    #reportsTab .data-table.student-stats td:nth-child(5) {
        min-width: 50px;
        max-width: 60px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(6),
    #reportsTab .data-table.student-stats td:nth-child(6) {
        min-width: 70px;
        max-width: 80px;
    }
}

@media (max-width: 480px) {
    #reportsTab .data-table-container:first-of-type {
        max-height: 200px;
    }
    
    #reportsTab .data-table-container:last-of-type {
        max-height: 250px;
    }
    
    #reportsTab .data-table {
        font-size: 0.75rem;
    }
    
    #reportsTab .data-table th,
    #reportsTab .data-table td {
        padding: 5px 6px;
        min-width: 45px;
    }
    
    #reportsTab .data-table th {
        font-size: 0.65rem;
    }
    
    /* 🔥 超小屏幕每日趋势表格优化 */
    #reportsTab .data-table.daily-trend {
        min-width: 400px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(1),
    #reportsTab .data-table.daily-trend td:nth-child(1) {
        min-width: 80px;
        max-width: 90px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(2),
    #reportsTab .data-table.daily-trend td:nth-child(2),
    #reportsTab .data-table.daily-trend th:nth-child(3),
    #reportsTab .data-table.daily-trend td:nth-child(3),
    #reportsTab .data-table.daily-trend th:nth-child(4),
    #reportsTab .data-table.daily-trend td:nth-child(4),
    #reportsTab .data-table.daily-trend th:nth-child(5),
    #reportsTab .data-table.daily-trend td:nth-child(5) {
        min-width: 45px;
        max-width: 50px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(6),
    #reportsTab .data-table.daily-trend td:nth-child(6) {
        min-width: 60px;
        max-width: 70px;
    }
    
    /* 🔥 超小屏幕学生统计表格优化 */
    #reportsTab .data-table.student-stats {
        min-width: 420px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(1),
    #reportsTab .data-table.student-stats td:nth-child(1) {
        min-width: 70px;
        max-width: 80px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(2),
    #reportsTab .data-table.student-stats td:nth-child(2) {
        min-width: 60px;
        max-width: 70px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(3),
    #reportsTab .data-table.student-stats td:nth-child(3),
    #reportsTab .data-table.student-stats th:nth-child(4),
    #reportsTab .data-table.student-stats td:nth-child(4),
    #reportsTab .data-table.student-stats th:nth-child(5),
    #reportsTab .data-table.student-stats td:nth-child(5) {
        min-width: 45px;
        max-width: 50px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(6),
    #reportsTab .data-table.student-stats td:nth-child(6) {
        min-width: 60px;
        max-width: 70px;
    }
}

/* 🔥 新增：滚动提示 */
#reportsTab .data-table-container::after {
    content: '← 左右滑动查看更多 →';
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 5;
}

#reportsTab .data-table-container:hover::after {
    opacity: 1;
}

/* 🔥 移动端滚动提示 */
@media (max-width: 768px) {
    #reportsTab .data-table-container::after {
        content: '← 滑动 →';
        font-size: 0.65rem;
        padding: 3px 6px;
        bottom: 6px;
        right: 6px;
    }
}

/* 🔥 新增：深色模式适配 */
@media (prefers-color-scheme: dark) {
    #reportsTab .data-table-container {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
    #reportsTab .data-table {
        background: var(--card-bg);
    }
    
    #reportsTab .data-table th,
    #reportsTab .data-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    #reportsTab .data-table th {
        background: var(--card-hover-bg);
        color: var(--text-color);
    }
    
    #reportsTab .data-table tr:hover {
        background: var(--card-hover-bg);
    }
    
    #reportsTab .data-table-container::-webkit-scrollbar-track {
        background: var(--card-hover-bg);
    }
    
    #reportsTab .data-table-container::-webkit-scrollbar-thumb {
        background: var(--medium-gray);
    }
    
    #reportsTab .data-table-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }
    
    #reportsTab .data-table-container::after {
        background: rgba(13, 17, 23, 0.9);
        color: var(--text-color);
    }
}


/* ===== 样式文件结束 ===== */

</style>
</head>
<body>
<div class="container">
    <!-- 语言切换器 -->
    <div class="language-switcher">
        <button class="lang-btn active" onclick="switchLanguage('zh')" data-lang="zh">中文</button>
        <button class="lang-btn" onclick="switchLanguage('en')" data-lang="en">EN</button>
    </div>

    <!-- 连接状态指示器 -->
    <div id="connectionStatus" class="connection-status offline">
        <span data-i18n="status.offline">🔴 离线模式</span>
    </div>

    <!-- 头部 -->
    <div class="header">
        <h1><span data-i18n="header.title">🎼 青岛耶胡迪梅纽因学校</span></h1>
        <div class="subtitle" data-i18n="header.subtitle">实时练琴跟踪系统</div>
    </div>

    <!-- 导航标签 -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')">
            <span data-i18n="nav.dashboard">📊 考勤概览</span>
        </button>
        <button class="nav-tab" onclick="switchTab('students')">
            <span data-i18n="nav.students">👥 学生详情</span>
        </button>
        <button class="nav-tab" onclick="switchTab('reports')">
            <span data-i18n="nav.reports">📈 历史报告</span>
        </button>
        <button class="nav-tab" onclick="switchTab('sync')">
            <span data-i18n="nav.sync">🔄 数据同步</span>
        </button>
    </div>

    <!-- 考勤概览 -->
    <div id="dashboardTab" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label" data-i18n="stats.total">总学生数</div>
                <div class="stat-description" data-i18n="stats.total.desc">已登记学生</div>
            </div>
            <div class="stat-card present">
                <div class="stat-number" id="presentCount">0</div>
                <div class="stat-label" data-i18n="stats.present">出勤</div>
                <div class="stat-description" data-i18n="stats.present.desc">当前在琴房</div>
            </div>
            <div class="stat-card absent">
                <div class="stat-number" id="absentCount">0</div>
                <div class="stat-label" data-i18n="stats.absent">缺勤</div>
                <div class="stat-description" data-i18n="stats.absent.desc">未到/未登记</div>
            </div>
            <div class="stat-card excused">
                <div class="stat-number" id="excusedCount">0</div>
                <div class="stat-label" data-i18n="stats.excused">请假</div>
                <div class="stat-description" data-i18n="stats.excused.desc">已批准请假</div>
            </div>
        </div>

        <!-- 请假信息 -->
        <div class="card" id="excuseInfoPanel" style="display:none;">
            <h3 data-i18n="excuse.title">📝 今日请假信息</h3>
            <div id="excuseInfoContainer"></div>
        </div>

        <!-- 实时练琴状态 -->
        <div class="card">
            <h3 data-i18n="practice.title">🎹 实时练琴状态</h3>
            <div class="date-picker">
                <span style="color:#666;font-size:14px;">
                    <span data-i18n="practice.current_time">当前时间：</span>
                    <span id="currentTime"></span>
                </span>
            </div>
            <!-- 🔥 修改：移除独立的 practiceStatusContainer，直接在这里渲染 -->
            <div id="practiceStatusContainer">
                <!-- 筛选器和结果将在这里动态生成 -->
            </div>
        </div>

        <!-- 今日考勤快照（从 attendanceRecords 读取，如无则提示） -->
        <div class="card">
            <h3 data-i18n="attendance.title">📅 今日考勤快照</h3>
            <div class="date-picker">
                <label data-i18n="attendance.select_date">选择日期：</label>
                <input type="date" id="dateSelect" class="date-input" onchange="loadAttendanceData()">
            </div>
            <div id="todaySnapshot" class="loading">
                <div class="spinner"></div>
                <div class="loading-text" data-i18n="msg.loading">加载中...</div>
            </div>
        </div>
    </div>

    <!-- 学生详情 -->
    <div id="studentsTab" class="tab-content" style="display:none;">
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.major">专业筛选</label>
                    <select id="majorFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_majors">所有专业</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.grade">年级筛选</label>
                    <select id="gradeFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_grades">所有年级</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.status">考勤状态</label>
                    <select id="statusFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_status">所有状态</option>
                        <option value="present" data-i18n="status.present">出勤</option>
                        <option value="absent" data-i18n="status.absent">缺勤</option>
                        <option value="excused" data-i18n="status.excused">请假</option>
                        <option value="pending" data-i18n="status.pending">待考勤</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.search">搜索学生</label>
                    <input type="text" id="studentSearch" class="filter-input"
                           data-i18n-placeholder="filter.search_placeholder"
                           placeholder="输入学生姓名..." oninput="filterStudents()">
                </div>
            </div>
        </div>
        <div id="studentList" class="student-grid"></div>
    </div>

    <!-- 历史报告 -->
    <div id="reportsTab" class="tab-content" style="display:none;">
        <div class="card">
            <h3 data-i18n="report.title">📈 考勤历史分析</h3>
            <div class="date-picker">
                <label data-i18n="report.start_date">开始日期：</label>
                <input type="date" id="startDate" class="date-input">
                <label data-i18n="report.end_date">结束日期：</label>
                <input type="date" id="endDate" class="date-input">
                <button class="btn btn-primary" onclick="generateReport()">
                    <span>📊</span><span data-i18n="btn.generate_report">生成报告</span>
                </button>
            </div>
            <div id="reportContent">
                <div class="empty-state">
                    <div class="empty-state-icon">📊</div>
                    <div class="empty-state-title" data-i18n="report.empty.title">选择日期范围生成报告</div>
                    <div class="empty-state-description" data-i18n="report.empty.desc">选择开始和结束日期，然后点击"生成报告"</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 同步信息 -->
    <div id="syncTab" class="tab-content" style="display:none;">
        <div class="card">
            <h3 data-i18n="sync.title">🔄 数据同步管理</h3>
            <div class="card success" id="syncStatus">
                <h4 data-i18n="sync.status">同步状态</h4>
                <p id="syncStatusText" data-i18n="sync.checking">正在检查连接状态...</p>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="forceSync()">
                        <span>🔄</span><span data-i18n="btn.force_sync">强制同步</span>
                    </button>
                    <button class="btn btn-warning" onclick="clearLocalCache()">
                        <span>🗑️</span><span data-i18n="btn.clear_cache">清除缓存</span>
                    </button>
                </div>
            </div>
            <div class="card">
                <h4 data-i18n="sync.logs">📋 同步日志</h4>
                <div id="syncLogs" style="max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px;white-space:pre-line;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 学生详情模态 -->
<div id="studentDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="studentDetailTitle" data-i18n="student.detail.title">学生详情</h3>
            <button class="modal-close" onclick="closeModal('studentDetailModal')">&times;</button>
        </div>
        <div id="studentDetailContent"></div>
    </div>
</div>

<script>
/* =============================
   1. 国际化配置（保留原结构）
   ============================= */
const i18n = {
  zh: {
    // 头部
    'header.title': '🎼 青岛耶胡迪梅纽因学校',
    'header.subtitle': '实时练琴跟踪系统',
    
    // 导航
    'nav.dashboard': '📊 考勤概览',
    'nav.students': '👥 学生详情', 
    'nav.reports': '📈 历史报告',
    'nav.sync': '🔄 数据同步',
    
    // 连接状态
    'status.online': '🟢 已连接',
    'status.offline': '🔴 离线模式',
    'status.syncing': '🟡 同步中',
    
    // 考勤状态
    'status.present': '出勤',
    'status.absent': '缺勤',
    'status.excused': '请假',
    'status.pending': '待考勤',
    'status.low_efficiency': '低效',


    // 统计
    'stats.total': '总学生数',
    'stats.total.desc': '已登记学生',
    'stats.present': '出勤',
    'stats.present.desc': '当前在琴房',
    'stats.absent': '缺勤',
    'stats.absent.desc': '未到/未登记',
    'stats.excused': '请假',
    'stats.excused.desc': '已批准请假',
    
    // 练琴相关
    'practice.title': '🎹 实时练琴状态',
    'practice.current_time': '当前时间：',
    'practice.empty.title': '当前没有学生在练琴',
    'practice.empty.desc.weekday': '等待学生开始练琴',
    'practice.in_slot': '段内',
    'practice.out_slot': '段外',
    
    // 考勤相关
    'attendance.title': '📅 今日考勤快照',
    'attendance.select_date': '选择日期：',
    'attendance.history': '最近7天考勤',
    'attendance.rate': '出勤率',
    'attendance.detail.suffix': '考勤详情',
    'attendance.summary': '考勤汇总',
    'attendance.detailed_records': '详细记录',
    'attendance.remarks': '备注',
    
    // 筛选器
    'filter.major': '专业筛选',
    'filter.grade': '年级筛选',
    'filter.status': '考勤状态',
    'filter.search': '搜索学生',
    'filter.all_majors': '所有专业',
    'filter.all_grades': '所有年级',
    'filter.all_status': '所有状态',
    'filter.search_placeholder': '输入学生姓名...',
    'filter.no_results': '没有符合条件的学生',
    'filter.try_different': '请尝试调整筛选条件',
    'filter.clear': '清除',
    
    // 学生信息
    'student.name': '姓名',
    'student.major': '专业',
    'student.grade': '年级',
    'student.room': '所在琴房',
    'student.time_slot': '时间段',
    'student.practice_duration': '练琴时长',
    'student.start_time': '最近开始',
    'student.not_in_room': '不在琴房',
    'student.not_started': '未开始',
    'student.not_set': '未设置',
    'student.unknown_major': '未知专业',
    'student.detail.title': '学生详情',
    'student.today_attendance': '今日考勤',
    'student.today_practice': '今日练琴时长',
    
    // 时间相关
    'time.hours': '小时',
    'time.minutes': '分钟',
    'time.seconds': '秒',
    'time.no_practice': '0分钟',
    
    // 请假相关
    'excuse.title': '📝 今日请假信息',
    'excuse.reason': '请假原因',
    'excuse.duration_text': '请假时长',
    'excuse.end_date': '结束日期',
    'excuse.not_filled': '未填写',
    
    // 报告相关
    'report.title': '📈 考勤历史分析',
    'report.start_date': '开始日期：',
    'report.end_date': '结束日期：',
    'report.empty.title': '选择日期范围生成报告',
    'report.empty.desc': '选择开始和结束日期，然后点击"生成报告"',
    'report.analysis_title': '📊 考勤分析报告',
    'report.period': '统计周期',
    'report.to': '至',
    'report.days': '天',
    'report.participants': '参与学生',
    'report.people': '人',
    'report.daily_trend': '📈 每日考勤趋势',
    'report.date': '日期',
    'report.total': '合计',
    'report.student_stats': '👥 学生考勤统计',
    'report.regenerate': '重新生成',
    
    // 同步相关
    'sync.title': '🔄 数据同步管理',
    'sync.status': '同步状态',
    'sync.checking': '正在检查连接状态...',
    'sync.logs': '📋 同步日志',
    'sync.force_sync': '强制同步',
    
    // 按钮
    'btn.generate_report': '生成报告',
    'btn.force_sync': '强制同步',
    'btn.clear_cache': '清除缓存',
    
    // 消息提示
    'msg.loading': '加载中...',
    'msg.no_data': '暂无数据',
    'msg.select_dates': '请选择开始和结束日期',
    'msg.date_range_error': '开始日期不能晚于结束日期',
    'msg.sync_required': '需要网络连接才能同步数据',
    'msg.clear_cache_confirm': '确定要清除本地缓存吗？',
    'msg.cache_cleared': '本地缓存已清除',
    
    // 空状态
    'empty.no_students': '暂无学生数据',
    'empty.no_attendance': '还没有考勤记录',
    'empty.load_failed': '加载失败'
  },
  
  en: {
    // 头部
    'header.title': '🎼 Qingdao Yehudi Menuhin School',
    'header.subtitle': 'Real-time Practice Tracking System',
    
    // 导航
    'nav.dashboard': '📊 Attendance Overview',
    'nav.students': '👥 Student Details',
    'nav.reports': '📈 Historical Reports',
    'nav.sync': '🔄 Data Sync',
    
    // 连接状态
    'status.online': '🟢 Connected',
    'status.offline': '🔴 Offline Mode',
    'status.syncing': '🟡 Syncing',
    
    // 考勤状态
    'status.present': 'Present',
    'status.absent': 'Absent',
    'status.excused': 'Excused',
    'status.pending': 'Pending',
    'status.low_efficiency': 'Low Efficiency',
    
    // 统计
    'stats.total': 'Total Students',
    'stats.total.desc': 'Registered Students',
    'stats.present': 'Present',
    'stats.present.desc': 'Currently in Rooms',
    'stats.absent': 'Absent',
    'stats.absent.desc': 'Not Present/Registered',
    'stats.excused': 'Excused',
    'stats.excused.desc': 'Approved Leave',
    
    // 练琴相关
    'practice.title': '🎹 Real-time Practice Status',
    'practice.current_time': 'Current Time: ',
    'practice.empty.title': 'No students currently practicing',
    'practice.empty.desc.weekday': 'Waiting for students to start practicing',    
    'practice.in_slot': 'In-Slot',
    'practice.out_slot': 'Out-Slot',
    // 考勤相关
    'attendance.title': '📅 Today\'s Attendance Snapshot',
    'attendance.select_date': 'Select Date: ',
    'attendance.history': 'Last 7 Days Attendance',
    'attendance.rate': 'Attendance Rate',
    'attendance.detail.suffix': ' Attendance Details',
    'attendance.summary': 'Attendance Summary',
    'attendance.detailed_records': 'Detailed Records',
    'attendance.remarks': 'Remarks',

    
    // 筛选器
    'filter.major': 'Major Filter',
    'filter.grade': 'Grade Filter',
    'filter.status': 'Attendance Status',
    'filter.search': 'Search Students',
    'filter.all_majors': 'All Majors',
    'filter.all_grades': 'All Grades',
    'filter.all_status': 'All Status',
    'filter.search_placeholder': 'Enter student name...',
    'filter.no_results': 'No matching students found',
    'filter.try_different': 'Please try adjusting filter criteria',
    'filter.clear': 'Clear',
    
    // 学生信息
    'student.name': 'Name',
    'student.major': 'Major',
    'student.grade': 'Grade',
    'student.room': 'Room',
    'student.time_slot': 'Time Slot',
    'student.practice_duration': 'Practice Duration',
    'student.start_time': 'Recent Start',
    'student.not_in_room': 'Not in Room',
    'student.not_started': 'Not Started',
    'student.not_set': 'Not Set',
    'student.unknown_major': 'Unknown Major',
    'student.detail.title': 'Student Details',
    'student.today_attendance': 'Today\'s Attendance',
    'student.today_practice': 'Today\'s Practice Time',
    
    // 时间相关
    'time.hours': 'h',
    'time.minutes': 'min',
    'time.seconds': 's',
    'time.no_practice': '0 min',
    
    // 请假相关
    'excuse.title': '📝 Today\'s Leave Information',
    'excuse.reason': 'Leave Reason',
    'excuse.duration_text': 'Leave Duration',
    'excuse.end_date': 'End Date',
    'excuse.not_filled': 'Not Filled',
    
    // 报告相关
    'report.title': '📈 Attendance History Analysis',
    'report.start_date': 'Start Date: ',
    'report.end_date': 'End Date: ',
    'report.empty.title': 'Select date range to generate report',
    'report.empty.desc': 'Choose start and end dates, then click "Generate Report"',
    'report.analysis_title': '📊 Attendance Analysis Report',
    'report.period': 'Statistical Period',
    'report.to': 'to',
    'report.days': ' days',
    'report.participants': 'Participating Students',
    'report.people': ' students',
    'report.daily_trend': '📈 Daily Attendance Trend',
    'report.date': 'Date',
    'report.total': 'Total',
    'report.student_stats': '👥 Student Attendance Statistics',
    'report.regenerate': 'Regenerate',
    
    // 同步相关
    'sync.title': '🔄 Data Sync Management',
    'sync.status': 'Sync Status',
    'sync.checking': 'Checking connection status...',
    'sync.logs': '📋 Sync Logs',
    'sync.force_sync': 'Force Sync',
    
    // 按钮
    'btn.generate_report': 'Generate Report',
    'btn.force_sync': 'Force Sync',
    'btn.clear_cache': 'Clear Cache',
    
    // 消息提示
    'msg.loading': 'Loading...',
    'msg.no_data': 'No Data',
    'msg.select_dates': 'Please select start and end dates',
    'msg.date_range_error': 'Start date cannot be later than end date',
    'msg.sync_required': 'Network connection required for data sync',
    'msg.clear_cache_confirm': 'Are you sure you want to clear local cache?',
    'msg.cache_cleared': 'Local cache cleared',
    
    // 空状态
    'empty.no_students': 'No student data available',
    'empty.no_attendance': 'No attendance records yet',
    'empty.load_failed': 'Loading failed'
  }
};


let currentLanguage = 'zh';
function t(key,fallback=''){const pack=i18n[currentLanguage]||{};return pack[key]||fallback||key;}
function switchLanguage(lang){
  if(lang===currentLanguage)return;
  currentLanguage=lang;
  document.querySelectorAll('.lang-btn').forEach(b=>{
    b.classList.toggle('active', b.getAttribute('data-lang')===lang);
  });
  updatePageLanguage();
  localStorage.setItem('preferred_language',lang);
  addSyncLog(`🌐 ${lang==='zh'?'语言切换为中文':'Language switched to English'}`);
  refreshCurrentTabContent();
}

function updatePageLanguage(){
  const pack=i18n[currentLanguage]||{};
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k=el.getAttribute('data-i18n');
    if(pack[k]) el.textContent=pack[k];
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
    const k=el.getAttribute('data-i18n-placeholder');
    if(pack[k]) el.placeholder=pack[k];
  });
  document.title = currentLanguage==='zh'?'青岛梅纽因音乐学校练琴跟踪系统':'Qingdao Menuhin Music School Practice Tracking System';
}


/* =============================
   2. Firebase（使用琴房系统同配置）
   ============================= */
const firebaseConfig = {
  apiKey: "AIzaSyBfRjrAKsVUAHBl5WbBl96YONrkRe1UWUo",
  authDomain: "menuhin-studio-system.firebaseapp.com",
  databaseURL: "https://menuhin-studio-system-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "menuhin-studio-system",
  storageBucket: "menuhin-studio-system.firebasestorage.app",
  messagingSenderId: "218592951152",
  appId: "1:218592951152:web:650d080726b6c44f5a2db5",
  measurementId: "G-P49SZQTLT7"
};

let database=null;
let isOnline=false;

/* =============================
   3. 数据结构（精简版）
   ============================= */
let rooms=[];                    // 来自琴房系统
let studentDatabase={};          // { major: [ {name, grade?} or string ] }
let excuseData={};               // excuseData[YYYY-MM-DD][studentName] = { reason, ... }
let attendanceRecordsCache={};   // attendanceRecords[date] => remote snapshot
let realTimePracticeMap={};      // { studentName: {room,startTime,currentSec} } (派生)
let syncLogs=[];
let currentTab='dashboard';
// ==== 练琴历史统计新增（时段内 / 时段外） ====
let studentTimeSlots = {};                 // 从同项目 Firebase 读取的学生练琴时间段
let dailyPracticeRecords = {};            // { dateKey: { student: { inSlot,outSlot,totalSessions,sessions[],lastUpdated }} }
let practiceSessionTracker = new Map();   // 当前进行中的练琴会话
let lastPracticeSessionSweep = 0;
const PRACTICE_UPDATE_INTERVAL_MS = 60000; // 每 60 秒刷新会话累计

/* ==== 补丁：缺失的通用辅助函数（closeModal / getLastNDates / getStatusClassSimple） ==== */
/**
 * 获取最近 n 天的日期数组（含今天），格式：YYYY-MM-DD
 * @param {number} n - 天数
 * @param {boolean} includeToday - 是否包含今天
 * @param {'asc'|'desc'} order - 返回顺序（asc：从早到晚；desc：从晚到早）
 */
if (typeof getLastNDates !== 'function') {
  function getLastNDates(n, includeToday = true, order = 'asc') {
    const today = new Date();
    const list = [];
    for (let i = 0; i < n; i++) {
      const offset = includeToday ? i : (i + 1);
      const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - (n - 1 - offset));
      const iso = d.toISOString().slice(0, 10);
      list.push(iso);
    }
    if (order === 'desc') list.reverse();
    return list;
  }
}

/**
 * 关闭模态框的安全函数
 * 常见调用形式：closeModal('studentDetailModal') 或某些旧代码直接 closeModal()
 */
function closeModal(id) {
    const candidateIds = id ? [id] : ['studentDetailModal', 'studentListModal', 'queueStudentModal'];
    let hasClosedModal = false;
    
    candidateIds.forEach(cid => {
        const el = document.getElementById(cid);
        if (el && el.classList.contains('show')) {
            // 添加隐藏动画类
            el.classList.add('hiding');
            el.classList.remove('show');
            hasClosedModal = true;
            
            // 等待动画完成后再隐藏
            setTimeout(() => {
                if (el.classList.contains('hiding')) {
                    el.style.display = 'none';
                    el.classList.remove('hiding');
                }
            }, 300); // 与 CSS transition 时间一致
        }
    });
    
    // 如果关闭了模态框，恢复背景滚动
    if (hasClosedModal) {
        document.body.classList.remove('modal-open');
    }
}


/**
 * 简单状态 -> CSS class（用于彩色标记时间线 / 小圆点）
 * 可按自己现有的样式系统调整
 */
if (typeof getStatusClassSimple !== 'function') {
  function getStatusClassSimple(status) {
    switch (status) {
      case 'present':
      case 'practicing':
        return 'present';
      case 'low_efficiency':
        return 'low_efficiency';
      case 'absent':
        return 'absent';
      case 'excused':
        return 'excused';
      case 'under_review':
      case 'preparing':
        return 'under_review';
      default:
        return 'unknown';
    }
  }
}

/* 若 formatDate 在本页面未实现，也补一个最简版本（避免 formatDate 未定义报错） */
if (typeof formatDate !== 'function') {
  function formatDate(d) {
    if (!(d instanceof Date)) d = new Date(d);
    return d.toISOString().slice(0, 10);
  }
}

/* =============================
   4. 初始化
   ============================= */
document.addEventListener('DOMContentLoaded',()=>{
  const saved=localStorage.getItem('preferred_language');
  if(saved) currentLanguage=saved;
  updatePageLanguage();
  initFirebase();
  initClock();
  const today=formatDate(new Date());
  document.getElementById('dateSelect').value=today;
  addSyncLog('🚀 系统启动');
});
// 修改点击背景关闭模态框的事件监听
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal') && e.target.classList.contains('show')) {
        if (e.target.id === 'attendanceDetailModal') {
            closeAttendanceDetailModal();
        } else {
            closeModal(e.target.id);
        }
    }
});

// 修改 ESC 键关闭模态框
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const openModals = document.querySelectorAll('.modal.show');
        if (openModals.length > 0) {
            openModals.forEach(modal => {
                if (modal.id === 'attendanceDetailModal') {
                    closeAttendanceDetailModal();
                } else {
                    closeModal(modal.id);
                }
            });
        }
    }
});


/* =============================
   5. Firebase 初始化与监听
   ============================= */
function initFirebase(){
  try{
    firebase.initializeApp(firebaseConfig);
    database=firebase.database();
    database.ref('.info/connected').on('value',snap=>{
      isOnline = snap.val()===true;
      updateConnectionStatus();
      if(isOnline){
        addSyncLog('✅ 已连接云端');
        // 初始加载
        loadAllCoreData();
      }else{
        addSyncLog('⚠️ 已离线');
      }
    });
    // 监听：rooms
    database.ref('rooms').on('value',snap=>{
      const val=snap.val();
      if(Array.isArray(val)){
        rooms=val;
        buildRealTimePracticeFromRooms();
        if(currentTab==='dashboard') renderPracticeArea();
        updateStatsPanel();
      }
    });
    // 监听：studentDatabase
    database.ref('studentDatabase').on('value',snap=>{
      const val=snap.val();
      if(val && typeof val==='object'){
        studentDatabase=val;
        populateFilters();
        if(currentTab==='students') renderStudentList();
        updateStatsPanel();
      }
    });
    // 监听：excuseData
    database.ref('excuseData').on('value',snap=>{
      const val=snap.val();
      if(val && typeof val==='object'){
        excuseData=val;
        if(currentTab==='dashboard') renderExcusePanel();
        updateStatsPanel();
      }
    });
    // 学生时间段（用于时段内/外统计）
    database.ref('studentTimeSlots').on('value', snap=>{
      studentTimeSlots = snap.val() || {};
      addSyncLog('📥 已同步 studentTimeSlots');
    });

    // 考勤记录（仅加载今日，其他按需加载）
    const today=formatDate(new Date());
    database.ref(`attendanceRecords/${today}`).on('value',snap=>{
      attendanceRecordsCache[today]=snap.val()||null;
      if(document.getElementById('dateSelect').value===today && currentTab==='dashboard'){
        renderAttendanceSnapshot(today);
      }
    });
  }catch(e){
    console.error('Firebase init error',e);
    addSyncLog('❌ Firebase 初始化失败: '+e.message);
  }
}

/* =============================
   6. 基础工具
   ============================= */
function addSyncLog(msg){
  const time=new Date().toLocaleString();
  syncLogs.unshift(`[${time}] ${msg}`);
  if(syncLogs.length>300) syncLogs.length=300;
  const box=document.getElementById('syncLogs');
  if(box){
    box.textContent=syncLogs.join('\n');
  }
}
function updateConnectionStatus(){
  const el=document.getElementById('connectionStatus');
  if(!el) return;
  if(isOnline){
    el.className='connection-status online';
    el.innerHTML='<span>'+t('status.online','已连接')+'</span>';
  }else{
    el.className='connection-status offline';
    el.innerHTML='<span>'+t('status.offline','离线模式')+'</span>';
  }
}
function formatDate(d){
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function initClock(){
  function run(){
    const now=new Date();
    document.getElementById('currentTime').textContent=now.toLocaleString(currentLanguage==='zh'?'zh-CN':'en-US');
    setTimeout(run,1000);
  }
  run();
}

/* =============================
   7. 数据派生：实时练琴
   ============================= */
function buildRealTimePracticeFromRooms(){
  const now=Date.now();
  const newMap={};
  const activeSessionIds=new Set();

  rooms.forEach(r=>{
    if(r && r.student && r.registerTime){
      const reg=Number(r.registerTime);
      if(!isNaN(reg) && reg>0 && (now-reg)<12*3600*1000){
        newMap[r.student]={
          room:r.name,
          startTime:reg,
          currentSec:Math.max(0,Math.floor((now-reg)/1000))
        };
        const sid = `${r.student}__${r.name}__${r.registerTime}`;
        activeSessionIds.add(sid);
        if(!practiceSessionTracker.has(sid)){
          startPracticeSession(r.student, r.name, r.registerTime);
        }
      }
    }
  });

  // 结束已经不存在的会话
  for(const [sid, sess] of practiceSessionTracker.entries()){
    if(!activeSessionIds.has(sid)){
      endPracticeSession(sid, Date.now(), '房间状态变更结束');
    }
  }

  realTimePracticeMap=newMap;
}

/* =============================
   8. 统计面板更新
   ============================= */
function updateStatsPanel(){
  const allStudents = flattenStudents();
  const total=allStudents.length;
  // 出勤：当前在 rooms
  const presentSet=new Set();
  rooms.forEach(r=>{ if(r.student) presentSet.add(r.student); });
  const present=presentSet.size;
  // 请假：今日
  const today=formatDate(new Date());
  const todayExcuses = excuseData[today]||{};
  const excused = Object.keys(todayExcuses).length;
  const absent = Math.max(0,total - present - excused);

  setText('totalStudents', total);
  setText('presentCount', present);
  setText('absentCount', absent);
  setText('excusedCount', excused);
}
function setText(id,v){const el=document.getElementById(id);if(el)el.textContent=v;}

/* =============================
   9. 实时练琴区域
   ============================= */
function renderPracticeArea(){
  const container=document.getElementById('practiceStatusContainer');
  if(!container) return;
  const names=Object.keys(realTimePracticeMap);
  
  if(!names.length){
    container.innerHTML=`
      <div class="practice-filters">
        <div class="practice-filter-row">
          <div class="practice-filter-group">
            <label class="practice-filter-label" data-i18n="filter.major">专业筛选</label>
            <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
              <option value="" data-i18n="filter.all_majors">所有专业</option>
            </select>
          </div>
          <div class="practice-filter-group">
            <label class="practice-filter-label" data-i18n="filter.grade">年级筛选</label>
            <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
              <option value="" data-i18n="filter.all_grades">所有年级</option>
            </select>
          </div>
          <div class="practice-filter-group">
            <label class="practice-filter-label" data-i18n="filter.search">搜索学生</label>
            <input type="text" id="practiceStudentSearch" class="practice-filter-input"
                   data-i18n-placeholder="filter.search_placeholder"
                   placeholder="输入学生姓名..." oninput="filterPracticeStatus()">
          </div>
        </div>
        <div class="quick-filter-tags" id="practiceQuickFilters"></div>
        
        <!-- 🔥 新增：在筛选器内部包含结果网格 -->
        <div id="practiceStudentList" class="student-grid" style="margin-top: 20px;">
          <div class="practice-empty-state" style="grid-column:1/-1;">
            <div class="practice-empty-state-icon">🎵</div>
            <div class="practice-empty-state-title">${t('practice.empty.title','当前没有学生在练琴')}</div>
            <div class="practice-empty-state-description">${t('practice.empty.desc.weekday','等待学生开始练琴')}</div>
          </div>
        </div>
      </div>
    `;
    return;
  }
  
  // 按时长排序
  names.sort((a,b)=>realTimePracticeMap[b].currentSec - realTimePracticeMap[a].currentSec);
  
  // 生成筛选器HTML
  const majors=new Set(), grades=new Set();
  names.forEach(n=>{
    const info=getStudentInfo(n);
    if(info.major) majors.add(info.major);
    if(info.grade) grades.add(info.grade);
  });
  
  let quickFiltersHtml = '';
  [...majors].sort().forEach(m=>{
    quickFiltersHtml+=`<div class="quick-filter-tag" onclick="setQuickPracticeFilter('major','${m}')">${m}</div>`;
  });
  [...grades].sort().forEach(g=>{
    quickFiltersHtml+=`<div class="quick-filter-tag" onclick="setQuickPracticeFilter('grade','${g}')">${g}</div>`;
  });
  if(majors.size||grades.size){
    quickFiltersHtml+=`<div class="quick-filter-tag" style="background:#f8d7da;color:#721c24;border-color:#f5c6cb;" onclick="clearPracticeFilters()">${t('filter.clear','清除')}</div>`;
  }
  
  // 生成学生卡片HTML
  let studentsHtml='';
  names.forEach(n=>{
    const info=getStudentInfo(n);
    const p=realTimePracticeMap[n];
    const startTime=new Date(p.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'});
    studentsHtml+=`
      <div class="practice-status-card compact" onclick="openStudentDetail('${n}')">
        <div class="practice-indicator"></div>
        <div class="compact-content">
          <div class="student-name-compact">${n}</div>
          <div class="student-info-row">
            <span class="info-item">${info.major||t('student.unknown_major','未知专业')}</span>
            <span class="info-divider">•</span>
            <span class="info-item">${info.grade||t('student.not_set','未设置')}</span>
          </div>
          <div class="student-info-row">
            <span class="info-item">🕐 ${startTime}</span>
            <span class="info-divider">•</span>
            <span class="info-item">🏠 ${p.room}</span>
          </div>
          <div class="practice-duration-large">${formatDuration(p.currentSec)}</div>
        </div>
      </div>
    `;
  });
  
  // 🔥 修改：将筛选器和结果合并在一个容器中
  container.innerHTML=`
    <div class="practice-filters">
      <div class="practice-filter-row">
        <div class="practice-filter-group">
          <label class="practice-filter-label" data-i18n="filter.major">专业筛选</label>
          <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
            <option value="" data-i18n="filter.all_majors">所有专业</option>
            ${[...majors].sort().map(m=>`<option value="${m}">${m}</option>`).join('')}
          </select>
        </div>
        <div class="practice-filter-group">
          <label class="practice-filter-label" data-i18n="filter.grade">年级筛选</label>
          <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
            <option value="" data-i18n="filter.all_grades">所有年级</option>
            ${[...grades].sort().map(g=>`<option value="${g}">${g}</option>`).join('')}
          </select>
        </div>
        <div class="practice-filter-group">
          <label class="practice-filter-label" data-i18n="filter.search">搜索学生</label>
          <input type="text" id="practiceStudentSearch" class="practice-filter-input"
                 data-i18n-placeholder="filter.search_placeholder"
                 placeholder="输入学生姓名..." oninput="filterPracticeStatus()">
        </div>
      </div>
      <div class="quick-filter-tags" id="practiceQuickFilters">
        ${quickFiltersHtml}
      </div>
      
      <!-- 🔥 新增：在筛选器内部包含结果网格 -->
      <div id="practiceStudentList" class="student-grid" style="margin-top: 20px;">
        ${studentsHtml}
      </div>
    </div>
  `;
  
  // 应用筛选（如果有的话）
  filterPracticeStatus();
}

function formatDuration(sec){
  if(sec<=0) return t('time.no_practice','0分钟');
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
  
  if(currentLanguage === 'en') {
    // 英文格式
    if(h) return `${h}h${m?` ${m}min`:''}`;
    if(m) return `${m}min${s?` ${s}s`:''}`;
    return `${s}s`;
  } else {
    // 中文格式
    if(h) return `${h}${t('time.hours','小时')}${m?m+t('time.minutes','分钟'):''}`;
    if(m) return `${m}${t('time.minutes','分钟')}${s? s+t('time.seconds','秒'):''}`;
    return `${s}${t('time.seconds','秒')}`;
  }
}



function filterPracticeStatus(){
  const majorFilter=document.getElementById('practiceMajorFilter')?.value || '';
  const gradeFilter=document.getElementById('practiceGradeFilter')?.value || '';
  const search=document.getElementById('practiceStudentSearch')?.value.trim().toLowerCase() || '';
  const container=document.getElementById('practiceStudentList');
  
  if (!container) return;
  
  const names=Object.keys(realTimePracticeMap);
  if(!names.length) {
    container.innerHTML=`<div class="practice-empty-state" style="grid-column:1/-1;">
      <div class="practice-empty-state-icon">🎵</div>
      <div class="practice-empty-state-title">${t('practice.empty.title','当前没有学生在练琴')}</div>
      <div class="practice-empty-state-description">${t('practice.empty.desc.weekday','等待学生开始练琴')}</div>
    </div>`;
    return;
  }
  
  let filtered=names.filter(n=>{
    const info=getStudentInfo(n);
    if(majorFilter && info.major!==majorFilter) return false;
    if(gradeFilter && info.grade!==gradeFilter) return false;
    if(search && !n.toLowerCase().includes(search)) return false;
    return true;
  });
  
  if(!filtered.length){
    container.innerHTML=`<div class="practice-empty-state" style="grid-column:1/-1;">
      <div class="practice-empty-state-icon">🔍</div>
      <div class="practice-empty-state-title">${t('filter.no_results','没有符合条件的学生')}</div>
      <div class="practice-empty-state-description">${t('filter.try_different','请尝试调整筛选条件')}</div>
    </div>`;
    return;
  }
  
  // 重绘筛选后的结果
  filtered.sort((a,b)=>realTimePracticeMap[b].currentSec - realTimePracticeMap[a].currentSec);
  let html='';
  filtered.forEach(n=>{
    const info=getStudentInfo(n);
    const p=realTimePracticeMap[n];
    const startTime=new Date(p.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'});
    html+=`
    <div class="practice-status-card compact" onclick="openStudentDetail('${n}')">
      <div class="practice-indicator"></div>
      <div class="compact-content">
        <div class="student-name-compact">${n}</div>
        <div class="student-info-row">
          <span>${info.major||''}</span>
          <span class="info-divider">•</span>
          <span>${info.grade||''}</span>
        </div>
        <div class="student-info-row">
          <span>🕐 ${startTime}</span>
          <span class="info-divider">•</span>
          <span>🏠 ${p.room}</span>
        </div>
        <div class="practice-duration-large">${formatDuration(p.currentSec)}</div>
      </div>
    </div>`;
  });
  container.innerHTML=html;
}


// 设置快速练琴筛选（原有的）
function setQuickPracticeFilter(type, val) {
    if (type === 'major') {
        document.getElementById('practiceMajorFilter').value = val;
        document.getElementById('practiceGradeFilter').value = '';
    } else {
        document.getElementById('practiceGradeFilter').value = val;
        document.getElementById('practiceMajorFilter').value = '';
    }
    document.getElementById('practiceStudentSearch').value = '';
    filterPracticeStatus();
}

// 设置考勤筛选（新增）
function setAttendanceFilter(status) {
    const statusSelect = document.getElementById('attendanceStatusFilter');
    const searchInput = document.getElementById('attendanceStudentSearch');
    
    if (statusSelect) statusSelect.value = status;
    if (searchInput) searchInput.value = '';
    
    filterAttendanceSnapshot();
    
    // 更新快速筛选标签的激活状态
    updateAttendanceQuickFilterTags(status);
}

// 清除考勤筛选
function clearAttendanceFilters() {
    const statusSelect = document.getElementById('attendanceStatusFilter');
    const searchInput = document.getElementById('attendanceStudentSearch');
    
    if (statusSelect) statusSelect.value = '';
    if (searchInput) searchInput.value = '';
    
    filterAttendanceSnapshot();
    
    // 清除快速筛选标签的激活状态
    updateAttendanceQuickFilterTags('');
}

// 更新快速筛选标签状态
function updateAttendanceQuickFilterTags(activeStatus) {
    const tags = document.querySelectorAll('#attendanceQuickFilters .quick-filter-tag');
    tags.forEach(tag => {
        const tagText = tag.textContent.trim();
        const isActive = tagText === getStatusDisplayName(activeStatus);
        tag.classList.toggle('active', isActive);
    });
}

// 获取状态显示名称
function getStatusDisplayName(status) {
    switch(status) {
        case 'present': return '出勤';
        case 'low_efficiency': return '低效';
        case 'absent': return '缺勤';
        case 'excused': return '请假';
        default: return '';
    }
}

function clearPracticeFilters(){
  document.getElementById('practiceMajorFilter').value='';
  document.getElementById('practiceGradeFilter').value='';
  document.getElementById('practiceStudentSearch').value='';
  renderPracticeArea();
}

/* =============================
   10. 学生信息与列表
   ============================= */
function flattenStudents(){
  const arr=[];
  Object.keys(studentDatabase).forEach(major=>{
    const list=studentDatabase[major];
    if(Array.isArray(list)){
      list.forEach(s=>{
        if(typeof s==='string') arr.push({name:s,major});
        else if(s && typeof s==='object') arr.push({name:s.name,major,grade:s.grade||''});
      });
    }
  });
  return arr;
}
function getStudentInfo(name){
  for(const [major,arr] of Object.entries(studentDatabase)){
    if(Array.isArray(arr)){
      for(const s of arr){
        if(typeof s==='string' && s===name) return {name,major,grade:''};
        if(typeof s==='object' && s.name===name) return {name,major,grade:s.grade||''};
      }
    }
  }
  return {name,major:t('student.unknown_major','未知专业'),grade:''};
}
function populateFilters(){
  // majorFilter / gradeFilter / practice filters 已有单独逻辑，这里只用于学生列表
  const majorSel=document.getElementById('majorFilter');
  const gradeSel=document.getElementById('gradeFilter');
  if(majorSel){
    const val=majorSel.value;
    majorSel.innerHTML=`<option value="">${t('filter.all_majors','所有专业')}</option>`+
      Object.keys(studentDatabase).sort().map(m=>`<option value="${m}">${m}</option>`).join('');
    if(Object.keys(studentDatabase).includes(val)) majorSel.value=val;
  }
  if(gradeSel){
    const gradeSet=new Set();
    flattenStudents().forEach(s=>{ if(s.grade) gradeSet.add(s.grade); });
    const val=gradeSel.value;
    gradeSel.innerHTML=`<option value="">${t('filter.all_grades','所有年级')}</option>`+
      [...gradeSet].sort().map(g=>`<option value="${g}">${g}</option>`).join('');
    if(gradeSet.has(val)) gradeSel.value=val;
  }
}
function renderStudentList(){
  const container=document.getElementById('studentList');
  if(!container)return;
  const all=flattenStudents();
  if(!all.length){
    container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">📂</div><div class="empty-state-title">${t('empty.no_students','暂无学生数据')}</div></div>`;
    return;
  }
  const majorFilter=document.getElementById('majorFilter').value;
  const gradeFilter=document.getElementById('gradeFilter').value;
  const statusFilter=document.getElementById('statusFilter').value;
  const kw=document.getElementById('studentSearch').value.trim().toLowerCase();

  // 构造今日请假映射
  const today=formatDate(new Date());
  const todayExcuses=excuseData[today]||{};
  const presentSet=new Set();
  rooms.forEach(r=>{ if(r.student) presentSet.add(r.student); });

  // 🔥 新增：获取当前时间和星期
  const now = new Date();
  const currentDay = now.getDay(); // 0=周日, 1=周一, ..., 6=周六
  const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();

  let filtered=all.filter(s=>{
    if(majorFilter && s.major!==majorFilter) return false;
    if(gradeFilter && s.grade!==gradeFilter) return false;
    if(kw && !s.name.toLowerCase().includes(kw)) return false;

    // 🔥 修改：更智能的状态判断
    let stat = getStudentCurrentStatus(s.name, presentSet, todayExcuses, currentDay, currentTimeMinutes);
    
    if(statusFilter && stat!==statusFilter) return false;
    s._status=stat;
    return true;
  });

  if(!filtered.length){
    container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">🔍</div><div class="empty-state-title">${t('filter.no_results','没有符合条件的学生')}</div></div>`;
    return;
  }

  filtered.sort((a,b)=>a.name.localeCompare(b.name,'zh-CN'));
  let html='';
  filtered.forEach(s=>{
    const practice=realTimePracticeMap[s.name];
    const room=practice?practice.room:t('student.not_in_room','不在琴房');
    const duration=practice?formatDuration(practice.currentSec):t('time.no_practice','0分钟');
    const statusClass=getStatusClass(s._status);
    const statusText=getStatusText(s._status);
    html+=`
      <div class="practice-status-card compact ${statusClass}" onclick="openStudentDetail('${s.name}')">
        ${practice?'<div class="practice-indicator"></div>':''}
        <div class="compact-content">
          <div class="student-name-compact">${s.name}</div>
          <div class="student-info-row">
            <span>${s.major||''}</span>
            <span class="info-divider">•</span>
            <span>${s.grade||t('student.not_set','未设置')}</span>
          </div>
          <div class="student-info-row">
            <span>${room}</span>
          </div>
          <div class="status-duration-row">
            <div class="student-status-compact ${statusClass}">${statusText}</div>
            <div class="practice-duration-large">${duration}</div>
          </div>
        </div>
      </div>
    `;
  });
  container.innerHTML=html;
}
/**
 * 获取学生当前状态
 * @param {string} studentName - 学生姓名
 * @param {Set} presentSet - 当前在琴房的学生集合
 * @param {Object} todayExcuses - 今日请假数据
 * @param {number} currentDay - 当前星期几 (0-6)
 * @param {number} currentTimeMinutes - 当前时间（分钟）
 * @returns {string} 状态：present, absent, excused, pending
 */
function getStudentCurrentStatus(studentName, presentSet, todayExcuses, currentDay, currentTimeMinutes) {
    // 1. 首先检查请假
    if (todayExcuses[studentName]) {
        return 'excused';
    }
    
    // 2. 检查是否在琴房
    if (presentSet.has(studentName)) {
        return 'present';
    }
    
    // 3. 获取学生今日时间段
    const dayMap = {1: 'monday', 2: 'tuesday', 3: 'wednesday', 4: 'thursday', 5: 'friday'};
    const dayKey = dayMap[currentDay];
    
    // 周末或没有时间段安排
    if (!dayKey || !studentTimeSlots[studentName] || !studentTimeSlots[studentName][dayKey]) {
        return 'pending'; // 待考勤（非练琴时间）
    }
    
    const todaySlots = studentTimeSlots[studentName][dayKey];
    if (!todaySlots || todaySlots.length === 0) {
        return 'pending'; // 今日无安排
    }
    
    // 4. 检查当前时间是否在任何时间段内
    const isInTimeSlot = todaySlots.some(slot => {
        const startMinutes = timeToMinutes(slot.start);
        const endMinutes = timeToMinutes(slot.end);
        return currentTimeMinutes >= startMinutes && currentTimeMinutes < endMinutes;
    });
    
    if (isInTimeSlot) {
        // 在时间段内但不在琴房 = 缺勤
        return 'absent';
    } else {
        // 不在时间段内 = 待考勤
        return 'pending';
    }
}

/**
 * 获取状态对应的CSS类名
 */
function getStatusClass(status) {
    switch(status) {
        case 'present': return 'present';
        case 'absent': return 'absent';
        case 'excused': return 'excused';
        case 'pending': return 'pending';
        default: return 'pending';
    }
}

/**
 * 获取状态显示文本
 */
function getStatusText(status) {
    switch(status) {
        case 'present': return t('status.present', '出勤');
        case 'absent': return t('status.absent', '缺勤');
        case 'excused': return t('status.excused', '请假');
        case 'pending': return t('status.pending', '待考勤');
        default: return t('status.pending', '待考勤');
    }
}

/* =============================
   11. 请假面板
   ============================= */
function renderExcusePanel(){
  const today=formatDate(new Date());
  const data=excuseData[today]||{};
  const keys=Object.keys(data);
  const panel=document.getElementById('excuseInfoPanel');
  const box=document.getElementById('excuseInfoContainer');
  if(!keys.length){
    panel.style.display='none';return;
  }
  panel.style.display='block';
  let html='<div class="student-grid">';
  keys.forEach(name=>{
    const ex=data[name];
    html+=`
      <div class="student-card excused" style="min-height:180px;">
        <div class="student-header">
          <div class="student-name">${name}</div>
          <div class="student-status excused">${t('status.excused','请假')}</div>
        </div>
        <div class="student-details">
          <div class="detail-item">
            <div class="detail-label">${t('excuse.reason','请假原因')}</div>
            <div class="detail-value">${ex.reason||t('excuse.not_filled','未填写')}</div>
          </div>
          ${ex.durationText?`<div class="detail-item">
            <div class="detail-label">${t('excuse.duration_text','请假时长')}</div>
            <div class="detail-value">${ex.durationText}</div>
          </div>`:''}
          ${ex.endDate?`<div class="detail-item">
            <div class="detail-label">${t('excuse.end_date','结束日期')}</div>
            <div class="detail-value">${ex.endDate}</div>
          </div>`:''}
        </div>
      </div>`;
  });
  html+='</div>';
  box.innerHTML=html;
}

/* =============================
   12. 考勤快照（attendanceRecords）
   ============================= */
function loadAttendanceData(){
  const date=document.getElementById('dateSelect').value;
  if(!date) return;
  renderAttendanceSnapshot(date,true);
  if(isOnline){
    // 按需加载（如果不是已监听的今天）
    if(!attendanceRecordsCache[date] || date!==formatDate(new Date())){
      database.ref(`attendanceRecords/${date}`).once('value').then(snap=>{
        attendanceRecordsCache[date]=snap.val()||null;
        renderAttendanceSnapshot(date);
      }).catch(e=>{
        addSyncLog('❌ 加载考勤记录失败 '+e.message);
        renderAttendanceSnapshot(date);
      });
    }
  }
}
function renderAttendanceFilters(){
  const filtersHtml=`
    <div class="practice-filters">
      <div class="practice-filter-row">
        <div class="practice-filter-group">
          <label class="practice-filter-label">${t('filter.status', '状态筛选')}</label>
          <select id="attendanceStatusFilter" class="practice-filter-select" onchange="filterAttendanceSnapshot()">
            <option value="">${t('filter.all_status', '所有状态')}</option>
            <option value="present">${t('status.present', '出勤')}</option>
            <option value="low_efficiency">${t('status.low_efficiency', '低效')}</option>
            <option value="absent">${t('status.absent', '缺勤')}</option>
            <option value="excused">${t('status.excused', '请假')}</option>
          </select>
        </div>
        <div class="practice-filter-group">
          <label class="practice-filter-label">${t('filter.search', '学生搜索')}</label>
          <input type="text" id="attendanceStudentSearch" class="practice-filter-input"
                 placeholder="${t('filter.search_placeholder', '输入学生姓名...')}" oninput="debouncedFilterAttendanceSnapshot()">
        </div>
      </div>
      <div class="quick-filter-tags" id="attendanceQuickFilters">
        <div class="quick-filter-tag" onclick="setAttendanceFilter('present')">${t('status.present', '出勤')}</div>
        <div class="quick-filter-tag" onclick="setAttendanceFilter('low_efficiency')">${t('status.low_efficiency', '低效')}</div>
        <div class="quick-filter-tag" onclick="setAttendanceFilter('absent')">${t('status.absent', '缺勤')}</div>
        <div class="quick-filter-tag" onclick="setAttendanceFilter('excused')">${t('status.excused', '请假')}</div>
        <div class="quick-filter-tag" style="background:#f8d7da;color:#721c24;border-color:#f5c6cb;" onclick="clearAttendanceFilters()">${t('filter.clear', '清除')}</div>
      </div>
      
      <div id="attendanceSnapshotGrid" class="student-grid" style="margin-top: 20px;"></div>
    </div>
  `;
  return filtersHtml;
}


function filterAttendanceSnapshot() {
    if (!window.attendanceSnapshotData) return;
    
    const statusFilter = document.getElementById('attendanceStatusFilter')?.value || '';
    const searchText = document.getElementById('attendanceStudentSearch')?.value.trim().toLowerCase() || '';
    
    let filtered = window.attendanceSnapshotData.filter(s => {
        // 状态筛选
        if (statusFilter && s.finalAttendanceStatus !== statusFilter) {
            return false;
        }
        
        // 姓名搜索
        if (searchText && !s.name.toLowerCase().includes(searchText)) {
            return false;
        }
        
        return true;
    });
    
    const grid = document.getElementById('attendanceSnapshotGrid');
    if (!grid) return;
    
    if (filtered.length === 0) {
        grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="empty-state-icon">🔍</div>
                <div class="empty-state-title">${t('filter.no_results', '没有符合条件的记录')}</div>
                <div class="empty-state-description">${t('filter.try_different', '请尝试调整筛选条件')}</div>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = renderAttendanceCards(filtered);
    
    // 更新快速筛选标签的激活状态
    updateAttendanceQuickFilterTags(statusFilter);
}

// 设置考勤筛选
function setAttendanceFilter(status) {
    const statusSelect = document.getElementById('attendanceStatusFilter');
    const searchInput = document.getElementById('attendanceStudentSearch');
    
    if (statusSelect) statusSelect.value = status;
    if (searchInput) searchInput.value = '';
    
    filterAttendanceSnapshot();
}

// 清除考勤筛选
function clearAttendanceFilters() {
    const statusSelect = document.getElementById('attendanceStatusFilter');
    const searchInput = document.getElementById('attendanceStudentSearch');
    
    if (statusSelect) statusSelect.value = '';
    if (searchInput) searchInput.value = '';
    
    filterAttendanceSnapshot();
}

// 更新快速筛选标签状态
function updateAttendanceQuickFilterTags(activeStatus) {
    const tags = document.querySelectorAll('#attendanceQuickFilters .quick-filter-tag');
    tags.forEach(tag => {
        const isActive = tag.textContent.trim() === getStatusDisplayName(activeStatus);
        tag.classList.toggle('active', isActive);
    });
}

function getStatusDisplayName(status) {
    switch(status) {
        case 'present': return t('status.present', '出勤');
        case 'low_efficiency': return t('status.low_efficiency', '低效');
        case 'absent': return t('status.absent', '缺勤');
        case 'excused': return t('status.excused', '请假');
        default: return '';
    }
}

function renderAttendanceSnapshot(date, loading = false) {
    const box = document.getElementById('todaySnapshot');
    if (!box) return;
    
    if (loading) {
        box.innerHTML = '<div class="loading"><div class="spinner"></div><div class="loading-text">' + t('msg.loading', '加载中...') + '</div></div>';
        return;
    }
    
    const rec = attendanceRecordsCache[date];
    if (!rec) {
        box.innerHTML = `
            ${renderAttendanceFilters()}
            <div class="empty-state" style="margin-top: 20px;">
                <div class="empty-state-icon">📄</div>
                <div class="empty-state-title">${t('msg.no_data', '暂无数据')}</div>
                <div class="empty-state-description">${date} ${t('empty.no_attendance', '还没有考勤记录')}</div>
            </div>
        `;
        return;
    }
    
    // 结构假设：rec.students / rec.endedSlots （来自琴房系统同步）
    const list = [...(rec.students || []), ...(rec.endedSlots || [])];
    if (!list.length) {
        box.innerHTML = `
            ${renderAttendanceFilters()}
            <div class="empty-state" style="margin-top: 20px;">
                <div class="empty-state-icon">📄</div>
                <div class="empty-state-title">${t('msg.no_data', '暂无数据')}</div>
            </div>
        `;
        return;
    }
    
    // 🔥 新增：保存当前筛选状态
    const currentStatusFilter = document.getElementById('attendanceStatusFilter')?.value || '';
    const currentSearchText = document.getElementById('attendanceStudentSearch')?.value || '';
    
    // 存储原始数据用于筛选
    window.attendanceSnapshotData = list;
    
    // 渲染筛选器（内部已包含网格容器）
    box.innerHTML = renderAttendanceFilters();
    
    // 🔥 新增：恢复筛选状态
    if (currentStatusFilter) {
        const statusSelect = document.getElementById('attendanceStatusFilter');
        if (statusSelect) statusSelect.value = currentStatusFilter;
    }
    if (currentSearchText) {
        const searchInput = document.getElementById('attendanceStudentSearch');
        if (searchInput) searchInput.value = currentSearchText;
    }
    
    // 渲染初始数据到网格中
    const grid = document.getElementById('attendanceSnapshotGrid');
    if (grid) {
        grid.innerHTML = renderAttendanceCards(list);
    }
    
    // 应用筛选条件（如果有的话）
    if (currentStatusFilter || currentSearchText) {
        filterAttendanceSnapshot();
    }
}


// 渲染考勤卡片的独立函数
function renderAttendanceCards(list) {
    return list.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN')).map(s => {
        // 根据考勤状态决定显示的琴房信息
        let roomDisplay = s.room || t('student.not_in_room', '不在琴房');
        
        // 如果是缺勤状态，不应该显示具体琴房
        if (s.finalAttendanceStatus === 'absent') {
            roomDisplay = t('student.not_in_room', '不在琴房');
        } else if (s.finalAttendanceStatus === 'excused') {
            roomDisplay = t('status.excused', '请假');
        }
        
        return `
            <div class="student-card ${getStatusClassSimple(s.finalAttendanceStatus)}" style="min-height:160px;">
                <div class="student-header">
                    <div class="student-name">${s.name}</div>
                    <div class="student-status ${getStatusClassSimple(s.finalAttendanceStatus)}">${statusTextSimple(s.finalAttendanceStatus)}</div>
                </div>
                <div class="student-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('student.time_slot', '时间段')}</div>
                        <div class="detail-value">${s.start || '--'} - ${s.end || '--'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.practice_duration', '练琴时长')}</div>
                        <div class="detail-value">${s.practicedText || '0'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.room', '所在琴房')}</div>
                        <div class="detail-value">${roomDisplay}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function getStatusClassSimple(stat){
  if(stat==='present')return 'present';
  if(stat==='excused')return 'excused';
  if(stat==='absent')return 'absent';
  if(stat==='low_efficiency')return 'low-efficiency';
  return 'pending';
}
function statusTextSimple(stat) {
    if (stat === 'present') return t('status.present', '出勤');
    if (stat === 'excused') return t('status.excused', '请假');
    if (stat === 'absent') return t('status.absent', '缺勤');
    if (stat === 'low_efficiency') return t('status.low_efficiency', '低效');
    return t('status.pending', '待考勤');
}


// =============== 练琴记录系统（时段内 / 时段外） ===============
function getTodayDateString(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function toDateKey(x){
  if(!x) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(x)) return x;
  const d=new Date(x);
  if(isNaN(d)) return null;
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function timeToMinutes(t){
  const [H,M]=t.split(':').map(Number);
  return H*60+M;
}
function getStudentTodaySlots(name){
  const wd=new Date().getDay();
  const MAP={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const key=MAP[wd];
  if(!key || !studentTimeSlots[name]) return [];
  return studentTimeSlots[name][key]||[];
}
function findCurrentTimeSlot(slots,ts){
  const d=new Date(ts);
  const m=d.getHours()*60+d.getMinutes();
  return slots.find(s=>{
    const sm=timeToMinutes(s.start);
    const em=timeToMinutes(s.end);
    return m>=sm && m<em;
  })||null;
}
function startPracticeSession(student,room,registerTime){
  const sid=`${student}__${room}__${registerTime}`;
  if(practiceSessionTracker.has(sid)) return practiceSessionTracker.get(sid);
  const now=Date.now();
  const slots=getStudentTodaySlots(student);
  const currentSlot=findCurrentTimeSlot(slots,now);
  const sess={
    sessionId:sid,
    studentName:student,
    roomName:room,
    startTime:registerTime,
    prepEndTime:registerTime+60000,
    actualStartTime:null,
    endTime:null,
    inSlotTime:0,
    outSlotTime:0,
    currentSlot,
    slotTransitions:[],
    isActive:true
  };
  practiceSessionTracker.set(sid,sess);
  return sess;
}
function updatePracticeSessions(){
  const now=Date.now();
  practiceSessionTracker.forEach((sess,sid)=>{
    if(!sess.isActive) return;
    const still=rooms.find(r=>r.student===sess.studentName && r.name===sess.roomName && r.registerTime===sess.startTime);
    if(!still){
      endPracticeSession(sid,now,'消失');
      return;
    }
    if(now<sess.prepEndTime) return;
    if(!sess.actualStartTime) sess.actualStartTime=sess.prepEndTime;
    const slots=getStudentTodaySlots(sess.studentName);
    const curSlot=findCurrentTimeSlot(slots,now);
    if(JSON.stringify(curSlot)!==JSON.stringify(sess.currentSlot)){
      sess.slotTransitions.push({time:now,from:sess.currentSlot,to:curSlot});
      sess.currentSlot=curSlot;
    }
    let inc=60;
    if(sess._lastTick){
      const dt=Math.floor((now-sess._lastTick)/1000);
      if(dt>=10 && dt<=120) inc=dt;
    }
    sess._lastTick=now;
    if(sess.currentSlot) sess.inSlotTime+=inc;
    else sess.outSlotTime+=inc;
  });
}
function endPracticeSession(sid,endTime,reason='结束'){
  const sess=practiceSessionTracker.get(sid);
  if(!sess || !sess.isActive) return;
  sess.isActive=false;
  sess.endTime=endTime;
  if(endTime<sess.prepEndTime){
    practiceSessionTracker.delete(sid);
    return;
  }
  if(!sess.actualStartTime) sess.actualStartTime=sess.prepEndTime;
  recalcSessionTimes(sess);
  recordDailyPractice(sess);
  sess.endReason=reason;
  practiceSessionTracker.delete(sid);
}
function recalcSessionTimes(sess){
  if(!sess.actualStartTime||!sess.endTime) return;
  const startMin=Math.floor(sess.actualStartTime/60000)*60000;
  const endMin=Math.floor(sess.endTime/60000)*60000;
  const slots=getStudentTodaySlots(sess.studentName);
  let inSlot=0,outSlot=0;
  for(let t=startMin;t<endMin;t+=60000){
    const slot=findCurrentTimeSlot(slots,t);
    if(slot) inSlot+=60; else outSlot+=60;
  }
  sess.inSlotTime=inSlot;
  sess.outSlotTime=outSlot;
}
function recordDailyPractice(sess){
  const dk=toDateKey(new Date(sess.startTime))||getTodayDateString();
  if(!dailyPracticeRecords[dk]) dailyPracticeRecords[dk]={};
  if(!dailyPracticeRecords[dk][sess.studentName]){
    dailyPracticeRecords[dk][sess.studentName]={inSlot:0,outSlot:0,totalSessions:0,sessions:[],lastUpdated:Date.now()};
  }
  const rec=dailyPracticeRecords[dk][sess.studentName];
  rec.inSlot+=sess.inSlotTime;
  rec.outSlot+=sess.outSlotTime;
  rec.totalSessions++;
  rec.lastUpdated=Date.now();
  rec.sessions.push({
    room:sess.roomName,
    start:sess.startTime,
    end:sess.endTime,
    inSlot:sess.inSlotTime,
    outSlot:sess.outSlotTime,
    endReason:sess.endReason||'正常'
  });
  try{
    localStorage.setItem('practiceRecords_'+dk,JSON.stringify(dailyPracticeRecords[dk]));
  }catch(e){}
}
function getStudentPracticeRecord(name,dk){
  if(!dk) dk=getTodayDateString();
  if(!dailyPracticeRecords[dk]){
    const raw=localStorage.getItem('practiceRecords_'+dk);
    if(raw){
      try{dailyPracticeRecords[dk]=JSON.parse(raw);}catch(e){}
    }
  }
  return dailyPracticeRecords[dk]?.[name]||{inSlot:0,outSlot:0,totalSessions:0,sessions:[],lastUpdated:0};
}
function estimateLiveSessionInOut(sess){
  if(!sess.isActive) return null;
  const now=Date.now();
  if(now<sess.prepEndTime) return {tempIn:0,tempOut:0};
  const baseIn=sess.inSlotTime;
  const baseOut=sess.outSlotTime;
  let extra=0;
  if(sess._lastTick){
    const dt=Math.floor((now-sess._lastTick)/1000);
    if(dt>0 && dt<900) extra=dt;
  }
  const curSlot=findCurrentTimeSlot(getStudentTodaySlots(sess.studentName),now);
  if(curSlot) return {tempIn:baseIn+extra,tempOut:baseOut};
  return {tempIn:baseIn,tempOut:baseOut+extra};
}
function getStudentPracticeStats(name,days=7){
  const stats={totalDays:0,totalInSlot:0,totalOutSlot:0,totalSessions:0,dailyDetails:[]};
  const today=new Date();
  for(let i=0;i<days;i++){
    const d=new Date(today.getTime()-i*86400000);
    const dk=toDateKey(d);
    const rec=getStudentPracticeRecord(name,dk);
    if(rec.totalSessions>0){
      stats.totalDays++;
      stats.totalInSlot+=rec.inSlot;
      stats.totalOutSlot+=rec.outSlot;
      stats.totalSessions+=rec.totalSessions;
    }
    stats.dailyDetails.push({date:dk,inSlot:rec.inSlot,outSlot:rec.outSlot,sessions:rec.totalSessions});
  }
  return stats;
}
function calculateDailyTotalDuration(name){
  const rec=getStudentPracticeRecord(name,getTodayDateString());
  let total=rec.inSlot+rec.outSlot;
  for(const [sid,sess] of practiceSessionTracker.entries()){
    if(sess.studentName===name && sess.isActive){
      const live=estimateLiveSessionInOut(sess);
      if(live){
        total += live.tempIn + live.tempOut - (sess.inSlotTime + sess.outSlotTime);
      }
    }
  }
  return total;
}
function formatDailyTotalDuration(name){
  return formatDuration(calculateDailyTotalDuration(name));
}

/* =============================
   13. 学生详情
   ============================= */
function openStudentDetail(name){
    const info = getStudentInfo(name);
    const practice = realTimePracticeMap[name];
    const today = formatDate(new Date());
    const excuse = (excuseData[today] || {})[name];

    // 🔥 新增：智能状态判断
    const now = new Date();
    const currentDay = now.getDay();
    const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();
    const presentSet = new Set();
    rooms.forEach(r => { if(r.student) presentSet.add(r.student); });
    const todayExcuses = excuseData[today] || {};
    
    const currentStatus = getStudentCurrentStatus(name, presentSet, todayExcuses, currentDay, currentTimeMinutes);

    // 近7天考勤 - 按从今天到7天前的顺序
    const todayDate = new Date();
    const history = [];
    for (let i = 0; i < 7; i++) {
        const date = new Date(todayDate.getFullYear(), todayDate.getMonth(), todayDate.getDate() - i);
        const dateStr = formatDate(date);
        const rec = attendanceRecordsCache[dateStr];
        let status = 'no-data';
        if (rec) {
            const found = [ ...(rec.students||[]), ...(rec.endedSlots||[]) ].find(s=>s.name===name);
            if (found) status = found.finalAttendanceStatus || 'no-data';
        }
        history.push({ date: dateStr, status });
    }

    // 练琴统计 - 只用于生成明细表格
    const pStats = getStudentPracticeStats(name,7);
    const todayRec = getStudentPracticeRecord(name,getTodayDateString());
    let liveIn = 0, liveOut = 0;
    
    // 如果学生当前正在练琴，计算实时累积时间
    if (practice) {
        // 获取学生今日时间段
        const slots = getStudentTodaySlots(name);
        const now = Date.now();
        const startTime = practice.startTime;
        
        // 计算从开始到现在的总时长（秒）
        const totalSeconds = Math.floor((now - startTime) / 1000);
        
        // 按分钟计算时段内外时间
        let inSlotSeconds = 0;
        let outSlotSeconds = 0;
        
        // 从开始时间每分钟检查一次是否在时间段内
        for (let t = startTime; t < now; t += 60000) {
            const currentSlot = findCurrentTimeSlot(slots, t);
            if (currentSlot) {
                inSlotSeconds += 60;
            } else {
                outSlotSeconds += 60;
            }
        }
        
        // 加上历史记录
        liveIn = todayRec.inSlot + inSlotSeconds;
        liveOut = todayRec.outSlot + outSlotSeconds;
    } else {
        // 不在练琴时只显示历史记录
        liveIn = todayRec.inSlot;
        liveOut = todayRec.outSlot;
    }
    
    const todayInMin   = Math.floor(liveIn / 60);
    const todayOutMin  = Math.floor(liveOut / 60);
    const todayTotalMin = todayInMin + todayOutMin;

    const practiceRows = pStats.dailyDetails
        .sort((a,b)=>b.date.localeCompare(a.date))
        .map(d=>{
            let inM  = Math.floor(d.inSlot/60);
            let outM = Math.floor(d.outSlot/60);
            let sessions = d.sessions;
            
            // 如果是今天且学生正在练琴，加上实时数据
            if (d.date === getTodayDateString() && practice) {
                const slots = getStudentTodaySlots(name);
                const now = Date.now();
                const startTime = practice.startTime;
                
                // 计算实时时段内外时间
                let realtimeInSeconds = 0;
                let realtimeOutSeconds = 0;
                
                for (let t = startTime; t < now; t += 60000) {
                    const currentSlot = findCurrentTimeSlot(slots, t);
                    if (currentSlot) {
                        realtimeInSeconds += 60;
                    } else {
                        realtimeOutSeconds += 60;
                    }
                }
                
                inM = Math.floor((d.inSlot + realtimeInSeconds) / 60);
                outM = Math.floor((d.outSlot + realtimeOutSeconds) / 60);
                sessions = d.sessions + 1; // 当前会话算作一次
            }
            
            // 今天的行添加特殊样式
            const isToday = d.date === getTodayDateString();
            const rowClass = isToday ? ' class="today-row"' : '';
            const dateDisplay = isToday ? `${d.date} <small style="color:#007bff;">(今天)</small>` : d.date;
            
            return `<tr${rowClass}>
                <td class="date-cell">${dateDisplay}</td>
                <td>${inM}</td>
                <td>${outM}</td>
                <td class="total-duration-cell">${inM+outM}</td>
            </tr>`;
        }).join('') || `<tr><td colspan="4" style="text-align:center;color:#999;">无记录</td></tr>`;

    const modal   = document.getElementById('studentDetailModal');
    if (!modal) return;
    document.getElementById('studentDetailTitle').textContent = name + ' - ' + t('student.detail.title','学生详情');
    const content = document.getElementById('studentDetailContent');

    // 🔥 修改：使用智能状态判断的结果
    const statusNow = getStatusText(currentStatus);

    const duration  = practice ? formatDuration(practice.currentSec) : t('time.no_practice','0分钟');
    const startTime = practice
        ? new Date(practice.startTime).toLocaleTimeString(
            currentLanguage==='zh'?'zh-CN':'en-US',
            {hour:'2-digit',minute:'2-digit'}
        )
        : t('student.not_started','未开始');

    let historyHtml = '';
    history.forEach((h, index)=>{
        const cls = getStatusClassSimple(h.status);
        const day = index + 1; // 1是今天，2是昨天，以此类推
        historyHtml += `<div class="history-day ${cls}" onclick="showDayAttendanceDetail('${name}', '${h.date}', ${day})" title="点击查看${h.date}详情">${day}</div>`;
    });

    // 🔥 新增：根据当前状态显示时间段信息
    let timeSlotInfo = '';
    if (currentStatus !== 'excused') {
        const dayMap = {1: 'monday', 2: 'tuesday', 3: 'wednesday', 4: 'thursday', 5: 'friday'};
        const dayKey = dayMap[currentDay];
        
        if (dayKey && studentTimeSlots[name] && studentTimeSlots[name][dayKey]) {
            const todaySlots = studentTimeSlots[name][dayKey];
                        if (todaySlots && todaySlots.length > 0) {
                const slotsHtml = todaySlots.map(slot => {
                    const startMinutes = timeToMinutes(slot.start);
                    const endMinutes = timeToMinutes(slot.end);
                    const isCurrent = currentTimeMinutes >= startMinutes && currentTimeMinutes < endMinutes;
                    const currentClass = isCurrent ? ' current' : '';
                    const statusIcon = isCurrent ? '🎵 ' : '';
                    return `<span class="time-slot-tag${currentClass}">${statusIcon}${slot.start}-${slot.end}</span>`;
                }).join('');
                
                timeSlotInfo = `
                    <div class="metric-item time-slots-container">
                        <div class="metric-icon">📅</div>
                        <div class="metric-content">
                            <div class="metric-label">考勤时间段</div>
                            <div class="metric-value time-slots-wrapper">${slotsHtml}</div>
                        </div>
                    </div>
                `;

            } else {
                timeSlotInfo = `
                    <div class="metric-item">
                        <div class="metric-icon">📅</div>
                        <div class="metric-content">
                            <div class="metric-label">今日时间段</div>
                            <div class="metric-value">无安排</div>
                        </div>
                    </div>
                `;
            }
        } else {
            const dayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            timeSlotInfo = `
                <div class="metric-item">
                    <div class="metric-icon">📅</div>
                    <div class="metric-content">
                        <div class="metric-label">考勤时间段</div>
                        <div class="metric-value">${dayNames[currentDay]} 无安排</div>
                    </div>
                </div>
            `;
        }
    }

    content.innerHTML = `
        <div class="student-detail-content">
            <div class="student-profile-card">
                <h2 class="profile-name">${name}</h2>
                <div class="profile-meta">
                    <span>${info.major||''}</span><span class="meta-divider">•</span>
                    <span>${info.grade||t('student.not_set','未设置')}</span>
                </div>
            </div>

            <div class="today-status-card ${getStatusClass(currentStatus)}">
                <div class="status-header">
                    <h3 class="status-title">${t('student.today_attendance','今日考勤')}</h3>
                    <div class="status-badge ${getStatusClass(currentStatus)}">${statusNow}</div>
                </div>
                <div class="status-metrics">
                    ${timeSlotInfo}
                    <div class="metric-item practice-status-container">
                        <div class="metric-icon">🎵</div>
                        <div class="metric-content">
                            <div class="metric-label">练琴状态</div>
                            <div class="metric-value practice-status-compact">
                                <div class="practice-info-row">
                                    <span class="practice-info-item">
                                        <span class="practice-label">开始时间:</span>
                                        <strong class="practice-value">${startTime}</strong>
                                    </span>
                                </div>
                                <div class="practice-info-row">
                                    <span class="practice-info-item">
                                        <span class="practice-label">琴房:</span>
                                        <strong class="practice-value">${practice?practice.room:t('student.not_in_room','不在琴房')}</strong>
                                    </span>
                                </div>
                                <div class="practice-info-row">
                                    <span class="practice-info-item">
                                        <span class="practice-label">当前练习:</span>
                                        <strong class="practice-value current-practice">${duration}</strong>
                                    </span>
                                </div>
                                <div class="practice-info-row">
                                    <span class="practice-info-item">
                                        <span class="practice-label">今日总计:</span>
                                        <strong class="practice-value total-practice">${todayTotalMin} 分钟</strong>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                ${excuse?`
                <div class="excuse-info">
                    <div class="excuse-header">
                        <i class="excuse-icon">📝</i><span class="excuse-title">${t('excuse.reason','请假原因')}</span>
                    </div>
                    <div class="excuse-content">
                        <p class="excuse-reason">${excuse.reason||''}</p>
                        ${excuse.durationText?`<p class="excuse-approver">${t('excuse.duration_text','请假时长')}: ${excuse.durationText}</p>`:''}
                        ${excuse.endDate?`<p class="excuse-approver">${t('excuse.end_date','结束日期')}: ${excuse.endDate}</p>`:''}
                    </div>
                </div>`:''}
            </div>

            <div class="card attendance-history">
                <div class="history-title">${t('attendance.history','最近7天考勤')}</div>
                <div class="history-timeline">${historyHtml}</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">🗓️ 最近7天练琴明细</h4>
                    <p style="font-size:0.75rem;color:var(--medium-gray);margin:8px 0 0 0;line-height:1.3;">
                        段内=规定练琴时段，段外=非规定练琴时段，时长单位：分钟
                    </p>
                </div>
                <div class="data-table-container" style="max-height:230px;overflow-y:auto;">
                    <table class="data-table">
                        <thead>
                            <tr><th>${t('report.date', '日期')}</th><th>${t('practice.in_slot', '段内')}</th><th>${t('practice.out_slot', '段外')}</th><th>${t('report.total', '总计')}</th></tr>
                        </thead>
                        <tbody>${practiceRows}</tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    // ---- 关键显示逻辑修复：确保二次打开可见 ----
    // 先清除可能残留的 inline 隐藏
    modal.style.display = 'flex';
    // 防止背景滚动
    document.body.classList.add('modal-open');
    
    // 若需要淡入动画，使用下一帧再加类
    if (!modal.classList.contains('show')) {
        requestAnimationFrame(()=> modal.classList.add('show'));
    }
}

/**
 * 获取天数描述
 * @param {number} dayNumber - 天数（1-7）
 * @returns {string} 描述文本
 */
function getDayDescription(dayNumber) {
    if (currentLanguage === 'en') {
        const descriptions = {
            1: 'Today',
            2: 'Yesterday', 
            3: '2 days ago',
            4: '3 days ago',
            5: '4 days ago',
            6: '5 days ago',
            7: '6 days ago'
        };
        return descriptions[dayNumber] || `${dayNumber-1} days ago`;
    } else {
        const descriptions = {
            1: '今天',
            2: '昨天', 
            3: '前天',
            4: '第4天前',
            5: '第5天前',
            6: '第6天前',
            7: '第7天前'
        };
        return descriptions[dayNumber] || `第${dayNumber}天`;
    }
}


/**
 * 显示某天的考勤详情
 * @param {string} studentName - 学生姓名
 * @param {string} date - 日期 YYYY-MM-DD
 * @param {number} dayNumber - 显示的天数（1-7）
 */
function showDayAttendanceDetail(studentName, date, dayNumber) {
    // 阻止事件冒泡，避免关闭模态框
    event.stopPropagation();
    
    // 获取该日期的考勤记录
    const rec = attendanceRecordsCache[date];
    const today = formatDate(new Date());
    const todayExcuses = excuseData[date] || {};
    
    let detailInfo = {
        present: 0,
        absent: 0,
        excused: 0,
        lowEfficiency: 0,
        details: []
    };
    
    if (rec) {
        // 从考勤记录中查找该学生
        const allRecords = [...(rec.students || []), ...(rec.endedSlots || [])];
        const studentRecords = allRecords.filter(s => s.name === studentName);
        
        studentRecords.forEach(record => {
            const status = record.finalAttendanceStatus;
            const timeSlot = `${record.start || '--'} - ${record.end || '--'}`;
            const practiceTime = record.practicedText || '0分钟';
            
            // 根据状态决定琴房显示
            let roomDisplay = record.room || '待考勤';
            if (status === 'absent') {
                roomDisplay = '不在琴房';
            } else if (status === 'excused') {
                roomDisplay = '请假';
            }
            
            switch(status) {
                case 'present':
                    detailInfo.present++;
                    break;
                case 'absent':
                    detailInfo.absent++;
                    break;
                case 'excused':
                    detailInfo.excused++;
                    break;
                case 'low_efficiency':
                    detailInfo.lowEfficiency++;
                    break;
            }
            
            detailInfo.details.push({
                timeSlot,
                status,
                practiceTime,
                room: roomDisplay,
                statusText: getStatusText(status)
            });
        });
    }
    
    // 检查请假信息
    if (todayExcuses[studentName]) {
        detailInfo.excused++;
        detailInfo.details.push({
            timeSlot: '全天',
            status: 'excused',
            practiceTime: '请假',
            room: '请假',
            statusText: '请假',
            excuseReason: todayExcuses[studentName].reason || '未填写原因'
        });
    }
    
    // 如果没有任何记录，默认为缺勤
    if (detailInfo.details.length === 0) {
        detailInfo.absent = 1;
        detailInfo.details.push({
            timeSlot: '无记录',
            status: 'absent',
            practiceTime: '0分钟',
            room: '不在琴房',
            statusText: '缺勤'
        });
    }
    
    // 显示详情弹窗
    showAttendanceDetailModal(studentName, date, dayNumber, detailInfo);
}


/**
 * 获取状态文本
 */
function getStatusText(status) {
    switch(status) {
        case 'present': return t('status.present', '出勤');
        case 'absent': return t('status.absent', '缺勤');
        case 'excused': return t('status.excused', '请假');
        case 'low_efficiency': return t('status.low_efficiency', '低效');
        default: return t('status.unknown', '待考勤');
    }
}

/**
 * 显示考勤详情模态框 - 调整间距
 */
function showAttendanceDetailModal(studentName, date, dayNumber, detailInfo) {
    // 创建模态框内容 - 调整间距
    const modalContent = `
        <div class="modal-header">
            <h3 class="modal-title">${studentName} - ${getDayDescription(dayNumber)}${t('attendance.detail.suffix', '考勤详情')}</h3>
            <button class="modal-close" onclick="closeAttendanceDetailModal()">&times;</button>
        </div>
        <div style="padding: 25px 20px 20px 20px;">
            <div class="card" style="margin-bottom: 25px;">
                <h4 style="margin-bottom: 20px;">📅 ${date} ${t('attendance.summary', '考勤汇总')}</h4>
                <div class="stats-grid-detailed" style="grid-template-columns: repeat(4, 1fr); gap: 12px;">
                    <div class="stat-item present">
                        <div class="stat-icon">✅</div>
                        <div class="stat-content">
                            <div class="stat-number">${detailInfo.present}</div>
                            <div class="stat-label">${t('stats.present', '出勤')}</div>
                        </div>
                    </div>
                    <div class="stat-item absent">
                        <div class="stat-icon">❌</div>
                        <div class="stat-content">
                            <div class="stat-number">${detailInfo.absent}</div>
                            <div class="stat-label">${t('stats.absent', '缺勤')}</div>
                        </div>
                    </div>
                    <div class="stat-item" style="background: linear-gradient(135deg, #ffeaa7, #fdcb6e);">
                        <div class="stat-icon">⚠️</div>
                        <div class="stat-content">
                            <div class="stat-number">${detailInfo.lowEfficiency}</div>
                            <div class="stat-label">${t('status.low_efficiency', '低效')}</div>
                        </div>
                    </div>
                    <div class="stat-item excused">
                        <div class="stat-icon">📝</div>
                        <div class="stat-content">
                            <div class="stat-number">${detailInfo.excused}</div>
                            <div class="stat-label">${t('stats.excused', '请假')}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h4 style="margin-bottom: 20px;">📋 ${t('attendance.detailed_records', '详细记录')}</h4>
                <div class="data-table-container" style="max-height: 300px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>${t('student.time_slot', '时间段')}</th>
                                <th>${t('filter.status', '状态')}</th>
                                <th>${t('student.practice_duration', '练琴时长')}</th>
                                <th>${t('student.room', '琴房')}</th>
                                ${detailInfo.details.some(d => d.excuseReason) ? `<th>${t('attendance.remarks', '备注')}</th>` : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${detailInfo.details.map(detail => `
                                <tr>
                                    <td>${detail.timeSlot}</td>
                                    <td><span class="table-status-badge ${getStatusClassSimple(detail.status)}">${detail.statusText}</span></td>
                                    <td>${detail.practiceTime}</td>
                                    <td>${detail.room}</td>
                                    ${detail.excuseReason ? `<td>${detail.excuseReason}</td>` : (detailInfo.details.some(d => d.excuseReason) ? '<td>-</td>' : '')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // 其余代码保持不变...
    let detailModal = document.getElementById('attendanceDetailModal');
    if (!detailModal) {
        detailModal = document.createElement('div');
        detailModal.id = 'attendanceDetailModal';
        detailModal.className = 'modal';
        detailModal.innerHTML = `<div class="modal-content" style="max-width: 800px;"></div>`;
        document.body.appendChild(detailModal);
    }
    
    detailModal.classList.remove('hiding');
    detailModal.querySelector('.modal-content').innerHTML = modalContent;
    detailModal.style.display = 'flex';
    
    // 防止背景滚动
    document.body.classList.add('modal-open');
    
    requestAnimationFrame(() => {
        detailModal.classList.add('show');
    });
}

/**
 * 关闭考勤详情模态框 - 简单渐隐动画
 */
function closeAttendanceDetailModal() {
    const modal = document.getElementById('attendanceDetailModal');
    if (modal && modal.classList.contains('show')) {
        // 直接设置透明度为0，触发渐隐动画
        modal.style.opacity = '0';
        modal.classList.remove('show');
        
        // 恢复背景滚动
        document.body.classList.remove('modal-open');
        
        // 等待渐隐动画完成后隐藏
        setTimeout(() => {
            modal.style.display = 'none';
            modal.style.opacity = '1'; // 重置透明度，为下次显示做准备
        }, 300);
    }
}




/* =============================
   14. 报告（基于 attendanceRecordsCache）
   ============================= */
function generateReport(){
  const start=document.getElementById('startDate').value;
  const end=document.getElementById('endDate').value;
  if(!start||!end){
    alert(t('msg.select_dates','请选择开始和结束日期'));
    return;
  }
  if(new Date(start)>new Date(end)){
    alert(t('msg.date_range_error','开始日期不能晚于结束日期'));
    return;
  }
  const content=document.getElementById('reportContent');
  content.innerHTML='<div class="loading"><div class="spinner"></div></div>';
  // 按需加载日期范围内的记录
  loadAttendanceRange(start,end).then(()=> {
    const data=collectReportData(start,end);
    content.innerHTML=renderReportHTML(data,start,end);
  }).catch(e=>{
    content.innerHTML=`<div class="empty-state"><div class="empty-state-icon">⚠️</div><div class="empty-state-title">${t('empty.load_failed','加载失败')}</div><div class="empty-state-description">${e.message}</div></div>`;
  });
}
function loadAttendanceRange(start,end){
  if(!isOnline) return Promise.resolve();
  const dates=getDateSpan(start,end);
  const tasks=[];
  dates.forEach(d=>{
    if(!attendanceRecordsCache[d]){
      tasks.push(database.ref(`attendanceRecords/${d}`).once('value').then(snap=>{
        attendanceRecordsCache[d]=snap.val()||null;
      }));
    }
  });
  return Promise.all(tasks);
}
function getDateSpan(start,end){
  const res=[];
  let d=new Date(start);
  const ed=new Date(end);
  while(d<=ed){
    res.push(formatDate(d));
    d.setDate(d.getDate()+1);
  }
  return res;
}
function collectReportData(start,end){
  const dates=getDateSpan(start,end);
  const daily=[];
  const studentAgg=new Map();
  dates.forEach(date=>{
    const rec=attendanceRecordsCache[date];
    if(!rec){
      daily.push({date,total:0,present:0,absent:0,excused:0,rate:0});
      return;
    }
    const all=[...(rec.students||[]),...(rec.endedSlots||[])];
    let present=0,excused=0,absent=0,total=all.length;
    all.forEach(s=>{
      const stat=s.finalAttendanceStatus;
      if(stat==='present') present++;
      else if(stat==='excused') excused++;
      else if(stat==='absent') absent++;
      // 聚合学生
      if(!studentAgg.has(s.name)){
        studentAgg.set(s.name,{name:s.name,major:s.major||'',present:0,excused:0,absent:0,total:0});
      }
      const ag=studentAgg.get(s.name);
      ag.total++;
      if(stat==='present') ag.present++;
      else if(stat==='excused') ag.excused++;
      else if(stat==='absent') ag.absent++;
    });
    const eff=total>0?((present+excused)/total*100).toFixed(1):0;
    daily.push({date,total,present,absent,excused,rate:eff});
  });
  const students=[...studentAgg.values()].map(s=>{
    s.rate=s.total>0?((s.present+s.excused)/s.total*100).toFixed(1):'0.0';
    return s;
  }).sort((a,b)=>b.rate - a.rate);
  return {daily,students};
}
function renderReportHTML(data,start,end){
  return `
    <div class="card">
      <h4>${t('report.analysis_title','📊 考勤分析报告')}</h4>
      <div class="student-details">
        <div class="detail-item">
          <div class="detail-label">${t('report.period','统计周期')}</div>
          <div class="detail-value">${start} ${t('report.to','至')} ${end} (${data.daily.length}${t('report.days','天')})</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">${t('report.participants','参与学生')}</div>
          <div class="detail-value">${data.students.length}${t('report.people','人')}</div>
        </div>
      </div>
    </div>
    <div class="card">
      <h4>${t('report.daily_trend','📈 每日考勤趋势')}</h4>
      <div class="data-table-container" style="max-height:300px;overflow-y:auto;">
        <table class="data-table daily-trend">
          <thead><tr>
            <th>${t('report.date','日期')}</th>
            <th>${t('report.total','合计')}</th>
            <th>${t('stats.present','出勤')}</th>
            <th>${t('stats.absent','缺勤')}</th>
            <th>${t('stats.excused','请假')}</th>
            <th>${t('attendance.rate','出勤率')}</th>
          </tr></thead>
          <tbody>
            ${data.daily.map(d=>`<tr>
              <td>${d.date}</td>
              <td>${d.total}</td>
              <td>${d.present}</td>
              <td>${d.absent}</td>
              <td>${d.excused}</td>
              <td>${d.rate}%</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <h4>${t('report.student_stats','👥 学生考勤统计')}</h4>
      <div class="data-table-container" style="max-height:400px;overflow-y:auto;">
        <table class="data-table student-stats">
          <thead><tr>
            <th>${t('student.name','姓名')}</th>
            <th>${t('student.major','专业')}</th>
            <th>${t('stats.present','出勤')}</th>
            <th>${t('stats.absent','缺勤')}</th>
            <th>${t('stats.excused','请假')}</th>
            <th>${t('attendance.rate','出勤率')}</th>
          </tr></thead>
          <tbody>
            ${data.students.map(s=>`<tr>
              <td>${s.name}</td>
              <td>${s.major}</td>
              <td>${s.present}</td>
              <td>${s.absent}</td>
              <td>${s.excused}</td>
              <td>${s.rate}%</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
      <div class="export-options">
        <button class="btn btn-primary" onclick="generateReport()"><span>🔄</span>${t('report.regenerate','重新生成')}</button>
      </div>
    </div>
  `;
}


/* =============================
   15. 同步 & 缓存
   ============================= */
function forceSync(){
  if(!isOnline){
    alert(t('msg.sync_required','需要网络连接才能同步数据'));
    return;
  }
  addSyncLog('🔄 '+t('sync.force_sync','强制同步'));
  loadAllCoreData(true);
}
function loadAllCoreData(force=false){
  if(!database) return;
  const today=formatDate(new Date());
  const tasks=[];
  tasks.push(database.ref('rooms').once('value').then(s=>{ if(Array.isArray(s.val())){rooms=s.val();buildRealTimePracticeFromRooms();}}));
  tasks.push(database.ref('studentDatabase').once('value').then(s=>{ if(s.val()) studentDatabase=s.val();}));
  tasks.push(database.ref('excuseData').once('value').then(s=>{ if(s.val()) excuseData=s.val(); }));
  tasks.push(database.ref(`attendanceRecords/${today}`).once('value').then(s=>{ attendanceRecordsCache[today]=s.val()||null; }));
  Promise.all(tasks).then(()=>{
    addSyncLog('✅ 核心数据加载完成');
    updateStatsPanel();
    renderPracticeArea();
    renderExcusePanel();
    renderAttendanceSnapshot(today);
    if(currentTab==='students') renderStudentList();
  }).catch(e=>{
    addSyncLog('❌ 加载失败 '+e.message);
  });
}
function clearLocalCache(){
  if(!confirm(t('msg.clear_cache_confirm','确定要清除本地缓存吗？'))) return;
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith('attendance_')||k==='studentData'||k==='excuseData') localStorage.removeItem(k);
  });
  addSyncLog('🗑️ '+t('msg.cache_cleared','本地缓存已清除'));
  alert(t('msg.cache_cleared','本地缓存已清除'));
}

/* =============================
   16. Tab 切换
   ============================= */
function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.toggle('active', b.getAttribute('onclick').includes(tab)));
  document.querySelectorAll('.tab-content').forEach(div=>div.style.display='none');
  document.getElementById(tab+'Tab').style.display='block';
  
  if(tab==='dashboard'){
    updateStatsPanel();
    renderPracticeArea();
    renderExcusePanel();
    // 🔥 修改：只在必要时重新加载考勤数据
    const currentDate = document.getElementById('dateSelect').value;
    if (currentDate && attendanceRecordsCache[currentDate] !== undefined) {
      // 如果已有数据，直接渲染
      renderAttendanceSnapshot(currentDate);
    } else {
      // 如果没有数据，才重新加载
      loadAttendanceData();
    }
  }else if(tab==='students'){
    renderStudentList();
  }
}


/* =============================
   17. 其它辅助
   ============================= */
function refreshCurrentTabContent(){
  if(currentTab==='dashboard'){
    updateStatsPanel();
    renderPracticeArea();
    renderExcusePanel();
    // 🔥 修改：避免不必要的重新加载
    const currentDate = document.getElementById('dateSelect').value;
    if (currentDate && window.attendanceSnapshotData) {
      // 如果已有数据，直接重新渲染
      renderAttendanceSnapshot(currentDate);
    }
  }else if(currentTab==='students'){
    renderStudentList();
  }
}
// 🔥 新增：防抖函数
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// 🔥 新增：防抖版本的筛选函数
const debouncedFilterAttendanceSnapshot = debounce(filterAttendanceSnapshot, 300);

// 修改HTML中的调用
// 将 oninput="filterAttendanceSnapshot()" 改为 oninput="debouncedFilterAttendanceSnapshot()"

/* 暴露必要函数到全局（HTML 内联调用） */
window.switchLanguage=switchLanguage;
window.switchTab=switchTab;
window.filterPracticeStatus=filterPracticeStatus;
window.clearPracticeFilters=clearPracticeFilters;
window.openStudentDetail=openStudentDetail;
window.closeModal=closeModal;
window.generateReport=generateReport;
window.loadAttendanceData=loadAttendanceData;
window.forceSync=forceSync;
window.clearLocalCache=clearLocalCache;
window.filterStudents=renderStudentList;
window.showDayAttendanceDetail = showDayAttendanceDetail;
window.closeAttendanceDetailModal = closeAttendanceDetailModal;
// 在文件末尾的全局函数暴露部分添加
window.filterAttendanceSnapshot = filterAttendanceSnapshot;
window.setAttendanceFilter = setAttendanceFilter;
window.clearAttendanceFilters = clearAttendanceFilters;
window.updateAttendanceQuickFilterTags = updateAttendanceQuickFilterTags;
window.renderAttendanceCards = renderAttendanceCards;
// 在文件末尾的全局函数暴露部分添加
window.debouncedFilterAttendanceSnapshot = debounce(filterAttendanceSnapshot, 300);


/* =============================
   18. 定时刷新（练琴时长每 30s 更新 UI）
   ============================= */
setInterval(()=>{
  // 更新 duration
  const now=Date.now();
  Object.keys(realTimePracticeMap).forEach(n=>{
    const p=realTimePracticeMap[n];
    p.currentSec=Math.floor((now-p.startTime)/1000);
  });
  if(currentTab==='dashboard') renderPracticeArea();
  if(currentTab==='students') renderStudentList();
},30000);
// 每 10 秒检查是否到达 1 分钟边界，做一次会话累积
setInterval(()=>{
  const now=Date.now();
  if(now - lastPracticeSessionSweep >= PRACTICE_UPDATE_INTERVAL_MS - 500){
    updatePracticeSessions();
    lastPracticeSessionSweep=now;
  }
},10000);


</script>
</body>
</html>
