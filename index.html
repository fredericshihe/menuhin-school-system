<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>青岛梅纽因音乐学校练琴跟踪系统</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root {
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --success-color: #27ae60;
    --background-color: #f8f9fa;
    --text-color: #2c3e50;
    --border-color: #dee2e6;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --radius: 12px;
    --mobile-padding: 15px;
    --mobile-font-size: 16px;
    --touch-target-size: 44px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    overflow-x: hidden;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom);
}

/* 语言切换按钮 */
.language-switcher {
    position: fixed;
    bottom: max(20px, env(safe-area-inset-bottom) + 10px);
    left: 20px;
    z-index: 1001;
    display: flex;
    background: white;
    border-radius: 20px;
    box-shadow: var(--shadow);
    overflow: hidden;
}

.lang-btn {
    padding: 8px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 40px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lang-btn.active {
    background: var(--primary-color);
    color: white;
}

.lang-btn:hover:not(.active) {
    background: rgba(52, 152, 219, 0.1);
}

/* 移动端适配 */
@media (max-width: 768px) {
    .language-switcher {
        bottom: max(10px, env(safe-area-inset-bottom) + 5px);
        left: 10px;
        border-radius: 16px;
    }
    
    .lang-btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 35px;
        height: 28px;
    }
}

/* 头部样式 */
.header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: max(30px, env(safe-area-inset-top) + 20px) 20px 30px 20px;
    margin-bottom: 30px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
}

.header h1 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    margin-bottom: 10px;
    font-weight: 300;
    line-height: 1.2;
}

.header .subtitle {
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    opacity: 0.9;
    line-height: 1.3;
}

/* 连接状态指示器 */
.connection-status {
    position: fixed;
    top: max(20px, env(safe-area-inset-top) + 10px);
    right: 20px;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    z-index: 1000;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.connection-status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--danger-color);
}

.connection-status.online::before {
    background: var(--success-color);
}

.connection-status.syncing::before {
    background: var(--warning-color);
    animation: pulse 1.5s infinite;
}

.connection-status.online {
    background: white;
    color: var(--success-color);
    border: 1px solid var(--success-color);
}

.connection-status.offline {
    background: white;
    color: var(--danger-color);
    border: 1px solid var(--danger-color);
}

.connection-status.syncing {
    background: white;
    color: var(--warning-color);
    border: 1px solid var(--warning-color);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* 主导航 */
.nav-tabs {
    display: flex;
    background: white;
    border-radius: var(--radius);
    padding: 5px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.nav-tabs::-webkit-scrollbar {
    display: none;
}

.nav-tab {
    flex: 1;
    padding: 12px 16px;
    text-align: center;
    background: transparent;
    border: none;
    border-radius: calc(var(--radius) - 5px);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: clamp(14px, 3vw, 16px);
    font-weight: 500;
    white-space: nowrap;
    min-width: 120px;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
}

.nav-tab:hover {
    background: rgba(52, 152, 219, 0.1);
}

.nav-tab.active {
    background: var(--primary-color);
    color: white;
}

/* 卡片容器 */
.card {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
}

.card.success {
    border-left-color: var(--success-color);
}

.card.warning {
    border-left-color: var(--warning-color);
}

.card.danger {
    border-left-color: var(--danger-color);
}

/* 统计面板 */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 10px;
}

.stat-label {
    font-size: 1.1rem;
    color: #666;
    margin-bottom: 5px;
}

.stat-description {
    font-size: 0.9rem;
    color: #999;
}

.stat-card.present .stat-number { color: var(--success-color); }
.stat-card.absent .stat-number { color: var(--danger-color); }
.stat-card.excused .stat-number { color: var(--warning-color); }
.stat-card.total .stat-number { color: var(--primary-color); }
.stat-card.unscheduled .stat-number { color: #9b59b6; }
.stat-card.weekend .stat-number { color: #95a5a6; }

/* 🔥 统一的学生网格布局 */
.student-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-top: 20px;
    width: 100%;
}

/* 🔥 响应式网格优化 */
@media (min-width: 600px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
    }
}

@media (min-width: 900px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }
}

@media (min-width: 1200px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
    }
}

@media (min-width: 1600px) {
    .student-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: 15px;
    }
}



/* 🔥 统一的卡片基础样式 - 学生卡片和实时练琴卡片共用 */
.student-card,
.practice-status-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    border-left: 4px solid #ddd;
    cursor: pointer;
    min-width: 0;
    width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    height: auto;
    min-height: 280px;
}

/* 🔥 新增：确保卡片在大屏幕下有合适的最小宽度 */
@media (min-width: 1200px) {
    .student-card,
    .practice-status-card {
        min-width: 260px;
    }
}

@media (min-width: 1400px) {
    .student-card,
    .practice-status-card {
        min-width: 280px;
    }
}

@media (min-width: 1600px) {
    .student-card,
    .practice-status-card {
        min-width: 320px;
    }
}


/* 🔥 统一的卡片悬停效果 */
.student-card:hover,
.practice-status-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

/* 🔥 统一的状态样式 */
.student-card.present { border-left-color: var(--success-color); }
.student-card.absent { border-left-color: var(--danger-color); }
.student-card.excused { border-left-color: var(--warning-color); }
.student-card.low-efficiency { border-left-color: #f39c12; }
.student-card.practicing-unscheduled,
.practice-status-card { 
    border-left-color: #9b59b6; 
    background: linear-gradient(135deg, #f8f4ff, #ffffff);
}
.student-card.weekend { 
    border-left-color: #95a5a6; 
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
}

/* 🔥 统一的头部样式 */
.student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

/* 🔥 统一的学生姓名样式 */
.student-name {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
}

/* 🔥 统一的状态/时长标签样式 */
.student-status,
.practice-duration {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
}

/* 学生状态颜色 */
.student-status.present { background: #d4edda; color: #155724; }
.student-status.absent { background: #f8d7da; color: #721c24; }
.student-status.excused { background: #fff3cd; color: #856404; }
.student-status.low-efficiency { background: #ffeaa7; color: #b06000; }
.student-status.practicing-unscheduled { background: #e8d5f2; color: #6a1b9a; }
.student-status.weekend { background: #ecf0f1; color: #2c3e50; }

/* 练琴时长标签颜色 */
.practice-duration {
    background: #e8d5f2;
    color: #6a1b9a;
}

/* 🔥 统一的详情网格样式 */
.student-details,
.practice-details {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-bottom: 15px;
    flex: 1;
}

/* 🔥 优化：根据屏幕尺寸调整详情网格 */
@media (min-width: 480px) {
    .student-details,
    .practice-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
}

@media (min-width: 768px) {
    .student-details,
    .practice-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
}

@media (min-width: 1024px) {
    .student-details,
    .practice-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
}

/* 🔥 新增：大屏幕下保持2列，避免过度压缩 */
@media (min-width: 1200px) {
    .student-details,
    .practice-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
    }
}

@media (min-width: 1600px) {
    .student-details,
    .practice-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
}




/* 🔥 统一的详情项样式 */
.detail-item {
    display: flex;
    flex-direction: column;
}

.detail-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 3px;
}

.detail-value {
    font-weight: 600;
    color: var(--text-color);
}

/* 🔥 实时练琴卡片特有的指示器 */
.practice-status-card .practice-indicator {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    background: #27ae60;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

/* 🔥 考勤历史样式（只在学生详情卡片中显示） */
.attendance-history {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.history-title {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 10px;
}

.history-timeline {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.history-day {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.history-day.present { background: var(--success-color); color: white; }
.history-day.absent { background: var(--danger-color); color: white; }
.history-day.excused { background: var(--warning-color); color: white; }
.history-day.no-data { background: #f8f9fa; color: #999; }

.history-day:hover {
    transform: scale(1.1);
}

/* 🔥 空状态样式 */
.practice-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.practice-empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.practice-empty-state-title {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--text-color);
}

.practice-empty-state-description {
    font-size: 0.9rem;
    line-height: 1.4;
}

/* 🔥 响应式设计 - 统一处理 */
/* 超大屏幕：保持4列 */
@media (min-width: 1400px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }
}

/* 大屏幕：保持4列 */
@media (min-width: 1200px) and (max-width: 1399px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
    }
}

/* 中等屏幕：3列 */
@media (min-width: 900px) and (max-width: 1199px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }
}

/* 平板：2列 */
@media (min-width: 600px) and (max-width: 899px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .student-card,
    .practice-status-card {
        padding: 18px;
    }
}

/* 手机：1列 */
@media (max-width: 480px) {
    .container {
        padding: 10px;
    }
    
    .student-card,
    .practice-status-card {
        padding: 10px;
    }
    
    .header h1 {
        font-size: 1.5rem;
    }
    
    .header .subtitle {
        font-size: 0.9rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
    
    .student-name {
        font-size: 1.1rem;
    }
    
    .detail-label {
        font-size: 0.8rem;
    }
    
    .detail-value {
        font-size: 0.9rem;
    }
    .student-details,
    .practice-details {
        grid-template-columns: 1fr;
        gap: 6px;
    }
}


/* 筛选器 */
.filters {
    background: white;
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 25px;
    box-shadow: var(--shadow);
}

.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
}

.filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
}

.filter-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 5px;
}

.filter-select, .filter-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.filter-select:focus, .filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* 操作按钮 */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: var(--mobile-font-size);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: var(--touch-target-size);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

.btn:hover {
    transform: translateY(-2px);
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-warning {
    background: var(--warning-color);
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

/* 模态框 */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    animation: fadeIn 0.3s ease;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    max-width: min(600px, 95vw);
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideIn 0.3s ease;
    margin: env(safe-area-inset-top) auto env(safe-area-inset-bottom) auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    color: var(--danger-color);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* 表格样式 */
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
}

.data-table th,
.data-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    min-width: 80px;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: var(--text-color);
}

.data-table tr:hover {
    background: #f8f9fa;
}

/* 加载动画 */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 空状态 */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: var(--text-color);
}

.empty-state-description {
    font-size: 1rem;
    line-height: 1.6;
}

/* 日期选择器样式 */
.date-picker {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.date-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
}

/* 导出按钮样式 */
.export-options {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* 触摸优化 */
.student-card, .practice-status-card, .stat-card, .btn, .nav-tab {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
    tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.student-card:active, .practice-status-card:active, .stat-card:active {
    transform: scale(0.98);
}

.btn:active {
    transform: scale(0.95);
}

/* iOS安全区域适配 */
@supports (padding: max(0px)) {
    .container {
        padding-left: max(20px, env(safe-area-inset-left));
        padding-right: max(20px, env(safe-area-inset-right));
    }
    
    @media (max-width: 768px) {
        .container {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }
    }
}

/* 防止缩放 */
input[type="text"], input[type="date"], select, textarea {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

/* 滚动条优化 */
.modal-content, .sync-logs {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

.modal-content::-webkit-scrollbar, .sync-logs::-webkit-scrollbar {
    width: 4px;
}

.modal-content::-webkit-scrollbar-track, .sync-logs::-webkit-scrollbar-track {
    background: transparent;
}

.modal-content::-webkit-scrollbar-thumb, .sync-logs::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 2px;
}


/* 超小屏幕优化 */
@media (max-width: 480px) {
    .container {
        padding: 10px;
    }
    
    .student-card,
    .practice-status-card {
        padding: 10px;
    }
    
    .header h1 {
        font-size: 1.5rem;
    }
    
    .header .subtitle {
        font-size: 0.9rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
    
    .student-name {
        font-size: 1.1rem;
    }
    
    .detail-label {
        font-size: 0.8rem;
    }
    
    .detail-value {
        font-size: 0.9rem;
    }
}

/* iOS Safari 特殊优化 */
@supports (-webkit-touch-callout: none) {
    .nav-tabs {
        -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
        -webkit-overflow-scrolling: touch;
    }
    
    input, select, textarea {
        -webkit-appearance: none;
        border-radius: 8px;
    }
    
    .btn {
        -webkit-appearance: none;
    }
}

/* 横屏模式优化 */
@media (max-width: 768px) and (orientation: landscape) {
    .header {
        padding: max(15px, env(safe-area-inset-top) + 10px) 20px 15px 20px;
    }
    
    .header h1 {
        font-size: 1.8rem;
        margin-bottom: 5px;
    }
    
    .header .subtitle {
        font-size: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .modal-content {
        max-height: 80vh;
    }
}

/* 🔥 新增：特殊内容的处理 */
.detail-item[style*="grid-column: 1 / -1"] .detail-value {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-top: 2px;
}

/* 🔥 新增：请假信息样式优化 */
.detail-item .detail-value[style*="color: #f39c12"] {
    background: rgba(243, 156, 18, 0.1);
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    line-height: 1.3;
}

/* 🔥 新增：数据表格容器 */
.data-table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* 🔥 新增：学生详情内容样式 */
.student-detail-content .card {
    margin-bottom: 20px;
}

.student-detail-content .card:last-child {
    margin-bottom: 0;
}

/* 🔥 新增：同步日志样式 */
.sync-logs {
    max-height: 400px;
    overflow-y: auto;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 14px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* 🔥 新增：练琴状态特殊样式 */
.practice-status-card .student-header {
    position: relative;
}

.practice-status-card .practice-indicator {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.7;
        transform: scale(1.1);
    }
}

/* 🔥 新增：状态标签的统一样式 */
.student-status,
.practice-duration {
    display: inline-block;
    white-space: nowrap;
    text-align: center;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    transition: all 0.15s ease-in-out;
}

/* 🔥 新增：考勤历史时间轴增强 */
.history-timeline {
    padding: 10px 0;
    justify-content: flex-start;
}

.history-day {
    position: relative;
    border: 2px solid transparent;
    transition: all 0.2s ease;
}

.history-day:hover {
    transform: scale(1.15);
    z-index: 1;
}

.history-day.present {
    background: var(--success-color);
    border-color: var(--success-color);
}

.history-day.absent {
    background: var(--danger-color);
    border-color: var(--danger-color);
}

.history-day.excused {
    background: var(--warning-color);
    border-color: var(--warning-color);
}

.history-day.no-data {
    background: #f8f9fa;
    border-color: #dee2e6;
    color: #6c757d;
}

.history-day.low-efficiency {
    background: #f39c12;
    border-color: #f39c12;
    color: white;
}

.history-day.practicing-unscheduled {
    background: #9b59b6;
    border-color: #9b59b6;
    color: white;
}

.history-day.weekend {
    background: #95a5a6;
    border-color: #95a5a6;
    color: white;
}

/* 🔥 新增：工具提示样式 */
[title] {
    position: relative;
}

/* 🔥 新增：表格响应式优化 */
@media (max-width: 768px) {
    .data-table-container {
        margin: 0 -20px;
        padding: 0 20px;
    }
    
    .data-table {
        min-width: 600px;
    }
    
    .data-table th,
    .data-table td {
        padding: 10px 8px;
        font-size: 13px;
    }
}

/* 🔥 新增：筛选器响应式优化 */
@media (max-width: 768px) {
    .filters {
        padding: 15px;
        margin: 0 -5px 20px -5px;
    }
    
    .filter-row {
        gap: 12px;
    }
    
    .filter-group {
        min-width: auto;
        width: 100%;
    }
    
    .filter-select,
    .filter-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }
    
    .filter-select:focus,
    .filter-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}

/* 🔥 新增：日期选择器响应式优化 */
@media (max-width: 768px) {
    .date-picker {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 15px;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-bottom: 20px;
    }
    
    .date-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
    }
    
    .date-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}

/* 🔥 新增：模态框响应式优化 */
@media (max-width: 768px) {
    .modal {
        padding: 0;
        align-items: flex-end;
    }
    
    .modal-content {
        width: 100%;
        max-width: 100%;
        max-height: 90vh;
        border-radius: 20px 20px 0 0;
        margin: 0;
        animation: slideUpIn 0.3s ease;
    }
    
    @keyframes slideUpIn {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-header {
        padding-bottom: 20px;
        border-bottom: 2px solid #eee;
    }
    
    .modal-title {
        font-size: 1.3rem;
    }
    
    .modal-close {
        width: 40px;
        height: 40px;
        font-size: 1.8rem;
        border-radius: 50%;
        background: #f8f9fa;
    }
    
    .modal-close:hover {
        background: #e9ecef;
    }
}

/* 🔥 新增：空状态响应式优化 */
@media (max-width: 768px) {
    .empty-state {
        padding: 40px 15px;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .empty-state-title {
        font-size: 1.2rem;
        margin-bottom: 8px;
    }
    
    .empty-state-description {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .practice-empty-state {
        padding: 30px 15px;
    }
    
    .practice-empty-state-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
    }
    
    .practice-empty-state-title {
        font-size: 1.1rem;
        margin-bottom: 6px;
    }
    
    .practice-empty-state-description {
        font-size: 0.85rem;
    }
}

/* 🔥 新增：加载动画响应式优化 */
@media (max-width: 768px) {
    .loading {
        padding: 30px 20px;
    }
    
    .spinner {
        width: 35px;
        height: 35px;
        border-width: 3px;
    }
}

/* 🔥 新增：统计卡片动画增强 */
.stat-card {
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.stat-card:hover::before {
    left: 100%;
}

/* 🔥 新增：按钮组响应式优化 */
@media (max-width: 768px) {
    .action-buttons {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 15px;
        margin: 20px -15px -15px -15px;
        border-top: 1px solid #eee;
        z-index: 10;
    }
    
    .export-options {
        flex-direction: column;
        gap: 8px;
        margin-top: 15px;
    }
    
    .export-options .btn {
        width: 100%;
    }
}

/* 🔥 新增：深色模式支持（可选） */
@media (prefers-color-scheme: dark) {
    :root {
        --background-color: #1a1a1a;
        --text-color: #ffffff;
        --border-color: #333333;
    }
    
    /* 可以根据需要添加更多深色模式样式 */
}

/* 🔥 新增：打印样式优化 */
@media print {
    .language-switcher,
    .connection-status,
    .nav-tabs,
    .action-buttons,
    .btn,
    .modal {
        display: none !important;
    }
    
    .container {
        max-width: none;
        padding: 0;
    }
    
    .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .student-card,
    .practice-status-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
}

/* 🔥 新增：高对比度模式支持 */
@media (prefers-contrast: high) {
    .student-card,
    .practice-status-card,
    .stat-card {
        border: 2px solid var(--text-color);
    }
    
    .btn {
        border: 2px solid currentColor;
    }
    
    .history-day {
        border-width: 3px;
    }
}

/* 🔥 新增：减少动画模式支持 */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .practice-indicator {
        animation: none;
    }
    
    .spinner {
        animation: none;
        border-top-color: var(--primary-color);
    }
}
/* 🔥 修复：正确的响应式网格 */
@media (min-width: 768px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1024px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (min-width: 1400px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

/* 🔥 新增：确保卡片有足够的最小宽度 */
@media (min-width: 1400px) {
    .student-card,
    .practice-status-card {
        min-width: 280px;
    }
}

@media (min-width: 1600px) {
    .student-card,
    .practice-status-card {
        min-width: 320px;
    }
}

/* 🔥 新增：移动端紧凑卡片样式 */
@media (max-width: 768px) {
    .student-card,
    .practice-status-card {
        min-height: 200px;
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .student-header {
        margin-bottom: 10px;
    }
    
    .student-name {
        font-size: 1.1rem;
        line-height: 1.2;
    }
    
    .student-status,
    .practice-duration {
        padding: 3px 8px;
        font-size: 0.75rem;
        border-radius: 12px;
    }
    
    .student-details,
    .practice-details {
        grid-template-columns: 1fr;
        gap: 8px;
        margin-bottom: 10px;
    }
    
    .detail-item {
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .detail-item:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-size: 0.75rem;
        margin-bottom: 2px;
        color: #888;
    }
    
    .detail-value {
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .attendance-history {
        margin-top: 10px;
        padding-top: 10px;
    }
    
    .history-timeline {
        gap: 6px;
        justify-content: center;
    }
    
    .history-day {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
    }
    
    .practice-indicator {
        width: 8px;
        height: 8px;
        top: 10px;
        right: 10px;
    }
}

/* 🔥 新增：实时练琴筛选器样式 */
.practice-filters {
    background: white;
    padding: 15px;
    border-radius: var(--radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow);
}

.practice-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
}

.practice-filter-group {
    display: flex;
    flex-direction: column;
    min-width: 120px;
    flex: 1;
}

.practice-filter-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 4px;
    font-weight: 500;
}

.practice-filter-select,
.practice-filter-input {
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease;
    background: white;
}

.practice-filter-select:focus,
.practice-filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

/* 移动端筛选器优化 */
@media (max-width: 768px) {
    .practice-filters {
        padding: 12px;
        margin: 0 -5px 15px -5px;
    }
    
    .practice-filter-row {
        flex-direction: column;
        gap: 10px;
    }
    
    .practice-filter-group {
        min-width: auto;
        width: 100%;
    }
    
    .practice-filter-select,
    .practice-filter-input {
        width: 100%;
        padding: 10px 12px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }
    
    .practice-filter-select:focus,
    .practice-filter-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}

/* 🔥 新增：快速筛选标签样式 */
.quick-filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.quick-filter-tag {
    padding: 4px 10px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 15px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
}

.quick-filter-tag:hover {
    background: #e9ecef;
}

.quick-filter-tag.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

@media (max-width: 768px) {
    .quick-filter-tags {
        justify-content: center;
        margin-top: 8px;
    }
    
    .quick-filter-tag {
        padding: 6px 12px;
        font-size: 0.75rem;
    }
}

</style>
</head>

<body>
<div class="container">
    <!-- 语言切换器 -->
    <div class="language-switcher">
        <button class="lang-btn active" onclick="switchLanguage('zh')" data-lang="zh">中文</button>
        <button class="lang-btn" onclick="switchLanguage('en')" data-lang="en">EN</button>
    </div>

    <!-- 连接状态指示器 -->
    <div id="connectionStatus" class="connection-status offline">
        <span data-i18n="status.offline">🔴 离线模式</span>
    </div>

    <!-- 头部 -->
    <div class="header">
        <h1><span data-i18n="header.title">🎼 青岛耶胡迪梅纽因学校</span></h1>
        <div class="subtitle" data-i18n="header.subtitle">实时练琴跟踪系统</div>
    </div>

    <!-- 导航标签 -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')">
            <span data-i18n="nav.dashboard">📊 考勤概览</span>
        </button>
        <button class="nav-tab" onclick="switchTab('students')">
            <span data-i18n="nav.students">👥 学生详情</span>
        </button>
        <button class="nav-tab" onclick="switchTab('reports')">
            <span data-i18n="nav.reports">📈 历史报告</span>
        </button>
        <button class="nav-tab" onclick="switchTab('sync')">
            <span data-i18n="nav.sync">🔄 数据同步</span>
        </button>
    </div>

    <!-- 考勤概览标签页 -->
    <div id="dashboardTab" class="tab-content">
        <!-- 统计面板 -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label" data-i18n="stats.total">总学生数</div>
                <div class="stat-description" data-i18n="stats.total.desc">已登记学生</div>
            </div>
            <div class="stat-card present">
                <div class="stat-number" id="presentCount">0</div>
                <div class="stat-label" data-i18n="stats.present">正常出勤</div>
                <div class="stat-description" data-i18n="stats.present.desc">今日出勤率</div>
            </div>
            <div class="stat-card absent">
                <div class="stat-number" id="absentCount">0</div>
                <div class="stat-label" data-i18n="stats.absent">缺勤学生</div>
                <div class="stat-description" data-i18n="stats.absent.desc">需要关注</div>
            </div>
            <div class="stat-card excused">
                <div class="stat-number" id="excusedCount">0</div>
                <div class="stat-label" data-i18n="stats.excused">请假学生</div>
                <div class="stat-description" data-i18n="stats.excused.desc">已批准请假</div>
            </div>
        </div>

        <!-- 请假信息面板 -->
        <div class="card" id="excuseInfoPanel" style="display: none;">
            <h3 data-i18n="excuse.title">📝 今日请假信息</h3>
            <div id="excuseInfoContainer">
                <!-- 请假信息将在这里显示 -->
            </div>
        </div>

        <!-- 实时练琴状态 -->
        <div class="card">
            <h3 data-i18n="practice.title">🎹 实时练琴状态</h3>
            <div class="date-picker">
                <span style="color: #666; font-size: 14px;">
                    <span data-i18n="practice.current_time">当前时间：</span>
                    <span id="currentTime"></span>
                </span>
                <button class="btn btn-primary" onclick="refreshPracticeStatus()">
                    <span>🔄</span> <span data-i18n="btn.refresh_status">刷新状态</span>
                </button>
            </div>

            <!-- 🔥 新增：实时练琴筛选器 -->
            <div class="practice-filters">
                <div class="practice-filter-row">
                    <div class="practice-filter-group">
                        <label class="practice-filter-label" data-i18n="filter.major">专业筛选</label>
                        <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
                            <option value="" data-i18n="filter.all_majors">所有专业</option>
                        </select>
                    </div>
                    <div class="practice-filter-group">
                        <label class="practice-filter-label" data-i18n="filter.grade">年级筛选</label>
                        <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
                            <option value="" data-i18n="filter.all_grades">所有年级</option>
                        </select>
                    </div>
                    <div class="practice-filter-group">
                        <label class="practice-filter-label" data-i18n="filter.search">搜索学生</label>
                        <input type="text" id="practiceStudentSearch" class="practice-filter-input" 
                               data-i18n-placeholder="filter.search_placeholder" placeholder="输入学生姓名..." 
                               oninput="filterPracticeStatus()">
                    </div>
                </div>
                
                <!-- 🔥 新增：快速筛选标签 -->
                <div class="quick-filter-tags" id="practiceQuickFilters">
                    <!-- 快速筛选标签将在这里动态生成 -->
                </div>
            </div>

            <div id="practiceStatusContainer">
                <div id="practiceStudentList" class="student-grid">
                    <!-- 正在练琴的学生卡片将在这里显示 -->
                </div>
            </div>
        </div>

        <!-- 今日考勤快照 -->
        <div class="card">
            <h3 data-i18n="attendance.title">📅 今日考勤快照</h3>
            <div class="date-picker">
                <label for="dateSelect" data-i18n="attendance.select_date">选择日期：</label>
                <input type="date" id="dateSelect" class="date-input" onchange="loadAttendanceData()">
                <button class="btn btn-primary" onclick="refreshData()">
                    <span>🔄</span> <span data-i18n="btn.refresh_data">刷新数据</span>
                </button>
            </div>
            <div id="todaySnapshot" class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- 学生详情标签页 -->
    <div id="studentsTab" class="tab-content" style="display: none;">
        <!-- 筛选器 -->
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.major">专业筛选</label>
                    <select id="majorFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_majors">所有专业</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.grade">年级筛选</label>
                    <select id="gradeFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_grades">所有年级</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.status">考勤状态</label>
                    <select id="statusFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_status">所有状态</option>
                        <option value="present" data-i18n="status.present">正常出勤</option>
                        <option value="absent" data-i18n="status.absent">缺勤</option>
                        <option value="excused" data-i18n="status.excused">请假</option>
                        <option value="low-efficiency" data-i18n="status.low_efficiency">低效出勤</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.search">搜索学生</label>
                    <input type="text" id="studentSearch" class="filter-input" data-i18n-placeholder="filter.search_placeholder" placeholder="输入学生姓名..." oninput="filterStudents()">
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="refreshData()">
                <span>🔄</span> <span data-i18n="btn.refresh_data">刷新数据</span>
            </button>
        </div>

        <!-- 学生列表 -->
        <div id="studentList" class="student-grid">
            <!-- 学生卡片将在这里动态生成 -->
        </div>
    </div>

    <!-- 历史报告标签页 -->
    <div id="reportsTab" class="tab-content" style="display: none;">
        <div class="card">
            <h3 data-i18n="report.title">📈 考勤历史分析</h3>
            
            <!-- 日期范围选择 -->
            <div class="date-picker">
                <label for="startDate" data-i18n="report.start_date">开始日期：</label>
                <input type="date" id="startDate" class="date-input">
                <label for="endDate" data-i18n="report.end_date">结束日期：</label>
                <input type="date" id="endDate" class="date-input">
                <button class="btn btn-primary" onclick="generateReport()">
                    <span>📊</span> <span data-i18n="btn.generate_report">生成报告</span>
                </button>
            </div>

            <!-- 报告内容 -->
            <div id="reportContent">
                <div class="empty-state">
                    <div class="empty-state-icon">📊</div>
                    <div class="empty-state-title" data-i18n="report.empty.title">选择日期范围生成报告</div>
                    <div class="empty-state-description" data-i18n="report.empty.desc">选择开始和结束日期，然后点击"生成报告"按钮查看详细的考勤分析</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据同步标签页 -->
    <div id="syncTab" class="tab-content" style="display: none;">
        <div class="card">
            <h3 data-i18n="sync.title">🔄 数据同步管理</h3>
            
            <!-- 同步状态 -->
            <div class="card success" id="syncStatus">
                <h4 data-i18n="sync.status">同步状态</h4>
                <p id="syncStatusText" data-i18n="sync.checking">正在检查连接状态...</p>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="forceSyncData()">
                        <span>🔄</span> <span data-i18n="btn.force_sync">强制同步</span>
                    </button>
                    <button class="btn btn-warning" onclick="clearLocalCache()">
                        <span>🗑️</span> <span data-i18n="btn.clear_cache">清除缓存</span>
                    </button>
                </div>
            </div>

            <!-- 同步日志 -->
            <div class="card">
                <h4 data-i18n="sync.logs">📋 同步日志</h4>
                <div id="syncLogs" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 14px;">
                    <!-- 同步日志将在这里显示 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 学生详情模态框 -->
<div id="studentDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="studentDetailTitle" data-i18n="student.detail.title">学生详情</h3>
            <button class="modal-close" onclick="closeModal('studentDetailModal')">&times;</button>
        </div>
        <div id="studentDetailContent">
            <!-- 学生详细信息将在这里显示 -->
        </div>
    </div>
</div>

<script>
// 🌐 国际化配置
const i18n = {
    zh: {
        // 头部
        'header.title': '🎼 青岛耶胡迪梅纽因学校',
        'header.subtitle': '实时练琴跟踪系统',
        
        // 导航
        'nav.dashboard': '📊 考勤概览',
        'nav.students': '👥 学生详情',
        'nav.reports': '📈 历史报告',
        'nav.sync': '🔄 数据同步',
        
        // 状态
        'status.online': '已连接',
        'status.offline': '离线模式',
        'status.syncing': '同步中',
        'status.present': '正常出勤',
        'status.absent': '缺勤',
        'status.excused': '请假',
        'status.low_efficiency': '低效出勤',
        'status.practicing_unscheduled': '时间段外练琴',
        'status.weekend': '周末',
        'status.no_data': '无数据',
        
        // 统计
        'stats.total': '总学生数',
        'stats.total.desc': '已登记学生',
        'stats.present': '正常出勤',
        'stats.present.desc': '今日出勤率',
        'stats.absent': '缺勤学生',
        'stats.absent.desc': '需要关注',
        'stats.excused': '请假学生',
        'stats.excused.desc': '已批准请假',
        'stats.practicing': '正在练琴',
        'stats.not_practicing': '未在练琴',
        
        // 按钮
        'btn.refresh_status': '刷新状态',
        'btn.refresh_data': '刷新数据',
        'btn.generate_report': '生成报告',
        'btn.force_sync': '强制同步',
        'btn.clear_cache': '清除缓存',
        'btn.close': '关闭',
        
        // 筛选器
        'filter.major': '专业筛选',
        'filter.grade': '年级筛选',
        'filter.status': '考勤状态',
        'filter.search': '搜索学生',
        'filter.all_majors': '所有专业',
        'filter.all_grades': '所有年级',
        'filter.all_status': '所有状态',
        'filter.search_placeholder': '输入学生姓名...',
        
        // 练琴状态
        'practice.title': '🎹 实时练琴状态',
        'practice.current_time': '当前时间：',
        'practice.empty.title': '当前没有学生在练琴',
        'practice.empty.desc.weekday': '工作日时间，等待学生开始练琴',
        'practice.empty.desc.weekend': '周末时间，学生可自主安排练琴',
        'practice.duration': '练琴时长',
        'practice.room': '所在琴房',
        'practice.start_time': '开始时间',
        'practice.type.weekend': '周末自主练琴',
        'practice.type.unscheduled': '时间段外练琴',
        
        // 考勤
        'attendance.title': '📅 今日考勤快照',
        'attendance.select_date': '选择日期：',
        'attendance.history': '最近7天考勤',
        'attendance.rate': '出勤率',
        
        // 学生信息
        'student.name': '姓名',
        'student.major': '专业',
        'student.grade': '年级',
        'student.time_slot': '时间段',
        'student.practice_duration': '练琴时长',
        'student.room': '所在琴房',
        'student.not_in_room': '不在琴房',
        'student.detail.title': '学生详情',
        'student.basic_info': '基本信息',
        'student.today_attendance': '今日考勤',
        'student.attendance_stats': '考勤统计',
        'student.history_records': '历史记录',
        'student.no_schedule': '无',
        'student.self_practice': '自主练琴',
        'student.unknown_major': '未知专业',
        'student.not_set': '未设置',
        
        // 请假
        'excuse.title': '📝 今日请假信息',
        'excuse.reason': '请假原因',
        'excuse.time': '请假时间',
        'excuse.approver': '批准人',
        'excuse.submit_time': '提交时间',
        'excuse.status.approved': '已批准',
        'excuse.status.pending': '待审核',
        'excuse.status.rejected': '已拒绝',
        'excuse.not_filled': '未填写',
        
        // 报告
        'report.title': '📈 考勤历史分析',
        'report.start_date': '开始日期：',
        'report.end_date': '结束日期：',
        'report.empty.title': '选择日期范围生成报告',
        'report.empty.desc': '选择开始和结束日期，然后点击"生成报告"按钮查看详细的考勤分析',
        'report.analysis_title': '📊 考勤分析报告',
        'report.period': '统计周期：',
        'report.participants': '参与学生：',
        'report.daily_trend': '📈 每日考勤趋势',
        'report.student_stats': '👥 学生考勤统计',
        'report.date': '日期',
        'report.total': '总人数',
        'report.days': '天',
        'report.people': '人',
        'report.regenerate': '重新生成',
        
        // 同步
        'sync.title': '🔄 数据同步管理',
        'sync.status': '同步状态',
        'sync.checking': '正在检查连接状态...',
        'sync.connected': '✅ 已连接到Firebase数据库',
        'sync.disconnected': '❌ 未连接到数据库',
        'sync.realtime': '数据正在实时同步中...',
        'sync.offline_mode': '当前处于离线模式，部分功能受限',
        'sync.last_sync': '最后同步时间: ',
        'sync.check_network': '请检查网络连接',
        'sync.logs': '📋 同步日志',
        'sync.offline': '离线模式',
        'sync.realtime_sync': '实时同步',
        
        // 消息
        'msg.no_data': '暂无数据',
        'msg.loading': '加载中...',
        'msg.network_required': '需要网络连接才能查看学生详情',
        'msg.sync_required': '需要网络连接才能同步数据',
        'msg.clear_cache_confirm': '确定要清除本地缓存吗？这将删除所有离线数据。',
        'msg.cache_cleared': '本地缓存已清除',
        'msg.date_range_error': '开始日期不能晚于结束日期',
        'msg.select_dates': '请选择开始和结束日期',
        'msg.student_not_found': '未找到学生信息',
        
        // 时间
        'time.minutes': '分钟',
        'time.hours': '小时',
        'time.seconds': '秒',
        'time.no_practice': '0分钟',
        
        // 空状态
        'empty.no_students': '暂无学生数据',
        'empty.ensure_sync': '请确保学生数据已正确同步',
        'empty.no_attendance': '还没有考勤记录',
        'empty.offline_no_data': '离线模式下没有找到该日期的考勤数据',
        'empty.load_failed': '加载失败',
        'empty.network_error': '无法加载考勤数据，请检查网络连接',

        // 筛选
        'filter.clear': '清除',
        'filter.no_results': '没有符合条件的学生',
        'filter.try_different': '请尝试调整筛选条件',
        'practice.scheduled': '规定时段',
        'practice.unscheduled': '时段外',
        'practice.total': '总时长',
        'report.last_30_days': '最近30天',
        'report.to': '至',
    },
    
    en: {
        // Header
        'header.title': '🎼 Qingdao Yehudi Menuhin School',
        'header.subtitle': 'Real-time Practice Tracking System',
        
        // Navigation
        'nav.dashboard': '📊 Dashboard',
        'nav.students': '👥 Students',
        'nav.reports': '📈 Reports',
        'nav.sync': '🔄 Sync',
        
        // Status
        'status.online': 'Online',
        'status.offline': 'Offline',
        'status.syncing': 'Syncing',

        'status.present': 'Present',
        'status.absent': 'Absent',
        'status.excused': 'Excused',
        'status.low_efficiency': 'Low Efficiency',
        'status.practicing_unscheduled': 'Unscheduled Practice',
        'status.weekend': 'Weekend',
        'status.no_data': 'No Data',
        
        // Statistics
        'stats.total': 'Total Students',
        'stats.total.desc': 'Registered Students',
        'stats.present': 'Present',
        'stats.present.desc': 'Today\'s Attendance',
        'stats.absent': 'Absent',
        'stats.absent.desc': 'Need Attention',
        'stats.excused': 'Excused',
        'stats.excused.desc': 'Approved Leave',
        'stats.practicing': 'Practicing',
        'stats.not_practicing': 'Not Practicing',
        
        // Buttons
        'btn.refresh_status': 'Refresh Status',
        'btn.refresh_data': 'Refresh Data',
        'btn.generate_report': 'Generate Report',
        'btn.force_sync': 'Force Sync',
        'btn.clear_cache': 'Clear Cache',
        'btn.close': 'Close',
        
        // Filters
        'filter.major': 'Major Filter',
        'filter.grade': 'Grade Filter',
        'filter.status': 'Status Filter',
        'filter.search': 'Search Student',
        'filter.all_majors': 'All Majors',
        'filter.all_grades': 'All Grades',
        'filter.all_status': 'All Status',
        'filter.search_placeholder': 'Enter student name...',
        
        // Practice Status
        'practice.title': '🎹 Real-time Practice Status',
        'practice.current_time': 'Current Time: ',
        'practice.empty.title': 'No students practicing currently',
        'practice.empty.desc.weekday': 'Weekday time, waiting for students to start practicing',
        'practice.empty.desc.weekend': 'Weekend time, students can arrange practice freely',
        'practice.duration': 'Practice Duration',
        'practice.room': 'Practice Room',
        'practice.start_time': 'Start Time',
        'practice.type.weekend': 'Weekend Self Practice',
        'practice.type.unscheduled': 'Unscheduled Practice',
        
        // Attendance
        'attendance.title': '📅 Today\'s Attendance Snapshot',
        'attendance.select_date': 'Select Date: ',
        'attendance.history': 'Last 7 Days Attendance',
        'attendance.rate': 'Attendance Rate',
        
        // Student Information
        'student.name': 'Name',
        'student.major': 'Major',
        'student.grade': 'Grade',
        'student.time_slot': 'Time Slot',
        'student.practice_duration': 'Practice Duration',
        'student.room': 'Practice Room',
        'student.not_in_room': 'Not in Room',
        'student.detail.title': 'Student Details',
        'student.basic_info': 'Basic Information',
        'student.today_attendance': 'Today\'s Attendance',
        'student.attendance_stats': 'Attendance Statistics',
        'student.history_records': 'History Records',
        'student.no_schedule': 'None',
        'student.self_practice': 'Self Practice',
        'student.unknown_major': 'Unknown Major',
        'student.not_set': 'Not Set',
        
        // Leave/Excuse
        'excuse.title': '📝 Today\'s Leave Information',
        'excuse.reason': 'Leave Reason',
        'excuse.time': 'Leave Time',
        'excuse.approver': 'Approver',
        'excuse.submit_time': 'Submit Time',
        'excuse.status.approved': 'Approved',
        'excuse.status.pending': 'Pending',
        'excuse.status.rejected': 'Rejected',
        'excuse.not_filled': 'Not Filled',
        
        // Reports
        'report.title': '📈 Attendance History Analysis',
        'report.start_date': 'Start Date: ',
        'report.end_date': 'End Date: ',
        'report.empty.title': 'Select date range to generate report',
        'report.empty.desc': 'Select start and end dates, then click "Generate Report" to view detailed attendance analysis',
        'report.analysis_title': '📊 Attendance Analysis Report',
        'report.period': 'Period: ',
        'report.participants': 'Participants: ',
        'report.daily_trend': '📈 Daily Attendance Trend',
        'report.student_stats': '👥 Student Attendance Statistics',
        'report.date': 'Date',
        'report.total': 'Total',
        'report.days': ' days',
        'report.people': ' people',
        'report.regenerate': 'Regenerate',
        
        // Sync
        'sync.title': '🔄 Data Sync Management',
        'sync.status': 'Sync Status',
        'sync.checking': 'Checking connection status...',
        'sync.connected': '✅ Connected to Firebase database',
        'sync.disconnected': '❌ Not connected to database',
        'sync.realtime': 'Data is syncing in real-time...',
        'sync.offline_mode': 'Currently in offline mode, some features are limited',
        'sync.last_sync': 'Last sync time: ',
        'sync.check_network': 'Please check network connection',
        'sync.logs': '📋 Sync Logs',
        'sync.offline': 'Offline Mode',
        'sync.realtime_sync': 'Real-time Sync',
        
        // Messages
        'msg.no_data': 'No Data',
        'msg.loading': 'Loading...',
        'msg.network_required': 'Network connection required to view student details',
        'msg.sync_required': 'Network connection required to sync data',
        'msg.clear_cache_confirm': 'Are you sure you want to clear local cache? This will delete all offline data.',
        'msg.cache_cleared': 'Local cache cleared',
        'msg.date_range_error': 'Start date cannot be later than end date',
        'msg.select_dates': 'Please select start and end dates',
        'msg.student_not_found': 'Student information not found',
        
        // Time
        'time.minutes': ' minutes',
        'time.hours': ' hours',
        'time.seconds': ' seconds',
        'time.no_practice': '0 minutes',
        
        // Empty States
        'empty.no_students': 'No student data',
        'empty.ensure_sync': 'Please ensure student data is properly synced',
        'empty.no_attendance': 'No attendance records yet',
        'empty.offline_no_data': 'No attendance data found for this date in offline mode',
        'empty.load_failed': 'Load Failed',
        'empty.network_error': 'Unable to load attendance data, please check network connection',
        //shaixuan
        'filter.clear': 'Clear',
        'filter.no_results': 'No matching students',
        'filter.try_different': 'Please try different filter criteria',
        'practice.scheduled': 'Scheduled',
        'practice.unscheduled': 'Unscheduled', 
        'practice.total': 'Total',
        'report.last_30_days': 'Last 30 Days',
        'report.to': 'to'
    }
};

// 当前语言
let currentLanguage = 'zh';

// 语言切换函数
function switchLanguage(lang) {
    if (lang === currentLanguage) return;
    
    currentLanguage = lang;
    
    // 更新按钮状态
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-lang') === lang) {
            btn.classList.add('active');
        }
    });
    
    // 更新页面文本
    updatePageLanguage();
    
    // 保存语言偏好
    localStorage.setItem('preferred_language', lang);
    
    // 重新渲染当前页面内容
    refreshCurrentTabContent();
    
    addSyncLog(`🌐 语言已切换为 ${lang === 'zh' ? '中文' : 'English'}`);
}

// 更新页面语言
function updatePageLanguage() {
    const texts = i18n[currentLanguage];
    
    // 更新所有带有 data-i18n 属性的元素
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (texts[key]) {
            element.textContent = texts[key];
        }
    });
    
    // 更新 placeholder 文本
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (texts[key]) {
            element.placeholder = texts[key];
        }
    });
    
    // 更新页面标题
    document.title = currentLanguage === 'zh' ? 
        '青岛梅纽因音乐学校练琴跟踪系统' : 
        'Qingdao Menuhin Music School Practice Tracking System';
}

// 获取翻译文本
function t(key, fallback = '') {
    const texts = i18n[currentLanguage];
    return texts[key] || fallback || key;
}

// 刷新当前标签页内容
function refreshCurrentTabContent() {
    switch(currentTab) {
        case 'dashboard':
            if (attendanceData && Object.keys(attendanceData).length > 0) {
                updateDashboard();
                displayPracticeStatus();
            }
            break;
        case 'students':
            if (Object.keys(studentData).length > 0) {
                loadStudentList();
                updateStatusFilterOptions();
            }
            break;
        case 'reports':
            // 报告页面不需要特殊刷新
            break;
        case 'sync':
            updateSyncStatus();
            break;
    }
}

// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyBfRjrAKsVUAHBl5WbBl96YONrkRe1UWUo",
  authDomain: "menuhin-studio-system.firebaseapp.com",
  databaseURL: "https://menuhin-studio-system-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "menuhin-studio-system",
  storageBucket: "menuhin-studio-system.firebasestorage.app",
  messagingSenderId: "218592951152",
  appId: "1:218592951152:web:650d080726b6c44f5a2db5",
  measurementId: "G-P49SZQTLT7"
};


// 全局变量
let database = null;
let isOnline = false;
let currentTab = 'dashboard';
let attendanceData = {
    realTimePractice: {}
};
let studentData = {};
let excuseData = {};
let syncLogs = [];
let rooms = [];

let syncTimers = new Set();
let isInitialized = false;
let debugMode = true;
// 🔥 新增：实时练琴状态相关变量（变化驱动版）
let realTimePracticeStatus = {}; // 存储每个学生的实时状态
let lastRealTimePracticeHash = ''; // 用于检测变化的哈希值
let practiceStatusUpdateTimeout = null; // 防抖定时器

// 调试日志函数
function debugLog(message, data = null) {
    if (debugMode) {
        console.log(`[DEBUG] ${message}`, data || '');
        addSyncLog(`🔍 ${message}${data ? ': ' + JSON.stringify(data) : ''}`);
    }
}

// 初始化 Firebase
function initFirebase() {
    if (isInitialized) {
        console.log('Firebase已经初始化，跳过重复初始化');
        return;
    }
    
    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        isInitialized = true;
        
        // 监听连接状态
        database.ref('.info/connected').on('value', (snapshot) => {
            const wasOnline = isOnline;
            isOnline = snapshot.val() === true;
            updateConnectionStatus();
            
            if (isOnline && !wasOnline) {
                addSyncLog('✅ ' + t('sync.connected', '已连接到Firebase数据库'));
                setTimeout(() => {
                    loadInitialData();
                }, 1000);
            } else if (!isOnline && wasOnline) {
                addSyncLog('❌ ' + t('sync.disconnected', '与Firebase数据库断开连接'));
            }
        });
        
        // 监听考勤数据变化
        database.ref('attendanceData').on('value', (snapshot) => {
            try {
                if (snapshot.exists()) {
                    const newData = snapshot.val();
                    if (newData && typeof newData === 'object') {
                        attendanceData = { ...attendanceData, ...newData };
                        addSyncLog('📥 ' + t('sync.attendance_updated', '考勤数据已更新'));
                        updateDashboard();
                        if (currentTab === 'students') {
                            loadStudentList();
                        }
                    }
                }
            } catch (error) {
                console.error('处理考勤数据更新失败:', error);
                addSyncLog('❌ ' + t('sync.attendance_failed', '考勤数据更新失败') + ': ' + error.message);
            }
        }, (error) => {
            console.error('监听考勤数据失败:', error);
            addSyncLog('❌ ' + t('sync.listen_failed', '监听考勤数据失败') + ': ' + error.message);
        });

        // 监听实时练琴状态变化
        let practiceUpdateTimeout;
        database.ref('realTimePracticeStatus').on('value', (snapshot) => {
            try {
                clearTimeout(practiceUpdateTimeout);
                practiceUpdateTimeout = setTimeout(() => {
                    if (snapshot.exists()) {
                        handleRemoteRealTimePracticeUpdate(snapshot.val());
                    } else {
                        handleRemoteRealTimePracticeUpdate({});
                    }
                }, 500);
            } catch (error) {
                console.error('处理实时练琴状态更新失败:', error);
                addSyncLog('❌ ' + t('sync.practice_failed', '实时练琴状态更新失败') + ': ' + error.message);
            }
        }, (error) => {
            console.error('监听实时练琴状态失败:', error);
            addSyncLog('❌ ' + t('sync.practice_listen_failed', '监听实时练琴状态失败') + ': ' + error.message);
        });
        
        // 监听琴房状态变化
        let roomsUpdateTimeout;
        database.ref('rooms').on('value', (snapshot) => {
            try {
                clearTimeout(roomsUpdateTimeout);
                roomsUpdateTimeout = setTimeout(() => {
                    if (snapshot.exists()) {
                        handleRoomsUpdate(snapshot.val());
                    } else {
                        handleRoomsUpdate([]);
                    }
                }, 500);
            } catch (error) {
                console.error('处理琴房状态更新失败:', error);
                addSyncLog('❌ ' + t('sync.rooms_failed', '琴房状态更新失败') + ': ' + error.message);
            }
        }, (error) => {
            console.error('监听琴房状态失败:', error);
            addSyncLog('❌ ' + t('sync.rooms_listen_failed', '监听琴房状态失败') + ': ' + error.message);
        });
        
        // 监听学生数据变化（包含本地存储）
        database.ref('studentDatabase').on('value', (snapshot) => {
            try {
                if (snapshot.exists()) {
                    const newStudentData = snapshot.val();
                    if (newStudentData && typeof newStudentData === 'object') {
                        studentData = newStudentData;
                        
                        // 保存到本地存储
                        try {
                            localStorage.setItem('studentData', JSON.stringify(newStudentData));
                        } catch (e) {
                            console.warn('保存学生数据到本地存储失败:', e);
                        }
                        
                        addSyncLog('📥 ' + t('sync.student_updated', '学生数据已更新'));
                        updateFilters();
                        if (currentTab === 'students') {
                            loadStudentList();
                        }
                    }
                }
            } catch (error) {
                console.error('处理学生数据更新失败:', error);
                addSyncLog('❌ ' + t('sync.student_failed', '学生数据更新失败') + ': ' + error.message);
            }
        }, (error) => {
            console.error('监听学生数据失败:', error);
            addSyncLog('❌ ' + t('sync.student_listen_failed', '监听学生数据失败') + ': ' + error.message);
        });

        // 监听请假数据变化（包含本地存储）
        database.ref('excuseData').on('value', (snapshot) => {
            try {
                if (snapshot.exists()) {
                    const newExcuseData = snapshot.val();
                    if (newExcuseData && typeof newExcuseData === 'object') {
                        excuseData = newExcuseData;
                        
                        // 保存到本地存储
                        try {
                            localStorage.setItem('excuseData', JSON.stringify(newExcuseData));
                        } catch (e) {
                            console.warn('保存请假数据到本地存储失败:', e);
                        }
                        
                        addSyncLog('📥 ' + t('sync.excuse_updated', '请假数据已更新'));
                        if (currentTab === 'dashboard') {
                            updateDashboard();
                        } else if (currentTab === 'students') {
                            loadStudentList();
                        }
                    }
                }
            } catch (error) {
                console.error('处理请假数据更新失败:', error);
                addSyncLog('❌ ' + t('sync.excuse_failed', '请假数据更新失败') + ': ' + error.message);
            }
        }, (error) => {
            console.error('监听请假数据失败:', error);
            addSyncLog('❌ ' + t('sync.excuse_listen_failed', '监听请假数据失败') + ': ' + error.message);
        });
        
    } catch (error) {
        console.error('Firebase初始化失败:', error);
        addSyncLog('❌ Firebase初始化失败: ' + error.message);
        isInitialized = false;
    }
}

function handleRoomsUpdate(roomsData) {
    debugLog('收到琴房状态更新', roomsData ? roomsData.length + '间琴房' : '空数据');
    
    if (!roomsData || !Array.isArray(roomsData) || roomsData.length === 0) {
        debugLog('琴房数据为空，强制清理所有练琴状态');
        
        // 🔥 关键修复：当琴房数据为空时，强制清空所有练琴状态
        if (attendanceData.realTimePractice && Object.keys(attendanceData.realTimePractice).length > 0) {
            const clearedStudents = Object.keys(attendanceData.realTimePractice);
            attendanceData.realTimePractice = {};
            
            // 🔥 移除：不再操作本地存储
            displayPracticeStatus();
            
            addSyncLog(`🧹 琴房系统已清空，强制清理 ${clearedStudents.length} 个练琴状态`);
            console.log('🧹 已清理所有练琴状态:', clearedStudents);
        }
        
        rooms = [];
        return;
    }

    console.log('🏠 收到琴房状态更新:', roomsData.length, '间琴房');
    rooms = roomsData;
    
    // 🔥 关键修复：构建当前活跃的练琴学生列表
    const currentActivePractice = {};
    const now = Date.now();
    
    roomsData.forEach(room => {
        if (room.student && room.student !== '空闲' && room.registerTime) {
            const studentName = room.student;
            const registerTime = new Date(room.registerTime).getTime();
            
            // 验证时间有效性
            if (registerTime > 0 && registerTime <= now && (now - registerTime) < 12 * 60 * 60 * 1000) {
                const currentDuration = Math.floor((now - registerTime) / 1000);
                
                currentActivePractice[studentName] = {
                    room: room.name,
                    startTime: room.registerTime,
                    currentDuration: currentDuration,
                    status: 'practicing',
                    lastUpdated: now,
                    syncSource: 'rooms'
                };
            }
        }
    });
    
    if (!attendanceData.realTimePractice) {
        attendanceData.realTimePractice = {};
    }
    
    let hasChanges = false;
    const currentStudents = Object.keys(attendanceData.realTimePractice);
    const activeStudents = Object.keys(currentActivePractice);
    
    // 🔥 关键修复：清理不在活跃列表中的学生
    currentStudents.forEach(studentName => {
        const currentRecord = attendanceData.realTimePractice[studentName];
        
        // 如果学生不在当前活跃列表中，且是来自琴房系统的数据，则清理
        if (!activeStudents.includes(studentName) && 
            (currentRecord.syncSource === 'rooms' || currentRecord.room)) {
            console.log(`🧹 学生已离开琴房，清理状态: ${studentName}`);
            delete attendanceData.realTimePractice[studentName];
            hasChanges = true;
        }
    });
    
    // 更新或添加活跃学生的状态
    activeStudents.forEach(studentName => {
        const newRecord = currentActivePractice[studentName];
        const currentRecord = attendanceData.realTimePractice[studentName];
        
        if (!currentRecord || 
            currentRecord.room !== newRecord.room ||
            Math.abs((currentRecord.currentDuration || 0) - newRecord.currentDuration) > 30) {
            
            attendanceData.realTimePractice[studentName] = newRecord;
            hasChanges = true;
            console.log(`🔄 更新琴房练琴状态: ${studentName} in ${newRecord.room}`);
        }
    });
    
    if (hasChanges) {
        // 🔥 移除：不再保存到本地存储
        
        if (currentTab === 'dashboard') {
            displayPracticeStatus();
        }
        
        const activeCount = Object.keys(currentActivePractice).length;
        addSyncLog(`🏠 琴房状态已同步 (${activeCount}名学生在练琴)`);
        
        if (activeCount === 0) {
            addSyncLog('✅ 所有琴房已清空，无学生在练琴');
        }
        
        // 琴房状态变化时触发实时状态同步
        if (isOnline) {
            triggerRealTimePracticeStatusUpdate();
        }
    }
}

/* =============== 实时练琴状态同步系统（变化驱动版） =============== */

/**
 * 计算学生的实时练琴状态
 */
function calculateRealTimePracticeStatus(studentName) {
    const practiceData = attendanceData.realTimePractice || {};
    const studentPractice = practiceData[studentName];
    
    if (!studentPractice || !studentPractice.startTime) {
        return null;
    }
    
    const now = Date.now();
    const startTime = new Date(studentPractice.startTime).getTime();
    
    // 验证时间有效性
    if (isNaN(startTime) || startTime > now || (now - startTime) > 12 * 60 * 60 * 1000) {
        return null;
    }
    
    const currentDuration = Math.floor((now - startTime) / 1000);
    
    return {
        currentDuration,
        lastUpdated: now,
        room: studentPractice.room || '未知琴房',
        startTime: studentPractice.startTime,
        status: 'practicing'
    };
}

/**
 * 生成实时状态的哈希值，用于检测变化
 */
function generateRealTimePracticeHash(statusData) {
    // 只包含关键状态信息，排除时间戳
    const keyData = {};
    Object.keys(statusData).forEach(studentName => {
        const status = statusData[studentName];
        if (status) {
            keyData[studentName] = {
                room: status.room,
                status: status.status,
                // 将时长按10秒取整，减少微小变化
                durationRounded: Math.floor((status.currentDuration || 0) / 10) * 10
            };
        }
    });
    return JSON.stringify(keyData);
}

/**
 * 检查并更新实时练琴状态（仅在有变化时同步）
 */
function checkAndUpdateRealTimePracticeStatus(forceUpdate = false) {
    const newStatus = {};
    
    // 遍历所有正在练琴的学生
    if (attendanceData.realTimePractice) {
        Object.keys(attendanceData.realTimePractice).forEach(studentName => {
            const status = calculateRealTimePracticeStatus(studentName);
            if (status) {
                newStatus[studentName] = status;
            }
        });
    }
    
    // 生成新的哈希值
    const newHash = generateRealTimePracticeHash(newStatus);
    
    // 检查是否有实质性变化
    const hasSignificantChange = newHash !== lastRealTimePracticeHash || forceUpdate;
    
    if (hasSignificantChange) {
        debugLog('检测到实时练琴状态变化，准备同步', Object.keys(newStatus));
        
        // 更新状态和哈希值
        realTimePracticeStatus = newStatus;
        lastRealTimePracticeHash = newHash;
        
        // 防抖同步：短时间内多次变化只同步最后一次
        if (practiceStatusUpdateTimeout) {
            clearTimeout(practiceStatusUpdateTimeout);
        }
        
        practiceStatusUpdateTimeout = setTimeout(() => {
            syncRealTimePracticeStatusToFirebase();
            practiceStatusUpdateTimeout = null;
        }, 1000); // 1秒防抖
        
        // 🔥 移除：不再保存到本地存储
        
        return true; // 有变化
    }
    
    return false; // 无变化
}


/**
 * 同步实时练琴状态到 Firebase
 */
function syncRealTimePracticeStatusToFirebase() {
    if (!database || !isOnline) {
        debugLog('跳过实时状态同步', { database: !!database, isOnline });
        return;
    }
    
    // 清理数据，确保兼容 Firebase
    const cleanData = cleanDataForFirebase(realTimePracticeStatus);
    
    debugLog('同步实时练琴状态到云端，学生数量', Object.keys(cleanData).length);
    
    database.ref('realTimePracticeStatus').set(cleanData)
        .then(() => {
            addSyncLog('✅ 实时练琴状态同步成功');
            debugLog('实时练琴状态同步成功');
        })
        .catch(error => {
            console.error('实时练琴状态同步失败:', error);
            addSyncLog('❌ 实时练琴状态同步失败: ' + error.message);
        });
}

/**
 * 清理Firebase数据，确保兼容性
 */
function cleanDataForFirebase(data) {
    if (!data || typeof data !== 'object') return {};
    
    const cleaned = {};
    Object.keys(data).forEach(key => {
        if (key && data[key] && typeof data[key] === 'object') {
            cleaned[key] = { ...data[key] };
            
            // 确保所有时间戳都是有效的数字
            if (cleaned[key].lastUpdated) {
                cleaned[key].lastUpdated = Number(cleaned[key].lastUpdated) || Date.now();
            }
            if (cleaned[key].startTime) {
                const startTime = new Date(cleaned[key].startTime).getTime();
                cleaned[key].startTime = isNaN(startTime) ? Date.now() : startTime;
            }
            if (cleaned[key].currentDuration) {
                cleaned[key].currentDuration = Number(cleaned[key].currentDuration) || 0;
            }
        }
    });
    
    return cleaned;
}

/**
 * 立即触发实时状态检查和同步（用于关键操作后）
 */
function triggerRealTimePracticeStatusUpdate() {
    // 立即检查并同步，跳过防抖
    if (practiceStatusUpdateTimeout) {
        clearTimeout(practiceStatusUpdateTimeout);
        practiceStatusUpdateTimeout = null;
    }
    
    setTimeout(() => {
        checkAndUpdateRealTimePracticeStatus(true);
    }, 100);
}

/**
 * 定期检查状态变化（用于捕获时间推移导致的状态变化）
 */
function periodicRealTimePracticeStatusCheck() {
    // 只检查，不强制更新
    checkAndUpdateRealTimePracticeStatus(false);
}

/**
 * 清理已结束练琴的学生状态
 */
function cleanupEndedPracticeStatus() {
    if (!attendanceData.realTimePractice) return;
    
    const activeStudents = new Set(Object.keys(attendanceData.realTimePractice));
    let hasChanges = false;
    
    Object.keys(realTimePracticeStatus).forEach(studentName => {
        if (!activeStudents.has(studentName)) {
            delete realTimePracticeStatus[studentName];
            hasChanges = true;
        }
    });
    
    if (hasChanges) {
        debugLog('清理已结束练琴的学生状态');
        lastRealTimePracticeHash = generateRealTimePracticeHash(realTimePracticeStatus);
        // 🔥 移除：不再保存到本地存储
        syncRealTimePracticeStatusToFirebase();
    }
}

/**
 * 获取指定学生的实时练琴状态
 */
function getStudentRealTimePracticeStatus(studentName) {
    return realTimePracticeStatus[studentName] || null;
}

/**
 * 处理远程实时练琴状态更新
 */
function handleRemoteRealTimePracticeUpdate(remoteStatus) {
    try {
        debugLog('收到远程实时练琴状态更新', remoteStatus);
        
        if (!attendanceData) {
            attendanceData = {};
        }
        if (!attendanceData.realTimePractice) {
            attendanceData.realTimePractice = {};
        }
        
        // 🔥 关键修复：如果远程数据为空，强制清空本地状态
        if (!remoteStatus || typeof remoteStatus !== 'object' || Object.keys(remoteStatus).length === 0) {
            debugLog('远程练琴数据为空，强制清空本地状态');
            
            const clearedCount = Object.keys(attendanceData.realTimePractice).length;
            attendanceData.realTimePractice = {};
            
            // 🔥 同时清理同步状态
            realTimePracticeStatus = {};
            lastRealTimePracticeHash = '';
            
            // 🔥 移除：不再操作本地存储
            displayPracticeStatus();
            
            if (clearedCount > 0) {
                addSyncLog(`🧹 远程数据为空，已强制清空 ${clearedCount} 个练琴状态`);
            }
            return;
        }

        const remoteStudentNames = Object.keys(remoteStatus);
        const localStudentNames = Object.keys(attendanceData.realTimePractice);
        
        debugLog('远程练琴学生', remoteStudentNames);
        debugLog('本地练琴学生', localStudentNames);
        
        let hasChanges = false;
        const now = Date.now();
        
        // 🔥 关键修复：强制清理不在远程数据中的学生
        localStudentNames.forEach(studentName => {
            if (!remoteStudentNames.includes(studentName)) {
                debugLog(`强制清理不在远程数据中的学生: ${studentName}`);
                delete attendanceData.realTimePractice[studentName];
                hasChanges = true;
            }
        });

        // 更新远程数据中的学生状态
        remoteStudentNames.forEach(studentName => {
            const remoteRecord = remoteStatus[studentName];
            const currentStatus = attendanceData.realTimePractice[studentName];
            
            if (!remoteRecord || typeof remoteRecord !== 'object') {
                console.warn(`⚠️ 学生 ${studentName} 的远程数据无效:`, remoteRecord);
                return;
            }
            
            // 验证时间数据有效性
            const startTime = new Date(remoteRecord.startTime).getTime();
            if (isNaN(startTime) || startTime > now || (now - startTime) > 24 * 60 * 60 * 1000) {
                console.warn(`⚠️ 学生 ${studentName} 的时间数据异常，清理该记录`);
                if (attendanceData.realTimePractice[studentName]) {
                    delete attendanceData.realTimePractice[studentName];
                    hasChanges = true;
                }
                return;
            }
            
            const shouldUpdate = !currentStatus || 
                currentStatus.room !== remoteRecord.room ||
                Math.abs((currentStatus.currentDuration || 0) - (remoteRecord.currentDuration || 0)) > 10 ||
                currentStatus.startTime !== remoteRecord.startTime;
            
            if (shouldUpdate) {
                attendanceData.realTimePractice[studentName] = {
                    room: remoteRecord.room,
                    startTime: remoteRecord.startTime,
                    currentDuration: remoteRecord.currentDuration || 0,
                    lastUpdated: now,
                    syncSource: 'remote'
                };
                hasChanges = true;
                debugLog(`更新学生练琴状态: ${studentName}`, remoteRecord);
            }
        });
        
        if (hasChanges) {
            if (currentTab === 'dashboard') {
                displayPracticeStatus();
            }
            
            // 🔥 移除：不再保存到本地存储
            
            // 🔥 新增：同步更新本地同步状态
            setTimeout(() => {
                checkAndUpdateRealTimePracticeStatus(true);
            }, 500);
            
            const activeCount = remoteStudentNames.length;
            addSyncLog(`🎹 实时练琴状态已同步 (${activeCount}名学生)`);
            
            if (activeCount === 0) {
                addSyncLog('✅ 所有学生已结束练琴');
            }
        }
    } catch (error) {
        console.error('处理实时练琴状态更新失败:', error);
        addSyncLog('❌ 实时练琴状态更新失败: ' + error.message);
    }
}

// 🔥 新增：强制同步验证函数
function forceValidateAndSync() {
    if (!isOnline || !database) {
        console.log('离线状态，跳过强制同步验证');
        return;
    }
    
    console.log('🔍 开始强制同步验证...');
    
    const promises = [];
    
    // 同时获取琴房和练琴状态数据
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            const roomsData = snapshot.exists() ? snapshot.val() : [];
            console.log('🏠 强制获取琴房数据:', roomsData);
            handleRoomsUpdate(roomsData);
        })
        .catch((error) => {
            console.error('强制获取琴房数据失败:', error);
        });
    
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            const practiceData = snapshot.exists() ? snapshot.val() : {};
            console.log('🎹 强制获取练琴数据:', practiceData);
            handleRemoteRealTimePracticeUpdate(practiceData);
        })
        .catch((error) => {
            console.error('强制获取练琴数据失败:', error);
        });
    
    promises.push(roomsPromise, practicePromise);
    
    Promise.all(promises).then(() => {
        console.log('✅ 强制同步验证完成');
        addSyncLog('🔍 强制同步验证完成');
    });
}
// 🔥 新增：强制验证实时练琴数据
function forceValidateRealTimePractice() {
    if (!isOnline || !database) return;
    
    const promises = [];
    
    // 获取远程练琴状态
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            const remoteData = snapshot.exists() ? snapshot.val() : {};
            debugLog('强制验证 - 远程练琴数据', remoteData);
            
            // 立即处理远程数据
            handleRemoteRealTimePracticeUpdate(remoteData);
        })
        .catch((error) => {
            console.error('强制验证练琴数据失败:', error);
        });
    
    // 获取琴房状态
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            const roomsData = snapshot.exists() ? snapshot.val() : [];
            debugLog('强制验证 - 琴房数据', roomsData);
            
            // 立即处理琴房数据
            handleRoomsUpdate(roomsData);
        })
        .catch((error) => {
            console.error('强制验证琴房数据失败:', error);
        });
    
    promises.push(practicePromise, roomsPromise);
    
    Promise.all(promises).then(() => {
        // 验证完成后立即清理过期数据
        validateAndCleanExpiredData();
        debugLog('强制验证完成');
    });
}

// 🔥 新增：深度验证和同步
function deepValidateAndSync() {
    if (!isOnline || !database) return;
    
    debugLog('开始深度验证和同步');
    
    // 先清理本地过期数据
    validateAndCleanExpiredData();
    
    // 然后获取最新的远程数据进行对比
    Promise.all([
        database.ref('realTimePracticeStatus').once('value'),
        database.ref('rooms').once('value')
    ]).then(([practiceSnapshot, roomsSnapshot]) => {
        const remotePracticeData = practiceSnapshot.exists() ? practiceSnapshot.val() : {};
        const remoteRoomsData = roomsSnapshot.exists() ? roomsSnapshot.val() : [];
        
        debugLog('深度验证 - 远程练琴数据', remotePracticeData);
        debugLog('深度验证 - 远程琴房数据', remoteRoomsData);
        debugLog('深度验证 - 本地练琴数据', attendanceData.realTimePractice);
        
        // 检查数据一致性
        const remoteStudents = Object.keys(remotePracticeData);
        const localStudents = Object.keys(attendanceData.realTimePractice || {});
        
        // 如果本地有学生但远程没有，强制清理
        const studentsToRemove = localStudents.filter(student => !remoteStudents.includes(student));
        if (studentsToRemove.length > 0) {
            debugLog('深度验证发现需要清理的学生', studentsToRemove);
            studentsToRemove.forEach(studentName => {
                delete attendanceData.realTimePractice[studentName];
            });
            localStorage.setItem('realTimePracticeStatus', JSON.stringify(attendanceData.realTimePractice));
            displayPracticeStatus();
            addSyncLog(`🧹 深度验证清理了 ${studentsToRemove.length} 个不一致的练琴状态`);
        }
        
        // 处理最新的远程数据
        handleRemoteRealTimePracticeUpdate(remotePracticeData);
        handleRoomsUpdate(remoteRoomsData);
        
    }).catch((error) => {
        console.error('深度验证失败:', error);
        addSyncLog('❌ 深度验证失败: ' + error.message);
    });
}

// 更新连接状态显示
function updateConnectionStatus() {
    const statusEl = document.getElementById('connectionStatus');
    
    if (isOnline) {
        statusEl.className = 'connection-status online';
        statusEl.innerHTML = '<span data-i18n="status.online">' + t('status.online', '已连接') + '</span>';
    } else {
        statusEl.className = 'connection-status offline';
        statusEl.innerHTML = '<span data-i18n="status.offline">' + t('status.offline', '离线模式') + '</span>';
    }
}


// 添加同步日志
function addSyncLog(message) {
    const timestamp = new Date().toLocaleString();
    const logEntry = `[${timestamp}] ${message}`;
    syncLogs.unshift(logEntry);
    
    if (syncLogs.length > 100) {
        syncLogs = syncLogs.slice(0, 100);
    }
    
    updateSyncLogsDisplay();
}

// 更新同步日志显示
function updateSyncLogsDisplay() {
    const logsEl = document.getElementById('syncLogs');
    if (logsEl) {
        logsEl.innerHTML = syncLogs.join('\n');
        logsEl.scrollTop = 0;
    }
}

function loadInitialData() {
    if (!isOnline) return;
    
    addSyncLog('🔄 ' + t('sync.loading_data', '开始加载数据...'));
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = today;
    
    preloadRecentAttendanceData();
    forceRefreshAllData();
}

function forceRefreshAllData() {
    addSyncLog('🔄 ' + t('sync.force_refresh', '正在强制刷新所有数据...'));
    
    const refreshPromises = [];
    
    const selectedDate = document.getElementById('dateSelect').value;
    if (selectedDate) {
        const attendancePromise = database.ref(`attendanceData/${selectedDate}`).once('value')
            .then((snapshot) => {
                const data = snapshot.val() || {};
                attendanceData[selectedDate] = data;
                displayAttendanceSnapshot(data, selectedDate);
                addSyncLog(`✅ 已刷新 ${selectedDate} 的考勤数据`);
            })
            .catch((error) => {
                addSyncLog(`❌ 刷新考勤数据失败: ${error.message}`);
            });
        refreshPromises.push(attendancePromise);
    }
    
    const studentPromise = database.ref('studentDatabase').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                studentData = snapshot.val();
                updateFilters();
                addSyncLog('✅ ' + t('sync.student_refreshed', '已刷新学生数据'));
            }
        })
        .catch((error) => {
            addSyncLog(`❌ 刷新学生数据失败: ${error.message}`);
        });
    refreshPromises.push(studentPromise);
    
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRemoteRealTimePracticeUpdate(snapshot.val());
                addSyncLog('✅ ' + t('sync.practice_refreshed', '已刷新实时练琴状态'));
            }
        })
        .catch((error) => {
            addSyncLog(`❌ 刷新实时练琴状态失败: ${error.message}`);
        });
    refreshPromises.push(practicePromise);
    
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRoomsUpdate(snapshot.val());
                addSyncLog('✅ ' + t('sync.rooms_refreshed', '已刷新琴房状态'));
            }
        })
        .catch((error) => {
            addSyncLog(`❌ 刷新琴房状态失败: ${error.message}`);
        });
    refreshPromises.push(roomsPromise);
    
    const excusePromise = database.ref('excuseData').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                excuseData = snapshot.val();
                addSyncLog('✅ ' + t('sync.excuse_refreshed', '已刷新请假数据'));
            }
        })
        .catch((error) => {
            addSyncLog(`❌ 刷新请假数据失败: ${error.message}`);
        });
    refreshPromises.push(excusePromise);
    
    Promise.all(refreshPromises).then(() => {
        addSyncLog('🎉 ' + t('sync.all_refreshed', '所有数据刷新完成'));
        updateDashboard();
        if (currentTab === 'students') {
            updateStudentList();
        }
        if (currentTab === 'dashboard') {
            displayPracticeStatus();
        }
    }).catch((error) => {
        addSyncLog(`⚠️ 部分数据刷新失败: ${error.message}`);
    });
}

function updateStudentList() {
    if (currentTab === 'students') {
        const combinedData = combineStudentAndAttendanceData();
        displayStudentList(combinedData);
        addSyncLog('🔄 ' + t('sync.student_list_updated', '学生列表已更新'));
    }
}

// 加载考勤数据
function loadAttendanceData() {
    const selectedDate = document.getElementById('dateSelect').value;
    if (!selectedDate) return;
    
    showLoading('todaySnapshot');
    
    if (isOnline) {
        database.ref(`attendanceData/${selectedDate}`).once('value')
            .then((snapshot) => {
                const data = snapshot.val() || {};
                displayAttendanceSnapshot(data, selectedDate);
                addSyncLog(`📊 已加载 ${selectedDate} 的考勤数据`);
            })
            .catch((error) => {
                console.error('加载考勤数据失败:', error);
                addSyncLog('❌ ' + t('sync.load_failed', '加载考勤数据失败') + ': ' + error.message);
                showEmptyState('todaySnapshot', t('empty.load_failed', '加载失败'), t('empty.network_error', '无法加载考勤数据，请检查网络连接'));
            });
    } else {
        const localData = localStorage.getItem(`attendance_${selectedDate}`);
        if (localData) {
            displayAttendanceSnapshot(JSON.parse(localData), selectedDate);
        } else {
            showEmptyState('todaySnapshot', t('msg.no_data', '暂无数据'), t('empty.offline_no_data', '离线模式下没有找到该日期的考勤数据'));
        }
        
        displayPracticeStatus();
    }
}

// 🔥 保留：显示考勤快照时的本地存储功能
function displayAttendanceSnapshot(data, date) {
    const container = document.getElementById('todaySnapshot');
    
    if (!data || Object.keys(data).length === 0) {
        showEmptyState('todaySnapshot', t('msg.no_data', '暂无数据'), `${date} ` + t('empty.no_attendance', '还没有考勤记录'));
        return;
    }
    
    // 🔥 保留：保存考勤数据到本地存储
    try {
        localStorage.setItem(`attendance_${date}`, JSON.stringify(data));
    } catch (e) {
        console.warn('保存考勤数据到本地存储失败:', e);
    }
    
    // 其余显示逻辑保持不变...
    let html = '<div class="student-grid">';
    
    const groupedByMajor = {};
    Object.values(data).forEach(student => {
        const major = student.major || t('student.unknown_major', '其他');
        if (!groupedByMajor[major]) {
            groupedByMajor[major] = [];
        }
        groupedByMajor[major].push(student);
    });
    
    Object.keys(groupedByMajor).sort().forEach(major => {
        html += `<div style="grid-column: 1 / -1; margin: 20px 0 10px 0;">
                    <h4 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">
                        ${major} (${groupedByMajor[major].length}${t('report.people', '人')})
                    </h4>
                </div>`;
        
        groupedByMajor[major].forEach(student => {
            html += createStudentCard(student, true);
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    updateStatistics(data);
    displayPracticeStatus();
}


// 创建学生卡片
function createStudentCard(student, isSnapshot = false) {
    const statusClass = getStatusClass(student.finalAttendanceStatus);
    const statusText = getStatusText(student.finalAttendanceStatus);
    
    return `
        <div class="student-card ${statusClass}" onclick="showStudentDetail('${student.name}')">
            <div class="student-header">
                <div class="student-name">${student.name}</div>
                <div class="student-status ${statusClass}">${statusText}</div>
            </div>
            <div class="student-details">
                <div class="detail-item">
                    <div class="detail-label">${t('student.major', '专业')}</div>
                    <div class="detail-value">${student.major || t('student.not_set', '未设置')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.grade', '年级')}</div>
                    <div class="detail-value">${student.grade || t('student.not_set', '未设置')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.time_slot', '时间段')}</div>
                    <div class="detail-value">${student.start || t('student.no_schedule', '无')} - ${student.end || t('student.no_schedule', '无')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.practice_duration', '练琴时长')}</div>
                    <div class="detail-value">${student.practicedText || t('time.no_practice', '0分钟')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.room', '所在琴房')}</div>
                    <div class="detail-value">${student.room || t('student.not_in_room', '不在琴房')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('attendance.rate', '出勤率')}</div>
                    <div class="detail-value">${calculateAttendanceRate(student)}%</div>
                </div>
                ${student.excuseInfo ? `
                <div class="detail-item" style="grid-column: 1 / -1;">
                    <div class="detail-label">${t('excuse.reason', '请假信息')}</div>
                    <div class="detail-value" style="color: #f39c12;">
                        ${student.excuseInfo.reason || t('status.excused', '已请假')}
                        ${student.excuseInfo.approvedBy ? `<br><small>${t('excuse.approver', '批准人')}: ${student.excuseInfo.approvedBy}</small>` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
            ${!isSnapshot ? createAttendanceHistory(student) : ''}
        </div>
    `;
}
// 🔥 新增：筛选实时练琴状态
function filterPracticeStatus() {
    const majorFilter = document.getElementById('practiceMajorFilter').value;
    const gradeFilter = document.getElementById('practiceGradeFilter').value;
    const searchText = document.getElementById('practiceStudentSearch').value.toLowerCase();
    
    const container = document.getElementById('practiceStudentList');
    if (!container) return;
    
    const practiceData = attendanceData.realTimePractice || {};
    const practiceStudents = Object.keys(practiceData);
    
    if (practiceStudents.length === 0) {
        displayEmptyPracticeState();
        return;
    }
    
    // 筛选学生
    const filteredStudents = practiceStudents.filter(studentName => {
        const studentInfo = getStudentInfoFromDatabase(studentName);
        
        // 专业筛选
        if (majorFilter && studentInfo.major !== majorFilter) return false;
        
        // 年级筛选
        if (gradeFilter && studentInfo.grade !== gradeFilter) return false;
        
        // 姓名搜索
        if (searchText && !studentName.toLowerCase().includes(searchText)) return false;
        
        return true;
    });
    
    if (filteredStudents.length === 0) {
        container.innerHTML = `
            <div class="practice-empty-state" style="grid-column: 1 / -1;">
                <div class="practice-empty-state-icon">🔍</div>
                <div class="practice-empty-state-title">${t('filter.no_results', '没有符合条件的学生')}</div>
                <div class="practice-empty-state-description">${t('filter.try_different', '请尝试调整筛选条件')}</div>
            </div>
        `;
        return;
    }
    
    displayFilteredPracticeStatus(filteredStudents);
}

// 🔥 新增：显示筛选后的练琴状态
function displayFilteredPracticeStatus(filteredStudents) {
    const container = document.getElementById('practiceStudentList');
    const practiceData = attendanceData.realTimePractice || {};
    
    let html = '';
    
    const sortedStudents = filteredStudents.sort((a, b) => {
        const durationA = practiceData[a].currentDuration || 0;
        const durationB = practiceData[b].currentDuration || 0;
        return durationB - durationA;
    });
    
    sortedStudents.forEach(studentName => {
        const practiceInfo = practiceData[studentName];
        const studentInfo = getStudentInfoFromDatabase(studentName);
        
        let currentDuration = practiceInfo.currentDuration || 0;
        if (practiceInfo.startTime) {
            const now = Date.now();
            const startTime = new Date(practiceInfo.startTime).getTime();
            currentDuration = Math.floor((now - startTime) / 1000);
            
            practiceData[studentName].currentDuration = currentDuration;
        }
        
        const duration = formatPracticeDuration(currentDuration);
        const startTime = new Date(practiceInfo.startTime).toLocaleTimeString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });

        const practiceType = isWeekend() ? 
            t('practice.type.weekend', '周末自主练琴') : 
            t('practice.type.unscheduled', '时间段外练琴');
        
        html += `
            <div class="practice-status-card" onclick="showStudentDetail('${studentName}')">
                <div class="practice-indicator"></div>
                <div class="student-header">
                    <div class="student-name">${studentName}</div>
                    <div class="practice-duration">${duration}</div>
                </div>
                <div class="practice-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('practice.room', '所在琴房')}</div>
                        <div class="detail-value">${practiceInfo.room || t('student.not_in_room', '未知琴房')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('practice.start_time', '开始时间')}</div>
                        <div class="detail-value">${startTime}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.major', '专业')}</div>
                        <div class="detail-value">${studentInfo.major}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.grade', '年级')}</div>
                        <div class="detail-value">${studentInfo.grade || t('student.not_set', '未设置')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('practice.type', '练琴类型')}</div>
                        <div class="detail-value">${practiceType}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// 🔥 新增：显示空的练琴状态
function displayEmptyPracticeState() {
    const container = document.getElementById('practiceStudentList');
    const emptyDesc = isWeekend() ? 
        t('practice.empty.desc.weekend', '周末时间，学生可自主安排练琴') : 
        t('practice.empty.desc.weekday', '工作日时间，等待学生开始练琴');
        
    container.innerHTML = `
        <div class="practice-empty-state" style="grid-column: 1 / -1;">
            <div class="practice-empty-state-icon">🎹</div>
            <div class="practice-empty-state-title">${t('practice.empty.title', '当前没有学生在练琴')}</div>
            <div class="practice-empty-state-description">${emptyDesc}</div>
        </div>
    `;
}

// 🔥 新增：更新练琴筛选器选项
function updatePracticeFilterOptions() {
    const practiceData = attendanceData.realTimePractice || {};
    const practiceStudents = Object.keys(practiceData);
    
    if (practiceStudents.length === 0) {
        return;
    }
    
    // 更新专业筛选
    const majorFilter = document.getElementById('practiceMajorFilter');
    const gradeFilter = document.getElementById('practiceGradeFilter');
    
    if (!majorFilter || !gradeFilter) return;
    
    const currentMajor = majorFilter.value;
    const currentGrade = gradeFilter.value;
    
    // 收集正在练琴学生的专业和年级
    const majors = new Set();
    const grades = new Set();
    
    practiceStudents.forEach(studentName => {
        const studentInfo = getStudentInfoFromDatabase(studentName);
        if (studentInfo.major) majors.add(studentInfo.major);
        if (studentInfo.grade) grades.add(studentInfo.grade);
    });
    
    // 更新专业选项
    majorFilter.innerHTML = `<option value="">${t('filter.all_majors', '所有专业')}</option>`;
    Array.from(majors).sort().forEach(major => {
        const option = document.createElement('option');
        option.value = major;
        option.textContent = major;
        if (major === currentMajor) option.selected = true;
        majorFilter.appendChild(option);
    });
    
    // 更新年级选项
    gradeFilter.innerHTML = `<option value="">${t('filter.all_grades', '所有年级')}</option>`;
    Array.from(grades).sort().forEach(grade => {
        const option = document.createElement('option');
        option.value = grade;
        option.textContent = grade;
        if (grade === currentGrade) option.selected = true;
        gradeFilter.appendChild(option);
    });
    
    // 生成快速筛选标签
    generatePracticeQuickFilters(majors, grades);
}

// 🔥 新增：生成快速筛选标签
function generatePracticeQuickFilters(majors, grades) {
    const container = document.getElementById('practiceQuickFilters');
    if (!container) return;
    
    let html = '';
    
    // 专业快速筛选
    Array.from(majors).sort().forEach(major => {
        html += `<div class="quick-filter-tag" onclick="setQuickFilter('major', '${major}')">${major}</div>`;
    });
    
    // 年级快速筛选
    Array.from(grades).sort().forEach(grade => {
        html += `<div class="quick-filter-tag" onclick="setQuickFilter('grade', '${grade}')">${grade}</div>`;
    });
    
    // 清除筛选
    if (majors.size > 0 || grades.size > 0) {
        html += `<div class="quick-filter-tag" onclick="clearPracticeFilters()" style="background: #f8d7da; color: #721c24; border-color: #f5c6cb;">✕ ${t('filter.clear', '清除')}</div>`;
    }
    
    container.innerHTML = html;
}

// 🔥 新增：设置快速筛选
function setQuickFilter(type, value) {
    if (type === 'major') {
        document.getElementById('practiceMajorFilter').value = value;
        document.getElementById('practiceGradeFilter').value = '';
    } else if (type === 'grade') {
        document.getElementById('practiceGradeFilter').value = value;
        document.getElementById('practiceMajorFilter').value = '';
    }
    
    document.getElementById('practiceStudentSearch').value = '';
    
    // 更新标签状态
    document.querySelectorAll('.quick-filter-tag').forEach(tag => {
        tag.classList.remove('active');
        if (tag.textContent.trim() === value) {
            tag.classList.add('active');
        }
    });
    
    filterPracticeStatus();
}

// 🔥 新增：清除练琴筛选
function clearPracticeFilters() {
    document.getElementById('practiceMajorFilter').value = '';
    document.getElementById('practiceGradeFilter').value = '';
    document.getElementById('practiceStudentSearch').value = '';
    
    document.querySelectorAll('.quick-filter-tag').forEach(tag => {
        tag.classList.remove('active');
    });
    
    displayPracticeStatus();
}

// 创建考勤历史时间轴
function createAttendanceHistory(student) {
    const history = student.attendanceHistory || [];
    const last7Days = getLast7Days();
    
    let historyHtml = `<div class="attendance-history"><div class="history-title">${t('attendance.history', '最近7天考勤')}</div><div class="history-timeline">`;
    
    // 对于时间轴显示，我们反转顺序，让最远的日期在左边，最近的在右边
    const reversedDays = [...last7Days].reverse();
    
    reversedDays.forEach(date => {
        const dayData = history.find(h => h.date === date);
        const status = dayData ? dayData.status : 'no-data';
        const day = new Date(date).getDate();
        
        const dayName = new Date(date).toLocaleDateString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', { weekday: 'short' });
        const statusText = getStatusText(status);
        const tooltipText = `${date} (${dayName}) - ${statusText}`;
        
        historyHtml += `<div class="history-day ${getStatusClass(status)}" 
                            title="${tooltipText}" 
                            data-date="${date}" 
                            data-status="${status}">${day}</div>`;
    });
    
    historyHtml += '</div></div>';
    return historyHtml;
}


// 获取最近7天日期
function getLast7Days() {
    const dates = [];
    for (let i = 0; i < 7; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toISOString().split('T')[0]);
    }
    return dates;
}


// 获取状态样式类
function getStatusClass(status) {
    const statusMap = {
        'present': 'present',
        'absent': 'absent', 
        'excused': 'excused',
        'low_efficiency': 'low-efficiency',
        'low-efficiency': 'low-efficiency',
        'under_review': 'low-efficiency',
        'practicing_unscheduled': 'practicing-unscheduled',
        'weekend': 'weekend',
        'no-data': 'no-data'
    };
    return statusMap[status] || 'no-data';
}

// 获取状态文本
function getStatusText(status) {
    const statusMap = {
        'present': t('status.present', '正常出勤'),
        'absent': t('status.absent', '缺勤'),
        'excused': t('status.excused', '请假'),
        'low_efficiency': t('status.low_efficiency', '低效出勤'),
        'under_review': t('status.low_efficiency', '待观察'),
        'no-data': t('status.no_data', '无数据'),
        'practicing_unscheduled': t('status.practicing_unscheduled', '时间段外练琴'),
        'weekend': t('status.weekend', '周末')
    };
    return statusMap[status] || t('status.no_data', '未知');
}

// 计算出勤率
function calculateAttendanceRate(student) {
    if (!student.attendanceHistory || student.attendanceHistory.length === 0) {
        return 0;
    }
    
    const totalDays = student.attendanceHistory.length;
    const presentDays = student.attendanceHistory.filter(h => 
        h.status === 'present' || h.status === 'low_efficiency'
    ).length;
    
    return Math.round((presentDays / totalDays) * 100);
}

// 更新仪表板
function updateDashboard() {
    const selectedDate = document.getElementById('dateSelect').value;
    if (selectedDate) {
        loadAttendanceData();
    }
    updateExcuseInfoDisplay();
}

// 更新请假信息显示
function updateExcuseInfoDisplay() {
    const today = new Date().toISOString().split('T')[0];
    const todayExcuses = excuseData[today] || {};
    const excusePanel = document.getElementById('excuseInfoPanel');
    const excuseContainer = document.getElementById('excuseInfoContainer');
    
    const excuseList = Object.keys(todayExcuses);
    
    if (excuseList.length === 0) {
        excusePanel.style.display = 'none';
        return;
    }
    
    excusePanel.style.display = 'block';
    
    let html = '<div class="student-grid">';
    
    excuseList.forEach(studentName => {
        const excuse = todayExcuses[studentName];
        const statusClass = excuse.status === 'approved' ? 'success' : 
                           excuse.status === 'pending' ? 'warning' : 'danger';
        const statusText = excuse.status === 'approved' ? t('excuse.status.approved', '已批准') :
                          excuse.status === 'pending' ? t('excuse.status.pending', '待审核') : t('excuse.status.rejected', '已拒绝');
        
        html += `
            <div class="student-card ${statusClass}">
                <div class="student-header">
                    <div class="student-name">${studentName}</div>
                    <div class="student-status ${statusClass}">${statusText}</div>
                </div>
                <div class="student-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.reason', '请假原因')}</div>
                        <div class="detail-value">${excuse.reason || t('excuse.not_filled', '未填写')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.time', '请假时间')}</div>
                        <div class="detail-value">${excuse.startDate || today} ${t('report.to', '至')} ${excuse.endDate || today}</div>
                    </div>
                    ${excuse.approvedBy ? `
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.approver', '批准人')}</div>
                        <div class="detail-value">${excuse.approvedBy}</div>
                    </div>
                    ` : ''}
                    ${excuse.submittedAt ? `
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.submit_time', '提交时间')}</div>
                        <div class="detail-value">${new Date(excuse.submittedAt).toLocaleString()}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    excuseContainer.innerHTML = html;
}

// 更新统计数据
function updateStatistics(data) {
    const students = Object.values(data);
    const total = students.length;
    const present = students.filter(s => s.finalAttendanceStatus === 'present').length;
    const absent = students.filter(s => s.finalAttendanceStatus === 'absent').length;
    const excused = students.filter(s => s.finalAttendanceStatus === 'excused').length;
    const unscheduled = students.filter(s => s.finalAttendanceStatus === 'practicing_unscheduled').length;
    const weekend = students.filter(s => s.finalAttendanceStatus === 'weekend').length;
    
    if (isWeekend()) {
        updateWeekendStats(total, unscheduled, weekend - unscheduled);
    } else {
        updateWeekdayStats(total, present, absent, excused, unscheduled);
    }
}

function updateWeekendStats(total, practicing, resting) {
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('presentCount').textContent = practicing;
    document.getElementById('absentCount').textContent = resting;
    document.getElementById('excusedCount').textContent = 0;
    
    // 更新标签文字
    document.querySelector('#presentCount').parentElement.querySelector('.stat-label').textContent = t('stats.practicing', '正在练琴');
    document.querySelector('#absentCount').parentElement.querySelector('.stat-label').textContent = t('stats.not_practicing', '未在练琴');
    document.querySelector('#excusedCount').parentElement.querySelector('.stat-label').textContent = t('status.weekend', '周末');
}

function updateWeekdayStats(total, present, absent, excused, unscheduled) {
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('excusedCount').textContent = excused;
    
    // 恢复工作日标签
    document.querySelector('#presentCount').parentElement.querySelector('.stat-label').textContent = t('stats.present', '正常出勤');
    document.querySelector('#absentCount').parentElement.querySelector('.stat-label').textContent = t('stats.absent', '缺勤学生');
    document.querySelector('#excusedCount').parentElement.querySelector('.stat-label').textContent = t('stats.excused', '请假学生');
}

// 刷新练琴状态
function refreshPracticeStatus() {
    updateCurrentTime();
    
    if (isOnline) {
        addSyncLog('🔄 ' + t('sync.refreshing_practice', '正在刷新实时练琴状态...'));
        
        // 🔥 修改：先清理过期数据，再强制验证
        validateAndCleanExpiredData();
        triggerRealTimePracticeStatusUpdate();
        
        // 🔥 新增：延迟再次验证，确保数据同步
        setTimeout(() => {
            forceValidateRealTimePractice();
        }, 2000);
    } else {
        updatePracticeDurations();
        displayPracticeStatus();
    }
    
    addSyncLog('🎹 ' + t('sync.practice_refreshed', '已刷新实时练琴状态'));
}


// 更新当前时间显示
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const currentTimeEl = document.getElementById('currentTime');
    if (currentTimeEl) {
        currentTimeEl.textContent = timeString;
    }
}

// 显示实时练琴状态
function displayPracticeStatus() {
    const container = document.getElementById('practiceStudentList');
    if (!container) return;
    
    const practiceData = attendanceData.realTimePractice || {};
    const practiceStudents = Object.keys(practiceData);
    
    if (practiceStudents.length === 0) {
        displayEmptyPracticeState();
        // 清空筛选器
        const majorFilter = document.getElementById('practiceMajorFilter');
        const gradeFilter = document.getElementById('practiceGradeFilter');
        const quickFilters = document.getElementById('practiceQuickFilters');
        
        if (majorFilter) majorFilter.innerHTML = `<option value="">${t('filter.all_majors', '所有专业')}</option>`;
        if (gradeFilter) gradeFilter.innerHTML = `<option value="">${t('filter.all_grades', '所有年级')}</option>`;
        if (quickFilters) quickFilters.innerHTML = '';
        
        return;
    }
    
    // 更新筛选器选项
    updatePracticeFilterOptions();
    
    // 应用当前筛选条件
    filterPracticeStatus();
}


// 初始化实时练琴状态显示
function initPracticeStatusDisplay() {
    updateCurrentTime();
    displayPracticeStatus();
    
    // 🔥 修改：更频繁的数据刷新和验证
    setInterval(() => {
        updateCurrentTime();
        if (currentTab === 'dashboard') {
            if (isOnline) {
                // 每10秒检查一次状态变化并同步
                periodicRealTimePracticeStatusCheck();
                cleanupEndedPracticeStatus();
            } else {
                updatePracticeDurations();
                displayPracticeStatus();
            }
        }
    }, 10000);
    
    // 🔥 新增：每30秒进行一次强制验证
    setInterval(() => {
        if (isOnline && currentTab === 'dashboard') {
            validateAndCleanExpiredData();
            triggerRealTimePracticeStatusUpdate();
        }
    }, 30000);
    
    setInterval(updateCurrentTime, 1000);
    
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && currentTab === 'dashboard') {
            debugLog('页面变为可见，开始强制同步');
            setTimeout(() => {
                validateAndCleanExpiredData();
                
                if (isOnline) {
                    triggerRealTimePracticeStatusUpdate();
                } else {
                    displayPracticeStatus();
                }
            }, 1000);
        }
    });
}

// 专门刷新实时练琴数据的函数
function refreshRealTimePracticeData() {
    if (!isOnline || !database) return;
    
    const refreshPromises = [];
    
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRemoteRealTimePracticeUpdate(snapshot.val());
            }
        })
        .catch((error) => {
            console.log('刷新实时练琴状态失败:', error.message);
        });
    refreshPromises.push(practicePromise);
    
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRoomsUpdate(snapshot.val());
            }
        })
        .catch((error) => {
            console.log('刷新琴房状态失败:', error.message);
        });
    refreshPromises.push(roomsPromise);
    
    Promise.all(refreshPromises).then(() => {
        displayPracticeStatus();
        updatePracticeDurations();
    });
}

// 更新练琴时长显示
function updatePracticeDurations() {
    if (!attendanceData.realTimePractice) return;
    
    const now = Date.now();
    let hasUpdates = false;
    
    Object.keys(attendanceData.realTimePractice).forEach(studentName => {
        const practiceInfo = attendanceData.realTimePractice[studentName];
        if (practiceInfo.startTime) {
            const startTime = new Date(practiceInfo.startTime).getTime();
            const newDuration = Math.floor((now - startTime) / 1000);
            
            if (newDuration !== practiceInfo.currentDuration) {
                attendanceData.realTimePractice[studentName].currentDuration = newDuration;
                hasUpdates = true;
            }
        }
    });
    
    if (hasUpdates) {
        displayPracticeStatus();
        // 🔥 移除：不再保存到本地存储
        
        // 有更新时触发同步检查
        if (isOnline) {
            checkAndUpdateRealTimePracticeStatus(false);
        }
    }
}



// 判断是否为周末
function isWeekend() {
    const day = new Date().getDay();
    return day === 0 || day === 6;
}

// 从学生数据库获取学生信息
function getStudentInfoFromDatabase(studentName) {
    for (const [major, students] of Object.entries(studentData)) {
        if (Array.isArray(students)) {
            const found = students.find(student => {
                const name = typeof student === 'string' ? student : student.name;
                return name === studentName;
            });
            if (found) {
                return {
                    major: major,
                    grade: typeof found === 'object' ? found.grade || '' : ''
                };
            }
        }
    }
    return { major: t('student.unknown_major', '未知专业'), grade: '' };
}

// 格式化练琴时长
function formatPracticeDuration(seconds) {
    if (!seconds || seconds <= 0) return t('time.no_practice', '0分钟');
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}${t('time.hours', '小时')}${minutes > 0 ? minutes + t('time.minutes', '分钟') : ''}`;
    } else if (minutes > 0) {
        return `${minutes}${t('time.minutes', '分钟')}${secs > 0 ? secs + t('time.seconds', '秒') : ''}`;
    } else {
        return `${secs}${t('time.seconds', '秒')}`;
    }
}

// 获取学生考勤历史
function getStudentAttendanceHistory(studentName) {
    const history = [];
    const last7Days = getLast7Days();
    
    last7Days.forEach(date => {
        const dayData = attendanceData[date];
        if (dayData && dayData[studentName]) {
            history.push({
                date: date,
                status: dayData[studentName].finalAttendanceStatus || 'no-data'
            });
        } else {
            history.push({
                date: date,
                status: 'no-data'
            });
        }
    });
    
    return history;
}

// 🔥 增强的过期数据清理函数
function validateAndCleanExpiredData() {
    if (!attendanceData.realTimePractice) return;
    
    const now = Date.now();
    const maxAge = 15 * 60 * 1000; // 🔥 进一步缩短到15分钟
    let cleaned = 0;
    
    Object.keys(attendanceData.realTimePractice).forEach(studentName => {
        const practiceInfo = attendanceData.realTimePractice[studentName];
        
        // 检查是否缺少必要字段
        if (!practiceInfo || !practiceInfo.lastUpdated || !practiceInfo.startTime) {
            debugLog(`清理缺少必要字段的记录: ${studentName}`);
            delete attendanceData.realTimePractice[studentName];
            cleaned++;
            return;
        }
        
        const lastUpdated = new Date(practiceInfo.lastUpdated).getTime();
        const startTime = new Date(practiceInfo.startTime).getTime();
        const age = now - lastUpdated;
        const practiceAge = now - startTime;
        
        // 🔥 更严格的过期检测
        if (isNaN(lastUpdated) || isNaN(startTime) || 
            age > maxAge || 
            practiceAge > 8 * 60 * 60 * 1000 || // 🔥 练琴超过8小时视为异常
            startTime > now) { // 开始时间在未来
            
            debugLog(`清理过期/异常记录: ${studentName} (更新${Math.round(age/60000)}分钟前, 练琴${Math.round(practiceAge/60000)}分钟)`);
            delete attendanceData.realTimePractice[studentName];
            cleaned++;
        }
    });
    
    if (cleaned > 0) {
        localStorage.setItem('realTimePracticeStatus', JSON.stringify(attendanceData.realTimePractice));
        displayPracticeStatus();
        addSyncLog(`🧹 已清理 ${cleaned} 个过期/异常的练琴记录`);
    }
}


// 切换标签页
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.getElementById(tabName + 'Tab').style.display = 'block';
    
    event.target.classList.add('active');
    
    currentTab = tabName;
    
    switch(tabName) {
        case 'dashboard':
            if (isOnline) {
                forceRefreshAllData();
            } else {
                loadAttendanceData();
                displayPracticeStatus();
            }
            break;
        case 'students':
            if (isOnline) {
                database.ref('studentDatabase').once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            studentData = snapshot.val();
                            updateFilters();
                        }
                        loadStudentList();
                        addSyncLog('✅ ' + t('sync.student_page_refreshed', '学生页面数据已刷新'));
                    })
                    .catch((error) => {
                        loadStudentList();
                        addSyncLog(`⚠️ 学生数据刷新失败: ${error.message}`);
                    });
            } else {
                loadStudentList();
            }
            break;
        case 'reports':
            initReportsTab();
            break;
        case 'sync':
            updateSyncStatus();
            break;
    }
}

// 加载学生列表
function loadStudentList() {
    if (!isOnline) {
        showEmptyState('studentList', t('sync.offline', '离线模式'), t('msg.network_required', '需要连接到网络才能查看学生详情'));
        return;
    }
    
    showLoading('studentList');
    
    const combinedData = combineStudentAndAttendanceData();
    
    console.log('合并后的学生数据数量:', Object.keys(combinedData).length);
    console.log('学生列表:', Object.keys(combinedData));
    
    displayStudentList(combinedData);
    updateStatusFilterOptions();
    
    addSyncLog(`📋 已加载 ${Object.keys(combinedData).length} 名学生的信息`);
}

// 合并学生和考勤数据
function combineStudentAndAttendanceData() {
    const combined = {};
    const today = new Date().toISOString().split('T')[0];
    const todayAttendance = attendanceData[today] || {};
    const todayExcuses = excuseData[today] || {};
    
    Object.keys(studentData).forEach(major => {
        if (Array.isArray(studentData[major])) {
            studentData[major].forEach(student => {
                const studentName = typeof student === 'string' ? student : student.name;
                const studentGrade = typeof student === 'object' ? student.grade : '';
                
                if (!studentName) return;
                
                const excuseInfo = todayExcuses[studentName];
                let defaultStatus = isWeekend() ? 'weekend' : 'absent';
                let defaultStatusText = isWeekend() ? t('status.weekend', '周末') : t('status.absent', '缺勤');
                
                if (excuseInfo && excuseInfo.status === 'approved') {
                    defaultStatus = 'excused';
                    defaultStatusText = t('status.excused', '请假');
                }
                
                combined[studentName] = {
                    name: studentName,
                    major: major,
                    grade: studentGrade,
                    finalAttendanceStatus: defaultStatus,
                    finalStatusText: defaultStatusText,
                    practicedText: t('time.no_practice', '0分钟'),
                    room: t('student.not_in_room', '不在琴房'),
                    start: '',
                    end: '',
                    attendanceHistory: getStudentAttendanceHistory(studentName),
                    excuseInfo: excuseInfo || null
                };
            });
        }
    });
    
    Object.keys(todayAttendance).forEach(studentName => {
        const attendanceRecord = todayAttendance[studentName];
        
        if (combined[studentName]) {
            combined[studentName] = {
                ...combined[studentName],
                ...attendanceRecord,
                attendanceHistory: getStudentAttendanceHistory(studentName)
            };
        } else {
            const studentInfo = getStudentInfoFromDatabase(studentName);
            combined[studentName] = {
                name: studentName,
                major: studentInfo.major,
                grade: studentInfo.grade,
                ...attendanceRecord,
                attendanceHistory: getStudentAttendanceHistory(studentName),
                excuseInfo: todayExcuses[studentName] || null
            };
        }
    });
    
    if (attendanceData.realTimePractice) {
        Object.keys(attendanceData.realTimePractice).forEach(studentName => {
            const practiceStatus = attendanceData.realTimePractice[studentName];
            
            if (!combined[studentName]) {
                const studentInfo = getStudentInfoFromDatabase(studentName);
                
                combined[studentName] = {
                    name: studentName,
                    major: studentInfo.major,
                    grade: studentInfo.grade,
                    finalAttendanceStatus: 'practicing_unscheduled',
                    finalStatusText: isWeekend() ? t('practice.type.weekend', '周末自主练琴') : t('practice.type.unscheduled', '时间段外练琴'),
                    practicedText: formatPracticeDuration(practiceStatus.currentDuration || 0),
                    room: practiceStatus.room || t('student.not_in_room', '不在琴房'),
                    start: '',
                    end: '',
                    attendanceHistory: getStudentAttendanceHistory(studentName),
                    excuseInfo: todayExcuses[studentName] || null
                };
            } else {
                combined[studentName].finalAttendanceStatus = 'practicing_unscheduled';
                combined[studentName].finalStatusText = isWeekend() ? 
                    t('practice.type.weekend', '周末自主练琴') : 
                    t('practice.type.unscheduled', '时间段外练琴');
                combined[studentName].practicedText = formatPracticeDuration(practiceStatus.currentDuration || 0);
                combined[studentName].room = practiceStatus.room || combined[studentName].room;
            }
        });
    }
    
    return combined;
}

// 显示学生列表
function displayStudentList(students) {
    const container = document.getElementById('studentList');
    
    if (!students || Object.keys(students).length === 0) {
        showEmptyState('studentList', t('empty.no_students', '暂无学生数据'), t('empty.ensure_sync', '请确保学生数据已正确同步'));
        return;
    }
    
    const filteredStudents = filterStudentsByCurrentFilters(students);
    
    if (filteredStudents.length === 0) {
        showEmptyState('studentList', t('filter.no_results', '没有符合条件的学生'), t('filter.try_different', '请尝试调整筛选条件'));
        return;
    }
    
    let html = '<div class="student-grid">';
    
    const groupedByMajor = {};
    filteredStudents.forEach(student => {
        const major = student.major || t('student.unknown_major', '其他');
        if (!groupedByMajor[major]) {
            groupedByMajor[major] = [];
        }
        groupedByMajor[major].push(student);
    });
    
    Object.keys(groupedByMajor).sort().forEach(major => {
        html += `<div style="grid-column: 1 / -1; margin: 20px 0 10px 0;">
                    <h4 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">
                        ${major} (${groupedByMajor[major].length}${t('report.people', '人')})
                    </h4>
                </div>`;
        
        groupedByMajor[major].forEach(student => {
            html += createStudentCard(student, false);
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// 根据当前筛选条件过滤学生
function filterStudentsByCurrentFilters(students) {
    const majorFilter = document.getElementById('majorFilter').value;
    const gradeFilter = document.getElementById('gradeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const searchText = document.getElementById('studentSearch').value.toLowerCase();
    
    return Object.values(students).filter(student => {
        if (majorFilter && student.major !== majorFilter) return false;
        if (gradeFilter && student.grade !== gradeFilter) return false;
        if (statusFilter && student.finalAttendanceStatus !== statusFilter) return false;
        if (searchText && !student.name.toLowerCase().includes(searchText)) return false;
        return true;
    });
}

// 筛选学生
function filterStudents() {
    if (currentTab === 'students') {
        const combinedData = combineStudentAndAttendanceData();
        displayStudentList(combinedData);
    }
}

// 更新筛选器选项
function updateFilters() {
    updateMajorFilterOptions();
    updateGradeFilterOptions();
    updateStatusFilterOptions();
}

// 更新专业筛选选项
function updateMajorFilterOptions() {
    const majorFilter = document.getElementById('majorFilter');
    const currentValue = majorFilter.value;
    
    majorFilter.innerHTML = `<option value="">${t('filter.all_majors', '所有专业')}</option>`;
    
    const majors = Object.keys(studentData).sort();
    majors.forEach(major => {
        const option = document.createElement('option');
        option.value = major;
        option.textContent = major;
        if (major === currentValue) {
            option.selected = true;
        }
        majorFilter.appendChild(option);
    });
}

// 更新年级筛选选项
function updateGradeFilterOptions() {
    const gradeFilter = document.getElementById('gradeFilter');
    const currentValue = gradeFilter.value;
    
    gradeFilter.innerHTML = `<option value="">${t('filter.all_grades', '所有年级')}</option>`;
    
    const grades = new Set();
    Object.values(studentData).forEach(students => {
        if (Array.isArray(students)) {
            students.forEach(student => {
                if (typeof student === 'object' && student.grade) {
                    grades.add(student.grade);
                }
            });
        }
    });
    
    Array.from(grades).sort().forEach(grade => {
        const option = document.createElement('option');
        option.value = grade;
        option.textContent = grade;
        if (grade === currentValue) {
            option.selected = true;
        }
        gradeFilter.appendChild(option);
    });
}

// 更新状态筛选选项
function updateStatusFilterOptions() {
    const statusFilter = document.getElementById('statusFilter');
    const currentValue = statusFilter.value;
    
    statusFilter.innerHTML = `
        <option value="">${t('filter.all_status', '所有状态')}</option>
        <option value="present">${t('status.present', '正常出勤')}</option>
        <option value="absent">${t('status.absent', '缺勤')}</option>
        <option value="excused">${t('status.excused', '请假')}</option>
        <option value="low-efficiency">${t('status.low_efficiency', '低效出勤')}</option>
        <option value="practicing_unscheduled">${t('status.practicing_unscheduled', '时间段外练琴')}</option>
        <option value="weekend">${t('status.weekend', '周末')}</option>
    `;
    
    if (currentValue) {
        statusFilter.value = currentValue;
    }
}

// 显示学生详情
function showStudentDetail(studentName) {
    if (!isOnline) {
        alert(t('msg.network_required', '需要网络连接才能查看学生详情'));
        return;
    }
    
    const modal = document.getElementById('studentDetailModal');
    const title = document.getElementById('studentDetailTitle');
    const content = document.getElementById('studentDetailContent');
    
    title.textContent = `${studentName} - ${t('student.detail.title', '学生详情')}`;
    
    content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    modal.classList.add('show');
    
    loadStudentDetailData(studentName).then(studentData => {
        content.innerHTML = createStudentDetailContent(studentData);
    }).catch(error => {
        content.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">❌</div>
                <div class="empty-state-title">${t('msg.student_not_found', '未找到学生信息')}</div>
                <div class="empty-state-description">${error.message}</div>
            </div>
        `;
    });
}

// 加载学生详细数据
function loadStudentDetailData(studentName) {
    return new Promise((resolve, reject) => {
        const combinedData = combineStudentAndAttendanceData();
        const student = combinedData[studentName];
        
        if (!student) {
            reject(new Error(t('msg.student_not_found', '未找到学生信息')));
            return;
        }
        
        // 加载更多历史数据
        const promises = [];
        const last30Days = getLast30Days();
        
        last30Days.forEach(date => {
            if (isOnline && !attendanceData[date]) {
                const promise = database.ref(`attendanceData/${date}/${studentName}`).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            if (!attendanceData[date]) {
                                attendanceData[date] = {};
                            }
                            attendanceData[date][studentName] = snapshot.val();
                        }
                    })
                    .catch(error => {
                        console.warn(`加载 ${date} 的数据失败:`, error);
                    });
                promises.push(promise);
            }
        });
        
        Promise.all(promises).then(() => {
            student.extendedHistory = getExtendedAttendanceHistory(studentName);
            resolve(student);
        });
    });
}

// 获取最近30天日期
function getLast30Days() {
    const dates = [];
    for (let i = 0; i < 30; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toISOString().split('T')[0]);
    }
    return dates;
}

// 获取扩展的考勤历史
function getExtendedAttendanceHistory(studentName) {
    const history = [];
    const last30Days = getLast30Days();
    
    last30Days.forEach(date => {
        const dayData = attendanceData[date];
        if (dayData && dayData[studentName]) {
            const studentRecord = dayData[studentName];
            let scheduledDuration = '0分钟';
            let unscheduledDuration = '0分钟';
            let totalDuration = studentRecord.practicedText || t('time.no_practice', '0分钟');

            // 如果有详细的练琴记录，可以分别统计
            if (studentRecord.scheduledPracticeTime) {
                scheduledDuration = formatPracticeDuration(studentRecord.scheduledPracticeTime);
            }
            if (studentRecord.unscheduledPracticeTime) {
                unscheduledDuration = formatPracticeDuration(studentRecord.unscheduledPracticeTime);
            }

            history.push({
                date: date,
                status: studentRecord.finalAttendanceStatus || 'no-data',
                practiceDuration: totalDuration,
                scheduledDuration: scheduledDuration,    // 新增：规定时间段练琴
                unscheduledDuration: unscheduledDuration, // 新增：时间段外练琴
                room: studentRecord.room || t('student.not_in_room', '不在琴房')
            });

        } else {
            history.push({
                date: date,
                status: 'no-data',
                practiceDuration: t('time.no_practice', '0分钟'),
                room: t('student.not_in_room', '不在琴房')
            });
        }
    });
    
    return history;
}

// 创建学生详情内容
function createStudentDetailContent(student) {
    const attendanceStats = calculateDetailedAttendanceStats(student.extendedHistory);
    
    return `
        <div class="student-detail-content">
            <!-- 基本信息 -->
            <div class="card">
                <h4>${t('student.basic_info', '基本信息')}</h4>
                <div class="student-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('student.name', '姓名')}</div>
                        <div class="detail-value">${student.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.major', '专业')}</div>
                        <div class="detail-value">${student.major || t('student.not_set', '未设置')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.grade', '年级')}</div>
                        <div class="detail-value">${student.grade || t('student.not_set', '未设置')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.time_slot', '时间段')}</div>
                        <div class="detail-value">${student.start && student.end ? `${student.start} - ${student.end}` : t('student.self_practice', '自主练琴')}</div>
                    </div>
                </div>
            </div>

            <!-- 今日状态 -->
            <div class="card ${getStatusClass(student.finalAttendanceStatus)}">
                <h4>${t('student.today_attendance', '今日考勤')}</h4>
                <div class="student-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('attendance.status', '考勤状态')}</div>
                        <div class="detail-value">${student.finalStatusText || getStatusText(student.finalAttendanceStatus)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.practice_duration', '练琴时长')}</div>
                        <div class="detail-value">${student.practicedText || t('time.no_practice', '0分钟')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.room', '所在琴房')}</div>
                        <div class="detail-value">${student.room || t('student.not_in_room', '不在琴房')}</div>
                    </div>
                    ${student.excuseInfo ? `
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label">${t('excuse.reason', '请假信息')}</div>
                        <div class="detail-value" style="color: #f39c12;">
                            ${student.excuseInfo.reason || t('status.excused', '已请假')}
                            ${student.excuseInfo.approvedBy ? `<br><small>${t('excuse.approver', '批准人')}: ${student.excuseInfo.approvedBy}</small>` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>

            <!-- 考勤统计 -->
            <div class="card">
                <h4>${t('student.attendance_stats', '考勤统计')} (${t('report.last_30_days', '最近30天')})</h4>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                    <div class="stat-card present">
                        <div class="stat-number">${attendanceStats.present}</div>
                        <div class="stat-label">${t('stats.present', '正常出勤')}</div>
                    </div>
                    <div class="stat-card absent">
                        <div class="stat-number">${attendanceStats.absent}</div>
                        <div class="stat-label">${t('stats.absent', '缺勤')}</div>
                    </div>
                    <div class="stat-card excused">
                        <div class="stat-number">${attendanceStats.excused}</div>
                        <div class="stat-label">${t('stats.excused', '请假')}</div>
                    </div>
                    <div class="stat-card total">
                        <div class="stat-number">${attendanceStats.rate}%</div>
                        <div class="stat-label">${t('attendance.rate', '出勤率')}</div>
                    </div>
                </div>
            </div>

            <!-- 历史记录 -->
            <div class="card">
                <h4>${t('student.history_records', '历史记录')} (${t('report.last_30_days', '最近30天')})</h4>
                <div class="data-table-container" style="max-height: 300px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>${t('report.date', '日期')}</th>
                                <th>${t('attendance.status', '状态')}</th>
                                <th>${t('practice.scheduled', '规定时段')}</th>
                                <th>${t('practice.unscheduled', '时段外')}</th>
                                <th>${t('practice.total', '总时长')}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${student.extendedHistory.map(record => `
                                <tr>
                                    <td>${record.date}</td>
                                    <td><span class="student-status ${getStatusClass(record.status)}">${getStatusText(record.status)}</span></td>
                                    <td>${record.scheduledDuration || '0分钟'}</td>
                                    <td>${record.unscheduledDuration || '0分钟'}</td>
                                    <td><strong>${record.practiceDuration}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

// 计算详细考勤统计
function calculateDetailedAttendanceStats(history) {
    const total = history.length;
    const present = history.filter(h => h.status === 'present' || h.status === 'low_efficiency').length;
    const absent = history.filter(h => h.status === 'absent').length;
    const excused = history.filter(h => h.status === 'excused').length;
    const validDays = history.filter(h => h.status !== 'no-data').length;
    
    const rate = validDays > 0 ? Math.round((present / validDays) * 100) : 0;
    
    return { total, present, absent, excused, rate };
}

// 关闭模态框
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
}

// 点击模态框外部关闭
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
    }
});

// 刷新数据
function refreshData() {
    if (!isOnline) {
        alert(t('msg.sync_required', '需要网络连接才能同步数据'));
        return;
    }
    
    addSyncLog('🔄 ' + t('sync.manual_refresh', '手动刷新数据...'));
    forceRefreshAllData();
}

// 报告相关功能
function initReportsTab() {
    const today = new Date();
    const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('startDate').value = oneWeekAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

// 生成报告
function generateReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert(t('msg.select_dates', '请选择开始和结束日期'));
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert(t('msg.date_range_error', '开始日期不能晚于结束日期'));
        return;
    }
    
    if (!isOnline) {
        generateOfflineReport(startDate, endDate);
        return;
    }
    
    const reportContent = document.getElementById('reportContent');
    reportContent.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    loadReportData(startDate, endDate).then(data => {
        displayReport(data, startDate, endDate);
        addSyncLog(`📊 已生成 ${startDate} 至 ${endDate} 的考勤报告`);
    }).catch(error => {
        reportContent.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">❌</div>
                <div class="empty-state-title">${t('report.generate_failed', '报告生成失败')}</div>
                <div class="empty-state-description">${error.message}</div>
            </div>
        `;
        addSyncLog(`❌ 报告生成失败: ${error.message}`);
    });
}

// 加载报告数据
function loadReportData(startDate, endDate) {
    return new Promise((resolve, reject) => {
        const promises = [];
        const reportData = {};
        
        const current = new Date(startDate);
        const end = new Date(endDate);
        
        while (current <= end) {
            const dateStr = current.toISOString().split('T')[0];
            
            if (attendanceData[dateStr]) {
                reportData[dateStr] = attendanceData[dateStr];
            } else {
                const promise = database.ref(`attendanceData/${dateStr}`).once('value')
                    .then(snapshot => {
                        reportData[dateStr] = snapshot.val() || {};
                    })
                    .catch(error => {
                        console.warn(`加载 ${dateStr} 数据失败:`, error);
                        reportData[dateStr] = {};
                    });
                promises.push(promise);
            }
            
            current.setDate(current.getDate() + 1);
        }
        
        Promise.all(promises).then(() => {
            resolve(reportData);
        }).catch(reject);
    });
}

// 生成离线报告
function generateOfflineReport(startDate, endDate) {
    const reportData = {};
    const current = new Date(startDate);
    const end = new Date(endDate);
    
    while (current <= end) {
        const dateStr = current.toISOString().split('T')[0];
        const localData = localStorage.getItem(`attendance_${dateStr}`);
        reportData[dateStr] = localData ? JSON.parse(localData) : {};
        current.setDate(current.getDate() + 1);
    }
    
    displayReport(reportData, startDate, endDate);
    addSyncLog(`📊 已生成离线报告 ${startDate} 至 ${endDate}`);
}

// 显示报告
function displayReport(data, startDate, endDate) {
    const reportContent = document.getElementById('reportContent');
    
    const analysis = analyzeReportData(data);
    const dateRange = calculateDateRange(startDate, endDate);
    
    let html = `
        <div class="card">
            <h4>${t('report.analysis_title', '📊 考勤分析报告')}</h4>
            <div class="student-details">
                <div class="detail-item">
                    <div class="detail-label">${t('report.period', '统计周期')}</div>
                    <div class="detail-value">${startDate} ${t('report.to', '至')} ${endDate} (${dateRange}${t('report.days', '天')})</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('report.participants', '参与学生')}</div>
                    <div class="detail-value">${analysis.totalStudents}${t('report.people', '人')}</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card present">
                <div class="stat-number">${analysis.totalPresent}</div>
                <div class="stat-label">${t('stats.present', '正常出勤')}</div>
                <div class="stat-description">${analysis.presentRate}%</div>
            </div>
            <div class="stat-card absent">
                <div class="stat-number">${analysis.totalAbsent}</div>
                <div class="stat-label">${t('stats.absent', '缺勤')}</div>
                <div class="stat-description">${analysis.absentRate}%</div>
            </div>
            <div class="stat-card excused">
                <div class="stat-number">${analysis.totalExcused}</div>
                <div class="stat-label">${t('stats.excused', '请假')}</div>
                <div class="stat-description">${analysis.excusedRate}%</div>
            </div>
            <div class="stat-card total">
                <div class="stat-number">${analysis.totalRecords}</div>
                <div class="stat-label">${t('report.total_records', '总记录数')}</div>
                <div class="stat-description">${t('report.all_data', '全部数据')}</div>
            </div>
        </div>

        <div class="card">
            <h4>${t('report.daily_trend', '📈 每日考勤趋势')}</h4>
            <div class="data-table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>${t('report.date', '日期')}</th>
                            <th>${t('report.total', '总人数')}</th>
                            <th>${t('stats.present', '正常出勤')}</th>
                            <th>${t('stats.absent', '缺勤')}</th>
                            <th>${t('stats.excused', '请假')}</th>
                            <th>${t('attendance.rate', '出勤率')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.dailyStats.map(day => `
                            <tr>
                                <td>${day.date}</td>
                                <td>${day.total}</td>
                                <td>${day.present}</td>
                                <td>${day.absent}</td>
                                <td>${day.excused}</td>
                                <td>${day.rate}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h4>${t('report.student_stats', '👥 学生考勤统计')}</h4>
            <div class="data-table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>${t('student.name', '姓名')}</th>
                            <th>${t('student.major', '专业')}</th>
                            <th>${t('stats.present', '正常出勤')}</th>
                            <th>${t('stats.absent', '缺勤')}</th>
                            <th>${t('stats.excused', '请假')}</th>
                            <th>${t('attendance.rate', '出勤率')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.studentStats.map(student => `
                            <tr>
                                <td>${student.name}</td>
                                <td>${student.major}</td>
                                <td>${student.present}</td>
                                <td>${student.absent}</td>
                                <td>${student.excused}</td>
                                <td>${student.rate}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="export-options">
            <button class="btn btn-primary" onclick="generateReport()">
                <span>🔄</span> ${t('report.regenerate', '重新生成')}
            </button>
        </div>
    `;
    
    reportContent.innerHTML = html;
}

// 分析报告数据
function analyzeReportData(data) {
    const studentStats = {};
    const dailyStats = [];
    let totalRecords = 0;
    let totalPresent = 0;
    let totalAbsent = 0;
    let totalExcused = 0;
    
    // 按日期排序
    const sortedDates = Object.keys(data).sort();
    
    sortedDates.forEach(date => {
        const dayData = data[date];
        const students = Object.values(dayData);
        
        const dayPresent = students.filter(s => s.finalAttendanceStatus === 'present').length;
        const dayAbsent = students.filter(s => s.finalAttendanceStatus === 'absent').length;
        const dayExcused = students.filter(s => s.finalAttendanceStatus === 'excused').length;
        const dayTotal = students.length;
        const dayRate = dayTotal > 0 ? Math.round((dayPresent / dayTotal) * 100) : 0;
        
        dailyStats.push({
            date: date,
            total: dayTotal,
            present: dayPresent,
            absent: dayAbsent,
            excused: dayExcused,
            rate: dayRate
        });
        
        totalRecords += dayTotal;
        totalPresent += dayPresent;
        totalAbsent += dayAbsent;
        totalExcused += dayExcused;
        
        // 统计每个学生的数据
        students.forEach(student => {
            if (!studentStats[student.name]) {
                studentStats[student.name] = {
                    name: student.name,
                    major: student.major || t('student.unknown_major', '未知专业'),
                    present: 0,
                    absent: 0,
                    excused: 0,
                    total: 0
                };
            }
            
            const stats = studentStats[student.name];
            stats.total++;
            
            switch (student.finalAttendanceStatus) {
                case 'present':
                    stats.present++;
                    break;
                case 'absent':
                    stats.absent++;
                    break;
                case 'excused':
                    stats.excused++;
                    break;
            }
        });
    });
    
    // 计算学生出勤率
    const studentStatsArray = Object.values(studentStats).map(student => ({
        ...student,
        rate: student.total > 0 ? Math.round((student.present / student.total) * 100) : 0
    })).sort((a, b) => b.rate - a.rate);
    
    const totalStudents = Object.keys(studentStats).length;
    const presentRate = totalRecords > 0 ? Math.round((totalPresent / totalRecords) * 100) : 0;
    const absentRate = totalRecords > 0 ? Math.round((totalAbsent / totalRecords) * 100) : 0;
    const excusedRate = totalRecords > 0 ? Math.round((totalExcused / totalRecords) * 100) : 0;
    
    return {
        totalStudents,
        totalRecords,
        totalPresent,
        totalAbsent,
        totalExcused,
        presentRate,
        absentRate,
        excusedRate,
        dailyStats,
        studentStats: studentStatsArray
    };
}

// 计算日期范围
function calculateDateRange(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    return diffDays;
}

// 同步管理功能
function updateSyncStatus() {
    const statusEl = document.getElementById('syncStatusText');
    
    if (isOnline) {
        statusEl.innerHTML = `
            <div style="color: #27ae60; margin-bottom: 10px;">
                ✅ ${t('sync.connected', '已连接到Firebase数据库')}
            </div>
            <div style="color: #666; font-size: 14px;">
                ${t('sync.realtime', '数据正在实时同步中...')}
            </div>
            <div style="color: #666; font-size: 12px; margin-top: 5px;">
                ${t('sync.last_sync', '最后同步时间: ')}${new Date().toLocaleString()}
            </div>
        `;
    } else {
        statusEl.innerHTML = `
            <div style="color: #e74c3c; margin-bottom: 10px;">
                ❌ ${t('sync.disconnected', '未连接到数据库')}
            </div>
            <div style="color: #f39c12; font-size: 14px;">
                ${t('sync.offline_mode', '当前处于离线模式，部分功能受限')}
            </div>
            <div style="color: #666; font-size: 12px; margin-top: 5px;">
                ${t('sync.check_network', '请检查网络连接')}
            </div>
        `;
    }
}

// 强制同步数据
function forceSyncData() {
    if (!isOnline) {
        alert(t('msg.sync_required', '需要网络连接才能同步数据'));
        return;
    }
    
    addSyncLog('🔄 ' + t('sync.force_start', '开始强制同步...'));
    
    // 清除本地缓存
    Object.keys(localStorage).forEach(key => {
        if (key.startsWith('attendance_') || key === 'realTimePracticeStatus') {
            localStorage.removeItem(key);
        }
    });
    
    // 重新初始化数据
    attendanceData = { realTimePractice: {} };
    studentData = {};
    excuseData = {};
    
    // 强制刷新所有数据
    forceRefreshAllData();
    
    addSyncLog('✅ ' + t('sync.force_complete', '强制同步完成'));
}

// 清除本地缓存
function clearLocalCache() {
    if (!confirm(t('msg.clear_cache_confirm', '确定要清除本地缓存吗？这将删除所有离线数据。'))) {
        return;
    }
    
    // 🔥 修改：清除所有本地存储数据（但实时练琴数据本来就不在本地存储中）
    const keysToRemove = [];
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (
            key.startsWith('attendance_') ||
            key === 'studentData' ||
            key === 'excuseData'
            // 注意：不包含实时练琴相关的键，因为它们已经不存储在本地了
        )) {
            keysToRemove.push(key);
        }
    }
    
    // 批量删除
    keysToRemove.forEach(key => {
        localStorage.removeItem(key);
    });
    
    // 🔥 重置数据
    studentData = {};
    excuseData = {};
    // 清空考勤历史数据，但保留实时练琴数据（因为它在内存中）
    const realTimePractice = attendanceData.realTimePractice; // 备份
    attendanceData = { realTimePractice }; // 重置但保留实时数据
    
    // 清空显示
    document.getElementById('todaySnapshot').innerHTML = '';
    document.getElementById('studentList').innerHTML = '';
    // 不清空练琴状态显示，因为数据仍在内存中
    
    addSyncLog(`🗑️ 已清除 ${keysToRemove.length} 个本地缓存项（实时练琴数据保留在内存中）`);
    alert(t('msg.cache_cleared', '本地缓存已清除'));
    
    // 如果在线，重新加载数据
    if (isOnline) {
        setTimeout(() => {
            forceRefreshAllData();
        }, 1000);
    }
}


// 🔥 保留：预加载最近的考勤数据（这个功能保持不变）
function preloadRecentAttendanceData() {
    if (!isOnline) return;
    
    const promises = [];
    const today = new Date();
    
    // 预加载最近7天的数据
    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        if (!attendanceData[dateStr]) {
            const promise = database.ref(`attendanceData/${dateStr}`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val() || {};
                    attendanceData[dateStr] = data;
                    
                    // 🔥 保留：保存到本地存储
                    try {
                        localStorage.setItem(`attendance_${dateStr}`, JSON.stringify(data));
                    } catch (e) {
                        console.warn('本地存储空间不足:', e);
                    }
                })
                .catch((error) => {
                    console.warn(`预加载 ${dateStr} 数据失败:`, error);
                });
            promises.push(promise);
        }
    }
    
    Promise.all(promises).then(() => {
        addSyncLog(`📥 已预加载最近7天的考勤数据`);
    });
}

// 显示加载状态
function showLoading(containerId) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <div style="margin-top: 10px; color: #666;">${t('msg.loading', '加载中...')}</div>
            </div>
        `;
    }
}

// 显示空状态
function showEmptyState(containerId, title, description) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📋</div>
                <div class="empty-state-title">${title}</div>
                <div class="empty-state-description">${description}</div>
            </div>
        `;
    }
}

// 错误处理
window.addEventListener('error', (event) => {
    console.error('全局错误:', event.error);
    addSyncLog(`❌ 系统错误: ${event.error?.message || '未知错误'}`);
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('未处理的Promise拒绝:', event.reason);
    addSyncLog(`❌ Promise错误: ${event.reason?.message || '未知错误'}`);
});

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 页面开始初始化...');
    
    // 恢复语言偏好
    const savedLanguage = localStorage.getItem('preferred_language');
    if (savedLanguage && savedLanguage !== currentLanguage) {
        switchLanguage(savedLanguage);
    } else {
        updatePageLanguage();
    }
    
    // 设置今天的日期
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = today;
    
    // 🔥 修改：恢复其他本地数据，但不恢复实时练琴状态
    restoreOtherLocalData();
    
    // 🔥 实时练琴状态初始化为空（不使用本地存储）
    attendanceData.realTimePractice = {};
    realTimePracticeStatus = {};
    lastRealTimePracticeHash = '';
    console.log('📱 实时练琴状态已初始化为空状态（不使用本地存储）');
    
    // 初始化Firebase
    initFirebase();
    
    // 初始化实时练琴状态显示
    initPracticeStatusDisplay();
    
    // 更新连接状态
    updateConnectionStatus();
    
    // 更新同步状态
    updateSyncStatus();
    
    // 初始化同步日志显示
    updateSyncLogsDisplay();
    
    // 添加初始化日志
    addSyncLog('🎼 青岛梅纽因学校练琴跟踪系统已启动');
    addSyncLog(`🌐 当前语言: ${currentLanguage === 'zh' ? '中文' : 'English'}`);
    addSyncLog('📱 实时练琴数据仅存储在内存中，考勤历史数据正常缓存');
    
    console.log('✅ 页面初始化完成');
});

/**
 * 恢复其他本地数据（保留考勤历史等）
 */
function restoreOtherLocalData() {
    try {
        // 🔥 保留：恢复学生数据
        const savedStudentData = localStorage.getItem('studentData');
        if (savedStudentData) {
            const studentDataParsed = JSON.parse(savedStudentData);
            if (studentDataParsed && typeof studentDataParsed === 'object') {
                studentData = studentDataParsed;
                console.log('📚 已恢复学生数据');
            }
        }
        
        // 🔥 保留：恢复请假数据
        const savedExcuseData = localStorage.getItem('excuseData');
        if (savedExcuseData) {
            const excuseDataParsed = JSON.parse(savedExcuseData);
            if (excuseDataParsed && typeof excuseDataParsed === 'object') {
                excuseData = excuseDataParsed;
                console.log('📝 已恢复请假数据');
            }
        }
        
        // 🔥 保留：恢复考勤历史数据
        let restoredDates = 0;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('attendance_')) {
                try {
                    const dateStr = key.replace('attendance_', '');
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data && typeof data === 'object') {
                        attendanceData[dateStr] = data;
                        restoredDates++;
                    }
                } catch (error) {
                    console.warn(`恢复考勤数据失败 ${key}:`, error);
                }
            }
        }
        
        if (restoredDates > 0) {
            console.log(`📅 已恢复 ${restoredDates} 天的考勤历史数据`);
        }
        
    } catch (error) {
        console.warn('恢复本地数据失败:', error);
    }
}


// 页面卸载时的清理
window.addEventListener('beforeunload', () => {
    // 清理定时器
    syncTimers.forEach(timer => clearTimeout(timer));
    syncTimers.clear();
    
    if (practiceStatusUpdateTimeout) {
        clearTimeout(practiceStatusUpdateTimeout);
        practiceStatusUpdateTimeout = null;
    }
    
    // 🔥 移除：不再保存实时练琴状态到本地存储
    
    console.log('🧹 页面卸载，实时练琴数据已清理（不保存到本地）');
});


// 网络状态监听
window.addEventListener('online', () => {
    console.log('🌐 网络已连接');
    addSyncLog('🌐 网络连接已恢复');
    
    // 延迟重新初始化Firebase连接
    setTimeout(() => {
        if (!isOnline) {
            initFirebase();
        }
    }, 2000);
});

window.addEventListener('offline', () => {
    console.log('📱 网络已断开');
    addSyncLog('📱 网络连接已断开，切换到离线模式');
    isOnline = false;
    updateConnectionStatus();
    updateSyncStatus();
});

// 导出全局函数供HTML调用
window.switchTab = switchTab;
window.switchLanguage = switchLanguage;
window.loadAttendanceData = loadAttendanceData;
window.refreshData = refreshData;
window.refreshPracticeStatus = refreshPracticeStatus;
window.filterStudents = filterStudents;
window.showStudentDetail = showStudentDetail;
window.closeModal = closeModal;
window.generateReport = generateReport;
window.forceSyncData = forceSyncData;
window.clearLocalCache = clearLocalCache;
window.updateSyncStatus = updateSyncStatus;
window.getStudentRealTimePracticeStatus = getStudentRealTimePracticeStatus;
window.checkAndUpdateRealTimePracticeStatus = checkAndUpdateRealTimePracticeStatus;
window.triggerRealTimePracticeStatusUpdate = triggerRealTimePracticeStatusUpdate;
window.cleanupEndedPracticeStatus = cleanupEndedPracticeStatus;
window.filterPracticeStatus = filterPracticeStatus;
window.setQuickFilter = setQuickFilter;
window.clearPracticeFilters = clearPracticeFilters;


console.log('📜 脚本加载完成，等待DOM初始化...');

</script>
</body>
</html>
