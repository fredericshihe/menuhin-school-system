<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- å…³é”®èµ„æºé¢„åŠ è½½ï¼šæé«˜é¦–å±æ¸²æŸ“é€Ÿåº¦ -->
  <link rel="preload" as="style" href="./index.css" onload="this.rel='stylesheet'">
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
  <!-- å­—ä½“æ˜¾ç¤ºç­–ç•¥ï¼šè‹¥æœ‰è‡ªå®šä¹‰å­—ä½“æ–‡ä»¶ï¼Œå¯åœ¨æ­¤æ·»åŠ  preload + font-display:swap -->
  <!-- <link rel="preload" as="font" href="/fonts/YourFont.woff2" type="font/woff2" crossorigin> -->
  <meta http-equiv="Cache-Control" content="max-age=3600, stale-while-revalidate=600" />
  <meta name="color-scheme" content="light dark">
<meta charset="UTF-8">
<title>é’å²›æ¢…çº½å› éŸ³ä¹å­¦æ ¡ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<style>
/* ===============================================
   é’å²›æ¢…çº½å› éŸ³ä¹å­¦æ ¡ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ - å®Œæ•´ä¼˜åŒ–æ ·å¼æ–‡ä»¶
   =============================================== */

/* ===== 1. CSSå˜é‡å®šä¹‰ ===== */
:root {
  /* æ—¥é—´æ¨¡å¼æ˜¾å¼çŠ¶æ€æ¸å˜ï¼ˆæµ…è‰²å˜ä½“ï¼‰ */
  --gradient-present-light: linear-gradient(135deg, #e6f9ef, #d1f2e0);
  --gradient-absent-light: linear-gradient(135deg, #ffecec, #ffd6d6);
  --gradient-excused-light: linear-gradient(135deg, #fff6e6, #ffe9c7);
  --gradient-primary-light: linear-gradient(135deg, #eef6ff, #dbeeff);
  --gradient-weekend-light: linear-gradient(135deg, #f5f7fa, #eef1f6);

    /* ä¸»è‰²è°ƒ */
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --success-color: #27ae60;
    
    /* èƒŒæ™¯å’Œæ–‡æœ¬ */
    --background-color: #f8f9fa;
    --card-bg: #ffffff;
    --card-hover-bg: #f8f9fa;
    --text-color: #2c3e50;
    --text-secondary: #6c757d;
    --text-muted: #adb5bd;
    --border-color: #dee2e6;
    --light-gray: #f1f3f4;
    --medium-gray: #6c757d;
    --dark-gray: #495057;
    --shadow-color: rgba(0,0,0,0.1);
    
    /* é˜´å½±å’Œåœ†è§’ */
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-hover: 0 5px 20px rgba(0,0,0,0.15);
    --radius: 12px;
    --radius-small: 6px;
    --radius-large: 20px;
  --primary-faint: rgba(52, 152, 219, 0.08);
  --muted-gray: #95a5a6;
    
    /* ç§»åŠ¨ç«¯é€‚é… */
    --mobile-padding: 15px;
    --mobile-font-size: 16px;
    --touch-target-size: 44px;
    
    /* æ¸å˜è‰² */
    --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    --gradient-card: linear-gradient(135deg, #f8f9fa, #ffffff);
  /* çŠ¶æ€å¡ç‰‡ä¸æ¨¡æ€å˜é‡ï¼ˆä¾¿äºä¸»é¢˜åˆ‡æ¢è¦†ç›–ï¼‰ */
  --gradient-present: linear-gradient(135deg, #d4edda, #c3e6cb);
  --gradient-absent: linear-gradient(135deg, #f8d7da, #f5c6cb);
  --gradient-excused: linear-gradient(135deg, #fff3cd, #ffeaa7);
  --gradient-rate: linear-gradient(135deg, #cce7ff, #b3d9ff);
  --gradient-header: linear-gradient(135deg, #f8f9fa, #ffffff);
  --modal-backdrop: rgba(0,0,0,0.5);
  --modal-shadow: 0 20px 50px rgba(0,0,0,0.35);
  --accent-faint: rgba(88, 166, 255, 0.1);
  --overlay-faint: rgba(255,255,255,0.7);
  --accent-faint-2: rgba(88, 166, 255, 0.3);
  --accent-faint-3: rgba(88, 166, 255, 0.4);
  --overlay-faint-strong: rgba(255,255,255,0.8);
  --warning-faint: rgba(243, 156, 18, 0.1);
  --overlay-faint-text: rgba(240, 246, 252, 0.9);
  --modal-backdrop-strong: rgba(0,0,0,0.8);
  --danger-faint: rgba(231, 76, 60, 0.1);
  --danger-faint-2: rgba(231, 76, 60, 0.2);
  --amber-faint: rgba(187, 128, 9, 0.15);
  --overlay-very-faint: rgba(255,255,255,0.1);
  --overlay-faint-2: rgba(240,246,252,0.1);
  /* Hover variants */
  --primary-hover: #2980b9;
  --success-hover: #229954;
  --warning-hover: #e67e22;
  --danger-hover: #c0392b;
  --secondary-hover: #5a6268;
  --on-accent-text: #0d1117;
  --purple-strong: #8250df;
  --amber-strong: #9a6700;
  --muted-dark: #6e7681;
  --muted-light: #8b949e;
}

/* ===== å‰”é™¤ & æ®µå¤– ç»Ÿä¸€å±…ä¸­æ¨¡æ€å¼¹çª—ï¼ˆæµ…è‰²/æ·±è‰²è‡ªé€‚åº”ï¼‰ ===== */
.mini-help-btn{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:4px;border:1px solid var(--border-color,#ccc);background:var(--primary-faint,#eef);color:#007bff;font-size:12px;line-height:1;cursor:pointer;padding:0;margin-left:4px;transition:.15s;}
.mini-help-btn:hover{background:#007bff;color:#fff;border-color:#007bff;}
.mini-help-btn:active{transform:scale(.94);} 

/* å†å²æ’è¡Œæ¦œæ ·å¼ */
.history-modal-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
}

.history-date-select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  background: #fff;
  color: #333;
}

.history-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  table-layout: fixed; /* ğŸ”§ ä¿®å¤ï¼šå›ºå®šè¡¨æ ¼å¸ƒå±€ */
}

.history-table thead tr {
  background: rgba(0,0,0,0.05);
}

.history-table th, .history-table td {
  padding: 8px 6px;
  border: 1px solid #ddd;
  text-align: center;
  vertical-align: middle; /* ğŸ”§ ä¿®å¤ï¼šå‚ç›´å±…ä¸­å¯¹é½ */
  line-height: 1.3; /* ğŸ”§ ä¿®å¤ï¼šè®¾ç½®è¡Œé«˜ */
}

.history-table th {
  font-weight: 600;
  color: #333;
  white-space: nowrap; /* ğŸ”§ ä¿®å¤ï¼šé˜²æ­¢è¡¨å¤´æ¢è¡Œ */
  overflow: hidden;
  text-overflow: ellipsis;
}

/* å†å²è¡¨æ ¼å‰ä¸‰åï¼šé¿å…ç»§æ‰¿ä¸»æ¦œæ ·å¼ */
.history-table tr.rank-1 td { background: rgba(255,215,0,0.15); color: #d1b000; }
.history-table tr.rank-2 td { background: rgba(192,192,192,0.15); color: #b5b5b5; }
.history-table tr.rank-3 td { background: rgba(205,127,50,0.15); color: #b07730; }
/* å»æ‰å†å²è¡¨æ ¼çš„ position/ä¼ªå…ƒç´ å½±å“ */
.history-table tr.rank-1::before, .history-table tr.rank-2::before, .history-table tr.rank-3::before { content: none !important; }
/* è°ƒæ•´å†å²è¡¨æ ¼ç¬¬ä¸€åˆ—(æ’å)å›ºå®šå®½åº¦å¹¶å±…ä¸­ */
.history-table td:first-child, .history-table th:first-child { width:50px; min-width:50px; text-align:center; }
.center-pop-modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:10000;opacity:0;transition:opacity .18s ease;backdrop-filter:blur(2px);}
.center-pop-modal-overlay.show{opacity:1;}
.center-pop-modal{background:#1f2429;color:#f0f6fc;border:1px solid #30363d;border-radius:14px;box-shadow:0 12px 36px rgba(0,0,0,.45);padding:18px 20px 20px;width:min(460px,90vw);max-height:70vh;display:flex;flex-direction:column;position:relative;font-size:13px;line-height:1.55;animation:cpScaleIn .22s cubic-bezier(.32,.72,.33,1);}
.center-pop-modal h4{margin:0 0 10px;font-size:15px;font-weight:600;display:flex;align-items:center;gap:6px;line-height:1.3;}
.center-pop-modal table{width:100%;border-collapse:collapse;margin:0;font-size:13px;table-layout:fixed;}
.center-pop-modal th,.center-pop-modal td{padding:6px 6px;text-align:left;font-weight:400;word-wrap:break-word;hyphens:auto;}
.center-pop-modal th{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.center-pop-modal tr:nth-child(even){background:rgba(255,255,255,0.04);} 
.center-pop-modal .close-btn{position:absolute;top:8px;right:10px;background:transparent;border:none;color:#8b949e;cursor:pointer;font-size:18px;line-height:1;padding:2px;border-radius:6px;}
.center-pop-modal .close-btn:hover{color:#fff;background:rgba(255,255,255,0.08);} 
.center-pop-modal-body{flex:1;min-height:0;overflow:auto;padding-right:2px;}
@keyframes cpScaleIn{from{opacity:0;transform:translateY(6px) scale(.95);}to{opacity:1;transform:translateY(0) scale(1);} }
@media (prefers-color-scheme: light){
  .center-pop-modal{background:#ffffff;color:#24292f;border:1px solid #d0d7de;box-shadow:0 4px 24px rgba(0,0,0,.08),0 0 0 1px rgba(0,0,0,.03);} 
  .center-pop-modal tr:nth-child(even){background:#f6f8fa;} 
  .center-pop-modal .close-btn{color:#666;}
  .center-pop-modal .close-btn:hover{color:#000;background:rgba(0,0,0,0.06);} 
}
/* å°å±é€‚é… */
@media (max-width:520px){
  .center-pop-modal{width:92vw;padding:16px 16px 18px;border-radius:12px;}
  .center-pop-modal h4{font-size:14px;margin-bottom:8px;}
  .center-pop-modal th,.center-pop-modal td{padding:5px 6px;}
}

/* ===== ğŸ… æ’è¡Œæ¦œæ ·å¼ ===== */
.leaderboard-container {
  background: linear-gradient(135deg, #fafbfc 0%, #f1f3f7 100%);
  border-radius: 20px;
  padding: 28px;
  box-shadow: 
    0 8px 32px rgba(71, 85, 105, 0.08),
    0 1px 2px rgba(71, 85, 105, 0.06);
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(148, 163, 184, 0.12);
}

.leaderboard-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: none;
  pointer-events: none;
}

.leaderboard-title {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 32px;
  font-weight: 700;
  margin: 0;
  text-align: center;
  position: relative;
  letter-spacing: -0.5px;
  line-height: 1.2;
  text-shadow: none;
}

.leaderboard-title-container {
  text-align: center;
  margin-bottom: 24px;
  position: relative;
  padding: 20px 24px;
  background: transparent;
  border: none;
  border-radius: 0;
  box-shadow: none;
}

/* æ’è¡Œæ¦œå³ä¸Šè§’å†å²æŒ‰é’® */
.leaderboard-history-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 40px;
  height: 40px;
  border-radius: 10px;
  border: 2px solid rgba(102, 126, 234, 0.3);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #ffffff;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25), 0 2px 4px rgba(102, 126, 234, 0.15);
}

.leaderboard-history-btn:hover {
  background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
  border-color: rgba(102, 126, 234, 0.5);
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.35), 0 4px 8px rgba(102, 126, 234, 0.2);
}

.leaderboard-history-btn:active {
  background: linear-gradient(135deg, #4c51bf 0%, #553c9a 100%);
  transform: translateY(-1px) scale(1.02);
}

@keyframes goldShimmer {
  0%, 100% { 
    background-position: 0% 50%; 
    text-shadow: 0 3px 6px rgba(0,0,0,0.4), 0 0 20px rgba(255,215,0,0.3);
  }
  50% { 
    background-position: 100% 50%; 
    text-shadow: 0 3px 6px rgba(0,0,0,0.4), 0 0 30px rgba(255,215,0,0.6);
  }
}

/* 442æµ‹è¯„ä½“ç³»ç‰¹è‰²æ ·å¼ */
.evaluation-system-btn {
    background: rgba(255,255,255,0.1) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15) !important;
}

.evaluation-system-btn:hover {
    background: rgba(255,255,255,0.2) !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.25) !important;
}

/* æ’è¡Œæ¦œæŒ‰é’®åŒºåŸŸï¼ˆå›ºå®šæ’åˆ—ï¼Œé€‚åº”æ‰€æœ‰å°ºå¯¸ï¼‰ */
.leaderboard-action-bar {
  display:flex;
  align-items:stretch;
  position:relative;
  gap:16px;
  margin-bottom:14px;
  flex-wrap:nowrap;
  min-height:42px;
}
.leaderboard-action-bar .lb-left,
.leaderboard-action-bar .lb-center,
.leaderboard-action-bar .lb-right {display:flex;align-items:stretch;}
.leaderboard-action-bar .lb-left {flex:0 0 200px;justify-content:flex-start;}
.leaderboard-action-bar .lb-center {flex:1 1 auto;justify-content:center;}
.leaderboard-action-bar .lb-right {flex:0 0 200px;gap:12px;justify-content:flex-end;}

/* å½“lb-rightåªæœ‰å±•å¼€å…¨éƒ¨æŒ‰é’®æ—¶ï¼Œç¡®ä¿å±…ä¸­ */
.leaderboard-action-bar .lb-right:has(.lb-expand:only-child) {
  justify-content:center;
}

/* é€šç”¨çš„å±•å¼€å…¨éƒ¨æŒ‰é’®å±…ä¸­æ ·å¼ */
.leaderboard-action-bar .lb-expand {
  margin:0 auto;
  padding: 0 16px;
  height: 36px;
  font-size: 12px;
  min-width: 80px;
}

.leaderboard-status {display:flex;align-items:center;padding:0 14px;font-size:13px;color:#6b7280;}
.leaderboard-status.minimal {padding:4px 2px 6px 2px;background:none;border:none;backdrop-filter:none;height:auto;justify-content:flex-start;margin:0 0 2px 2px;}

.leaderboard-btn {display:inline-flex;align-items:center;justify-content:center;gap:4px;padding:0 24px;height:44px;font-size:14px;font-weight:600;border-radius:12px;transition:all .3s ease;border:1px solid rgba(148, 163, 184, 0.2);background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;box-shadow:0 4px 12px rgba(102, 126, 234, 0.25), 0 2px 4px rgba(102, 126, 234, 0.15);} 
.leaderboard-btn.lb-refresh {background:linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);box-shadow:0 4px 12px rgba(78, 205, 196, 0.25), 0 2px 4px rgba(78, 205, 196, 0.15);}
.leaderboard-btn.lb-info {background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border:2px solid rgba(102, 126, 234, 0.2);color:#374151;font-weight:600;min-width:240px;box-shadow:0 6px 16px rgba(71, 85, 105, 0.12), 0 3px 6px rgba(71, 85, 105, 0.08);}
.leaderboard-btn.lb-expand {background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);border:2px solid rgba(102, 126, 234, 0.15);color:#475569;font-weight:600;box-shadow:0 4px 12px rgba(71, 85, 105, 0.1), 0 2px 4px rgba(71, 85, 105, 0.06);}
.leaderboard-btn:hover {transform:translateY(-3px);box-shadow:0 8px 20px rgba(102, 126, 234, 0.35), 0 4px 8px rgba(102, 126, 234, 0.2);} 
.leaderboard-btn.lb-info:hover {background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-color:rgba(102, 126, 234, 0.4);color:#1e293b;box-shadow:0 10px 24px rgba(71, 85, 105, 0.15), 0 4px 8px rgba(71, 85, 105, 0.1);}
.leaderboard-btn.lb-expand:hover {background:linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);border-color:rgba(102, 126, 234, 0.25);color:#334155;transform:translateY(-2px);box-shadow:0 8px 20px rgba(71, 85, 105, 0.12), 0 4px 8px rgba(71, 85, 105, 0.08);}
.leaderboard-btn:active {transform:translateY(-1px);box-shadow:0 4px 8px rgba(102, 126, 234, 0.3), 0 2px 4px rgba(102, 126, 234, 0.2);} 

/* å“åº”å¼è°ƒæ•´ - ä¿æŒåŸæœ‰æ’åˆ—æ–¹å¼ï¼Œä»…è°ƒæ•´å°ºå¯¸å’Œé—´è· */
@media (max-width: 880px){
  .leaderboard-action-bar {gap:12px;}
  .leaderboard-action-bar .lb-left {flex:0 0 150px;}
  .leaderboard-action-bar .lb-right {flex:0 0 150px;}
  .leaderboard-status {padding:0 10px;font-size:12px;}
  .leaderboard-btn {padding:0 16px;font-size:13px;height:38px;}
  .leaderboard-btn.lb-info {min-width:180px;}
  .leaderboard-btn.lb-expand {padding:0 14px;height:30px;font-size:11px;min-width:70px;top:8px;right:0;}
  
  /* å†å²æŒ‰é’®è°ƒæ•´ */
  .leaderboard-history-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
}
@media (max-width: 560px){
  .leaderboard-action-bar {gap:8px;}
  .leaderboard-action-bar .lb-left {flex:0 0 100px;}
  .leaderboard-action-bar .lb-right {flex:0 0 100px;}
  .leaderboard-status {padding:0 8px;font-size:11px;}
  .leaderboard-btn {padding:0 12px;font-size:12px;height:36px;}
  .leaderboard-btn.lb-info {min-width:150px;}
  .leaderboard-btn.lb-expand {padding:0 12px;height:28px;font-size:10px;min-width:60px;top:6px;right:0;}
  
  /* å°å±å¹•å†å²æŒ‰é’®è°ƒæ•´ */
  .leaderboard-history-btn {
    width: 28px;
    height: 28px;
    font-size: 12px;
  }
}
@media (max-width: 380px){
  .leaderboard-action-bar .lb-left {flex:0 0 80px;}
  .leaderboard-action-bar .lb-right {flex:0 0 80px;}
  .leaderboard-btn {font-size:12px;height:40px;padding:0 12px;}
  .leaderboard-btn.lb-expand {padding:0 10px;height:26px;font-size:10px;min-width:55px;top:5px;right:0;}
  .leaderboard-btn.lb-info {min-width:120px;font-size:11px;}
  .leaderboard-status {font-size:12px;padding:0 10px;height:40px;}
  
  /* è¶…å°å±å¹•å†å²æŒ‰é’® */
  .leaderboard-history-btn {
    width: 26px;
    height: 26px;
    font-size: 11px;
  }
}
.system-highlight {
  background: linear-gradient(45deg, rgba(255,215,0,0.15), rgba(255,165,0,0.1));
  border: 1px solid rgba(255,215,0,0.3);
  border-radius: 8px;
  padding: 12px 16px;
  margin: 8px 0;
  position: relative;
  overflow: hidden;
}

.system-highlight::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,215,0,0.1), transparent);
  animation: sweep 3s ease-in-out infinite;
}

@keyframes sweep {
  0% { left: -100%; }
  50% { left: 100%; }
  100% { left: 100%; }
}

.leaderboard-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 
    0 6px 24px rgba(71, 85, 105, 0.06),
    0 2px 8px rgba(71, 85, 105, 0.04);
  position: relative;
  z-index: 1;
  table-layout: fixed;
  border: 1px solid rgba(148, 163, 184, 0.08);
}

.leaderboard-table thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.leaderboard-table th {
  padding: 16px 12px;
  font-weight: 600;
  color: white;
  text-align: center;
  font-size: 14px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  border: none;
}

/* å›ºå®šåˆ—å®½åˆ†é…ï¼Œç¡®ä¿ä¸å—ä¸Šæ–¹æŒ‰é’®å½±å“ */
.leaderboard-table th:nth-child(1) { width: 60px; }  /* æ’å */
.leaderboard-table th:nth-child(2) { width: auto; }  /* å§“å */
.leaderboard-table th:nth-child(3) { width: 15%; }   /* å¹´çº§ */
.leaderboard-table th:nth-child(4) { width: 20%; }   /* ä¸“ä¸š */
.leaderboard-table th:nth-child(5) { width: 120px; } /* æ€»åˆ† */

/* è¡¨æ ¼å®¹å™¨ç‹¬ç«‹å¸ƒå±€ï¼Œä¸å—ä¸Šæ–¹æŒ‰é’®å½±å“ */
.table-responsive {
  width: 100%;
  margin: 0 auto;
  position: relative;
}

/* å…¨éƒ¨å±•å¼€æŒ‰é’® - å®šä½åˆ°è¡¨æ ¼æ ‡é¢˜è¡Œå³ä¾§ï¼Œä¸è¡¨æ ¼å³è¾¹ç¼˜å¯¹é½ */
.leaderboard-btn.lb-expand {
  position: absolute;
  top: 10px;
  right: 0;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  color: #6b7280;
  font-weight: 500;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  z-index: 10;
}

.leaderboard-table tbody tr {
  transition: all 0.3s ease;
  border-bottom: 1px solid rgba(148, 163, 184, 0.08);
  background: #ffffff;
}

.leaderboard-table tbody tr:nth-child(even) {
  background: rgba(248, 250, 252, 0.6);
}

.leaderboard-table tbody tr:hover {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.06) 0%, rgba(118, 75, 162, 0.04) 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(71, 85, 105, 0.12), 0 2px 6px rgba(71, 85, 105, 0.06);
}

.leaderboard-table td {
  padding: 16px 12px;
  text-align: center;
  font-size: 14px;
  border: none;
  position: relative;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* TDå•å…ƒæ ¼ä¹Ÿåº”ç”¨ç›¸åŒçš„å®½åº¦çº¦æŸ */
.leaderboard-table td:nth-child(1) { width: 60px; }  /* æ’å */
.leaderboard-table td:nth-child(2) { width: auto; }  /* å§“å */
.leaderboard-table td:nth-child(3) { width: 15%; }   /* å¹´çº§ */
.leaderboard-table td:nth-child(4) { width: 20%; }   /* ä¸“ä¸š */
.leaderboard-table td:nth-child(5) { width: 120px; } /* æ€»åˆ† */

/* æ’åæ ·å¼ - é‡æ–°è®¾è®¡ä¸ºç®€æ´ç¾è§‚é£æ ¼ */
.rank-cell {
  font-weight: 600;
  font-size: 16px;
  width: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 36px;
  border-radius: 10px;
  margin: 4px auto;
  transition: all 0.3s ease;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  color: #475569;
  border: 1px solid rgba(148, 163, 184, 0.15);
  box-shadow: 0 2px 6px rgba(71, 85, 105, 0.08), 0 1px 2px rgba(71, 85, 105, 0.05);
}

/* å‰ä¸‰åç‰¹æ®Šæ ·å¼ - ç°ä»£ç®€çº¦è®¾è®¡ */
.leaderboard-table .rank-1 {
  background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
  color: #92400e;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(255, 215, 0, 0.35), 0 2px 4px rgba(255, 215, 0, 0.2);
  position: relative;
  border: 2px solid rgba(255, 215, 0, 0.4);
}

.leaderboard-table .rank-1::before {
  content: '1';
  font-size: 18px;
  font-weight: 800;
}

.leaderboard-table .rank-2 {
  background: linear-gradient(135deg, #c0c0c0 0%, #e5e5e5 100%);
  color: #374151;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(192, 192, 192, 0.35), 0 2px 4px rgba(192, 192, 192, 0.2);
  border: 2px solid rgba(192, 192, 192, 0.4);
}

.leaderboard-table .rank-2::before {
  content: '2';
  font-size: 16px;
  font-weight: 800;
}

.leaderboard-table .rank-3 {
  background: linear-gradient(135deg, #cd7f32 0%, #e5a55a 100%);
  color: #92400e;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(205, 127, 50, 0.35), 0 2px 4px rgba(205, 127, 50, 0.2);
  border: 2px solid rgba(205, 127, 50, 0.4);
}

.leaderboard-table .rank-3::before {
  content: '3';
  font-size: 16px;
  font-weight: 800;
}

/* æ™®é€šæ’åæ ·å¼ */
.rank-cell:not(.rank-1):not(.rank-2):not(.rank-3) {
  background: #f3f4f6;
  color: #6b7280;
  font-weight: 600;
}

/* å‰ä¸‰åæ•´è¡Œæ•ˆæœ - æ›´ç²¾ç»†çš„èƒŒæ™¯è®¾è®¡ */
.leaderboard-table tbody tr.top-1 {
  background: linear-gradient(90deg, rgba(255, 215, 0, 0.12), rgba(255, 215, 0, 0.06));
  border-left: 4px solid #ffd700;
  box-shadow: inset 0 1px 0 rgba(255, 215, 0, 0.2);
}

.leaderboard-table tbody tr.top-2 {
  background: linear-gradient(90deg, rgba(192, 192, 192, 0.12), rgba(192, 192, 192, 0.06));
  border-left: 4px solid #c0c0c0;
  box-shadow: inset 0 1px 0 rgba(192, 192, 192, 0.2);
}

.leaderboard-table tbody tr.top-3 {
  background: linear-gradient(90deg, rgba(205, 127, 50, 0.12), rgba(205, 127, 50, 0.06));
  border-left: 4px solid #cd7f32;
  box-shadow: inset 0 1px 0 rgba(205, 127, 50, 0.2);
}

/* åˆ†æ•°æ ·å¼ */
.score-cell {
  font-weight: 700;
  font-size: 16px;
  position: relative;
}

/* å‘¨æœ«æé†’æ ·å¼ */
.leaderboard-table tbody tr.weekend-notice {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.06));
  border: none;
}

.leaderboard-table tbody tr.weekend-notice:hover {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.06));
  transform: none;
  box-shadow: none;
}

.score-excellent {
  color: #10b981;
  text-shadow: 0 1px 2px rgba(16,185,129,0.2);
}

.score-good {
  color: #3b82f6;
}

.score-average {
  color: #f59e0b;
}

.score-poor {
  color: #ef4444;
}

/* é«˜åˆ†æ®µç‰¹æ•ˆ */
.top-1 .score-cell::after {
  content: 'âœ¨';
  position: absolute;
  right: -20px;
  top: 50%;
  transform: translateY(-50%);
  animation: sparkle 2s ease-in-out infinite;
}

@keyframes sparkle {
  0%, 100% { opacity: 0.6; transform: translateY(-50%) scale(1); }
  50% { opacity: 1; transform: translateY(-50%) scale(1.2); }
}

/* å§“åæ ·å¼ */
.name-cell {
  font-weight: 600;
  text-align: left;
}

.top-1 .name-cell {
  color: #b8860b;
  font-weight: 700;
}

.top-2 .name-cell {
  color: #708090;
  font-weight: 700;
}

.top-3 .name-cell {
  color: #8b4513;
  font-weight: 700;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .leaderboard-container {
    padding: 16px;
    border-radius: 12px;
  }
  
  .leaderboard-title-container {
    margin-bottom: 16px;
    padding: 16px 20px;
  }
  
  .leaderboard-title {
    font-size: 24px;
  }
  
  .leaderboard-history-btn {
    width: 32px;
    height: 32px;
    top: 10px;
    right: 10px;
    font-size: 13px;
  }
  
  .leaderboard-table th,
  .leaderboard-table td {
    padding: 12px 8px;
    font-size: 13px;
  }
  
  .rank-cell {
    font-size: 16px;
    width: 60px;
  }
  
  .score-cell {
    font-size: 14px;
  }
}

@media (prefers-color-scheme: dark) {
  /* æ·±è‰²æ¨¡å¼ä¸‹çš„è‡ªä¸»ç»ƒç´çŠ¶æ€å¡ç‰‡æ ·å¼ */
  .today-status-card.self-practice,
  .today-status-card.practicing-unscheduled {
    background: rgba(126,63,242,0.12) !important;
    border-left-color: #9c7ff2 !important;
    box-shadow: 0 3px 12px rgba(126,63,242,0.25) !important;
  }
  
  .stats-grid-detailed .stat-item.self-practice {
    background: rgba(126,63,242,0.12) !important;
    border: 1px solid rgba(126,63,242,0.3) !important;
    box-shadow: 0 4px 16px rgba(126,63,242,0.2) !important;
  }

  /* æ·±è‰²æ¨¡å¼ä¸‹çš„è‡ªä¸»ç»ƒç´çŠ¶æ€å¾½ç« æ ·å¼ */
  .status-badge.self-practice, 
  .status-badge.practicing-unscheduled {
    background: rgba(126,63,242,0.2) !important;
    color: #e4d5ff !important;
    border: 1px solid rgba(126,63,242,0.4) !important;
    font-weight: 600 !important;
    font-size: 0.75rem !important;
    box-shadow: 0 3px 8px rgba(126,63,242,0.25) !important;
  }

  /* æ·±è‰²æ¨¡å¼ä¸‹çš„è‡ªä¸»ç»ƒç´å­¦ç”ŸçŠ¶æ€æ ‡ç­¾æ ·å¼ */
  .student-status.self-practice,
  .student-status-compact.self-practice {
    background: rgba(126,63,242,0.2) !important;
    color: #e4d5ff !important;
    border: 1px solid rgba(126,63,242,0.4) !important;
    font-weight: 600 !important;
    font-size: 0.75rem !important;
    box-shadow: 0 3px 8px rgba(126,63,242,0.25) !important;
  }

  /* æ’è¡Œæ¦œå®¹å™¨æ·±è‰²æ¨¡å¼ */
  .leaderboard-container {
    background: #1f2937;
  }
  
  /* æ’è¡Œæ¦œæ ‡é¢˜æ·±è‰²æ¨¡å¼ */
  .leaderboard-title {
    background: none !important;
    -webkit-background-clip: unset !important;
    -webkit-text-fill-color: #ffffff !important;
    background-clip: unset !important;
    color: #ffffff !important;
  }
  
  /* æ·±è‰²æ¨¡å¼æ— éœ€é¢å¤–ä¿®æ”¹ï¼Œä¿æŒé»˜è®¤æ ·å¼ */
  
  /* æ’è¡Œæ¦œè¡¨æ ¼æ·±è‰²æ¨¡å¼ */
  .leaderboard-table {
    background: #1f2937;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  
  .leaderboard-table thead {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  }
  
  .leaderboard-table th {
    color: #f0f6fc;
    text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  }
  
  .leaderboard-table tbody tr {
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  
  .leaderboard-table tbody tr:hover {
    background: rgba(59,130,246,0.12);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .leaderboard-table td {
    color: #f0f6fc;
  }
  
  /* æ’åå•å…ƒæ ¼æ·±è‰²æ¨¡å¼ - ä¿æŒç®€æ´è®¾è®¡ */
  .leaderboard-table .rank-1 {
    background: #fbbf24 !important;
    color: #92400e !important;
    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4) !important;
  }
  
  .leaderboard-table .rank-2 {
    background: #9ca3af !important;
    color: #1f2937 !important;
    box-shadow: 0 2px 8px rgba(156, 163, 175, 0.4) !important;
  }
  
  .leaderboard-table .rank-3 {
    background: #f59e0b !important;
    color: #92400e !important;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4) !important;
  }
  
  /* æ™®é€šæ’åæ·±è‰²æ¨¡å¼ */
  .rank-cell:not(.rank-1):not(.rank-2):not(.rank-3) {
    background: #374151 !important;
    color: #d1d5db !important;
  }
  
  /* å‰ä¸‰åè¡Œæ•ˆæœæ·±è‰²æ¨¡å¼ */
  .leaderboard-table tbody tr.top-1 {
    background: linear-gradient(90deg, rgba(251,191,36,0.12), rgba(251,191,36,0.06)) !important;
    border-left: 3px solid #fbbf24 !important;
  }
  
  .leaderboard-table tbody tr.top-2 {
    background: linear-gradient(90deg, rgba(156,163,175,0.12), rgba(156,163,175,0.06)) !important;
    border-left: 3px solid #9ca3af !important;
  }
  
  .leaderboard-table tbody tr.top-3 {
    background: linear-gradient(90deg, rgba(245,158,11,0.12), rgba(245,158,11,0.06)) !important;
    border-left: 3px solid #f59e0b !important;
  }
  
  /* å§“åå•å…ƒæ ¼æ·±è‰²æ¨¡å¼ */
  .name-cell {
    color: #f0f6fc;
  }
  
  .top-1 .name-cell {
    color: #fbbf24;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  
  .top-2 .name-cell {
    color: #d1d5db;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  
  .top-3 .name-cell {
    color: #ea580c;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  
  /* åˆ†æ•°å•å…ƒæ ¼æ·±è‰²æ¨¡å¼ */
  .score-excellent {
    color: #10b981;
    text-shadow: 0 1px 2px rgba(16,185,129,0.3);
  }
  
  .score-good {
    color: #60a5fa;
  }
  
  .score-average {
    color: #fbbf24;
  }
  
  .score-poor {
    color: #f87171;
  }
  
  /* æŒ‰é’®åŒºåŸŸæ·±è‰²æ¨¡å¼ */
  .leaderboard-btn {
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 2px 4px rgba(0,0,0,0.4);
  }
  
  .leaderboard-btn.lb-info {
    background: #374151 !important;
    border: 1px solid #4b5563 !important;
    color: #f9fafb !important;
  }
  
  .leaderboard-btn.lb-info:hover {
    background: #4b5563 !important;
    border-color: #6b7280 !important;
  }
  
  /* çŠ¶æ€æ–‡å­—æ·±è‰²æ¨¡å¼ */
  .leaderboard-status {
    color: #d1d5db !important;
  }
  
  /* å±•å¼€æŒ‰é’®æ·±è‰²æ¨¡å¼ - ä½è°ƒæ ·å¼ */
  .leaderboard-btn.lb-expand {
    background: #374151 !important;
    border: 1px solid #4b5563 !important;
    color: #9ca3af !important;
  }
  
  .leaderboard-btn.lb-expand:hover {
    background: #4b5563 !important;
    border-color: #6b7280 !important;
    color: #d1d5db !important;
  }
  
  .leaderboard-btn.lb-history {
    background: linear-gradient(135deg,rgba(255,152,0,0.9),rgba(251,140,0,0.8));
  }
  
  /* æ’è¡Œæ¦œå³ä¸Šè§’å†å²æŒ‰é’®æ·±è‰²æ¨¡å¼ */
  .leaderboard-history-btn {
    background: linear-gradient(135deg,rgba(255,152,0,0.9),rgba(251,140,0,0.8));
    border: 1px solid rgba(255,152,0,0.4);
  }
  
  .leaderboard-history-btn:hover {
    background: linear-gradient(135deg,rgba(255,152,0,1),rgba(251,140,0,0.9));
  }
  
  .leaderboard-btn:hover {
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }
  
  /* çŠ¶æ€æ–‡å­—æ·±è‰²æ¨¡å¼ */
  .leaderboard-status {
    color: rgba(255,255,255,0.75);
  }
  
  .leaderboard-status.minimal {
    color: rgba(255,255,255,0.65);
  }
  
  /* å¸®åŠ©æŒ‰é’®æ·±è‰²æ¨¡å¼ */
  .mini-help-btn {
    background: rgba(255,255,255,0.12) !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    color: rgba(255,255,255,0.85) !important;
  }
  
  /* å†å²æ’è¡Œæ¦œæ·±è‰²æ¨¡å¼ */
  .history-modal-label {
    color: rgba(255,255,255,0.9);
  }
  
  .history-date-select {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.9);
  }
  
  .history-table th {
    color: rgba(255,255,255,0.9);
    background: rgba(255,255,255,0.08);
  }
  
  .history-table th, .history-table td {
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.85);
    padding: 8px 6px; /* ğŸ”§ ä¿®å¤ï¼šç¡®ä¿æ·±è‰²æ¨¡å¼ä¸‹çš„å†…è¾¹è·ä¸€è‡´ */
  }
  
  .history-table .rank-1 {
    background: rgba(255, 215, 0, 0.25); /* ğŸ”§ ä¿®å¤ï¼šå¢å¼ºå¯¹æ¯”åº¦ */
    color: rgba(255,255,255,0.95);
  }
  
  .history-table .rank-2 {
    background: rgba(192, 192, 192, 0.25); /* ğŸ”§ ä¿®å¤ï¼šå¢å¼ºå¯¹æ¯”åº¦ */
    color: rgba(255,255,255,0.95);
  }
  
  .history-table .rank-3 {
    background: rgba(205, 127, 50, 0.25); /* ğŸ”§ ä¿®å¤ï¼šå¢å¼ºå¯¹æ¯”åº¦ */
    color: rgba(255,255,255,0.95);
  }
  
  .mini-help-btn:hover {
    background: rgba(255,255,255,0.18) !important;
    border-color: rgba(255,255,255,0.3) !important;
  }
}

/* ===== ğŸ”¥ å…¨å±€æ€§èƒ½ä¼˜åŒ– - ç§»åŠ¨ç«¯åŠ¨ç”»æ€§èƒ½ ===== */
@media (max-width: 768px) {
  /* å…¨å±€GPUåŠ é€Ÿ */
  * {
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }
  
  /* ä¼˜åŒ–æ¨¡æ€æ¡†åŠ¨ç”»å…ƒç´  */
  .modal,
  .modal-content {
    will-change: transform, opacity;
    transform: translateZ(0);
    -webkit-perspective: 1000px;
    perspective: 1000px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  /* ğŸ”¥ ç§»åŠ¨ç«¯å®Œå…¨ç¦ç”¨é®ç½©æ•ˆæœ */
  .modal.show {
    background: transparent !important;
    backdrop-filter: none !important;
  }
  
  .modal.hiding {
    background: transparent !important;
    backdrop-filter: none !important;
  }
}

@media (max-width: 480px) {
  /* ğŸ”¥ å°å±å¹•å®Œå…¨æ— é®ç½© */
  .modal.show {
    backdrop-filter: none !important;
    background: transparent !important;
  }
  
  .modal.hiding {
    backdrop-filter: none !important;
    background: transparent !important;
  }
}

/* ===== ğŸ”¥ ä½æ€§èƒ½è®¾å¤‡ä¼˜åŒ– ===== */
@media (prefers-reduced-motion: reduce) {
  .modal,
  .modal-content {
    animation-duration: 0.2s !important;
    transition-duration: 0.2s !important;
  }
}

/* æ—¥é—´æ¨¡å¼ - å¼ºåŒ–çŠ¶æ€å¡ç‰‡é¢œè‰²ï¼ˆæ›´æ˜æ˜¾çš„è‰²å—/æ¸å˜ï¼‰ */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  /* æ›´æ˜æ˜¾çš„è‰²å—ä¸æ¸å˜ï¼Œå¢å¼ºå¯è§†åŒºåˆ† */
  :root {
    --status-present-bg: #e9faf0;
    --status-present-accent: #27ae60;
    --status-present-gradient-strong: linear-gradient(135deg, #e9faf0, #c9f2d6);
    --status-absent-bg: #fff0f0;
    --status-absent-accent: #e74c3c;
    --status-absent-gradient-strong: linear-gradient(135deg, #fff0f0, #ffd6d6);
    --status-excused-bg: #fff9ed;
    --status-excused-accent: #f39c12;
    --status-excused-gradient-strong: linear-gradient(135deg, #fff9ed, #ffecce);
    --status-low-eff-bg: #fff8e6;
    --status-low-eff-accent: #dbae00;
    --status-low-eff-gradient-strong: linear-gradient(135deg, #fff8e6, #ffe8b3);
  }

  /* å¼ºåˆ¶é¢œè‰²æŒ‰éœ€æ±‚åŒ¹é… */
  .today-status-card.present { background: #e9faf0 !important; border-left-color: #27ae60 !important; color: var(--text-color) !important; }
  .today-status-card.absent { background: #fff0f0 !important; border-left-color: #e74c3c !important; color: var(--text-color) !important; }
  .today-status-card.low-efficiency { background: #fff8e6 !important; border-left-color: #dbae00 !important; color: var(--text-color) !important; }
  .today-status-card.excused { background: #fff9ed !important; border-left-color: #f39c12 !important; color: var(--text-color) !important; }
  .today-status-card.self-practice, .today-status-card.practicing-unscheduled { background: #ede4ff !important; border-left-color: #7e3ff2 !important; color: var(--text-color) !important; box-shadow: 0 2px 8px rgba(126,63,242,0.15) !important; }
  .today-status-card.pending, .today-status-card.waiting { background: #f5f7fa !important; border-left-color: #dfe6ec !important; color: var(--text-color) !important; }

  .status-badge.present { background: #e9faf0 !important; color: #27ae60 !important; border-color: transparent !important; }
  .status-badge.absent { background: #fff0f0 !important; color: #e74c3c !important; border-color: transparent !important; }
  .status-badge.excused { background: #fff9ed !important; color: #f39c12 !important; border-color: transparent !important; }
  .status-badge.low-efficiency { background: #fff8e6 !important; color: #dbae00 !important; border-color: transparent !important; }
  .status-badge.self-practice, .status-badge.practicing-unscheduled { background: #ede4ff !important; color: #7e3ff2 !important; border: 1px solid rgba(126,63,242,0.15) !important; font-weight: 600 !important; box-shadow: 0 2px 6px rgba(126,63,242,0.12) !important; }
  .status-badge.pending, .status-badge.waiting { background: #f5f7fa !important; color: #6c757d !important; border-color: transparent !important; }

  /* ä»…ä¿®æ”¹ç»Ÿè®¡æ±‡æ€»å®¹å™¨çš„èƒŒæ™¯ä¸å½¢çŠ¶ï¼Œä¸ä¿®æ”¹æ–‡æœ¬é¢œè‰²æˆ–è¾¹æ¡† */
  .stats-grid-detailed .stat-item.present { background: #e9faf0 !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.absent { background: #fff0f0 !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.excused { background: #fff9ed !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.low-efficiency { background: #fff8e6 !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.self-practice { background: #ede4ff !important; border-radius: 12px !important; box-shadow: 0 2px 8px rgba(126,63,242,0.15) !important; }
}

/* ===== 2. åŸºç¡€é‡ç½®å’Œå…¨å±€æ ·å¼ ===== */
/* æ—¥é—´æ¨¡å¼ï¼šå¼ºåŒ–å‡ºå‹¤/ç¼ºå‹¤/ä½æ•ˆ/è¯·å‡å››ç±»å¡ç‰‡ï¼Œå¢åŠ è¾¹æ¡†ã€å›¾æ ‡å’Œæ•°å­—å¼ºè°ƒ */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  /* å‡ºå‹¤ - ç»¿è‰² */
  .stats-grid-detailed .stat-item.present,
  .today-status-card.present {
    background: var(--status-present-gradient-strong);
    box-shadow: 0 6px 18px rgba(39,174,96,0.04);
  }
  .stats-grid-detailed .stat-item.present .stat-icon,
  .today-status-card.present .metric-icon {
    background: rgba(39,174,96,0.08);
    color: var(--status-present-accent);
  }
  .stats-grid-detailed .stat-item.present .stat-number {
    color: var(--status-present-accent);
  }

  /* ç¼ºå‹¤ - çº¢è‰² */
  .stats-grid-detailed .stat-item.absent,
  .today-status-card.absent {
    background: var(--status-absent-gradient-strong);
    box-shadow: 0 6px 18px rgba(231,76,60,0.04);
  }
  .stats-grid-detailed .stat-item.absent .stat-icon,
  .today-status-card.absent .metric-icon {
    background: rgba(231,76,60,0.06);
    color: var(--status-absent-accent);
  }
  .stats-grid-detailed .stat-item.absent .stat-number {
    color: var(--status-absent-accent);
  }

  /* ä½æ•ˆ - é»„è‰²/æ©™è‰² */
  .stats-grid-detailed .stat-item.low-efficiency,
  .today-status-card.low-efficiency {
    background: var(--status-low-eff-gradient-strong);
    box-shadow: 0 6px 18px rgba(219,150,0,0.04);
  }
  .stats-grid-detailed .stat-item.low-efficiency .stat-icon,
  .today-status-card.low-efficiency .metric-icon {
    background: rgba(219,150,0,0.06);
    color: var(--status-low-eff-accent);
  }
  .stats-grid-detailed .stat-item.low-efficiency .stat-number {
    color: var(--status-low-eff-accent);
  }

  /* è¯·å‡ - æ©™é»„ (excused) */
  .stats-grid-detailed .stat-item.excused,
  .today-status-card.excused {
    background: var(--status-excused-gradient-strong);
    box-shadow: 0 6px 18px rgba(243,156,18,0.04);
  }
  .stats-grid-detailed .stat-item.excused .stat-icon,
  .today-status-card.excused .metric-icon {
    background: rgba(243,156,18,0.06);
    color: var(--status-excused-accent);
  }
  .stats-grid-detailed .stat-item.excused .stat-number {
    color: var(--status-excused-accent);
  }

  /* Badge å¼ºåŒ– */
  .status-badge { border: none; }
  .status-badge.present { box-shadow: none; }
}

/* ===== é¢å¤–ï¼šè§„èŒƒåŒ–ç»Ÿè®¡å¡ç‰‡å¸ƒå±€ä¸æ’ç‰ˆï¼ˆå‡ºå‹¤/ç¼ºå‹¤/è¯·å‡/å¾…è€ƒå‹¤ï¼‰ ===== */
.stats-grid-detailed {
  display: grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap: 12px;
  align-items: stretch;
}
.stats-grid-detailed .stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 14px 12px;
  border-radius: 12px;
  min-height: 92px;
  box-shadow: 0 2px 8px var(--shadow-color);
  text-align: center;
}
.stats-grid-detailed .stat-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}
.stats-grid-detailed .stat-content {
  display: flex;
  flex-direction: column;
  gap: 4px;
  align-items: center;
  min-width: 0;
}
.stats-grid-detailed .stat-label {
  font-size: 13px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}
.stats-grid-detailed .stat-number {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-color);
  line-height: 1;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 24px;
}
.stats-grid-detailed .stat-desc {
  font-size: 12px;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* ä¿è¯å›¾æ ‡å’Œæ•°å­—åœ¨æ—¥/å¤œæ¨¡å¼ä¸‹çš„å¯¹æ¯” */
.stats-grid-detailed .stat-item .stat-icon { background: var(--overlay-faint-2); }
.stats-grid-detailed .stat-item.present .stat-icon { background: rgba(39,174,96,0.08); color: var(--status-present-accent); }
.stats-grid-detailed .stat-item.absent .stat-icon { background: rgba(231,76,60,0.06); color: var(--status-absent-accent); }
.stats-grid-detailed .stat-item.excused .stat-icon { background: rgba(243,156,18,0.06); color: var(--status-excused-accent); }
.stats-grid-detailed .stat-item.pending .stat-icon { background: rgba(108,117,125,0.06); color: var(--medium-gray); }

/* å“åº”å¼ï¼šçª„å±æ—¶æ”¹ä¸ºä¸¤åˆ—æˆ–å•åˆ— */
@media (max-width: 900px) {
  .stats-grid-detailed { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 480px) {
  .stats-grid-detailed { grid-template-columns: 1fr; }
  .stats-grid-detailed .stat-item { padding: 10px; }
}

/* æ—¥é—´æ¨¡å¼ï¼šå¼ºåŒ–â€œåŠ è½½æ›´å¤š/å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šâ€æç¤ºçš„æµ…è‰²èƒŒæ™¯ï¼Œæå‡é€‰æ‹©å™¨ä¼˜å…ˆçº§ä»¥é¿å…è¢«æš—è‰²è¦†ç›– */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  /* ä½¿ç”¨çˆ¶å®¹å™¨é™å®šé€‰æ‹©å™¨ä»¥æé«˜ä¼˜å…ˆçº§ï¼ŒåŒæ—¶ä¸ä½¿ç”¨ !important */
  .attendance-history .load-more-hint,
  .practice-history .load-more-hint,
  .recent-practices .load-more-hint,
  .load-more-hint {
    background: var(--light-gray);
    color: var(--text-secondary);
    border-top-color: var(--border-color);
    transition: background-color 0.18s ease;
  }

  .attendance-history .load-more-hint:hover,
  .practice-history .load-more-hint:hover,
  .recent-practices .load-more-hint:hover,
  .load-more-hint:hover {
    background: var(--card-hover-bg);
  }
}
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    overflow-x: hidden;
}

/* ===== 3. å®¹å™¨å’Œå¸ƒå±€ ===== */
.container {
    width: 100%;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom);
    box-sizing: border-box;
}

/* ğŸ”¥ æ–°å¢ï¼šç¡®ä¿å®æ—¶ç»ƒç´çŠ¶æ€åŒºåŸŸæ²¡æœ‰é¢å¤–çš„å†…è¾¹è· */
.container .card {
    margin-left: 0;
    margin-right: 0;
}

/* ğŸ”¥ æ–°å¢ï¼šç¡®ä¿å­¦ç”Ÿç½‘æ ¼ä»æœ€å·¦ä¾§å¼€å§‹ */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(12px, 2vw, 20px);
    width: 100%;
    padding: 0;
    margin: 0;
    padding-left: 0 !important;
}

/* å“åº”å¼å®¹å™¨ */
@media (min-width: 1500px) {
    .container {
        max-width: none;
        padding: 20px 40px;
    }
}

@media (min-width: 1800px) {
    .container {
        padding: 20px 60px;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 10px;
    }
}

/* ===== 4. ç»ƒç´çŠ¶æ€ç´§å‡‘å¸ƒå±€æ ·å¼ ===== */
.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: stretch;
}

.metric-item {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 8px;
    padding: 20px 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    height: 100%;
    box-sizing: border-box;
    text-align: center;
    min-height: 120px;
}

.metric-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    height: 100%;
    align-items: center;
    text-align: center;
    justify-content: center;
    gap: 6px;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
    color: var(--medium-gray);
    flex-shrink: 0;
    text-align: center;
    width: 100%;
    order: 2;
    margin-top: 4px;
}

.metric-value {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    width: 100%;
    order: 1;
}

/* ç»ƒç´çŠ¶æ€ç´§å‡‘å¸ƒå±€æ ·å¼ä¼˜åŒ– */
.metric-value.practice-status-compact {
    line-height: 1.4;
    font-size: 15px;
    min-height: 95px;
    padding: 4px 0;
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* ç»ƒç´çŠ¶æ€å®¹å™¨ç‰¹æ®Šå¸ƒå±€ */
.practice-status-container.metric-item {
    flex-direction: row;
    align-items: flex-start;
    text-align: left;
    gap: 12px;
    padding: 16px;
    justify-content: flex-start;
}

.practice-status-container .metric-content {
    display: flex;
    flex-direction: column;
    gap: 6px;
    width: 100%;
    text-align: left;
}

.practice-status-container .metric-label {
    text-align: left;
    order: 1;
    margin-bottom: 8px;
}

.practice-status-container .metric-value {
    order: 2;
    text-align: left;
}

.practice-info-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    min-height: 20px;
    justify-content: flex-start;
    padding: 2px 0 2px 12px;
    width: 100%;
    gap: 8px;
}

.practice-info-row:last-child {
    margin-bottom: 0;
}

.practice-info-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.practice-label {
    color: #666;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    min-width: 70px;
    flex-shrink: 0;
    text-align: left;
}

.practice-value {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-color);
    text-align: left;
    flex: 1;
}

/* è€ƒå‹¤è¯¦æƒ…æ¨¡æ€ä¸­ä½¿ç”¨çš„çŠ¶æ€ç±»ï¼Œé¿å…å†…è”æ ·å¼ä»¥ä¾¿ä¸»é¢˜åˆ‡æ¢ */
.stats-grid-detailed .stat-item.low-efficiency{background: var(--gradient-excused); color: var(--text-color);}
.stats-grid-detailed .stat-item.pending{background: var(--gradient-card); color: var(--text-color);}

.practice-value.current-practice {
    color: #2196F3;
    font-size: 14px;
    text-align: left;
}

.practice-value.total-practice {
    color: var(--primary-color);
    font-size: 1.2rem;
    font-weight: 700;
    text-align: left;
}

/* æ—¶é—´æ®µå®¹å™¨å¯¹é½ä¼˜åŒ– */
.time-slots-container .metric-value {
    margin-top: 0;
    line-height: 1.4;
    min-height: 95px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding: 4px 0;
}

.time-slots-wrapper {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    gap: 4px;
    margin-top: 4px;
    flex: 1;
}

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
    .status-metrics {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .metric-value.practice-status-compact {
        min-height: 85px;
        font-size: 14px;
        padding: 3px 0;
    }
    
    .time-slots-container .metric-value {
        min-height: 85px;
        padding: 3px 0;
    }
    
    .practice-info-row {
        margin-bottom: 6px;
        min-height: 20px;
        padding: 1px 0;
    }
    
    .practice-label {
        font-size: 12px;
        min-width: 55px;
        font-weight: 500;
    }
    
    .practice-value {
        font-size: 13px;
    }
    
    .practice-value.total-practice {
        font-size: 14px;
        font-weight: 700;
    }
    
    .metric-item {
        padding: 12px;
    }
    
    .metric-label {
        margin-bottom: 4px;
    }
    
    .time-slots-wrapper {
        gap: 3px;
        margin-top: 3px;
    }
}

@media (max-width: 480px) {
    .metric-value.practice-status-compact {
        min-height: 75px;
        font-size: 13px;
        padding: 2px 0;
    }
    
    .time-slots-container .metric-value {
        min-height: 75px;
        padding: 2px 0;
    }
    
    .practice-info-row {
        margin-bottom: 5px;
        min-height: 18px;
    }
    
    .practice-label {
        font-size: 11px;
        min-width: 50px;
        font-weight: 500;
    }
    
    .practice-value {
        font-size: 12px;
    }
    
    .practice-value.total-practice {
        font-size: 13px;
        font-weight: 700;
    }
    
    .metric-item {
        padding: 10px;
    }
    
    .time-slots-wrapper {
        gap: 2px;
        margin-top: 2px;
    }
}

/* ===== 5. è¯­è¨€åˆ‡æ¢å™¨ ===== */
.language-switcher {
    position: fixed;
    bottom: max(20px, env(safe-area-inset-bottom) + 10px);
    left: 20px;
    z-index: 1001;
  display: flex;
  background: var(--card-bg);
    border-radius: var(--radius-large);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.lang-btn {
    padding: 8px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 40px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lang-btn.active {
    background: var(--primary-color);
    color: white;
}

.lang-btn:hover:not(.active) {
  background: var(--primary-faint);
}

/* ç§»åŠ¨ç«¯è¯­è¨€åˆ‡æ¢å™¨ */
@media (max-width: 768px) {
    .language-switcher {
        bottom: max(10px, env(safe-area-inset-bottom) + 5px);
        left: 10px;
        border-radius: 16px;
    }
    
    .lang-btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 35px;
        height: 28px;
    }
}

/* ===== 6. å¤´éƒ¨æ ·å¼ ===== */
.header {
    background: var(--gradient-primary);
    color: white;
    padding: max(30px, env(safe-area-inset-top) + 20px) 20px 30px 20px;
    margin-bottom: 30px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
}

.header h1 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    margin-bottom: 10px;
    font-weight: 300;
    line-height: 1.2;
}

.header .subtitle {
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    opacity: 0.9;
    line-height: 1.3;
}

@media (max-width: 768px) {
    .header {
        padding: max(25px, env(safe-area-inset-top) + 15px) 15px 25px 15px;
        margin-bottom: 20px;
    }
}

/* ===== 7. è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ ===== */
.connection-status {
    position: fixed;
    top: max(20px, env(safe-area-inset-top) + 10px);
    right: 20px;
    padding: 8px 12px;
    border-radius: var(--radius-large);
    font-size: 13px;
    font-weight: 600;
    z-index: 1000;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.connection-status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--danger-color);
}

.connection-status.online::before {
    background: var(--success-color);
}

.connection-status.syncing::before {
    background: var(--warning-color);
    animation: pulse 1.5s infinite;
}

.connection-status.online {
  background: var(--card-bg);
  color: var(--success-color);
  border: 1px solid var(--success-color);
}

.connection-status.offline {
  background: var(--card-bg);
  color: var(--danger-color);
  border: 1px solid var(--danger-color);
}

.connection-status.syncing {
  background: var(--card-bg);
  color: var(--warning-color);
  border: 1px solid var(--warning-color);
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@media (max-width: 768px) {
    .connection-status {
        top: max(15px, env(safe-area-inset-top) + 5px);
        right: 15px;
        padding: 6px 10px;
        font-size: 12px;
        min-height: 36px;
    }
}

/* ===== 8. ä¸»å¯¼èˆªæ ‡ç­¾ ===== */
.nav-tabs {
  display: flex;
  background: var(--card-bg);
    border-radius: var(--radius);
    padding: 5px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.nav-tabs::-webkit-scrollbar {
    display: none;
}

.nav-tab {
    flex: 1;
    padding: 12px 16px;
    text-align: center;
    background: transparent;
    border: none;
    border-radius: calc(var(--radius) - 5px);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: clamp(14px, 3vw, 16px);
    font-weight: 500;
    white-space: nowrap;
    min-width: 120px;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
}

.nav-tab:hover {
  background: var(--primary-faint);
}

.nav-tab.active {
    background: var(--primary-color);
    color: white;
}

@media (max-width: 768px) {
    .nav-tabs {
        margin-bottom: 20px;
        padding: 3px;
    }
    
    .nav-tab {
        padding: 10px 12px;
        font-size: 14px;
        min-width: 100px;
        min-height: 40px;
    }
}

/* ===== 9. å¡ç‰‡å®¹å™¨åŸºç¡€æ ·å¼ ===== */
.card {
  background: var(--card-bg);
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.card.success {
    border-left-color: var(--success-color);
}

.card.warning {
    border-left-color: var(--warning-color);
}

.card.danger {
    border-left-color: var(--danger-color);
}

@media (max-width: 768px) {
    .card {
        padding: 20px 15px;
        margin-bottom: 20px;
    }
}

/* ===== 10. ç»Ÿè®¡é¢æ¿ ===== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
  background: var(--card-bg);
  padding: 25px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.stat-card:hover::before {
    left: 100%;
}

.stat-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 8px;
    line-height: 1;
    text-align: center;
    display: block;
    width: 100%;
    order: 1;
}

.stat-label {
    font-size: 1.1rem;
    color: var(--medium-gray);
    margin-bottom: 2px;
    font-weight: 600;
    text-align: center;
    display: block;
    width: 100%;
    order: 2;
}

.stat-description {
    font-size: 0.9rem;
    color: #999;
    line-height: 1.3;
    text-align: center;
    display: block;
    width: 100%;
    order: 3;
    margin-top: 2px;
}

/* ç»Ÿè®¡å¡ç‰‡é¢œè‰²ä¸»é¢˜ */
.stat-card.present .stat-number { color: var(--success-color); }
.stat-card.absent .stat-number { color: var(--danger-color); }
.stat-card.excused .stat-number { color: var(--warning-color); }
.stat-card.unscheduled .stat-number { color: #9b59b6; }
.stat-card.weekend .stat-number { color: var(--muted-gray); }
.stat-card.pending .stat-number { color: var(--text-secondary); }
.stat-card.self-practice { background: rgba(126,63,242,0.08); border-left: none; }
.stat-card.self-practice .stat-number { color: #7e3ff2; }
/* è‡ªä¸»ç»ƒç´å¡æ–‡å­—é¢œè‰²ä¸å…¶ä»–å¡ç‰‡ç»Ÿä¸€ï¼ˆlabel ç”¨ medium-grayï¼Œdescription ç”¨ #999ï¼Œä¸‹é¢ä¸å†å•ç‹¬æå‡ä¸ºæ­£æ–‡è‰²ï¼‰ */
/* åŸæ¥ä½¿ç”¨ var(--text-color) è¿‡æ·±ï¼Œå¯¼è‡´è§†è§‰ä¸ä¸€è‡´ */
/* ç§»é™¤ç‰¹æ®Šæ–‡å­—è‰²ï¼šä¿æŒä¸é€šç”¨ .stat-label / .stat-description ç›¸åŒ */

/* æ·±è‰²æ¨¡å¼ä¸‹è‡ªä¸»ç»ƒç´å¡ç‰‡ç»Ÿä¸€èƒŒæ™¯æ ·å¼ */
@media (prefers-color-scheme: dark) {
  .stat-card.self-practice { 
    background: var(--card-bg) !important; /* ä¸å…¶ä»–ä¸‰ä¸ªå¡ç‰‡ç»Ÿä¸€èƒŒæ™¯ */
    border-left: none !important;
    box-shadow: var(--shadow) !important; /* ç»Ÿä¸€é˜´å½± */
  }
  .stat-card.self-practice:hover {
    transform: translateY(-5px) !important; /* ç»Ÿä¸€hoverå˜æ¢ */
    box-shadow: var(--shadow-hover) !important; /* ç»Ÿä¸€hoveré˜´å½± */
  }
}

/* è‡ªä¸»ç»ƒç´çŠ¶æ€å¾½ç« ï¼ˆå­¦ç”Ÿå¡ï¼‰ */
.student-status-compact.self-practice, .student-status.self-practice {
  background: #ede4ff;
  color: #7e3ff2;
  border: 1px solid rgba(126,63,242,0.15);
  font-weight: 600;
  font-size: 0.75rem;
  box-shadow: 0 2px 6px rgba(126,63,242,0.12);
}
.practice-status-card.self-practice { background: rgba(126,63,242,0.08); border-left: none; }

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        padding: 18px 12px;
        min-height: 120px;
    }
    
    .stat-number {
        font-size: 2.2rem;
        margin-bottom: 6px;
    }
    
    .stat-label {
        font-size: 1rem;
        margin-bottom: 2px;
    }
    
    .stat-description {
        font-size: 0.8rem;
    }
    
    .stat-description {
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        gap: 8px;
    }
    
    .stat-card {
        padding: 15px 10px;
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
}

/* ===== 11. å­¦ç”Ÿç½‘æ ¼å¸ƒå±€ç³»ç»Ÿ ===== */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(12px, 2vw, 20px);
    width: 100%;
    padding: 0;
}

/* é™åˆ¶æœ€å¤§åˆ—æ•°ä¸º4åˆ— */
@media (min-width: 1400px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
        margin: 0 auto;
        gap: 24px;
    }
}

/* ä¸åŒå±å¹•å®½åº¦çš„å“åº”å¼è®¾ç½® */
@media (max-width: 1399px) and (min-width: 1100px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }
}

@media (max-width: 1099px) and (min-width: 800px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
}

@media (max-width: 799px) {
    .student-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

/* å°å±å¹•ä¼˜åŒ– */
@media (max-width: 599px) {
    .student-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (max-width: 360px) {
    .student-grid {
        gap: 8px;
    }
}

/* å¤§å±å¹•ä¼˜åŒ– */
@media (min-width: 1600px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
        gap: 24px;
    }
}

/* ===== 12. å­¦ç”Ÿå¡ç‰‡å’Œç»ƒç´çŠ¶æ€å¡ç‰‡ ===== */
.student-card,
.practice-status-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
  border-left: 4px solid var(--border-color);
    cursor: pointer;
    width: 100%;
    max-width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    height: auto;
    min-height: 280px;
    box-sizing: border-box;
    justify-self: stretch;
    align-self: stretch;
    color: var(--text-color);
}

/* å¯å¤ç”¨å·¦ä¾§å¼ºè°ƒæ¡ï¼šä¸»è‰²è°ƒï¼ˆç”¨äºå­¦ç”Ÿè¯¦æƒ…å„å®¹å™¨ç»Ÿä¸€é£æ ¼ï¼‰ */
.edge-accent-primary {
  border-left-width: 4px !important;
  border-left-style: solid !important;
  border-left-color: var(--primary-color) !important;
}

/* æŠŠ edge-accent-primary åº”ç”¨åˆ°å­¦ç”Ÿè¯¦æƒ…å¸¸ç”¨å®¹å™¨ */
.student-card.edge-accent-primary,
.practice-status-card.edge-accent-primary,
.student-header.edge-accent-primary,
.student-details.edge-accent-primary,
.student-grid.edge-accent-primary {
  /* ä¿æŒç°æœ‰èƒŒæ™¯ä¸é˜´å½±ï¼Œä»…ç»Ÿä¸€å·¦ä¾§é¢œè‰² */
  box-shadow: inherit; /* keep inherited shadow, prevents empty rule warnings */
}

.student-card:hover,
.practice-status-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
    background: var(--card-hover-bg);
}

.practice-status-card.compact {
    min-height: 120px;
    padding: 10px 12px;
    margin-bottom: 8px;
}

/* å¾…è€ƒå‹¤çŠ¶æ€æ ·å¼ */
.student-status.pending,
.student-status-compact.pending,
.table-status-badge.pending,
.status-badge.pending {
  background: var(--gradient-card);
  color: var(--text-secondary);
  border-color: var(--border-color);
}

.table-status-badge.low_efficiency { 
  background: var(--gradient-excused); 
  color: var(--text-color); 
  border-color: transparent;
}

.practice-status-card.pending,
.student-card.pending {
  border-left-color: var(--medium-gray);
}

/* å¾…è€ƒå‹¤çŠ¶æ€çš„å¡ç‰‡ */
.practice-status-card.pending,
.student-card.pending {
    background: var(--card-bg);
    border-left-color: var(--medium-gray);
}

.compact-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
}

.student-name-compact {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 2px;
}

.student-info-row {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    color: var(--medium-gray);
    flex-wrap: wrap;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 2px;
}

.info-divider {
    opacity: 0.6;
    margin: 0 2px;
}

.status-duration-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
    gap: 10px;
}

.practice-duration-large {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary-color);
  background: var(--primary-faint);
    padding: 3px 6px;
    border-radius: var(--radius-small);
}

/* === ä¼‘æ¯å€’è®¡æ—¶ç¾åŒ–ç»„ä»¶ === */
.break-badge{position:relative;display:inline-flex;flex-direction:column;align-items:flex-start;justify-content:center;gap:2px;padding:6px 10px 8px;border-radius:10px;background:linear-gradient(135deg,#f6f8fa,#e9eef5);color:#0d1117;font-size:11px;font-weight:600;line-height:1.2;min-width:118px;box-shadow:0 2px 6px rgba(0,0,0,.08);border:1px solid #d0d7de;overflow:hidden;}
@media (prefers-color-scheme: dark){
  .break-badge{background:linear-gradient(135deg,#21262d,#2d333b);color:#f0f6fc;border:1px solid #30363d;box-shadow:0 2px 6px rgba(0,0,0,.35);} 
}
.break-badge[data-break-type="lunch"], .break-badge[data-label-key*="lunch"]{background:linear-gradient(135deg,#fff4e0,#ffe1b0);border-color:#ffd79a;}
.break-badge[data-break-type="concert"], .break-badge[data-label-key*="concert"]{background:linear-gradient(135deg,#efe7ff,#dccfff);border-color:#c7b5ff;}
.break-badge[data-break-type="large"], .break-badge[data-label-key*="large"]{background:linear-gradient(135deg,#e0f7ff,#b9ebff);border-color:#a1def5;}
.break-badge[data-break-type="recess"], .break-badge[data-label-key*="recess"]{background:linear-gradient(135deg,#e8f7ee,#c9efd9);border-color:#b2e6c6;}
.break-badge .bb-head{display:flex;align-items:center;gap:4px;width:100%;}
.break-badge .bb-icon{font-size:14px;filter:saturate(1.2);} 
.break-badge .bb-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.break-badge .bb-remain{font-variant-numeric:tabular-nums;font-weight:700;font-size:11px;letter-spacing:.5px;}
.break-badge .bb-remain.urgent{color:#d92c2c;animation:pulseRemain 1s infinite alternate;} 
.break-badge .bb-line{width:100%;height:6px;border-radius:4px;background:rgba(0,0,0,.08);overflow:hidden;position:relative;margin-top:4px;}
@media (prefers-color-scheme: dark){.break-badge .bb-line{background:rgba(255,255,255,.12);} }
.break-badge .bb-fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#56ccf2,#2f80ed);transition:width .6s cubic-bezier(.4,.6,.3,1);} 
.break-badge[data-break-type="lunch"] .bb-fill{background:linear-gradient(90deg,#f2994a,#f2c94c);} 
.break-badge[data-break-type="concert"] .bb-fill{background:linear-gradient(90deg,#bb6bd9,#845ef7);} 
.break-badge[data-break-type="large"] .bb-fill{background:linear-gradient(90deg,#2d9cdb,#56ccf2);} 
.break-badge[data-break-type="recess"] .bb-fill{background:linear-gradient(90deg,#27ae60,#6fcf97);} 
@keyframes pulseRemain{from{opacity:1;}to{opacity:.55;}}

/* ç§»åŠ¨ç«¯å¡ç‰‡ä¼˜åŒ– */
@media (max-width: 768px) {
    .student-card,
    .practice-status-card {
        min-height: 140px;
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .practice-status-card.compact {
        min-height: 120px;
        padding: 10px;
    }
    
    .student-name-compact {
        font-size: 1rem;
    }
    
    .student-info-row {
        font-size: 0.75rem;
        gap: 6px;
    }
    
    .practice-duration-large {
        font-size: 1rem;
        padding: 3px 6px;
    }
}

@media (max-width: 480px) {
    .student-card,
    .practice-status-card {
        min-height: 120px;
        padding: 8px;
    }
    
    .practice-status-card.compact {
        min-height: 100px;
        padding: 8px;
    }
    
    .student-name-compact {
        font-size: 0.95rem;
    }
    
    .student-info-row {
        font-size: 0.7rem;
        gap: 4px;
    }
    
    .practice-duration-large {
        font-size: 0.9rem;
        padding: 2px 4px;
    }
}

/* ===== 13. å¡ç‰‡è¾¹æ¡†é¢œè‰² ===== */
.practice-status-card { 
  border-left-color: var(--secondary-color); 
  background: var(--card-bg);
}

.student-card.weekend,
.practice-status-card.weekend { 
  border-left-color: var(--muted-gray);
  background: var(--gradient-card);
}

.practice-status-card.present,
.student-card.present { 
    border-left-color: var(--success-color); 
}

.practice-status-card.absent,
.student-card.absent { 
    border-left-color: var(--danger-color); 
}

.practice-status-card.excused,
.student-card.excused { 
    border-left-color: var(--warning-color); 
}

.practice-status-card.low-efficiency,
.student-card.low-efficiency { 
  border-left-color: var(--warning-color); 
}

.practice-status-card.practicing-unscheduled,
.student-card.practicing-unscheduled { 
  border-left-color: var(--secondary-color); 
}

/* è‡ªä¸»ç»ƒç´ç»Ÿä¸€ï¼šä½¿ç”¨æµ…ç´«è‰²èƒŒæ™¯ï¼Œä¸ç”¨å·¦ä¾§è‰²æ¡ */
.practice-status-card.self-practice,
.student-card.self-practice {
  background: rgba(126,63,242,0.08);
  border-left: none;
}

/* è‡ªä¸»ç»ƒç´å¾½ç«  - ä¿æŒä¸€å®šçš„èƒŒæ™¯è‰²ä½†é™ä½é¥±å’Œåº¦ */
.student-status.self-practice,
.student-status-compact.self-practice {
  background: #ede4ff;
  color: #7e3ff2;
  border-color: transparent;
  font-weight: 600;
  font-size: 0.75rem;
  box-shadow: 0 2px 6px rgba(126,63,242,0.12);
  border: 1px solid rgba(126,63,242,0.15);
}

/* ç´§å‡‘å¡ç‰‡ - ä½¿ç”¨æµ…ç´«è‰²èƒŒæ™¯é£æ ¼ */
.practice-status-card.self-practice { 
  background: rgba(126,63,242,0.08);
  border-left: none;
  transition: all 0.3s ease; 
}
.practice-status-card.self-practice:hover { 
  background: rgba(126,63,242,0.12);
  box-shadow: 0 4px 12px rgba(126,63,242,0.15); 
  transform: translateY(-2px); 
}

/* æ€§èƒ½æ¨¡å¼é™çº§ï¼šå»é™¤æ¸å˜ä¸é˜´å½±ï¼Œç»Ÿä¸€ä¸ºçº¯è‰² */
html.performance-mode .student-status.self-practice,
html.performance-mode .student-status-compact.self-practice {
  background: #ede4ff !important;
  box-shadow: none !important;
}
html.performance-mode .practice-status-card.self-practice:hover { box-shadow:none; transform:none; }

/* ===== 14. å¡ç‰‡å†…å®¹æ ·å¼ï¼ˆç»­ï¼‰ ===== */
.student-details,
.practice-details {
    width: 100%;
    margin-bottom: 15px;
}

/* å­¦ç”Ÿè¯¦æƒ…å¤´éƒ¨ï¼ˆä½¿ç”¨å˜é‡ä»¥ä¾¿ä¸»é¢˜åˆ‡æ¢ï¼‰ */
.student-header {
  margin-bottom: 15px;
  padding: 20px;
  border-radius: var(--radius-large);
  background: var(--gradient-header);
  color: var(--text-color);
}


/* åœ¨æ›´å¤§å±å¹•ä¸Šä½¿ç”¨ä¸¤åˆ—ï¼Œä½†å­¦ç”ŸåŒºåŸŸä»ç„¶å…¨å®½ */
@media (min-width: 1200px) {
    .student-details,
    .practice-details {
        grid-template-columns: 1fr 1fr;
    }
    
    /* å­¦ç”Ÿå¡ç‰‡åŒºåŸŸè·¨è¶Šä¸¤åˆ— */
    .student-grid,
    .department-section,
    .room-section {
        grid-column: 1 / -1;
    }
}

.detail-item {
    display: flex;
    flex-direction: column;
    padding: 4px 0;
}

.detail-label {
    font-size: 0.75rem;
    color: var(--medium-gray);
    margin-bottom: 2px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-color);
    line-height: 1.3;
}

/* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
.student-status,
.student-status-compact,
.practice-duration {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    white-space: nowrap;
    text-align: center;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    transition: all 0.15s ease-in-out;
}

/* å­¦ç”ŸçŠ¶æ€é¢œè‰² */
.student-status.present,
.student-status-compact.present { 
  background: var(--gradient-present);
  color: var(--text-color);
  border-color: transparent;
}

.student-status.absent,
.student-status-compact.absent { 
  background: var(--gradient-absent);
  color: var(--text-color);
  border-color: transparent;
}

.student-status.excused,
.student-status-compact.excused { 
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.student-status.low-efficiency,
.student-status-compact.low-efficiency { 
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.student-status.practicing-unscheduled,
.student-status-compact.practicing-unscheduled { 
  background: var(--gradient-primary);
  color: var(--text-color);
  border-color: transparent;
}

.student-status.weekend,
.student-status-compact.weekend { 
  background: var(--gradient-card);
  color: var(--text-color);
  border-color: transparent;
}

/* ç»ƒç´æ—¶é•¿æ ‡ç­¾é¢œè‰² */
.practice-duration {
  background: var(--gradient-primary);
  color: var(--text-color);
  border-color: transparent;
}

@media (max-width: 768px) {
    .student-header {
        margin-bottom: 8px;
    }
    
    .student-name {
        font-size: 1.3rem;
    }
    .practice-details {
        grid-template-columns: 1fr;
        gap: 6px;
        margin-bottom: 10px;
    }
    
    .detail-label {
        font-size: 0.7rem;
    }
    
    .detail-value {
        font-size: 0.8rem;
    }
    
    .student-status,
    .student-status-compact,
    .practice-duration {
        padding: 3px 8px;
        font-size: 0.7rem;
        border-radius: 12px;
    }
}

/* ===== 15. å®æ—¶ç»ƒç´æŒ‡ç¤ºå™¨ ===== */
.practice-indicator {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    background: var(--success-color);
    border-radius: 50%;
    animation: pulse 2s infinite;
    box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
}

.practice-status-card.compact .practice-indicator {
    top: 12px;
    right: 12px;
    width: 10px;
    height: 10px;
}

@keyframes pulse {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
    }
    
    70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(39, 174, 96, 0);
    }
    
    100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0);
    }
}

@media (max-width: 768px) {
    .practice-indicator {
        width: 8px;
        height: 8px;
        top: 10px;
        right: 10px;
    }
    
    .practice-status-card.compact .practice-indicator {
        width: 6px;
        height: 6px;
        top: 8px;
        right: 8px;
    }
}

/* ===== 16. è€ƒå‹¤å†å²æ—¶é—´è½´ï¼ˆä¿®å¤ç§»åŠ¨ç«¯å˜å½¢ï¼‰ ===== */
.attendance-history {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}

.history-title {
  font-size: 0.9rem;
  color: var(--medium-gray);
  margin-bottom: 10px;
  font-weight: 500;
}

.history-timeline {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 10px 0;
  justify-content: center;
  align-items: center;
  /* ğŸ”¥ é˜²æ­¢å®¹å™¨è¢«å‹ç¼© */
  min-height: 60px;
}

.history-timeline-container {
  padding: 15px 0;
  /* ğŸ”¥ ç¡®ä¿å®¹å™¨æœ‰è¶³å¤Ÿç©ºé—´ */
  min-height: 80px;
}

.history-day {
  /* ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨å›ºå®šå°ºå¯¸å’Œé˜²å‹ç¼©å±æ€§ */
  width: 40px;
  height: 40px;
  min-width: 40px !important;
  min-height: 40px !important;
  max-width: 40px !important;
  max-height: 40px !important;
  flex: 0 0 40px; /* ğŸ”¥ å…³é”®ï¼šflex-basiså›ºå®šï¼Œä¸å…è®¸ä¼¸ç¼© */
  
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  border: 2px solid transparent;
  box-sizing: border-box;
  
  /* ğŸ”¥ é˜²æ­¢è¢«ä»»ä½•å¸ƒå±€å½±å“ */
  flex-shrink: 0;
  flex-grow: 0;
  aspect-ratio: 1 / 1; /* ğŸ”¥ ç°ä»£æµè§ˆå™¨æ”¯æŒï¼šå¼ºåˆ¶1:1æ¯”ä¾‹ */
}

.history-day:hover {
  transform: scale(1.15);
  z-index: 1;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* çŠ¶æ€é¢œè‰²ä¿æŒä¸å˜ */
.history-day.present { 
  background: var(--success-color); 
  color: white; 
  border-color: var(--success-color);
}

.history-day.absent { 
  background: var(--danger-color); 
  color: white; 
  border-color: var(--danger-color);
}

.history-day.excused { 
  background: var(--warning-color); 
  color: white; 
  border-color: var(--warning-color);
}

.history-day.no-data { 
  background: #f0f0f0; 
  color: #999999; 
  border-color: #f0f0f0;
}

.history-day.pending { 
  background: #f0f0f0; 
  color: #999999; 
  border-color: #f0f0f0;
}

.history-day.low-efficiency {
  background: var(--warning-color);
  border-color: var(--warning-color);
  color: white;
}

.history-day.practicing-unscheduled {
  background: var(--secondary-color);
  border-color: var(--secondary-color);
  color: white;
}

.history-day.weekend {
  background: var(--light-gray);
  border-color: var(--light-gray);
  color: var(--text-color);
}

/* ğŸ”¥ ç§»åŠ¨ç«¯ä¼˜åŒ– - å¼ºåˆ¶ä¿æŒåœ†å½¢ */
@media (max-width: 768px) {
  .attendance-history {
    margin-top: 10px;
    padding-top: 10px;
  }
  
  .history-timeline {
    gap: 6px;
    padding: 8px 0;
    min-height: 55px;
    /* ğŸ”¥ ç§»åŠ¨ç«¯ä½¿ç”¨æ›´å®‰å…¨çš„å¸ƒå±€ */
    justify-content: space-around;
  }
  
  .history-timeline-container {
    min-height: 70px;
  }
  
  .history-day {
    width: 35px;
    height: 35px;
    min-width: 35px !important;
    min-height: 35px !important;
    max-width: 35px !important;
    max-height: 35px !important;
    flex: 0 0 35px; /* ğŸ”¥ å›ºå®šbasis */
    font-size: 0.8rem;
    aspect-ratio: 1 / 1;
  }
  
  .history-day:hover {
    transform: scale(1.1);
  }
}

@media (max-width: 480px) {
  .history-timeline {
    gap: 4px;
    padding: 6px 0;
    min-height: 50px;
    justify-content: space-around;
  }
  
  .history-timeline-container {
    min-height: 65px;
  }
  
  .history-day {
    width: 32px;
    height: 32px;
    min-width: 32px !important;
    min-height: 32px !important;
    max-width: 32px !important;
    max-height: 32px !important;
    flex: 0 0 32px;
    font-size: 0.75rem;
    aspect-ratio: 1 / 1;
  }
  
  .history-day:hover {
    transform: scale(1.05);
  }
}

/* ğŸ”¥ è¶…å°å±å¹•ä¿æŠ¤ */
@media (max-width: 360px) {
  .history-timeline {
    gap: 3px;
    justify-content: space-around;
    min-height: 45px;
  }
  
  .history-timeline-container {
    min-height: 60px;
  }
  
  .history-day {
    width: 30px;
    height: 30px;
    min-width: 30px !important;
    min-height: 30px !important;
    max-width: 30px !important;
    max-height: 30px !important;
    flex: 0 0 30px;
    font-size: 0.7rem;
    aspect-ratio: 1 / 1;
  }
}

/* ğŸ”¥ ç¡®ä¿åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šéƒ½æ˜¯å®Œç¾åœ†å½¢ */
@supports (aspect-ratio: 1 / 1) {
  .history-day {
    aspect-ratio: 1 / 1;
  }
}

/* ğŸ”¥ ä¸ºä¸æ”¯æŒaspect-ratioçš„è€æµè§ˆå™¨æä¾›åå¤‡ */
@supports not (aspect-ratio: 1 / 1) {
  .history-day::before {
    content: '';
    display: block;
    width: 100%;
    height: 0;
    padding-bottom: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
  }
}

/* ===== 17. ç©ºçŠ¶æ€æ ·å¼ ===== */
.practice-empty-state,
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--medium-gray);
}

.practice-empty-state-icon,
.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.practice-empty-state-title,
.empty-state-title {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--text-color);
    font-weight: 600;
}

.practice-empty-state-description,
.empty-state-description {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--medium-gray);
}

.empty-state {
    padding: 60px 20px;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.empty-state-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
}

.empty-state-description {
    font-size: 1rem;
    line-height: 1.6;
}

/* ç§»åŠ¨ç«¯ç©ºçŠ¶æ€ä¼˜åŒ– */
@media (max-width: 768px) {
    .empty-state {
        padding: 40px 15px;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .empty-state-title {
        font-size: 1.2rem;
        margin-bottom: 8px;
    }
    
    .empty-state-description {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .practice-empty-state {
        padding: 30px 15px;
    }
    
    .practice-empty-state-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
    }
    
    .practice-empty-state-title {
        font-size: 1.1rem;
        margin-bottom: 6px;
    }
    
    .practice-empty-state-description {
        font-size: 0.85rem;
    }
}

/* ===== 18. ç­›é€‰å™¨æ ·å¼ ===== */
.filters,
.practice-filters {
  background: var(--card-bg);
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 25px;
    box-shadow: var(--shadow);
}

.filter-row,
.practice-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
}

.practice-filter-row {
    gap: 12px;
}

.filter-group,
.practice-filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
    flex: 1;
}

.practice-filter-group {
    min-width: 120px;
}

.filter-label,
.practice-filter-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    margin-bottom: 5px;
    font-weight: 500;
}

.practice-filter-label {
    font-size: 0.85rem;
    margin-bottom: 4px;
}

.filter-select, 
.filter-input,
.practice-filter-select,
.practice-filter-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-small);
    font-size: 14px;
  transition: all 0.3s ease;
  background: var(--card-bg);
    color: var(--text-color);
}

.practice-filter-select,
.practice-filter-input {
    padding: 8px 10px;
}

.filter-select:focus, 
.filter-input:focus,
.practice-filter-select:focus,
.practice-filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

.filter-select:hover,
.filter-input:hover,
.practice-filter-select:hover,
.practice-filter-input:hover {
    border-color: var(--primary-color);
}

/* å¿«é€Ÿç­›é€‰æ ‡ç­¾ */
.quick-filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
    justify-content: flex-start;
}

.quick-filter-tag {
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 20px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    background: var(--light-gray);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    min-width: auto;
}

.quick-filter-tag:hover {
  background: var(--light-gray);
    transform: translateY(-1px);
}

.quick-filter-tag.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* ç§»åŠ¨ç«¯ç­›é€‰å™¨ä¼˜åŒ– */
@media (max-width: 768px) {
    .filters {
        padding: 15px;
        margin: 0 -5px 20px -5px;
    }
    
    .practice-filters {
        padding: 12px;
        margin: 0 -5px 15px -5px;
    }
    
    .filter-row,
    .practice-filter-row {
        flex-direction: column;
        gap: 12px;
    }
    
    .practice-filter-row {
        gap: 10px;
    }
    
    .filter-group,
    .practice-filter-group {
        min-width: auto;
        width: 100%;
    }
    
    .filter-select,
    .filter-input,
    .practice-filter-select,
    .practice-filter-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }
    
    .practice-filter-select,
    .practice-filter-input {
        padding: 10px 12px;
    }
    
    .filter-select:focus,
    .filter-input:focus,
    .practice-filter-select:focus,
    .practice-filter-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .quick-filter-tags {
        justify-content: center;
        margin-top: 12px;
    }
    
    .quick-filter-tag {
        padding: 6px 12px;
        font-size: 13px;
        height: 32px;
    }
}

/* ç­›é€‰å™¨å†…çš„å­¦ç”Ÿç½‘æ ¼æ ·å¼è°ƒæ•´ */
.practice-filters .student-grid {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
    .practice-filters .student-grid {
        margin-top: 15px;
        padding-top: 15px;
    }
}

/* ===== 19. æ“ä½œæŒ‰é’®æ ·å¼ ===== */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: var(--mobile-font-size);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: var(--touch-target-size);
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  appearance: none;
  -webkit-appearance: none;
    text-decoration: none;
    line-height: 1;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.btn:active {
    transform: scale(0.95);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* æŒ‰é’®é¢œè‰²å˜ä½“ - å¼ºåˆ¶æ˜¾ç¤º */
.btn-primary {
    background: #3498db !important;
    color: white !important;
    border: 1px solid #3498db !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.btn-primary:hover {
  background: #2980b9 !important;
}

.btn-success {
    background: #27ae60 !important;
    color: white !important;
    border: 1px solid #27ae60 !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.btn-success:hover {
  background: #229954 !important;
}

.btn-warning {
    background: #f39c12 !important;
    color: white !important;
    border: 1px solid #f39c12 !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.btn-warning:hover {
  background: #e67e22 !important;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
  background: var(--danger-hover);
}

.btn-secondary {
    background: var(--medium-gray);
    color: white;
}

.btn-secondary:hover {
  background: var(--secondary-hover);
}

.btn-outline {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

/* å¯¼å‡ºé€‰é¡¹ */
.export-options {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

/* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
@media (max-width: 768px) {
  .action-buttons {
    position: sticky;
    bottom: 0;
    background: var(--card-bg);
    padding: 15px;
    margin: 20px -15px -15px -15px;
    border-top: 1px solid #eee;
    z-index: 10;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
  }
    
    .export-options {
        flex-direction: column;
        gap: 8px;
        margin-top: 15px;
    }
    
    .export-options .btn {
        width: 100%;
    }
    
    .btn {
        padding: 14px 20px;
        font-size: 16px;
        border-radius: 10px;
    }
}

/* ===== 20. ğŸ”¥ ç»Ÿä¸€è¡¨æ ¼æ ·å¼ç³»ç»Ÿ ===== */
/* ğŸ”¥ æ ¸å¿ƒï¼šç»Ÿä¸€çš„è¡¨æ ¼å®¹å™¨æ ·å¼ */
.data-table-container,
.table-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: auto;
  border-radius: 8px;
  border: 1px solid #e9ecef;
  background: var(--card-bg);
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    /* ğŸ”¥ ç»Ÿä¸€æœ€å¤§é«˜åº¦ */
    max-height: 400px;
}

/* ğŸ”¥ æ ¸å¿ƒï¼šç»Ÿä¸€çš„è¡¨æ ¼æ ·å¼ */
.data-table,
.detail-table {
    width: 100%;
    min-width: 500px; /* ğŸ”¥ ç»Ÿä¸€æœ€å°å®½åº¦ï¼Œç¡®ä¿è¡¨æ ¼å®Œæ•´æ˜¾ç¤º */
    border-collapse: collapse;
  margin: 0;
  background: var(--card-bg);
    font-size: 0.9rem; /* ğŸ”¥ ç»Ÿä¸€å­—ä½“å¤§å° */
    border-radius: 0;
    overflow: hidden;
    box-shadow: none;
}

.data-table th,
.data-table td,
.detail-table th,
.detail-table td {
    padding: 12px 15px; /* ğŸ”¥ ç»Ÿä¸€å†…è¾¹è· */
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    vertical-align: middle;
    min-width: 80px; /* ğŸ”¥ ç»Ÿä¸€æœ€å°åˆ—å®½ */
    box-sizing: border-box;
}

.data-table th,
.detail-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10;
}

.data-table tr:hover,
.detail-table tr:hover {
    background: var(--light-gray);
}

.data-table tr:last-child td,
.detail-table tr:last-child td {
    border-bottom: none;
}

/* ğŸ”¥ ç§»åŠ¨ç«¯è¡¨æ ¼é€‚é… - ä¿æŒæ¡Œé¢ç«¯ä½“éªŒ */
@media (max-width: 768px) {
    .data-table-container,
    .table-container {
        /* ğŸ”¥ å…³é”®ï¼šç§»åŠ¨ç«¯ä¸æ”¹å˜å®¹å™¨æ ·å¼ï¼Œä¿æŒä¸€è‡´ */
        max-height: 350px; /* ç¨å¾®å‡å°‘é«˜åº¦é€‚åº”å°å±å¹• */
        border-radius: 8px;
        margin: 0; /* ğŸ”¥ ä¸ä½¿ç”¨è´Ÿè¾¹è· */
    }
    
    .data-table,
    .detail-table {
        min-width: 450px; /* ğŸ”¥ ç§»åŠ¨ç«¯ç¨å¾®å‡å°‘ä½†ä¿æŒè¶³å¤Ÿå®½åº¦ */
        font-size: 0.85rem;
    }
    
    .data-table th,
    .data-table td,
    .detail-table th,
    .detail-table td {
        padding: 10px 12px; /* ğŸ”¥ ç§»åŠ¨ç«¯ç¨å¾®å‡å°‘å†…è¾¹è· */
        min-width: 70px;
    }
    
    .data-table th,
    .detail-table th {
        font-size: 0.75rem;
    }
}

@media (max-width: 480px) {
    .data-table-container,
    .table-container {
        max-height: 300px;
    }
    
    .data-table,
    .detail-table {
        min-width: 400px; /* ğŸ”¥ è¶…å°å±å¹•ä¿æŒæœ€å°å®½åº¦ */
        font-size: 0.8rem;
    }
    
    .data-table th,
    .data-table td,
    .detail-table th,
    .detail-table td {
        padding: 8px 10px;
        min-width: 60px;
    }
    
    .data-table th,
    .detail-table th {
        font-size: 0.7rem;
    }
}

/* ğŸ”¥ æ»šåŠ¨æ¡ç¾åŒ– */
.data-table-container::-webkit-scrollbar,
.table-container::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

.data-table-container::-webkit-scrollbar-track,
.table-container::-webkit-scrollbar-track {
  background: var(--card-hover-bg);
    border-radius: 3px;
}

.data-table-container::-webkit-scrollbar-thumb,
.table-container::-webkit-scrollbar-thumb {
  background: var(--text-muted);
    border-radius: 3px;
}

.data-table-container::-webkit-scrollbar-thumb:hover,
.table-container::-webkit-scrollbar-thumb:hover {
  background: var(--medium-gray);
}

/* ğŸ”¥ æ»šåŠ¨æç¤º */
.data-table-container::after,
.table-container::after {
  /* removed: visual 'å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤š' hint */
  content: none !important;
  display: none !important;
  position: absolute;
  bottom: 8px;
  right: 8px;
  pointer-events: none !important;
  opacity: 0 !important;
  transition: none !important;
  z-index: 0 !important;
}

.data-table-container:hover::after,
.table-container:hover::after {
  /* no-op when hidden */
  opacity: 0 !important;
}

/* ğŸ”¥ ç§»åŠ¨ç«¯æ»šåŠ¨æç¤º */
@media (max-width: 768px) {
    .data-table-container::after,
    .table-container::after {
  /* mobile hint removed */
  content: none !important;
  display: none !important;
  font-size: 0.65rem;
  padding: 0;
  bottom: 6px;
    }
}

/* ğŸ”¥ ç‰¹å®šè¡¨æ ¼æ ·å¼ */
.history-table-card .table-container {

    /* æ—¥é—´æ¨¡å¼ï¼šç¡®ä¿ä¼ªå…ƒç´ æç¤ºå·²ç§»é™¤ */
    @media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
      .data-table-container::after,
      .table-container::after {
        content: none !important;
        display: none !important;
      }
    }
    max-height: 300px;
}

/* å…¨å±€å¼ºåˆ¶éšè—æ—§ç‰ˆæˆ–å¤‡ç”¨å®ç°çš„åŠ è½½æ›´å¤šæç¤ºï¼ˆä»¥é˜²åŒæ—¶å­˜åœ¨ .load-more-hint å…ƒç´ ï¼‰ */
.load-more-hint {
  display: none !important;
  visibility: hidden !important;
  pointer-events: none !important;
}

/* è¡¨æ ¼å•å…ƒæ ¼æ ·å¼ */
.date-cell {
    font-weight: 500;
    color: var(--dark-gray);
    min-width: 100px;
}

.table-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    display: inline-block;
    border: 1px solid transparent;
}

.table-status-badge.present {
  background: var(--gradient-present);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.absent {
  background: var(--gradient-absent);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.excused {
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.low-efficiency {
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.practicing-unscheduled {
  background: var(--gradient-primary);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.weekend {
  background: var(--gradient-card);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.no-data { 
    background: #666666; 
    color: white; 
    border-color: #666666;
}

.duration-cell {
    color: var(--medium-gray);
    font-weight: 500;
    text-align: right;
    min-width: 80px;
}

.total-duration-cell {
    font-weight: 600;
    color: var(--primary-color);
    text-align: right;
    min-width: 90px;
}

/* è¡¨æ ¼ç©ºçŠ¶æ€ */
.table-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--medium-gray);
}

.table-empty-state-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    opacity: 0.5;
}

.table-empty-state-title {
    font-size: 1rem;
    margin-bottom: 5px;
    color: var(--text-color);
    font-weight: 600;
}

.table-empty-state-description {
    font-size: 0.85rem;
    line-height: 1.4;
}

/* ä»Šæ—¥è¡Œæ ·å¼ */
.today-row {
  background: var(--overlay-faint-strong);
}

/* ===== 21. æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ–ï¼ˆç§»åŠ¨ç«¯æµç•…åŠ¨ç”» - å‘ä¸‹å…³é—­ï¼‰ ===== */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    /* ğŸ”¥ iOSé£æ ¼ï¼šåˆå§‹çŠ¶æ€é€æ˜æ— æ¨¡ç³Š */
    background: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    z-index: 2000;
    align-items: flex-start;
    justify-content: center;
    /* ğŸ”¥ æ¡Œé¢ç«¯ï¼šå¼¹çª—æ˜¾ç¤ºåœ¨å±å¹•ä¸‹æ–¹çº¦2/3ä½ç½® */
    padding-top: 20vh;
    /* ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ï¼šGPUåŠ é€Ÿ */
    will-change: background, backdrop-filter;
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    /* ğŸ”¥ iOSé£æ ¼è¿‡æ¸¡ï¼šä¸å†…å®¹åŠ¨ç”»æ—¶é—´åŒ¹é… */
    transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* ğŸ”¥ æ¡Œé¢ç«¯æ˜¾ç¤ºé®ç½© */
@media (min-width: 769px) {
    .modal.show {
        display: flex;
        /* ğŸ”¥ æ¡Œé¢ç«¯ï¼šæ˜¾ç¤ºæ—¶æœ‰åŠé€æ˜èƒŒæ™¯å’Œæ¨¡ç³Š */
        background: var(--modal-backdrop);
        backdrop-filter: blur(10px);
    }
}

/* ğŸ”¥ ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–ï¼šå®Œå…¨ç§»é™¤é®ç½©æ•ˆæœ */
@media (max-width: 768px) {
    .modal.show {
        /* ğŸ”¥ ç§»åŠ¨ç«¯å®Œå…¨ç§»é™¤èƒŒæ™¯é®ç½© */
        background: transparent !important;
        backdrop-filter: none !important;
    }
    
    .modal.hiding {
        /* ğŸ”¥ ç§»åŠ¨ç«¯å…³é—­æ—¶ä¹Ÿæ— é®ç½© */
        background: transparent !important;
        backdrop-filter: none !important;
    }
}

@media (max-width: 480px) {
    .modal.show {
        /* ğŸ”¥ å°å±å¹•å®Œå…¨æ— é®ç½© */
        background: transparent !important;
        backdrop-filter: none !important;
    }
    
    .modal.hiding {
        /* ğŸ”¥ å°å±å¹•å…³é—­æ—¶ä¹Ÿæ— é®ç½© */
        background: transparent !important;
        backdrop-filter: none !important;
    }
}

.modal.hiding {
    /* ğŸ”¥ iOSé£æ ¼å¿«é€ŸèƒŒæ™¯æ¶ˆå¤± */
    background: rgba(0, 0, 0, 0) !important;
    backdrop-filter: blur(0px) !important;
    transition: all 0.3s cubic-bezier(0.32, 0.0, 0.67, 0.0) !important;
}

.modal-content {
  background: var(--card-bg);
    border-radius: var(--radius-large);
    padding: 25px;
    max-width: min(800px, 95vw);
    width: 95%;
    max-height: 75vh;
    overflow-y: auto;
    position: relative;
  box-shadow: var(--modal-shadow, 0 20px 50px rgba(0,0,0,0.35));
    /* ğŸ”¥ æ¡Œé¢ç«¯ï¼šä»ä¸Šæ–¹æ»‘å…¥ */
    transform: translateZ(0) translateY(-50px) scale(0.94);
    opacity: 0;
    /* ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ï¼šGPUåŠ é€Ÿ */
    will-change: transform, opacity;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    -webkit-perspective: 1000px;
    perspective: 1000px;
    /* ğŸ”¥ ç§»é™¤è¿‡æ¸¡ï¼Œå®Œå…¨ä¾èµ–åŠ¨ç”» */
}

.modal.show .modal-content {
    /* ğŸ”¥ æ¡Œé¢ç«¯ï¼šä»ä¸Šæ–¹æ·¡å…¥å¼¹å‡º */
    animation: slideInFromTop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.modal.hiding .modal-content {
    /* ğŸ”¥ æ¡Œé¢ç«¯ï¼šå‘ä¸Šæ·¡å‡ºå…³é—­ */
    animation: slideOutToTop 0.18s cubic-bezier(0.32, 0.0, 0.67, 0.0) forwards !important;
}

/* ğŸ”¥ ç§»åŠ¨ç«¯iOSé£æ ¼åŠ¨ç”» */
@media (max-width: 768px) {
    .modal {
        align-items: flex-end;
        justify-content: center;
        padding-top: 0;
        /* ğŸ”¥ ç§»åŠ¨ç«¯æ— é®ç½©ï¼Œæ— è¿‡æ¸¡æ•ˆæœ */
        transform: translateZ(0);
        transition: none;
    }
    
    .modal.show {
        display: flex;
        /* ğŸ”¥ ç§»åŠ¨ç«¯å®Œå…¨æ— é®ç½© */
        background: transparent !important;
        backdrop-filter: none !important;
    }
    
    .modal-content {
        width: 100%;
        max-width: 100%;
        max-height: 100vh;
        /* ğŸ”¥ ä¿®å¤ï¼šå®Œå…¨è¦†ç›–åº•éƒ¨ï¼Œæ— åœ†è§’ */
        border-radius: var(--radius-large) var(--radius-large) 0 0;
        margin: 0;
        /* ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿çª—å£ä»å®Œå…¨åº•éƒ¨å¼€å§‹ï¼Œæ— ç©ºç™½ */
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        /* ğŸ”¥ iOSç§»åŠ¨ç«¯ï¼šåˆå§‹çŠ¶æ€åœ¨å±å¹•å¤–åº•éƒ¨ */
        transform: translateZ(0) translateY(100%);
        opacity: 1;
        /* ğŸ”¥ ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ– */
        will-change: transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        -webkit-perspective: 1000px;
        perspective: 1000px;
        /* ğŸ”¥ ç§»åŠ¨ç«¯æ¸²æŸ“ä¼˜åŒ– */
        -webkit-transform: translateZ(0) translateY(100%);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    .modal.show .modal-content {
        /* ğŸ”¥ iOSç§»åŠ¨ç«¯å¼¹å‡ºåŠ¨ç”» - æ€§èƒ½ä¼˜åŒ– */
        animation: slideUpBounce 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }
    
    .modal.hiding .modal-content {
        /* ğŸ”¥ iOSç§»åŠ¨ç«¯è¶…å¿«å…³é—­åŠ¨ç”» - æ€§èƒ½ä¼˜åŒ– */
        animation: slideDownGesture 0.18s cubic-bezier(0.4, 0, 1, 1) forwards !important;
    }
}

/* ğŸ”¥ è¶…å°å±å¹•iOSä¼˜åŒ– */
@media (max-width: 480px) {
    .modal-content {
        /* ğŸ”¥ è¶…å°å±å¹•ï¼šæ›´å°çš„é¡¶éƒ¨åœ†è§’ */
        border-radius: 12px 12px 0 0;
        max-height: 100vh;
        /* ğŸ”¥ ç¡®ä¿å®Œå…¨è´´åº• */
        padding-bottom: env(safe-area-inset-bottom, 20px);
    }
    
    .modal.show .modal-content {
        /* ğŸ”¥ è¶…å°å±å¹•iOSå¼¹å‡ºï¼šæ€§èƒ½ä¼˜åŒ– */
        animation: slideUpBounceSmall 0.35s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }
    
    .modal.hiding .modal-content {
        /* ğŸ”¥ è¶…å°å±å¹•è¶…å¿«å…³é—­ - æ€§èƒ½ä¼˜åŒ– */
        animation: slideDownGestureSmall 0.15s cubic-bezier(0.4, 0, 1, 1) forwards !important;
    }
}

/* ğŸ”¥ æ¡Œé¢ç«¯iOSé£æ ¼å…³é—­åŠ¨ç”» */
@media (min-width: 769px) {
    .modal.hiding .modal-content {
        /* ğŸ”¥ æ¡Œé¢ç«¯å‘ä¸Šæ·¡å‡ºå…³é—­ */
        animation: slideOutToTop 0.18s cubic-bezier(0.32, 0.0, 0.67, 0.0) forwards !important;
    }
    
    .modal.hiding {
        /* ğŸ”¥ æ¡Œé¢ç«¯è¶…å¿«èƒŒæ™¯æ¶ˆå¤± */
        transition: all 0.18s cubic-bezier(0.32, 0.0, 0.67, 0.0) !important;
    }
}


/* ğŸ”¥ é‡æ–°è®¾è®¡ï¼šiOSé£æ ¼åŠ¨ç”»å…³é”®å¸§ - GPUä¼˜åŒ– */
@keyframes slideUpBounce {
    0% {
        transform: translateZ(0) translateY(100%);
    }
    60% {
        transform: translateZ(0) translateY(-1%);
    }
    100% {
        transform: translateZ(0) translateY(0);
    }
}

/* ğŸ”¥ æ–°å¢ï¼šæ¡Œé¢ç«¯ä»ä¸Šæ–¹æ·¡å…¥åŠ¨ç”» */
@keyframes slideInFromTop {
    0% {
        transform: translateZ(0) translateY(-50px) scale(0.94);
        opacity: 0;
    }
    60% {
        transform: translateZ(0) translateY(5px) scale(1.01);
        opacity: 0.9;
    }
    100% {
        transform: translateZ(0) translateY(0) scale(1);
        opacity: 1;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šæ¡Œé¢ç«¯å‘ä¸Šæ·¡å‡ºåŠ¨ç”» */
@keyframes slideOutToTop {
    0% {
        transform: translateZ(0) translateY(0) scale(1);
        opacity: 1;
    }
    100% {
        transform: translateZ(0) translateY(-50px) scale(0.94);
        opacity: 0;
    }
}

/* ğŸ”¥ iOSé£æ ¼å…³é—­åŠ¨ç”» - çº¯ä½ç§»æ— æ¸éš */
@keyframes slideDownSmooth {
    0% {
        transform: translateY(0);
    }
    100% {
        transform: translateY(100%);
    }
}

/* ğŸ”¥ æ–°å¢ï¼šiOSæ‰‹åŠ¿é£æ ¼å…³é—­åŠ¨ç”» - GPUä¼˜åŒ– */
@keyframes slideDownGesture {
    0% {
        transform: translateZ(0) translateY(0);
    }
    100% {
        transform: translateZ(0) translateY(100%);
    }
}

/* ğŸ”¥ å°å±å¹•iOSé£æ ¼åŠ¨ç”» */
@keyframes slideDownSmoothSmall {
    0% {
        transform: translateY(0);
    }
    100% {
        transform: translateY(100%);
    }
}

@keyframes slideUpBounceSmall {
    0% {
        transform: translateZ(0) translateY(100%);
    }
    60% {
        transform: translateZ(0) translateY(-0.5%);
    }
    100% {
        transform: translateZ(0) translateY(0);
    }
}

/* ğŸ”¥ æ–°å¢ï¼šè¶…å°å±å¹•æ‰‹åŠ¿å…³é—­åŠ¨ç”» - GPUä¼˜åŒ– */
@keyframes slideDownGestureSmall {
    0% {
        transform: translateZ(0) translateY(0);
    }
    100% {
        transform: translateZ(0) translateY(100%);
    }
}

/* ğŸ”¥ æ·»åŠ è§¦æ‘¸åé¦ˆ */
@media (max-width: 768px) {
    .modal-close {
        transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        transform: scale(1);
    }
    
    .modal-close:active {
        transform: scale(0.9);
        background: var(--danger-color);
        color: #fff;
    }
}


/* ===== 22. æ¨¡æ€æ¡†å¤´éƒ¨å’Œå…³é—­æŒ‰é’®ä¼˜åŒ– ===== */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding: 15px 0 15px 0;
    border-bottom: 2px solid var(--light-gray);
    position: relative;
    min-height: 60px;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
    flex: 1;
    line-height: 1.3;
    padding-right: 60px;
    padding-top: 5px;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 44px;
    height: 44px;
    background: transparent;
    border: none;
    font-size: 28px;
    font-weight: 300;
    color: var(--medium-gray);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
    z-index: 10;
    line-height: 1;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

.modal-close:hover {
  background: var(--danger-faint);
    color: var(--danger-color);
    transform: scale(1.1);
}

.modal-close:active {
    transform: scale(0.95);
  background: var(--danger-faint-2);
}

/* ğŸ”¥ ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
    .modal-header {
        padding: 10px 0 12px 0;
        min-height: 50px;
    }
    
    .modal-title {
        font-size: 1.3rem;
        padding-right: 50px;
        padding-top: 3px;
    }
    
    .modal-close {
        width: 40px;
        height: 40px;
        font-size: 24px;
        top: 8px;
        right: 8px;
    }
    
    .modal-content {
        padding: 15px;
        width: 100%;
        max-width: 100%;
        border-radius: var(--radius-large) var(--radius-large) 0 0;
        margin: 0;
    }
}

@media (max-width: 480px) {
    .modal-header {
        padding: 8px 0 10px 0;
        min-height: 45px;
    }
    
    .modal-title {
        font-size: 1.2rem;
        padding-right: 45px;
        padding-top: 2px;
    }
    
    .modal-close {
        width: 36px;
        height: 36px;
        font-size: 22px;
        top: 6px;
        right: 6px;
    }
    
    .modal-content {
        padding: 12px;
    }
}

/* ===== 23. åŠ è½½åŠ¨ç”» ===== */
.loading {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--light-gray);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 15px;
    color: var(--medium-gray);
    font-size: 0.9rem;
}

/* ç§»åŠ¨ç«¯åŠ è½½åŠ¨ç”»ä¼˜åŒ– */
@media (max-width: 768px) {
    .loading {
        padding: 30px 20px;
    }
    
    .spinner {
        width: 35px;
        height: 35px;
        border-width: 3px;
    }
    
    .loading-text {
        margin-top: 12px;
        font-size: 0.85rem;
    }
}

/* ===== 24. æ—¥æœŸé€‰æ‹©å™¨æ ·å¼ ===== */
.date-picker {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.date-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-small);
    font-size: 14px;
    color: var(--text-color);
  background: var(--card-bg);
    transition: all 0.3s ease;
}

.date-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

/* ç§»åŠ¨ç«¯æ—¥æœŸé€‰æ‹©å™¨ä¼˜åŒ– */
@media (max-width: 768px) {
    .date-picker {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 15px;
  background: var(--card-bg);
        border-radius: var(--radius);
  box-shadow: var(--shadow);
        margin-bottom: 20px;
    }
    
    .date-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
    }
    
    .date-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}

/* ===== 25. å­¦ç”Ÿè¯¦æƒ…é¡µé¢ç‰¹æ®Šæ ·å¼ ===== */
.student-detail-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 800px;
    margin: 0 auto;
}

/* å­¦ç”Ÿæ¡£æ¡ˆå¡ç‰‡ */
.student-profile-card {
  /* æ·»åŠ æ¸å˜èƒŒæ™¯æ¥å‡¸æ˜¾å­¦ç”Ÿå§“åå¡ç‰‡ */
  background: linear-gradient(135deg, var(--primary-color), #58a6ff);
  color: white;
  padding: 22px 24px;
  border-radius: var(--radius-large);
  text-align: center;
  box-shadow: var(--shadow-hover);
  border: none;
  position: relative;
  overflow: hidden;
}

.profile-info {
    width: 100%;
}

.profile-name {
  font-size: 2.2rem;
  font-weight: 700;
  margin: 0 0 8px 0;
  color: white;
  line-height: 1.1;
  text-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.profile-meta {
  display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 12px;
  font-size: 0.98rem;
  color: var(--text-secondary);
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.meta-icon {
    font-size: 1rem;
}

.meta-divider {
    opacity: 0.6;
    margin: 0 4px;
    font-size: 1.2rem;
}

/* ä»Šæ—¥çŠ¶æ€å¡ç‰‡ */
.today-status-card {
  background: var(--card-bg);
  border-radius: 14px;
  padding: 18px;
  box-shadow: var(--shadow);
  border-left: 6px solid var(--primary-color);
}

.today-status-card.present { border-left-color: var(--success-color); }
.today-status-card.absent { border-left-color: var(--danger-color); }
.today-status-card.excused { border-left-color: var(--warning-color); }
.today-status-card.low-efficiency { border-left-color: #f39c12; }
/* è‡ªä¸»ç»ƒç´çŠ¶æ€æ ·å¼å·²åœ¨ä¸Šæ–¹ç»Ÿä¸€å®šä¹‰ */
.today-status-card.weekend { border-left-color: var(--muted-gray); }

.status-header {
    display: flex;
  font-weight: 700;
  color: var(--text-color);
  margin: 0;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.status-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: var(--radius-large);
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid transparent;
    color: var(--text-color);
    background: var(--overlay-faint-strong);
}

/* responsive tweak for small screens */
@media (max-width: 480px) {
  .today-status-card { padding: 14px; }
  .status-title { font-size: 1.05rem; }
  .status-badge { font-size: 0.9rem; padding: 5px 8px; }
}

.status-badge.present { background: var(--gradient-present); color: var(--text-color); border-color: transparent; }
.status-badge.absent { background: var(--gradient-absent); color: var(--text-color); border-color: transparent; }
.status-badge.excused { background: var(--gradient-excused); color: var(--text-color); border-color: transparent; }
.status-badge.low-efficiency { background: var(--gradient-excused); color: var(--text-color); border-color: transparent; }
/* è‡ªä¸»ç»ƒç´çŠ¶æ€æ ·å¼å·²åœ¨ä¸Šæ–¹ç»Ÿä¸€å®šä¹‰ */
.status-badge.self-practice { 
  background: #ede4ff; 
  color: #7e3ff2; 
  border: 1px solid rgba(126,63,242,0.15);
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(126,63,242,0.12);
}
.status-badge.weekend { background: var(--gradient-card); color: var(--text-color); border-color: transparent; }

.metric-icon {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  background: var(--overlay-faint-strong);
    border-radius: 50%;
}

/* æ—¥é—´æ¨¡å¼ï¼šä¸ºä»Šæ—¥å¡ç‰‡å’Œå¾½ç« åº”ç”¨æµ…è‰²æ¸å˜ä»¥å¢å¼ºåŒºåˆ†åº¦ */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  .today-status-card.present { background: var(--gradient-present-light); }
  .today-status-card.absent { background: var(--gradient-absent-light); }
  .today-status-card.excused { background: var(--gradient-excused-light); }
  .today-status-card.practicing-unscheduled { background: var(--gradient-primary-light); }
  .today-status-card.weekend { background: var(--gradient-weekend-light); }

  .status-badge.present { background: var(--gradient-present-light); color: var(--text-color); border-color: transparent; }
  .status-badge.absent { background: var(--gradient-absent-light); color: var(--text-color); border-color: transparent; }
  .status-badge.excused { background: var(--gradient-excused-light); color: var(--text-color); border-color: transparent; }
  .status-badge.practicing-unscheduled { background: var(--gradient-primary-light); color: var(--text-color); border-color: transparent; }
  .status-badge.self-practice { 
    background: #ede4ff; 
    color: #7e3ff2; 
    border: 1px solid rgba(126,63,242,0.15);
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(126,63,242,0.12);
  }
  .status-badge.weekend { background: var(--gradient-weekend-light); color: var(--text-color); border-color: transparent; }
}

.status-metrics .metric-item {
  padding: 14px;
  gap: 12px;
  align-items: center;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
}

.status-metrics .metric-item:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-hover);
}

.metric-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-color);
  line-height: 1.05;
}

.metric-label {
  font-size: 0.92rem;
  color: var(--text-secondary);
}

@media (max-width: 480px) {
  .status-metrics .metric-item { padding: 12px; }
  .metric-value { font-size: 1.25rem; }
}

/* è¯·å‡ä¿¡æ¯ */
.excuse-info {
    margin-top: 20px;
    padding: 16px;
  background: var(--warning-faint);
    border-radius: var(--radius);
    border-left: 4px solid #f39c12;
}

.excuse-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.excuse-icon {
    font-size: 1.2rem;
}

.excuse-title {
    font-weight: 600;
    color: #b06000;
}

.excuse-content {
    padding-left: 28px;
}

.excuse-reason {
    margin: 0 0 4px 0;
    color: #856404;
    font-weight: 500;
}

.excuse-approver {
    margin: 0;
    font-size: 0.9rem;
    color: #6c5700;
}

/* é€šç”¨å¡ç‰‡æ ·å¼ */
.card-header {
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--light-gray);
}

.card-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.title-icon {
    font-size: 1.3rem;
}

.title-subtitle {
    font-size: 0.85rem;
    font-weight: 400;
    color: var(--medium-gray);
    margin-left: 4px;
}

/* ç»Ÿè®¡ç½‘æ ¼è¯¦ç»†ç‰ˆ */
.stats-grid-detailed {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    max-width: 100%;
}

.stats-grid-detailed .stat-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px;
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    min-height: 80px;
}

.stats-grid-detailed .stat-item:hover {
    transform: translateY(-3px);
}

.stats-grid-detailed .stat-item.present { 
  background: var(--gradient-present);
}

.stats-grid-detailed .stat-item.absent { 
  background: var(--gradient-absent);
}

.stats-grid-detailed .stat-item.excused { 
  background: var(--gradient-excused);
}

.stats-grid-detailed .stat-item.rate { 
  background: var(--gradient-rate);
}

.stats-grid-detailed .stat-icon {
    font-size: 1.5rem;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
  background: var(--overlay-faint-strong);
    border-radius: 50%;
    flex-shrink: 0;
}

.stats-grid-detailed .stat-content {
    flex: 1;
    min-width: 0;
}

.stats-grid-detailed .stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
    color: var(--text-color);
}

.stats-grid-detailed .stat-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    font-weight: 500;
    line-height: 1.2;
}

/* ç§»åŠ¨ç«¯å­¦ç”Ÿè¯¦æƒ…é¡µé¢ä¼˜åŒ– */
@media (max-width: 768px) {
    .student-detail-content {
        gap: 16px;
    }
    
    .student-profile-card {
        padding: 25px 20px;
    }
    
    .profile-name {
        font-size: 2rem;
    }
    
    .profile-meta {
        font-size: 1rem;
        gap: 10px;
    }
    
    .status-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .status-metrics {
        grid-template-columns: 1fr;
    }
    
    .stats-grid-detailed {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 16px;
        min-height: 70px;
    }
    
    .stats-grid-detailed .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1.3rem;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.5rem;
    }
    
    .stats-grid-detailed .stat-label {
        font-size: 0.85rem;
    }
}

@media (max-width: 480px) {
    .student-detail-content {
        gap: 16px;
    }
    
    .card {
        padding: 20px 16px;
    }
    
    .profile-name {
        font-size: 1.8rem;
    }
    
    .profile-meta {
        font-size: 0.9rem;
        gap: 8px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 14px;
        min-height: 60px;
        gap: 10px;
    }
    
    .stats-grid-detailed .stat-icon {
        width: 35px;
        height: 35px;
        font-size: 1.2rem;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.3rem;
    }
    
    .stats-grid-detailed .stat-label {
        font-size: 0.8rem;
    }
}

/* ä¸­ç­‰å±å¹•ç»Ÿè®¡ç½‘æ ¼ä¼˜åŒ– */
@media (min-width: 769px) and (max-width: 1024px) {
    .stats-grid-detailed {
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 18px;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.6rem;
    }
}

/* å¤§å±å¹•ç»Ÿè®¡ç½‘æ ¼ä¼˜åŒ– */
@media (min-width: 1200px) {
    .stats-grid-detailed {
        max-width: 600px;
        margin: 0 auto;
    }
}

/* ===== 26. æ—¶é—´æ®µæ ‡ç­¾ç¾åŒ–æ ·å¼ ===== */
.time-slot-tag {
    display: inline-block;
    background: transparent;
  color: var(--medium-gray);
    border: none;
    padding: 2px 4px;
    margin: 2px 4px 2px 0;
    border-radius: 0;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: none;
    transition: all 0.2s ease;
    white-space: nowrap;
}

time-slot-tag:hover {
  color: var(--text-color);
    transform: none;
    box-shadow: none;
    background: transparent;
}

.time-slots-wrapper {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    justify-content: flex-start;
    gap: 0;
    margin-top: 4px;
    width: 100%;
    margin-left: 0;
    padding-left: 0;
}

.time-slots-container {
    width: 100%;
}

.time-slots-container .metric-value {
    line-height: 1.4;
    text-align: left;
    width: 100%;
    margin-left: 0;
    padding-left: 0;
}

.time-slots-container.metric-item {
    justify-content: flex-start;
    align-items: flex-start;
    flex-direction: row;
    text-align: left;
    gap: 12px;
    padding: 16px;
}

.time-slots-container .metric-content {
    width: 100%;
    text-align: left;
    margin-left: 0;
    padding-left: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.metric-content .metric-label {
    margin-left: 0;
    padding-left: 0;
    text-align: left;
    order: 1;
    font-size: 0.9rem;
    color: var(--medium-gray);
    margin-bottom: 6px;
}

.metric-content .metric-value.time-slots-wrapper {
    margin-left: 0 !important;
    padding-left: 0 !important;
    text-align: left;
    justify-content: flex-start !important;
    order: 2;
    margin-top: 0;
}

/* å½“å‰æ—¶é—´æ®µé«˜äº® - åªæœ‰è¿™ä¸ªçŠ¶æ€æ‰æœ‰èƒŒæ™¯å’Œå½¢çŠ¶ */
.time-slot-tag.current {
    background: linear-gradient(135deg, #d1ecf1, #bee5eb);
    color: #0c5460;
    border: 1px solid #b8daff;
    padding: 6px 14px;
    border-radius: 18px;
    font-weight: 600;
    font-size: 0.95rem;
    box-shadow: 0 1px 3px rgba(12, 84, 96, 0.2);
    animation: pulse-glow 2s infinite;
}

.time-slot-tag.current:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(12, 84, 96, 0.3);
}

@keyframes pulse-glow {
    0%, 100% { 
        box-shadow: 0 1px 3px rgba(12, 84, 96, 0.2);
    }
    50% { 
        box-shadow: 0 2px 8px rgba(12, 84, 96, 0.3);
    }
}

.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: start;
}

.status-metrics .metric-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    text-align: left;
}

.status-metrics .time-slots-container.metric-item .metric-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
}

.status-metrics .time-slots-container.metric-item .metric-label {
    align-self: flex-start;
    margin-left: 0;
    padding-left: 0;
}

.status-metrics .time-slots-container.metric-item .metric-value {
    align-self: flex-start;
    width: 100%;
    margin-left: 0;
    padding-left: 0;
}

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
    .time-slot-tag {
        font-size: 0.85rem;
        padding: 3px 4px;
        margin: 1px 3px 1px 0;
        font-weight: 500;
    }
    
    .time-slot-tag.current {
        padding: 5px 12px;
        font-size: 0.9rem;
    }
    
    .time-slots-container .metric-value {
        line-height: 1.5;
        text-align: left;
        margin-left: 0;
        padding-left: 0;
    }
    
    .time-slots-wrapper {
        justify-content: flex-start;
        margin-left: 0;
        padding-left: 0;
    }
    
    .status-metrics {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (max-width: 480px) {
    .time-slot-tag {
        font-size: 0.8rem;
        padding: 2px 3px;
        margin: 1px 2px 1px 0;
    }
    
    .time-slot-tag.current {
        padding: 4px 10px;
        font-size: 0.85rem;
    }
    
    .time-slots-wrapper {
        margin-top: 2px;
        justify-content: flex-start;
        margin-left: 0;
        padding-left: 0;
    }
    
    .time-slots-container .metric-value {
        margin-left: 0;
        padding-left: 0;
    }
}

/* ===== 27. åŠ è½½æ›´å¤šæç¤º ===== */
.load-more-hint {
    text-align: center;
    padding: 15px;
    color: var(--medium-gray);
    font-size: 0.85rem;
    border-top: 1px solid #eee;
    background: var(--light-gray);
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.load-more-hint:hover {
  background: var(--light-gray);
}

.load-more-hint.loading {
    color: var(--primary-color);
    cursor: not-allowed;
}

/* ===== 28. è§¦æ‘¸ä¼˜åŒ– ===== */
.student-card, 
.practice-status-card, 
.stat-card, 
.btn, 
.nav-tabs {
  display: flex;
  background: var(--card-bg);
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.student-card:active, 
.practice-status-card:active, 
.stat-card:active {
    transform: scale(0.98);
}

.btn:active {
    transform: scale(0.95);
}

.quick-filter-tag:active,
.history-day:active {
    transform: scale(0.95);
}

/* ===== 29. iOSå®‰å…¨åŒºåŸŸé€‚é… ===== */
@supports (padding: max(0px)) {
    .container {
        padding-left: max(20px, env(safe-area-inset-left));
        padding-right: max(20px, env(safe-area-inset-right));
    }
    
    @media (max-width: 768px) {
        .container {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }
    }
}

/* ===== 30. æ¨ªå±æ¨¡å¼ä¼˜åŒ– ===== */
@media (max-width: 768px) and (orientation: landscape) {
    .header {
        padding: max(15px, env(safe-area-inset-top) + 10px) 20px 15px 20px;
    }
    
    .header h1 {
        font-size: 1.8rem;
        margin-bottom: 5px;
    }
    
    .header .subtitle {
        font-size: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .modal-content {
        max-height: 80vh;
    }
    
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* ===== 31. iOS Safari ç‰¹æ®Šä¼˜åŒ– ===== */
@supports (-webkit-touch-callout: none) {
    .nav-tabs {
        -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
        -webkit-overflow-scrolling: touch;
    }
    
    input, select, textarea {
  appearance: none;
  -webkit-appearance: none;
  border-radius: 8px;
    }
    
  .btn {
    appearance: none;
    -webkit-appearance: none;
  }
}

/* ===== 32. æ»šåŠ¨æ¡æ ·å¼ ===== */
* {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

*::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

*::-webkit-scrollbar-track {
    background: transparent;
}

*::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

*::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0, 0, 0, 0.4);
}

/* ç§»åŠ¨ç«¯æ»šåŠ¨æ¡ */
@media (max-width: 768px) {
    *::-webkit-scrollbar {
        width: 3px;
        height: 3px;
    }
}

/* ===== 33. å¯è®¿é—®æ€§ä¼˜åŒ– ===== */
.student-card:focus,
.practice-status-card:focus,
.btn:focus,
.nav-tab:focus,
.quick-filter-tag:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

button:focus,
input:focus,
select:focus,
textarea:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 1px;
}

/* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
@media (prefers-contrast: high) {
    :root {
        --border-color: #000;
        --text-color: #000;
        --background-color: #fff;
    }
    
    .card {
        border: 2px solid #000;
    }
    
    .btn {
        border: 2px solid currentColor;
    }
}

/* å‡å°‘åŠ¨ç”»åå¥½ */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .practice-indicator {
        animation: none;
    }
    
    .spinner {
        animation: none;
    }
}

/* ===== 34. æ‰“å°æ ·å¼ä¼˜åŒ– ===== */
@media print {
    .language-switcher,
    .connection-status,
    .nav-tabs,
    .action-buttons,
    .btn,
    .modal,
    .practice-indicator {
        display: none !important;
    }
    
    .container {
        max-width: none;
        padding: 0;
    }
    
    .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
        margin-bottom: 15px;
    }
    
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .student-card,
    .practice-status-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .header {
        background: none !important;
        color: #000 !important;
        box-shadow: none;
    }
    
    body {
        background: white !important;
        color: black !important;
    }
}

/* ===== 35. ç»Ÿä¸€çš„çŠ¶æ€é¢œè‰²ç³»ç»Ÿï¼ˆå˜é‡é©±åŠ¨ï¼‰ ===== */
.present,
.student-status.present,
.student-status-compact.present,
.table-status-badge.present,
.status-badge.present {
  background: var(--gradient-present);
  color: var(--text-color);
  border-color: transparent;
}

.absent,
.student-status.absent,
.student-status-compact.absent,
.table-status-badge.absent,
.status-badge.absent {
  background: var(--gradient-absent);
  color: var(--text-color);
  border-color: transparent;
}

.pending,
.student-status.pending,
.student-status-compact.pending,
.table-status-badge.pending,
.status-badge.pending {
  background: var(--gradient-card);
  color: var(--text-secondary);
  border-color: transparent;
}

.excused,
.student-status.excused,
.student-status-compact.excused,
.table-status-badge.excused,
.status-badge.excused {
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.low-efficiency,
.student-status.low-efficiency,
.student-status-compact.low-efficiency,
.table-status-badge.low-efficiency,
.status-badge.low-efficiency {
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.practicing-unscheduled,
.student-status.practicing-unscheduled,
.student-status-compact.practicing-unscheduled,
.table-status-badge.practicing-unscheduled,
.status-badge.practicing-unscheduled {
  background: var(--gradient-primary);
  color: var(--text-color);
  border-color: transparent;
}

.weekend,
.student-status.weekend,
.student-status-compact.weekend,
.table-status-badge.weekend,
.status-badge.weekend {
  background: var(--gradient-card);
  color: var(--text-color);
  border-color: transparent;
}

/* ===== 36. æ–‡æœ¬å’Œæ’ç‰ˆä¼˜åŒ– ===== */
p, div, span {
    line-height: 1.5;
}

h1, h2, h3, h4, h5, h6 {
    line-height: 1.2;
    margin-bottom: 0.5em;
    font-weight: 600;
}

/* ç¡®ä¿æ‰€æœ‰æ–‡æœ¬è¾“å…¥æ¡†åœ¨iOSä¸Šä¸ä¼šè¢«ç¼©æ”¾ */
input, select, textarea, button {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

/* ç¡®ä¿è§¦æ‘¸ç›®æ ‡è¶³å¤Ÿå¤§ */
.nav-tab,
.btn,
.lang-btn,
.connection-status,
.student-card,
.practice-status-card,
.history-day,
.quick-filter-tag {
    min-height: 44px;
    min-width: 44px;
}

/* å°å±å¹•ä¸‹çš„è§¦æ‘¸ç›®æ ‡è°ƒæ•´ */
@media (max-width: 480px) {
    .nav-tab,
    .btn {
        min-height: 40px;
    }
    
    .lang-btn {
        min-height: 32px;
        min-width: 32px;
    }
    
    .history-day {
        min-height: 32px;
        min-width: 32px;
    }
}

/* ===== 37. ç‰¹æ®Šå†…å®¹å¤„ç† ===== */
.detail-item[style*="grid-column: 1 / -1"] .detail-value {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-top: 2px;
}

.detail-item .detail-value[style*="color: #f39c12"] {
  background: var(--warning-faint);
    padding: 6px 8px;
    border-radius: var(--radius-small);
    font-size: 0.8rem;
    line-height: 1.3;
}

/* ===== 38. é˜²æ­¢æ¨¡æ€æ¡†èƒŒæ™¯æ»šåŠ¨ ===== */
body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
}

/* ç§»åŠ¨ç«¯é˜²æ»šåŠ¨ä¼˜åŒ– */
@media (max-width: 768px) {
    body.modal-open {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        -webkit-overflow-scrolling: none;
    }
}

/* ===== 39. æ–°å¢ï¼šç›®å‰æœªç»ƒç´çŠ¶æ€æ ·å¼ ===== */
.student-status.not-practicing,
.student-status-compact.not-practicing,
.table-status-badge.not-practicing,
.status-badge.not-practicing {
  background: #f5f7fa;
  color: #6c757d;
  border-color: transparent;
  font-weight: 600;
  font-size: 0.75rem;
}

.practice-status-card.not-practicing,
.student-card.not-practicing {
  border-left-color: #6c757d;
}

/* è€ƒå‹¤å†å²æ—¶é—´è½´æ ·å¼ */
.history-day.not-practicing {
  background: var(--medium-gray);
  border-color: var(--medium-gray);
    color: white;
}

/* ===== 40. æ·±è‰²æ¨¡å¼å®Œæ•´é€‚é… ===== */
@media (prefers-color-scheme: dark) {
    :root {
        /* æ·±è‰²æ¨¡å¼é¢œè‰²å˜é‡é‡å®šä¹‰ */
        --background-color: #0d1117;
        --card-bg: #21262d;
        --card-hover-bg: #30363d;
        --text-color: #f0f6fc;
        --text-secondary: #8b949e;
        --text-muted: #6e7681;
        --border-color: #30363d;
        --light-gray: #21262d;
        --medium-gray: #8b949e;
        --dark-gray: #f0f6fc;
        --shadow-color: rgba(0,0,0,0.4);
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„ä¸»è‰²è°ƒè°ƒæ•´ */
        --primary-color: #58a6ff;
        --secondary-color: #3fb950;
        --warning-color: #d29922;
        --danger-color: #f85149;
        --success-color: #3fb950;
        
        /* æ·±è‰²æ¨¡å¼æ¸å˜è‰² */
        --gradient-primary: linear-gradient(135deg, #58a6ff, #3fb950);
        --gradient-card: linear-gradient(135deg, #21262d, #30363d);
  /* æ·±è‰²æ¨¡å¼çŠ¶æ€å¡ç‰‡æ¸å˜è¦†ç›– */
  --gradient-present: linear-gradient(135deg, #0d2818, #238636);
  --gradient-absent: linear-gradient(135deg, #2c0e0e, #da3633);
  --gradient-excused: linear-gradient(135deg, #2d1b00, #bb8009);
  --gradient-low-efficiency: rgba(243,156,18,0.75);
  --gradient-rate: linear-gradient(135deg, #0c1929, #1f6feb);
  --gradient-header: linear-gradient(135deg, #1f2937, #374151);
  --modal-backdrop: rgba(0,0,0,0.6);
  --modal-shadow: 0 20px 50px rgba(0,0,0,0.5);
        
        /* æ·±è‰²æ¨¡å¼é˜´å½± */
        --shadow: 0 2px 10px rgba(0,0,0,0.4);
        --shadow-hover: 0 5px 20px rgba(0,0,0,0.6);
    }
    
    /* åŸºç¡€å…ƒç´ æ·±è‰²é€‚é… */
    body {
        background: var(--background-color);
        color: var(--text-color);
    }

  /* æ·±è‰²æ¨¡å¼ - ä½¿ç”¨çº¯è‰²è€Œéæ¸å˜æ¥åŒºåˆ†çŠ¶æ€å¡ç‰‡ */
  .stats-grid-detailed .stat-item.present,
  .today-status-card.present { background: rgba(30,95,63,0.65) !important; }

  .stats-grid-detailed .stat-item.absent,
  .today-status-card.absent { background: rgba(122,31,31,0.6) !important; }

  .stats-grid-detailed .stat-item.low-efficiency,
  .today-status-card.low-efficiency { background: rgba(243,156,18,0.6) !important; }

  .stats-grid-detailed .stat-item.excused,
  .today-status-card.excused { background: rgba(139,95,34,0.6) !important; }

  /* çŠ¶æ€æ ‡ç­¾ä¸è¡¨æ ¼å†…çŠ¶æ€ä¹Ÿä½¿ç”¨çº¯è‰²èƒŒæ™¯ */
  .table-status-badge.present,
  .status-badge.present,
  .student-status.present { background: rgba(30,95,63,0.6) !important; color: var(--text-color) !important; }

  .table-status-badge.absent,
  .status-badge.absent,
  .student-status.absent { background: rgba(122,31,31,0.55) !important; color: var(--text-color) !important; }

  .table-status-badge.excused,
  .status-badge.excused,
  .student-status.excused { background: rgba(139,95,34,0.55) !important; color: var(--text-color) !important; }

  .table-status-badge.low-efficiency,
  .status-badge.low-efficiency,
  .student-status.low-efficiency { background: rgba(243,156,18,0.55) !important; color: var(--text-color) !important; }

  .table-status-badge.practicing-unscheduled,
  .status-badge.practicing-unscheduled,
  .student-status.practicing-unscheduled,
  .student-status-compact.practicing-unscheduled { background: rgba(88,166,255,0.6) !important; color: var(--text-color) !important; }

  .table-status-badge.weekend,
  .status-badge.weekend,
  .student-status.weekend,
  .student-status-compact.weekend { background: rgba(139,149,158,0.6) !important; color: var(--text-color) !important; }

  .table-status-badge.pending,
  .status-badge.pending,
  .student-status.pending,
  .student-status-compact.pending { background: rgba(108,117,125,0.6) !important; color: var(--text-color) !important; }

  .table-status-badge.not-practicing,
  .status-badge.not-practicing,
  .student-status.not-practicing,
  .student-status-compact.not-practicing { background: rgba(108,117,125,0.2) !important; color: #adb5bd !important; border-color: transparent !important; font-size: 0.75rem !important; }

  .table-status-badge.no-data,
  .status-badge.no-data,
  .student-status.no-data { background: #cccccc !important; color: #333333 !important; }

  /* ç»ƒç´æ—¶é•¿æ ‡ç­¾æ·±è‰²é€‚é… - ä¹Ÿä½¿ç”¨çº¯è‰² */
  .practice-duration,
  .practice-duration-large { background: rgba(155,89,182,0.6) !important; color: var(--text-color) !important; }
    
    /* å¡ç‰‡å’Œå®¹å™¨æ·±è‰²é€‚é… */
    .card,
    .student-card,
    .practice-status-card,
    .stat-card,
    .today-status-card {
        background: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .card:hover,
    .student-card:hover,
    .practice-status-card:hover {
        background: var(--card-hover-bg);
    }
    
    /* å¯¼èˆªå’Œæ ‡ç­¾æ·±è‰²é€‚é… */
    .nav-tabs {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .nav-tab {
        color: var(--medium-gray);
    }
    
  .nav-tab:hover {
    background: var(--accent-faint);
    color: var(--primary-color);
  }
    
    .nav-tab.active {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* è¯­è¨€åˆ‡æ¢å™¨æ·±è‰²é€‚é… */
    .language-switcher {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .lang-btn {
        color: var(--medium-gray);
    }
    
  .lang-btn:hover:not(.active) {
    background: var(--accent-faint);
    color: var(--primary-color);
  }
    
    .lang-btn.active {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨æ·±è‰²é€‚é… */
    .connection-status.online {
        background: var(--card-bg);
        color: var(--success-color);
        border-color: var(--success-color);
    }
    
    .connection-status.offline {
        background: var(--card-bg);
        color: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .connection-status.syncing {
        background: var(--card-bg);
        color: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    /* ç­›é€‰å™¨æ·±è‰²é€‚é… */
    .filters,
    .practice-filters {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .practice-filter-label,
    .filter-label {
        color: var(--medium-gray);
    }
    
    .filter-select,
    .filter-input,
    .practice-filter-select,
    .practice-filter-input,
    .date-input {
        background: var(--background-color);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .filter-select:focus,
    .filter-input:focus,
    .practice-filter-select:focus,
    .practice-filter-input:focus,
    .date-input:focus {
        border-color: var(--primary-color);
  box-shadow: 0 0 0 2px var(--accent-faint);
    }
    
    .filter-select:hover,
    .filter-input:hover,
    .practice-filter-select:hover,
    .practice-filter-input:hover,
    .date-input:hover {
        border-color: var(--primary-color);
    }
    
    /* å¿«é€Ÿç­›é€‰æ ‡ç­¾æ·±è‰²é€‚é… */
    .quick-filter-tag {
        background: var(--card-hover-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .quick-filter-tag:hover {
  background: var(--dark-gray);
        transform: translateY(-1px);
    }
    
    .quick-filter-tag.active {
        background: var(--primary-color);
        color: #0d1117;
        border-color: var(--primary-color);
    }
    
    /* æŒ‰é’®æ·±è‰²é€‚é… */
    .btn-primary {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    .btn-primary:hover {
  background: var(--primary-hover);
    }
    
    .btn-success {
        background: var(--success-color);
        color: #0d1117;
    }
    
    .btn-success:hover {
  background: var(--success-hover);
    }
    
    .btn-warning {
        background: var(--warning-color);
        color: #0d1117;
    }
    
    .btn-warning:hover {
  background: var(--warning-hover);
    }
    
    .btn-danger {
        background: var(--danger-color);
        color: #0d1117;
    }
    
    .btn-danger:hover {
  background: var(--danger-hover);
    }
    
    .btn-secondary {
        background: var(--medium-gray);
        color: #0d1117;
    }
    
    .btn-secondary:hover {
  background: var(--secondary-hover);
    }
    
    .btn-outline {
        background: transparent;
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-outline:hover {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* æ¨¡æ€æ¡†æ·±è‰²é€‚é… */
    .modal {
  background: var(--modal-backdrop-strong);
    }
    
    .modal-content {
        background: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    .modal-close {
        background: var(--card-hover-bg);
        color: var(--medium-gray);
    }
    
    .modal-close:hover {
        background: var(--danger-color);
        color: #0d1117;
    }
    
    /* è¡¨æ ¼æ·±è‰²é€‚é… */
    .data-table,
    .detail-table {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .data-table th,
    .data-table td,
    .detail-table th,
    .detail-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    .data-table th,
    .detail-table th {
        background: var(--card-hover-bg);
        color: var(--text-color);
        border-bottom-color: var(--border-color);
    }
    
    .data-table tr:hover,
    .detail-table tr:hover {
        background: var(--card-hover-bg);
    }
    
    .data-table-container,
    .table-container {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
  /* çŠ¶æ€æ ‡ç­¾æ·±è‰²æ¨¡å¼é€‚é…ï¼ˆä½¿ç”¨æ·±è‰²å˜é‡ï¼‰ */
  .student-status.present,
  .student-status-compact.present,
  .table-status-badge.present,
  .status-badge.present {
    background: var(--gradient-present);
    color: var(--text-color);
    border-color: transparent;
  }

  .student-status.absent,
  .student-status-compact.absent,
  .table-status-badge.absent,
  .status-badge.absent {
    background: var(--gradient-absent);
    color: var(--text-color);
    border-color: transparent;
  }

  .student-status.excused,
  .student-status-compact.excused,
  .table-status-badge.excused,
  .status-badge.excused {
    background: var(--gradient-excused);
    color: var(--text-color);
    border-color: transparent;
  }

  .student-status.low-efficiency,
  .student-status-compact.low-efficiency,
  .table-status-badge.low-efficiency,
  .table-status-badge.low_efficiency,
  .status-badge.low-efficiency {
    background: var(--gradient-absent);
    color: var(--text-color);
    border-color: transparent;
  }

  /* ç§»é™¤è¿™äº›æ·±è‰²æ¨¡å¼ä¸‹çš„æ¸å˜æ ·å¼ï¼Œä½¿ç”¨ä¸Šé¢çš„çº¯è‰²æ›¿ä»£ */

  .student-status.pending,
  .student-status-compact.pending,
  .table-status-badge.pending,
  .status-badge.pending {
    background: var(--card-bg);
    color: var(--text-secondary);
    border-color: transparent;
  }

  /* è¿™ä¸ªæ ·å¼å·²è¢«ä¸Šé¢çš„çº¯è‰²è¦†ç›– */
    
  /* ç§»é™¤è¿™äº›æ³¨é‡Šï¼Œå› ä¸ºä¸Šé¢å·²ç»ç”¨çº¯è‰²è¦†ç›–äº† */
    
    /* è€ƒå‹¤å†å²æ—¶é—´è½´æ·±è‰²é€‚é… */
    .history-day.present {
        background: var(--success-color);
        border-color: var(--success-color);
    }
    
    .history-day.absent {
        background: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .history-day.excused {
        background: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    .history-day.no-data {
        background: #cccccc;
        color: #333333;
        border-color: #cccccc;
    }

    .history-day.pending {
        background: #cccccc;
        color: #333333;
        border-color: #cccccc;
    }
    
    .history-day.low-efficiency {
  background: var(--amber-strong);
        border-color: #bb8009;
    }
    
    .history-day.practicing-unscheduled {
  background: var(--purple-strong);
        border-color: #a475f9;
    }
    
    .history-day.weekend {
  background: var(--muted-dark);
        border-color: #8b949e;
    }
    
    .history-day.not-practicing {
  background: var(--muted-dark);
        border-color: #8b949e;
    }
    
    /* å¡ç‰‡è¾¹æ¡†é¢œè‰²æ·±è‰²é€‚é… */
    .practice-status-card.present,
    .student-card.present {
        border-left-color: var(--success-color);
    }
    
    .practice-status-card.absent,
    .student-card.absent {
        border-left-color: var(--danger-color);
    }
    
    .practice-status-card.excused,
    .student-card.excused {
        border-left-color: var(--warning-color);
    }
    
    .practice-status-card.low-efficiency,
    .student-card.low-efficiency {
        border-left-color: #bb8009;
    }
    
    .practice-status-card.practicing-unscheduled,
    .student-card.practicing-unscheduled {
        border-left-color: #8250df;
    }
    
    .practice-status-card.weekend,
    .student-card.weekend {
        border-left-color: #6e7681;
        background: var(--gradient-card);
    }
    
    .practice-status-card.pending,
    .student-card.pending {
        border-left-color: var(--medium-gray);
    }
    
    .practice-status-card.not-practicing,
    .student-card.not-practicing {
        border-left-color: #8b949e;
    }
    
    /* åŒæ­¥çŠ¶æ€æ–‡æœ¬æ·±è‰²é€‚é… */
    #syncStatusText {
        color: var(--text-color);
    }
    
    /* åŒæ­¥æ—¥å¿—åŒºåŸŸæ·±è‰²é€‚é… */
    #syncLogs {
        background: var(--background-color) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--border-color) !important;
        scrollbar-color: var(--medium-gray) var(--background-color);
    }
    
    /* åŒæ­¥æ—¥å¿—æ»šåŠ¨æ¡æ·±è‰²é€‚é… */
    #syncLogs::-webkit-scrollbar {
        width: 8px;
        background: var(--background-color);
    }
    
    #syncLogs::-webkit-scrollbar-track {
        background: var(--card-hover-bg);
        border-radius: 4px;
    }
    
    #syncLogs::-webkit-scrollbar-thumb {
        background: var(--medium-gray);
        border-radius: 4px;
    }
    
    #syncLogs::-webkit-scrollbar-thumb:hover {
  background: var(--muted-light);
    }
    
    /* åŒæ­¥çŠ¶æ€å¡ç‰‡æ·±è‰²é€‚é… */
    #syncStatus {
        background: var(--card-bg);
        color: var(--text-color);
        border-left-color: var(--success-color);
    }
    
    #syncStatus h4 {
        color: var(--text-color);
    }
    
    /* æ“ä½œæŒ‰é’®åŒºåŸŸæ·±è‰²é€‚é… */
    .action-buttons {
        background: var(--card-bg);
        border-top-color: var(--border-color);
    }
    
    /* ç§»åŠ¨ç«¯æ“ä½œæŒ‰é’®æ·±è‰²é€‚é… */
    @media (max-width: 768px) {
        .action-buttons {
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }
    }
    
    /* ç¡®ä¿æ‰€æœ‰å¡ç‰‡æ ‡é¢˜åœ¨æ·±è‰²æ¨¡å¼ä¸‹æ­£ç¡®æ˜¾ç¤º */
    .card h3,
    .card h4,
    .card h5 {
        color: var(--text-color);
    }
    
    /* åŒæ­¥é¡µé¢ç‰¹å®šçš„æ–‡æœ¬é¢œè‰² */
    #syncTab .card p {
        color: var(--text-color);
    }
    
    /* åŒæ­¥æ—¥å¿—æ–‡æœ¬æ ·å¼ä¼˜åŒ– */
    #syncLogs {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Consolas', 'Courier New', monospace !important;
        font-size: 12px !important;
        line-height: 1.4 !important;
        white-space: pre-line !important;
        word-wrap: break-word !important;
        background: var(--background-color) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: var(--radius-small);
        padding: 12px;
    }
    
    /* åŒæ­¥æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³å’Œæ¶ˆæ¯é¢œè‰²åŒºåˆ† */
    #syncLogs {
        /* ä½¿ç”¨CSSå˜é‡æ¥ç¡®ä¿æ–‡æœ¬é¢œè‰²æ­£ç¡® */
        --log-timestamp-color: var(--medium-gray);
        --log-success-color: var(--success-color);
        --log-warning-color: var(--warning-color);
        --log-error-color: var(--danger-color);
        --log-info-color: var(--primary-color);
    }
}

  /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ï¼šä½¿ç”¨è¯­ä¹‰å˜é‡ä»¥æ”¯æŒæ—¥/å¤œé—´ä¸»é¢˜åˆ‡æ¢ */
  .stats-grid-detailed .stat-item.present {
    background: var(--gradient-present);
  }

  .stats-grid-detailed .stat-item.absent {
    background: var(--gradient-absent);
  }

  .stats-grid-detailed .stat-item.excused {
    background: var(--gradient-excused);
  }

  .stats-grid-detailed .stat-item.rate {
    background: var(--gradient-rate);
  }
    
    /* ç»Ÿè®¡å›¾æ ‡èƒŒæ™¯æ·±è‰²é€‚é… */
    .stats-grid-detailed .stat-icon,
    .metric-icon {
  background: var(--overlay-faint-2);
    }
    
    /* è¯·å‡ä¿¡æ¯æ·±è‰²é€‚é… */
    .excuse-info {
  background: var(--amber-faint);
        border-left-color: var(--warning-color);
    }
    
    .excuse-title {
        color: var(--warning-color);
    }
    
    .excuse-reason {
        color: #f2cc60;
    }
    
    .excuse-approver {
        color: #d29922;
    }
    
    /* ç©ºçŠ¶æ€æ·±è‰²é€‚é… */
    .empty-state,
    .practice-empty-state,
    .table-empty-state {
        color: var(--medium-gray);
    }
    
    .empty-state-title,
    .practice-empty-state-title,
    .table-empty-state-title {
        color: var(--text-color);
    }
    
    /* åŠ è½½åŠ¨ç”»æ·±è‰²é€‚é… */
    .spinner {
        border-color: var(--card-hover-bg);
        border-top-color: var(--primary-color);
    }
    
    .loading-text {
        color: var(--medium-gray);
    }
    
    /* æ»šåŠ¨æ¡æ·±è‰²é€‚é… */
    *::-webkit-scrollbar-track {
        background: var(--background-color);
    }
    
    *::-webkit-scrollbar-thumb {
        background-color: var(--card-hover-bg);
    }
    
    *::-webkit-scrollbar-thumb:hover {
        background-color: #484f58;
    }
    
    /* è¡¨æ ¼æ»šåŠ¨æç¤ºæ·±è‰²é€‚é… */
    .data-table-container::after,
    .table-container::after {
  background: var(--modal-backdrop-strong);
        color: var(--text-color);
    }
    
    /* è¯¦æƒ…æ ‡ç­¾æ·±è‰²é€‚é… */
    .detail-label {
        color: var(--medium-gray);
    }
    
    .detail-value {
        color: var(--text-color);
    }
    
    /* ç‰¹æ®Šå†…å®¹å¤„ç†æ·±è‰²é€‚é… */
    .detail-item .detail-value[style*="color: #f39c12"] {
  background: var(--amber-faint) !important;
        color: #f2cc60 !important;
    }
    
    /* åŒæ­¥æ—¥å¿—æ·±è‰²é€‚é… */
    #syncLogs {
        background: var(--background-color) !important;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    /* æ—¥æœŸé€‰æ‹©å™¨æ·±è‰²é€‚é… */
    .date-picker {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
  /* å­¦ç”Ÿæ¡£æ¡ˆå¡ç‰‡ï¼šåœ¨æ·±è‰²æ¨¡å¼å˜é‡ä¸­ä¼šè¢«è¦†ç›–ä¸ºæ·±è‰²ï¼Œè¿™é‡Œä½¿ç”¨è¯­ä¹‰å˜é‡ä»¥é¿å…å¼ºåˆ¶æ·±è‰² */
  .student-profile-card {
    background: var(--gradient-header);
  }
    
    /* ä»Šæ—¥çŠ¶æ€å¡ç‰‡æ·±è‰²é€‚é… */
    .today-status-card.present { border-left-color: var(--success-color); }
    .today-status-card.absent { border-left-color: var(--danger-color); }
    .today-status-card.excused { border-left-color: var(--warning-color); }
    .today-status-card.low-efficiency { border-left-color: #bb8009; }
    .today-status-card.practicing-unscheduled { border-left-color: #8250df; }
    .today-status-card.weekend { border-left-color: #6e7681; }
    
    /* æ—¶é—´æ®µæ ‡ç­¾æ·±è‰²é€‚é… */
    .time-slot-tag {
        color: var(--medium-gray);
    }
    
    .time-slot-tag:hover {
        color: var(--text-color);
    }
    
    .time-slot-tag.current {
        background: linear-gradient(135deg, #0c4a6e, #0369a1);
        color: #7dd3fc;
        border-color: #0284c7;
    }
    
    .time-slot-tag.current:hover {
        box-shadow: 0 2px 6px rgba(2, 132, 199, 0.4);
    }
    
    @keyframes pulse-glow {
        0%, 100% { 
            box-shadow: 0 1px 3px rgba(2, 132, 199, 0.3);
        }
        50% { 
            box-shadow: 0 2px 8px rgba(2, 132, 199, 0.5);
        }
    }
    
    /* æŒ‡æ ‡é¡¹æ·±è‰²é€‚é… */
    .metric-item {
        background: var(--card-hover-bg);
        border: 1px solid var(--border-color);
    }
    
    .metric-label {
        color: var(--medium-gray);
    }
    
    .metric-value {
        color: var(--text-color);
    }
    
    .practice-label {
        color: var(--medium-gray);
    }
    
    .practice-value {
        color: var(--text-color);
    }
    
    .practice-value.current-practice {
        color: var(--primary-color);
    }
    
    .practice-value.total-practice {
        color: var(--primary-color);
    }
    
    /* åŠ è½½æ›´å¤šæç¤ºæ·±è‰²é€‚é… */
    .load-more-hint {
        background: var(--card-hover-bg);
        color: var(--medium-gray);
        border-top-color: var(--border-color);
    }
    
  .load-more-hint:hover {
    background: var(--dark-gray);
  }
    
    .load-more-hint.loading {
        color: var(--primary-color);
    }
    
    /* è€ƒå‹¤å†å²æ·±è‰²é€‚é… */
    .attendance-history {
        border-top-color: var(--border-color);
    }
    
    .history-title {
        color: var(--medium-gray);
    }
    
    /* å¡ç‰‡æ ‡é¢˜æ·±è‰²é€‚é… */
    .card-title {
        color: var(--text-color);
    }
    
    .title-subtitle {
        color: var(--medium-gray);
    }
    
    /* çŠ¶æ€æ ‡é¢˜æ·±è‰²é€‚é… */
    .status-title {
        color: var(--text-color);
    }
    
    /* å­¦ç”Ÿå§“åæ·±è‰²é€‚é… */
    .student-name,
    .student-name-compact,
    .profile-name {
        color: var(--text-color);
    }
    
    /* å­¦ç”Ÿä¿¡æ¯è¡Œæ·±è‰²é€‚é… */
    .student-info-row {
        color: var(--medium-gray);
    }
    
    /* æ—¥æœŸå•å…ƒæ ¼æ·±è‰²é€‚é… */
    .date-cell {
        color: var(--text-color);
    }
    
    /* æ—¶é•¿å•å…ƒæ ¼æ·±è‰²é€‚é… */
    .duration-cell {
        color: var(--medium-gray);
    }
    
    .total-duration-cell {
        color: var(--primary-color);
    }
    
    /* ä»Šæ—¥è¡Œæ·±è‰²é€‚é… */
    .today-row {
  background: var(--accent-faint);
    }
    
    /* ä¸ªäººèµ„æ–™å…ƒæ•°æ®æ·±è‰²é€‚é… */
  .profile-meta {
    color: var(--overlay-faint-text);
  }
    
    /* ç»Ÿè®¡é¡¹å†…å®¹æ·±è‰²é€‚é… */
    .stats-grid-detailed .stat-number,
    .stats-grid-detailed .stat-label {
        color: var(--text-color);
    }
    
    /* ç»Ÿè®¡å¡ç‰‡æ•°å­—é¢œè‰²æ·±è‰²é€‚é… */
    .stat-card.present .stat-number { color: var(--success-color); }
    .stat-card.absent .stat-number { color: var(--danger-color); }
    .stat-card.excused .stat-number { color: var(--warning-color); }
    .stat-card.unscheduled .stat-number { color: #a475f9; }
    .stat-card.weekend .stat-number { color: #8b949e; }
    .stat-card.pending .stat-number { color: var(--medium-gray); }
    
    /* ç»Ÿè®¡æ ‡ç­¾å’Œæè¿°æ·±è‰²é€‚é… */
    .stat-label {
        color: var(--medium-gray);
    }
    
  .stat-description {
    color: var(--text-muted);
  }

/* ===== 41. æœ€ç»ˆä¼˜åŒ–å’Œå…¼å®¹æ€§ä¿®å¤ ===== */

/* ç¡®ä¿æ‰€æœ‰æ–‡æœ¬é€‰æ‹©é¢œè‰²ä¸€è‡´ */
  ::selection {
  background: var(--accent-faint-2);
    color: inherit;
  }
    
  ::-moz-selection {
  background: var(--accent-faint-2);
    color: inherit;
  }

/* æ·±è‰²æ¨¡å¼ä¸‹çš„æ–‡æœ¬é€‰æ‹© */
@media (prefers-color-scheme: dark) {
    ::selection {
  background: var(--accent-faint-3);
        color: inherit;
    }
    
    ::-moz-selection {
  background: var(--accent-faint-3);
        color: inherit;
    }
}

/* ç¡®ä¿æ‰€æœ‰äº¤äº’å…ƒç´ éƒ½æœ‰é€‚å½“çš„ç„¦ç‚¹æ ·å¼ */
*:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* ç§»é™¤é»˜è®¤ç„¦ç‚¹æ ·å¼ */
*:focus:not(:focus-visible) {
    outline: none;
}

/* ç¡®ä¿åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šéƒ½æœ‰è‰¯å¥½çš„è§¦æ‘¸ä½“éªŒ */
@media (pointer: coarse) {
    .student-card,
    .practice-status-card,
    .btn,
    .nav-tab,
    .quick-filter-tag,
    .history-day {
        min-height: 48px;
    }
    
    .lang-btn,
    .connection-status {
        min-height: 40px;
    }
}

/* ç¡®ä¿åœ¨é«˜åˆ†è¾¨ç‡å±å¹•ä¸Šçš„æ¸…æ™°åº¦ */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .practice-indicator {
        border: 0.5px solid transparent;
    }
    
    .history-day {
        border-width: 1.5px;
    }
    
    .card {
        border-left-width: 3px;
    }
}

/* æœ€ç»ˆçš„å“åº”å¼æ–­ç‚¹ä¼˜åŒ– */
@media (min-width: 320px) and (max-width: 374px) {
    .container {
        padding: 8px;
    }
    
    .student-grid {
        gap: 8px;
    }
    
    .card {
        padding: 12px;
    }
}

@media (min-width: 375px) and (max-width: 413px) {
    .container {
        padding: 10px;
    }
    
    .student-grid {
        gap: 10px;
    }
}

@media (min-width: 414px) and (max-width: 767px) {
    .container {
        padding: 12px;
    }
    
    .student-grid {
        gap: 12px;
    }
}

/* ç¡®ä¿åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­éƒ½æœ‰ä¸€è‡´çš„æ¸²æŸ“ */
* {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}

/* æœ€åçš„æ€§èƒ½ä¼˜åŒ– */
.student-card,
.practice-status-card,
.stat-card {
    will-change: transform;
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
}

/* ç¡®ä¿åŠ¨ç”»åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šéƒ½æµç•… */
@media (max-width: 768px) {
    .student-card,
    .practice-status-card,
    .stat-card {
        transition: transform 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    
    .btn {
        transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    
    .nav-tab {
        transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
}

/* ç¡®ä¿åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šéƒ½æœ‰é€‚å½“çš„é—´è· */
.container > *:last-child {
    margin-bottom: 0;
}

/* æœ€ç»ˆçš„å¯è®¿é—®æ€§ç¡®ä¿ */
@media (prefers-reduced-motion: reduce) {
    .student-card,
    .practice-status-card,
    .stat-card,
    .btn,
    .nav-tab,
    .quick-filter-tag {
        transition: none;
    }
    
    .modal-content {
        transition: none;
        animation: none;
    }
    
    .modal {
        transition: none;
    }
}

/* ç¡®ä¿åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­éƒ½æ­£ç¡®æ˜¾ç¤º */
@supports not (display: grid) {
    .student-grid {
        display: flex;
        flex-wrap: wrap;
    }
    
    .student-card,
    .practice-status-card {
        flex: 1 1 280px;
        margin: 10px;
    }
    
    .stats-grid {
        display: flex;
        flex-wrap: wrap;
    }
    
    .stat-card {
        flex: 1 1 200px;
        margin: 8px;
    }
}

/* æœ€ç»ˆç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½æœ‰æ­£ç¡®çš„ç›’æ¨¡å‹ */
*,
*::before,
*::after {
    box-sizing: border-box;
}

/* ç¡®ä¿åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šéƒ½æœ‰é€‚å½“çš„å­—ä½“å¤§å° */
html {
    font-size: 16px;
}

@media (max-width: 320px) {
    html {
        font-size: 15px;
    }
}

@media (min-width: 1200px) {
    html {
        font-size: 17px;
    }
}

/* æœ€ç»ˆçš„æ‰“å°ä¼˜åŒ– */
@media print {
    * {
        color: black !important;
        background: white !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }
    
    .student-grid {
        display: block !important;
    }
    
    .student-card,
    .practice-status-card {
        display: block !important;
        width: 100% !important;
        margin: 10px 0 !important;
        page-break-inside: avoid;
    }
    
    .modal,
    .language-switcher,
    .connection-status {
        display: none !important;
    }
}
/* ===== æ¨¡æ€æ¡†ä¸‹æ»‘æ‰‹åŠ¿æ”¯æŒ ===== */
.modal-content {
    /* ç°æœ‰æ ·å¼ä¿æŒä¸å˜ */
    touch-action: pan-y; /* ğŸ”¥ å…è®¸å‚ç›´æ»‘åŠ¨ */
    user-select: none; /* ğŸ”¥ é˜²æ­¢æ–‡æœ¬é€‰æ‹©å¹²æ‰°æ‰‹åŠ¿ */
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

/* ğŸ”¥ æ‹–æ‹½çŠ¶æ€ä¸‹çš„è§†è§‰åé¦ˆ */
.modal-content.dragging {
    transition: none !important;
    /* ğŸ”¥ ç¡¬ä»¶åŠ é€Ÿä¼˜åŒ–ä¸‹æ‹‰æ‰‹åŠ¿æ€§èƒ½ */
    will-change: transform;
    transform-origin: center top;
}

.modal.dragging {
    transition: none !important;
    /* ğŸ”¥ èƒŒæ™¯é€æ˜åº¦å˜åŒ–çš„ç¡¬ä»¶åŠ é€Ÿ */
    will-change: background-color;
}

/* ğŸ”¥ iOSé£æ ¼ä¸‹æ‹‰æ‰‹åŠ¿ä¼˜åŒ– */
@media (max-width: 768px) {
    .modal-content {
        /* ğŸ”¥ ç¡®ä¿è§¦æ‘¸äº‹ä»¶æ­£ç¡®å“åº” */
        touch-action: pan-y;
        /* ğŸ”¥ ä¼˜åŒ–ä¸‹æ‹‰æ‰‹åŠ¿çš„è§¦æ‘¸å“åº” */
        -webkit-overflow-scrolling: touch;
    }
}

/* ğŸ”¥ ç§»åŠ¨ç«¯æ¨¡æ€æ¡†å¤´éƒ¨å¢åŠ æ‹–æ‹½æŒ‡ç¤ºå™¨ */
@media (max-width: 768px) {
    .modal-content::before {
        content: '';
        display: block; /* ğŸ”¥ æ˜¾ç¤ºiOSé£æ ¼æ‹–æ‹½æŒ‡ç¤ºå™¨ */
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 36px;
        height: 4px;
        background: var(--text-secondary, #999);
        border-radius: 2px;
        opacity: 0.6;
        z-index: 1000;
    }
    
    .modal-header {
        padding-top: 20px; /* ğŸ”¥ ä¸ºæ‹–æ‹½æŒ‡ç¤ºå™¨ç•™å‡ºç©ºé—´ */
    }
}

/* ğŸ”¥ æ·±è‰²æ¨¡å¼ä¸‹çš„æ‹–æ‹½æŒ‡ç¤ºå™¨ */
@media (prefers-color-scheme: dark) and (max-width: 768px) {
    .modal-content::before {
        background: var(--text-secondary, #666);
        opacity: 0.8;
    }
}


/* ===============================================
   æ ·å¼æ–‡ä»¶ç»“æŸ
   é’å²›æ¢…çº½å› éŸ³ä¹å­¦æ ¡ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ
   ç‰ˆæœ¬: 4.0 å®Œæ•´ä¼˜åŒ–ç‰ˆ
   =============================================== */

/* ===== å¼ºåˆ¶æ—¥é—´æ¨¡å¼ï¼šè¦†ç›–æ½œåœ¨æ™šå£°æ˜çš„æ·±è‰²è§„åˆ™ ===== */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  /* å­¦ç”Ÿè¯¦æƒ…å¤´éƒ¨åº”ä½¿ç”¨æµ…è‰²å¡ç‰‡èƒŒæ™¯ */
  .student-header {
    background: var(--gradient-header) !important;
    color: var(--text-color) !important;
  }

  /* è€ƒå‹¤/ç»Ÿè®¡å¡ç‰‡ä½¿ç”¨æµ…è‰²å˜é‡ */
  .stats-grid-detailed .stat-item.present,
  .stats-grid-detailed .stat-item.absent,
  .stats-grid-detailed .stat-item.excused,
  .stats-grid-detailed .stat-item.rate {
    background: var(--gradient-card) !important;
    color: var(--text-color) !important;
  }

  /* çŠ¶æ€å¾½ç« ä¸å­¦ç”ŸçŠ¶æ€åœ¨æ—¥é—´åº”ä½¿ç”¨æµ…è‰²å˜é‡ */
  .status-badge,
  .student-status,
  .student-status-compact {
    background: var(--card-bg) !important;
    color: var(--text-color) !important;
    border-color: var(--border-color) !important;
  }
  
  /* ä¸ªäººèµ„æ–™å…ƒæ•°æ®ï¼ˆå­¦é™¢/ç­çº§ï¼‰åœ¨æ—¥é—´åº”æ›´æ˜¾çœ¼ */
  .profile-meta {
    color: var(--text-secondary) !important;
    opacity: 1 !important;
  }
}

/* ================= 442è¯´æ˜æ–°ç‰ˆæ ·å¼ ================= */
.lb442-doc{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.55;color:#24292f;max-width:860px;margin:0 auto;padding:4px 4px 24px;}
.lb442-head{text-align:center;margin-bottom:20px;}
.lb442-head h2{margin:0 0 6px;font-size:26px;font-weight:700;letter-spacing:.5px;background:linear-gradient(90deg,#2563eb,#7c3aed);-webkit-background-clip:text;background-clip:text;color:transparent;}
.lb442-sub{margin:0 auto 10px;font-size:14px;color:#5f6b7a;max-width:560px;}
.lb442-tagline{display:inline-block;background:#f1f5f9;color:#0f172a;font-size:12px;font-weight:600;padding:4px 10px;border-radius:999px;letter-spacing:.5px;border:1px solid #e2e8f0;}
.lb442-section{margin:26px 0 18px;}
.lb442-section h3{margin:0 0 12px;font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px;color:#1e293b;}
.lb442-section h3 span{font-size:12px;font-weight:500;color:#64748b;background:#f1f5f9;padding:2px 8px;border-radius:12px;}
.lb442-section.grid-3{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));}
.metric-card{background:#ffffff;border:1px solid #e2e8f0;border-radius:14px;padding:16px;position:relative;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 4px rgba(0,0,0,.04);transition:.25s;} .metric-card:hover{box-shadow:0 6px 18px -4px rgba(0,0,0,.15);transform:translateY(-3px);} 
.metric-card h4{margin:0;font-size:15px;font-weight:700;line-height:1.3;display:flex;justify-content:space-between;align-items:center;gap:6px;}
.metric-card h4 em{font-style:normal;font-size:11px;font-weight:600;background:#eef2ff;color:#3730a3;padding:2px 6px;border-radius:6px;}
.metric-card .desc{margin:0;font-size:12px;color:#64748b;min-height:32px;}
.metric-card ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:4px;font-size:12px;color:#334155;}
.metric-card.m1{border-color:#3b82f6;background:linear-gradient(180deg,#f0f7ff,#ffffff);} 
.metric-card.m2{border-color:#a855f7;background:linear-gradient(180deg,#f8f1ff,#ffffff);} 
.metric-card.m3{border-color:#fb923c;background:linear-gradient(180deg,#fff4e8,#ffffff);} 
.key-points{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px;font-size:14px;color:#334155;}
.key-points li{background:#f1f5f9;border:1px solid #e2e8f0;padding:8px 10px;border-radius:10px;}
.formula-box{font-family:ui-monospace,Menlo,Consolas,monospace;background:#ffffff;color:#1e293b;padding:10px 14px;border-radius:10px;font-size:13px;text-align:center;letter-spacing:.5px;border:1px solid #e2e8f0;}
.note{font-size:12px;color:#64748b;margin-top:6px;}
.two-col{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));}
.two-col h4{margin:0 0 8px;font-size:14px;font-weight:700;color:#1e293b;}
.two-col ul{margin:0;padding-left:18px;font-size:12px;color:#334155;line-height:1.5;}
.two-col ul.tight{list-style:disc;padding-left:18px;}
.examples{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
.ex{background:#ffffff;border:1px solid #e2e8f0;padding:12px 14px;border-radius:12px;position:relative;font-size:12px;line-height:1.55;color:#334155;box-shadow:0 1px 2px rgba(0,0,0,.06);} .ex p{margin:4px 0 0;}
.ex .tag{position:absolute;top:-10px;left:12px;background:#1e293b;color:#fff;font-size:11px;padding:2px 8px;border-radius:16px;font-weight:600;letter-spacing:.5px;box-shadow:0 2px 4px rgba(0,0,0,.18);} .ex .tag.ok{background:#047857;} .ex .tag.warn{background:#b45309;} .ex .tag.info{background:#0369a1;}
.principles{list-style:none;margin:0;padding:0;display:grid;gap:10px;font-size:13px;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));}
.principles li{display:flex;gap:8px;align-items:flex-start;background:#f8fafc;border:1px solid #e2e8f0;padding:10px 12px;border-radius:12px;}
.lb442-foot{margin-top:10px;font-size:11px;color:#64748b;text-align:center;padding-top:12px;border-top:1px dashed #e2e8f0;}
@media (prefers-color-scheme: dark){
  .lb442-doc{color:#e6edf3;}
  .lb442-sub{color:#94a3b8;}
  .lb442-tagline{background:#1e293b;color:#e2e8f0;border-color:#334155;}
  .metric-card{background:#1e293b;border-color:#334155;box-shadow:0 1px 2px rgba(0,0,0,.4);} .metric-card:hover{box-shadow:0 6px 18px -4px rgba(0,0,0,.55);}
  .metric-card.m1{background:linear-gradient(180deg,#0f2542,#1e293b);} .metric-card.m2{background:linear-gradient(180deg,#2b2140,#1e293b);} .metric-card.m3{background:linear-gradient(180deg,#402d14,#1e293b);} 
  .metric-card .desc{color:#94a3b8;}
  .metric-card ul{color:#cbd5e1;}
  .key-points li{background:#1e293b;border-color:#334155;color:#cbd5e1;}
  .formula-box{background:#0f172a;color:#e2e8f0;}
  .note{color:#94a3b8;}
  .ex{background:#1e293b;border-color:#334155;color:#cbd5e1;}
  .principles li{background:#1e293b;border-color:#334155;color:#cbd5e1;}
  .lb442-foot{border-top-color:#334155;color:#64748b;}
}
/* ================= 442è¯´æ˜æ–°ç‰ˆæ ·å¼ END ================= */
</style>
<style id="performance-mode-style">
/* ================= æ€§èƒ½æ¨¡å¼è¦†ç›–ï¼ˆä»…åœ¨ html.performance-mode ä¸‹ç”Ÿæ•ˆï¼‰ ================= */
html.performance-mode {
  --shadow: 0 1px 2px rgba(0,0,0,0.08) !important;
  --shadow-hover: 0 2px 4px rgba(0,0,0,0.14) !important;
}
html.performance-mode .modal.show { backdrop-filter: none !important; }
html.performance-mode .modal-content { box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important; }
html.performance-mode [data-anim="loop"],
html.performance-mode .pulse,
html.performance-mode .glow { animation-play-state: paused !important; }
html.performance-mode .anim-paused { animation-play-state: paused !important; }
html.performance-mode * { transition-duration: .18s !important; }
/* å‡å°‘å¤æ‚é˜´å½± */
html.performance-mode .card, 
html.performance-mode .panel, 
html.performance-mode .student-status,
html.performance-mode .status-badge { box-shadow: var(--shadow) !important; }
/* ç§»é™¤ä¸å¿…è¦ will-change */
html.performance-mode * { will-change: auto !important; }
/* å…³é—­è¿‡å†²å¼¹æ€§åŠ¨ç”»æ”¹ä¸ºç®€å•æ·¡å…¥ */
html.performance-mode .modal.show .modal-content { animation: fadeInUpSimple .22s ease-out forwards !important; }
html.performance-mode .modal.hiding .modal-content { animation: fadeOutDownSimple .15s ease-in forwards !important; }
@keyframes fadeInUpSimple {from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
@keyframes fadeOutDownSimple {from{opacity:1;transform:translateY(0);}to{opacity:0;transform:translateY(10px);} }
/* è¡¨æ ¼é—ªçƒä¼˜åŒ– */
html.performance-mode table td, html.performance-mode table th { backface-visibility:hidden; }
/* é™ä½é¢‘ç¹æ›´æ–°æ•°å­—çš„ç»˜åˆ¶æƒé‡ */
html.performance-mode .dynamic-number { will-change: contents !important; }
</style>

<style>
/* æœ€åè¦†ç›–ï¼šç¡®ä¿ç»Ÿè®¡æ±‡æ€»å®¹å™¨åœ¨æ—¥é—´æ¨¡å¼ä¸‹æ˜¾ç¤ºæŒ‡å®šèƒŒæ™¯ï¼ˆåªå½±å“å®¹å™¨èƒŒæ™¯ä¸å½¢çŠ¶ï¼‰ */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  /* æ·±ä¸€äº›çš„æµ…è‰²å˜ä½“ä»¥å¢å¼ºå¯è¯»æ€§ */
  .stats-grid-detailed .stat-item.present { background: linear-gradient(135deg,#dff5e6,#bff0cf) !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.absent { background: linear-gradient(135deg,#ffecec,#ffcfcf) !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.low-efficiency { background: linear-gradient(135deg,#fff4d9,#ffe3a8) !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.excused { background: linear-gradient(135deg,#fff6e6,#ffe4be) !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.pending { background: #eef0f3 !important; border-radius: 12px !important; }

  /* éšè—å¾…è€ƒå‹¤çš„æ•°é‡ï¼Œä»…åœ¨ç»Ÿè®¡æ±‡æ€»ä¸­éšè— .stat-number */
  .stats-grid-detailed .stat-item.pending .stat-number { display: none !important; }
}

/* æ—¥é—´æ¨¡å¼ä¸“ç”¨ï¼šç¡®ä¿å½“å‰æ—¶é—´æ®µæ ‡ç­¾ä½¿ç”¨æµ…è‰²é«˜äº®ï¼Œä¼˜å…ˆè¦†ç›–æ·±è‰²æ ·å¼ */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  .time-slot-tag.current {
    background: linear-gradient(135deg, #d1ecf1, #bee5eb) !important;
    color: #0c5460 !important;
    border: 1px solid #b8daff !important;
    box-shadow: 0 1px 3px rgba(12, 84, 96, 0.2) !important;
  }
  .time-slot-tag.current:hover {
    box-shadow: 0 2px 6px rgba(12,84,96,0.3) !important;
    transform: translateY(-1px) !important;
  }
}

/* è¿›ä¸€æ­¥ç»†åŒ–ï¼šç¡®ä¿æ•°å­—å±…ä¸­ã€æ–‡æœ¬è§„æ•´ã€è¯´æ˜çœç•¥æº¢å‡º */
.stats-grid-detailed .stat-item {
  justify-content: center;
}
.stats-grid-detailed .stat-left {
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 0;
}
.stats-grid-detailed .stat-content {
  min-width: 0;
  text-align: center;
}
.stats-grid-detailed .stat-label,
.stats-grid-detailed .stat-desc {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.stats-grid-detailed .stat-number {
  text-align: center;
  width: 100%;
}

</style>
</head>
<body>
<!-- ===== é¡µé¢ä¸»ä½“ï¼ˆä¸ä½ åŸå§‹ç‰ˆæœ¬ä¸€è‡´ï¼Œè¿™é‡Œä¿æŒä¸åŠ¨ï¼‰ ===== -->
<div class="container">
  <div class="language-switcher">
    <button class="lang-btn" onclick="switchLanguage('zh')" data-lang="zh">ä¸­æ–‡</button>
    <button class="lang-btn" onclick="switchLanguage('en')" data-lang="en">EN</button>
  </div>
  <div id="connectionStatus" class="connection-status offline">
    <span data-i18n="status.offline">ğŸ”´ ç¦»çº¿æ¨¡å¼</span>
  </div>
  <div class="header">
    <h1><span data-i18n="header.title">ğŸ¼ é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡</span></h1>
    <div class="subtitle" data-i18n="header.subtitle">å®æ—¶ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ</div>
  </div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('dashboard')"><span data-i18n="nav.dashboard">ğŸ“Š è€ƒå‹¤æ¦‚è§ˆ</span></button>
    <button class="nav-tab" onclick="switchTab('students')"><span data-i18n="nav.students">ğŸ‘¥ å­¦ç”Ÿè¯¦æƒ…</span></button>
  <button class="nav-tab" onclick="switchTab('leaderboard')"><span data-i18n="nav.leaderboard">ğŸ† 442æ’è¡Œæ¦œ</span></button>
    <button class="nav-tab" onclick="switchTab('sync')"><span data-i18n="nav.sync">ğŸ”„ æ•°æ®åŒæ­¥</span></button>
  </div>

  <div id="dashboardTab" class="tab-content">
    <div class="stats-grid">
      <div class="stat-card present">
        <div class="stat-number" id="presentCount">0</div>
        <div class="stat-label" data-i18n="stats.present">å‡ºå‹¤</div>
        <div class="stat-description" data-i18n="stats.present.desc">å½“å‰åœ¨ç´æˆ¿</div>
      </div>
      <div class="stat-card absent">
        <div class="stat-number" id="absentCount">0</div>
        <div class="stat-label" data-i18n="stats.absent">ç¼ºå‹¤</div>
        <div class="stat-description" data-i18n="stats.absent.desc">åº”åˆ°æœªåˆ°</div>
      </div>
      <div class="stat-card excused">
        <div class="stat-number" id="excusedCount">0</div>
        <div class="stat-label" data-i18n="stats.excused">è¯·å‡</div>
        <div class="stat-description" data-i18n="stats.excused.desc">å·²æ‰¹å‡†è¯·å‡</div>
      </div>
      <div class="stat-card self-practice">
  <!-- è‡ªä¸»ç»ƒç´äººæ•°ï¼šä¹‹å‰è¯¯ç”¨ pendingCountï¼Œç°æ–°å¢ selfPracticeCountï¼Œä¿ç•™æ—§IDé¿å…å…¶ä»–åœ°æ–¹å¼•ç”¨å¤±æ•ˆ -->
  <div class="stat-number" id="selfPracticeCount">0</div>
  <div class="stat-number" id="pendingCount" style="display:none;">0</div>
        <div class="stat-label" data-i18n="stats.self_practice">è‡ªä¸»ç»ƒç´</div>
        <div class="stat-description" data-i18n="stats.self_practice.desc">éè§„å®šæ—¶é—´æ®µç»ƒç´</div>
      </div>
    </div>
    <div class="card" id="excuseInfoPanel" style="display:none;">
      <h3 data-i18n="excuse.title">ğŸ“ ä»Šæ—¥è¯·å‡ä¿¡æ¯</h3>
      <div id="excuseInfoContainer"></div>
    </div>
    <div class="card">
      <h3 data-i18n="practice.title">ğŸ¹ å®æ—¶ç»ƒç´çŠ¶æ€</h3>
      <div class="date-picker">
        <span class="current-time-display">
          <span data-i18n="practice.current_time">å½“å‰æ—¶é—´ï¼š</span>
          <span id="currentTime"></span>
        </span>
      </div>
      <div id="practiceStatusContainer"></div>
    </div>
  </div>

  <div id="studentsTab" class="tab-content" style="display:none;">
    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.major">ä¸“ä¸šç­›é€‰</label>
          <select id="majorFilter" class="filter-select" onchange="filterStudents()">
            <option value="" data-i18n="filter.all_majors">æ‰€æœ‰ä¸“ä¸š</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.grade">å¹´çº§ç­›é€‰</label>
          <select id="gradeFilter" class="filter-select" onchange="filterStudents()">
            <option value="" data-i18n="filter.all_grades">æ‰€æœ‰å¹´çº§</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.status">è€ƒå‹¤çŠ¶æ€</label>
          <select id="statusFilter" class="filter-select" onchange="filterStudents()">
            <option value="" data-i18n="filter.all_status">æ‰€æœ‰çŠ¶æ€</option>
            <option value="present" data-i18n="status.present">å‡ºå‹¤</option>
            <option value="absent" data-i18n="status.absent">ç¼ºå‹¤</option>
            <option value="excused" data-i18n="status.excused">è¯·å‡</option>
            <option value="practicing-unscheduled" data-i18n="status.practicing_unscheduled">è‡ªä¸»ç»ƒç´</option>
            <option value="not-practicing" data-i18n="status.not_practicing">æœªç»ƒç´</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.search">æœç´¢å­¦ç”Ÿ</label>
          <input type="text" id="studentSearch" class="filter-input" data-i18n-placeholder="filter.search_placeholder" placeholder="è¾“å…¥å­¦ç”Ÿå§“å..." oninput="filterStudents()">
        </div>
      </div>
    </div>
    <div id="studentList" class="student-grid"></div>
  </div>

  <!-- æ’è¡Œæ¦œ Tabï¼ˆæ›¿æ¢åŸå†å²æŠ¥å‘Šï¼‰ -->
  <div id="leaderboardTab" class="tab-content" style="display:none;">
    <div class="leaderboard-container" id="leaderboard-section">
      <div class="leaderboard-title-container">
        <h3 class="leaderboard-title">442ç»ƒç´æ’è¡Œæ¦œ</h3>
        <button onclick="showHistoryLeaderboard()" class="leaderboard-history-btn" title="æŸ¥çœ‹å†å²æ’è¡Œæ¦œ">ğŸ“…</button>
      </div>
      
      <!-- æ’è¡Œæ¦œæŒ‰é’®åŒºåŸŸï¼ˆå»é™¤åˆ·æ–°æŒ‰é’®ï¼‰ -->
      <div class="leaderboard-action-bar">
  <div class="lb-left">
    <div id="leaderboard-refresh-status" class="leaderboard-status minimal" data-mode="idle">å°šæœªè®¡ç®—</div>
  </div>
        <div class="lb-center">
          <button onclick="showLeaderboardDetail()" class="leaderboard-btn lb-info" title="æŸ¥çœ‹442æµ‹è¯„ä½“ç³»è§„åˆ™">ğŸ“Š 442æµ‹è¯„ä½“ç³»è§„åˆ™è¯´æ˜</button>
        </div>
        <div class="lb-right">
          <button class="leaderboard-btn lb-expand" id="lb-toggle-more" style="display:none;" data-i18n="leaderboard.expand">å±•å¼€å…¨éƒ¨</button>
        </div>
      </div>
      
      <div class="table-responsive" style="overflow-x:auto;">
        <table class="leaderboard-table" id="leaderboard-table">
          <thead>
            <tr>
              <th style="width:80px;">æ’å</th>
              <th data-i18n="student.name">å§“å</th>
              <th data-i18n="student.grade">å¹´çº§</th>
              <th data-i18n="student.major">ä¸“ä¸š</th>
              <th style="width:120px;">æ€»åˆ†</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="syncTab" class="tab-content" style="display:none;">
    <div class="card">
      <h3 data-i18n="sync.title">ğŸ”„ æ•°æ®åŒæ­¥ç®¡ç†</h3>
      <div class="card success" id="syncStatus">
        <h4 data-i18n="sync.status">åŒæ­¥çŠ¶æ€</h4>
        <p id="syncStatusText" data-i18n="sync.checking">æ­£åœ¨æ£€æŸ¥è¿æ¥çŠ¶æ€...</p>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="forceSync()"><span>ğŸ”„</span><span data-i18n="btn.force_sync">å¼ºåˆ¶åŒæ­¥</span></button>
          <button class="btn btn-warning" onclick="clearLocalCache()"><span>ğŸ—‘ï¸</span><span data-i18n="btn.clear_cache">æ¸…é™¤ç¼“å­˜</span></button>
        </div>
      </div>
      <div class="card">
        <h4 data-i18n="sync.logs">ğŸ“‹ åŒæ­¥æ—¥å¿—</h4>
        <div id="syncLogs" style="max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px;white-space:pre-line;"></div>
      </div>
    </div>
  </div>
</div>

<!-- å­¦ç”Ÿè¯¦æƒ…æ¨¡æ€ -->
<div id="studentDetailModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="studentDetailTitle" data-i18n="student.detail.title">å­¦ç”Ÿè¯¦æƒ…</h3>
      <button class="modal-close" onclick="closeModal('studentDetailModal')">&times;</button>
    </div>
    <div id="studentDetailContent"></div>
  </div>
</div>

<!-- è€ƒå‹¤è¯¦æƒ…æ¨¡æ€ï¼ˆåŠ¨æ€åˆ›å»ºæ—¶ä¹Ÿä¼šä½¿ç”¨è¿™ä¸ªIDï¼‰ -->
<div id="attendanceDetailModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:800px;"></div>
</div>

<script>
// ================== ç»ƒç´è´¨é‡æ’è¡Œæ¦œæ ¸å¿ƒé€»è¾‘ï¼ˆæ–°å¢ï¼‰ ==================
// ä¾èµ–ï¼šstudentDatabase, studentTimeSlots, å·²æœ‰çš„è·å–å­¦ç”Ÿå®é™…ç»ƒç´åŒºé—´/ç»Ÿè®¡å‡½æ•°ï¼ˆéœ€å¤ç”¨ï¼‰

// å…¨å±€ç¦ç”¨ï¼ˆæ–°å¢ä½ç½®ï¼Œç¡®ä¿ä½äºé¦–æ¬¡è°ƒç”¨å‰ï¼‰
if(typeof window!=='undefined' && window.ALLOW_SUMMARY_RECONSTRUCT===undefined){
  window.ALLOW_SUMMARY_RECONSTRUCT=false;
}

let leaderboardState = {
  lastCompute: 0,
  raw: [],
  expanded: false,
  pending: false
};

// === æ¯æ—¥å†å²æ’è¡Œæ¦œå¿«ç…§ä¿éšœæœºåˆ¶ ===
(function setupDailySnapshotGuard(){
  const SNAPSHOT_GUARD_FLAG_KEY = 'leaderboard_history_guard_saved_date';
  function todayKey(){
    return formatDate(new Date()).replace(/\//g,'-');
  }
  function hasTodaySnapshot(){
    try {
      const snapshots = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      return !!snapshots[todayKey()];
    } catch { return false; }
  }
  function markGuard(){
    localStorage.setItem(SNAPSHOT_GUARD_FLAG_KEY, todayKey());
  }
  function guardShouldRun(){
    return localStorage.getItem(SNAPSHOT_GUARD_FLAG_KEY)!==todayKey();
  }
  function attemptGuardSave(reason){
    const now = new Date();
    const freezeMin = getTodayFreezeMinutes(now);
    const curMin = now.getHours()*60 + now.getMinutes();
    const pastCutoff = curMin >= (freezeMin + 1); // å†»ç»“å+1åˆ†é’Ÿ
    if(!pastCutoff) return; // æœªåˆ°æ—¶é—´
    if(hasTodaySnapshot()){ markGuard(); return; }
    if(!guardShouldRun()) return;
    // éœ€è¦å½“å‰çš„ rows æ•°æ®ï¼Œå¦‚æœå°šæœªè®¡ç®—åˆ™è®¡ç®—ä¸€æ¬¡
    if(!leaderboardState.raw || !leaderboardState.raw.length){
      console.log('[å¿«ç…§ä¿éšœ] è§¦å‘é‡ç®—ä»¥ä¿å­˜å¿«ç…§');
      computeLeaderboard();
    } else {
      console.log('[å¿«ç…§ä¿éšœ] ç›´æ¥ä¿å­˜å¿«ç…§ (åŸå› :'+reason+')');
      saveLeaderboardSnapshot(leaderboardState.raw);
    }
    if(hasTodaySnapshot()){
      console.log('[å¿«ç…§ä¿éšœ] æˆåŠŸè¡¥ä¿å­˜ä»Šæ—¥å¿«ç…§');
      markGuard();
    }
  }
  // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  setInterval(()=>attemptGuardSave('interval'), 60*1000);
  // é¡µé¢é‡æ–°å¯è§æ—¶æ£€æŸ¥
  document.addEventListener('visibilitychange',()=>{ if(!document.hidden) attemptGuardSave('visibility'); });
  // é¡µé¢åŠ è½½å®Œæˆåå»¶è¿Ÿ 10 ç§’æ‰§è¡Œä¸€æ¬¡ï¼ˆé˜²æ­¢åˆå§‹æœªè¿‡21:30è¯¯è§¦å‘ï¼‰
  setTimeout(()=>attemptGuardSave('initial'), 10*1000);
})();

function getTodayWeekdayKey(){
  // ä¿®æ”¹ï¼šå‘¨æœ«ä¸å‚ä¸è®¡ç®—ï¼Œè¿”å›null
  // æµ‹è¯•åŠŸèƒ½ï¼šå¯ä»¥é€šè¿‡ window.__simulateWeekend = true æ¥æ¨¡æ‹Ÿå‘¨æœ«
  if(window.__simulateWeekend) return null;
  
  const wd = new Date().getDay(); // 0=å‘¨æ—¥ 6=å‘¨å…­
  // å‘¨æœ«è¿”å›nullï¼Œå·¥ä½œæ—¥è¿”å›å¯¹åº”é”®å
  if(wd === 0 || wd === 6) return null;
  const map = {1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  return map[wd];
}

// === æ–°å¢ï¼šæ’è¡Œæ¦œæ´»åŠ¨æ—¥æœŸé€»è¾‘ï¼ˆæ—©ä¸Š8ç‚¹å‰æ˜¾ç¤ºå‰ä¸€å¤© ===ï¼‰
let __activeLeaderboardDate = null; // YYYY-MM-DD (åŸºäº serverNowMs)
function getServerDateParts(d){return {y:d.getFullYear(),m:d.getMonth(),day:d.getDate()};}
function dateToKey(y,m,day){return `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;}
function getActiveLeaderboardDate(){
  const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
  const hour = now.getHours();
  const {y,m,day} = getServerDateParts(now);
  if(hour < 8){
    // å‰ä¸€å¤©
    const prev = new Date(now.getTime()-24*60*60*1000);
    const {y:py,m:pm,day:pd} = getServerDateParts(prev);
    return dateToKey(py,pm,pd);
  }
  return dateToKey(y,m,day);
}
function ensureActiveLeaderboardDate(){
  const key = getActiveLeaderboardDate();
  if(__activeLeaderboardDate!==key){
    __activeLeaderboardDate = key;
    console.log('[Leaderboard] æ´»åŠ¨æ—¥æœŸåˆ‡æ¢ä¸º', key);
  }
  return __activeLeaderboardDate;
}

// æ—©æ™¨æ ¡éªŒï¼šè‹¥ <08:00 ï¼Œå¯¹æ˜¨å¤©å¿«ç…§è¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥
(function morningSnapshotFix(){
  const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
  if(now.getHours()>=8) return; // ä»…åœ¨æ—©ä¸Š8ç‚¹å‰
  try {
    const todayKey = formatDate(now).replace(/\//g,'-');
    const yesterday = new Date(now.getTime()-24*60*60*1000);
    const yKey = formatDate(yesterday).replace(/\//g,'-');
    const snapshots = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
    let snap = snapshots[yKey];
    const missing = !snap;
    if(missing){
      console.warn('[æ™¨é—´ä¿®å¤] æ˜¨æ—¥å¿«ç…§ç¼ºå¤±ï¼Œå°è¯•é‡å»º');
    }
    // é‡æ–°è®¡ç®—æ˜¨å¤© (æœ€ç®€ï¼šå¤ç”¨ä»Šæ—¥è®¡ç®—é€»è¾‘å‡è®¾æ•°æ®ä»å¯è¿˜åŸ) â€”â€” æ ‡è®°ä¸´æ—¶ override
    window.__computeDateOverride = yKey; // YYYY-MM-DD
    window.__skipSnapshotOnce = true; // è®¡ç®—æ—¶ä¸è‡ªåŠ¨ä¿å­˜æ™®é€šå¿«ç…§
    computeLeaderboard();
    delete window.__computeDateOverride;
    const rows = (leaderboardState.raw||[]);
  if(!rows.length){ console.log('[æ™¨é—´ä¿®å¤] é‡æ–°è®¡ç®—æ— æ•°æ®ï¼Œè·³è¿‡'); return; }
    // ç”Ÿæˆ hash å¯¹æ¯”
    function hashString(str){ let h=5381,i=str.length; while(i) h=(h*33)^str.charCodeAt(--i); return (h>>>0).toString(16); }
    const compact = rows.slice(0,20).map(r=>({n:r.name,t:r.total,d1:r.dim1.score,d2:r.dim2.score,d3:r.dim3.score}));
    const newHash = hashString(JSON.stringify(compact));
  const oldHash = snap && snap.meta && snap.meta.rowsHash;
  if(!missing && oldHash && oldHash === newHash){ console.log('[æ™¨é—´ä¿®å¤] æ˜¨æ—¥å¿«ç…§ä¸€è‡´ï¼Œæ— éœ€è¦†ç›–'); return; }
  console.warn(`[æ™¨é—´ä¿®å¤] ${missing? 'ç¼ºå¤±é‡å»º':'å“ˆå¸Œä¸ä¸€è‡´è¦†ç›–'}`);
  window.__snapshotSourceOverride = missing? 'morning-rebuild':'final-morning-fix';
    saveLeaderboardSnapshot(rows); // ä½¿ç”¨æ˜¨å¤© dateKey è¦†ç›– => éœ€ä¸´æ—¶ä¿®æ”¹ä¿å­˜é€»è¾‘çš„æ—¥æœŸé”®? ç®€åŒ–: ç›´æ¥æ‰‹åŠ¨å†™å…¥
    // æ‰‹åŠ¨å†™å…¥æŒ‡å®šé”®ï¼ˆè¦†ç›– save é»˜è®¤ä»Šå¤©ï¼‰
    try {
      const all = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      const nowMs = (window.serverNowMs?window.serverNowMs():Date.now());
      all[yKey] = {
        date: yKey,
        timestamp: nowMs,
        data: rows.slice(0,20),
        totalCount: rows.length,
        isTestData: false,
        meta: {version:1,source:'final-morning-fix',computedAt:new Date(nowMs).toISOString(),offsetMs:window.__serverTimeOffsetMs||0,rowsHash:newHash}
      };
      localStorage.setItem('leaderboard_history', JSON.stringify(all));
      console.log('[æ™¨é—´ä¿®å¤] å·²è¦†ç›–æ˜¨æ—¥å¿«ç…§');
    } catch(e){ console.error('[æ™¨é—´ä¿®å¤] è¦†ç›–å¤±è´¥', e); }
  } catch(e){ console.error('[æ™¨é—´ä¿®å¤] é”™è¯¯', e); }
})();

// è·å–æŸå­¦ç”Ÿä»Šå¤©çš„æ ‡å‡†ç»ƒç´æ®µæ•°ç»„ [{startMinute,endMinute}]
function getStudentTodaySlots(name){
  const key = getTodayWeekdayKey();
  if(!key||!studentTimeSlots[name]||!Array.isArray(studentTimeSlots[name][key])) {
    console.debug(`[getStudentTodaySlots] ${name}: no slots for ${key}`);
    return [];
  }
  const slots = studentTimeSlots[name][key].map(s=>({
    start: s.start||s.startTime||s.s||s.begin,
    end: s.end||s.endTime||s.e||s.finish,
    startMinute: toMinute(s.start||s.startTime||s.s||s.begin),
    endMinute: toMinute(s.end||s.endTime||s.e||s.finish)
  })).filter(x=>Number.isFinite(x.startMinute)&&Number.isFinite(x.endMinute)&&x.endMinute>x.startMinute);
  console.debug(`[getStudentTodaySlots] ${name}: ${slots.length} slots for ${key}:`, slots);
  return slots;
}

function toMinute(str){
  if(typeof str==='number') return str;
  if(!str||typeof str!=='string') return NaN;
  const m = str.trim();
  const mt = m.match(/^(\d{1,2}):(\d{1,2})$/);
  if(!mt) return NaN;return parseInt(mt[1])*60+parseInt(mt[2]);
}

// ================= æ–°442æµ‹è¯„ç®—æ³•å‚æ•°ï¼ˆå¯è°ƒï¼‰ =================
const LB442_PARAMS = {
  dim1:{
    coverageCompleteThreshold:0.6, // å•æ®µè¦†ç›–å®Œæˆé˜ˆå€¼ï¼ˆä»ç”¨äºâ€œå®Œæˆæ®µâ€ç»Ÿè®¡å±•ç¤ºï¼‰
    absentThreshold:0.1,           // è¦†ç›–ä½äº10%è§†ä¸ºç¼ºå¸­æ®µ
    graceMinutes:5,                // è¿Ÿåˆ°å®½é™
    P_incomplete:40,               // (1-å®Œæˆç‡)*P çš„æ‰£åˆ†ä¸Šé™
    pLate:0.4,                     // è¿Ÿåˆ°æ¯åˆ†é’Ÿæ‰£åˆ†
    lateCap:20,                    // è¿Ÿåˆ°æ‰£åˆ†å°é¡¶
    pAbsent:15,                    // ç¼ºå¸­æ®µå›ºå®šç½šåˆ†
    fullBonus:3                    // å…¨å‹¤åŠ åˆ†ï¼ˆä¸è¶…è¿‡40é€»è¾‘å‰æˆªæ–­ï¼‰
  },
  dim2:{
    longStartMin:120,
    longCapExtraMin:120,
    pLong:0.25,
    // lowEffWindows æ”¹ä¸ºåŠ¨æ€å‡½æ•° (è§ getDailyLowEffWindows)
    pWindow:0.3,
    windowCapPerSession:18,
  shortThreshold:30,
    pShort:0.5,
  // morningWindow å·²åˆ é™¤ï¼šæ—©æ™¨åŠ æˆé€»è¾‘ç§»é™¤
    pTail:0.4,
    tailGrace:15,
    tailCapMinutes:30
  },
  dim3:{
    maxRank:20,
    percentStart:0.20,             // ç¬¬ä¸€ååŠ æˆç™¾åˆ†æ¯”
    percentStep:0.01,              // æ¯ä¸‹é™ä¸€åå‡çš„ç™¾åˆ†æ¯”
    
    // æ–°å¢ï¼šå¤šå› å­æƒé‡åˆ†é…
    factors: {
      yesterdayRank: 0.50,         // æ˜¨æ—¥æ’åæƒé‡ 50%
      weeklyProgress: 0.25,        // å‘¨è¿›æ­¥å¹…åº¦æƒé‡ 25%
      consistency: 0.15,           // ç¨³å®šæ€§æƒé‡ 15%
      freshness: 0.10              // æ–°é²œåº¦å¥–åŠ±æƒé‡ 10%
    },
    
    // åéœ¸æ¦œæœºåˆ¶
    antiDomination: {
      maxConsecutiveDays: 5,       // è¿ç»­ç™»é¡¶æœ€å¤šå¤©æ•° (å·¥ä½œæ—¥)
      decayAfterDays: 3,           // è¿ç»­ç™»é¡¶3å¤©åå¼€å§‹è¡°å‡ (å·¥ä½œæ—¥)
      decayRate: 0.8,              // æ¯å¤©è¡°å‡ç³»æ•°
      breakPeriod: 2               // éœ€è¦ä¸­æ–­å‡ å¤©æ‰èƒ½é‡ç½® (å·¥ä½œæ—¥)
    },
    
    // è¿›æ­¥å¥–åŠ±
    progressBonus: {
      enabled: true,
      maxBonus: 0.05,              // æœ€å¤§è¿›æ­¥å¥–åŠ±5%
      rankImproveThreshold: 3      // æ’åæå‡3ä½ä»¥ä¸Šæ‰æœ‰å¥–åŠ±
    },
    
    // ç¨³å®šæ€§è¯„ä¼°
    stabilityWindow: 5,            // è¿‡å»5ä¸ªå·¥ä½œæ—¥ç¨³å®šæ€§çª—å£
    minDaysForStability: 3         // è‡³å°‘3ä¸ªå·¥ä½œæ—¥æ•°æ®æ‰è®¡ç®—ç¨³å®šæ€§
  }
};

function parseHHMM(str){
  if(!str) return NaN; const m=str.match(/^(\d{1,2}):(\d{2})$/); if(!m) return NaN; return +m[1]*60+ +m[2];
}
function minutesDiff(a,b){return (b-a)/60000;}

// ç»´åº¦1ï¼šå›ºå®šç»ƒç´å®Œæˆç‡ + è¿Ÿåˆ°ä¸ç¼ºå¸­æ‰£åˆ† => äº§å‡º 0~40
function computeDimension1(slots, practiceIntervals, dateStr){
  const p = LB442_PARAMS.dim1;
  if(!slots.length) return {completed:0,total:0,rate:0,score:0,latenessMinutes:0,latePenalty:0,absentSlots:0,absentPenalty:0,incompletePenalty:0};
  // é¢„å¤„ç†ï¼šè·å–æ¯æ®µè¦†ç›–ç§’æ•°
  let completed=0, absent=0; let latePenalty=0; let totalRequiredMin=0; let firstStartsCache=[];
  for(const slot of slots){
    const slotStartMs = new Date(`${dateStr}T${slot.start}:00`).getTime();
    const slotEndMs = new Date(`${dateStr}T${slot.end}:00`).getTime();
    const durMin = (slotEndMs-slotStartMs)/60000; if(durMin<=0) continue; totalRequiredMin += durMin;
    const overlapSec = calcOverlapSeconds(practiceIntervals, slotStartMs, slotEndMs);
    const coverage = durMin>0 ? (overlapSec/60)/durMin : 0;
    // æ”¹åŠ¨ï¼šè‹¥æœ‰ä»»æ„è¦†ç›–(>0)ä¸å†åˆ¤å®šç¼ºå¸­ï¼›ç¼ºå¸­ä»…åœ¨å®Œå…¨ 0 è¦†ç›–æ—¶ç»Ÿè®¡ï¼›ä½è¦†ç›–ä½†>0 å½’å…¥â€œæœªå®Œæˆâ€ç”± incompletePenalty ç»Ÿä¸€å¤„ç†
    if(coverage >= p.coverageCompleteThreshold) {
      completed++;
    } else if(overlapSec === 0) { // å®Œå…¨æ— è¦†ç›–æ‰è®°ç¼ºå¸­
      absent++;
    } // else: éƒ¨åˆ†è¦†ç›–ä½†æœªå®Œæˆï¼Œä¸è®¡å…¥ completed/absentï¼Œä»…å½±å“ (1-rate)
    // è¿Ÿåˆ°ï¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸æœ¬æ®µæœ‰äº¤é›†çš„ç»ƒç´å¼€å§‹æ—¶é—´
    let firstStartMs = null;
    for(const iv of practiceIntervals){ if(iv.end<=slotStartMs) continue; if(iv.start>=slotEndMs) break; firstStartMs = Math.max(iv.start, slotStartMs); break; }
    if(firstStartMs){
      const lateMin = Math.max(0, Math.floor(minutesDiff(slotStartMs, firstStartMs)-p.graceMinutes));
      if(lateMin>0){ latePenalty += lateMin * p.pLate; firstStartsCache.push(lateMin); }
    }
  }
  const rate = completed / slots.length;
  const incompletePenalty = (1-rate)*p.P_incomplete;
  latePenalty = Math.min(latePenalty, p.lateCap);
  const absentPenalty = absent * p.pAbsent;
  let raw = 100 - incompletePenalty - latePenalty - absentPenalty;
  if(rate===1 && latePenalty===0 && absent===0) raw += p.fullBonus;
  raw = Math.max(0, Math.min(raw, 100));
  const score = +( (raw/100)*40 ).toFixed(2);
  return {completed,total:slots.length,rate,score,latenessMinutes:firstStartsCache.reduce((a,b)=>a+b,0),latePenalty:+latePenalty.toFixed(2),absentSlots:absent,absentPenalty:+absentPenalty.toFixed(2),incompletePenalty:+incompletePenalty.toFixed(2)};
}

// ç»´åº¦2ï¼šè´¨é‡æ•ˆç‡ï¼ˆæ‰£åˆ†åˆ¶ï¼‰ => 0~40
function computeDimension2(slots, practiceIntervals, dateStr){
  const p = LB442_PARAMS.dim2;
  if(!practiceIntervals || !practiceIntervals.length) return {actual:0,required:0,ratio:0,score:0,penalties:{long:0,window:0,short:0,tail:0},details:[]};
  // åˆå¹¶ç»ƒä¹ åŒºé—´
  const merged = mergePracticeIntervalsMs(practiceIntervals);
  const windows = getDailyLowEffWindows(dateStr).map(w=>({start:parseHHMM(w.start), end:parseHHMM(w.end)})).filter(x=>x.start<x.end);
  // ç»Ÿè®¡
  let totalPracticeMin=0; let longPenalty=0, windowPenalty=0, shortPenalty=0, tailPenalty=0; const details=[];
  for(const iv of merged){
    const startMin = toDayMinute(iv.start, dateStr);
    const endMin = toDayMinute(iv.end, dateStr);
    if(endMin<=startMin) continue;
    const L = endMin-startMin; totalPracticeMin += L; details.push({startMin,endMin,durationMin:L});
    // è¶…é•¿
    if(L>p.longStartMin){ const over = Math.min(L - p.longStartMin, p.longCapExtraMin); longPenalty += over * p.pLong; }
    // ä½æ•ˆçª—å£è¦†ç›–
    let overlapLow=0; for(const win of windows){ if(endMin<=win.start||startMin>=win.end) continue; overlapLow += Math.min(endMin, win.end)-Math.max(startMin, win.start);} 
    if(overlapLow>0){ windowPenalty += Math.min(overlapLow * p.pWindow, p.windowCapPerSession); }
    // çŸ­æ—¶
    if(L < p.shortThreshold){ shortPenalty += (p.shortThreshold - L) * p.pShort; }
  }
  // æ§½å¤–æ‹–å°¾ï¼šç®€å•ç­–ç•¥ï¼Œç»ƒä¹ åŒºé—´ç»“æŸç‚¹è‹¥è¶…å‡ºä»»æ„ slot ç»“æŸ>tailGrace è®°ä¸€æ¬¡
  const slotEnds = (slots||[]).map(s=>parseHHMM(s.end));
  for(const iv of merged){
    const endMin = toDayMinute(iv.end, dateStr);
    const startMin = toDayMinute(iv.start, dateStr);
    for(const s of slotEnds){ if(startMin < s && endMin > s + p.tailGrace){ const tail = Math.min(endMin - (s + p.tailGrace), p.tailCapMinutes); tailPenalty += tail * p.pTail; break; } }
  }
  const totalPenalty = longPenalty + windowPenalty + shortPenalty + tailPenalty;
  let raw = 100 - totalPenalty; raw = Math.max(0, Math.min(raw,100));
  const score = +((raw/100)*40).toFixed(2);
  return {actual:Math.round(totalPracticeMin), required:0, ratio:raw/100, score, penalties:{long:+longPenalty.toFixed(2),window:+windowPenalty.toFixed(2),short:+shortPenalty.toFixed(2),tail:+tailPenalty.toFixed(2)}, details};
}

function toDayMinute(ms, dateStr){ const dayStart = new Date(`${dateStr}T00:00:00`).getTime(); return Math.floor((ms - dayStart)/60000); }
function mergePracticeIntervalsMs(arr){ if(!arr||!arr.length) return []; const sorted=arr.slice().sort((a,b)=>a.start-b.start); const r=[]; let cur=sorted[0]; for(let i=1;i<sorted.length;i++){const x=sorted[i]; if(x.start<=cur.end){cur.end=Math.max(cur.end,x.end);}else{r.push(cur);cur=x;}} r.push(cur); return r; }

// æŒ‰æ—¥æœŸï¼ˆæ˜ŸæœŸï¼‰è¿”å›ä½æ•ˆçª—å£
function getDailyLowEffWindows(dateStr){
  // æ˜ŸæœŸï¼š0(æ—¥)-6(å…­)ã€‚éœ€æ±‚ï¼šå‘¨ä¸€äºŒå››äº” => 12:00-13:00 18:00-19:00ï¼›å‘¨ä¸‰ => 12:00-12:50 12:50-13:20 18:30-19:30ï¼›å…¶å®ƒ(å‘¨å…­æ—¥) ç©º
  try {
    const d = new Date(`${dateStr}T00:00:00`);
    const w = d.getDay();
    if([1,2,4,5].includes(w)) return [
      {start:'12:00', end:'13:00'},
      {start:'18:00', end:'19:00'}
    ];
    if(w===3) return [
      {start:'12:00', end:'12:50'},
      {start:'12:50', end:'13:20'},
      {start:'18:30', end:'19:30'}
    ];
    return []; // å‘¨æ—¥(0)å‘¨å…­(6)æ— ä½æ•ˆçª—å£
  } catch(e){ console.warn('[getDailyLowEffWindows] error', e); return []; }
}

// ç»´åº¦3ï¼šæ˜¨æ—¥æ’åæ¿€åŠ± => 0~(æœ€å¤šçº¦16) ä»æ”¾å…¥ 20 åˆ†æƒé‡æ§½ä½
function computeDimension3FromPrev(prevPercent, baseSum, studentName = '', todayStr = ''){
  const p = LB442_PARAMS.dim3;
  
  // åŸºç¡€æ˜¨æ—¥æ’ååˆ†æ•°
  let yesterdayScore = baseSum * prevPercent * p.factors.yesterdayRank;
  
  // æ–°å¢å› å­è®¡ç®—
  let progressScore = 0;
  let consistencyScore = 0;
  let freshnessScore = 0;
  // ä¿®å¤ï¼šfreshnessMultiplier åœ¨ try å¤–å£°æ˜ï¼Œé¿å…å—çº§ä½œç”¨åŸŸå¯¼è‡´å¤–éƒ¨å¼•ç”¨æŠ¥é”™
  let freshnessMultiplier = 1;
  
  try {
    // 1. å‘¨è¿›æ­¥å¹…åº¦è®¡ç®— (åŸºäºå·¥ä½œæ—¥)
    const weekHistory = getStudentWeekHistory(studentName, p.stabilityWindow); // è·å–5ä¸ªå·¥ä½œæ—¥å†å²
    if (weekHistory.length >= 2) {
      const halfPoint = Math.ceil(weekHistory.length / 2);
      const recentData = weekHistory.slice(0, halfPoint);
      const olderData = weekHistory.slice(halfPoint);
      
      if (recentData.length > 0 && olderData.length > 0) {
        const recentAvg = recentData.reduce((sum, h) => sum + h.rank, 0) / recentData.length;
        const olderAvg = olderData.reduce((sum, h) => sum + h.rank, 0) / olderData.length;
        const improvement = Math.max(0, olderAvg - recentAvg); // æ’åä¸‹é™æ˜¯å¥½äº‹
        
        if (improvement >= p.progressBonus.rankImproveThreshold) {
          progressScore = baseSum * Math.min(improvement / 10, p.progressBonus.maxBonus) * p.factors.weeklyProgress;
        }
      }
    }
    
    // 2. ç¨³å®šæ€§è®¡ç®— (åŸºäºå·¥ä½œæ—¥æ’åæ³¢åŠ¨)
    if (weekHistory.length >= p.minDaysForStability) {
      const ranks = weekHistory.map(h => h.rank);
      const avgRank = ranks.reduce((sum, r) => sum + r, 0) / ranks.length;
      const variance = ranks.reduce((sum, r) => sum + Math.pow(r - avgRank, 2), 0) / ranks.length;
      const stability = Math.max(0, 1 - variance / 25); // æ ‡å‡†åŒ–ç¨³å®šæ€§åˆ†æ•°
      consistencyScore = baseSum * 0.05 * stability * p.factors.consistency;
    }
    
    // 3. æ–°é²œåº¦å¥–åŠ± (é¿å…éœ¸æ¦œ) - åŸºäºå·¥ä½œæ—¥
  const consecutiveDays = getConsecutiveTopDays(studentName);
    
    if (consecutiveDays >= p.antiDomination.decayAfterDays) {
      const excessDays = consecutiveDays - p.antiDomination.decayAfterDays;
      freshnessMultiplier = Math.pow(p.antiDomination.decayRate, excessDays);
      
      // å¦‚æœè¿ç»­ç™»é¡¶è¶…è¿‡æœ€å¤§å¤©æ•°ï¼Œé¢å¤–æƒ©ç½š
      if (consecutiveDays >= p.antiDomination.maxConsecutiveDays) {
        freshnessMultiplier *= 0.5; // é¢å¤–50%è¡°å‡
      }
    } else {
      // ç»™æ–°é¢å­”æˆ–ä¸­æ–­éœ¸æ¦œçš„å­¦ç”Ÿå¥–åŠ±
      const daysSinceLastTop = getDaysSinceLastTop(studentName);
      if (daysSinceLastTop >= p.antiDomination.breakPeriod) {
        freshnessScore = baseSum * 0.02 * p.factors.freshness; // 2%æ–°é²œåº¦å¥–åŠ±
      }
    }
    
  } catch (e) {
    console.warn('[dim3] å¤šå› å­è®¡ç®—å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€åˆ†æ•°', e);
  }
  
  // ç»¼åˆè®¡ç®—
  let totalScore = yesterdayScore + progressScore + consistencyScore + freshnessScore;
  
  // åº”ç”¨æ–°é²œåº¦è¡°å‡
  totalScore *= freshnessMultiplier;
  
  // ç¡®ä¿ä¸è¶…è¿‡ç»´åº¦3çš„ç†è®ºä¸Šé™
  const maxDim3 = baseSum * p.percentStart;
  totalScore = Math.min(totalScore, maxDim3);
  
  return {
    score: +totalScore.toFixed(2), 
    percent: prevPercent,
    breakdown: {
      yesterday: +yesterdayScore.toFixed(2),
      progress: +progressScore.toFixed(2),
      consistency: +consistencyScore.toFixed(2),
      freshness: +freshnessScore.toFixed(2),
      freshnessMultiplier: +freshnessMultiplier.toFixed(3)
    }
  };
}

// è·å–å­¦ç”Ÿè¿‡å»Nå¤©çš„æ’è¡Œå†å² (åªåŒ…å«å·¥ä½œæ—¥) - æ”¯æŒå¿«ç…§ä¼˜åŒ–
function getStudentWeekHistory(studentName, days = 7) {
  const history = [];
  const today = new Date();
  let checkedDays = 0;
  let actualWorkdays = 0;
  
  // é¦–å…ˆæ£€æŸ¥ä»Šå¤©çš„å¿«ç…§
  const todayKey = formatDate(today).replace(/\//g, '-');
  const todaySnapshot = getStudentStatsSnapshot(studentName, todayKey);
  
  // å¦‚æœæœ‰ä»Šå¤©çš„å¿«ç…§ä¸”åŒ…å«è¶³å¤Ÿçš„å†å²æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
  if (todaySnapshot && todaySnapshot.attendance && todaySnapshot.attendance.length >= days) {
    console.log(`[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§] ä½¿ç”¨ç¼“å­˜æ•°æ®: ${studentName}`);
    return todaySnapshot.attendance;
  }
  
  // å¦‚æœæ²¡æœ‰æœ¬åœ°å¿«ç…§ï¼Œå°è¯•ä»äº‘ç«¯ä¸‹è½½
  if (!todaySnapshot) {
    downloadStudentStatsFromCloud(todayKey).then(cloudData => {
      if (cloudData && cloudData[studentName]) {
        console.log(`[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§] ä»äº‘ç«¯æ¢å¤: ${studentName}`);
        // å¼‚æ­¥æ›´æ–°ï¼Œä¸å½±å“å½“å‰è¿”å›
      }
    }).catch(() => {});
  }
  
  try {
    const snapshots = getUnifiedSnapshotsStore();
    
    // ç»§ç»­æŸ¥æ‰¾ç›´åˆ°æ‰¾åˆ°è¶³å¤Ÿçš„å·¥ä½œæ—¥æ•°æ®ï¼Œä½†æœ€å¤šæ£€æŸ¥30å¤©
    while (actualWorkdays < days && checkedDays < 30) {
      checkedDays++;
      const checkDate = new Date(today);
      checkDate.setDate(today.getDate() - checkedDays);
      
      // è·³è¿‡å‘¨æœ« (å‘¨å…­=6, å‘¨æ—¥=0)
      const weekday = checkDate.getDay();
      if (weekday === 0 || weekday === 6) {
        continue;
      }
      
      const dateKey = formatDate(checkDate).replace(/\//g, '-');
      const snapshot = snapshots[dateKey];
      
      if (snapshot && snapshot.data) {
        const studentData = snapshot.data.find(s => s.n === studentName || s.name === studentName);
        if (studentData) {
          // æ‰¾åˆ°è¯¥å­¦ç”Ÿåœ¨å½“å¤©çš„æ’å
          const sortedData = [...snapshot.data].sort((a, b) => (b.t || b.total) - (a.t || a.total));
          const rank = sortedData.findIndex(s => (s.n || s.name) === studentName) + 1;
          
          history.push({
            date: dateKey,
            rank: rank,
            score: studentData.t || studentData.total || 0,
            weekday: weekday
          });
          
          actualWorkdays++;
        }
      }
    }
    
    // ä¿å­˜åˆ°å¿«ç…§ä¸­
    if (history.length > 0) {
      saveStudentStatsSnapshot(studentName, todayKey, history, null);
    }
    
  } catch (e) {
    console.warn('[history] è·å–å­¦ç”Ÿå†å²å¤±è´¥', e);
  }
  
  return history;
}

// è·å–å­¦ç”Ÿè¿ç»­ç™»é¡¶å¤©æ•° (åªè®¡ç®—å·¥ä½œæ—¥)
function getConsecutiveTopDays(studentName) {
  let consecutiveDays = 0;
  const today = new Date();
  let checkedDays = 0;
  
  try {
  const snapshots = getUnifiedSnapshotsStore();
    
    // ä»æ˜¨å¤©å¼€å§‹å¾€å‰æŸ¥æ‰¾ï¼Œæœ€å¤šæ£€æŸ¥30ä¸ªè‡ªç„¶æ—¥
    while (checkedDays < 30) {
      checkedDays++;
      const checkDate = new Date(today);
      checkDate.setDate(today.getDate() - checkedDays);
      
      // è·³è¿‡å‘¨æœ«
      const weekday = checkDate.getDay();
      if (weekday === 0 || weekday === 6) {
        continue;
      }
      
      const dateKey = formatDate(checkDate).replace(/\//g, '-');
      const snapshot = snapshots[dateKey];
      
      if (snapshot && snapshot.data && snapshot.data.length > 0) {
        const topStudent = snapshot.data[0];
        const topName = topStudent.n || topStudent.name;
        
        if (topName === studentName) {
          consecutiveDays++;
        } else {
          break; // è¿ç»­ä¸­æ–­
        }
      } else {
        // æ²¡æœ‰æ•°æ®ï¼Œå¯èƒ½æ˜¯ç³»ç»Ÿåˆšå¯ç”¨ï¼Œä¸ç®—ä¸­æ–­ï¼Œç»§ç»­æŸ¥æ‰¾
        continue;
      }
    }
  } catch (e) {
    console.warn('[consecutive] è·å–è¿ç»­ç™»é¡¶å¤©æ•°å¤±è´¥', e);
  }
  
  return consecutiveDays;
}

// è·å–å­¦ç”Ÿè·ç¦»ä¸Šæ¬¡ç™»é¡¶çš„å¤©æ•° (åªè®¡ç®—å·¥ä½œæ—¥)
function getDaysSinceLastTop(studentName) {
  const today = new Date();
  let checkedDays = 0;
  let workdaysSinceTop = 0;
  
  try {
  const snapshots = getUnifiedSnapshotsStore();
    
    // ä»æ˜¨å¤©å¼€å§‹å¾€å‰æŸ¥æ‰¾ï¼Œæœ€å¤šæ£€æŸ¥30ä¸ªè‡ªç„¶æ—¥
    while (checkedDays < 30) {
      checkedDays++;
      const checkDate = new Date(today);
      checkDate.setDate(today.getDate() - checkedDays);
      
      // è·³è¿‡å‘¨æœ«
      const weekday = checkDate.getDay();
      if (weekday === 0 || weekday === 6) {
        continue;
      }
      
      workdaysSinceTop++; // è®¡ç®—å·¥ä½œæ—¥å¤©æ•°
      
      const dateKey = formatDate(checkDate).replace(/\//g, '-');
      const snapshot = snapshots[dateKey];
      
      if (snapshot && snapshot.data && snapshot.data.length > 0) {
        const topStudent = snapshot.data[0];
        const topName = topStudent.n || topStudent.name;
        
        if (topName === studentName) {
          return workdaysSinceTop; // æ‰¾åˆ°ä¸Šæ¬¡ç™»é¡¶ï¼Œè¿”å›è·ç¦»çš„å·¥ä½œæ—¥å¤©æ•°
        }
      }
    }
  } catch (e) {
    console.warn('[lastTop] è·å–ä¸Šæ¬¡ç™»é¡¶å¤±è´¥', e);
  }
  
  return 15; // å¦‚æœ15ä¸ªå·¥ä½œæ—¥å†…æ²¡æœ‰ç™»é¡¶è¿‡ï¼Œè¿”å›15 (çº¦3å‘¨)
}

function getYesterdayRankPercentMap(){
  try{
  const snaps = getUnifiedSnapshotsStore();
    const today = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const y = new Date(today.getTime()-86400000);
    const key = formatDate(y);
    const snap = snaps[key]; if(!snap||!snap.data) return {};
    // æ’åºä¾æ® data é¡ºåºï¼ˆå·²æ˜¯å‰æ—¥æ¦œå•é¡ºåºï¼‰
    // å¤„ç†å¹¶åˆ—: æŒ‰ total (t) åˆ†ç»„
    const rows = snap.data.map((r,i)=>({name:r.n,total:r.t,index:i}));
    rows.sort((a,b)=> b.total - a.total || a.name.localeCompare(b.name,'zh'));
    const groups=[]; let cur=[]; let lastTotal=null;
    for(const r of rows){ const t=r.total.toFixed(2); if(lastTotal===null||t===lastTotal){cur.push(r); lastTotal=t;} else {groups.push(cur); cur=[r]; lastTotal=t;} }
    if(cur.length) groups.push(cur);
    const pConf = LB442_PARAMS.dim3; const percentForRank = r=> Math.max(0, pConf.percentStart - (r-1)*pConf.percentStep);
    let rank=1; const map={};
    for(const g of groups){ const startRank=rank; const endRank=rank+g.length-1; let avgPerc=0; for(let rr=startRank; rr<=endRank; rr++){ avgPerc+=percentForRank(rr);} avgPerc/=g.length; avgPerc = Math.max(0,avgPerc); for(const item of g){ if(rank>pConf.maxRank) { map[item.name]=0; } else { map[item.name]= (rank>pConf.maxRank?0:avgPerc); } } rank = endRank+1; if(rank>pConf.maxRank) break; }
    return map;
  }catch(e){ console.warn('[dim3] è·å–æ˜¨æ—¥æ’è¡Œå¤±è´¥', e); return {}; }
}

// è®¡ç®— slot å†…è¦†ç›–åˆ†é’Ÿï¼ˆåˆå¹¶ practiceIntervals åè®¡ç®—äº¤é›†ï¼‰
function coveredMinutesInSlot(slot, intervals){
  if(!intervals||!intervals.length) return 0;
  let total=0;
  for(const it of intervals){
    const s = Math.max(it.start, slot.startMinute);
    const e = Math.min(it.end, slot.endMinute);
    if(e>s) total += (e-s);
  }
  return total;
}

// åˆå¹¶ & è§„èŒƒ interval æ•°ç»„ï¼ŒæœŸæœ›å…ƒç´ : {start,end} (åˆ†é’Ÿ)
function mergeIntervals(intervals){
  if(!intervals||!intervals.length) return [];
  const arr = intervals.filter(i=>Number.isFinite(i.start)&&Number.isFinite(i.end)&&i.end>i.start)
    .sort((a,b)=>a.start-b.start);
  const res=[];let cur=arr[0];
  for(let i=1;i<arr.length;i++){
    const x=arr[i];
    if(x.start<=cur.end){
      cur.end = Math.max(cur.end,x.end);
    } else { res.push(cur); cur=x; }
  }
  res.push(cur);return res;
}

// ç»Ÿä¸€åŒ…è£…ï¼šè·å–ä»Šæ—¥ç»ƒç´ï¼ˆæ®µå†…/æ®µå¤–ï¼‰åˆ†é’ŸåŒºé—´ï¼Œç”¨äºæ’è¡Œæ¦œ
function getTodayPracticeForLeaderboard(name){
  const todayStr = new Date().toISOString().slice(0,10);
  let cleaned=[], outIntervals=[];
  try{
    const dio = computeDayInOut(name, todayStr);
    cleaned = dio.cleanIntervals||[];      // [{start,end} ms]
    outIntervals = dio.outIntervals||[];   // [{start,end,durationSec}]
  }catch(e){ console.warn('[leaderboard] computeDayInOut error', name, e); }
  // æ³¨æ„ï¼šç»´åº¦1å’Œ2éœ€è¦åŸå§‹msæ—¶é—´æˆ³ç”¨äºcalcOverlapSecondsï¼Œè¿™é‡Œä¸è½¬æ¢
  return {cleanIntervals: cleaned, outIntervals, todayStr};
}

// è·å–æ®µå¤–ç»ƒç´åˆ†é’Ÿï¼ˆè¿‡æ»¤æ™šé—´ï¼‰
function computeOutsideMinutes(practiceIntervals, slotIntervals){
  // å¥å£®æ€§ & æ—©é€€
  if(!Array.isArray(practiceIntervals) || !practiceIntervals.length) return 0;
  slotIntervals = Array.isArray(slotIntervals)? slotIntervals: [];

  // è§„èŒƒåŒ– -> åˆå¹¶
  const mergedPractice = mergeIntervals(practiceIntervals).filter(iv=>iv && Number.isFinite(iv.start) && Number.isFinite(iv.end));
  const mergedSlots = mergeIntervals(slotIntervals.map(s=>s?{start:s.startMinute,end:s.endMinute}:null).filter(s=>s && Number.isFinite(s.start) && Number.isFinite(s.end)));
  if(!mergedPractice.length) return 0;

  // ç”Ÿæˆæ®µå¤–åŒºé—´åˆ—è¡¨ï¼ˆè€Œä¸æ˜¯ç›´æ¥åŠ åˆ†é’Ÿï¼Œä¾¿äºåç»­è£å‰ª cutoffï¼‰
  const outsideSegments=[];
  for(const p of mergedPractice){
    if(!p) continue;
    let cursor=p.start;
    for(const sl of mergedSlots){
      if(!sl) continue;
      if(sl.end <= cursor) continue;      // slot åœ¨å½“å‰æŒ‡é’ˆå·¦ä¾§
      if(sl.start >= p.end) break;        // slot åœ¨åŒºé—´å³ä¾§ -> ç»“æŸ
      if(sl.start > cursor){              // å­˜åœ¨ä¸€æ®µ outside
        outsideSegments.push({start:cursor,end:Math.min(sl.start,p.end)});
      }
      cursor = Math.max(cursor, sl.end);
      if(cursor >= p.end) break;          // åŒºé—´å·²è€—å°½
    }
    if(cursor < p.end){
      outsideSegments.push({start:cursor,end:p.end});
    }
  }
  if(!outsideSegments.length) return 0;

  // æ™šé—´æˆªæ–­ï¼šä½¿ç”¨åŠ¨æ€å†»ç»“æ—¶é—´
  const cutoff = getTodayFreezeMinutes(new Date());
  let minutes=0;
  for(const seg of outsideSegments){
    if(!seg) continue;
    if(seg.start >= cutoff) continue;
    const span = Math.max(0, Math.min(seg.end, cutoff) - seg.start);
    if(span>0) minutes += span;
  }
  return minutes;
}

function computeLeaderboard(){
  leaderboardState.dirty=false;
  if(leaderboardState.pending) return;
  const startTs=Date.now();
  ensureActiveLeaderboardDate();
  const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
  const isMorningPrev = now.getHours() < 8 && !window.__computeDateOverride;
  const freezeMin = getTodayFreezeMinutes(now);
  const afterFreeze = (now.getHours()*60+now.getMinutes()) >= freezeMin;
  // è¯Šæ–­ï¼šå­¦ç”Ÿåº“ä¸ºç©ºç›´æ¥æ¸²æŸ“ç©ºçŠ¶æ€
  if(!studentDatabase || Object.keys(studentDatabase).length===0){
    console.warn('[leaderboard] studentDatabase ä¸ºç©ºï¼Œæ— æ³•è®¡ç®—æ’è¡Œæ¦œ');
    leaderboardState.raw=[];renderLeaderboard();return; }
  if(afterFreeze && leaderboardState.raw && leaderboardState.raw.length && !window.__forcePostFreeze){
    renderLeaderboard();
    return;
  }
  const key = getTodayWeekdayKey();
  if(!key){ console.warn('[leaderboard] getTodayWeekdayKey è¿”å›ç©ºï¼ˆå¯èƒ½æ˜¯å‘¨æœ«ï¼‰ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€'); leaderboardState.raw=[]; renderLeaderboard(); return; }
  const students = flattenStudents();
  if(!students.length){ console.warn('[leaderboard] æ— å¯å‚ä¸å­¦ç”Ÿï¼ˆè¿‡æ»¤åä¸ºç©ºï¼Œä¾‹å¦‚å…¨éƒ¨ä¸º G12ï¼‰'); leaderboardState.raw=[]; renderLeaderboard(); return; }
  const yesterdayMap = getYesterdayRankPercentMap();
  const rows=[];
  for(const stu of students){
    if(stu.grade === 'G12') continue;
    const name = stu.name;
    const slots = getStudentTodaySlots(name);
    const {cleanIntervals, todayStr} = getTodayPracticeForLeaderboard(name);
    const practiceIntervals = cleanIntervals;
    const dim1 = computeDimension1(slots, practiceIntervals, todayStr);
    const dim2 = computeDimension2(slots, practiceIntervals, todayStr);
    const prevPercent = yesterdayMap[name] || 0; // 0~0.20
    const dim3 = computeDimension3FromPrev(prevPercent, dim1.score + dim2.score, name, todayStr); // ä¼ å…¥å­¦ç”Ÿå§“åå’Œæ—¥æœŸ
    const weighted = 0.4*(dim1.score/40) + 0.4*(dim2.score/40) + 0.2*(dim3.score/ ( (dim1.score+dim2.score)>0 ? ( (dim1.score+dim2.score)*LB442_PARAMS.dim3.percentStart ) : 1) );
    // ä¸ºä¿æŒå†å²æ˜¾ç¤º total ä»ç”¨ 0~100 ä½“ç³»ï¼š
    const total = +(weighted*100).toFixed(2);
    rows.push({name,grade:stu.grade||'',major:stu.major||'',dim1,dim2,dim3,total,prevPercent});
  }
  rows.sort((a,b)=> b.total-a.total || b.dim1.score-a.dim1.score || b.dim2.score-a.dim2.score || b.dim3.score-a.dim3.score || a.name.localeCompare(b.name,'zh'));
  // å¹¶åˆ—æ’åè®¡ç®— (æ ‡å‡†ç«èµ›æ’å 1,1,3)
  let currentRank=0, processed=0, lastKey=null;
  for(const r of rows){
    processed++;
    const keyStr = `${r.total.toFixed(2)}|${r.dim1.score.toFixed(2)}|${r.dim2.score.toFixed(2)}|${r.dim3.score.toFixed(2)}`;
    if(keyStr!==lastKey){ currentRank=processed; lastKey=keyStr; }
    r.displayRank = currentRank;
  }
  leaderboardState.raw = rows;
  leaderboardState.lastCompute=Date.now();
  if(!isMorningPrev){
    if(!window.__skipSnapshotOnce){ saveLeaderboardSnapshot(rows);} else window.__skipSnapshotOnce=false;
  }
  renderLeaderboard();
  const cost=Date.now()-startTs;
  if(window.setUpdateStatus) window.setUpdateStatus('updated',{rows:rows.length,cost});
}

function renderLeaderboard(){
  const section = document.getElementById('leaderboard-section');
  if(!section) return;
  const tbody = document.querySelector('.leaderboard-table tbody');
  if(!tbody){ section.style.display='none'; return; }
  const rows = leaderboardState.raw || [];
  // å§‹ç»ˆæ˜¾ç¤ºåŒºå—ï¼Œä¾¿äºæ“ä½œâ€œæ¨¡æ‹Ÿ100äººâ€æŒ‰é’®ä¸æç¤º
  section.style.display = 'block';
  // å·²å®šæ ¼æ ‡è¯†
  const statusEl = document.getElementById('leaderboard-refresh-status');
  if(statusEl){
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const freezeMin = getTodayFreezeMinutes(now);
    const curMin = now.getHours()*60+now.getMinutes();
    if(curMin >= freezeMin){
      const hh = String(Math.floor(freezeMin/60)).padStart(2,'0');
      const mm = String(freezeMin%60).padStart(2,'0');
      if(window.setUpdateStatus) window.setUpdateStatus('frozen', {time:`${hh}:${mm}`}); else statusEl.innerHTML = `ğŸ”’ å·²å®šæ ¼ (${hh}:${mm})`;
    }
  }
  const showAll = leaderboardState.expanded;
  const displayRows = showAll? rows: rows.slice(0,10);
  
  if(!rows.length){
    // æ£€æŸ¥æ˜¯å¦æ˜¯å‘¨æœ«ï¼Œæ˜¾ç¤ºç‰¹æ®Šæé†’
    const today = new Date();
    const isWeekend = today.getDay() === 0 || today.getDay() === 6;
    
    if(isWeekend){
      tbody.innerHTML = `<tr class="weekend-notice"><td colspan="5" style="text-align:center;padding:40px;color:var(--text-secondary);font-size:15px;">
        <div style="margin-bottom:16px;font-size:18px;">ğŸ“… å‘¨æœ«æ—¶å…‰</div>
        <div style="margin-bottom:12px;color:#667eea;font-weight:600;">æ’è¡Œæ¦œè®¡ç®—æš‚åœ</div>
        <div style="margin-bottom:8px;">å‘¨æœ«æœŸé—´æ’è¡Œæ¦œä¸è¿›è¡Œè®¡ç®—ä¸æµ‹è¯„</div>
        <div style="color:#64748b;font-size:13px;">å‘¨ä¸€å°†æ¢å¤æ­£å¸¸</div>
      </td></tr>`;
    } else {
      tbody.innerHTML = `<tr class="empty"><td colspan="5" style="text-align:center;padding:30px;color:var(--text-secondary);font-size:14px;">
        <div style="margin-bottom:8px;">ğŸš« æš‚æ— å¯è®¡ç®—æ•°æ®</div>
    <div style="margin-bottom:8px;">å¯èƒ½åŸå› ï¼š1) å­¦ç”Ÿåº“ä¸ºç©º 2) æ‰€æœ‰å­¦ç”Ÿä¸º G12 è¢«æ’é™¤ 3) ä»Šæ—¥å°šæ— ç»ƒç´/æ—¶æ®µæ•°æ® 4) æ•°æ®å°šæœªåŒæ­¥å®Œæˆ</div>
    <div>è¯·æ·»åŠ å­¦ç”ŸåŠå…¶è®¡åˆ’æ—¶æ®µæˆ–ç­‰å¾…æ•°æ®å†™å…¥åè‡ªåŠ¨åˆ·æ–°ã€‚</div>
      </td></tr>`;
    }
    
    const toggleBtn = document.getElementById('lb-toggle-more');
    if(toggleBtn) toggleBtn.style.display='none';
    // çŠ¶æ€æ–‡æœ¬
    const statusEl = document.getElementById('leaderboard-refresh-status');
    if(statusEl) {
      if(isWeekend) {
        statusEl.textContent='å‘¨æœ«æš‚åœ';
      } else {
        statusEl.textContent='ç©º';
      }
    }
    return;
  }
  tbody.innerHTML = displayRows.map((r,i)=>{
    const rank = r.displayRank || (i+1);
    let rowClass = '';
    let rankClass = 'rank-cell';
    let scoreClass = 'score-cell';
    let nameClass = 'name-cell';
    
    // æ’åæ ·å¼
  if(rank === 1) {
      rowClass = 'top-1';
      rankClass += ' rank-1';
    } else if(rank === 2) {
      rowClass = 'top-2';
      rankClass += ' rank-2';
    } else if(rank === 3) {
      rowClass = 'top-3';
      rankClass += ' rank-3';
    }
    
    // åˆ†æ•°é¢œè‰²
    const score = r.total;
    if(score >= 90) {
      scoreClass += ' score-excellent';
    } else if(score >= 80) {
      scoreClass += ' score-good';
    } else if(score >= 70) {
      scoreClass += ' score-average';
    } else {
      scoreClass += ' score-poor';
    }
    
    return `<tr class="${rowClass}">
      <td class="${rankClass}">${rank <= 3 ? '' : rank}</td>
      <td class="${nameClass}">${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.grade||'')}</td>
      <td>${escapeHtml(r.major||'')}</td>
      <td class="${scoreClass}">${r.total.toFixed(2)} <button class="mini-help-btn" onclick="showStudentLeaderboardDetail('${escapeHtml(r.name)}')" title="æŸ¥çœ‹è¯¦ç»†å¾—åˆ†">?</button></td>
    </tr>`;
  }).join('');
  
  const toggleBtn = document.getElementById('lb-toggle-more');
  if(toggleBtn){
    if(rows.length>10){
      toggleBtn.style.display='inline-block';
      toggleBtn.textContent = showAll? 'æ”¶èµ·' : `å±•å¼€å…¨éƒ¨ (${rows.length})`;
    } else toggleBtn.style.display='none';
  }
}

// ================== æ¨¡æ‹Ÿæ•°æ® (æœ¬åœ°è°ƒè¯•) ==================
// runLeaderboardSimulation å·²ç§»é™¤ï¼ˆåŸç”¨äºç”Ÿæˆç¤ºä¾‹æ•°æ®ï¼‰

function escapeHtml(str){
  if(str==null) return '';
  return String(str).replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
}

// ===== æ’è¡Œæ¦œåˆ·æ–°ç»Ÿä¸€çŠ¶æ€æ˜¾ç¤º =====
// çŠ¶æ€ç±»å‹: idle | detecting | updating | final | frozen
window.setUpdateStatus = function(type, extra){
  const el = document.getElementById('leaderboard-refresh-status');
  if(!el) return;
  el.dataset.mode = type;
  const map = {
    idle: 'å°šæœªè®¡ç®—',
    detecting: 'æ£€æµ‹åˆ°æ–°æ•°æ®ï¼Œç¨åè‡ªåŠ¨åˆ·æ–°â€¦',
    updating: 'è®¡ç®—ä¸­â€¦',
    updated: (extra && extra.rows!=null && extra.cost!=null) ? `å·²æ›´æ–° (${extra.rows}äºº, ${extra.cost}ms)` : 'å·²æ›´æ–°',
    frozen: (extra && extra.time) ? `ğŸ”’ å·²å®šæ ¼ (${extra.time})` : 'ğŸ”’ å·²å®šæ ¼'
  };
  el.textContent = map[type] || type;
};

// ä¾›æ•°æ®ç›‘å¬/æ¨é€è°ƒç”¨ï¼šæ ‡è®°æœ‰æ–°æ•°æ®å¹¶å»¶è¿Ÿè§¦å‘é‡æ–°è®¡ç®—
window.leaderboardMarkDataChanged = function(reason){
  // è‹¥å·²å†»ç»“åˆ™ä¸å†æç¤ºæ£€æµ‹ï¼ˆä½†ä»å¯æœ€ç»ˆé‡æ–°è®¡ç®—ï¼‰
  try {
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const freezeMin = getTodayFreezeMinutes(now);
    const curMin = now.getHours()*60 + now.getMinutes();
    if(curMin >= freezeMin){
      // å†»ç»“åå¿½ç•¥â€œæ£€æµ‹åˆ°â€æç¤ºï¼Œç›´æ¥èµ°å³æ—¶é‡ç®—ï¼ˆå¯èƒ½ç”¨äºè¡¥å†™ finalï¼‰
      computeLeaderboard();
      return;
    }
  } catch(e){ /* å¿½ç•¥ */ }
  if(window.setUpdateStatus) window.setUpdateStatus('detecting');
  if(window.__leaderboardRecomputeScheduled) return; // å·²æ’é˜Ÿ
  window.__leaderboardRecomputeScheduled = true;
  setTimeout(()=>{
    window.__leaderboardRecomputeScheduled = false;
    window.setUpdateStatus && window.setUpdateStatus('updating');
    try { computeLeaderboard(); } catch(e){ console.error('[leaderboard] è‡ªåŠ¨åˆ·æ–°å¤±è´¥', e); }
  }, 1200); // 1.2s åˆå¹¶æŠ–åŠ¨
};

// æ˜¾ç¤ºæ•´ä½“æ’è¡Œæ¦œè§„åˆ™è¯¦æƒ…
function showLeaderboardDetail(){
  ensureLBExtraStyles();
  const content = `
  <div class="lb442-doc">
    <header class="lb442-head">
      <div class="lb-head-card">
        <h2>442 æµ‹è¯„ä½“ç³»</h2>
        <p class="lb442-sub">ç»ƒç´è´¨é‡ç»¼åˆè¯„ä»·æ¨¡å‹ Â· ç»“æ„åŒ– Â· å¯è§£é‡Š Â· å¯æŒç»­æ¿€åŠ±</p>
        <div class="lb442-tagline">æƒé‡ç»“æ„ 40 : 40 : 20</div>
      </div>
    </header>

    <section class="lb442-section core-concept">
      <h3>ä¸€ã€æ ¸å¿ƒç†å¿µ <span>Why 442?</span></h3>
      <div class="concept-grid">
        <div class="concept-card cc-objective">
          <div class="cc-icon">ğŸ¯</div>
          <div class="cc-content">
            <h4>å®¢è§‚æ€§</h4>
            <p>æ—¶é—´åŒºé—´ + è¦†ç›–ç‡ + æœ‰æ•ˆåˆ†é’Ÿ<br>ä»£æ›¿ä¸»è§‚æ‰“åˆ†</p>
          </div>
        </div>
        <div class="concept-card cc-balance">
          <div class="cc-icon">âš–ï¸</div>
          <div class="cc-content">
            <h4>å‡è¡¡æ€§</h4>
            <p>å‡ºå‹¤å®Œæˆ / è´¨é‡æ•ˆç‡<br>æˆé•¿åŠ¨åŠ› ä¸‰ç»´å¹¶é‡</p>
          </div>
        </div>
        <div class="concept-card cc-cycle">
          <div class="cc-icon">ğŸ”„</div>
          <div class="cc-content">
            <h4>æ­£å¾ªç¯</h4>
            <p>å¥–åŠ±ç¨³å®šæŠ•å…¥ä¸è¿›æ­¥<br>è€Œéæç«¯åˆ·æ—¶é•¿</p>
          </div>
        </div>
        <div class="concept-card cc-transparent">
          <div class="cc-icon">ğŸ’</div>
          <div class="cc-content">
            <h4>é€æ˜åŒ–</h4>
            <p>æ‰€æœ‰æ‰£åˆ†åŠ æˆéƒ½æœ‰æ¥æº<br>æ”¯æŒé•¿æœŸç¨³å®šè¿›æ­¥</p>
          </div>
        </div>
      </div>
    </section>

    <section class="lb442-section grid-3">
      <div class="metric-card m1">
        <h4>ğŸ“… ç»´åº¦1 å‡ºå‹¤å®Œæˆ <em>40%</em></h4>
        <p class="desc">æŒ‰è®¡åˆ’æ—¶é—´æ®µçš„<br>è¦†ç›–ç‡ / ç¼ºå¸­ / è¿Ÿåˆ°ã€‚</p>
        <ul>
          <li>è¦†ç›–â‰¥60% è®¡ä¸ºå®Œæˆ</li>
          <li>ç¼ºå¸­æ—¶æ®µ = 0 åˆ†</li>
          <li>è¿Ÿåˆ°å®½é™ 5 åˆ†é’Ÿ</li>
          <li>å…¨å‹¤é™„åŠ å¥–åŠ±</li>
        </ul>
      </div>
      <div class="metric-card m2">
        <h4>âš¡ ç»´åº¦2 è´¨é‡æ•ˆç‡ <em>40%</em></h4>
        <p class="desc">å…³æ³¨æœ‰æ•ˆæ—¶é•¿ç»“æ„åˆç†ã€‚</p>
        <ul>
          <li>å•æ®µ 30~120 åˆ†é’Ÿæœ€ä½³</li>
          <li>è¿‡çŸ­ / è¿‡é•¿ é€’å‡</li>
          <li>é¿å¼€ä½æ•ˆæ—¶é—´æ®µ</li>
          <!-- æ—©æ™¨ç»ƒç´åŠ æˆå·²åˆ é™¤ -->
        </ul>
      </div>
      <div class="metric-card m3">
        <h4>ğŸ† ç»´åº¦3 æˆé•¿åŠ æˆ <em>20%</em></h4>
        <p class="desc">æ’ååŠ¨åŠ› & ç¨³å®šæŠ•å…¥ã€‚</p>
        <ul>
          <li>æ˜¨æ—¥æ’ååŒºé—´åŠ æˆ</li>
          <li>å‘¨å†…è¿›æ­¥å¥–åŠ±</li>
          <li>ç¨³å®šä½æ³¢åŠ¨å¥–åŠ±</li>
          <li>æ–°é²œåº¦/åéœ¸æ¦œæœºåˆ¶</li>
        </ul>
      </div>
    </section>

    <section class="lb442-section scard">
      <h3>äºŒã€å¾—åˆ†è®¡ç®—</h3>
      <div class="formula-box">æ€»åˆ† = ç»´åº¦1Ã—0.4 + ç»´åº¦2Ã—0.4 + ç»´åº¦3Ã—0.2</div>
      <p class="note">æ’åºä¼˜å…ˆçº§ï¼šæ€»åˆ† â†’ ç»´åº¦1 â†’ ç»´åº¦2 â†’ ç»´åº¦3 â†’ å§“åå­—æ¯åº</p>
    </section>

    <section class="lb442-section two-col">
      <div class="mini-card mc-low">
        <h4>âš ï¸ ä½æ•ˆæ—¶æ®µ</h4>
        <ul class="tight">
          <li>å·¥ä½œæ—¥ï¼šåˆé¤ / æ™šé¤å›ºå®šåŒºé—´</li>
          <li>ä½æ•ˆæ®µå†…åˆ†é’ŸæŒ‰æƒé‡æŠ˜å‡</li>
          <li>å‘¨æœ«ä¸è®¾ä½æ•ˆæ®µ</li>
        </ul>
      </div>
      <div class="mini-card mc-anti">
        <h4>ğŸ›¡ï¸ åéœ¸æ¦œ</h4>
        <ul class="tight">
          <li>è¿ç»­å æ¦œé€æ—¥é€’å‡</li>
          <li>é—´éš” 2 ä¸ªå·¥ä½œæ—¥é‡ç½®</li>
          <li>æ–°åŠ å…¥ / å›å½’æœ‰å¯åŠ¨å¥–åŠ±</li>
        </ul>
      </div>
    </section>

    <section class="lb442-section scard">
      <h3>ä¸‰ã€å…¸å‹åˆ¤å®šç¤ºä¾‹</h3>
      <div class="examples">
        <div class="ex">
          <span class="tag ok">ç¨³å®šå‹</span>
          <p>è®¡åˆ’ 4 æ®µå…¨éƒ¨â‰¥70% è¦†ç›–ï¼Œè´¨é‡åŒºé—´åˆç† â†’ ç»´åº¦1 è¿‘æ»¡åˆ†ï¼Œç»´åº¦2 é«˜åˆ†ã€‚</p>
        </div>
        <div class="ex">
          <span class="tag warn">åˆ·æ—¶é•¿å‹</span>
          <p>å•æ®µ >150 åˆ†é’Ÿï¼Œå¤šæ®µå¤±è¡¡ â†’ ç»´åº¦2 é€’å‡ï¼Œéš¾ä»¥å†²é¡¶ã€‚</p>
        </div>
        <div class="ex">
          <span class="tag info">å›å‡å‹</span>
          <p>æœ¬å‘¨æ’åå¿«é€Ÿä¸Šå‡ + æ³¢åŠ¨é™ä½ â†’ ç»´åº¦3 è·é¢å¤–æˆé•¿åŠ æˆã€‚</p>
        </div>
      </div>
    </section>
  </div>`;
  createCenterModal(content,'442æµ‹è¯„ä½“ç³»');
}

function ensureLBExtraStyles(){
  if(document.getElementById('lb-detail-extra-styles')) return;
  const style=document.createElement('style');
  style.id='lb-detail-extra-styles';
  style.textContent=`/* è¯„åˆ†è¯¦æƒ… & 442 è¯´æ˜æ‰©å±•æ ·å¼ */
  .lb442-doc .metric-card{background:#ffffff;border:1px solid var(--border-color);border-radius:12px;padding:14px 16px;box-shadow:0 2px 6px rgba(0,0,0,.06);transition:.25s;} 
  .lb442-doc .metric-card:hover{box-shadow:0 6px 18px -4px rgba(0,0,0,.18);} 
  .lb442-doc .metric-card h4{margin:0 0 6px;font-size:15px;font-weight:600;display:flex;align-items:center;gap:6px;}
  .lb442-doc .metric-card ul{margin:6px 0 0;padding-left:18px;font-size:12px;line-height:1.6;}
  .lb442-doc .formula-box{background:#ffffff;color:#1e293b;border:1px solid #e2e8f0;}
  .lb442-doc .lb442-section{position:relative;}
  /* ç« èŠ‚å®¹å™¨å¡ç‰‡ */
  .lb442-doc .lb442-head{margin:0 0 18px;padding:0;border:none;}
  .lb442-doc .lb-head-card{background:linear-gradient(135deg,#0d47a1,#1976d2 55%,#42a5f5);border:1px solid rgba(255,255,255,.25);border-radius:18px;padding:26px 24px 22px;position:relative;overflow:hidden;color:#fff;box-shadow:0 10px 28px -8px rgba(13,71,161,.55),0 4px 16px -4px rgba(0,0,0,.35);}
  .lb442-doc .lb-head-card:before{content:"";position:absolute;width:420px;height:420px;top:-160px;right:-120px;background:radial-gradient(circle at center,rgba(255,255,255,.35),transparent 60%);filter:blur(8px);opacity:.55;}
  .lb442-doc .lb-head-card h2{margin:0;font-size:30px;font-weight:800;letter-spacing:.5px;line-height:1.15;background:linear-gradient(90deg,#fff,#e3f2fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;}
  .lb442-doc .lb-head-card .lb442-sub{margin:10px 0 14px;font-size:13px;line-height:1.55;max-width:600px;color:rgba(255,255,255,.9);}
  .lb442-doc .lb-head-card .lb442-tagline{display:inline-flex;align-items:center;gap:6px;font-size:11px;font-weight:600;letter-spacing:1px;padding:6px 14px;border-radius:30px;background:rgba(255,255,255,.15);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.35);}
  /* é€šç”¨ section å¡ç‰‡ - å½©è‰²èƒŒæ™¯ */
  .lb442-doc .scard{background:linear-gradient(145deg,#e8f4fd,#f0f9ff);border:1px solid rgba(25,118,210,.25);border-radius:16px;padding:18px 18px 16px;margin:0 0 16px;position:relative;overflow:hidden;box-shadow:0 4px 14px -4px rgba(25,118,210,.25),0 2px 6px rgba(0,0,0,.06);transition:.3s;}
  
  /* æ ¸å¿ƒç†å¿µä¸“ç”¨æ ·å¼ */
  .lb442-doc .core-concept{background:linear-gradient(135deg,#f8fafc,#f1f5f9);border:1px solid rgba(71,85,105,.15);border-radius:16px;padding:16px;margin:0 0 16px;box-shadow:0 3px 12px -2px rgba(71,85,105,.15);} 
  .lb442-doc .core-concept h3{margin:0 0 14px;font-size:16px;font-weight:600;color:#1e293b;display:flex;align-items:center;gap:8px;}
  .lb442-doc .core-concept h3 span{font-size:13px;color:#1976d2;font-weight:500;background:rgba(25,118,210,.15);padding:4px 10px;border-radius:12px;letter-spacing:.3px;}
  .lb442-doc .concept-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;}
  .lb442-doc .concept-card{display:flex;align-items:flex-start;gap:8px;background:rgba(255,255,255,.8);border:1px solid rgba(71,85,105,.12);border-radius:10px;padding:10px 12px;transition:.25s;}
  .lb442-doc .concept-card:hover{transform:translateY(-1px);box-shadow:0 4px 12px -2px rgba(71,85,105,.2);}
  .lb442-doc .cc-icon{font-size:18px;line-height:1;margin-top:1px;}
  .lb442-doc .cc-content h4{margin:0 0 4px;font-size:13px;font-weight:600;color:#1e293b;line-height:1.2;}
  .lb442-doc .cc-content p{margin:0;font-size:11px;line-height:1.4;color:#64748b;}
  .lb442-doc .scard:before{content:"";position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 88% 16%,rgba(25,118,210,.25),transparent 70%);opacity:.65;mix-blend-mode:overlay;}
  .lb442-doc .scard:hover{box-shadow:0 10px 28px -8px rgba(25,118,210,.35),0 4px 12px rgba(0,0,0,.1);transform:translateY(-2px);}
  .lb442-doc .scard h3{margin:0 0 10px;font-size:18px;font-weight:700;display:flex;align-items:center;gap:10px;line-height:1.25;position:relative;padding-left:10px;}
  .lb442-doc .scard h3:before{content:"";position:absolute;left:0;top:4px;bottom:4px;width:4px;border-radius:4px;background:linear-gradient(180deg,#1976d2,#42a5f5);} 
  .lb442-doc .scard h3 span{font-size:11px;font-weight:600;color:#1976d2;background:rgba(25,118,210,.18);padding:2px 8px;border-radius:20px;letter-spacing:.5px;}
  .lb442-doc .scard ul.key-points{margin:0;padding-left:20px;font-size:13px;line-height:1.65;}
  .lb442-doc .scard ul.key-points li{margin:4px 0 0;}
  .lb442-doc .scard .note{font-size:12px;color:var(--text-secondary);margin:8px 0 0;}
  /* ç¤ºä¾‹ä¸æ ‡ç­¾ - å½©è‰²èƒŒæ™¯ */
  .lb442-doc .examples{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-top:10px;}
  .lb442-doc .examples .ex{background:linear-gradient(150deg,#fef3c7,#fef9e7);border:1px solid rgba(245,158,11,.3);padding:12px 12px 10px;border-radius:12px;font-size:12px;line-height:1.55;position:relative;box-shadow:0 2px 8px rgba(245,158,11,.15);transition:.25s;}
  .lb442-doc .examples .ex:hover{box-shadow:0 6px 18px -4px rgba(245,158,11,.35);}
  .lb442-doc .examples .ex .tag{display:inline-flex;align-items:center;font-size:10px;font-weight:600;padding:3px 8px;border-radius:20px;letter-spacing:.5px;margin-bottom:6px;}
  .lb442-doc .examples .ex .tag.ok{background:rgba(16,185,129,.2);color:#047857;}
  .lb442-doc .examples .ex .tag.warn{background:rgba(245,158,11,.25);color:#b45309;}
  .lb442-doc .examples .ex .tag.info{background:rgba(59,130,246,.25);color:#1d4ed8;}
  .lb442-doc .principles{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;padding:0;margin:0;margin-top:6px;list-style:none;}
  .lb442-doc .principles li{background:linear-gradient(145deg,#f0fdf4,#f7fee7);border:1px solid rgba(16,185,129,.25);padding:10px 12px 9px;border-radius:12px;font-size:12px;line-height:1.55;box-shadow:0 2px 8px rgba(16,185,129,.15);}
  .lb442-doc .principles li strong{display:block;font-size:12px;margin-bottom:4px;color:#047857;}
  /* ä¸‰å¤§ç»´åº¦å½©è‰²å¡ç‰‡ï¼ˆæµ…è‰²ï¼‰ */
  .lb442-doc .metric-card.m1{background:linear-gradient(135deg,#e3f2fd 0%,#ffffff 70%);border:1px solid rgba(25,118,210,.35);box-shadow:0 4px 14px -4px rgba(25,118,210,.35),0 2px 6px rgba(0,0,0,.05);position:relative;overflow:hidden;}
  .lb442-doc .metric-card.m2{background:linear-gradient(135deg,#f3e5f5 0%,#ffffff 70%);border:1px solid rgba(142,36,170,.35);box-shadow:0 4px 14px -4px rgba(142,36,170,.35),0 2px 6px rgba(0,0,0,.05);position:relative;overflow:hidden;}
  .lb442-doc .metric-card.m3{background:linear-gradient(135deg,#fff3e0 0%,#ffffff 70%);border:1px solid rgba(245,124,0,.4);box-shadow:0 4px 14px -4px rgba(245,124,0,.38),0 2px 6px rgba(0,0,0,.05);position:relative;overflow:hidden;}
  .lb442-doc .metric-card.m1:before,.lb442-doc .metric-card.m2:before,.lb442-doc .metric-card.m3:before{content:"";position:absolute;inset:0;pointer-events:none;mix-blend-mode:overlay;opacity:.55;}
  .lb442-doc .metric-card.m1:before{background:radial-gradient(circle at 85% 18%,rgba(25,118,210,.35),transparent 60%);} 
  .lb442-doc .metric-card.m2:before{background:radial-gradient(circle at 82% 20%,rgba(142,36,170,.35),transparent 60%);} 
  .lb442-doc .metric-card.m3:before{background:radial-gradient(circle at 80% 22%,rgba(245,124,0,.4),transparent 60%);} 
  .lb442-doc .metric-card h4 em{background:rgba(0,0,0,.08);padding:2px 6px;border-radius:12px;font-style:normal;font-weight:600;font-size:11px;letter-spacing:.5px;}
  /* è¯„åˆ†è¯¦æƒ… sparkline åŸºç¡€ */
  .lb-sparkline{max-width:200px;height:50px;}
  .lb-spark-legend .lb-dot{border:1px solid rgba(0,0,0,.15);} 
  /* è¿›åº¦æ¡åŠ¨ç”» */
  .lb-detail-modal .bar>i{animation:lbGrow .8s ease;} @keyframes lbGrow{from{transform:scaleX(.1);}to{transform:scaleX(1);}}
  /* ====== ç»Ÿä¸€å¡ç‰‡ä½“ç³» ====== */
  .lb-card{background:linear-gradient(145deg,#ffffff,#f6f8fa);border:1px solid rgba(0,0,0,0.06);border-radius:14px;padding:14px 16px;box-shadow:0 4px 12px -2px rgba(0,0,0,.08),0 2px 4px rgba(0,0,0,.04);position:relative;overflow:hidden;transition:.3s;}
  .lb-card:before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 85% 15%,rgba(56,189,248,.18),transparent 60%);opacity:.7;pointer-events:none;mix-blend-mode:overlay;}
  .lb-card:hover{box-shadow:0 8px 28px -6px rgba(0,0,0,.18),0 4px 12px rgba(0,0,0,.08);transform:translateY(-2px);}
  .lb-subcard{background:linear-gradient(160deg,#ffffff,#f2f4f7);border:1px solid rgba(0,0,0,0.05);border-radius:10px;padding:12px 14px;box-shadow:0 2px 6px rgba(0,0,0,.06);position:relative;overflow:hidden;transition:.25s;}
  .lb-subcard:after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(99,102,241,.08),rgba(168,85,247,.05));opacity:0;transition:.4s;pointer-events:none;}
  .lb-subcard:hover:after{opacity:1;}
  .lb-card h4,.lb-subcard h4,.lb-section-title{margin:0 0 8px;font-size:14px;font-weight:600;letter-spacing:.5px;display:flex;align-items:center;gap:6px;}
  .lb-card-title{font-size:13px;font-weight:600;margin:0 0 4px;display:flex;align-items:center;gap:6px;}
  .lb-chip{display:inline-flex;align-items:center;gap:4px;font-size:11px;padding:2px 8px;border-radius:20px;background:rgba(0,0,0,.06);color:#444;font-weight:500;}
  .lb-chip.primary{background:rgba(25,118,210,.15);color:#0d47a1;}
  .lb-chip.accent{background:rgba(142,36,170,.15);color:#6a1b9a;}
  .lb-chip.warn{background:rgba(245,124,0,.15);color:#e65100;}
  .lb-chip.good{background:rgba(46,125,50,.15);color:#1b5e20;}
  .lb-divider{height:1px;background:linear-gradient(90deg,rgba(0,0,0,.08),rgba(0,0,0,.03));margin:10px 0;}
  .lb-card-list{list-style:disc;padding-left:18px;margin:6px 0 0;font-size:12px;line-height:1.6;}
  .lb-suggestion-list{padding-left:18px;margin:0;font-size:12px;line-height:1.7;}
  .lb-footer-formula{font-size:11px;color:var(--text-secondary);background:#fff;border:1px dashed var(--border-color);padding:10px 12px;border-radius:10px;line-height:1.5;}
  /* è¯„åˆ†è§£æå½©è‰²ç»´åº¦å¡ç‰‡ */
  .lb-detail-modal .card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:14px;margin-bottom:10px;}
  .lb-dcard{position:relative;border-radius:16px;padding:14px 16px 12px;overflow:hidden;color:#123;box-shadow:0 4px 14px -4px rgba(0,0,0,.15),0 2px 8px rgba(0,0,0,.06);display:flex;flex-direction:column;gap:6px;min-height:150px;}
  .lb-dcard:before{content:"";position:absolute;inset:0;pointer-events:none;mix-blend-mode:overlay;opacity:.55;}
  .lb-dcard h5{margin:0;font-size:13px;font-weight:700;letter-spacing:.5px;display:flex;align-items:center;gap:6px;}
  .lb-dcard .big{font-size:26px;font-weight:800;line-height:1;margin-top:2px;}
  .lb-dcard .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;}
  .lb-chip.sm{font-size:10px;padding:2px 6px;}
  .lb-dcard.d1{background:linear-gradient(135deg,#e3f2fd,#ffffff);border:1px solid rgba(25,118,210,.35);} 
  .lb-dcard.d1:before{background:radial-gradient(circle at 85% 18%,rgba(25,118,210,.38),transparent 65%);} 
  .lb-dcard.d2{background:linear-gradient(135deg,#f3e5f5,#ffffff);border:1px solid rgba(142,36,170,.35);} 
  .lb-dcard.d2:before{background:radial-gradient(circle at 82% 20%,rgba(142,36,170,.38),transparent 65%);} 
  .lb-dcard.d3{background:linear-gradient(135deg,#fff3e0,#ffffff);border:1px solid rgba(245,124,0,.4);} 
  .lb-dcard.d3:before{background:radial-gradient(circle at 80% 22%,rgba(245,124,0,.45),transparent 65%);} 
  .lb-dcard.suggest{background:linear-gradient(135deg,#e8f5e9,#ffffff);border:1px solid rgba(46,125,50,.35);} 
  .lb-dcard.suggest:before{background:radial-gradient(circle at 80% 18%,rgba(46,125,50,.35),transparent 65%);} 
  .lb-dcard.trend{background:linear-gradient(135deg,#ede7f6,#ffffff);border:1px solid rgba(103,58,183,.35);} 
  .lb-dcard.trend:before{background:radial-gradient(circle at 82% 18%,rgba(103,58,183,.35),transparent 65%);} 
  .lb-dcard.formula{background:linear-gradient(135deg,#f5f7fa,#ffffff);border:1px dashed rgba(99,115,129,.4);} 
  .lb-dcard ul{margin:4px 0 0;padding-left:18px;font-size:11px;line-height:1.6;}
  .lb-dcard .minor{font-size:11px;color:var(--text-secondary);}
  .lb-dcard .pen-break{font-size:11px;line-height:1.5;margin-top:2px;}
  /* å…¬å¼å¡ç‰‡å¼±åŒ–æ˜¾ç¤ºï¼šå»èƒŒæ™¯/é˜´å½±/ç»Ÿä¸€æˆåˆ†éš”è¡Œ */
  .lb-dcard.formula{background:transparent;border:none;border-top:1px dashed rgba(99,115,129,.4);box-shadow:none;padding:6px 6px 4px 6px;min-height:auto;border-radius:0;margin-top:10px;}
  .lb-dcard.formula:before{display:none;}
  .lb-dcard.formula h5{font-size:11px;font-weight:600;color:var(--text-secondary);margin:0 0 4px;letter-spacing:.5px;}
  .lb-dcard.formula .formula-text{font-size:11px;line-height:1.45;color:var(--text-secondary);}
  @media (prefers-color-scheme: dark){
    .lb-dcard.formula{border-top:1px dashed #39424a;}
    .lb-dcard.formula h5,.lb-dcard.formula .formula-text{color:#8b949e;}
  }
  .lb-dcard .pen-break div{display:flex;justify-content:space-between;}
  @media (prefers-color-scheme: dark){
    .lb-dcard{color:#d8e4ee;box-shadow:0 4px 18px -6px rgba(0,0,0,.65);} 
    .lb-dcard.d1{background:linear-gradient(140deg,#0d2538,#10344d);border-color:rgba(56,139,253,.45);} .lb-dcard.d1:before{background:radial-gradient(circle at 85% 18%,rgba(56,139,253,.5),transparent 65%);} 
    .lb-dcard.d2{background:linear-gradient(140deg,#271b33,#332040);border-color:rgba(173,127,255,.45);} .lb-dcard.d2:before{background:radial-gradient(circle at 82% 20%,rgba(173,127,255,.5),transparent 65%);} 
    .lb-dcard.d3{background:linear-gradient(140deg,#351f07,#4a2a08);border-color:rgba(255,171,64,.55);} .lb-dcard.d3:before{background:radial-gradient(circle at 80% 22%,rgba(255,171,64,.55),transparent 65%);} 
    .lb-dcard.suggest{background:linear-gradient(140deg,#0f2e1a,#18422b);border-color:rgba(46,160,70,.5);} .lb-dcard.suggest:before{background:radial-gradient(circle at 80% 18%,rgba(46,160,70,.5),transparent 65%);} 
    .lb-dcard.trend{background:linear-gradient(140deg,#241b35,#2e2342);border-color:rgba(136,118,210,.5);} .lb-dcard.trend:before{background:radial-gradient(circle at 82% 18%,rgba(136,118,210,.55),transparent 65%);} 
    .lb-dcard.formula{background:linear-gradient(140deg,#1f2429,#202d36);border-color:#39424a;} 
    .lb-dcard .minor{color:#8b949e;}
  }
  /* è§„åˆ™è¯´æ˜ä¸¤åˆ—è¿·ä½ å¡ç‰‡ */
  .lb442-doc .lb442-section.two-col{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;align-items:stretch;}
  .lb442-doc .mini-card{position:relative;background:linear-gradient(135deg,#fef3e7,#fef9f3);border:1px solid rgba(251,146,60,.25);border-radius:14px;padding:14px 16px;box-shadow:0 3px 10px -2px rgba(251,146,60,.15),0 1px 3px rgba(251,146,60,.08);overflow:hidden;transition:.3s;}
  .lb442-doc .mini-card:before{content:"";position:absolute;inset:0;pointer-events:none;opacity:.55;mix-blend-mode:overlay;}
  .lb442-doc .mini-card.mc-low:before{background:radial-gradient(circle at 82% 18%,rgba(255,193,7,.35),transparent 60%);} 
  .lb442-doc .mini-card.mc-anti:before{background:radial-gradient(circle at 80% 20%,rgba(56,189,248,.35),transparent 60%);} 
  .lb442-doc .mini-card:hover{box-shadow:0 8px 26px -6px rgba(0,0,0,.18),0 4px 10px rgba(0,0,0,.08);transform:translateY(-2px);} 
  .lb442-doc .mini-card h4{margin:0 0 8px;font-size:14px;font-weight:600;letter-spacing:.5px;display:flex;align-items:center;gap:6px;}
  .lb442-doc .mini-card ul{margin:0;padding-left:18px;font-size:12px;line-height:1.65;list-style:disc;}
  /* æ·±è‰²æ¨¡å¼å¡ç‰‡ */
  @media (prefers-color-scheme: dark){
    .lb-card{background:linear-gradient(140deg,#1f2429,#202a34);border:1px solid #2d333b;box-shadow:0 4px 16px -4px rgba(0,0,0,.6);} 
    .lb-card:before{background:radial-gradient(circle at 85% 15%,rgba(56,189,248,.25),transparent 60%);} 
    .lb-subcard{background:linear-gradient(160deg,#1f2429,#1c2730);border:1px solid #2d333b;box-shadow:0 2px 8px rgba(0,0,0,.5);} 
    .lb-subcard:after{background:linear-gradient(120deg,rgba(99,102,241,.18),rgba(168,85,247,.15));}
    .lb-chip{background:rgba(255,255,255,.08);color:#c9d1d9;}
    .lb-chip.primary{background:rgba(25,118,210,.25);color:#90caf9;}
    .lb-chip.accent{background:rgba(142,36,170,.25);color:#e1bee7;}
    .lb-chip.warn{background:rgba(245,124,0,.25);color:#ffcc80;}
    .lb-chip.good{background:rgba(46,125,50,.25);color:#a5d6a7;}
     .lb442-doc .mini-card{background:linear-gradient(140deg,#1f2429,#1d2730);border:1px solid #2d333b;box-shadow:0 4px 16px -6px rgba(0,0,0,.6);} 
     .lb442-doc .mini-card.mc-low:before{background:radial-gradient(circle at 80% 18%,rgba(255,193,7,.4),transparent 60%);} 
     .lb442-doc .mini-card.mc-anti:before{background:radial-gradient(circle at 80% 20%,rgba(56,189,248,.45),transparent 60%);} 
    .lb-footer-formula{background:#1f2429;border-color:#2d333b;color:#8b949e;}
  }
  @media (prefers-color-scheme: dark){
    .lb442-doc{color:#f0f6fc;}
  .lb442-doc .lb-head-card{background:linear-gradient(135deg,#0a1929,#0d2538 55%,#10344d);border:1px solid rgba(56,139,253,.4);box-shadow:0 10px 32px -10px rgba(2,34,64,.85),0 4px 18px -4px rgba(0,0,0,.65);} 
  .lb442-doc .lb-head-card:before{background:radial-gradient(circle at center,rgba(56,139,253,.5),transparent 60%);} 
  .lb442-doc .lb-head-card h2{background:linear-gradient(90deg,#e3f2fd,#bbdefb);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  .lb442-doc .lb-head-card .lb442-tagline{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);color:#e3f2fd;}
  .lb442-doc .scard{background:linear-gradient(145deg,#1f2429,#202d36);border:1px solid #2d333b;box-shadow:0 4px 18px -6px rgba(0,0,0,.6);} 
  .lb442-doc .scard:before{background:radial-gradient(circle at 88% 16%,rgba(56,139,253,.3),transparent 70%);} 
  .lb442-doc .scard h3 span{background:rgba(56,139,253,.18);color:#90caf9;}
  
  /* æ ¸å¿ƒç†å¿µæ·±è‰²æ¨¡å¼ */
  .lb442-doc .core-concept{background:linear-gradient(135deg,#1a202c,#1e293b);border:1px solid #334155;box-shadow:0 3px 12px -2px rgba(0,0,0,.4);}
  .lb442-doc .core-concept h3{color:#f1f5f9;}
  .lb442-doc .core-concept h3 span{color:#60a5fa;background:rgba(59,130,246,.25);border:1px solid rgba(59,130,246,.3);}
  .lb442-doc .concept-card{background:rgba(30,41,59,.6);border:1px solid #475569;}
  .lb442-doc .concept-card:hover{box-shadow:0 4px 12px -2px rgba(0,0,0,.3);}
  .lb442-doc .cc-content h4{color:#f8fafc;}
  .lb442-doc .cc-content p{color:#cbd5e1;}
  
  .lb442-doc .examples .ex{background:linear-gradient(150deg,#1f2429,#1b2933);border:1px solid #2d333b;box-shadow:0 2px 10px rgba(0,0,0,.55);} 
  .lb442-doc .examples .ex .tag.ok{background:rgba(16,185,129,.2);color:#34d399;}
  .lb442-doc .examples .ex .tag.warn{background:rgba(245,158,11,.22);color:#fbbf24;}
  .lb442-doc .examples .ex .tag.info{background:rgba(59,130,246,.25);color:#60a5fa;}
  .lb442-doc .principles li{background:linear-gradient(145deg,#1f2429,#1d2730);border:1px solid #2d333b;box-shadow:0 2px 10px rgba(0,0,0,.55);} 
  .lb442-doc .principles li strong{color:#58a6ff;}
  /* æå‡æš—è‰²å¯è¯»æ€§ï¼šæ–‡å­—ä¸èƒŒæ™¯å¯¹æ¯” */
  .lb442-doc .scard{color:#d9e2ec;}
  .lb442-doc .scard h3{color:#f0f6fc;}
  .lb442-doc .scard ul.key-points li{color:#c5d1dc;}
  .lb442-doc .scard .note{color:#8b949e;}
  .lb442-doc .formula-box{background:#0f172a;color:#e2e8f0;border:1px solid #374151;}
  .lb442-doc .mini-card{color:#d4dde6;}
  .lb442-doc .mini-card h4{color:#ffffff;}
  .lb442-doc .mini-card ul li{color:#c5d1dc;}
  .lb442-doc .examples .ex{color:#d0dae4;}
  .lb442-doc .examples .ex p{color:#c5d1dc;}
  .lb442-doc .principles li{color:#c5d1dc;}
  .lb442-doc .principles li strong{color:#7cb8ff;}
  .lb442-doc .lb-head-card .lb442-sub{color:rgba(255,255,255,.92);} 
  .lb442-doc .lb-head-card .lb442-tagline{color:#e3f2fd;}
  /* å‡å¼±å¾„å‘å…‰æ–‘ä»¥é¿å…æ–‡å­—èå…¥ */
  .lb442-doc .scard:before{opacity:.45;}
  .lb442-doc .mini-card:before{opacity:.5;}
  .lb442-doc .metric-card.m1:before,.lb442-doc .metric-card.m2:before,.lb442-doc .metric-card.m3:before{opacity:.5;}
    .lb442-doc .metric-card{background:#1f2429;border:1px solid #30363d;box-shadow:0 2px 6px rgba(0,0,0,.4);} 
    .lb442-doc .metric-card:hover{box-shadow:0 6px 20px -4px rgba(0,0,0,.65);} 
    .lb-spark-legend .lb-dot{border:1px solid #555;}
    .lb-detail-modal .panel{background:#1f2429 !important;border-color:#30363d !important;box-shadow:0 2px 4px rgba(0,0,0,.5);} 
    .lb-detail-modal .suggest-box{background:#1f2d36 !important;border-color:#2d3b47 !important;}
    .lb-detail-modal .bar{background:#2d3b47 !important;}
    .lb-detail-modal .formula-box{background:#1f2429 !important;border-color:#30363d !important;color:#8b949e;}
    .lb-detail-modal .trend-box{background:#1f2429 !important;border-color:#30363d !important;}
     /* ä¸‰å¤§ç»´åº¦å½©è‰²å¡ç‰‡ï¼ˆæ·±è‰²ï¼‰ */
     .lb442-doc .metric-card.m1{background:linear-gradient(140deg,#0d2538,#10344d);border:1px solid rgba(56,139,253,.4);box-shadow:0 4px 18px -6px rgba(56,139,253,.55),0 2px 8px rgba(0,0,0,.6);} 
     .lb442-doc .metric-card.m2{background:linear-gradient(140deg,#271b33,#332040);border:1px solid rgba(173,127,255,.45);box-shadow:0 4px 18px -6px rgba(173,127,255,.5),0 2px 8px rgba(0,0,0,.6);} 
     .lb442-doc .metric-card.m3{background:linear-gradient(140deg,#351f07,#4a2a08);border:1px solid rgba(255,171,64,.5);box-shadow:0 4px 18px -6px rgba(255,171,64,.5),0 2px 8px rgba(0,0,0,.6);} 
     .lb442-doc .metric-card.m1:before{background:radial-gradient(circle at 80% 18%,rgba(56,139,253,.45),transparent 60%);} 
     .lb442-doc .metric-card.m2:before{background:radial-gradient(circle at 80% 18%,rgba(173,127,255,.5),transparent 60%);} 
     .lb442-doc .metric-card.m3:before{background:radial-gradient(circle at 78% 20%,rgba(255,171,64,.55),transparent 60%);} 
     .lb442-doc .metric-card h4 em{background:rgba(255,255,255,.12);color:#fff;}
  }`;
  document.head.appendChild(style);
}

// æ˜¾ç¤ºå•ä¸ªå­¦ç”Ÿçš„è¯¦ç»†å¾—åˆ†
function showStudentLeaderboardDetail(studentName){
  // ç¡®ä¿æ‰©å±•æ ·å¼å·²æ³¨å…¥
  try{ ensureLBExtraStyles(); }catch(e){}
  const student = leaderboardState.raw.find(r => r.name === studentName);
  if(!student){ alert('æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿçš„æ•°æ®'); return; }
  const p1 = student.dim1;
  const p2 = student.dim2;
  const p3 = student.dim3;
  
  // ===== æ–°è®¾è®¡ï¼šä¸“ä¸šã€ç´§å‡‘ã€ç›´è§‚ =====
  function bar(percent, color){
    return `<div style="height:8px;border-radius:4px;background:linear-gradient(90deg,${color} ${percent}%,rgba(0,0,0,0.08) ${percent}%);"></div>`;
  }
  // ç»´åº¦è¿›åº¦ï¼ˆè½¬æ¢åˆ° 0~100ï¼‰
  const d1Pct = (p1.score/40*100).toFixed(1);
  const d2Pct = (p2.score/40*100).toFixed(1);
  const d3Pct = (p3.score/ ( (p1.score+p2.score)>0 ? ((p1.score+p2.score)*LB442_PARAMS.dim3.percentStart) : 1) *100).toFixed(1);

  // åˆ†ç±»ä¿¡æ¯
  const attendanceStatus = (()=>{
    if(p1.absentSlots>0) return 'å‡ºå‹¤éœ€æå‡';
    if(p1.completed === p1.total && p1.latePenalty===0) return 'å‡ºå‹¤ä¼˜ç§€';
    return 'åŸºæœ¬è¾¾æ ‡';
  })();
  const qualityStatus = (()=>{
    const pen = p2.penalties; const sum = pen.long+pen.short+pen.window+pen.tail;
    if(sum===0) return 'è´¨é‡ç»“æ„ä¼˜ç§€';
    if(sum<8) return 'è´¨é‡è‰¯å¥½';
    return 'éœ€ä¼˜åŒ–ç»“æ„';
  })();
  const growthStatus = p3.score>0 ? (p3.breakdown && p3.breakdown.progress>0 ? 'æˆé•¿åŠ é€Ÿ' : 'æŒç»­æˆé•¿') : 'ç­‰å¾…æ¿€æ´»';

  // å»ºè®®ç”Ÿæˆ
  const suggestions = [];
  if(p1.absentSlots>0) suggestions.push(`å‡å°‘ç¼ºå¸­ï¼šä»Šå¤©ç¼ºå¸­ ${p1.absentSlots} æ®µ`);
  if(p1.latePenalty>0) suggestions.push(`æ§åˆ¶è¿Ÿåˆ°ï¼šè¿Ÿåˆ°æ‰£ ${p1.latePenalty.toFixed(1)} åˆ†`);
  if(p2.penalties.long>0) suggestions.push(`æ‹†åˆ†è¶…é•¿æ®µï¼šè¶…é•¿æ‰£ ${p2.penalties.long.toFixed(1)} åˆ†`);
  if(p2.penalties.short>0) suggestions.push(`å»¶é•¿è¿‡çŸ­æ®µï¼šçŸ­æ—¶æ‰£ ${p2.penalties.short.toFixed(1)} åˆ†`);
  if(p2.penalties.window>0) suggestions.push(`é¿å¼€ä½æ•ˆçª—å£ï¼šä½æ•ˆæ‰£ ${p2.penalties.window.toFixed(1)} åˆ†`);
  if(p2.penalties.tail>0) suggestions.push(`æ§åˆ¶æ‹–å°¾ï¼šæ‹–å°¾æ‰£ ${p2.penalties.tail.toFixed(1)} åˆ†`);
  /* ç§»é™¤æ™¨ç»ƒåŠ æˆç›¸å…³å»ºè®® */
  if(p3.breakdown && p3.breakdown.freshnessMultiplier<1) suggestions.push('é€‚å½“è½®æ¢é«˜å³°æ—¶æ®µï¼Œå‡å°‘éœ¸æ¦œè¡°å‡');
  if(!suggestions.length) suggestions.push('ä¿æŒå½“å‰èŠ‚å¥ï¼Œç»§ç»­å·©å›ºç¨³å®šæ€§');
  const topSuggestions = suggestions.slice(0,3);

  // è¯¦ç»†åˆ†é¡¹ï¼ˆç²¾ç®€ï¼šæ˜¾ç¤ºä¸»è¦æ‰£åˆ†ä¸åŠ æˆï¼‰
  function penaltyLine(label,val){ if(!val) return ''; return `<div style=\"display:flex;justify-content:space-between;font-size:12px;\"><span>${label}</span><span>-${val.toFixed(1)}</span></div>`; }
  function bonusLine(label,val){ if(!val) return ''; return `<div style=\"display:flex;justify-content:space-between;font-size:12px;color:#1b5e20;\"><span>${label}</span><span>+${val.toFixed(1)}</span></div>`; }

  const dim2BreakMini = `
    ${penaltyLine('è¶…é•¿', p2.penalties.long)}
    ${penaltyLine('çŸ­æ—¶', p2.penalties.short)}
    ${penaltyLine('ä½æ•ˆæ®µ', p2.penalties.window)}
    ${penaltyLine('æ‹–å°¾', p2.penalties.tail)}
  `;
  const p2PenaltySum = (p2.penalties.long + p2.penalties.short + p2.penalties.window + p2.penalties.tail).toFixed(1);
  const chipsD1 = `<span class=\"lb-chip sm primary\">è¦†ç›– ${(p1.completed/Math.max(1,p1.total)*100).toFixed(0)}%</span>${p1.absentSlots?`<span class=\"lb-chip sm warn\">ç¼ºå¸­ ${p1.absentSlots}</span>`:''}${p1.latePenalty?`<span class=\"lb-chip sm warn\">è¿Ÿåˆ° -${p1.latePenalty.toFixed(1)}</span>`:''}`;
  const chipsD2 = `<span class=\"lb-chip sm accent\">æœ‰æ•ˆ ${p2.actual}m</span><span class=\"lb-chip sm warn\">æ‰£åˆ† ${p2PenaltySum}</span>`;
  const chipsD3 = p3.breakdown?`<span class=\"lb-chip sm good\">è¿›æ­¥ +${p3.breakdown.progress.toFixed(1)}</span><span class=\"lb-chip sm good\">ç¨³å®š +${p3.breakdown.consistency.toFixed(1)}</span>${p3.breakdown.freshness>0?`<span class=\"lb-chip sm good\">æ–°é²œ +${p3.breakdown.freshness.toFixed(1)}</span>`:''}`:'';

  const growthBreak = p3.breakdown ? `
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;font-size:11px;text-align:center;margin-top:6px;">
      <div><div style="font-weight:600;">æ˜¨æ—¥</div><div>+${p3.breakdown.yesterday.toFixed(1)}</div></div>
      <div><div style="font-weight:600;">è¿›æ­¥</div><div>+${p3.breakdown.progress.toFixed(1)}</div></div>
      <div><div style="font-weight:600;">ç¨³å®š</div><div>+${p3.breakdown.consistency.toFixed(1)}</div></div>
      <div><div style="font-weight:600;">æ–°é²œ</div><div>+${p3.breakdown.freshness.toFixed(1)}</div></div>
    </div>
    ${p3.breakdown.freshnessMultiplier<1?`<div style=\"margin-top:4px;font-size:11px;color:#ff9800;\">è¡°å‡Ã—${p3.breakdown.freshnessMultiplier.toFixed(2)}</div>`:''}
  `:'';

  const content = `
    <div class="lb-detail-modal" style="padding:18px 18px 22px;font-size:14px;line-height:1.6;">
      <div style="text-align:center;margin-bottom:18px;">
        <div style="font-size:22px;font-weight:700;color:var(--primary-color);letter-spacing:.5px;">${escapeHtml(studentName)}</div>
        <div style="margin-top:4px;font-size:12px;color:var(--text-secondary);">442 ç»¼åˆå¾—åˆ†</div>
        <div class="lb-card" style="margin-top:10px;padding:16px 14px;background:linear-gradient(135deg,var(--primary-color),#2563eb);color:#fff;display:flex;align-items:center;justify-content:center;gap:18px;box-shadow:0 6px 24px -6px rgba(0,0,0,.35);">
          <div style="text-align:center;">
            <div style="font-size:40px;font-weight:800;line-height:1;">${student.total.toFixed(2)}</div>
            <div style="font-size:11px;opacity:.85;">æ€»åˆ† /100</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;min-width:160px;">
            <div style="font-size:12px;display:flex;justify-content:space-between;align-items:center;gap:6px;">D1 <span style="font-weight:600;">${p1.score.toFixed(1)}</span></div>
            ${bar(d1Pct,'#1976d2')}
            <div style="font-size:12px;display:flex;justify-content:space-between;align-items:center;gap:6px;">D2 <span style="font-weight:600;">${p2.score.toFixed(1)}</span></div>
            ${bar(d2Pct,'#8e24aa')}
            <div style="font-size:12px;display:flex;justify-content:space-between;align-items:center;gap:6px;">D3 <span style="font-weight:600;">${p3.score.toFixed(1)}</span></div>
            ${bar(d3Pct,'#f57c00')}
          </div>
        </div>
      </div>
      
      <div class="card-grid">
        <div class="lb-dcard d1" style="border:1px solid rgba(25,118,210,.3);">
          <h5>ğŸ“… å‡ºå‹¤ <span class="minor">D1</span></h5>
          <div class="big">${p1.score.toFixed(1)}</div>
          <div class="chips">${chipsD1}</div>
          <div class="minor" style="margin-top:4px;color:${attendanceStatus==='å‡ºå‹¤ä¼˜ç§€'?'#2e7d32':attendanceStatus==='å‡ºå‹¤éœ€æå‡'?'#d32f2f':'#ef6c00'};">${attendanceStatus}</div>
        </div>
  <div class="lb-dcard d2" style="border:1px solid rgba(142,36,170,.3);">
          <h5>âš¡ è´¨é‡ <span class="minor">D2</span></h5>
            <div class="big">${p2.score.toFixed(1)}</div>
            <div class="chips">${chipsD2}</div>
            <div class="pen-break">${dim2BreakMini}</div>
            <div class="minor" style="color:${qualityStatus==='è´¨é‡ç»“æ„ä¼˜ç§€'?'#2e7d32':qualityStatus==='éœ€ä¼˜åŒ–ç»“æ„'?'#d32f2f':'#ef6c00'};">${qualityStatus}</div>
        </div>
  <div class="lb-dcard d3" style="border:1px solid rgba(245,124,0,.35);">
          <h5>ğŸ† æˆé•¿ <span class="minor">D3</span></h5>
          <div class="big">${p3.score.toFixed(1)}</div>
          <div class="chips">${chipsD3}</div>
          <div class="minor" style="margin-top:4px;color:${growthStatus.includes('ç­‰å¾…')?'#888':'#2e7d32'};">${growthStatus}</div>
          ${growthBreak}
        </div>
      </div>
      
  <div class="lb-dcard suggest" style="margin-top:12px;border:1px solid rgba(46,125,50,.35);">
        <h5>ğŸ¯ ä¼˜å…ˆæ”¹è¿›å»ºè®®</h5>
        <div class="chips">${topSuggestions.map(s=>`<span class='lb-chip sm warn'>${escapeHtml(s)}</span>`).join('')}</div>
      </div>
  <div class="lb-dcard trend" style="margin-top:14px;border:1px solid rgba(103,58,183,.35);">
        <h5 style="display:flex;align-items:center;gap:6px;">ğŸ“ˆ æœ€è¿‘5ä¸ªå·¥ä½œæ—¥è¶‹åŠ¿</h5>
        ${ (function(){ const d=getStudentRecentDimensionHistory(student.name,5); return renderSparkline(d); })() }
      </div>
      
  <div class="lb-dcard formula" style="margin-top:8px;">
        <h5>ğŸ§® å…¬å¼</h5>
        <div class="formula-text">æ€»åˆ† = D1Ã—40% + D2Ã—40% + D3Ã—20% â†’ ${p1.score.toFixed(1)}Ã—0.4 + ${p2.score.toFixed(1)}Ã—0.4 + ${p3.score.toFixed(1)}Ã—0.2 = <strong style="color:var(--primary-color);">${student.total.toFixed(2)}</strong></div>
      </div>
    </div>`;
  createCenterModal(content, `${studentName} Â· è¯„åˆ†è§£æ`);
}

function initLeaderboardEvents(){
  const toggle = document.getElementById('lb-toggle-more');
  if(toggle) toggle.addEventListener('click',()=>{leaderboardState.expanded=!leaderboardState.expanded;renderLeaderboard();});
}

// å†å²å¿«ç…§åŠŸèƒ½
function saveLeaderboardSnapshot(rows) {
  if (!rows || rows.length === 0) return;
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯å‘¨æœ«ï¼Œå‘¨æœ«ä¸è¿›è¡Œäº‘ç«¯å¤‡ä»½
  const nowMs = (window.serverNowMs ? window.serverNowMs() : Date.now());
  const now = new Date(nowMs);
  const dayOfWeek = now.getDay(); // 0=å‘¨æ—¥, 6=å‘¨å…­
  if (dayOfWeek === 0 || dayOfWeek === 6) {
    console.log('[leaderboard] å‘¨æœ«æœŸé—´ä¸è¿›è¡Œäº‘ç«¯å¤‡ä»½');
    return;
  }
  
  const dateKey = formatDate(now).replace(/\//g,'-');
  const hour = now.getHours();
  const minute = now.getMinutes();
  const isTestMode = window.location.search.includes('test') || localStorage.getItem('leaderboard_test_mode') === 'true';
  const freezeMin = getTodayFreezeMinutes(now);
  const curMin = hour*60 + minute;
  const isPastCutoff = curMin >= freezeMin; // ä½¿ç”¨æ–°çš„å†»ç»“åˆ†é’Ÿ
  const pendingSource = window.__snapshotSourceOverride || null; // å¤–éƒ¨å¼ºåˆ¶æ¥æº
  window.__snapshotSourceOverride = null;
  if (!isPastCutoff && !isTestMode && !pendingSource) return; // final/guard å¯ç»•è¿‡
  try {
    const snapshots = JSON.parse(localStorage.getItem('leaderboard_history') || '{}');
    const existing = snapshots[dateKey];
    // å·²æœ‰ final åˆ™ä¸è¦†å†™ï¼ˆé™¤æµ‹è¯•ï¼‰
    if (existing && existing.meta && existing.meta.final && !pendingSource && !isTestMode) return;
    // æ™®é€šè‡ªåŠ¨ä¿å­˜è‹¥å·²å­˜åœ¨æ™®é€šå¿«ç…§ç›´æ¥è·³è¿‡ï¼ˆæœªåˆ° final å‰ï¼‰
    if (!pendingSource && existing && !isTestMode && !isPastCutoff) return;
    function hashString(str){ let h=5381,i=str.length; while(i) h=(h*33)^str.charCodeAt(--i); return (h>>>0).toString(16); }
    // ä¿å­˜å®Œæ•´æ¦œå•ï¼ˆç”¨äºäº‘ç«¯ & ç»´åº¦3 å†å²è®¡ç®—æ›´å‡†ç¡®ï¼‰
    const fullRows = rows.map(r=>({n:r.name,t:r.total,d1:r.dim1.score,d2:r.dim2.score,d3:r.dim3.score}));
    const compactRows = fullRows.slice(0,20);
    const rowsHash = hashString(JSON.stringify(compactRows));
    // è®°å½•æ˜¯å¦å·²ä¿å­˜å†»ç»“å¿«ç…§ï¼Œé¿å…é‡å¤
    const freezeFlagKey = 'freeze_snapshot_done_'+dateKey;
  if(!pendingSource && isPastCutoff && localStorage.getItem(freezeFlagKey) && !(existing && existing.meta && existing.meta.final)){
      // å·²æœ‰å†»ç»“æ—¶é—´çš„ç¬¬ä¸€æ¬¡ä¿å­˜ä¸”é finalï¼Œä¸é‡å¤
      return;
    }
    let source = pendingSource || (isTestMode ? 'test-manual' : (isPastCutoff ? 'final-freeze' : 'auto-freeze'));
    const isFinal = source==='final-freeze';
    snapshots[dateKey] = {
      date: dateKey,
      timestamp: now.getTime(),
      data: compactRows,
      full: fullRows, // æ–°å¢ï¼šå®Œæ•´æ¦œå•
      totalCount: rows.length,
      isTestData: isTestMode,
      meta: {
        version:1,
        source,
        final: isFinal,
        computedAt: now.toISOString(),
        offsetMs: window.__serverTimeOffsetMs || 0,
        rowsHash
      }
    };
    const cutoffTime = now.getTime() - (30*24*60*60*1000);
    Object.keys(snapshots).forEach(k=>{ if(snapshots[k].timestamp < cutoffTime) delete snapshots[k]; });
    localStorage.setItem('leaderboard_history', JSON.stringify(snapshots));
  if(isPastCutoff && source==='auto-freeze') localStorage.setItem(freezeFlagKey,'1');
    console.log(`[å†å²å¿«ç…§] å·²ä¿å­˜ ${dateKey} (${source}) ${isTestMode?'(æµ‹è¯•)':''}`);

    // ===== æ–°å¢ï¼šä¿å­˜åè§¦å‘äº‘ç«¯ä¸Šä¼ æ£€æŸ¥ =====
    try { if(window.__attemptCloudPersistDailySnapshot) window.__attemptCloudPersistDailySnapshot('after-save'); } catch(e){ console.warn('[äº‘ç«¯å¿«ç…§] è§¦å‘å¤±è´¥', e); }
  } catch(e){ console.error('[å†å²å¿«ç…§] ä¿å­˜å¤±è´¥:', e); }
}

// ================= äº‘ç«¯å¿«ç…§æŒä¹…åŒ– =================
// éœ€æ±‚ï¼šå†å²æ’è¡Œæ¦œè¦ç¡®ä¿æ•°æ®å­˜åœ¨äº‘ç«¯ï¼Œæ–°è§„åˆ™ï¼šå‘¨ä¸€äºŒå››äº” 19:00 / å‘¨ä¸‰ 19:30 / å‘¨æœ« 21:30 ä¹‹åä¸Šä¼ ä¸€æ¬¡ï¼›å¤±è´¥é‡è¯•ç›´è‡³æˆåŠŸæˆ–è·¨æ—¥ã€‚
// é…ç½®æ–¹å¼ï¼š
//   localStorage.setItem('leaderboard_cloud_endpoint', 'https://example.com/api/leaderboardSnapshot');
//   å¯é€‰é‰´æƒï¼šlocalStorage.setItem('leaderboard_cloud_token', 'Bearer xxx');
// å…³é—­ä¸Šä¼ ï¼šåˆ é™¤ endpoint é…ç½®ã€‚
(function initCloudSnapshotPersistence(){
  const LS_FLAG_PREFIX = 'cloud_snapshot_uploaded_';
  const LS_RETRY_STATE = 'cloud_snapshot_retry_state';
  const MAX_RETRY_ATTEMPTS = 8; // å½“å¤©æœ€å¤š 8 æ¬¡ï¼ˆçº¦ 40 åˆ†é’Ÿè‹¥ 5min é—´éš”ï¼‰
  const RETRY_INTERVAL_MS = 5*60*1000;
  const MIN_GAP_BETWEEN_ATTEMPTS_MS = 60*1000; // é˜²æŠ–

  function getUploadStartMinutes(now){
    const d = now.getDay(); // 0=å‘¨æ—¥ 6=å‘¨å…­
    if(d===1||d===2||d===4||d===5) return 19*60;     // 19:00
    if(d===3) return 19*60+30;                       // 19:30 (å‘¨ä¸‰)
    return 21*60+30;                                 // å‘¨æœ« 21:30
  }

  function loadSnapshots(){
    try { return JSON.parse(localStorage.getItem('leaderboard_history')||'{}'); } catch { return {}; }
  }
  function pickSnapshotForDate(dateKey){
    const snaps = loadSnapshots();
    const snap = snaps[dateKey];
    if(!snap) return null;
    // å¦‚åç»­éœ€è¦åŒºåˆ† finalï¼Œå¯åœ¨æ­¤æ·»åŠ é€‰æ‹©é€»è¾‘ï¼ˆå½“å‰å­˜çš„æ˜¯è¦†ç›–å¼ï¼Œå·²æœ‰ final æ—¶ä¸è¦†å†™ï¼‰
    return snap;
  }
  function buildPayload(dateKey, snapshot){
    return {
      date: dateKey,
      generatedAt: snapshot.meta && snapshot.meta.computedAt || new Date(snapshot.timestamp).toISOString(),
      uploadAt: new Date((window.serverNowMs?window.serverNowMs():Date.now())).toISOString(),
      source: snapshot.meta && snapshot.meta.source,
      totalCount: snapshot.totalCount,
      final: !!(snapshot.meta && snapshot.meta.final),
      rows: snapshot.data.map(r=>({
        name: r.name,
        total: r.total,
        dim1: r.dim1 && r.dim1.score,
        dim2: r.dim2 && r.dim2.score,
        dim3: r.dim3 && r.dim3.score
      })),
      fullRows: (snapshot.full||snapshot.data).map(r=>({
        name: r.name,
        total: r.total,
        d1: r.d1!==undefined? r.d1 : (r.dim1&&r.dim1.score),
        d2: r.d2!==undefined? r.d2 : (r.dim2&&r.dim2.score),
        d3: r.d3!==undefined? r.d3 : (r.dim3&&r.dim3.score)
      }))
    };
  }
  function loadRetryState(){
    try { return JSON.parse(localStorage.getItem(LS_RETRY_STATE)||'{}'); } catch { return {}; }
  }
  function saveRetryState(st){ localStorage.setItem(LS_RETRY_STATE, JSON.stringify(st)); }

  async function upload(dateKey, snapshot){
    const endpoint = localStorage.getItem('leaderboard_cloud_endpoint') || '';
    if(!endpoint){ console.info('[äº‘ç«¯å¿«ç…§] æœªé…ç½® endpoint, è·³è¿‡'); return {skipped:true}; }
    const token = localStorage.getItem('leaderboard_cloud_token');
    const payload = buildPayload(dateKey, snapshot);
    console.log('[äº‘ç«¯å¿«ç…§] å¼€å§‹ä¸Šä¼ ', dateKey, payload);
    const resp = await fetch(endpoint, {
      method: 'POST',
      headers: Object.assign({'Content-Type':'application/json'}, token?{'Authorization':token}:{ }),
      body: JSON.stringify(payload)
    });
    if(!resp.ok){ throw new Error('HTTP '+resp.status); }
    const json = await resp.json().catch(()=>({}));
    console.log('[äº‘ç«¯å¿«ç…§] ä¸Šä¼ æˆåŠŸ', dateKey, json);
    return {ok:true, json};
  }

  function markUploaded(dateKey){
    localStorage.setItem(LS_FLAG_PREFIX+dateKey, '1');
  }
  function isUploaded(dateKey){ return !!localStorage.getItem(LS_FLAG_PREFIX+dateKey); }

  async function attempt(dateKey, reason){
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const curMin = now.getHours()*60 + now.getMinutes();
    const startMin = getUploadStartMinutes(now);
  const force = (reason==='after-save' || reason==='cloudTest');
  if(curMin < startMin && !force){ return; }
    if(isUploaded(dateKey)){ return; }
    const retryState = loadRetryState();
    const st = retryState[dateKey] || {attempts:0,lastAttempt:0};
    const nowMs = now.getTime();
  if(!force && nowMs - st.lastAttempt < MIN_GAP_BETWEEN_ATTEMPTS_MS){ return; }
  if(!force && st.attempts >= MAX_RETRY_ATTEMPTS){ console.warn('[äº‘ç«¯å¿«ç…§] è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°, åœæ­¢', dateKey); return; }
    const snapshot = pickSnapshotForDate(dateKey);
    if(!snapshot){ console.warn('[äº‘ç«¯å¿«ç…§] æ— æœ¬åœ°å¿«ç…§å¯ä¸Šä¼ ', dateKey); return; }
    st.attempts += 1; st.lastAttempt = nowMs; retryState[dateKey]=st; saveRetryState(retryState);
    try {
      const res = await upload(dateKey, snapshot);
      if(res.skipped) return; // æ—  endpoint
      markUploaded(dateKey);
      console.info('[äº‘ç«¯å¿«ç…§] æ ‡è®°å®Œæˆ', dateKey, 'å°è¯•æ¬¡æ•°:', st.attempts);
    } catch(e){ console.error('[äº‘ç«¯å¿«ç…§] ä¸Šä¼ å¤±è´¥', dateKey, e); }
  }

  // å‘å¤–æš´éœ²ï¼šç”¨äºä¿å­˜åç«‹å³è§¦å‘
  window.__attemptCloudPersistDailySnapshot = function(reason){
    try {
      const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
      const dateKey = formatDate(now).replace(/\//g,'-');
      attempt(dateKey, reason);
    } catch(e){ console.error('[äº‘ç«¯å¿«ç…§] immediate è°ƒç”¨å¼‚å¸¸', e); }
  };

  // ====== è¡¥ä¼ å†å²ç¼ºå¤±æ—¥æœŸ ======
  // å¤–éƒ¨è°ƒç”¨ï¼šwindow.backfillCloudSnapshots({start:'2025-09-01', end:'2025-09-10', parallel:2})
  // çœç•¥ start/end åˆ™å¯¹æœ¬åœ°æ‰€æœ‰æœªæ ‡è®°ä¸Šä¼ ä¸”éå½“å¤©æ—¥æœŸæ‰§è¡Œã€‚
  window.backfillCloudSnapshots = async function(opts){
    opts = opts || {};
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const todayKey = formatDate(now).replace(/\//g,'-');
    const snaps = loadSnapshots();
    let keys = Object.keys(snaps).filter(k=>k!==todayKey);
    keys.sort();
    if(opts.start) keys = keys.filter(k=>k>=opts.start);
    if(opts.end) keys = keys.filter(k=>k<=opts.end);
    keys = keys.filter(k=>!isUploaded(k));
    if(!keys.length){ console.info('[äº‘ç«¯å¿«ç…§][è¡¥ä¼ ] æ— éœ€è¡¥ä¼ '); return {done:true, count:0}; }
    console.warn('[äº‘ç«¯å¿«ç…§][è¡¥ä¼ ] å¾…è¡¥ä¼ æ•°é‡:', keys.length, keys);
    const endpoint = localStorage.getItem('leaderboard_cloud_endpoint') || '';
    if(!endpoint){ console.error('[äº‘ç«¯å¿«ç…§][è¡¥ä¼ ] æœªé…ç½® endpoint'); return {error:'no-endpoint'}; }
    const token = localStorage.getItem('leaderboard_cloud_token');
    const parallel = Math.max(1, Math.min( (opts.parallel||1), 5));
    let success=0, failed=0;
    async function uploadOne(dateKey){
      const snapshot = pickSnapshotForDate(dateKey);
      if(!snapshot){ console.warn('[äº‘ç«¯å¿«ç…§][è¡¥ä¼ ] è·³è¿‡æ— æœ¬åœ°æ•°æ®', dateKey); return; }
      const payload = buildPayload(dateKey, snapshot);
      try {
        const resp = await fetch(endpoint, { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, token?{'Authorization':token}:{}), body: JSON.stringify(payload)});
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        await resp.json().catch(()=>({}));
        markUploaded(dateKey);
        success++;
        console.log('[äº‘ç«¯å¿«ç…§][è¡¥ä¼ ] æˆåŠŸ', dateKey);
      } catch(e){ failed++; console.error('[äº‘ç«¯å¿«ç…§][è¡¥ä¼ ] å¤±è´¥', dateKey, e); }
    }
    // ç®€å•å¹¶å‘æ§åˆ¶
    for(let i=0;i<keys.length;i+=parallel){
      const slice = keys.slice(i,i+parallel);
      await Promise.all(slice.map(k=>uploadOne(k)));
    }
    console.info('[äº‘ç«¯å¿«ç…§][è¡¥ä¼ ] å®Œæˆ æˆåŠŸ/å¤±è´¥:', success,'/',failed);
    return {success, failed};
  };

  // å®šæ—¶å™¨ï¼šæ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å½“å¤©
  setInterval(()=>{ window.__attemptCloudPersistDailySnapshot('interval'); }, RETRY_INTERVAL_MS);
  // åˆæ¬¡å»¶è¿Ÿå¯åŠ¨ï¼ˆé¡µé¢åŠ è½½å 10 ç§’ï¼‰
  setTimeout(()=>window.__attemptCloudPersistDailySnapshot('initial'), 10*1000);

  // é¡µé¢é‡æ–°å¯è§æ—¶ä¹Ÿå°è¯•
  document.addEventListener('visibilitychange',()=>{ if(!document.hidden) window.__attemptCloudPersistDailySnapshot('visibility'); });

  // å¦‚æœ ?cloudTest=1 å¼ºåˆ¶ç«‹å³å°è¯•ï¼ˆæ— è§†æ—¶é—´çª—å£ï¼‰
  if(window.location.search.includes('cloudTest=1')){
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const dateKey = formatDate(now).replace(/\//g,'-');
    console.warn('[äº‘ç«¯å¿«ç…§] cloudTest=1 å¼ºåˆ¶å°è¯•ä¸Šä¼ ');
    // ä¸´æ—¶æ”¾å®½æ—¶é—´é™åˆ¶
    attempt(dateKey, 'cloudTest');
  }
})();

// ===== å­¦ç”Ÿç»Ÿè®¡å¿«ç…§äº‘ç«¯åŒæ­¥ =====
async function uploadStudentStatsToCloud(dateKey) {
  try {
    const endpoint = localStorage.getItem('leaderboard_cloud_endpoint')?.replace('/leaderboard', '/student-stats') || '';
    if (!endpoint) return false;
    
    const snapshots = getStudentStatsSnapshotStore();
    const dayData = snapshots[dateKey];
    if (!dayData || Object.keys(dayData).length === 0) return false;
    
    const payload = {
      date: dateKey,
      uploadAt: new Date().toISOString(),
      source: 'auto-backup',
      students: dayData
    };
    
    const token = localStorage.getItem('leaderboard_cloud_token');
    const resp = await fetch(endpoint, {
      method: 'POST',
      headers: Object.assign(
        {'Content-Type': 'application/json'},
        token ? {'Authorization': token} : {}
      ),
      body: JSON.stringify(payload)
    });
    
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    await resp.json().catch(() => ({}));
    
    console.log(`[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§][äº‘ç«¯] ä¸Šä¼ æˆåŠŸ: ${dateKey}`);
    return true;
  } catch(e) {
    console.warn(`[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§][äº‘ç«¯] ä¸Šä¼ å¤±è´¥: ${dateKey}`, e);
    return false;
  }
}

async function downloadStudentStatsFromCloud(dateKey) {
  try {
    const endpoint = localStorage.getItem('leaderboard_cloud_endpoint')?.replace('/leaderboard', '/student-stats') || '';
    if (!endpoint) return null;
    
    const url = endpoint.replace(/\/[^/]*$/, '') + '/one?date=' + encodeURIComponent(dateKey);
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), 8000);
    
    const resp = await fetch(url, {
      headers: {'Accept': 'application/json'},
      signal: ctrl.signal
    });
    
    clearTimeout(timer);
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    
    const json = await resp.json();
    if (!json || !json.students) return null;
    
    // ä¿å­˜åˆ°æœ¬åœ°
    const snapshots = getStudentStatsSnapshotStore();
    snapshots[dateKey] = json.students;
    localStorage.setItem('student_stats_snapshots', JSON.stringify(snapshots));
    
    console.log(`[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§][äº‘ç«¯] ä¸‹è½½æˆåŠŸ: ${dateKey}`);
    return json.students;
  } catch(e) {
    console.warn(`[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§][äº‘ç«¯] ä¸‹è½½å¤±è´¥: ${dateKey}`, e);
    return null;
  }
}

// æ¯å¤©è‡ªåŠ¨ä¸Šä¼ å­¦ç”Ÿç»Ÿè®¡å¿«ç…§
setInterval(() => {
  const now = new Date(window.serverNowMs ? window.serverNowMs() : Date.now());
  const hour = now.getHours();
  
  // åœ¨ 21:30-22:30 ä¹‹é—´ä¸Šä¼ å½“å¤©çš„å¿«ç…§
  if (hour >= 21 && hour < 23) {
    const dateKey = formatDate(now).replace(/\//g, '-');
    uploadStudentStatsToCloud(dateKey);
    uploadAttendanceDetailSnapshotsToCloud(dateKey); // åŒæ—¶ä¸Šä¼ è€ƒå‹¤è¯¦æƒ…å¿«ç…§
  }
}, 10 * 60 * 1000); // æ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

// ================= ç»Ÿä¸€å¿«ç…§è®¿é—®ï¼ˆäº‘ç«¯ä¼˜å…ˆï¼‰ =================
// çº¦å®šï¼šå¦‚æœé…ç½®äº† cloud endpoint ä¸”æ”¯æŒ GET /?date=YYYY-MM-DD æˆ– /all è¿”å›ç»“æ„ {snapshots:[{date,rows/fullRows,...}]}
// æä¾›è½»é‡å®ç°ï¼šå°è¯•æ‰¹é‡è·å–æœ€è¿‘ N å¤©ï¼ˆé»˜è®¤ 30ï¼‰äº‘ç«¯æ•°æ®ï¼ŒæˆåŠŸåå†™å…¥å†…å­˜ç¼“å­˜å¹¶å¯é€‰å†™å…¥ localStorageï¼ˆé¿å…åˆ·æ–°ä¸¢å¤±ï¼‰ã€‚
window.__cloudSnapshotsCache = { loaded:false, byDate:{} };
async function fetchCloudSnapshots(days=30){
  const endpoint = localStorage.getItem('leaderboard_cloud_endpoint')||'';
  if(!endpoint) return false;
  try {
    const url = endpoint.replace(/\/[^/]*$/,'') + '/recent?days='+days; // å‡è®¾åç«¯æ”¯æŒ /recent?days=
    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), 8000);
    const resp = await fetch(url,{headers:{'Accept':'application/json'},signal:ctrl.signal});
    clearTimeout(timer);
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const json = await resp.json();
    if(!json || !Array.isArray(json.snapshots)) return false;
    const map={};
    for(const s of json.snapshots){
      if(!s.date) continue;
      map[s.date]= {
        date:s.date,
        timestamp: s.timestamp || Date.now(),
        data: (s.rows||[]).map(r=>({name:r.name||r.n,total:r.total,dim1:{score:r.dim1||r.d1},dim2:{score:r.dim2||r.d2},dim3:{score:r.dim3||r.d3}})).slice(0,20),
        full: (s.fullRows||s.rows||[]).map(r=>({n:r.name||r.n,t:r.total,d1:r.d1||r.dim1,d2:r.d2||r.dim2,d3:r.d3||r.dim3})),
        totalCount: s.totalCount || (s.fullRows?s.fullRows.length:(s.rows?s.rows.length:0)),
        meta:{source:s.source||'cloud-import',final: !!s.final,version:1,fromCloud:true}
      };
    }
    window.__cloudSnapshotsCache.byDate = map;
    window.__cloudSnapshotsCache.loaded = true;
    window.__cloudSnapshotsCache.loadedAt = Date.now();
    console.info('[äº‘ç«¯å¿«ç…§] å·²åŠ è½½äº‘ç«¯å†å²', Object.keys(map).length);
    return true;
  } catch(e){ console.warn('[äº‘ç«¯å¿«ç…§] è·å–å¤±è´¥', e); return false; }
}

function getUnifiedSnapshotsStore(){
  // ä¼˜å…ˆäº‘ç«¯ç¼“å­˜
  if(window.__cloudSnapshotsCache && window.__cloudSnapshotsCache.loaded){
    return window.__cloudSnapshotsCache.byDate;
  }
  try { return JSON.parse(localStorage.getItem('leaderboard_history')||'{}'); } catch { return {}; }
}

// ===== å­¦ç”Ÿç»Ÿè®¡å¿«ç…§ç³»ç»Ÿ =====
// ä¿å­˜å­¦ç”Ÿ7å¤©è€ƒå‹¤å’Œç»ƒç´ç»Ÿè®¡çš„å¿«ç…§ï¼Œé¿å…é‡å¤è®¡ç®—
function getStudentStatsSnapshotStore(){
  try { return JSON.parse(localStorage.getItem('student_stats_snapshots')||'{}'); } catch { return {}; }
}

function saveStudentStatsSnapshot(studentName, date, attendanceHistory, practiceStats){
  try {
    const snapshots = getStudentStatsSnapshotStore();
    const dateKey = typeof date === 'string' ? date : formatDate(date).replace(/\//g, '-');
    
    if(!snapshots[dateKey]) snapshots[dateKey] = {};
    
    snapshots[dateKey][studentName] = {
      attendance: attendanceHistory,
      practice: practiceStats,
      updatedAt: new Date().toISOString(),
      version: 1
    };
    
    localStorage.setItem('student_stats_snapshots', JSON.stringify(snapshots));
    console.log(`[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§] ä¿å­˜æˆåŠŸ: ${studentName} - ${dateKey}`);
  } catch(e) {
    console.warn('[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§] ä¿å­˜å¤±è´¥:', e);
  }
}

function getStudentStatsSnapshot(studentName, date){
  try {
    const snapshots = getStudentStatsSnapshotStore();
    const dateKey = typeof date === 'string' ? date : formatDate(date).replace(/\//g, '-');
    
    return snapshots[dateKey] && snapshots[dateKey][studentName] || null;
  } catch(e) {
    console.warn('[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§] è·å–å¤±è´¥:', e);
    return null;
  }
}

function cleanOldStudentStatsSnapshots(keepDays = 30){
  try {
    const snapshots = getStudentStatsSnapshotStore();
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - keepDays);
    const cutoffKey = formatDate(cutoffDate).replace(/\//g, '-');
    
    let cleanedCount = 0;
    Object.keys(snapshots).forEach(dateKey => {
      if(dateKey < cutoffKey) {
        delete snapshots[dateKey];
        cleanedCount++;
      }
    });
    
    if(cleanedCount > 0) {
      localStorage.setItem('student_stats_snapshots', JSON.stringify(snapshots));
      console.log(`[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§] æ¸…ç†è¿‡æœŸå¿«ç…§: ${cleanedCount} å¤©`);
    }
  } catch(e) {
    console.warn('[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§] æ¸…ç†å¤±è´¥:', e);
  }
}

// ===== è€ƒå‹¤è¯¦æƒ…å¿«ç…§ç³»ç»Ÿ =====
// ä¿å­˜å­¦ç”Ÿæ¯æ—¥è¯¦ç»†è€ƒå‹¤è®°å½•ï¼ŒåŒ…æ‹¬æ—¶é—´æ®µã€çŠ¶æ€ã€ç»ƒç´æ—¶é•¿ã€ç´æˆ¿ç­‰ä¿¡æ¯
function getAttendanceDetailSnapshotStore(){
  try { return JSON.parse(localStorage.getItem('attendance_detail_snapshots')||'{}'); } catch { return {}; }
}

function saveAttendanceDetailSnapshot(studentName, date, detailInfo){
  try {
    const snapshots = getAttendanceDetailSnapshotStore();
    const dateKey = typeof date === 'string' ? date : formatDate(date).replace(/\//g, '-');
    
    if(!snapshots[dateKey]) snapshots[dateKey] = {};
    
    snapshots[dateKey][studentName] = {
      detail: detailInfo,
      updatedAt: new Date().toISOString(),
      version: 1
    };
    
    localStorage.setItem('attendance_detail_snapshots', JSON.stringify(snapshots));
    console.log(`[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] ä¿å­˜æˆåŠŸ: ${studentName} - ${dateKey}`);
  } catch(e) {
    console.warn('[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] ä¿å­˜å¤±è´¥:', e);
  }
}

function getAttendanceDetailSnapshot(studentName, date){
  try {
    const snapshots = getAttendanceDetailSnapshotStore();
    const dateKey = typeof date === 'string' ? date : formatDate(date).replace(/\//g, '-');
    
    return snapshots[dateKey] && snapshots[dateKey][studentName] || null;
  } catch(e) {
    console.warn('[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] è·å–å¤±è´¥:', e);
    return null;
  }
}

function cleanOldAttendanceDetailSnapshots(keepDays = 30){
  try {
    const snapshots = getAttendanceDetailSnapshotStore();
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - keepDays);
    const cutoffKey = formatDate(cutoffDate).replace(/\//g, '-');
    
    let cleanedCount = 0;
    Object.keys(snapshots).forEach(dateKey => {
      if(dateKey < cutoffKey) {
        delete snapshots[dateKey];
        cleanedCount++;
      }
    });
    
    if(cleanedCount > 0) {
      localStorage.setItem('attendance_detail_snapshots', JSON.stringify(snapshots));
      console.log(`[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] æ¸…ç†è¿‡æœŸå¿«ç…§: ${cleanedCount} å¤©`);
    }
  } catch(e) {
    console.warn('[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] æ¸…ç†å¤±è´¥:', e);
  }
}

// ä¸Šä¼ è€ƒå‹¤è¯¦æƒ…å¿«ç…§åˆ°äº‘ç«¯
function uploadAttendanceDetailSnapshotsToCloud(dateKey) {
  if(!dateKey) return Promise.resolve();
  
  const snapshots = getAttendanceDetailSnapshotStore();
  const dateData = snapshots[dateKey];
  
  if(!dateData || Object.keys(dateData).length === 0) {
    return Promise.resolve();
  }
  
  return firebase.database().ref(`attendance_detail_snapshots/${dateKey}`).set(dateData)
    .then(() => {
      console.log(`[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] äº‘ç«¯ä¸Šä¼ æˆåŠŸ: ${dateKey}`);
    })
    .catch(error => {
      console.error(`[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] äº‘ç«¯ä¸Šä¼ å¤±è´¥: ${dateKey}`, error);
    });
}

// ä»äº‘ç«¯ä¸‹è½½è€ƒå‹¤è¯¦æƒ…å¿«ç…§
function downloadAttendanceDetailSnapshotsFromCloud(dateKey) {
  if(!dateKey) return Promise.resolve(null);
  
  return firebase.database().ref(`attendance_detail_snapshots/${dateKey}`).once('value')
    .then(snapshot => {
      const cloudData = snapshot.val();
      if (cloudData) {
        const localSnapshots = getAttendanceDetailSnapshotStore();
        localSnapshots[dateKey] = cloudData;
        
        localStorage.setItem('attendance_detail_snapshots', JSON.stringify(localSnapshots));
        console.log(`[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] äº‘ç«¯ä¸‹è½½æˆåŠŸ: ${dateKey}`);
        return cloudData;
      }
      return null;
    })
    .catch(error => {
      console.error(`[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] äº‘ç«¯ä¸‹è½½å¤±è´¥: ${dateKey}`, error);
      return null;
    });
}

// å¯åŠ¨æ—¶å°è¯•è·å–äº‘ç«¯å†å²ï¼ˆä¸é˜»å¡ UIï¼‰ï¼ŒæˆåŠŸåè§¦å‘ä¸€æ¬¡åŸºäºäº‘ç«¯çš„é‡ç®—æå‡ç»´åº¦3å‡†ç¡®æ€§
// ====== äº‘ç«¯å†å²åŠ è½½ï¼šæŒ‡æ•°é€€é¿ + çŠ¶æ€å¾½æ ‡ + ç¼ºå¤±è¡¥ä¼  ======
;(function(){
  // å¾½æ ‡ DOM & æ ·å¼
  function ensureCloudBadge(){
    if(document.getElementById('cloud-history-badge')) return;
    const style=document.createElement('style');
    style.textContent=`#cloud-history-badge{position:fixed;bottom:10px;right:10px;z-index:9999;font-size:11px;font-family:system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(135deg,#1e3a8a,#2563eb);color:#fff;padding:6px 10px;border-radius:20px;display:none;align-items:center;gap:6px;box-shadow:0 4px 14px -4px rgba(0,0,0,.4);cursor:default;opacity:.9;transition:.3s;}body.show-history-leaderboard #cloud-history-badge{display:flex;}#cloud-history-badge.offline{background:linear-gradient(135deg,#334155,#475569);}#cloud-history-badge.warn{background:linear-gradient(135deg,#92400e,#ea580c);}#cloud-history-badge.ok{background:linear-gradient(135deg,#065f46,#059669);}#cloud-history-badge.loading{background:linear-gradient(135deg,#312e81,#4338ca);animation:cloudPulse 1.2s ease-in-out infinite alternate;}#cloud-history-badge:hover{opacity:1;transform:translateY(-2px);}#cloud-history-badge .dot{width:8px;height:8px;border-radius:50%;background:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.25);}#cloud-history-badge small{font-size:10px;opacity:.85;}@keyframes cloudPulse{from{filter:brightness(.9);}to{filter:brightness(1.15);}}`;
    document.head.appendChild(style);
    const div=document.createElement('div');
    div.id='cloud-history-badge';
    div.innerHTML='<span class="dot"></span><span class="txt">å†å²æº: æœ¬åœ°</span>';
    document.body.appendChild(div);
  }
  // å¯¹å¤–æä¾›å¼€å…³
  window.toggleCloudBadge=function(show){
    if(show) document.body.classList.add('show-history-leaderboard'); else document.body.classList.remove('show-history-leaderboard');
  }
  function updateCloudHistoryBadge(state){
    ensureCloudBadge();
    const el=document.getElementById('cloud-history-badge');
    if(!el) return;
    const map={loading:'loading',ok:'ok',fallback:'offline',error:'warn'};
    el.className=''; el.classList.add(map[state.status]||'offline');
    const txtEl=el.querySelector('.txt');
    const desc = state.desc || '';
    txtEl.textContent = 'å†å²æº: '+state.source + (desc?(' Â· '+desc):'');
    el.title = state.tooltip||'';
  }
  window.__updateCloudHistoryBadge = updateCloudHistoryBadge;

  let retryAttempt=0; const MAX_ATTEMPTS=6; // ~ 1+2+4+8+16+32=63s plus fetch time
  async function fetchCloudSnapshotsWithRetry(){
    const endpoint = localStorage.getItem('leaderboard_cloud_endpoint')||'';
    if(!endpoint){ updateCloudHistoryBadge({status:'fallback',source:'æœ¬åœ°',desc:'æœªé…ç½®'}); return false; }
    updateCloudHistoryBadge({status:'loading',source:'äº‘ç«¯',desc:'å°è¯•#'+(retryAttempt+1)});
    const ok = await fetchCloudSnapshots(30);
    if(ok){
      updateCloudHistoryBadge({status:'ok',source:'äº‘ç«¯',desc:'å·²åŒæ­¥',tooltip:'äº‘ç«¯å†å²å·²è½½å…¥'});
      unifyAndBackfill();
      try { if(leaderboardState && leaderboardState.raw) computeLeaderboard('cloudRefresh'); } catch(e){ console.warn('[äº‘ç«¯å¿«ç…§] é‡ç®—å¤±è´¥', e); }
      return true;
    }
    retryAttempt++;
    if(retryAttempt>=MAX_ATTEMPTS){
      updateCloudHistoryBadge({status:'error',source:'æœ¬åœ°',desc:'å¤±è´¥è½¬æœ¬åœ°',tooltip:'äº‘ç«¯è·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜'});
      return false;
    }
    const delay = Math.min(32000, 1000 * Math.pow(2,retryAttempt-1));
    updateCloudHistoryBadge({status:'loading',source:'äº‘ç«¯',desc:'é‡è¯• in '+Math.round(delay/1000)+'s'});
    setTimeout(fetchCloudSnapshotsWithRetry, delay);
  }

  // ç¼ºå¤±æ—¥æœŸè‡ªåŠ¨è¡¥ä¼ ï¼šäº‘ç«¯ç¼º -> ä»æœ¬åœ° full ä¸Šä¼ 
  async function unifyAndBackfill(){
    try{
      const endpoint = localStorage.getItem('leaderboard_cloud_endpoint')||''; if(!endpoint) return;
      const snapsLocal = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      const cloudMap = window.__cloudSnapshotsCache.byDate||{};
      const localKeys = Object.keys(snapsLocal);
      const cloudKeys = Object.keys(cloudMap);
      const missing = localKeys.filter(k=>!cloudKeys.includes(k));
      if(!missing.length) return;
      console.info('[äº‘ç«¯å¿«ç…§][è¡¥å·®] äº‘ç«¯ç¼ºå°‘æ—¥æœŸ:', missing);
      const token = localStorage.getItem('leaderboard_cloud_token');
      for(const k of missing){
        const snap = snapsLocal[k]; if(!snap||!snap.full) continue;
        const payload = {date:k,uploadAt:new Date().toISOString(),source:'backfill-local',totalCount:snap.totalCount,final:!!(snap.meta&&snap.meta.final),rows:snap.data.map(r=>({name:r.name||r.n,total:r.total,dim1:r.dim1?r.dim1.score:r.d1,dim2:r.dim2?r.dim2.score:r.d2,dim3:r.dim3?r.dim3.score:r.d3})),fullRows:snap.full.map(r=>({name:r.name||r.n,total:r.t||r.total,d1:r.d1||r.dim1,d2:r.d2||r.dim2,d3:r.d3||r.dim3}))};
        try{
          const resp = await fetch(endpoint,{method:'POST',headers:Object.assign({'Content-Type':'application/json'},token?{'Authorization':token}:{}),body:JSON.stringify(payload)});
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          await resp.json().catch(()=>({}));
          console.log('[äº‘ç«¯å¿«ç…§][è¡¥å·®] ä¸Šä¼ æˆåŠŸ', k);
        }catch(e){ console.warn('[äº‘ç«¯å¿«ç…§][è¡¥å·®] ä¸Šä¼ å¤±è´¥', k, e); }
      }
    }catch(e){ console.warn('[äº‘ç«¯å¿«ç…§][è¡¥å·®] å¼‚å¸¸', e); }
  }

  // åˆå§‹åŒ–
  ensureCloudBadge();
  fetchCloudSnapshotsWithRetry();
})();

// äº‘ç«¯ä¼˜å…ˆå†å²æ’è¡Œæ¦œ
async function fetchCloudSnapshotByDate(dateKey){
  try{
    const endpoint = localStorage.getItem('leaderboard_cloud_endpoint')||''; if(!endpoint) return null;
    const url = endpoint.replace(/\/[^/]*$/,'') + '/one?date='+encodeURIComponent(dateKey);
    const ctrl=new AbortController(); const timer=setTimeout(()=>ctrl.abort(),8000);
    const resp = await fetch(url,{headers:{'Accept':'application/json'},signal:ctrl.signal});
    clearTimeout(timer);
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const json = await resp.json();
    if(!json || !json.snapshot) return null;
    const s=json.snapshot;
    const mapped={
      date:s.date,
      timestamp: s.timestamp || Date.now(),
      data: (s.rows||[]).map(r=>({name:r.name||r.n,total:r.total,dim1:{score:r.dim1||r.d1},dim2:{score:r.dim2||r.d2},dim3:{score:r.dim3||r.d3}})).slice(0,20),
      full: (s.fullRows||s.rows||[]).map(r=>({n:r.name||r.n,t:r.total,d1:r.d1||r.dim1,d2:r.d2||r.dim2,d3:r.d3||r.dim3})),
      totalCount: s.totalCount || (s.fullRows?s.fullRows.length:(s.rows?s.rows.length:0)),
      meta:{source:s.source||'cloud-import',final:!!s.final,version:1,fromCloud:true}
    };
    // ç¼“å­˜åˆ°äº‘ç«¯ç¼“å­˜ç»“æ„
    if(!window.__cloudSnapshotsCache) window.__cloudSnapshotsCache={loaded:true,byDate:{}};
    window.__cloudSnapshotsCache.byDate[s.date]=mapped; window.__cloudSnapshotsCache.loaded=true;
    return mapped;
  }catch(e){ console.warn('[å†å²æ’è¡Œæ¦œ][å•æ—¥äº‘ç«¯] å¤±è´¥', dateKey, e); return null; }
}

function showHistoryLeaderboard(){
  // æ‰“å¼€å†å²æ¦œæ—¶æ˜¾ç¤ºå¾½æ ‡
  window.toggleCloudBadge&&window.toggleCloudBadge(true);
  try{
    const unified = getUnifiedSnapshotsStore();
    const localRaw = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const expectedDate = now.getHours()<8 ? formatDate(new Date(now.getTime()-86400000)).replace(/\//g,'-') : formatDate(now).replace(/\//g,'-');
    let dates = Array.from(new Set(Object.keys(unified).concat(Object.keys(localRaw)))).sort().reverse();
    if(!dates.length){ alert('æš‚æ— å†å²æ’è¡Œæ¦œè®°å½•'); return; }
    const hasExpectedDate = dates.includes(expectedDate);
    const defaultDate = hasExpectedDate?expectedDate:dates[0];
    let content = `<div style="margin-bottom:16px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <label for="history-date-select" class="history-modal-label">é€‰æ‹©æ—¥æœŸï¼š</label>
      ${now.getHours()<8?'<small style="color:#666;">(å‡Œæ™¨é»˜è®¤æ˜¨æ—¥)</small>':''}
      <select id="history-date-select" class="history-date-select"></select>
      <span id="history-source-ind" style="font-size:11px;color:var(--text-secondary);"></span>
    </div>
    <div id="history-leaderboard-content" style="max-height:400px;overflow-y:auto;">
      <div style="padding:30px;text-align:center;color:var(--text-secondary);">åŠ è½½ä¸­...</div>
    </div>`;
    const modal = createCenterModal(content,'ğŸ“… å†å²æ’è¡Œæ¦œ');
    if(!modal) return;
    
    // åœ¨æ¨¡æ€æ¡†å…³é—­æ—¶éšè—å¾½æ ‡
    const overlay = modal.closest('.center-pop-modal-overlay');
    const originalRemove = overlay.remove;
    overlay.remove = function() {
      window.toggleCloudBadge && window.toggleCloudBadge(false);
      originalRemove.call(this);
    };
    
    const select=modal.querySelector('#history-date-select');
    const contentDiv=modal.querySelector('#history-leaderboard-content');
    const ind=modal.querySelector('#history-source-ind');
    function refreshOptions(){
      select.innerHTML='';
      dates.forEach(d=>{
        const s= unified[d]||localRaw[d];
        if(!s) return;
        const labDate = new Date(s.timestamp).toLocaleDateString('zh-CN',{month:'short',day:'numeric',weekday:'short'});
        const src = s.meta && s.meta.fromCloud ? 'äº‘' : 'æœ¬';
        const opt=document.createElement('option');
        opt.value=d; opt.textContent=`${labDate} (${s.totalCount||s.data.length||0}äºº) [${src}]`;
        if(d===defaultDate) opt.selected=true;
        select.appendChild(opt);
      });
    }
    refreshOptions();
    async function render(dateKey){
      let snap = unified[dateKey] || localRaw[dateKey];
      if(!snap){
        contentDiv.innerHTML='<div style="padding:20px;text-align:center;color:#666;">å°è¯•ä»äº‘ç«¯è·å–...</div>';
        const cloud = await fetchCloudSnapshotByDate(dateKey);
        if(cloud){ snap=cloud; unified[dateKey]=cloud; dates=Array.from(new Set(dates.concat([dateKey]))).sort().reverse(); refreshOptions(); }
      }
      if(!snap){ contentDiv.innerHTML='<div style="padding:20px;text-align:center;color:#e67e22;">æœªæ‰¾åˆ°æ•°æ®</div>'; return; }
      ind.textContent = snap.meta && snap.meta.fromCloud ? 'æ¥æº: äº‘ç«¯' : 'æ¥æº: æœ¬åœ°ç¼“å­˜';
      if(!snap.data||!Array.isArray(snap.data)){ contentDiv.innerHTML='<div style="padding:20px;text-align:center;color:#999;">æ•°æ®ä¸å®Œæ•´</div>'; return; }
      let html=`<table class="history-table"><thead><tr><th style="width:50px;">æ’å</th><th>å§“å</th><th style="width:80px;">æ€»åˆ†</th><th style="width:70px;">ç»´åº¦1</th><th style="width:70px;">ç»´åº¦2</th><th style="width:70px;">ç»´åº¦3</th></tr></thead><tbody>`;
      snap.data.forEach((row,i)=>{ const rank=i+1; const name=row.name||'æœªçŸ¥'; const total=(row.total??0).toFixed(2); const d1=row.dim1&&typeof row.dim1.score==='number'?row.dim1.score.toFixed(1):'0.0'; const d2=row.dim2&&typeof row.dim2.score==='number'?row.dim2.score.toFixed(1):'0.0'; const d3=row.dim3&&typeof row.dim3.score==='number'?row.dim3.score.toFixed(1):'0.0'; const rc=rank===1?'rank-1':rank===2?'rank-2':rank===3?'rank-3':''; html+=`<tr class="${rc}"><td style="text-align:center;font-weight:600;">${rank}</td><td style="padding-left:12px;">${escapeHtml(name)}</td><td style="text-align:center;font-weight:600;">${total}</td><td style="text-align:center;">${d1}</td><td style="text-align:center;">${d2}</td><td style="text-align:center;">${d3}</td></tr>`; });
      html+='</tbody></table>';
      contentDiv.innerHTML=html;
    }
    render(defaultDate);
    select.addEventListener('change',()=>{render(select.value);});
  }catch(e){ console.error('[å†å²æ’è¡Œæ¦œ] æ˜¾ç¤ºå¤±è´¥', e); alert('å†å²æ’è¡Œæ¦œæ˜¾ç¤ºå¤±è´¥:'+e.message); }
}

// è°ƒåº¦ï¼šå¯åœ¨ç›¸å…³æ•°æ® ready åè°ƒç”¨ init + é¦–æ¬¡ compute
window.addEventListener('DOMContentLoaded',()=>{initLeaderboardEvents();});

// === æœåŠ¡å™¨æ—¶é—´åŒæ­¥ & ç»ˆå±€å¿«ç…§è°ƒåº¦ ===
(function initTimeAndFinalSnapshot(){
  window.__serverTimeOffsetMs = Number(localStorage.getItem('leaderboard_time_offset_ms')||0);
  window.serverNowMs = ()=> Date.now() + (window.__serverTimeOffsetMs||0);
  async function syncServerTime(){
    try {
      const t0=Date.now();
      const resp = await fetch('https://worldtimeapi.org/api/ip',{cache:'no-store'});
      const json = await resp.json();
      if(json && json.unixtime){
        const serverMs = json.unixtime*1000;
        const rtt = (Date.now()-t0)/2;
        const offset = (serverMs + rtt) - Date.now();
        window.__serverTimeOffsetMs = offset;
        localStorage.setItem('leaderboard_time_offset_ms', String(offset));
        console.log('[æ—¶é—´åŒæ­¥] offset(ms)=', offset);
      }
    } catch(e){ console.warn('[æ—¶é—´åŒæ­¥] å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ—¶é—´', e); }
  }
  syncServerTime();
  setInterval(syncServerTime, 10*60*1000);
  function hasFinalSnapshot(){
    try {
      const snapshots = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      const now = new Date(window.serverNowMs());
      const dk = formatDate(now).replace(/\//g,'-');
      const s = snapshots[dk];
      return !!(s && s.meta && /^final/.test(s.meta.source));
    } catch { return false; }
  }
  function attemptFinalSnapshot(reason){
    const now = new Date(window.serverNowMs());
    const freezeMin = getTodayFreezeMinutes(now);
    const h = now.getHours();
    const m = now.getMinutes();
    const curMin = h*60+m;
    if(curMin >= freezeMin + 2){ // å†»ç»“å +2 åˆ†é’Ÿç”Ÿæˆç»ˆå±€å¿«ç…§
      if(hasFinalSnapshot()) return;
      console.log('[ç»ˆå±€å¿«ç…§] å°è¯•ç”Ÿæˆ (åŸå› :'+reason+')');
      window.__snapshotSourceOverride='final-freeze';
      window.__skipSnapshotOnce=false;
      computeLeaderboard();
    }
  }
  setInterval(()=>attemptFinalSnapshot('interval'), 60*1000);
  document.addEventListener('visibilitychange',()=>{ if(!document.hidden) attemptFinalSnapshot('visibility'); });
  setTimeout(()=>attemptFinalSnapshot('initial'), 15000);

  // ================= æ™¨é—´å†å²è¡¥å†™ï¼šä¿è¯æ˜¨å¤©ç»“æœ 08:00 å‰å¯è§ =================
  function morningHistoryEnsure(){
    try {
      const now = new Date(window.serverNowMs());
      if(now.getHours()>=8) return; // ä»… 08:00 å‰æ‰§è¡Œ
      if(window.__morningHistoryEnsured) return; // é˜²é‡å…¥
      window.__morningHistoryEnsured=true;
      const yesterday = new Date(now.getTime()-24*60*60*1000);
      const yKey = formatDate(yesterday).replace(/\//g,'-');
      const snaps = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      const ySnap = snaps[yKey];
      if(ySnap && ySnap.meta && ySnap.meta.rowsHash){
        console.info('[æ™¨é—´å†å²] æ˜¨æ—¥å·²æœ‰å¿«ç…§', ySnap.meta.source);
        return;
      }
      console.warn('[æ™¨é—´å†å²] ç¼ºå¤±æ˜¨æ—¥å¿«ç…§ï¼Œå¼€å§‹é‡å»º', yKey);
      // è®¡ç®—æ˜¨æ—¥æ’è¡Œæ¦œ
      window.__computeDateOverride = yKey;
      window.__skipSnapshotOnce = true; // é¿å…åœ¨ compute å†…è¯¯ä¿å­˜åˆ°ä»Šå¤©é”®
      computeLeaderboard();
      delete window.__computeDateOverride;
      const rows = (leaderboardState.raw||[]);
      if(rows.length){
        window.__snapshotSourceOverride = 'morning-history-fix';
        saveLeaderboardSnapshot(rows); // å†™å…¥æ˜¨å¤©é”®
        console.info('[æ™¨é—´å†å²] å·²è¡¥å†™æ˜¨æ—¥å¿«ç…§');
      } else {
        console.error('[æ™¨é—´å†å²] é‡å»ºå¤±è´¥ï¼Œæ—  rows');
      }
    } catch(e){ console.error('[æ™¨é—´å†å²] å¼‚å¸¸', e); }
  }
  setTimeout(morningHistoryEnsure, 5000); // é¡µé¢åŠ è½½åçŸ­å»¶è¿Ÿ
  // æ¯ 2 åˆ†é’Ÿå†å°è¯•ä¸€æ¬¡ç›´åˆ° >=08:00
  const morningTimer = setInterval(()=>{ const h=new Date(window.serverNowMs()).getHours(); if(h>=8){clearInterval(morningTimer);} else morningHistoryEnsure(); }, 2*60*1000);

  // ================= å†»ç»“åå»¶è¿Ÿç»ˆå±€è¡¥å†™ï¼šé˜²æ­¢é¡µé¢æœªå¼€å¯¼è‡´ final ç¼ºå¤± =================
  function lateFinalSnapshotFix(){
    try {
      const now = new Date(window.serverNowMs());
      const freezeMin = getTodayFreezeMinutes(now);
      const curMin = now.getHours()*60 + now.getMinutes();
      if(curMin < freezeMin + 15) return; // å†»ç»“ +15 ä»¥åæ‰æ£€æŸ¥
      const dk = formatDate(now).replace(/\//g,'-');
      const snaps = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      const s = snaps[dk];
      if(s && s.meta && /^final/.test(s.meta.source)) return; // å·²æœ‰ç»ˆå±€
      if(window.__lateFinalFixed) return;
      window.__lateFinalFixed=true;
      console.warn('[ç»ˆå±€è¡¥å†™] ç¼ºå¤± finalï¼Œå°è¯•è¡¥å†™');
      window.__snapshotSourceOverride='final-late-fix';
      window.__skipSnapshotOnce=false;
      computeLeaderboard();
    } catch(e){ console.error('[ç»ˆå±€è¡¥å†™] å¼‚å¸¸', e); }
  }
  setInterval(lateFinalSnapshotFix, 5*60*1000); // æ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
})();

// å¯¹æ¯”å·¥å…·
function compareSnapshotWithCurrent(dateKey){
  try {
    const snapshots=JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
    const snap=snapshots[dateKey];
    if(!snap){ console.warn('[å¯¹æ¯”] æ— å¿«ç…§', dateKey); return; }
    window.__skipSnapshotOnce=true;
    computeLeaderboard();
    const current=(leaderboardState.raw||[]).slice(0,snap.data.length);
    const diffs=[];const mapNow=new Map(current.map(r=>[r.name,r]));const mapSnap=new Map(snap.data.map(r=>[r.name,r]));
    snap.data.forEach(r=>{const live=mapNow.get(r.name);if(!live) diffs.push({name:r.name,type:'missingNow',snapTotal:r.total}); else {const delta=+(live.total-r.total).toFixed(2); if(Math.abs(delta)>0.009) diffs.push({name:r.name,type:'scoreChanged',snapTotal:r.total,nowTotal:live.total,delta});}});
    current.forEach(r=>{ if(!mapSnap.has(r.name)) diffs.push({name:r.name,type:'newInCurrent',nowTotal:r.total}); });
    console.group('[å¯¹æ¯”ç»“æœ]',dateKey);console.table(diffs);console.groupEnd();
    return diffs;
  }catch(e){console.error('[å¯¹æ¯”] å¤±è´¥',e);}
}

// ğŸ”§ æ–°å¢ï¼šå†å²æ’è¡Œæ¦œæ•°æ®è¯Šæ–­å·¥å…·
function debugLeaderboardHistory() {
  console.log('ğŸ” å†å²æ’è¡Œæ¦œæ•°æ®è¯Šæ–­ï¼š');
  console.log('=====================================');
  
  try {
    const snapshots = JSON.parse(localStorage.getItem('leaderboard_history') || '{}');
    const dates = Object.keys(snapshots);
    
    console.log(`ğŸ“Š å†å²è®°å½•æ€»æ•°ï¼š${dates.length}`);
    
    if (dates.length === 0) {
      console.log('âŒ æ²¡æœ‰æ‰¾åˆ°å†å²æ’è¡Œæ¦œæ•°æ®');
      return;
    }
    
    dates.sort().forEach(date => {
      const snapshot = snapshots[date];
      console.log(`\nğŸ“… æ—¥æœŸï¼š${date}`);
      
      // æ£€æŸ¥åŸºç¡€ç»“æ„
      console.log(`   âœ… æ—¶é—´æˆ³ï¼š${snapshot.timestamp ? new Date(snapshot.timestamp).toLocaleString() : 'âŒ ç¼ºå¤±'}`);
      console.log(`   âœ… æ€»äººæ•°ï¼š${snapshot.totalCount || 'âŒ ç¼ºå¤±'}`);
      console.log(`   âœ… æµ‹è¯•æ•°æ®ï¼š${snapshot.isTestData ? 'æ˜¯' : 'å¦'}`);
      
      // æ£€æŸ¥æ•°æ®ç»“æ„
      if (!snapshot.data) {
        console.log('   âŒ æ•°æ®ç¼ºå¤±ï¼šdata å­—æ®µä¸å­˜åœ¨');
      } else if (!Array.isArray(snapshot.data)) {
        console.log('   âŒ æ•°æ®æ ¼å¼é”™è¯¯ï¼šdata ä¸æ˜¯æ•°ç»„');
      } else {
        console.log(`   âœ… æ•°æ®æ¡æ•°ï¼š${snapshot.data.length}`);
        
        // æ£€æŸ¥å‰å‡ æ¡æ•°æ®çš„ç»“æ„
        const sampleSize = Math.min(3, snapshot.data.length);
        for (let i = 0; i < sampleSize; i++) {
          const row = snapshot.data[i];
          console.log(`     æ ·æœ¬ ${i + 1}:`);
          console.log(`       å§“åï¼š${row.name || 'âŒ ç¼ºå¤±'}`);
          console.log(`       æ€»åˆ†ï¼š${row.total !== undefined ? row.total : 'âŒ ç¼ºå¤±'}`);
          console.log(`       ç»´åº¦1ï¼š${row.dim1 && typeof row.dim1.score === 'number' ? row.dim1.score.toFixed(1) : 'âŒ ç¼ºå¤±æˆ–æ ¼å¼é”™è¯¯'}`);
          console.log(`       ç»´åº¦2ï¼š${row.dim2 && typeof row.dim2.score === 'number' ? row.dim2.score.toFixed(1) : 'âŒ ç¼ºå¤±æˆ–æ ¼å¼é”™è¯¯'}`);
          console.log(`       ç»´åº¦3ï¼š${row.dim3 && typeof row.dim3.score === 'number' ? row.dim3.score.toFixed(1) : 'âŒ ç¼ºå¤±æˆ–æ ¼å¼é”™è¯¯'}`);
        }
      }
    });
    
  } catch (e) {
    console.error('âŒ è¯Šæ–­è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š', e);
  }
  
  console.log('=====================================');
  console.log('ğŸ’¡ å¦‚éœ€æ¸…ç†æŸåçš„æ•°æ®ï¼Œè¯·è¿è¡Œï¼šcleanupLeaderboardHistory()');
}

// ğŸ”§ æ–°å¢ï¼šæ¸…ç†æŸåçš„å†å²æ’è¡Œæ¦œæ•°æ®
function cleanupLeaderboardHistory() {
  try {
    const snapshots = JSON.parse(localStorage.getItem('leaderboard_history') || '{}');
    const dates = Object.keys(snapshots);
    let cleaned = 0;
    let total = dates.length;
    
    console.log('ğŸ§¹ å¼€å§‹æ¸…ç†å†å²æ’è¡Œæ¦œæ•°æ®...');
    
    dates.forEach(date => {
      const snapshot = snapshots[date];
      
      // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
      if (!snapshot.data || !Array.isArray(snapshot.data) || !snapshot.timestamp) {
        console.log(`ğŸ—‘ï¸ åˆ é™¤æŸåçš„æ•°æ®ï¼š${date}`);
        delete snapshots[date];
        cleaned++;
        return;
      }
      
      // æ£€æŸ¥æ•°æ®é¡¹çš„å®Œæ•´æ€§
      const validData = snapshot.data.filter(row => {
        return row.name && 
               row.total !== undefined && 
               row.dim1 && typeof row.dim1.score === 'number' &&
               row.dim2 && typeof row.dim2.score === 'number' &&
               row.dim3 && typeof row.dim3.score === 'number';
      });
      
      if (validData.length !== snapshot.data.length) {
        console.log(`ğŸ”§ ä¿®å¤ ${date}ï¼šä» ${snapshot.data.length} æ¡ä¿®å¤ä¸º ${validData.length} æ¡`);
        snapshot.data = validData;
        snapshot.totalCount = validData.length;
      }
    });
    
    localStorage.setItem('leaderboard_history', JSON.stringify(snapshots));
    
    console.log(`âœ… æ¸…ç†å®Œæˆï¼šåˆ é™¤ ${cleaned} ä¸ªæŸåæ•°æ®ï¼Œå‰©ä½™ ${total - cleaned} ä¸ªæœ‰æ•ˆæ•°æ®`);
    
    if (cleaned > 0) {
      alert(`å·²æ¸…ç† ${cleaned} ä¸ªæŸåçš„å†å²è®°å½•ï¼Œå‰©ä½™ ${total - cleaned} ä¸ªæœ‰æ•ˆè®°å½•`);
    } else {
      alert('æ‰€æœ‰å†å²è®°å½•éƒ½æ˜¯å®Œæ•´çš„ï¼Œæ— éœ€æ¸…ç†');
    }
    
  } catch (e) {
    console.error('æ¸…ç†å¤±è´¥ï¼š', e);
    alert('æ¸…ç†å†å²æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
  }
}

// ğŸ”§ æ–°å¢ï¼šæµ‹è¯•æ¨¡æ€æ¡†åŠŸèƒ½
function testModal() {
  try {
    console.log('ğŸ§ª æµ‹è¯•æ¨¡æ€æ¡†åŠŸèƒ½...');
    
    const testContent = `
      <div style="padding: 20px; text-align: center;">
        <p>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¨¡æ€æ¡†</p>
        <p>å¦‚æœæ‚¨èƒ½çœ‹åˆ°è¿™ä¸ªå†…å®¹ï¼Œè¯´æ˜æ¨¡æ€æ¡†åŠŸèƒ½æ­£å¸¸</p>
        <button id="test-button" style="padding: 8px 16px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
          æµ‹è¯•æŒ‰é’®
        </button>
      </div>
    `;
    
    const modal = createCenterModal(testContent, 'ğŸ§ª æ¨¡æ€æ¡†æµ‹è¯•');
    
    if (modal) {
      console.log('âœ… æ¨¡æ€æ¡†åˆ›å»ºæˆåŠŸ');
      
      const testButton = modal.querySelector('#test-button');
      if (testButton) {
        console.log('âœ… æŒ‰é’®å…ƒç´ æŸ¥æ‰¾æˆåŠŸ');
        testButton.addEventListener('click', () => {
          alert('æŒ‰é’®ç‚¹å‡»äº‹ä»¶æ­£å¸¸ï¼');
        });
      } else {
        console.error('âŒ æŒ‰é’®å…ƒç´ æŸ¥æ‰¾å¤±è´¥');
      }
    } else {
      console.error('âŒ æ¨¡æ€æ¡†åˆ›å»ºå¤±è´¥');
    }
    
  } catch (e) {
    console.error('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š', e);
  }
}
// åç»­ï¼šåœ¨ studentTimeSlots / practice interval æ›´æ–°å¤„è°ƒç”¨ computeLeaderboard() èŠ‚æµå³å¯ã€‚

// æ’è¡Œæ¦œèŠ‚æµåˆ·æ–°ï¼šç›¸å…³æ•°æ®å˜æ›´æ—¶è°ƒç”¨
let scheduleLeaderboardUpdate = (function(){
  let timer=null; return function(){
    if(timer) return; timer=setTimeout(()=>{timer=null; computeLeaderboard();}, 600); // 600ms å»æŠ–
  };
})();

// æ•°æ®ç›‘å¬æŒ‚é’©ï¼ˆåœ¨ç°æœ‰ç›‘å¬æˆåŠŸå›è°ƒå°¾éƒ¨è°ƒç”¨ï¼‰ç¤ºä¾‹ï¼š
// åœ¨ studentTimeSlots on('value') ä¸ è€ƒå‹¤/ç»ƒç´è®°å½•å˜æ›´åæ·»åŠ  scheduleLeaderboardUpdate();
// ä¸‹é¢æ¼”ç¤ºæ€§åœ°å¯¹ window æš´éœ²ä¸€ä¸ªè§¦å‘æ–¹æ³•æ–¹ä¾¿æ‰‹åŠ¨è°ƒè¯•ã€‚
window.forceLeaderboardRecompute = computeLeaderboard;

// æµ‹è¯•å·¥å…·ï¼šå¯ç”¨æµ‹è¯•æ¨¡å¼ï¼ˆå¯ä»¥åœ¨ä»»ä½•æ—¶é—´ä¿å­˜å¿«ç…§ï¼‰
window.enableLeaderboardTestMode = function() {
  localStorage.setItem('leaderboard_test_mode', 'true');
  console.log('[æµ‹è¯•æ¨¡å¼] å·²å¯ç”¨æ’è¡Œæ¦œæµ‹è¯•æ¨¡å¼ï¼Œå°†åœ¨ä¸‹æ¬¡è®¡ç®—æ—¶ä¿å­˜å¿«ç…§');
};

// æµ‹è¯•å·¥å…·ï¼šç¦ç”¨æµ‹è¯•æ¨¡å¼
window.disableLeaderboardTestMode = function() {
  localStorage.removeItem('leaderboard_test_mode');
  console.log('[æµ‹è¯•æ¨¡å¼] å·²ç¦ç”¨æ’è¡Œæ¦œæµ‹è¯•æ¨¡å¼');
};

// æµ‹è¯•å·¥å…·ï¼šæ¸…é™¤æ‰€æœ‰å†å²å¿«ç…§
window.clearLeaderboardHistory = function() {
  localStorage.removeItem('leaderboard_history');
  console.log('[æµ‹è¯•å·¥å…·] å·²æ¸…é™¤æ‰€æœ‰å†å²å¿«ç…§');
};

// åˆå§‹åŒ–ï¼šç­‰æ ¸å¿ƒæ•°æ® ready åé¦–æ¬¡è®¡ç®—ï¼ˆä¾èµ– existing ready.* ç»“æ„ï¼‰
(function waitCore(){
  if(typeof ready==='object' && ready.students && ready.slots){
    computeLeaderboard();
  } else { setTimeout(waitCore, 500); }
})();

/* =============================
   1. å›½é™…åŒ–é…ç½®ï¼ˆä¿ç•™åŸç»“æ„ï¼‰
   ============================= */
const i18n = {
  zh: {
    // å¤´éƒ¨
    'header.title': 'ğŸ¼ é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡',
    'header.subtitle': 'å®æ—¶ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ',


    
    // å¯¼èˆª
    'nav.dashboard': 'ğŸ“Š è€ƒå‹¤æ¦‚è§ˆ',
    'nav.students': 'ğŸ‘¥ å­¦ç”Ÿè¯¦æƒ…', 
  // å¯¼èˆªæ›¿æ¢ï¼šæ’è¡Œæ¦œ
  'nav.leaderboard': 'ğŸ…æ’è¡Œæ¦œ',
  'leaderboard.title': 'ğŸ† 442ç»ƒç´æ’è¡Œæ¦œ',
  'leaderboard.refresh': 'åˆ·æ–°',
  'leaderboard.expand': 'å±•å¼€å…¨éƒ¨',
  'leaderboard.collapse': 'æ”¶èµ·',
    'nav.sync': 'ğŸ”„ æ•°æ®åŒæ­¥',
    
    // è¿æ¥çŠ¶æ€
    'status.online': 'ğŸŸ¢ å·²è¿æ¥',
    'status.offline': 'ğŸ”´ ç¦»çº¿æ¨¡å¼',
    'status.syncing': 'ğŸŸ¡ åŒæ­¥ä¸­',
    
    // è€ƒå‹¤çŠ¶æ€
    'status.present': 'å‡ºå‹¤',
    'status.absent': 'ç¼ºå‹¤',
    'status.excused': 'è¯·å‡',
    'status.pending': 'å¾…è€ƒå‹¤',
    'status.low_efficiency': 'ä½æ•ˆ',
    'stats.absent.desc': 'åº”åˆ°æœªåˆ°',
  'status.practicing_unscheduled': 'è‡ªä¸»ç»ƒç´',
  'status.not_practicing': 'ç›®å‰æœªç»ƒç´',


    // ç»Ÿè®¡
    'stats.total': 'æ€»å­¦ç”Ÿæ•°',
    'stats.total.desc': 'å·²ç™»è®°å­¦ç”Ÿ',
    'stats.present': 'å‡ºå‹¤',
    'stats.present.desc': 'å½“å‰åœ¨ç´æˆ¿',
    'stats.absent': 'ç¼ºå‹¤',
    'stats.absent.desc': 'åº”åˆ°æœªåˆ°',
    'stats.excused': 'è¯·å‡',
    'stats.excused.desc': 'å·²æ‰¹å‡†è¯·å‡',
    'stats.pending': 'å¾…è€ƒå‹¤',
    'stats.pending.desc': 'éç»ƒç´æ—¶é—´',
  'stats.self_practice': 'è‡ªä¸»ç»ƒç´',
  'stats.self_practice.desc': 'éè§„å®šæ—¶é—´æ®µç»ƒç´',

    
    // ç»ƒç´ç›¸å…³
    'practice.title': 'ğŸ¹ å®æ—¶ç»ƒç´çŠ¶æ€',
    'practice.current_time': 'å½“å‰æ—¶é—´ï¼š',
    'practice.empty.title': 'å½“å‰æ²¡æœ‰å­¦ç”Ÿåœ¨ç»ƒç´',
    'practice.empty.desc.weekday': 'ç­‰å¾…å­¦ç”Ÿå¼€å§‹ç»ƒç´',
    'practice.in_slot': 'æ®µå†…',
    'practice.out_slot': 'æ®µå¤–',
    'practice.recent_7days': 'ğŸ—“ï¸ æœ€è¿‘7å¤©ç»ƒç´æ˜ç»†',
    'practice.time_slot_desc': 'æ®µå†…=è§„å®šç»ƒç´æ—¶æ®µ | æ®µå¤–=éè§„å®šæ—¶æ®µ',
    'practice.data_source': 'â€¢ æ•°æ®æ¥æºï¼šå®æ—¶è®¡ç®—',
    'practice.status': 'ç»ƒç´çŠ¶æ€',
    'practice.start_time': 'å¼€å§‹æ—¶é—´:',
    'practice.room': 'ç´æˆ¿:',
    'practice.current_practice': 'å½“å‰ç»ƒä¹ :',
    'practice.today_total': 'ä»Šæ—¥æ€»è®¡:',
    'practice.out_slot_segments': 'æ®µå¤–ç»ƒç´åŒºé—´',
  'break.short.recess':'è¯¾é—´ä¼‘æ¯',
  'break.short.large':'å¤§è¯¾é—´ä¼‘æ¯',
  'break.short.lunch':'åˆé¤æ—¶é—´',
  'break.short.lunch_concert':'åˆé¤æ—¶é—´+åˆé—´éŸ³ä¹ä¼š',
  'break.short.dinner':'æ™šé¤æ—¶é—´',
  'break.night':'å¤œé—´',
  'break.excluded_minutes':'å‰”é™¤åˆ†é’Ÿ',
  'break.remaining':'å‰©ä½™',
    
    // è€ƒå‹¤ç›¸å…³
    'attendance.title': 'ğŸ“… ä»Šæ—¥è€ƒå‹¤å¿«ç…§',
    'attendance.select_date': 'é€‰æ‹©æ—¥æœŸï¼š',
    'attendance.history': 'æœ€è¿‘7å¤©è€ƒå‹¤',
    'attendance.rate': 'å‡ºå‹¤ç‡',
    'attendance.detail.suffix': 'è€ƒå‹¤è¯¦æƒ…',
    'attendance.summary': 'è€ƒå‹¤æ±‡æ€»',
    'attendance.detailed_records': 'è¯¦ç»†è®°å½•',
    'attendance.remarks': 'å¤‡æ³¨',
    
    // ç­›é€‰å™¨
    'filter.major': 'ä¸“ä¸šç­›é€‰',
    'filter.grade': 'å¹´çº§ç­›é€‰',
    'filter.status': 'è€ƒå‹¤çŠ¶æ€',
    'filter.search': 'æœç´¢å­¦ç”Ÿ',
    'filter.all_majors': 'æ‰€æœ‰ä¸“ä¸š',
    'filter.all_grades': 'æ‰€æœ‰å¹´çº§',
    'filter.all_status': 'æ‰€æœ‰çŠ¶æ€',
    'filter.search_placeholder': 'è¾“å…¥å­¦ç”Ÿå§“å...',
    'filter.no_results': 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿ',
    'filter.try_different': 'è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶',
    'filter.clear': 'æ¸…é™¤',
    
    // å­¦ç”Ÿä¿¡æ¯
    'student.name': 'å§“å',
    'student.major': 'ä¸“ä¸š',
    'student.grade': 'å¹´çº§',
    'student.room': 'æ‰€åœ¨ç´æˆ¿',
    'student.time_slot': 'æ—¶é—´æ®µ',
    'student.practice_duration': 'ç»ƒç´æ—¶é•¿',
    'student.start_time': 'æœ€è¿‘å¼€å§‹',
    'student.not_in_room': 'ä¸åœ¨ç´æˆ¿',
    'student.not_started': 'æœªå¼€å§‹',
    'student.not_set': 'æœªè®¾ç½®',
    'student.unknown_major': 'æœªçŸ¥ä¸“ä¸š',
    'student.detail.title': 'å­¦ç”Ÿè¯¦æƒ…',
    'student.today_attendance': 'ä»Šæ—¥è€ƒå‹¤',
    'student.today_practice': 'ä»Šæ—¥ç»ƒç´æ—¶é•¿',
    
    // æ—¶é—´ç›¸å…³
    'time.hours': 'å°æ—¶',
    'time.minutes': 'åˆ†é’Ÿ',
    'time.seconds': 'ç§’',
    'time.no_practice': '0åˆ†é’Ÿ',
    'time.preparing': 'å‡†å¤‡ä¸­',
    'time.preparing_formal': 'å‡†å¤‡ä¸­(æ­£å¼æ—¶æ®µ)',
    'time.buffer_observation': 'ç¼“å†²è§‚å¯Ÿ',
    'time.today': 'ä»Šå¤©',
    'time.no_records': 'æ— è®°å½•',
    
    // è¯·å‡ç›¸å…³
    'excuse.title': 'ğŸ“ ä»Šæ—¥è¯·å‡ä¿¡æ¯',
    'excuse.reason': 'è¯·å‡åŸå› ',
    'excuse.duration_text': 'è¯·å‡æ—¶é•¿',
    'excuse.end_date': 'ç»“æŸæ—¥æœŸ',
    'excuse.not_filled': 'æœªå¡«å†™',
    
    // æŠ¥å‘Šç›¸å…³
    'report.title': 'ğŸ“ˆ è€ƒå‹¤å†å²åˆ†æ',
    'report.start_date': 'å¼€å§‹æ—¥æœŸï¼š',
    'report.end_date': 'ç»“æŸæ—¥æœŸï¼š',
    'report.empty.title': 'é€‰æ‹©æ—¥æœŸèŒƒå›´ç”ŸæˆæŠ¥å‘Š',
    'report.empty.desc': 'é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼Œç„¶åç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"',
    'report.analysis_title': 'ğŸ“Š è€ƒå‹¤åˆ†ææŠ¥å‘Š',
    'report.period': 'ç»Ÿè®¡å‘¨æœŸ',
    'report.to': 'è‡³',
    'report.days': 'å¤©',
    'report.participants': 'å‚ä¸å­¦ç”Ÿ',
    'report.people': 'äºº',
    'report.daily_trend': 'ğŸ“ˆ æ¯æ—¥è€ƒå‹¤è¶‹åŠ¿',
    'report.date': 'æ—¥æœŸ',
    'report.total': 'åˆè®¡',
    'report.student_stats': 'ğŸ‘¥ å­¦ç”Ÿè€ƒå‹¤ç»Ÿè®¡',
    'report.regenerate': 'é‡æ–°ç”Ÿæˆ',
    
    // åŒæ­¥ç›¸å…³
    'sync.title': 'ğŸ”„ æ•°æ®åŒæ­¥ç®¡ç†',
    'sync.status': 'åŒæ­¥çŠ¶æ€',
    'sync.checking': 'æ­£åœ¨æ£€æŸ¥è¿æ¥çŠ¶æ€...',
    'sync.logs': 'ğŸ“‹ åŒæ­¥æ—¥å¿—',
    'sync.force_sync': 'å¼ºåˆ¶åŒæ­¥',
    
    // æŒ‰é’®
    'btn.generate_report': 'ç”ŸæˆæŠ¥å‘Š',
    'btn.force_sync': 'å¼ºåˆ¶åŒæ­¥',
    'btn.clear_cache': 'æ¸…é™¤ç¼“å­˜',
    
    // æ¶ˆæ¯æç¤º
    'msg.loading': 'åŠ è½½ä¸­...',
    'msg.no_data': 'æš‚æ— æ•°æ®',
    'msg.select_dates': 'è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ',
    'msg.date_range_error': 'å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ',
    'msg.sync_required': 'éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½åŒæ­¥æ•°æ®',
    'msg.clear_cache_confirm': 'ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ç¼“å­˜å—ï¼Ÿ',
    'msg.cache_cleared': 'æœ¬åœ°ç¼“å­˜å·²æ¸…é™¤',
    
    // ç©ºçŠ¶æ€
    'empty.no_students': 'æš‚æ— å­¦ç”Ÿæ•°æ®',
    'empty.no_attendance': 'è¿˜æ²¡æœ‰è€ƒå‹¤è®°å½•',
    'empty.load_failed': 'åŠ è½½å¤±è´¥',
    
    // æˆ¿é—´ç›¸å…³
    'room.practice_room': 'ç»ƒç´æˆ¿',
    'room.in_room': 'åœ¨ç´æˆ¿',
    'room.not_in_room': 'ä¸åœ¨ç´æˆ¿',
    'room.historical_rebuild': 'ï¼ˆå†å²é‡å»ºï¼‰',
    'room.no_arrangement': 'æ— å®‰æ’',
    'room.weekend': 'å‘¨æœ«',
    
    // çŠ¶æ€æ–‡æœ¬
    'status.present_out_slot': 'å‡ºå‹¤(æ®µå¤–)',
    'status.pending_attendance': 'å¾…è€ƒå‹¤',
    'status.absent_text': 'ç¼ºå‹¤',
    'status.present_text': 'å‡ºå‹¤',
    'status.low_efficiency_text': 'ä½æ•ˆ',
    'status.absent_buffer': 'ç¼ºå‹¤(ç¼“å†²æœŸ)',
    'status.absent_not_started': 'ç¼ºå‹¤(æœªå¼€å§‹)',
    'status.absent_ended': 'ç¼ºå‹¤(å·²ç»“æŸ)'
  },
  
  en: {
    // å¤´éƒ¨
    'header.title': 'ğŸ¼ Qingdao Menuhin School',
    'header.subtitle': 'Practice Tracking System',
    
    // å¯¼èˆª
    'nav.dashboard': 'ğŸ“Š Overview',
    'nav.students': 'ğŸ‘¥ Students', 
    'nav.reports': 'ğŸ“ˆ Reports',
    'nav.sync': 'ğŸ”„ Sync',
    
    // è¿æ¥çŠ¶æ€
    'status.online': 'ğŸŸ¢ Online',
    'status.offline': 'ğŸ”´ Offline',
    'status.syncing': 'ğŸŸ¡ Syncing',
    
    // è€ƒå‹¤çŠ¶æ€
    'status.present': 'Present',
    'status.absent': 'Absent',
    'status.excused': 'Excused',
    'status.pending': 'Pending',
    'status.low_efficiency': 'Low Efficiency',
    'stats.absent.desc': 'Should be Present',
  'status.practicing_unscheduled': 'Self Practice',
  'status.not_practicing': 'Not Practicing',
    
    // ç»Ÿè®¡
    'stats.total': 'Total',
    'stats.total.desc': 'Registered',
    'stats.present': 'Present',
    'stats.present.desc': 'In Rooms',
    'stats.absent': 'Absent',
    'stats.absent.desc': 'Should be Present',
    'stats.excused': 'Excused',
    'stats.excused.desc': 'Approved Leave',
    'stats.pending': 'Pending',
    'stats.pending.desc': 'Non-practice Time',
  'stats.self_practice': 'Self Practice',
  'stats.self_practice.desc': 'Out-of-slot practice',

    
    // ç»ƒç´ç›¸å…³
    'practice.title': 'ğŸ¹ Practice Status',
    'practice.current_time': 'Time: ',
    'practice.empty.title': 'No students practicing',
    'practice.empty.desc.weekday': 'Waiting for students',    
    'practice.in_slot': 'In-Slot',
    'practice.out_slot': 'Out-Slot',
    'practice.recent_7days': 'ğŸ—“ï¸ Recent 7 Days Practice Details',
    'practice.time_slot_desc': 'In-Slot=Scheduled Time | Out-Slot=Non-scheduled Time',
    'practice.data_source': 'â€¢ Data Source: Real-time Calculation',
    'practice.status': 'Practice Status',
    'practice.start_time': 'Start Time:',
    'practice.room': 'Room:',
    'practice.current_practice': 'Current:',
    'practice.today_total': 'Today Total:',
    'practice.out_slot_segments': 'Out-of-slot Intervals',
  'break.short.recess':'Recess',
  'break.short.large':'Long Break',
  'break.short.lunch':'Lunch',
  'break.short.lunch_concert':'Lunch + Noon Concert',
  'break.short.dinner':'Dinner',
  'break.night':'Night',
  'break.excluded_minutes':'Excluded Min',
  'break.remaining':'Remain',
    // è€ƒå‹¤ç›¸å…³
    'attendance.title': 'ğŸ“… Today\'s Attendance',
    'attendance.select_date': 'Date: ',
    'attendance.history': 'Last 7 Days',
    'attendance.rate': 'Rate',
    'attendance.detail.suffix': ' Details',
    'attendance.summary': 'Summary',
    'attendance.detailed_records': 'Records',
    'attendance.remarks': 'Remarks',

    
    // ç­›é€‰å™¨
    'filter.major': 'Major',
    'filter.grade': 'Grade',
    'filter.status': 'Status',
    'filter.search': 'Search',
    'filter.all_majors': 'All Majors',
    'filter.all_grades': 'All Grades',
    'filter.all_status': 'All Status',
    'filter.search_placeholder': 'Enter name...',
    'filter.no_results': 'No matches',
    'filter.try_different': 'Try different filters',
    'filter.clear': 'Clear',
    
    // å­¦ç”Ÿä¿¡æ¯
    'student.name': 'Name',
    'student.major': 'Major',
    'student.grade': 'Grade',
    'student.room': 'Room',
    'student.time_slot': 'Time Slot',
    'student.practice_duration': 'Duration',
    'student.start_time': 'Start',
    'student.not_in_room': 'Not in Room',
    'student.not_started': 'Not Started',
    'student.not_set': 'Not Set',
    'student.unknown_major': 'Unknown',
    'student.detail.title': 'Details',
    'student.today_attendance': 'Today\'s Attendance',
    'student.today_practice': 'Today\'s Practice',
    
    // æ—¶é—´ç›¸å…³
    'time.hours': 'h',
    'time.minutes': 'min',
    'time.seconds': 's',
    'time.no_practice': '0 min',
    'time.preparing': 'Preparing',
    'time.preparing_formal': 'Preparing (Formal)',
    'time.buffer_observation': 'Buffer Observation',
    'time.today': 'Today',
    'time.no_records': 'No Records',
    
    // è¯·å‡ç›¸å…³
    'excuse.title': 'ğŸ“ Today\'s Leave Info',
    'excuse.reason': 'Reason',
    'excuse.duration_text': 'Duration',
    'excuse.end_date': 'End Date',
    'excuse.not_filled': 'Not Filled',
    
    // æŠ¥å‘Šç›¸å…³
    'report.title': 'ğŸ“ˆ Analysis',
    'report.start_date': 'Start: ',
    'report.end_date': 'End: ',
    'report.empty.title': 'Select dates to generate',
    'report.empty.desc': 'Choose dates, then click "Generate"',
    'report.analysis_title': 'ğŸ“Š Analysis Report',
    'report.period': 'Period',
    'report.to': 'to',
    'report.days': ' days',
    'report.participants': 'Students',
    'report.people': ' students',
    'report.daily_trend': 'ğŸ“ˆ Daily Trend',
    'report.date': 'Date',
    'report.total': 'Total',
    'report.student_stats': 'ğŸ‘¥ Student Stats',
    'report.regenerate': 'Regenerate',
    
    // åŒæ­¥ç›¸å…³
    'sync.title': 'ğŸ”„ Data Sync',
    'sync.status': 'Status',
    'sync.checking': 'Checking...',
    'sync.logs': 'ğŸ“‹ Logs',
    'sync.force_sync': 'Force Sync',
    
    // æŒ‰é’®
    'btn.generate_report': 'Generate',
    'btn.force_sync': 'Force Sync',
    'btn.clear_cache': 'Clear Cache',
    
    // æ¶ˆæ¯æç¤º
    'msg.loading': 'Loading...',
    'msg.no_data': 'No Data',
    'msg.select_dates': 'Select start and end dates',
    'msg.date_range_error': 'Start date cannot be later than end',
    'msg.sync_required': 'Network required for sync',
    'msg.clear_cache_confirm': 'Clear local cache?',
    'msg.cache_cleared': 'Cache cleared',
    
    // ç©ºçŠ¶æ€
    'empty.no_students': 'No student data',
    'empty.no_attendance': 'No records yet',
    'empty.load_failed': 'Load failed',
    
    // æˆ¿é—´ç›¸å…³
    'room.practice_room': 'Practice Room',
    'room.in_room': 'In Room',
    'room.not_in_room': 'Not in Room',
    'room.historical_rebuild': '(Historical)',
    'room.no_arrangement': 'No Schedule',
    'room.weekend': 'Weekend',
    
    // çŠ¶æ€æ–‡æœ¬
    'status.present_out_slot': 'Present(Out-Slot)',
    'status.pending_attendance': 'Pending',
    'status.absent_text': 'Absent',
    'status.present_text': 'Present',
    'status.low_efficiency_text': 'Low Efficiency',
    'status.absent_buffer': 'Absent(Buffer)',
    'status.absent_not_started': 'Absent(Not Started)',
    'status.absent_ended': 'Absent(Ended)'
  }
};

let currentLanguage='zh';
function t(k,f=''){const p=i18n[currentLanguage]||{};return p[k]||f||k;}

// ğŸ”¥ æ–°å¢ï¼šåŒæ­¥è¯­è¨€æŒ‰é’®çŠ¶æ€
function syncLanguageButtons(){
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.dataset.lang===currentLanguage));
}

function switchLanguage(lang){if(lang===currentLanguage)return;currentLanguage=lang;syncLanguageButtons();updatePageLanguage();localStorage.setItem('preferred_language',lang);addSyncLog(`ğŸŒ ${lang==='zh'?'è¯­è¨€åˆ‡æ¢ä¸ºä¸­æ–‡':'Language switched to English'}`);refreshCurrentTabContent();}
function updatePageLanguage(){const pack=i18n[currentLanguage]||{};document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(pack[k]) el.textContent=pack[k];});document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{const k=el.getAttribute('data-i18n-placeholder');if(pack[k]) el.placeholder=pack[k];});document.title=currentLanguage==='zh'?'é’å²›æ¢…çº½å› éŸ³ä¹å­¦æ ¡ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ':'Qingdao Menuhin Music School Practice Tracking System';}

/* =============== Firebase =============== */
const firebaseConfig = {
  apiKey: "AIzaSyBfRjrAKsVUAHBl5WbBl96YONrkRe1UWUo",
  authDomain: "menuhin-studio-system.firebaseapp.com",
  databaseURL: "https://menuhin-studio-system-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "menuhin-studio-system",
  storageBucket: "menuhin-studio-system.firebasestorage.app",
  messagingSenderId: "218592951152",
  appId: "1:218592951152:web:650d080726b6c44f5a2db5",
  measurementId: "G-P49SZQTLT7"
};
let database=null,isOnline=false;

/* =============== å…¨å±€æ•°æ®ç»“æ„ =============== */
let rooms=[];
let studentDatabase={};
let excuseData={};
let attendanceRecordsCache={};
let realTimePracticeMap={};
let syncLogs=[];
let currentTab='dashboard';

let studentTimeSlots={};
let dailyPracticeRecords={};
// === æ’è¡Œæ¦œè‡ªåŠ¨åˆ·æ–°çŠ¶æ€ ===
leaderboardState.dirty=false;
let _lbAutoTimer=null;
function setLeaderboardDirty(){
  leaderboardState.dirty=true;
  const hint=document.getElementById('leaderboard-auto-hint');
  if(hint) hint.style.display='inline';
  scheduleLeaderboardAutoRecalc();
}
function scheduleLeaderboardAutoRecalc(){
  // å¦‚æœå½“å‰ Tab ä¸æ˜¯ leaderboardï¼Œç­‰åˆ‡æ¢æ—¶å·²æœ‰é€»è¾‘ä¼šè§¦å‘ï¼›ä»ä¿æŒè„æ ‡è®°
  if(_lbAutoTimer) clearTimeout(_lbAutoTimer);
  _lbAutoTimer=setTimeout(()=>{
    if(currentTab==='leaderboard'){ computeLeaderboard(); }
    else {
      // æœªåœ¨æ’è¡Œæ¦œé¡µï¼Œå»¶é•¿ç­‰å¾…ï¼ˆå†æ¬¡è®¾å®šå®šæ—¶å™¨ï¼‰
      scheduleLeaderboardAutoRecalc();
    }
  },3000); // 3ç§’é˜²æŠ–
}
let practiceSessionTracker=new Map();
let lastPracticeSessionSweep=0;
const PRACTICE_UPDATE_INTERVAL_MS=60000;
// ç»ƒç´ç»Ÿè®¡æ—¥çª—å£ï¼ˆåªç»Ÿè®¡æ­¤æ—¶é—´èŒƒå›´å†…çš„ç»ƒç´ï¼›ä»¥å‰å¤œé—´ 21:30-24:00 ä½œä¸ºâ€œå‰”é™¤â€ï¼Œç°åœ¨ç›´æ¥ä¸çº³å…¥åŸå§‹ç»Ÿè®¡ï¼‰
const PRACTICE_DAY_START_MINUTES = 6*60;   // 06:00
const PRACTICE_DAY_END_MINUTES   = 21*60+30; // å¤‡ç”¨é»˜è®¤ 21:30

// åŠ¨æ€æ¯æ—¥æˆªæ–­ï¼ˆå†»ç»“ï¼‰æ—¶é—´ï¼šå‘¨ä¸€/äºŒ/å››/äº” 19:00ï¼Œå‘¨ä¸‰ 19:30ï¼Œå…¶å®ƒï¼ˆå‘¨å…­/å‘¨æ—¥ï¼‰21:30
function getTodayFreezeMinutes(dateObj=new Date()){
  const wd = dateObj.getDay(); // 0=å‘¨æ—¥
  if(wd===1||wd===2||wd===4||wd===5) return 19*60;      // 19:00
  if(wd===3) return 19*60+30;                           // 19:30
  return PRACTICE_DAY_END_MINUTES;                      // å‘¨æœ«/å‘¨æ—¥ç”¨åŸå€¼(21:30)
}

/* ==== ä¼‘æ¯æ—¶é—´é…ç½®ï¼ˆè¯¾é—´/åˆé¤/å¤§è¯¾é—´/æ™šé¤ + å¤œé—´ï¼‰==== */
const BREAK_SCHEDULE={
  monTueThuFri:[
    {start:8*60+50,end:9*60,labelKey:'break.short.recess'},
    {start:9*60+50,end:10*60,labelKey:'break.short.recess'},
    {start:10*60+50,end:11*60,labelKey:'break.short.recess'},
    // å‘¨ä¸€äºŒå››äº”ï¼š11:50-13:00 ä»…åˆé¤
    {start:11*60+50,end:13*60,labelKey:'break.short.lunch'},
  // æ–°å¢ åˆåçŸ­ä¼‘ 13:50-14:00
  {start:13*60+50,end:14*60,labelKey:'break.short.recess'},
    {start:14*60+50,end:15*60+10,labelKey:'break.short.large'},
    {start:16*60,end:16*60+10,labelKey:'break.short.recess'},
    {start:17*60,end:17*60+10,labelKey:'break.short.recess'},
    {start:18*60,end:19*60,labelKey:'break.short.dinner'}
  ],
  wed:[
    {start:8*60+50,end:9*60,labelKey:'break.short.recess'},
    {start:9*60+50,end:10*60,labelKey:'break.short.recess'},
    {start:10*60+50,end:11*60,labelKey:'break.short.recess'},
    // å‘¨ä¸‰ï¼š11:50-13:30 åˆé¤æ—¶é—´+åˆé—´éŸ³ä¹ä¼š
    {start:11*60+50,end:13*60+30,labelKey:'break.short.lunch_concert'},
  // æ–°å¢ å‘¨ä¸‰åˆåçŸ­ä¼‘ 14:20-14:30
  {start:14*60+20,end:14*60+30,labelKey:'break.short.recess'},
    {start:15*60+20,end:15*60+40,labelKey:'break.short.large'},
    {start:16*60+30,end:16*60+40,labelKey:'break.short.recess'},
    {start:17*60+30,end:17*60+40,labelKey:'break.short.recess'},
    {start:18*60+30,end:19*60+30,labelKey:'break.short.dinner'}
  ],
  common:[]
};
function currentBreakInfo(now=new Date()){
  const wd=now.getDay();
  const m=now.getHours()*60+now.getMinutes();
  let segs=[...BREAK_SCHEDULE.common];
  if(wd===3) segs.push(...BREAK_SCHEDULE.wed); else if(wd>=1&&wd<=5) segs.push(...BREAK_SCHEDULE.monTueThuFri);
  for(const s of segs){ if(m>=s.start && m<s.end){
    const remain=(s.end-m)*60; // ç§’
    const label=t(s.labelKey,s.labelKey);
    return {labelKey:s.labelKey,label,labelRaw:s.labelKey,endMinute:s.end,remainSec:remain,startMinute:s.start};
  }}
  return null;
}

// è®¡ç®—æŸæ—¶é—´æ®µ(å¼€å§‹->å½“å‰)å‰”é™¤ä¼‘æ¯åçš„æœ‰æ•ˆç»ƒç´ç§’æ•°
function computeEffectivePracticeSeconds(startTimeMs, nowMs=new Date().getTime()){
  if(!startTimeMs || nowMs<=startTimeMs) return 0;
  const startDate=new Date(startTimeMs);
  const nowDate=new Date(nowMs);
  // ä»…å½“æ—¥åœºæ™¯ï¼›è‹¥è·¨æ—¥ç®€å•æˆªæ–­åˆ°ä»Šæ—¥0ç‚¹
  const dayStart=new Date(nowDate.getFullYear(),nowDate.getMonth(),nowDate.getDate()).getTime();
  let segStart=Math.max(startTimeMs, dayStart);
  const totalSec=Math.floor((nowMs - segStart)/1000);
  if(totalSec<=0) return 0;
  const wd=nowDate.getDay();
  let segs=[...BREAK_SCHEDULE.common];
  if(wd===3) segs.push(...BREAK_SCHEDULE.wed); else if(wd>=1&&wd<=5) segs.push(...BREAK_SCHEDULE.monTueThuFri);
  if(!segs.length) return totalSec;
  // è½¬æˆåˆ†é’Ÿä¾¿äºé‡å ï¼šä¼‘æ¯æ®µ start/end åˆ†é’Ÿï¼ŒåŒä¸€å¤©
  const startMin=Math.floor((segStart - dayStart)/60000);
  const nowMin=Math.floor((nowMs - dayStart)/60000);
  let deducted=0;
  for(const b of segs){
    // ä¸ [startMin, nowMin) é‡å 
    const ovStart=Math.max(startMin, b.start);
    const ovEnd=Math.min(nowMin, b.end);
    if(ovEnd>ovStart){
      deducted += (ovEnd-ovStart)*60; // ç§’
    }
  }
  const effective=Math.max(0, totalSec - deducted);
  return effective;
}

/* ==== å¢é‡ç»ƒç´å†™å…¥èŠ‚æµ ==== */
const SYNC_INCREMENT_INTERVAL_MS=90000; // 90ç§’å†™äº‘ç«¯ä¸€æ¬¡ï¼ˆå¯è°ƒï¼‰
let lastIncrementSync=0;

/* ==== Snapshot è¿‡æœŸé˜ˆå€¼ ==== */
const SNAPSHOT_STALE_MS=2*60*1000; // 2åˆ†é’Ÿ

/* =============== å·¥å…·å‡½æ•° =============== */
function addSyncLog(msg){const time=new Date().toLocaleString();syncLogs.unshift(`[${time}] ${msg}`);if(syncLogs.length>300)syncLogs.length=300;const box=document.getElementById('syncLogs');if(box) box.textContent=syncLogs.join('\n');}
function updateConnectionStatus(){const el=document.getElementById('connectionStatus');if(!el)return;if(isOnline){el.className='connection-status online';el.innerHTML='<span>'+t('status.online','å·²è¿æ¥')+'</span>';}else{el.className='connection-status offline';el.innerHTML='<span>'+t('status.offline','ç¦»çº¿æ¨¡å¼')+'</span>';}}
function formatDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function initClock(){(function loop(){const now=new Date();const el=document.getElementById('currentTime');if(el)el.textContent=now.toLocaleString(currentLanguage==='zh'?'zh-CN':'en-US');setTimeout(loop,1000);})();}
function setText(id,v){const el=document.getElementById(id);if(el)el.textContent=v;}
function timeToMinutes(str){if(!str||typeof str!=='string')return 0;const p=str.split(':');if(p.length!==2)return 0;const h=parseInt(p[0],10),m=parseInt(p[1],10);if(isNaN(h)||isNaN(m))return 0;return h*60+m;}
function getTodayDateString(){return formatDate(new Date());}
function flattenStudents(){const arr=[];Object.keys(studentDatabase).forEach(major=>{const list=studentDatabase[major];if(Array.isArray(list)){list.forEach(s=>{if(typeof s==='string')arr.push({name:s,major});else if(s&&typeof s==='object')arr.push({name:s.name,major,grade:s.grade||''});});}});return arr;}
function getStudentInfo(name){for(const [major,arr] of Object.entries(studentDatabase)){if(Array.isArray(arr)){for(const s of arr){if(typeof s==='string'&&s===name)return {name,major,grade:''};if(typeof s==='object'&&s.name===name)return {name,major,grade:s.grade||''};}}}return {name,major:t('student.unknown_major','æœªçŸ¥ä¸“ä¸š'),grade:''};}

// å°†åŸå§‹ç»ƒç´åŒºé—´è£å‰ªåˆ°æ—¥çª—å£ (06:00 <= t < 21:30)ï¼Œå»é™¤è·¨åˆå¤œæ®‹ç‰‡ä¸ 21:30 ä»¥åéƒ¨åˆ†
function clipPracticeIntervals(dateStr, intervals){
  if(!Array.isArray(intervals)||!intervals.length) return [];
  const dayStart=new Date(`${dateStr}T00:00:00`).getTime();
  const freezeMin = getTodayFreezeMinutes(new Date(dayStart));
  const winStart=dayStart + PRACTICE_DAY_START_MINUTES*60000;
  const winEnd  =dayStart + freezeMin*60000; // åŠ¨æ€æˆªæ–­
  const out=[];
  for(const iv of intervals){
    if(!iv||!iv.start||!iv.end) continue;
    let s=iv.start,e=iv.end;
    if(e<=winStart || s>=winEnd) continue; // å®Œå…¨åœ¨çª—å£å¤–
    if(s<winStart) s=winStart;
    if(e>winEnd)   e=winEnd;
    if(e-s>=1000) out.push({...iv,start:s,end:e});
  }
  return out;
}

/* ==== ä¼‘æ¯æ—¶é—´å‰”é™¤ä¸ç»Ÿä¸€è®¡ç®— ==== */
function subtractExcludedFromIntervals(dateStr, intervals){
  if(!Array.isArray(intervals)||!intervals.length) return [];
  const result=[];
  const dayStart=new Date(`${dateStr}T00:00:00`).getTime();
  const wd=new Date(dateStr).getDay();
  const segs=[...BREAK_SCHEDULE.common];
  if(wd===3) segs.push(...BREAK_SCHEDULE.wed); else if(wd>=1&&wd<=5) segs.push(...BREAK_SCHEDULE.monTueThuFri);
  // (å·²ç§»é™¤å¤œé—´æ®µ: 21:30 ä»¥åç›´æ¥ä¸è®¡å…¥ rawï¼Œä¸å†ä½œä¸ºâ€œå‰”é™¤æ¥æºâ€)
  const exclude=segs.map(s=>({start:dayStart+s.start*60000,end:dayStart+s.end*60000}));
  intervals.forEach(iv=>{
    let parts=[{start:iv.start,end:iv.end}];
    exclude.forEach(ex=>{
      const next=[];
      parts.forEach(seg=>{
        if(seg.end<=ex.start || seg.start>=ex.end){ next.push(seg); }
        else {
          if(seg.start<ex.start) next.push({start:seg.start,end:ex.start});
          if(seg.end>ex.end) next.push({start:ex.end,end:seg.end});
        }
      });
      parts=next;
    });
    parts.forEach(seg=>{ if(seg.end-seg.start>=1000) result.push({...iv,start:seg.start,end:seg.end}); });
  });
  result.sort((a,b)=>a.start-b.start);
  const merged=[];let cur=result[0];
  for(let i=1;i<result.length;i++){const n=result[i];if(n.start<=cur.end+1000 && n.room===cur.room){cur.end=Math.max(cur.end,n.end);}else{merged.push(cur);cur=n;}}
  if(cur) merged.push(cur);
  return merged;
}

// è®¡ç®—å‰”é™¤æ¥æºæ˜ç»†ï¼šè¿”å›æ•°ç»„ [{labelKey,label,start,end,removedSec}]
function buildExcludedBreakdown(dateStr, rawIntervals){
  const d=new Date(dateStr+"T00:00:00");
  if(isNaN(d)) return [];
  const wd=d.getDay();
  let segs=[...BREAK_SCHEDULE.common];
  if(wd===3) segs.push(...BREAK_SCHEDULE.wed); else if(wd>=1&&wd<=5) segs.push(...BREAK_SCHEDULE.monTueThuFri);
  const dayStart=d.getTime();
  // åˆå¹¶åŸå§‹åŒºé—´ï¼Œé¿å…é‡å¤ç´¯è®¡ï¼ˆå‡ºç° 20 -> 40 åˆ†é’Ÿç­‰ç¿»å€é—®é¢˜ï¼‰
  const merged=(function(){
    if(!rawIntervals||!rawIntervals.length) return [];
    const arr=rawIntervals.slice().sort((a,b)=>a.start-b.start);
    const out=[{start:arr[0].start,end:arr[0].end}];
    for(let i=1;i<arr.length;i++){
      const last=out[out.length-1],cur=arr[i];
      if(cur.start<=last.end){ if(cur.end>last.end) last.end=cur.end; }
      else out.push({start:cur.start,end:cur.end});
    }
    return out;
  })();
  const breakAbs=segs.map(s=>({
    labelKey:s.labelKey,label:t(s.labelKey,s.labelKey),
    start:dayStart+s.start*60000,
    end:dayStart+s.end*60000,
    segMinutes:s.end-s.start
  }));
  // å¤œé—´ä¸å†åŠ å…¥å‰”é™¤ç»Ÿè®¡ï¼ˆ21:30 åä¸é‡‡é›† / å·²è¢«è£å‰ªï¼‰
  const result=[];
  breakAbs.forEach(seg=>{
    let removed=0;
    merged.forEach(iv=>{const s=Math.max(iv.start,seg.start);const e=Math.min(iv.end,seg.end); if(e>s) removed+=e-s;});
    if(removed>0){
      const removedSec=Math.floor(removed/1000);
      result.push({...seg,removedSec,mergedCount:merged.length});
      // å¦‚æœæœªè¾¾åˆ°æ•´ä¸ªä¼‘æ¯æ®µé•¿åº¦ï¼Œè®°å½•è°ƒè¯•æç¤º
      const fullMs=seg.segMinutes*60000;
      if(removed<fullMs){
        console.debug('[ExcludedBreakdown][partial]', {date:dateStr,label:seg.labelKey,expectedMin:seg.segMinutes,actualMin:(removedSec/60).toFixed(2)});
      }
    }
  });
  return result.sort((a,b)=>a.start-b.start);
}
function getCleanedIntervals(studentName,dateStr){
  const isToday=dateStr===formatDate(new Date());
  let original = isToday? getStudentTodayIntervals(studentName): getHistoryIntervals(studentName,dateStr);
  // è¿‡æ»¤é—ç•™ summary é‡å»ºä¼ªåŒºé—´ï¼šæœ‰ type inSlot/outSlot ä¸”æ—  __sourceTag
  if(original && original.length){
    const before=original.length;
    original = original.filter(iv=>{
      if((iv.type==='inSlot'||iv.type==='outSlot') && !iv.__sourceTag){ return false; }
      return true;
    });
    if(before!==original.length){
      console.warn('[filter-summary-rebuild] removed legacy intervals', {student:studentName,date:dateStr,before,after:original.length});
    }
  }
  const clipped = clipPracticeIntervals(dateStr, original||[]);
  return {raw:clipped, cleaned: subtractExcludedFromIntervals(dateStr, clipped)};
}
function calcOverlapSeconds(intervals, slotStartMs, slotEndMs){
  if(!intervals||!intervals.length) return 0;
  const merged=[]; // merge overlapping parts inside slot window
  for(const iv of intervals){
    const st=Math.max(iv.start,slotStartMs);const en=Math.min(iv.end,slotEndMs);if(en<=st) continue;merged.push({start:st,end:en});
  }
  if(!merged.length) return 0;
  merged.sort((a,b)=>a.start-b.start);
  const stack=[merged[0]];
  for(let i=1;i<merged.length;i++){const cur=merged[i],last=stack[stack.length-1];if(cur.start<=last.end){last.end=Math.max(last.end,cur.end);}else stack.push(cur);} 
  let ms=0;stack.forEach(m=>ms+=m.end-m.start);
  const slotMs=slotEndMs-slotStartMs; if(ms>slotMs) ms=slotMs; return Math.floor(ms/1000);
}
// è®¡ç®—åŒºé—´å¹¶é›†ç§’æ•°ï¼ˆé¿å…é‡å åŒè®¡ï¼‰
function calcUnionSeconds(intervals){
  if(!intervals||!intervals.length) return 0;
  const list=intervals.map(iv=>({start:iv.start,end:iv.end})).sort((a,b)=>a.start-b.start);
  let total=0;let cur=list[0];
  for(let i=1;i<list.length;i++){
    const n=list[i];
    if(n.start<=cur.end){ if(n.end>cur.end) cur.end=n.end; }
    else { total+=Math.max(0,cur.end-cur.start); cur={start:n.start,end:n.end}; }
  }
  total+=Math.max(0,cur.end-cur.start);
  return Math.floor(total/1000);
}
function computeDayInOut(studentName,dateStr){
  const {raw,cleaned}=getCleanedIntervals(studentName,dateStr);
  const __rawSource = (raw && raw.length && raw[0].__sourceTag) ? raw[0].__sourceTag : undefined;
  const wd=new Date(dateStr).getDay();
  const map={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};const key=map[wd];
  const slots=(key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key])? studentTimeSlots[studentName][key]:[];
  // 1) è®¡ç®—æ®µå†…ç§’(inSec)
  let inSec=0;const slotWindows=slots.map(sl=>({start:new Date(`${dateStr}T${sl.start}:00`).getTime(),end:new Date(`${dateStr}T${sl.end}:00`).getTime()}));
  slotWindows.forEach(sw=>{inSec+=calcOverlapSeconds(cleaned,sw.start,sw.end);});
  // 2) totalSec ä½¿ç”¨ cleaned åŒºé—´å¹¶é›†ï¼ˆé¿å…é‡å ï¼‰
  const totalSec=calcUnionSeconds(cleaned);
  // 3) è®¡ç®— outIntervals = cleaned åŒºé—´å·®é›† slotWindows å¹¶é›†
  function diffIntervals(base, subtract){
    if(!base.length) return [];
    const sub = (function(){
      if(!subtract.length) return [];
      const arr=[...subtract].sort((a,b)=>a.start-b.start);
      const merged=[{start:arr[0].start,end:arr[0].end}];
      for(let i=1;i<arr.length;i++){const last=merged[merged.length-1],cur=arr[i];if(cur.start<=last.end){ if(cur.end>last.end) last.end=cur.end; } else merged.push({start:cur.start,end:cur.end});}
      return merged;
    })();
    if(!sub.length) return base.map(iv=>({start:iv.start,end:iv.end}));
    const result=[];
    base.forEach(iv=>{
      let segments=[{start:iv.start,end:iv.end}];
      sub.forEach(rm=>{
        const next=[];segments.forEach(seg=>{
          if(seg.end<=rm.start || seg.start>=rm.end) { next.push(seg); }
          else {
            if(seg.start<rm.start) next.push({start:seg.start,end:rm.start});
            if(seg.end>rm.end) next.push({start:rm.end,end:seg.end});
          }
        });segments=next; if(!segments.length) return;});
      segments.forEach(sg=>{ if(sg.end-sg.start>=1000) result.push(sg); });
    });
    // merge result
    if(!result.length) return [];
    result.sort((a,b)=>a.start-b.start);
    const merged=[result[0]];for(let i=1;i<result.length;i++){const last=merged[merged.length-1],cur=result[i];if(cur.start<=last.end){ if(cur.end>last.end) last.end=cur.end; } else merged.push(cur);}return merged;
  }
  const cleanedUnion=(function(){ if(!cleaned.length) return []; const arr=cleaned.map(iv=>({start:iv.start,end:iv.end})).sort((a,b)=>a.start-b.start); const merged=[arr[0]]; for(let i=1;i<arr.length;i++){const last=merged[merged.length-1],cur=arr[i]; if(cur.start<=last.end){ if(cur.end>last.end) last.end=cur.end; } else merged.push(cur);} return merged; })();
  const outIntervals=diffIntervals(cleanedUnion,slotWindows).map(m=>({start:m.start,end:m.end,durationSec:Math.floor((m.end-m.start)/1000)}));
  const outSec=outIntervals.reduce((s,iv)=>s+iv.durationSec,0);
  // ä¸€è‡´æ€§æ£€æŸ¥
  const expectOut=Math.max(0,totalSec-inSec);
  if(Math.abs(expectOut-outSec)>5){
    console.debug('[computeDayInOut][mismatch]', {student:studentName,date:dateStr,inSec,totalSec,outSec,expectOut,slots:slotWindows.length,cleaned:cleanedUnion});
  }
  if(wd>=1&&wd<=5 && totalSec>0 && slots.length===0){console.warn('[computeDayInOut] slots ç¼ºå¤±ï¼Œå…¨éƒ¨æˆä¸ºæ®µå¤–', {student:studentName,date:dateStr,totalSec});}
  const breakdown=buildExcludedBreakdown(dateStr, raw);
  const rawUnionSec=calcUnionSeconds(raw);
  const cleanUnionSec=calcUnionSeconds(cleaned);
  const excludedSecUnion=Math.max(0,rawUnionSec-cleanUnionSec);
  return {inSec,outSec,totalSec,rawIntervals:raw,cleanIntervals:cleaned,excludedBreakdown:breakdown,outIntervals,excludedSecUnion,source:__rawSource};
}

// è°ƒè¯•ï¼šè¾“å‡ºæŸå­¦ç”ŸæŸæ—¥åŸå§‹/æ¸…æ´—åŒºé—´ä¸æ¥æº
window.debugStudentDayRaw = function(name,dateStr){
  try{
    const dio = computeDayInOut(name,dateStr);
    console.group(`[debugStudentDayRaw] ${name} ${dateStr}`);
    console.log('source', dio.source);
    console.log('rawIntervals', dio.rawIntervals);
    console.log('cleanIntervals', dio.cleanIntervals);
    console.log('outIntervals', dio.outIntervals);
    console.log('excludedBreakdown', dio.excludedBreakdown);
    console.log('inSec/outSec/totalSec', dio.inSec, dio.outSec, dio.totalSec);
    console.groupEnd();
    return dio;
  }catch(e){console.error('[debugStudentDayRaw] error', e);}
}

// æ˜¾ç¤ºæŸæ—¥å‰”é™¤æ¥æºæ˜ç»†
function createCenterModal(contentHTML, title){
  // è‹¥å·²æœ‰åŒç±»å‹ modal å…ˆç§»é™¤
  const existing=document.querySelector('.center-pop-modal-overlay');
  if(existing) existing.remove();
  const overlay=document.createElement('div');
  overlay.className='center-pop-modal-overlay';
  overlay.innerHTML=`<div class="center-pop-modal" role="dialog" aria-modal="true">\n    <button class='close-btn' aria-label='close'>&times;</button>\n    <h4>${title}</h4>\n    <div class='center-pop-modal-body'>${contentHTML}</div>\n  </div>`;
  document.body.appendChild(overlay);
  requestAnimationFrame(()=>overlay.classList.add('show'));
  const close=()=>{overlay.classList.remove('show');setTimeout(()=>overlay.remove(),180);} ;
  overlay.addEventListener('click',e=>{ if(e.target===overlay) close(); });
  overlay.querySelector('.close-btn').addEventListener('click',close);
  document.addEventListener('keydown',function esc(e){ if(e.key==='Escape'){close();document.removeEventListener('keydown',esc);} });
  
  // ğŸ”§ ä¿®å¤ï¼šè¿”å›æ¨¡æ€æ¡†å†…å®¹å®¹å™¨ï¼Œä»¥ä¾¿å¤–éƒ¨å¯ä»¥æ“ä½œ
  const modal = overlay.querySelector('.center-pop-modal');
  return modal;
}
function showExcludedBreakdown(_anchor,dateStr){
  const name=window.__currentDetailStudent||''; if(!name) return;
  try{
    const dio=computeDayInOut(name,dateStr);const list=dio.excludedBreakdown||[];
  const totalMin=Math.round((dio.excludedSecUnion/60)*10)/10;
  const rows=list.map(seg=>{const start=new Date(seg.start),end=new Date(seg.end);const fmt=(d)=>`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;let mm=Math.round(seg.removedSec/60*10)/10; if(Math.abs(mm-Math.round(mm))<0.05) mm=Math.round(mm);return `<tr><td>${t(seg.labelKey,seg.label)}</td><td style='white-space:nowrap;'>${fmt(start)} - ${fmt(end)}</td><td style='text-align:right;'>${mm}min</td></tr>`;}).join('') || `<tr><td colspan='3' style='text-align:center;color:#888;'>0</td></tr>`;
  const note=`<div style='font-size:12px;line-height:1.5;margin:0 0 8px;color:#888;'>è¯´æ˜ï¼šå‰”é™¤æ—¶é—´ = è¯¾é—´ / å¤§è¯¾é—´ / åˆé¤${t('break.short.lunch_concert','åˆé¤æ—¶é—´+åˆé—´éŸ³ä¹ä¼š')?'/åˆé—´éŸ³ä¹ä¼š':''} / æ™šé¤ ç­‰ä¸è®¡å…¥ç»ƒç´ç»Ÿè®¡çš„æ—¶é—´ã€‚<br>æœ¬æ—¥å‰”é™¤åˆè®¡ï¼š<b>${totalMin} min</b></div>`;
  createCenterModal(`${note}<table>${rows}</table>`, `${dateStr} ${t('break.excluded_minutes','å‰”é™¤åˆ†é’Ÿ')}`);
  }catch(e){console.error('showExcludedBreakdown error',e);}
}
function showOutSlotBreakdown(_anchor,dateStr){
  const name=window.__currentDetailStudent||''; if(!name) return;
  try{
    const dio=computeDayInOut(name,dateStr);const list=dio.outIntervals||[];
    const rows=list.map(iv=>{const s=new Date(iv.start),e=new Date(iv.end);const fmt=(d)=>`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;const mm=Math.round(iv.durationSec/60*10)/10;return `<tr><td>${fmt(s)} - ${fmt(e)}</td><td style='text-align:right;'>${mm%1===0?mm:mm.toFixed(1)}min</td></tr>`;}).join('') || `<tr><td colspan='2' style='text-align:center;color:#888;'>0</td></tr>`;
    createCenterModal(`<table>${rows}</table>`, `${dateStr} ${t('practice.out_slot_segments','æ®µå¤–ç»ƒç´åŒºé—´')}`);
  }catch(e){console.error('showOutSlotBreakdown error',e);}
}


/* =============== æ¨¡æ€æ¡†ä¼˜åŒ–æ§åˆ¶ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒå¤–éƒ¨ç‚¹å‡»ã€ä¸‹æ»‘å…³é—­å’Œä¸æ»‘å‘ä¸‹å…³é—­ï¼‰ =============== */

// ğŸ”¥ å…¨å±€å˜é‡ï¼šè§¦æ‘¸ç›¸å…³
let modalTouchStartY = 0;
let modalTouchStartTime = 0;
let modalInitialScrollTop = 0;
let isModalDragging = false;
let modalTouchStartX = 0;

function closeModal(id) {
  const ids = id ? [id] : ['studentDetailModal', 'attendanceDetailModal'];
  let closed = false;
  let maxDelay = 0;
  ids.forEach(cid => {
    const el = document.getElementById(cid);
    if (el && el.classList.contains('show')) {
      el.classList.remove('show');
      el.classList.add('hiding');
      const isMobile = window.innerWidth <= 768;
      const delay = isMobile ? 200 : 180;
      if (delay > maxDelay) maxDelay = delay;
      setTimeout(() => {
        el.style.display = 'none';
        el.classList.remove('hiding');
        cleanupModalEventListeners(el);
        const modalContent = el.querySelector('.modal-content');
        if (modalContent) modalContent.style.cssText = '';
        el.style.cssText = '';
      }, delay);
      closed = true;
    }
  });
  if (closed) {
    // ä»…å½“æ²¡æœ‰å…¶å®ƒä»åœ¨æ˜¾ç¤º/å…³é—­åŠ¨ç”»ä¸­çš„æ¨¡æ€æ¡†æ—¶æ‰æ¢å¤ bodyï¼Œé¿å…å åŠ å…³é—­å‡ºç°é—ªçƒ
    setTimeout(() => {
      const anyActive = Array.from(document.querySelectorAll('.modal'))
        .some(m => m.classList.contains('show') || m.classList.contains('hiding'));
      if (!anyActive) {
        document.body.classList.remove('modal-open');
        if (document.body.dataset.scrollY) {
          const scrollY = document.body.dataset.scrollY;
          document.body.style.cssText = '';
          window.scrollTo(0, parseInt(scrollY));
          delete document.body.dataset.scrollY;
        }
      }
    }, maxDelay + 20); // ç­‰å¾…æœ€é•¿å…³é—­åŠ¨ç”»ç»“æŸ
  }
}

// ğŸ”¥ å¢å¼ºç‰ˆï¼šæ”¯æŒiOSé£æ ¼ä¸‹æ‹‰æ‰‹åŠ¿å…³é—­
function setupModalEventListeners(modal) {
    const modalContent = modal.querySelector('.modal-content');
    
    // å¤–éƒ¨ç‚¹å‡»å…³é—­
    const handleBackdropClick = (e) => {
        if (e.target === modal) {
            closeModal(modal.id);
        }
    };
    
    // ESCé”®å…³é—­
    const handleKeyDown = (e) => {
        if (e.key === 'Escape') {
            closeModal(modal.id);
        }
    };
    
    // ğŸ”¥ iOSé£æ ¼ä¸‹æ‹‰æ‰‹åŠ¿å…³é—­
    let touchStartY = 0;
    let touchStartTime = 0;
    let isDragging = false;
    let initialModalTop = 0;
    
    const handleTouchStart = (e) => {
        if (!modalContent.contains(e.target)) return;
        
        const modalTop = modalContent.scrollTop;
        // åªæœ‰åœ¨æ¨¡æ€æ¡†å†…å®¹æ»šåŠ¨åˆ°é¡¶éƒ¨æ—¶æ‰å¼€å§‹ä¸‹æ‹‰æ£€æµ‹
        if (modalTop > 0) return;
        
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
        isDragging = false;
        initialModalTop = 0;
        
        modalContent.style.transition = 'none';
    };
    
    const handleTouchMove = (e) => {
        if (!modalContent.contains(e.target)) return;
        if (modalContent.scrollTop > 0) return;
        
        const currentY = e.touches[0].clientY;
        const deltaY = currentY - touchStartY;
        
        // åªå“åº”å‘ä¸‹æ‹–æ‹½
        if (deltaY > 10) {
            isDragging = true;
            e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
            
            // iOSé£æ ¼é˜»å°¼æ•ˆæœï¼šä¸‹æ‹‰è·ç¦»éšç€æ‹–æ‹½è·ç¦»å¢åŠ è€Œå‡ç¼“
            const dampedDelta = Math.pow(deltaY * 0.6, 0.8);
            const scale = Math.max(0.95, 1 - dampedDelta * 0.0003);
            const opacity = Math.max(0.3, 1 - dampedDelta * 0.002);
            
            modalContent.style.transform = `translateY(${dampedDelta}px) scale(${scale})`;
            modal.style.backgroundColor = `rgba(0, 0, 0, ${0.5 * opacity})`;
        }
    };
    
    const handleTouchEnd = (e) => {
        if (!isDragging) return;
        
        const currentY = e.changedTouches[0].clientY;
        const deltaY = currentY - touchStartY;
        const deltaTime = Date.now() - touchStartTime;
        const velocity = deltaY / deltaTime; // px/ms
        
        // iOSé£æ ¼å…³é—­åˆ¤æ–­ï¼šä¸‹æ‹‰è·ç¦» > 120px æˆ– é€Ÿåº¦ > 0.5px/ms
        const shouldClose = deltaY > 120 || velocity > 0.5;
        
        if (shouldClose) {
            // è§¦å‘å…³é—­åŠ¨ç”»
            closeModal(modal.id);
        } else {
            // å›å¼¹åˆ°åŸä½
            modalContent.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            modalContent.style.transform = 'translateY(0) scale(1)';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            // æ¸…ç†è¿‡æ¸¡æ•ˆæœ
            setTimeout(() => {
                modalContent.style.transition = '';
            }, 300);
        }
        
        isDragging = false;
    };
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    modal.addEventListener('click', handleBackdropClick);
    document.addEventListener('keydown', handleKeyDown);
    
    // ğŸ”¥ æ·»åŠ è§¦æ‘¸äº‹ä»¶ï¼ˆä»…ç§»åŠ¨ç«¯ï¼‰
    if ('ontouchstart' in window) {
        modalContent.addEventListener('touchstart', handleTouchStart, { passive: false });
        modalContent.addEventListener('touchmove', handleTouchMove, { passive: false });
        modalContent.addEventListener('touchend', handleTouchEnd, { passive: false });
    }
    
    // ğŸ”¥ å­˜å‚¨äº‹ä»¶å¤„ç†å™¨å¼•ç”¨
    modal._eventHandlers = {
        handleBackdropClick,
        handleKeyDown,
        handleTouchStart,
        handleTouchMove,
        handleTouchEnd
    };
}


// openModalSmooth å’Œ cleanupModalEventListeners å‡½æ•°ä¿æŒä¸å˜
function openModalSmooth(modalId, contentHtml) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    if (contentHtml) {
        modal.querySelector('.modal-content').innerHTML = contentHtml;
    }
    
    if (!document.body.classList.contains('modal-open')) {
        const scrollY = window.scrollY;
        document.body.dataset.scrollY = scrollY;
        document.body.style.cssText = `
            position: fixed !important;
            top: -${scrollY}px !important;
            width: 100% !important;
            overflow: hidden !important;
        `;
    }
    document.body.classList.add('modal-open');
    
    modal.style.display = 'flex';
    setupModalEventListeners(modal);
    
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            modal.classList.add('show');
        });
    });
}

function cleanupModalEventListeners(modal) {
    if (!modal._eventHandlers) return;
    
    const {
        handleBackdropClick,
        handleKeyDown,
        handleTouchStart,
        handleTouchMove,
        handleTouchEnd
    } = modal._eventHandlers;
    
    const modalContent = modal.querySelector('.modal-content');
    
    modal.removeEventListener('click', handleBackdropClick);
    document.removeEventListener('keydown', handleKeyDown);
    
    // ğŸ”¥ æ¸…ç†è§¦æ‘¸äº‹ä»¶
    if (modalContent && 'ontouchstart' in window) {
        modalContent.removeEventListener('touchstart', handleTouchStart);
        modalContent.removeEventListener('touchmove', handleTouchMove);
        modalContent.removeEventListener('touchend', handleTouchEnd);
    }
    
    delete modal._eventHandlers;
    
    // ğŸ”¥ æ¸…ç†æ ·å¼
    modal.style.transition = '';
    modal.style.backgroundColor = '';
    if (modalContent) {
        modalContent.style.transition = '';
        modalContent.style.transform = '';
        modalContent.style.opacity = '';
    }
}

/* =============== ğŸš€ æ•°æ®ä¼ è¾“ä¼˜åŒ–æ¨¡å— =============== */

// æ•°æ®ç‰ˆæœ¬æ§åˆ¶å’Œå·®é‡åŒæ­¥
const DataSyncOptimizer = {
  // æœ¬åœ°æ•°æ®ç‰ˆæœ¬ç¼“å­˜
  localVersions: {
    rooms: null,
    studentDatabase: null,
    excuseData: null,
    studentTimeSlots: null,
    attendanceRecords: {},
    practiceRecords: {}
  },
  
  // å˜æ›´æ£€æµ‹é˜Ÿåˆ—
  pendingChanges: new Map(),
  
  // å‹ç¼©ä¼ è¾“é…ç½®
  compressionEnabled: true,
  batchSize: 50, // æ‰¹é‡ä¼ è¾“å¤§å°
  
  // ç½‘ç»œçŠ¶æ€ç›‘æµ‹
  networkQuality: 'good', // 'poor', 'moderate', 'good'
  lastBandwidthTest: 0,
  
  // åˆå§‹åŒ–æ•°æ®ç‰ˆæœ¬
  initVersions() {
    try {
      const cached = localStorage.getItem('dataVersions');
      if (cached) {
        this.localVersions = { ...this.localVersions, ...JSON.parse(cached) };
      }
    } catch (e) {
      console.warn('ç‰ˆæœ¬ç¼“å­˜åŠ è½½å¤±è´¥:', e);
    }
  },
  
  // ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
  saveVersions() {
    try {
      localStorage.setItem('dataVersions', JSON.stringify(this.localVersions));
    } catch (e) {
      console.warn('ç‰ˆæœ¬ç¼“å­˜ä¿å­˜å¤±è´¥:', e);
    }
  },
  
  // è®¡ç®—æ•°æ®å“ˆå¸Œå€¼ç”¨äºå˜æ›´æ£€æµ‹
  getDataHash(data) {
    if (!data) return null;
    const str = JSON.stringify(data);
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // Convert to 32bit integer
    }
    return hash.toString(36);
  },
  
  // æ£€æµ‹æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´
  hasChanged(dataType, newData) {
    const newHash = this.getDataHash(newData);
    const oldHash = this.localVersions[dataType];
    return newHash !== oldHash;
  },
  
  // æ ‡è®°æ•°æ®å·²æ›´æ–°
  markUpdated(dataType, data) {
    const newHash = this.getDataHash(data);
    this.localVersions[dataType] = newHash;
    this.saveVersions();
  },
  
  // ç½‘ç»œè´¨é‡æ£€æµ‹
  async detectNetworkQuality() {
    const now = Date.now();
    if (now - this.lastBandwidthTest < 60000) return this.networkQuality; // 1åˆ†é’Ÿå†…ä¸é‡å¤æµ‹è¯•
    
    try {
      const start = performance.now();
      await fetch('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js?t=' + now, { 
        method: 'HEAD',
        cache: 'no-cache'
      });
      const duration = performance.now() - start;
      
      if (duration < 100) this.networkQuality = 'good';
      else if (duration < 500) this.networkQuality = 'moderate';
      else this.networkQuality = 'poor';
      
      this.lastBandwidthTest = now;
      console.log(`ğŸŒ ç½‘ç»œè´¨é‡æ£€æµ‹: ${this.networkQuality} (${Math.round(duration)}ms)`);
    } catch (e) {
      this.networkQuality = 'poor';
      console.warn('ç½‘ç»œè´¨é‡æ£€æµ‹å¤±è´¥:', e);
    }
    
    return this.networkQuality;
  },
  
  // æ™ºèƒ½åŒæ­¥ç­–ç•¥
  getSyncStrategy() {
    const quality = this.networkQuality;
    return {
      useCompression: quality === 'poor',
      batchSize: quality === 'poor' ? 20 : quality === 'moderate' ? 50 : 100,
      syncInterval: quality === 'poor' ? 10000 : quality === 'moderate' ? 5000 : 2000,
      enableDelta: true,
      prioritizeUpdates: quality === 'poor' ? ['rooms'] : ['rooms', 'studentDatabase'],
    };
  },
  
  // åˆ›å»ºç²¾ç®€æ•°æ®åŒ…ï¼ˆåªåŒ…å«å¿…è¦å­—æ®µï¼‰
  createMinimalPayload(data, dataType) {
    if (!data) return null;
    
    switch (dataType) {
      case 'rooms':
        return Array.isArray(data) ? data.map(room => ({
          name: room.name,
          student: room.student,
          registerTime: room.registerTime,
          clearTime: room.clearTime,
          lastModified: room.lastModified || Date.now()
        })) : data;
        
      case 'studentDatabase':
        // åªåŒæ­¥å¿…è¦çš„å­¦ç”Ÿä¿¡æ¯å­—æ®µ
        const minimal = {};
        Object.keys(data).forEach(key => {
          const student = data[key];
          minimal[key] = {
            name: student.name,
            major: student.major,
            grade: student.grade,
            lastUpdated: student.lastUpdated || Date.now()
          };
        });
        return minimal;
        
      default:
        return data;
    }
  }
};

// åˆå§‹åŒ–æ•°æ®åŒæ­¥ä¼˜åŒ–å™¨
DataSyncOptimizer.initVersions();

/* =============== Firebase åˆå§‹åŒ–ä¸ç›‘å¬ =============== */
function initFirebase(){
  try{
    firebase.initializeApp(firebaseConfig);
    database=firebase.database();
    
    // ğŸš€ ä¼˜åŒ–ï¼šè¿æ¥çŠ¶æ€ç›‘å¬
    database.ref('.info/connected').on('value',snap=>{
      isOnline=snap.val()===true;
      updateConnectionStatus();
      if(isOnline){
        addSyncLog('âœ… å·²è¿æ¥äº‘ç«¯');
        // ğŸš€ ä¼˜åŒ–ï¼šæ£€æµ‹ç½‘ç»œè´¨é‡å¹¶è°ƒæ•´åŒæ­¥ç­–ç•¥
        DataSyncOptimizer.detectNetworkQuality().then(() => {
          const strategy = DataSyncOptimizer.getSyncStrategy();
          addSyncLog(`ğŸŒ ç½‘ç»œè´¨é‡: ${DataSyncOptimizer.networkQuality}, åŒæ­¥ç­–ç•¥å·²è°ƒæ•´`);
          loadAllCoreData();
        });
      }else addSyncLog('âš ï¸ å·²ç¦»çº¿');
    });
    
    // ğŸš€ ä¼˜åŒ–ï¼šæˆ¿é—´çŠ¶æ€æ™ºèƒ½ç›‘å¬ï¼ˆä»…åœ¨å¿…è¦æ—¶æ›´æ–°ï¼‰
    database.ref('rooms').on('value',snap=>{
      const v=snap.val();
      if(Array.isArray(v)){
        // æ£€æŸ¥æ˜¯å¦çœŸçš„å‘ç”Ÿäº†å˜æ›´
        if(DataSyncOptimizer.hasChanged('rooms', v)){
          addSyncLog('ğŸ“¥ æˆ¿é—´çŠ¶æ€å·²æ›´æ–°');
          rooms=v;
          DataSyncOptimizer.markUpdated('rooms', v);
          buildRealTimePracticeFromRooms();
          if(currentTab==='dashboard')renderPracticeArea();
          updateStatsPanel();
        } else {
          // æ•°æ®æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æ›´æ–°
          console.log('ğŸ”„ æˆ¿é—´æ•°æ®æ— å˜æ›´ï¼Œè·³è¿‡æ›´æ–°');
        }
      }
    });
    
    // ğŸš€ ä¼˜åŒ–ï¼šå­¦ç”Ÿæ•°æ®åº“æ™ºèƒ½ç›‘å¬
    database.ref('studentDatabase').on('value',snap=>{
      const v=snap.val();
      if(v){
        if(DataSyncOptimizer.hasChanged('studentDatabase', v)){
          addSyncLog('ğŸ“¥ å­¦ç”Ÿæ•°æ®åº“å·²æ›´æ–°');
          studentDatabase=v;
          DataSyncOptimizer.markUpdated('studentDatabase', v);
          populateFilters();
          if(currentTab==='students')renderStudentList();
          updateStatsPanel();
          if(typeof scheduleLeaderboardUpdate==='function') scheduleLeaderboardUpdate();
        } else {
          console.log('ğŸ”„ å­¦ç”Ÿæ•°æ®åº“æ— å˜æ›´ï¼Œè·³è¿‡æ›´æ–°');
        }
      }
    });
    
    // ğŸš€ ä¼˜åŒ–ï¼šè¯·å‡æ•°æ®æŒ‰éœ€ç›‘å¬ï¼ˆä»…å½“å‰æ—¥æœŸï¼‰
    const todayKey = getTodayDateString();
    database.ref(`excuseData/${todayKey}`).on('value',snap=>{
      const v=snap.val();
      if(v !== undefined){
        const currentExcuses = excuseData[todayKey] || {};
        const newHash = DataSyncOptimizer.getDataHash(v);
        const oldHash = DataSyncOptimizer.getDataHash(currentExcuses);
        
        if(newHash !== oldHash){
          addSyncLog(`ğŸ“¥ ä»Šæ—¥è¯·å‡æ•°æ®å·²æ›´æ–° (${todayKey})`);
          if(!excuseData) excuseData = {};
          excuseData[todayKey] = v || {};
          if(currentTab==='dashboard')renderExcusePanel();
          updateStatsPanel();
        }
      }
    });
    
    // ğŸš€ ä¼˜åŒ–ï¼šå­¦ç”Ÿæ—¶é—´æ®µæ™ºèƒ½ç›‘å¬
    database.ref('studentTimeSlots').on('value',snap=>{
      const raw = snap.val()||{};
      if(DataSyncOptimizer.hasChanged('studentTimeSlots', raw)){
        const beforeCnt = Object.values(raw).reduce((sum,s)=>sum + ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'].reduce((c,k)=>c + (s&&s[k]? s[k].length:0),0),0);
        studentTimeSlots = normalizeStudentTimeSlots(raw);
        DataSyncOptimizer.markUpdated('studentTimeSlots', raw);
        const afterCnt = Object.values(studentTimeSlots).reduce((sum,s)=>sum + ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'].reduce((c,k)=>c + (s&&s[k]? s[k].length:0),0),0);
        addSyncLog(`ğŸ“¥ å­¦ç”Ÿæ—¶é—´æ®µå·²æ›´æ–° (å½’ä¸€åŒ– ${beforeCnt} -> ${afterCnt})`);
        if(typeof scheduleLeaderboardUpdate==='function') scheduleLeaderboardUpdate();
        
        // åˆ·æ–°å­¦ç”Ÿè¯¦æƒ…ï¼ˆå¦‚æœå·²æ‰“å¼€ï¼‰
        const modal=document.getElementById('studentDetailModal');
        if(modal&&modal.style.display==='flex'){
          const title=document.getElementById('studentDetailTitle');
          if(title){
            const nm=title.textContent.split(' - ')[0];
            if(nm){
              console.log('[studentTimeSlots] refresh detail for',nm);
              openStudentDetail(nm);
            }
          }
        }
        updateStatsPanel();
      } else {
        console.log('ğŸ”„ å­¦ç”Ÿæ—¶é—´æ®µæ— å˜æ›´ï¼Œè·³è¿‡æ›´æ–°');
      }
    });
    
    // ğŸš€ ä¼˜åŒ–ï¼šè€ƒå‹¤è®°å½•æŒ‰éœ€ç›‘å¬ï¼ˆä»…æœ€è¿‘30å¤©ï¼‰
    database.ref('attendanceRecords').on('value',snap=>{
      const v=snap.val();
      if(v&&typeof v==='object'){
        const cutoff=new Date();cutoff.setDate(cutoff.getDate()-30);
        const cutoffStr=formatDate(cutoff);
        let hasUpdates = false;
        
        Object.keys(v).forEach(d=>{
          if(d>=cutoffStr){
            const newHash = DataSyncOptimizer.getDataHash(v[d]);
            const oldHash = DataSyncOptimizer.getDataHash(attendanceRecordsCache[d]);
            
            if(newHash !== oldHash){
              attendanceRecordsCache[d]=v[d];
              hasUpdates = true;
            }
          }
        });
        
        if(hasUpdates){
          addSyncLog('ğŸ“¥ è€ƒå‹¤è®°å½•å·²æ›´æ–°ï¼ˆä»…å˜æ›´éƒ¨åˆ†ï¼‰');
          if(currentTab==='students')renderStudentList();
        }
      }
    });
    
    // ğŸš€ ä¼˜åŒ–ï¼šç»ƒç´è®°å½•æŒ‰éœ€ç›‘å¬ï¼ˆä»…æœ€è¿‘7å¤©ï¼‰
    database.ref('practiceRecords').on('value',snap=>{
      const v=snap.val();
      if(v&&typeof v==='object'){
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const cutoffStr = formatDate(sevenDaysAgo);
        let hasUpdates = false;
        
        Object.keys(v).forEach(dateKey=>{
          if(dateKey >= cutoffStr){
            if(!dailyPracticeRecords[dateKey])dailyPracticeRecords[dateKey]={};
            
            Object.keys(v[dateKey]).forEach(student=>{
              const cloud=v[dateKey][student];
              const local=dailyPracticeRecords[dateKey][student];
              if(!local||cloud.lastUpdated>local.lastUpdated){
                dailyPracticeRecords[dateKey][student]=cloud;
                hasUpdates = true;
                try{
                  localStorage.setItem('practiceRecords_'+dateKey,JSON.stringify(dailyPracticeRecords[dateKey]));
                }catch(e){}
              }
            });
          }
        });
        
        if(hasUpdates){
          addSyncLog('ğŸ“¥ ç»ƒç´è®°å½•å·²æ›´æ–°ï¼ˆä»…æ–°æ•°æ®ï¼‰');
          try{ setLeaderboardDirty(); }catch(e){}
        }
      }
    });

    // ğŸš€ å¢å¼ºï¼šå®šæœŸæ¸…ç†è¿‡æœŸæœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´
    setInterval(()=>{
      const cutoff=new Date();cutoff.setDate(cutoff.getDate()-30);const cut=formatDate(cutoff);
      let cleanedCount = 0;
      
      // æ¸…ç†è¿‡æœŸè€ƒå‹¤è®°å½•
      Object.keys(attendanceRecordsCache).forEach(d=>{
        if(d<cut){
          delete attendanceRecordsCache[d];
          cleanedCount++;
        }
      });
      
      // æ¸…ç†è¿‡æœŸç»ƒç´è®°å½•
      Object.keys(dailyPracticeRecords).forEach(d=>{
        if(d<cut){
          delete dailyPracticeRecords[d];
          localStorage.removeItem('practiceRecords_'+d);
          cleanedCount++;
        }
      });
      
      // ğŸš€ æ–°å¢ï¼šæ™ºèƒ½ç¼“å­˜ä¼˜åŒ–
      SmartCacheManager.performMaintenance();
      
      if(cleanedCount > 0){
        addSyncLog(`ğŸ§¹ å·²æ¸…ç† ${cleanedCount} ä¸ªè¿‡æœŸæ•°æ®ç¼“å­˜`);
      }
    },24*60*60*1000);

    // ğŸš€ æ–°å¢ï¼šæ™ºèƒ½ç¼“å­˜é¢„åŠ è½½ï¼ˆåŸºäºä½¿ç”¨æ¨¡å¼ï¼‰
    SmartCacheManager.preloadFrequentData();
    
  }catch(e){addSyncLog('âŒ Firebase åˆå§‹åŒ–å¤±è´¥: '+e.message);console.error(e);}
}

/* =============== ğŸ§  æ™ºèƒ½ç¼“å­˜ç®¡ç†å™¨ =============== */
const SmartCacheManager = {
  // ç¼“å­˜ç»Ÿè®¡
  cacheStats: {
    hits: 0,
    misses: 0,
    lastCleanup: Date.now()
  },
  
  // è®¿é—®é¢‘ç‡è·Ÿè¸ª
  accessFrequency: new Map(),
  
  // ç¼“å­˜ç­–ç•¥é…ç½®
  config: {
    maxCacheSize: 50 * 1024 * 1024, // 50MB
    maxEntries: 1000,
    defaultTTL: 24 * 60 * 60 * 1000, // 24å°æ—¶
    hotDataTTL: 7 * 24 * 60 * 60 * 1000, // 7å¤©ï¼ˆé¢‘ç¹è®¿é—®çš„æ•°æ®ï¼‰
    preloadDays: 7 // é¢„åŠ è½½æœ€è¿‘7å¤©çš„æ•°æ®
  },
  
  // è·å–ç¼“å­˜é”®
  getCacheKey(type, identifier) {
    return `smart_cache_${type}_${identifier}`;
  },
  
  // è®°å½•è®¿é—®é¢‘ç‡
  recordAccess(cacheKey) {
    const count = this.accessFrequency.get(cacheKey) || 0;
    this.accessFrequency.set(cacheKey, count + 1);
  },
  
  // è·å–ç¼“å­˜æ•°æ®
  get(type, identifier) {
    const cacheKey = this.getCacheKey(type, identifier);
    this.recordAccess(cacheKey);
    
    try {
      const cached = localStorage.getItem(cacheKey);
      if (!cached) {
        this.cacheStats.misses++;
        return null;
      }
      
      const data = JSON.parse(cached);
      const now = Date.now();
      
      // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
      if (data.expires && now > data.expires) {
        localStorage.removeItem(cacheKey);
        this.cacheStats.misses++;
        return null;
      }
      
      this.cacheStats.hits++;
      return data.value;
    } catch (e) {
      console.warn('ç¼“å­˜è¯»å–å¤±è´¥:', e);
      this.cacheStats.misses++;
      return null;
    }
  },
  
  // è®¾ç½®ç¼“å­˜æ•°æ®
  set(type, identifier, value, customTTL = null) {
    const cacheKey = this.getCacheKey(type, identifier);
    const accessCount = this.accessFrequency.get(cacheKey) || 0;
    
    // æ ¹æ®è®¿é—®é¢‘ç‡ç¡®å®šTTL
    let ttl = customTTL || this.config.defaultTTL;
    if (accessCount > 10) { // é¢‘ç¹è®¿é—®çš„æ•°æ®ä¿ç•™æ›´é•¿æ—¶é—´
      ttl = this.config.hotDataTTL;
    }
    
    const data = {
      value,
      created: Date.now(),
      expires: Date.now() + ttl,
      accessCount
    };
    
    try {
      localStorage.setItem(cacheKey, JSON.stringify(data));
    } catch (e) {
      console.warn('ç¼“å­˜å†™å…¥å¤±è´¥ï¼Œå¯èƒ½å­˜å‚¨ç©ºé—´ä¸è¶³:', e);
      this.performCleanup();
      try {
        localStorage.setItem(cacheKey, JSON.stringify(data));
      } catch (e2) {
        console.error('ç¼“å­˜å†™å…¥å¤±è´¥:', e2);
      }
    }
  },
  
  // æ‰§è¡Œç¼“å­˜æ¸…ç†
  performCleanup() {
    const now = Date.now();
    let removedCount = 0;
    const keys = [];
    
    // æ”¶é›†æ‰€æœ‰ç¼“å­˜é”®
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('smart_cache_')) {
        keys.push(key);
      }
    }
    
    // æŒ‰è®¿é—®é¢‘ç‡å’Œè¿‡æœŸæ—¶é—´æ’åºï¼Œä¼˜å…ˆæ¸…ç†ä¸å¸¸ç”¨çš„è¿‡æœŸæ•°æ®
    const cacheItems = keys.map(key => {
      try {
        const data = JSON.parse(localStorage.getItem(key));
        return {
          key,
          expires: data.expires,
          accessCount: data.accessCount || 0,
          size: localStorage.getItem(key).length
        };
      } catch (e) {
        return { key, expires: 0, accessCount: 0, size: 0 };
      }
    });
    
    // æ’åºï¼šè¿‡æœŸçš„ä¼˜å…ˆï¼Œç„¶åæŒ‰è®¿é—®é¢‘ç‡æ’åº
    cacheItems.sort((a, b) => {
      if (a.expires < now && b.expires >= now) return -1;
      if (a.expires >= now && b.expires < now) return 1;
      return a.accessCount - b.accessCount;
    });
    
    // æ¸…ç†è¿‡æœŸå’Œä½é¢‘è®¿é—®çš„ç¼“å­˜
    for (const item of cacheItems) {
      if (item.expires < now || removedCount < keys.length * 0.3) { // æ¸…ç†30%çš„ç¼“å­˜
        localStorage.removeItem(item.key);
        this.accessFrequency.delete(item.key);
        removedCount++;
      }
    }
    
    this.cacheStats.lastCleanup = now;
    console.log(`ğŸ§¹ æ™ºèƒ½ç¼“å­˜æ¸…ç†å®Œæˆï¼Œç§»é™¤äº† ${removedCount} ä¸ªæ¡ç›®`);
  },
  
  // ç»´æŠ¤ç¼“å­˜ï¼ˆå®šæœŸè°ƒç”¨ï¼‰
  performMaintenance() {
    const now = Date.now();
    const daysSinceCleanup = (now - this.cacheStats.lastCleanup) / (24 * 60 * 60 * 1000);
    
    if (daysSinceCleanup > 1) { // æ¯å¤©æ¸…ç†ä¸€æ¬¡
      this.performCleanup();
    }
    
    // è¾“å‡ºç¼“å­˜ç»Ÿè®¡
    if (this.cacheStats.hits + this.cacheStats.misses > 0) {
      const hitRate = (this.cacheStats.hits / (this.cacheStats.hits + this.cacheStats.misses) * 100).toFixed(1);
      console.log(`ğŸ“Š ç¼“å­˜å‘½ä¸­ç‡: ${hitRate}% (${this.cacheStats.hits}/${this.cacheStats.hits + this.cacheStats.misses})`);
    }
  },
  
  // é¢„åŠ è½½é¢‘ç¹è®¿é—®çš„æ•°æ®
  async preloadFrequentData() {
    if (!database || !isOnline) return;
    
    const today = new Date();
    const promises = [];
    
    // é¢„åŠ è½½æœ€è¿‘å‡ å¤©çš„è€ƒå‹¤æ•°æ®
    for (let i = 0; i < this.config.preloadDays; i++) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateStr = formatDate(date);
      
      // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²æœ‰æ•°æ®
      if (!this.get('attendance', dateStr)) {
        promises.push(
          database.ref(`attendanceRecords/${dateStr}`).once('value').then(snap => {
            const data = snap.val();
            if (data) {
              this.set('attendance', dateStr, data);
            }
          }).catch(e => console.warn('é¢„åŠ è½½è€ƒå‹¤æ•°æ®å¤±è´¥:', dateStr, e))
        );
      }
      
      // é¢„åŠ è½½ç»ƒç´è®°å½•
      if (!this.get('practice', dateStr)) {
        promises.push(
          database.ref(`practiceRecords/${dateStr}`).once('value').then(snap => {
            const data = snap.val();
            if (data) {
              this.set('practice', dateStr, data);
            }
          }).catch(e => console.warn('é¢„åŠ è½½ç»ƒç´æ•°æ®å¤±è´¥:', dateStr, e))
        );
      }
    }
    
    if (promises.length > 0) {
      console.log(`ğŸš€ å¼€å§‹é¢„åŠ è½½ ${promises.length} ä¸ªæ•°æ®é¡¹`);
      await Promise.allSettled(promises);
      console.log('âœ… æ•°æ®é¢„åŠ è½½å®Œæˆ');
    }
  },
  
  // è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
  getStats() {
    return {
      ...this.cacheStats,
      totalEntries: this.accessFrequency.size,
      hitRate: this.cacheStats.hits + this.cacheStats.misses > 0 ? 
        (this.cacheStats.hits / (this.cacheStats.hits + this.cacheStats.misses) * 100).toFixed(1) + '%' : '0%'
    };
  }
};

/* =============== ğŸ“¦ æ‰¹é‡ä¸Šä¼ ç®¡ç†å™¨ =============== */
const BatchUploadManager = {
  // ä¸Šä¼ é˜Ÿåˆ—
  uploadQueue: new Map(),
  
  // æ‰¹é‡é…ç½®
  config: {
    maxBatchSize: 10,
    batchTimeout: 5000, // 5ç§’åå¼ºåˆ¶ä¸Šä¼ 
    retryAttempts: 3,
    retryDelay: 2000
  },
  
  // æ·»åŠ åˆ°ä¸Šä¼ é˜Ÿåˆ—
  addToQueue(dataType, dateKey, identifier, data) {
    const queueKey = `${dataType}_${dateKey}`;
    
    if (!this.uploadQueue.has(queueKey)) {
      this.uploadQueue.set(queueKey, {
        dataType,
        dateKey,
        items: new Map(),
        createdAt: Date.now(),
        retryCount: 0
      });
    }
    
    const batch = this.uploadQueue.get(queueKey);
    batch.items.set(identifier, data);
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç«‹å³ä¸Šä¼ 
    if (batch.items.size >= this.config.maxBatchSize) {
      this.processBatch(queueKey);
    } else {
      // è®¾ç½®å®šæ—¶å™¨ï¼Œç¡®ä¿ä¸ä¼šç§¯å‹å¤ªä¹…
      setTimeout(() => {
        if (this.uploadQueue.has(queueKey)) {
          this.processBatch(queueKey);
        }
      }, this.config.batchTimeout);
    }
  },
  
  // å¤„ç†æ‰¹é‡ä¸Šä¼ 
  async processBatch(queueKey) {
    const batch = this.uploadQueue.get(queueKey);
    if (!batch || batch.items.size === 0) return;
    
    const strategy = DataSyncOptimizer.getSyncStrategy();
    const { dataType, dateKey, items } = batch;
    
    try {
      console.log(`ğŸ“¦ å¼€å§‹æ‰¹é‡ä¸Šä¼ : ${dataType}/${dateKey}, ${items.size} ä¸ªé¡¹ç›®`);
      
      if (strategy.useCompression && items.size > 3) {
        // å¤§æ‰¹é‡æ•°æ®ä½¿ç”¨å‹ç¼©
        const batchData = {};
        items.forEach((data, identifier) => {
          batchData[identifier] = data;
        });
        
        const compressed = DataSyncOptimizer.compressData(batchData);
        if (compressed.compressed) {
          await database.ref(`${dataType}/${dateKey}/batch_compressed`).set(compressed);
          console.log(`âœ… å‹ç¼©æ‰¹é‡ä¸Šä¼ æˆåŠŸ: ${items.size} é¡¹, å‹ç¼©ç‡: ${Math.round((1-compressed.compressedSize/compressed.originalSize)*100)}%`);
        } else {
          throw new Error('å‹ç¼©å¤±è´¥ï¼Œå›é€€åˆ°åˆ†åˆ«ä¸Šä¼ ');
        }
      } else {
        // å°æ‰¹é‡æˆ–ç½‘ç»œè‰¯å¥½æ—¶åˆ†åˆ«ä¸Šä¼ 
        const promises = Array.from(items.entries()).map(([identifier, data]) => 
          database.ref(`${dataType}/${dateKey}/${identifier}`).set(data)
        );
        
        await Promise.allSettled(promises);
        console.log(`âœ… æ‰¹é‡ä¸Šä¼ å®Œæˆ: ${dataType}/${dateKey}, ${items.size} ä¸ªé¡¹ç›®`);
      }
      
      // ä¸Šä¼ æˆåŠŸï¼Œä»é˜Ÿåˆ—ä¸­ç§»é™¤
      this.uploadQueue.delete(queueKey);
      
    } catch (error) {
      console.error(`âŒ æ‰¹é‡ä¸Šä¼ å¤±è´¥: ${queueKey}`, error);
      
      // é‡è¯•é€»è¾‘
      batch.retryCount++;
      if (batch.retryCount < this.config.retryAttempts) {
        console.log(`ğŸ”„ å°†åœ¨ ${this.config.retryDelay}ms åé‡è¯• (${batch.retryCount}/${this.config.retryAttempts})`);
        setTimeout(() => {
          if (this.uploadQueue.has(queueKey)) {
            this.processBatch(queueKey);
          }
        }, this.config.retryDelay * batch.retryCount);
      } else {
        console.error(`ğŸ’€ æ‰¹é‡ä¸Šä¼ å½»åº•å¤±è´¥ï¼Œæ”¾å¼ƒé‡è¯•: ${queueKey}`);
        this.uploadQueue.delete(queueKey);
      }
    }
  },
  
  // å¼ºåˆ¶å¤„ç†æ‰€æœ‰å¾…ä¸Šä¼ çš„æ‰¹æ¬¡
  async flushAll() {
    const promises = Array.from(this.uploadQueue.keys()).map(key => this.processBatch(key));
    await Promise.allSettled(promises);
  },
  
  // è·å–é˜Ÿåˆ—çŠ¶æ€
  getQueueStatus() {
    const status = {};
    this.uploadQueue.forEach((batch, key) => {
      status[key] = {
        itemCount: batch.items.size,
        age: Date.now() - batch.createdAt,
        retryCount: batch.retryCount
      };
    });
    return status;
  }
};

// é¡µé¢å¸è½½æ—¶å¼ºåˆ¶ä¸Šä¼ æ‰€æœ‰å¾…å¤„ç†çš„æ‰¹æ¬¡
window.addEventListener('beforeunload', () => {
  BatchUploadManager.flushAll();
});

// é¡µé¢å˜ä¸ºä¸å¯è§æ—¶ä¹Ÿå¤„ç†æ‰¹æ¬¡
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    BatchUploadManager.flushAll();
  }
});

/* =============== ğŸŒ ç½‘ç»œçŠ¶æ€ç›‘æµ‹å™¨ =============== */
const NetworkMonitor = {
  // ç½‘ç»œçŠ¶æ€
  status: {
    isOnline: navigator.onLine,
    quality: 'unknown',
    latency: 0,
    bandwidth: 0,
    lastCheck: 0
  },
  
  // ç›‘æµ‹é…ç½®
  config: {
    checkInterval: 30000, // 30ç§’æ£€æµ‹ä¸€æ¬¡
    timeoutMs: 5000,
    testDataSize: 1024, // 1KBæµ‹è¯•æ•°æ®
    qualityThresholds: {
      excellent: { latency: 50, bandwidth: 1000 },
      good: { latency: 150, bandwidth: 500 },
      moderate: { latency: 500, bandwidth: 100 },
      poor: { latency: 1000, bandwidth: 50 }
    }
  },
  
  // åˆå§‹åŒ–ç½‘ç»œç›‘æµ‹
  init() {
    // ç›‘å¬åœ¨çº¿/ç¦»çº¿çŠ¶æ€å˜åŒ–
    window.addEventListener('online', () => {
      this.status.isOnline = true;
      this.onStatusChange();
      addSyncLog('ğŸŒ ç½‘ç»œå·²æ¢å¤è¿æ¥');
    });
    
    window.addEventListener('offline', () => {
      this.status.isOnline = false;
      this.status.quality = 'offline';
      this.onStatusChange();
      addSyncLog('ğŸŒ ç½‘ç»œå·²æ–­å¼€è¿æ¥');
    });
    
    // å¼€å§‹å®šæœŸæ£€æµ‹
    this.startPeriodicCheck();
    
    // ç«‹å³è¿›è¡Œä¸€æ¬¡æ£€æµ‹
    this.checkNetworkQuality();
  },
  
  // å¼€å§‹å®šæœŸæ£€æµ‹
  startPeriodicCheck() {
    setInterval(() => {
      if (this.status.isOnline) {
        this.checkNetworkQuality();
      }
    }, this.config.checkInterval);
  },
  
  // æ£€æµ‹ç½‘ç»œè´¨é‡
  async checkNetworkQuality() {
    if (!this.status.isOnline) return;
    
    const now = Date.now();
    if (now - this.status.lastCheck < 10000) return; // 10ç§’å†…ä¸é‡å¤æ£€æµ‹
    
    try {
      // å»¶è¿Ÿæµ‹è¯•
      const latency = await this.measureLatency();
      
      // å¸¦å®½æµ‹è¯•ï¼ˆç®€åŒ–ç‰ˆï¼‰
      const bandwidth = await this.measureBandwidth();
      
      // ç¡®å®šç½‘ç»œè´¨é‡ç­‰çº§
      const quality = this.determineQuality(latency, bandwidth);
      
      // æ›´æ–°çŠ¶æ€
      this.status = {
        isOnline: true,
        quality,
        latency,
        bandwidth,
        lastCheck: now
      };
      
      // é€šçŸ¥æ•°æ®åŒæ­¥ä¼˜åŒ–å™¨
      DataSyncOptimizer.networkQuality = quality;
      
      this.onStatusChange();
      
      console.log(`ğŸŒ ç½‘ç»œè´¨é‡æ£€æµ‹: ${quality} (å»¶è¿Ÿ: ${latency}ms, å¸¦å®½: ~${Math.round(bandwidth)}KB/s)`);
      
    } catch (error) {
      console.warn('ç½‘ç»œè´¨é‡æ£€æµ‹å¤±è´¥:', error);
      this.status.quality = 'poor';
      DataSyncOptimizer.networkQuality = 'poor';
    }
  },
  
  // æµ‹é‡ç½‘ç»œå»¶è¿Ÿ
  async measureLatency() {
    const start = performance.now();
    
    try {
      await fetch('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js?t=' + Date.now(), {
        method: 'HEAD',
        cache: 'no-cache',
        signal: AbortSignal.timeout(this.config.timeoutMs)
      });
      
      return Math.round(performance.now() - start);
    } catch (error) {
      return 9999; // è¡¨ç¤ºè¶…æ—¶æˆ–å¤±è´¥
    }
  },
  
  // æµ‹é‡å¸¦å®½ï¼ˆç®€åŒ–ç‰ˆï¼‰
  async measureBandwidth() {
    const testUrl = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
    const start = performance.now();
    
    try {
      const response = await fetch(testUrl + '?t=' + Date.now(), {
        cache: 'no-cache',
        signal: AbortSignal.timeout(this.config.timeoutMs)
      });
      
      const data = await response.text();
      const duration = (performance.now() - start) / 1000; // è½¬æ¢ä¸ºç§’
      const sizeKB = data.length / 1024; // è½¬æ¢ä¸ºKB
      
      return sizeKB / duration; // KB/s
    } catch (error) {
      return 0;
    }
  },
  
  // æ ¹æ®å»¶è¿Ÿå’Œå¸¦å®½ç¡®å®šç½‘ç»œè´¨é‡
  determineQuality(latency, bandwidth) {
    const thresholds = this.config.qualityThresholds;
    
    if (latency <= thresholds.excellent.latency && bandwidth >= thresholds.excellent.bandwidth) {
      return 'excellent';
    } else if (latency <= thresholds.good.latency && bandwidth >= thresholds.good.bandwidth) {
      return 'good';
    } else if (latency <= thresholds.moderate.latency && bandwidth >= thresholds.moderate.bandwidth) {
      return 'moderate';
    } else {
      return 'poor';
    }
  },
  
  // ç½‘ç»œçŠ¶æ€å˜åŒ–å›è°ƒ
  onStatusChange() {
    // æ ¹æ®ç½‘ç»œçŠ¶æ€è°ƒæ•´åŒæ­¥ç­–ç•¥
    const strategy = DataSyncOptimizer.getSyncStrategy();
    
    // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
    updateConnectionStatus();
    
    // å¦‚æœç½‘ç»œè´¨é‡å¾ˆå·®ï¼Œå‡å°‘åŒæ­¥é¢‘ç‡
    if (this.status.quality === 'poor') {
      addSyncLog('ğŸŒ æ£€æµ‹åˆ°ç½‘ç»œè¾ƒæ…¢ï¼Œå·²é™ä½åŒæ­¥é¢‘ç‡');
      
      // å»¶è¿Ÿéå…³é”®æ•°æ®çš„åŒæ­¥
      this.postponeNonCriticalSync();
    } else if (this.status.quality === 'excellent' || this.status.quality === 'good') {
      // ç½‘ç»œè‰¯å¥½æ—¶ï¼Œå¤„ç†ç§¯å‹çš„æ•°æ®
      this.processPendingSync();
    }
  },
  
  // å»¶è¿Ÿéå…³é”®åŒæ­¥
  postponeNonCriticalSync() {
    // æš‚åœé¢„åŠ è½½
    clearTimeout(window._preloadTimer);
    
    // å¢åŠ æ‰¹é‡ä¸Šä¼ çš„ç­‰å¾…æ—¶é—´
    BatchUploadManager.config.batchTimeout = 10000; // å¢åŠ åˆ°10ç§’
    BatchUploadManager.config.maxBatchSize = 5; // å‡å°‘æ‰¹é‡å¤§å°
  },
  
  // å¤„ç†ç§¯å‹çš„åŒæ­¥
  processPendingSync() {
    // æ¢å¤æ­£å¸¸çš„æ‰¹é‡é…ç½®
    BatchUploadManager.config.batchTimeout = 5000;
    BatchUploadManager.config.maxBatchSize = 10;
    
    // ç«‹å³å¤„ç†ç§¯å‹çš„æ‰¹æ¬¡
    BatchUploadManager.flushAll();
    
    // é‡æ–°å¯åŠ¨é¢„åŠ è½½
    if (SmartCacheManager.preloadFrequentData) {
      window._preloadTimer = setTimeout(() => {
        SmartCacheManager.preloadFrequentData();
      }, 2000);
    }
  },
  
  // è·å–ç½‘ç»œçŠ¶æ€æŠ¥å‘Š
  getStatusReport() {
    return {
      ...this.status,
      qualityDescription: this.getQualityDescription(this.status.quality),
      recommendation: this.getRecommendation(this.status.quality)
    };
  },
  
  // è·å–è´¨é‡æè¿°
  getQualityDescription(quality) {
    const descriptions = {
      excellent: 'ç½‘ç»œçŠ¶å†µæä½³',
      good: 'ç½‘ç»œçŠ¶å†µè‰¯å¥½',
      moderate: 'ç½‘ç»œçŠ¶å†µä¸€èˆ¬',
      poor: 'ç½‘ç»œçŠ¶å†µè¾ƒå·®',
      offline: 'ç½‘ç»œå·²æ–­å¼€',
      unknown: 'ç½‘ç»œçŠ¶å†µæœªçŸ¥'
    };
    return descriptions[quality] || 'æœªçŸ¥çŠ¶æ€';
  },
  
  // è·å–ä¼˜åŒ–å»ºè®®
  getRecommendation(quality) {
    const recommendations = {
      excellent: 'æ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ',
      good: 'å»ºè®®å¯ç”¨è‡ªåŠ¨åŒæ­¥',
      moderate: 'å»ºè®®å‡å°‘å¹¶å‘æ“ä½œ',
      poor: 'å»ºè®®ä»…è¿›è¡Œå¿…è¦æ“ä½œ',
      offline: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
      unknown: 'æ­£åœ¨æ£€æµ‹ç½‘ç»œçŠ¶å†µ'
    };
    return recommendations[quality] || 'æ— å»ºè®®';
  }
};

// åˆå§‹åŒ–ç½‘ç»œç›‘æµ‹
NetworkMonitor.init();

/* =============== ç»ƒç´å®æ—¶/ä¼šè¯ =============== */
function buildRealTimePracticeFromRooms(){
  const now=Date.now(),map={},active=new Set();
  rooms.forEach(r=>{
    if(r&&r.student&&r.registerTime){
      const reg=Number(r.registerTime);
      if(!isNaN(reg)&&reg>0&&(now-reg)<12*3600*1000){
        const sec=Math.max(0,Math.floor((now-reg)/1000));
        map[r.student]={room:r.name,startTime:reg,currentSec:sec};
        const sid=`${r.student}__${r.name}__${r.registerTime}`;
        active.add(sid);
        if(!practiceSessionTracker.has(sid)) startPracticeSession(r.student,r.name,r.registerTime);
      }
    }
  });
  for(const [sid,sess] of practiceSessionTracker.entries()){
    if(!active.has(sid)) endPracticeSession(sid,Date.now(),'æˆ¿é—´é‡Šæ”¾');
  }
  realTimePracticeMap=map;
}
function getStudentTodaySlots(name){
  const wd=new Date().getDay();
  const M={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const key=M[wd];if(!key||!studentTimeSlots[name])return [];
  return studentTimeSlots[name][key]||[];
}
// ğŸ”§ ç»Ÿä¸€æ—¶é—´æ ¼å¼ -> åˆå¹¶é‡å /ç›¸é‚» -> å»é‡ -> é‡æ–°è®¡ç®—åˆ†é’Ÿ
function normalizeStudentTimeSlots(raw){
  if(!raw||typeof raw!=="object") return raw;
  const dayKeys=['monday','tuesday','wednesday','thursday','friday'];
  const pad=t=>t.replace(/^\s+/,'').replace(/\s+$/,'').split(':').map(x=>x.padStart(2,'0')).join(':');
  function normList(list){
    if(!Array.isArray(list)) return [];
    // 1. è§„èŒƒåŒ– start/end
    const arr=list.map(s=>({
      name: s.name || `${s.start||''}-${s.end||''}`,
      start: pad(String(s.start||'')),
      end: pad(String(s.end||''))
    })).filter(s=>/^\d{2}:\d{2}$/.test(s.start)&&/^\d{2}:\d{2}$/.test(s.end)&&s.start<s.end);
    // 2. è½¬ä¸ºåˆ†é’Ÿå¹¶æ’åº
    const items=arr.map(s=>({
      name:s.name,
      sm: timeToMinutes(s.start),
      em: timeToMinutes(s.end)
    })).sort((a,b)=>a.sm-b.sm || a.em-b.em);
    // 3. åˆå¹¶
    const merged=[];
    for(const it of items){
      const last=merged[merged.length-1];
      if(!last){merged.push({...it});continue;}
      if(it.sm<=last.em){ // é‡å æˆ–ç›¸é‚»ï¼ˆå¦‚ 480 ä¸ 480, ä¹Ÿåˆå¹¶ï¼‰
        if(it.em>last.em) last.em=it.em;
      }else{
        merged.push({...it});
      }
    }
    // 4. ç”Ÿæˆæœ€ç»ˆç»“æ„å¹¶è®¡ç®— totalPlannedMinutes
    return merged.map(m=>({
      start: minutesToHHMM(m.sm),
      end: minutesToHHMM(m.em),
      totalPlannedMinutes: m.em - m.sm
    }));
  }
  function minutesToHHMM(m){
    const hh=String(Math.floor(m/60)).padStart(2,'0');
    const mm=String(m%60).padStart(2,'0');
    return `${hh}:${mm}`;
  }
  const out={};
  Object.keys(raw).forEach(student=>{
    const conf=raw[student];
    if(!conf||typeof conf!=='object'){ out[student]=conf; return; }
    out[student]={};
    dayKeys.forEach(d=>{
      if(conf[d]) out[student][d]=normList(conf[d]);
    });
  });
  return out;
}
function findCurrentTimeSlot(slots,ts){
  const d=new Date(ts);
  const m=d.getHours()*60+d.getMinutes();
  const weekday = d.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
  
  // æ£€æŸ¥æ˜¯å¦åœ¨æ’é™¤æ—¶é—´å†…
  if (isExcludedTime(m, weekday)) {
    return null; // æ’é™¤æ—¶é—´ä¸ç®—åœ¨æ—¶é—´æ®µå†…
  }
  
  return slots.find(s=>{const sm=timeToMinutes(s.start),em=timeToMinutes(s.end);return m>=sm&&m<em;})||null;
}

// ğŸ”¥ åˆ¤æ–­æ˜¯å¦ä¸ºæ’é™¤æ—¶é—´çš„å‡½æ•°ï¼ˆå·²æœ‰ï¼‰
function isExcludedTime(minutes, weekday, dateObj=new Date()) {
  // åŠ¨æ€å†»ç»“ï¼šè¶…è¿‡å½“æ—¥å†»ç»“æ—¶é—´ä¸€å¾‹æ’é™¤
  const freezeMin = getTodayFreezeMinutes(dateObj);
  if (minutes >= freezeMin) return true;
  // ç”¨é¤ç­‰å›ºå®šæ’é™¤ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰
  if (weekday === 1 || weekday === 2 || weekday === 4 || weekday === 5) {
    if (minutes >= 12 * 60 && minutes < 13 * 60) return true; // åˆé¤
    if (minutes >= 18 * 60 && minutes < 19 * 60) return true; // æ™šé¤
  }
  if (weekday === 3) {
    if (minutes >= 12 * 60 && minutes < 13 * 60 + 30) return true; // åˆé¤+éŸ³ä¹ä¼š
    if (minutes >= 18 * 60 + 30 && minutes < 19 * 60 + 30) return true; // æ™šé¤
  }
  return false;
}

// ================= è¯Šæ–­ï¼šæ£€æµ‹æ˜¯å¦ä»æœ‰å†»ç»“ååˆ†é’Ÿè¿›å…¥ç»Ÿè®¡ =================
function debugFreezeOverflow(targetDateStr=formatDate(new Date())){
  try{
    const dateObj=new Date(targetDateStr+"T00:00:00");
    if(isNaN(dateObj)) { console.warn('[debugFreezeOverflow] æ—¥æœŸæ— æ•ˆ', targetDateStr); return; }
    const freezeMin=getTodayFreezeMinutes(dateObj);
    const dayStart=dateObj.getTime();
    const dayEnd=dayStart+24*60*60*1000;
    const offenders=[];
    const students=flattenStudents().map(s=>s.name);
    students.forEach(stu=>{
      // è·å–åŸå§‹åŒºé—´ï¼ˆæœªå‰”é™¤ä¼‘æ¯ä½†å·²è£å‰ªæ—¥çª—å£ï¼‰
      const original=isTodayDate(targetDateStr)? getStudentTodayIntervals(stu): getHistoryIntervals(stu,targetDateStr);
      if(!original||!original.length) return;
      original.forEach(iv=>{
        const mStart=Math.floor((iv.start-dayStart)/60000);
        const mEnd=Math.floor((iv.end-dayStart)/60000);
        if(mEnd>freezeMin){
          // è‹¥åŒºé—´è·¨è¶Šå†»ç»“ç‚¹ï¼Œæˆªæ–­å‰åŠä»ä¿ç•™ï¼Œä½†ååŠåº”è¢«è£å‰ªï¼›è®°å½•è¿è§„éƒ¨åˆ†
            const overStart=Math.max(freezeMin,mStart);
            if(overStart<mEnd){
              offenders.push({student:stu,room:iv.room,start:new Date(iv.start).toLocaleTimeString('zh-CN',{hour12:false}),end:new Date(iv.end).toLocaleTimeString('zh-CN',{hour12:false}),overMinutes:mEnd-freezeMin,totalMinutes:mEnd-mStart});
            }
        }
      });
    });
    if(!offenders.length){
      console.info(`[debugFreezeOverflow] OK: ${targetDateStr} æ— è¶…è¿‡å†»ç»“(${freezeMin}min)çš„ç»ƒç´ç‰‡æ®µ`);
    }else{
      console.group(`[debugFreezeOverflow] å‘ç° ${offenders.length} ä¸ªè¶…å‡ºå†»ç»“ç‰‡æ®µ @${targetDateStr} freeze=${freezeMin}`);
      offenders.slice(0,50).forEach(o=>console.warn(o));
      if(offenders.length>50) console.warn('...(æ›´å¤šçœç•¥)', offenders.length-50);
      console.groupEnd();
    }
    return offenders;
  }catch(e){console.error('[debugFreezeOverflow] å¤±è´¥',e);}
}
function isTodayDate(str){
  const now=new Date();
  return str===formatDate(now);
}

// ğŸ”¥ æŒ‰åˆ†é’Ÿåˆ†æä¼šè¯æ—¶é—´åˆ†å¸ƒ
function analyzeSessionTimeDistribution(sess) {
  if (!sess.actualStartTime) {
    return {
      inSlotValid: 0,
      outSlotValid: 0,
      excludedTime: 0,
      breakdown: []
    };
  }
  
  const endTime = sess.endTime || Date.now();
  const startMin = Math.floor(sess.actualStartTime / 60000) * 60000;
  const endMin = Math.floor(endTime / 60000) * 60000;
  const slots = getStudentTodaySlots(sess.studentName);
  
  let inSlotValid = 0;
  let outSlotValid = 0;
  let excludedTime = 0;
  const breakdown = [];
  
  // ğŸ”¥ æŒ‰åˆ†é’Ÿéå†åˆ†æ
  for(let t = startMin; t < endMin; t += 60000) {
    const currentDate = new Date(t);
    const currentMinutes = currentDate.getHours() * 60 + currentDate.getMinutes();
    const currentWeekday = currentDate.getDay();
    const isExcluded = isExcludedTime(currentMinutes, currentWeekday);
    const slot = findCurrentTimeSlot(slots, t);
    
    const minuteInfo = {
      time: t,
      timeStr: currentDate.toLocaleTimeString('zh-CN', {hour12: false}).substring(0, 5),
      isExcluded,
      inSlot: !!slot,
      slotName: slot ? slot.name : null
    };
    
    if (isExcluded) {
      excludedTime += 60;
      minuteInfo.category = 'æ’é™¤æ—¶é—´';
    } else if (slot) {
      inSlotValid += 60;
      minuteInfo.category = 'æ®µå†…æœ‰æ•ˆ';
    } else {
      outSlotValid += 60;
      minuteInfo.category = 'æ®µå¤–æœ‰æ•ˆ';
    }
    
    breakdown.push(minuteInfo);
  }
  
  return {
    inSlotValid,
    outSlotValid,
    excludedTime,
    breakdown
  };
}



// ğŸ”¥ ç»Ÿä¸€çš„ç»ƒç´ä¼šè¯åˆ›å»ºå‡½æ•°
function startPracticeSession(student, room, registerTime){
  if(!student || !room) {
    console.error('åˆ›å»ºç»ƒç´ä¼šè¯å¤±è´¥ï¼šå­¦ç”Ÿåæˆ–æˆ¿é—´åä¸ºç©º');
    return null;
  }
  
  const sid = `${student}__${room}__${registerTime}`;
  if(practiceSessionTracker.has(sid)) {
    console.log(`ç»ƒç´ä¼šè¯å·²å­˜åœ¨: ${sid}`);
    return practiceSessionTracker.get(sid);
  }
  
  const now = Date.now();
  const slots = getStudentTodaySlots(student);
  const cur = findCurrentTimeSlot(slots, now);
  
  const sess = {
    sessionId: sid,
    studentName: student,
    roomName: room,
    startTime: Number(registerTime) || now, // ğŸ”¥ ç¡®ä¿æ˜¯æ•°å­—
    prepEndTime: (Number(registerTime) || now) + 60000,
    actualStartTime: null,
    endTime: null,
    inSlotTime: 0,        // ğŸ”¥ æ˜ç¡®åˆå§‹åŒ–ä¸º 0
    outSlotTime: 0,       // ğŸ”¥ æ˜ç¡®åˆå§‹åŒ–ä¸º 0
    currentSlot: cur,
    slotTransitions: [],
    isActive: true,
    _lastTick: now
  };
  
  practiceSessionTracker.set(sid, sess);
  console.log(`å¼€å§‹ç»ƒç´ä¼šè¯: ${student} åœ¨ ${room}`);
  return sess;
}


function endPracticeSession(sid, endTime, reason = 'ç»“æŸ'){
  const sess = practiceSessionTracker.get(sid);
  if(!sess || !sess.isActive) return;
  
  sess.isActive = false;
  sess.endTime = Number(endTime) || Date.now(); // ğŸ”¥ ç¡®ä¿æ˜¯æ•°å­—
  sess.endReason = reason;
  
  // ğŸ”¥ å¦‚æœç»ƒç´æ—¶é—´å¤ªçŸ­ï¼ˆå°äº1åˆ†é’Ÿï¼‰ï¼Œç›´æ¥åˆ é™¤ä¸è®°å½•
  if(sess.endTime < sess.prepEndTime) {
    console.log(`ç»ƒç´æ—¶é—´è¿‡çŸ­ï¼Œä¸è®°å½•: ${sess.studentName}`);
    practiceSessionTracker.delete(sid);
    return;
  }
  
  // ğŸ”¥ è®¾ç½®å®é™…å¼€å§‹æ—¶é—´
  if(!sess.actualStartTime) {
    sess.actualStartTime = sess.prepEndTime;
  }
  
  // ğŸ”¥ é‡æ–°è®¡ç®—æ—¶é•¿
  try {
    recalcSessionTimes(sess);
    
    // ğŸ”¥ æœ€ç»ˆéªŒè¯
    if(isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
      console.error(`ç»“æŸä¼šè¯æ—¶å‘ç°NaN: ${sess.studentName}`);
      sess.inSlotTime = 0;
      sess.outSlotTime = 0;
    }
    
    // ğŸ”¥ åªæœ‰æœ‰æ•ˆæ—¶é•¿æ‰è®°å½•
    if(sess.inSlotTime > 0 || sess.outSlotTime > 0) {
      recordDailyPractice(sess);
    } else {
      console.log(`æ— æœ‰æ•ˆç»ƒç´æ—¶é•¿ï¼Œä¸è®°å½•: ${sess.studentName}`);
    }
  } catch(e) {
    console.error(`ç»“æŸä¼šè¯æ—¶å‡ºé”™: ${sess.studentName}`, e);
  }
  
  practiceSessionTracker.delete(sid);
}

function recordDailyPractice(sess){
  try {
    const dk = formatDate(new Date(sess.startTime));
    
    // ğŸ”¥ éªŒè¯è¾“å…¥æ•°æ®
    if(!sess.studentName || !dk) {
      console.error('æ— æ•ˆçš„ä¼šè¯æ•°æ®:', sess);
      return;
    }
    
    // ğŸ”¥ éªŒè¯æ—¶é•¿æ•°æ®
    let inSlotTime = Number(sess.inSlotTime) || 0;
    let outSlotTime = Number(sess.outSlotTime) || 0;
    
    if(isNaN(inSlotTime) || isNaN(outSlotTime)) {
      console.error(`æ—¶é•¿æ•°æ®ä¸ºNaN: ${sess.studentName}, in=${sess.inSlotTime}, out=${sess.outSlotTime}`);
      inSlotTime = 0;
      outSlotTime = 0;
    }
    
    // ğŸ”¥ åˆç†æ€§æ£€æŸ¥ï¼ˆä¸è¶…è¿‡24å°æ—¶ï¼‰
    const maxSeconds = 24 * 60 * 60;
    if(inSlotTime > maxSeconds || outSlotTime > maxSeconds) {
      console.error(`æ—¶é•¿æ•°æ®å¼‚å¸¸: ${sess.studentName}, in=${inSlotTime}, out=${outSlotTime}`);
      return;
    }
    
    // ğŸ”¥ å¦‚æœæ—¶é•¿ä¸º0ï¼Œä¸è®°å½•
    if(inSlotTime === 0 && outSlotTime === 0) {
      console.log(`æ— æœ‰æ•ˆæ—¶é•¿ï¼Œè·³è¿‡è®°å½•: ${sess.studentName}`);
      return;
    }
    
    // ğŸ”¥ åˆå§‹åŒ–æ•°æ®ç»“æ„
    if(!dailyPracticeRecords[dk]) {
      dailyPracticeRecords[dk] = {};
    }
    
    if(!dailyPracticeRecords[dk][sess.studentName]) {
      dailyPracticeRecords[dk][sess.studentName] = {
        inSlot: 0,
        outSlot: 0,
        totalSessions: 0,
        sessions: [],
        lastUpdated: 0
      };
    }
    
    const rec = dailyPracticeRecords[dk][sess.studentName];
    
    // ğŸ”¥ ç¡®ä¿ sessions æ•°ç»„å­˜åœ¨
    if(!Array.isArray(rec.sessions)) {
      rec.sessions = [];
    }
    
    // ğŸ”¥ æ›´æ–°ç´¯è®¡æ•°æ®
    rec.inSlot = (Number(rec.inSlot) || 0) + inSlotTime;
    rec.outSlot = (Number(rec.outSlot) || 0) + outSlotTime;
    rec.totalSessions = (Number(rec.totalSessions) || 0) + 1;
    rec.lastUpdated = Date.now();
    
    // ğŸ”¥ æ·»åŠ ä¼šè¯è®°å½•
    rec.sessions.push({
      room: sess.roomName || t('room.practice_room', 'ç»ƒç´æˆ¿'),
      start: sess.startTime || Date.now(),
      end: sess.endTime || Date.now(),
      inSlot: inSlotTime,
      outSlot: outSlotTime,
      endReason: sess.endReason || 'æ­£å¸¸'
    });
    
    // ğŸ”¥ ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    try {
      localStorage.setItem('practiceRecords_' + dk, JSON.stringify(dailyPracticeRecords[dk]));
  // æ ‡è®°æ’è¡Œæ¦œéœ€è¦è‡ªåŠ¨åˆ·æ–°
  try{ setLeaderboardDirty(); }catch(e){ console.debug('setLeaderboardDirty failed',e); }
    } catch(e) {
      console.error('ä¿å­˜æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
    }
    
    // ğŸ”¥ åŒæ­¥åˆ°äº‘ç«¯
    if(isOnline && database) {
      const cloudData = {
        inSlotSeconds: Math.floor(rec.inSlot),
        outSlotSeconds: Math.floor(rec.outSlot),
        totalSessions: Math.floor(rec.totalSessions),
        sessions: rec.sessions,
        lastUpdated: rec.lastUpdated,
        running: false
      };
      
      // ğŸ”¥ æœ€ç»ˆNaNæ£€æŸ¥
      Object.keys(cloudData).forEach(key => {
        if(typeof cloudData[key] === 'number' && (isNaN(cloudData[key]) || !isFinite(cloudData[key]))) {
          console.error(`å‘ç°æ— æ•ˆæ•°å€¼ ${key}: ${cloudData[key]}`);
          if(key === 'inSlotSeconds' || key === 'outSlotSeconds') {
            cloudData[key] = 0;
          } else if(key === 'totalSessions') {
            cloudData[key] = 1;
          } else if(key === 'lastUpdated') {
            cloudData[key] = Date.now();
          }
        }
      });
      
      // ğŸš€ ä¼˜åŒ–ï¼šä½¿ç”¨æ‰¹é‡å‹ç¼©ä¼ è¾“æœºåˆ¶
      const optimizedData = DataSyncOptimizer.createMinimalPayload(cloudData, 'practiceRecord');
      const strategy = DataSyncOptimizer.getSyncStrategy();
      
      if (strategy.useCompression) {
        const compressed = DataSyncOptimizer.compressData(optimizedData);
        if (compressed.compressed && compressed.compressedSize < compressed.originalSize * 0.8) {
          console.log(`ğŸ“¦ æ•°æ®å‹ç¼©: ${compressed.originalSize}B â†’ ${compressed.compressedSize}B (${Math.round((1-compressed.compressedSize/compressed.originalSize)*100)}% å‡å°‘)`);
          
          // ä½¿ç”¨å‹ç¼©æ•°æ®ä¸Šä¼ 
          database.ref(`practiceRecords/${dk}/${sess.studentName}/compressed`).set(compressed)
            .then(() => {
              console.log(`ğŸš€ å‹ç¼©æ•°æ®äº‘ç«¯åŒæ­¥æˆåŠŸ: ${sess.studentName}`);
            })
            .catch(e => {
              console.error('å‹ç¼©æ•°æ®åŒæ­¥å¤±è´¥ï¼Œå›é€€åˆ°æ™®é€šä¸Šä¼ :', e);
              // å›é€€åˆ°æ™®é€šä¸Šä¼ 
              database.ref(`practiceRecords/${dk}/${sess.studentName}`).set(optimizedData);
            });
        } else {
          // å‹ç¼©æ•ˆæœä¸æ˜æ˜¾ï¼Œä½¿ç”¨æ™®é€šä¸Šä¼ 
          database.ref(`practiceRecords/${dk}/${sess.studentName}`).set(optimizedData);
        }
      } else {
        // ç½‘ç»œè‰¯å¥½ï¼Œç›´æ¥ä¸Šä¼ ä¼˜åŒ–åçš„æ•°æ®
        database.ref(`practiceRecords/${dk}/${sess.studentName}`).set(optimizedData);
      }
      
      // ğŸš€ æ–°å¢ï¼šæ‰¹é‡ä¸Šä¼ é˜Ÿåˆ—ç®¡ç†
      BatchUploadManager.addToQueue('practiceRecords', dk, sess.studentName, optimizedData);
    }
    
    addSyncLog(`ğŸ“ è®°å½•ç»ƒç´: ${sess.studentName} æ®µå†…${Math.round(inSlotTime/60)}åˆ†é’Ÿ æ®µå¤–${Math.round(outSlotTime/60)}åˆ†é’Ÿ`);
    
  } catch(e) {
    console.error('recordDailyPractice å‡ºé”™:', e, sess);
  }
}

function getStudentPracticeRecord(name,dk){
  if(!dk)dk=getTodayDateString();
  if(dailyPracticeRecords[dk]&&dailyPracticeRecords[dk][name])return dailyPracticeRecords[dk][name];
  if(!dailyPracticeRecords[dk]){
    const raw=localStorage.getItem('practiceRecords_'+dk);
    if(raw){try{dailyPracticeRecords[dk]=JSON.parse(raw);}catch(e){dailyPracticeRecords[dk]={};}}
  }
  if(dailyPracticeRecords[dk]&&dailyPracticeRecords[dk][name])return dailyPracticeRecords[dk][name];
  // è§¦å‘ä¸€æ¬¡å¼‚æ­¥è·å–ï¼ˆä¸é˜»å¡ï¼‰
  if(isOnline&&database){
    database.ref(`practiceRecords/${dk}/${name}`).once('value').then(s=>{
      const v=s.val();if(v){if(!dailyPracticeRecords[dk])dailyPracticeRecords[dk]={};dailyPracticeRecords[dk][name]=v;
        try{localStorage.setItem('practiceRecords_'+dk,JSON.stringify(dailyPracticeRecords[dk]));}catch(e){}
      }
    });
  }
  return {inSlot:0,outSlot:0,totalSessions:0,sessions:[],lastUpdated:0};
}
function estimateLiveSessionInOut(sess){
  if(!sess.isActive)return null;
  const now=Date.now();if(now<sess.prepEndTime)return {tempIn:0,tempOut:0};
  const baseIn=sess.inSlotTime,baseOut=sess.outSlotTime;
  let extra=0;
  if(sess._lastTick){
    const dt=Math.floor((now-sess._lastTick)/1000);
    if(dt>0&&dt<900)extra=dt;
  }
  const cur=findCurrentTimeSlot(getStudentTodaySlots(sess.studentName),now);
  if(cur)return {tempIn:baseIn+extra,tempOut:baseOut};
  return {tempIn:baseIn,tempOut:baseOut+extra};
}

/* =============== âœ… å®æ—¶è€ƒå‹¤å¢å¼ºï¼šå¢é‡ç»ƒç´æ—¶é•¿åŒæ­¥ =============== */
// ğŸ”¥ ä¿®å¤ 5: å¢å¼º syncActiveSessionsIncrement å‡½æ•°
function syncActiveSessionsIncrement(){
  const now = Date.now();
  if(now - lastIncrementSync < SYNC_INCREMENT_INTERVAL_MS) return;
  lastIncrementSync = now;
  const today = getTodayDateString();
  
  practiceSessionTracker.forEach(sess => {
    if(!sess.isActive) return;
    if(Date.now() < sess.prepEndTime) return;
    
    try {
      // ğŸ”¥ ä¸´æ—¶è®¡ç®—å½“å‰æ—¶é•¿
      const tempEndTime = sess.endTime;
      sess.endTime = now;
      recalcSessionTimes(sess);
      sess.endTime = tempEndTime; // æ¢å¤åŸå€¼
      
      // ğŸ”¥ éªŒè¯è®¡ç®—ç»“æœ
      if(isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
        console.error(`å¢é‡åŒæ­¥æ—¶å‘ç°NaN: ${sess.studentName}`);
        return;
      }
      
      if(!dailyPracticeRecords[today]) {
        dailyPracticeRecords[today] = {};
      }
      
      if(!dailyPracticeRecords[today][sess.studentName]) {
        dailyPracticeRecords[today][sess.studentName] = {
          inSlot: 0,
          outSlot: 0,
          totalSessions: 0,
          sessions: [],
          lastUpdated: 0
        };
      }
      
      const rec = dailyPracticeRecords[today][sess.studentName];
      
      // ğŸ”¥ æ›´æ–°ç´¯è®¡æ—¶é•¿
      rec.inSlot = Math.max(0, Math.floor(sess.inSlotTime));
      rec.outSlot = Math.max(0, Math.floor(sess.outSlotTime));
      rec.lastUpdated = now;
      
      // ğŸ”¥ ä¿å­˜åˆ°æœ¬åœ°
      try {
        localStorage.setItem('practiceRecords_' + today, JSON.stringify(dailyPracticeRecords[today]));
      } catch(e) {
        console.error('å¢é‡åŒæ­¥æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
      }
      
      // ğŸ”¥ åŒæ­¥åˆ°äº‘ç«¯
      if(isOnline && database) {
        const updateData = {
          inSlotSeconds: rec.inSlot,
          outSlotSeconds: rec.outSlot,
          lastUpdated: rec.lastUpdated,
          totalSessions: rec.totalSessions || 0,
          running: true
        };
        
        // ğŸ”¥ éªŒè¯æ•°æ®
        Object.keys(updateData).forEach(key => {
          if(typeof updateData[key] === 'number' && (isNaN(updateData[key]) || !isFinite(updateData[key]))) {
            console.error(`å¢é‡åŒæ­¥å‘ç°æ— æ•ˆæ•°å€¼ ${key}: ${updateData[key]}`);
            updateData[key] = 0;
          }
        });
        
        database.ref(`practiceRecords/${today}/${sess.studentName}`).update(updateData)
          .catch(e => console.error('å¢é‡åŒæ­¥å¤±è´¥:', e));
      }
      
    } catch(e) {
      console.error(`å¢é‡åŒæ­¥å‡ºé”™: ${sess.studentName}`, e);
    }
  });
}
/* =============== å‡ºå‹¤çŠ¶æ€ / ç»Ÿè®¡ =============== */
function shouldStudentBePresent(name,wd,curMin){
  if(wd===0||wd===6)return false;
  const map={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const key=map[wd];
  if(!key||!studentTimeSlots[name]||!studentTimeSlots[name][key])return false;
  return studentTimeSlots[name][key].some(s=>{
    const sm=timeToMinutes(s.start),em=timeToMinutes(s.end);
    return curMin>=sm&&curMin<em;
  });
}
function getStudentCurrentStatus(name,presentSet,excuses,wd,curMin){
  // è¯­ä¹‰ï¼š
  // present: åœ¨è§„å®šæ—¶é—´æ®µå†…ç»ƒç´
  // absent: åœ¨è§„å®šæ—¶é—´æ®µå†…ä½†æœªç»ƒç´
  // practicing-unscheduled: ä¸åœ¨è§„å®šæ—¶é—´æ®µå†…ä½†åœ¨ç»ƒç´ï¼ˆè‡ªä¸»ç»ƒç´ï¼‰
  // not-practicing: ä¸åœ¨è§„å®šæ—¶é—´æ®µå†…ä¸”æœªç»ƒç´
  // excused: è¯·å‡ä¼˜å…ˆçº§æœ€é«˜
  if(excuses[name]) return 'excused';
  const practicing = presentSet.has(name);
  const map={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const key=map[wd];
  let inSlot=false;
  if(key && studentTimeSlots[name] && studentTimeSlots[name][key]){
    inSlot = studentTimeSlots[name][key].some(sl=>{
      const sm=timeToMinutes(sl.start),em=timeToMinutes(sl.end);
      return curMin>=sm && curMin<em;
    });
  }
  if(inSlot){
    return practicing ? 'present' : 'absent';
  } else {
    return practicing ? 'practicing-unscheduled' : 'not-practicing';
  }
}
function getStatusClass(s){
  switch(s){
    case 'present':return 'present';
    case 'absent':return 'absent';
    case 'excused':return 'excused';
    case 'practicing-unscheduled':return 'self-practice'; // æ”¹ä¸ºç´«è‰²ç±»
    case 'not-practicing':return 'not-practicing';
    default:return 'pending';
  }
}
function getStatusText(s){
  switch(s){
    case 'present':return t('status.present','å‡ºå‹¤');
    case 'absent':return t('status.absent','ç¼ºå‹¤');
    case 'excused':return t('status.excused','è¯·å‡');
    case 'practicing-unscheduled':return t('status.practicing_unscheduled','è‡ªä¸»ç»ƒç´');
    case 'not-practicing':return t('status.not_practicing','æœªç»ƒç´');
    default:return t('status.pending','å¾…è€ƒå‹¤');
  }
}
function updateStatsPanel(){
  // ğŸ”’ æ•°æ®å°±ç»ªä¿æŠ¤ï¼šè‹¥å…³é”®æ•°æ®å°šæœªåŒæ­¥ï¼Œé¿å…é¦–å±è¯¯åˆ¤
  if(!studentDatabase || Object.keys(studentDatabase).length===0) return;
  // ä»¥å‰è¿™é‡Œå¼ºåˆ¶ç­‰å¾… studentTimeSlots å¯¼è‡´è‡ªä¸»ç»ƒç´äººæ•°å§‹ç»ˆä¸º 0ï¼ˆè¯¾è¡¨æœªåŠ è½½æ—¶ç›´æ¥é€€å‡ºï¼‰
  // ç°åœ¨æ”¾å®½ï¼šè‹¥è¯¾è¡¨æœªåŠ è½½ï¼Œåˆ™è®¤ä¸ºæ‰€æœ‰â€œåœ¨æˆ¿é—´â€çš„å­¦ç”Ÿéƒ½è§†ä¸ºè‡ªä¸»ç»ƒç´ï¼ˆä¸è®¡å…¥å‡ºå‹¤/ç¼ºå‹¤ï¼‰ï¼Œç¦»å¼€æˆ¿é—´çš„æš‚ä¸ç»Ÿè®¡
  const timeSlotsLoaded = studentTimeSlots && Object.keys(studentTimeSlots).length>0;
  const students=flattenStudents();
  const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
  const today=formatDate(new Date());
  const excuses=excuseData[today]||{};
  const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
  let present=0,absent=0,excused=0,selfPractice=0;
  let excludedTotalSec=0;
  students.forEach(s=>{
    // å½“è¯¾è¡¨æœªåŠ è½½æ—¶ï¼šåªåŒºåˆ† æ˜¯å¦åœ¨æˆ¿é—´ + æ˜¯å¦è¯·å‡
    let st;
    if(!timeSlotsLoaded){
      if(excuses[s.name]) st='excused';
      else if(presentSet.has(s.name)) st='practicing-unscheduled';
      else st='not-practicing';
    } else {
      st=getStudentCurrentStatus(s.name,presentSet,excuses,wd,curMin);
    }
    if(st==='present')present++;
    else if(st==='absent')absent++;
    else if(st==='excused')excused++;
    else if(st==='practicing-unscheduled')selfPractice++;
    // èšåˆä»Šæ—¥å‰”é™¤ç§’ (ä»…å¯¹æœ‰è®°å½•çš„å­¦ç”Ÿå°è¯•)
    try{
      const dio=computeDayInOut(s.name,today);
      if(dio && typeof dio.excludedSecUnion==='number') excludedTotalSec+=dio.excludedSecUnion;
    }catch(_e){}
  });
  setText('presentCount',present);
  setText('absentCount',absent);
  setText('excusedCount',excused);
  // å…¼å®¹æ—§ IDï¼špendingCount åŸæœ¬ç”¨äºå¾…è€ƒå‹¤ï¼Œç°åœ¨æ”¹ä¸ºæ˜¾ç¤ºè‡ªä¸»ç»ƒç´ï¼Œæ­£å¼ä½¿ç”¨ selfPracticeCount
  setText('selfPracticeCount',selfPractice);
  const legacyPendingEl=document.getElementById('pendingCount');
  if(legacyPendingEl){ legacyPendingEl.textContent=selfPractice; }
  const excludedMin=Math.round(excludedTotalSec/60);
  const excludedElId='excludedMinutesStat';
  let statHost=document.getElementById(excludedElId);
  if(!statHost){
    const container=document.getElementById('statsPanel');
    if(container){
      const div=document.createElement('div');div.className='stat-card';div.id=excludedElId;container.appendChild(div);statHost=div;
    }
  }
  if(statHost){ statHost.textContent=t('break.excluded_minutes','å‰”é™¤åˆ†é’Ÿ')+': '+excludedMin; }
}

/* =============== å®æ—¶ç»ƒç´åˆ—è¡¨ =============== */
function formatDuration(sec, mode='auto'){
  // mode = 'auto' | 'minuteOnly'
  if(sec==null || isNaN(sec)) return currentLanguage==='en' ? '0min' : '0åˆ†é’Ÿ';
  sec = Math.max(0, Math.floor(sec)); // ç»Ÿä¸€è½¬ä¸ºæ•´æ•°ç§’
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;

  if(currentLanguage === 'en'){
    if(h){
      if(m) return `${h}h ${m}m`;
      return `${h}h`;
    }
    if(m){
      if(s && mode!=='minuteOnly') return `${m}m ${s}s`;
      return `${m}m`;
    }
    return `${s}s`;
  }else{
    if(h){
      if(m) return `${h}å°æ—¶${m}åˆ†é’Ÿ`;
      return `${h}å°æ—¶`;
    }
    if(m){
      if(s && mode!=='minuteOnly') return `${m}åˆ†é’Ÿ${s}ç§’`;
      return `${m}åˆ†é’Ÿ`;
    }
    return `${s}ç§’`;
  }
}

function renderPracticeArea(){
  const el=document.getElementById('practiceStatusContainer');if(!el)return;
  // è®°å¿†å½“å‰ç­›é€‰ï¼ˆå¦‚æœå·²æœ‰ï¼‰
  const prevMajor=document.getElementById('practiceMajorFilter')?.value||'';
  const prevGrade=document.getElementById('practiceGradeFilter')?.value||'';
  const prevKw=document.getElementById('practiceStudentSearch')?.value||'';
  const names=Object.keys(realTimePracticeMap);
  if(!names.length){
    el.innerHTML=`<div class="practice-filters"><div class="practice-filter-row">
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.major','ä¸“ä¸šç­›é€‰')}</label>
      <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
        <option value="">${t('filter.all_majors','æ‰€æœ‰ä¸“ä¸š')}</option></select></div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.grade','å¹´çº§ç­›é€‰')}</label>
      <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
        <option value="">${t('filter.all_grades','æ‰€æœ‰å¹´çº§')}</option></select></div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.search','æœç´¢å­¦ç”Ÿ')}</label>
      <input id="practiceStudentSearch" class="practice-filter-input" placeholder="${t('filter.search_placeholder','è¾“å…¥å­¦ç”Ÿå§“å...')}" oninput="filterPracticeStatus()"></div>
    </div>
    <div id="practiceStudentList" class="student-grid" style="margin-top:20px;">
      <div class="practice-empty-state" style="grid-column:1/-1;">
        <div class="practice-empty-state-icon">ğŸµ</div>
        <div class="practice-empty-state-title">${t('practice.empty.title','å½“å‰æ²¡æœ‰å­¦ç”Ÿåœ¨ç»ƒç´')}</div>
        <div class="practice-empty-state-description">${t('practice.empty.desc.weekday','ç­‰å¾…å­¦ç”Ÿå¼€å§‹ç»ƒç´')}</div>
      </div>
    </div></div>`;
    return;
  }
  names.sort((a,b)=>realTimePracticeMap[b].currentSec-realTimePracticeMap[a].currentSec);
  const majors=new Set(),grades=new Set();
  names.forEach(n=>{const info=getStudentInfo(n);if(info.major)majors.add(info.major);if(info.grade)grades.add(info.grade);});
  let mf=[...majors].sort().map(m=>`<option value="${m}">${m}</option>`).join('');
  let gf=[...grades].sort().map(g=>`<option value="${g}">${g}</option>`).join('');
  let cards=names.map(n=>{
      const info=getStudentInfo(n),p=realTimePracticeMap[n];
      const st=new Date(p.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'});
      // ğŸ”¥ è·å–å½“å‰æ—¶é—´ä¿¡æ¯ç”¨äºçŠ¶æ€åˆ¤æ–­
      const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
      const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
      const todayExcuses=excuseData[getTodayDateString()]||{};
      const currentStatus=getStudentCurrentStatus(n,presentSet,todayExcuses,wd,curMin);
      const statusText=getDetailedStatusText(n,currentStatus,p,wd,curMin);
      const statusClass=getStatusClass(currentStatus);
          const br=currentBreakInfo(now);
          const breakBadge = br ? `<div class=\"break-badge\" data-break=\"1\" data-label-key=\"${br.labelKey}\" data-end-minute=\"${br.endMinute}\">${br.label}</div>` : '';
      
  const todayTotalMin = getTodayTotalPracticeMinutes(n);
  const todayTotalText = formatTotalPracticeTime(todayTotalMin);
  return `<div class="practice-status-card compact ${statusClass}" onclick="openStudentDetail('${n}')">
        <div class="practice-indicator"></div>
        <div class="compact-content">
          <div class="student-name-compact">${n}</div>
          <div class="student-info-row"><span>${info.major||''}</span><span class="info-divider">â€¢</span><span>${info.grade||t('student.not_set','æœªè®¾ç½®')}</span></div>
          <div class="student-info-row"><span>ğŸ• ${st}</span><span class="info-divider">â€¢</span><span>ğŸ  ${p.room}</span></div>
          <div class="status-duration-row">
            <div class="student-status-compact ${statusClass}">${statusText}</div>
            ${breakBadge}
            <div class="practice-duration-large" title="ä»Šæ—¥æ€»è®¡">${todayTotalText}</div>
          </div>
        </div></div>`;
    }).join('');
  el.innerHTML=`
  <div class="practice-filters">
    <div class="practice-filter-row">
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.major','ä¸“ä¸šç­›é€‰')}</label>
        <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
          <option value="">${t('filter.all_majors','æ‰€æœ‰ä¸“ä¸š')}</option>${mf}
        </select>
      </div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.grade','å¹´çº§ç­›é€‰')}</label>
        <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
          <option value="">${t('filter.all_grades','æ‰€æœ‰å¹´çº§')}</option>${gf}
        </select>
      </div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.search','æœç´¢å­¦ç”Ÿ')}</label>
        <input type="text" id="practiceStudentSearch" class="practice-filter-input" placeholder="${t('filter.search_placeholder','è¾“å…¥å­¦ç”Ÿå§“å...')}" oninput="filterPracticeStatus()">
      </div>
    </div>
    <div id="practiceStudentList" class="student-grid" style="margin-top:20px;">${cards}</div>
  </div>`;

  // æ¢å¤ç­›é€‰çŠ¶æ€
  const majorSel=document.getElementById('practiceMajorFilter');
  if(majorSel && prevMajor && [...majorSel.options].some(o=>o.value===prevMajor)) majorSel.value=prevMajor;
  const gradeSel=document.getElementById('practiceGradeFilter');
  if(gradeSel && prevGrade && [...gradeSel.options].some(o=>o.value===prevGrade)) gradeSel.value=prevGrade;
  const kwInput=document.getElementById('practiceStudentSearch');
  if(kwInput && prevKw) kwInput.value=prevKw;
  if(prevMajor||prevGrade||prevKw){ try{filterPracticeStatus();}catch(e){console.warn('apply filters fail',e);} }
}

// ===== ä¼‘æ¯å€’è®¡æ—¶åˆ·æ–° =====
function updateBreakCountdowns(){
  const badges=document.querySelectorAll('.break-badge[data-break="1"]');
  if(!badges.length) return;
  const now=new Date();
  const info=currentBreakInfo(now);
  badges.forEach(b=>{
    if(!info){ b.remove(); return; }
    const total=(info.endMinute-info.startMinute)*60; // ç§’
    const remain=info.remainSec; // ç§’
    const passed=Math.max(0,total-remain);
    const pct= total>0 ? Math.min(100,Math.max(0, (passed/total)*100)) : 0;
    const mm=Math.floor(remain/60),ss=remain%60;
    const label=t(info.labelKey,info.label);
    // è¯†åˆ«ç±»å‹
    let type='recess';
    if(/lunch_concert/.test(info.labelKey)) type='concert';
    else if(/lunch/.test(info.labelKey)) type='lunch';
    else if(/large/.test(info.labelKey)) type='large';
    else if(/recess/.test(info.labelKey)) type='recess';
    b.dataset.breakType=type;
    // æ„é€ å†…éƒ¨ç»“æ„ï¼ˆè‹¥ç¬¬ä¸€æ¬¡ï¼‰
    if(!b._enhanced){
      b.innerHTML=`<div class="bb-head"><span class="bb-icon">â±ï¸</span><span class="bb-title"></span><span class="bb-remain"></span></div><div class="bb-line"><div class="bb-fill"></div></div>`;
      b._enhanced=true;
    }
    const titleEl=b.querySelector('.bb-title');
    const remainEl=b.querySelector('.bb-remain');
    const fillEl=b.querySelector('.bb-fill');
    if(titleEl) titleEl.textContent=label;
    if(remainEl){
      remainEl.textContent=`${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
      remainEl.classList.toggle('urgent', remain<=60);
    }
    if(fillEl){ fillEl.style.width=pct.toFixed(1)+'%'; }
  });
}
setInterval(()=>{
  try{updateBreakCountdowns();}catch(e){console.warn('updateBreakCountdowns error',e);}
},1000);
function filterPracticeStatus(){
  const major=document.getElementById('practiceMajorFilter')?.value||'';
  const grade=document.getElementById('practiceGradeFilter')?.value||'';
  const kw=document.getElementById('practiceStudentSearch')?.value.trim().toLowerCase()||'';
  const list=document.getElementById('practiceStudentList');
  if(!list)return;
  let names=Object.keys(realTimePracticeMap);
  names=names.filter(n=>{
    const info=getStudentInfo(n);
    if(major && info.major!==major) return false;
    if(grade && info.grade!==grade) return false;
    if(kw && !n.toLowerCase().includes(kw)) return false;
    return true;
  });
  if(!names.length){
    list.innerHTML=`<div class="practice-empty-state" style="grid-column:1/-1;">
      <div class="practice-empty-state-icon">ğŸ”</div>
      <div class="practice-empty-state-title">${t('filter.no_results','æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿ')}</div>
      <div class="practice-empty-state-description">${t('filter.try_different','è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶')}</div>
    </div>`;
    return;
  }
  names.sort((a,b)=>realTimePracticeMap[b].currentSec-realTimePracticeMap[a].currentSec);
  list.innerHTML=names.map(n=>{
    const info=getStudentInfo(n),p=realTimePracticeMap[n];
    const st=new Date(p.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'});
  const todayTotalMin = getTodayTotalPracticeMinutes(n);
  const todayTotalText = formatTotalPracticeTime(todayTotalMin);
      // ä¸åˆå§‹æ¸²æŸ“ä¿æŒä¸€è‡´ï¼šéœ€è¦çŠ¶æ€ã€çŠ¶æ€ç±»ã€ä¼‘æ¯å¾½ç« ã€æ€»è®¡
      const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
      const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
      const todayExcuses=excuseData[getTodayDateString()]||{};
      const currentStatus=getStudentCurrentStatus(n,presentSet,todayExcuses,wd,curMin);
      const statusText=getDetailedStatusText(n,currentStatus,p,wd,curMin);
      const statusClass=getStatusClass(currentStatus);
      const br=currentBreakInfo(now);
      const breakBadge = br ? `<div class=\"break-badge\" data-break=\"1\" data-label-key=\"${br.labelKey}\" data-end-minute=\"${br.endMinute}\">${br.label}</div>` : '';
      return `<div class="practice-status-card compact ${statusClass}" onclick="openStudentDetail('${n}')">
        <div class="practice-indicator"></div>
        <div class="compact-content">
          <div class="student-name-compact">${n}</div>
          <div class="student-info-row"><span>${info.major||''}</span><span class="info-divider">â€¢</span><span>${info.grade||t('student.not_set','æœªè®¾ç½®')}</span></div>
          <div class="student-info-row"><span>ğŸ• ${st}</span><span class="info-divider">â€¢</span><span>ğŸ  ${p.room}</span></div>
          <div class="status-duration-row">
            <div class="student-status-compact ${statusClass}">${statusText}</div>
            ${breakBadge}
            <div class="practice-duration-large" title="ä»Šæ—¥æ€»è®¡">${todayTotalText}</div>
          </div>
        </div></div>`;
  }).join('');
}

/* =============== å­¦ç”Ÿåˆ—è¡¨ =============== */
function populateFilters(){
  const majorSel=document.getElementById('majorFilter');
  const gradeSel=document.getElementById('gradeFilter');
  if(majorSel){
    const cur=majorSel.value;
    majorSel.innerHTML=`<option value="">${t('filter.all_majors','æ‰€æœ‰ä¸“ä¸š')}</option>`+
      Object.keys(studentDatabase).sort().map(m=>`<option value="${m}">${m}</option>`).join('');
    if(cur && Object.keys(studentDatabase).includes(cur))majorSel.value=cur;
  }
  if(gradeSel){
    const set=new Set();flattenStudents().forEach(s=>{if(s.grade)set.add(s.grade);});
    const cur=gradeSel.value;
    gradeSel.innerHTML=`<option value="">${t('filter.all_grades','æ‰€æœ‰å¹´çº§')}</option>`+
      [...set].sort().map(g=>`<option value="${g}">${g}</option>`).join('');
    if(cur && set.has(cur))gradeSel.value=cur;
  }
}
function renderStudentList(){
  const container=document.getElementById('studentList');if(!container)return;
  const all=flattenStudents();
  if(!all.length){container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“‚</div><div class="empty-state-title">${t('empty.no_students','æš‚æ— å­¦ç”Ÿæ•°æ®')}</div></div>`;return;}
  const major=document.getElementById('majorFilter').value;
  const grade=document.getElementById('gradeFilter').value;
  const status=document.getElementById('statusFilter').value;
  const kw=document.getElementById('studentSearch').value.trim().toLowerCase();
  const today=formatDate(new Date());
  const excuses=excuseData[today]||{};
  const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
  const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
  let list = all.filter(s => {
    if (major && s.major !== major) return false;
    if (grade && s.grade !== grade) return false;
    if (kw && !s.name.toLowerCase().includes(kw)) return false;
    
    const p = realTimePracticeMap[s.name];
    const basicStatus = getStudentCurrentStatus(s.name, presentSet, excuses, wd, curMin);
    const detailedStatus = getDetailedStatus(s.name, basicStatus, p, wd, curMin);
    
    s._status = basicStatus;        // ç”¨äºæ ·å¼ç±»
    s._detailedStatus = detailedStatus; // ç”¨äºç­›é€‰
    
    // ğŸ”¥ ä¿®æ­£ï¼šç»Ÿä¸€ä½¿ç”¨åŸºç¡€çŠ¶æ€è¿›è¡Œç­›é€‰ï¼Œç¡®ä¿ç¼ºå‹¤åˆ¤æ–­ä¸€è‡´
    // ç¼ºå‹¤ = åœ¨æ—¶é—´æ®µå†…ä½†æ²¡æœ‰ç»ƒç´
    if (status && status !== basicStatus) return false;
    return true;
  });

  if(!list.length){container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><div class="empty-state-title">${t('filter.no_results','æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿ')}</div></div>`;return;}
  list.sort((a,b)=>a.name.localeCompare(b.name,'zh-CN'));

  // è½»é‡è™šæ‹ŸåŒ–ï¼šé¦–æ‰¹ + åˆ†å— appendï¼Œé™ä½ä¸»çº¿ç¨‹é•¿ä»»åŠ¡
  const BATCH=40; // é¦–æ‰¹æ¸²æŸ“æ•°é‡
  const CHUNK=50; // åç»­æ¯æ‰¹
  const INTERVAL=16; // æ¯å¸§æˆ–ç©ºé—²é—´éš”ï¼ˆmsï¼‰
  function cardHTML(s){
    const p = realTimePracticeMap[s.name];
  const room = p ? p.room : t('student.not_in_room','ä¸åœ¨ç´æˆ¿');
  const todayTotalMin = getTodayTotalPracticeMinutes(s.name);
  const dur = formatTotalPracticeTime(todayTotalMin);
    const detailedStatus = getDetailedStatus(s.name, s._status, p, wd, curMin);
    const cls = getStatusClass(detailedStatus);
    const statusText = getDetailedStatusText(s.name, s._status, p, wd, curMin);
    return `<div class="practice-status-card compact ${cls}" onclick="openStudentDetail('${s.name}')">
      ${p ? '<div class="practice-indicator"></div>' : ''}
      <div class="compact-content">
        <div class="student-name-compact">${s.name}</div>
        <div class="student-info-row"><span>${s.major||''}</span><span class="info-divider">â€¢</span><span>${s.grade||t('student.not_set','æœªè®¾ç½®')}</span></div>
        <div class="student-info-row"><span>${room}</span></div>
        <div class="status-duration-row">
          <div class="student-status-compact ${cls}">${statusText}</div>
          <div class="practice-duration-large" title="ä»Šæ—¥æ€»è®¡">${dur}</div>
        </div>
      </div></div>`;
  }
  // é¦–æ‰¹
  const first=list.slice(0,BATCH);
  container.innerHTML=first.map(cardHTML).join('');
  if(list.length<=BATCH)return;
  // åç»­æ‰¹æ¬¡
  let index=BATCH;
  function appendChunk(){
    if(index>=list.length)return;
    const frag=document.createDocumentFragment();
    const end=Math.min(index+CHUNK,list.length);
    for(let i=index;i<end;i++){
      const div=document.createElement('div');
      div.innerHTML=cardHTML(list[i]);
      frag.appendChild(div.firstChild);
    }
    queueDomUpdate(()=>container.appendChild(frag));
    index=end;
    if(index<list.length){
      if('requestIdleCallback' in window){requestIdleCallback(appendChunk,{timeout:200});}
      else setTimeout(appendChunk,INTERVAL);
    }
  }
  if('requestIdleCallback' in window){requestIdleCallback(appendChunk,{timeout:300});}
  else setTimeout(appendChunk,INTERVAL);
}
function filterStudents(){renderStudentList();}
function getDetailedStatus(studentName, currentStatus, practice, weekday, currentMinute) {
  // è¯¦ç»†çŠ¶æ€æ­¤å¤„ä¸åŸºç¡€çŠ¶æ€ä¸€è‡´ï¼ˆä¿ç•™æ‰©å±•ç‚¹ï¼‰
  return currentStatus;
}

/* =============== è¯·å‡é¢æ¿ =============== */
function renderExcusePanel(){
  const today=formatDate(new Date());
  const data=excuseData[today]||{};
  const keys=Object.keys(data);
  const panel=document.getElementById('excuseInfoPanel');
  const box=document.getElementById('excuseInfoContainer');
  if(!keys.length){panel.style.display='none';return;}
  panel.style.display='block';
  box.innerHTML='<div class="student-grid">'+keys.map(n=>{
    const ex=data[n];
    return `<div class="student-card excused" style="min-height:180px;">
      <div class="student-header">
        <div class="student-name">${n}</div>
        <div class="student-status excused">${t('status.excused','è¯·å‡')}</div>
      </div>
      <div class="student-details">
        <div class="detail-item"><div class="detail-label">${t('excuse.reason','è¯·å‡åŸå› ')}</div><div class="detail-value">${ex.reason||t('excuse.not_filled','æœªå¡«å†™')}</div></div>
        ${ex.durationText?`<div class="detail-item"><div class="detail-label">${t('excuse.duration_text','è¯·å‡æ—¶é•¿')}</div><div class="detail-value">${ex.durationText}</div></div>`:''}
        ${ex.endDate?`<div class="detail-item"><div class="detail-label">${t('excuse.end_date','ç»“æŸæ—¥æœŸ')}</div><div class="detail-value">${ex.endDate}</div></div>`:''}
      </div></div>`;
  }).join('')+'</div>';
}

/* =============== âœ… å®æ—¶è€ƒå‹¤å¢å¼ºï¼šå®æ—¶ / å¿«ç…§ / åˆå¹¶æ„å»ºå‡½æ•° =============== */

/**** ======= æ–°å¢è¾…åŠ©å‡½æ•° å¼€å§‹ ======= ****/

/**
 * è·å–å­¦ç”Ÿä»Šå¤©æ‰€æœ‰ç»ƒç´åŒºé—´ï¼ˆå«æ­£åœ¨è¿›è¡Œçš„ï¼‰
 * æ¯ä¸ªåŒºé—´ï¼š{ start: ms, end: ms, room: string }
 * prep æ—¶é—´ï¼ˆé¦–åˆ†é’Ÿï¼‰ä¸è®¡å…¥æ­£å¼æ—¶é•¿ï¼šstart ç”¨ prepEndTime
 */
function getStudentTodayIntervals(studentName){
  const todayKey = getTodayDateString();
  const intervals = [];

  // 1. å·²ç»“æŸä¼šè¯ï¼ˆä¼˜å…ˆä½¿ç”¨è¯¦ç»†çš„ sessions æ•°æ®ï¼‰
  const rec = dailyPracticeRecords[todayKey] && dailyPracticeRecords[todayKey][studentName];
  if(rec && Array.isArray(rec.sessions)){
    rec.sessions.forEach(s=>{
      if(!s.start || !s.end) return;
      const start = s.start + 60000; // å»é™¤1åˆ†é’Ÿå‡†å¤‡
      if(start >= s.end) return;
      intervals.push({
        start,
        end: s.end,
        room: s.room || t('room.practice_room', 'ç»ƒç´æˆ¿')
      });
    });
  }

  // 2. æ­£åœ¨è¿›è¡Œçš„ä¼šè¯ï¼ˆpracticeSessionTrackerï¼‰
  practiceSessionTracker.forEach(sess=>{
    if(!sess.isActive) return;
    if(sess.studentName !== studentName) return;
    const activeStart = Math.max(sess.prepEndTime, sess.startTime + 60000);
    const end = Date.now();
    if(activeStart < end){
      intervals.push({
        start: activeStart,
        end,
        room: sess.roomName
      });
    }
  });

  // 3. å¦‚æœæ²¡æœ‰è¯¦ç»†ä¼šè¯æ•°æ®ï¼Œå°è¯•æ ¹æ®æ±‡æ€»æ•°æ®å’Œæ’è¯¾æ—¶æ®µé‡å»º
  if (intervals.length === 0) {
    const today = getTodayDateString();
    const rec = dailyPracticeRecords[today] && dailyPracticeRecords[today][studentName];
    if (rec && (rec.inSlotSeconds || rec.inSlot)) {
      // æ ¹æ®ä»Šæ—¥æ’è¯¾æ‹†åˆ†
      const wd = new Date().getDay();
      const map = {1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
      const key = map[wd];
      const slots = (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) ? studentTimeSlots[studentName][key] : [];
      let remain = rec.inSlotSeconds || rec.inSlot || 0;
      
      slots.forEach(slot=>{
        if (remain <= 0) return;
        const slotStart = new Date(`${today}T${slot.start}:00`).getTime();
        const slotEnd   = new Date(`${today}T${slot.end}:00`).getTime();
        const slotSec   = (slotEnd - slotStart)/1000;
        const use = Math.min(remain, slotSec);
        if (use > 0) {
          intervals.push({
            start: slotStart,
            end: slotStart + use*1000,
            room: t('room.historical_rebuild', 'ï¼ˆå†å²é‡å»ºï¼‰')
          });
          remain -= use;
        }
      });
    }
  }

  return intervals;
}


// ğŸ”¥ æ–°å¢ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å‡½æ•°
function validatePracticeData(studentName, date) {
  const rec = dailyPracticeRecords[date] && dailyPracticeRecords[date][studentName];
  if(!rec) return false;
  
  // æ£€æŸ¥æ˜¯å¦æœ‰è¯¦ç»†ä¼šè¯è®°å½•
  if(!rec.sessions || !Array.isArray(rec.sessions) || rec.sessions.length === 0) {
    console.warn(`${studentName} ${date} ç¼ºå°‘è¯¦ç»†ä¼šè¯è®°å½•`);
    return false;
  }
  
  // æ£€æŸ¥ç´¯è®¡æ—¶é•¿æ˜¯å¦ä¸ä¼šè¯è®°å½•åŒ¹é…
  let totalInSlot = 0, totalOutSlot = 0;
  rec.sessions.forEach(s => {
    totalInSlot += (s.inSlot || 0);
    totalOutSlot += (s.outSlot || 0);
  });
  
  const recordedInSlot = rec.inSlotSeconds || rec.inSlot || 0;
  const recordedOutSlot = rec.outSlotSeconds || rec.outSlot || 0;
  
  if(Math.abs(totalInSlot - recordedInSlot) > 60 || Math.abs(totalOutSlot - recordedOutSlot) > 60) {
    console.warn(`${studentName} ${date} æ•°æ®ä¸ä¸€è‡´: ä¼šè¯ç´¯è®¡(${totalInSlot},${totalOutSlot}) vs è®°å½•(${recordedInSlot},${recordedOutSlot})`);
    return false;
  }
  
  return true;
}

/**
 * è®¡ç®—ä¸€ä¸ªåŒºé—´æ•°ç»„ä¸ç›®æ ‡(timeStart,timeEnd) çš„æ€»é‡å ç§’æ•°
 */
function calcOverlapSeconds(intervals, slotStartMs, slotEndMs){
  // ä¿æŠ¤ï¼šæ— åŒºé—´ / é€†åºæ—¶é—´æ®µ
  if(!Array.isArray(intervals) || intervals.length===0) return 0;
  if(slotEndMs <= slotStartMs) return 0;

  // 1. å…ˆè£å‰ªåˆ° slot è¾¹ç•Œï¼Œå¹¶è¿‡æ»¤æ— æ•ˆ / ç»“æŸæ—©äºå¼€å§‹çš„
  const clipped = [];
  for(const it of intervals){
    if(!it || typeof it.start!== 'number' || typeof it.end!== 'number') continue;
    let st = Math.max(it.start, slotStartMs);
    let en = Math.min(it.end, slotEndMs);
    if(en - st >= 1000) { // è‡³å°‘ 1 ç§’
      clipped.push({start: st, end: en});
    }
  }
  if(clipped.length===0) return 0;

  // 2. æŒ‰å¼€å§‹æ—¶é—´æ’åº
  clipped.sort((a,b)=>a.start-b.start);

  // 3. åˆå¹¶é‡å /ç›¸é‚»(<=1s è§†ä¸ºç›¸é‚») åŒºé—´ï¼Œé¿å…é‡å¤è®¡æ—¶
  const merged=[];
  let cur = clipped[0];
  for(let i=1;i<clipped.length;i++){
    const nxt = clipped[i];
    if(nxt.start <= cur.end + 1000){ // æœ‰é‡å æˆ–å‡ ä¹ç›¸é‚»
      cur.end = Math.max(cur.end, nxt.end);
    } else {
      merged.push(cur);
      cur = nxt;
    }
  }
  merged.push(cur);

  // 4. è®¡ç®—åˆå¹¶åæ€»æ¯«ç§’
  let totalMs=0;
  for(const m of merged){ totalMs += (m.end - m.start); }

  // 5. clamp åˆ° slot é•¿åº¦ï¼Œé˜²æ­¢è¾¹ç•Œè¯¯å·®å¯¼è‡´è¶…è¿‡
  const slotMs = slotEndMs - slotStartMs;
  if(totalMs > slotMs) {
    // è®°å½•ä¸€æ¬¡è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºåç»­æ’æŸ¥åŸå§‹ intervals æ˜¯å¦è¶Šç•Œ
    if(window && window.debugOverlap) {
      console.warn('[calcOverlapSeconds] totalMs è¶…å‡º slotMs, å·² clamp', {slotStart:new Date(slotStartMs).toLocaleTimeString(), slotEnd:new Date(slotEndMs).toLocaleTimeString(), totalMs, slotMs, merged});
    }
    totalMs = slotMs;
  }

  return Math.floor(totalMs/1000);
}


/**
 * é€‰å–ä¸è¯¥ slot é‡å æ—¶é•¿æœ€å¤šçš„æˆ¿é—´ï¼ˆç”¨äºå†å²å·²ç»“æŸ slot çš„æˆ¿é—´æ˜¾ç¤ºï¼‰
 */
function pickDominantRoom(intervals, slotStartMs, slotEndMs){
  const map = new Map();
  intervals.forEach(it=>{
    const st = Math.max(it.start, slotStartMs);
    const en = Math.min(it.end, slotEndMs);
    if(en > st){
      const sec = (en - st)/1000;
      map.set(it.room, (map.get(it.room)||0)+sec);
    }
  });
  let bestRoom = '';
  let maxSec = 0;
  for(const [room,sec] of map.entries()){
    if(sec > maxSec){
      maxSec = sec;
      bestRoom = room;
    }
  }
  return bestRoom;
}

/**** ======= æ–°å¢è¾…åŠ©å‡½æ•° ç»“æŸ ======= ****/


/**
 * æ›¿æ¢åçš„ buildRealtimeAttendanceDetail
 * å®ç°ï¼šåˆ©ç”¨å½“å¤©æ‰€æœ‰ç»ƒç´åŒºé—´å¯¹æ¯ä¸ªæ’è¯¾ slot åšé‡å è®¡ç®—
 */
function buildRealtimeAttendanceDetail(studentName, date){
  const detail = {present:0, absent:0, excused:0, lowEfficiency:0, pending:0, details:[]};
  
  // 1. æ£€æŸ¥è¯·å‡çŠ¶æ€
  const excuses = excuseData[date] || {};
  if(excuses[studentName]){
    detail.excused++;
    detail.details.push({
      timeSlot: 'å…¨å¤©',
      status: 'excused',
      practiceTime: t('status.excused', 'è¯·å‡'),
      room: t('status.excused', 'è¯·å‡'),
      statusText: t('status.excused', 'è¯·å‡'),
      excuseReason: excuses[studentName].reason || ''
    });
    return detail;
  }

  // 2. è·å–æ—¥æœŸä¿¡æ¯
  const target = new Date(date);
  const wd = target.getDay();
  const map = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = map[wd];
  const isToday = (date === getTodayDateString());

  // 3. è·å–å­¦ç”Ÿå½“å¤©çš„æ—¶é—´æ®µå®‰æ’
  const slots = (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) 
                  ? studentTimeSlots[studentName][key] : [];

  // 4. ğŸ”¥ ä¿®å¤ï¼šè·å–ç»ƒç´åŒºé—´ï¼ˆæ”¯æŒå†å²æ—¥æœŸï¼‰
  let intervals = isToday ? getStudentTodayIntervals(studentName) : getHistoryIntervals(studentName, date);
  
  // å·²ç§»é™¤ summary è¡¥å¿ï¼šä¸å†æ ¹æ®ç´¯è®¡æ—¶é•¿è™šæ„åŒºé—´
  
  const now = isToday ? Date.now() : new Date(date + 'T23:59:59').getTime();

  // 5. è€ƒå‹¤åˆ¤æ–­çš„é˜ˆå€¼å¸¸é‡
  const MIN_PRESENT_SEC = 5 * 60;         // >=5åˆ†é’Ÿæ‰è®¤å¯åŸºæœ¬å‡ºå‹¤
  const EFFICIENCY_RATIO = 0.6;           // 60% æ—¶é•¿è¾¾åˆ°æ‰æ˜¯"å‡ºå‹¤"
  const MIN_ACTIVE_SEC_FOR_ONGOING = 60;  // æ­£åœ¨è¿›è¡Œçš„æ®µå†…é‡å  < 60ç§’ä»æ˜¾ç¤º pending

  // 6. å¤„ç†æ— æ—¶é—´æ®µå®‰æ’çš„æƒ…å†µ
  if(!slots.length){
    detail.pending++;
    const activeRoom = intervals.length ? (intervals[intervals.length-1].room || t('room.in_room', 'åœ¨ç´æˆ¿')) : t('room.no_arrangement', 'æ— å®‰æ’');
    const totalPracticeTime = intervals.length ? 
      formatDuration(calcOverlapSeconds(intervals, new Date(date).getTime(), now)) : 'â€”';
    
    detail.details.push({
      timeSlot: (wd === 0 || wd === 6) ? t('room.weekend', 'å‘¨æœ«') : t('room.no_arrangement', 'æ— å®‰æ’'),
      status: intervals.length ? 'present' : 'pending',
      practiceTime: totalPracticeTime,
      room: intervals.length ? activeRoom : t('room.no_arrangement', 'æ— å®‰æ’'),
      statusText: intervals.length ? t('status.present_out_slot', 'å‡ºå‹¤(æ®µå¤–)') : t('status.pending_attendance', 'å¾…è€ƒå‹¤')
    });
    
    if(intervals.length){
      detail.present++;
      detail.pending--;
    }
    return detail;
  }

  // 7. å¤„ç†æ¯ä¸ªæ—¶é—´æ®µ
  slots.forEach(slot => {
    const slotLabel = `${slot.start} - ${slot.end}`;
    const slotStartMs = new Date(`${date}T${slot.start}:00`).getTime();
    const slotEndMs = new Date(`${date}T${slot.end}:00`).getTime();
    const slotDurSec = (slotEndMs - slotStartMs) / 1000;

    let status = 'pending';
    let statusText = t('status.pending_attendance', 'å¾…è€ƒå‹¤');
    let practiceTime = '--';
    let room = '--';

  // è®¡ç®—è¯¥æ—¶é—´æ®µå†…çš„ç»ƒç´é‡å æ—¶é•¿ï¼ˆå«é˜²æŠ¤ clampï¼‰
  let overlapSec = calcOverlapSeconds(intervals, slotStartMs, slotEndMs);
  const slotMaxSecClamp = Math.floor((slotEndMs - slotStartMs)/1000);
  if(overlapSec > slotMaxSecClamp) overlapSec = slotMaxSecClamp;

    if(!isToday){
      // å†å²æ—¥æœŸï¼šæ ¹æ®å®é™…ç»ƒç´æ—¶é•¿åˆ¤æ–­
      if(overlapSec >= slotDurSec * EFFICIENCY_RATIO){
        status = 'present';
        statusText = t('status.present_text', 'å‡ºå‹¤');
      } else if(overlapSec >= MIN_PRESENT_SEC){
        status = 'low_efficiency';
        statusText = t('status.low_efficiency_text', 'ä½æ•ˆ');
      } else {
        status = 'absent';
        statusText = t('status.absent_text', 'ç¼ºå‹¤');
      }
      
      practiceTime = overlapSec > 0 ? formatDuration(overlapSec, 'minuteOnly') : t('time.no_practice', '0åˆ†é’Ÿ');
      
      if(overlapSec > 0){
        room = pickDominantRoom(intervals, slotStartMs, slotEndMs) || t('room.in_room', 'åœ¨ç´æˆ¿');
      } else {
        room = t('room.not_in_room', 'ä¸åœ¨ç´æˆ¿');
      }
    } else {
      // ä»Šæ—¥å®æ—¶åˆ¤æ–­
      if(now < slotStartMs){
        // æœªæ¥æ—¶é—´æ®µ
        status = 'pending';
        statusText = t('status.pending_attendance', 'å¾…è€ƒå‹¤');
      } else if(now >= slotEndMs){
        // å·²ç»“æŸæ—¶é—´æ®µ
        if(overlapSec >= slotDurSec * EFFICIENCY_RATIO){
          status = 'present';
          statusText = t('status.present_text', 'å‡ºå‹¤');
        } else if(overlapSec >= MIN_PRESENT_SEC){
          status = 'low_efficiency';
          statusText = t('status.low_efficiency_text', 'ä½æ•ˆ');
        } else {
          status = 'absent';
          statusText = t('status.absent_text', 'ç¼ºå‹¤');
        }
        
        practiceTime = overlapSec > 0 ? formatDuration(overlapSec, 'minuteOnly') : t('time.no_practice', '0åˆ†é’Ÿ');
        
        if(overlapSec > 0){
          room = pickDominantRoom(intervals, slotStartMs, slotEndMs) || t('room.in_room', 'åœ¨ç´æˆ¿');
        } else {
          room = t('room.not_in_room', 'ä¸åœ¨ç´æˆ¿');
        }
      } else {
        // æ­£åœ¨è¿›è¡Œä¸­çš„æ—¶é—´æ®µ
        const expectedSec = (now - slotStartMs) / 1000;
        
        if(overlapSec < MIN_ACTIVE_SEC_FOR_ONGOING){
          status = 'pending';
          statusText = t('status.pending_attendance', 'å¾…è€ƒå‹¤'); // åˆšå¼€å§‹ä¸ç«‹åˆ»åˆ¤ç¼ºå‹¤
        } else {
          if(overlapSec >= expectedSec * EFFICIENCY_RATIO){
            status = 'present';
            statusText = t('status.present_text', 'å‡ºå‹¤');
          } else {
            status = 'low_efficiency';
            statusText = t('status.low_efficiency_text', 'ä½æ•ˆ');
          }
        }
        
        practiceTime = overlapSec > 0 ? formatDuration(overlapSec, 'minuteOnly') : '--';
        
        // å½“å‰æˆ¿é—´ï¼šå– active interval æœ€åä¸€ä¸ªæˆ¿é—´
        const activeInterval = intervals[intervals.length - 1];
        room = activeInterval ? activeInterval.room : (overlapSec > 0 ? t('room.in_room', 'åœ¨ç´æˆ¿') : t('room.not_in_room', 'ä¸åœ¨ç´æˆ¿'));
      }
    }

    // ç»Ÿè®¡å„çŠ¶æ€æ•°é‡
    switch(status){
      case 'present': detail.present++; break;
      case 'absent': detail.absent++; break;
      case 'excused': detail.excused++; break;
      case 'low_efficiency': detail.lowEfficiency++; break;
      case 'pending': detail.pending++; break;
    }

    // æ·»åŠ è¯¦æƒ…è®°å½•
    detail.details.push({
      timeSlot: slotLabel,
      status,
      practiceTime,
      room,
      statusText
    });
  });

  return detail;
}



/**
 * æ„é€  snapshot è§†å›¾
 */
function buildSnapshotAttendanceDetail(studentName,date,rec){
  const detail={present:0,absent:0,excused:0,lowEfficiency:0,pending:0,details:[]};
  if(!rec){detail.pending++;detail.details.push({timeSlot:t('time.no_records', 'æ— è®°å½•'),status:'pending',practiceTime:'--',room:'--',statusText:t('status.pending_attendance', 'å¾…è€ƒå‹¤')});return detail;}
  const all=[...(rec.students||[]),...(rec.endedSlots||[])];
  const seg=all.filter(s=>s.name===studentName);
  if(!seg.length){
    detail.pending++;
    detail.details.push({timeSlot:t('time.no_records', 'æ— è®°å½•'),status:'pending',practiceTime:'--',room:'--',statusText:t('status.pending_attendance', 'å¾…è€ƒå‹¤')});
    return detail;
  }
  seg.forEach(s=>{
    const stat=s.finalAttendanceStatus||'absent';
    let text=getStatusText(stat);
    if(stat==='present')detail.present++;
    else if(stat==='excused')detail.excused++;
    else if(stat==='absent')detail.absent++;
    else if(stat==='low_efficiency')detail.lowEfficiency++;
    else detail.pending++;
    detail.details.push({
      timeSlot:`${s.start}-${s.end}`,
      status:stat,
      practiceTime:s.practicedText||t('time.no_practice', '0åˆ†é’Ÿ'),
      room:s.room|| (stat==='present'? t('room.in_room', 'åœ¨ç´æˆ¿') : t('room.not_in_room', 'ä¸åœ¨ç´æˆ¿')),
      statusText:text
    });
  });
  return detail;
}

// =====================
// åˆå¹¶ snapshot ä¸ realtime
// è§„åˆ™ï¼š
//  1. realtime present / low_efficiency æ°¸è¿œè¦†ç›–
//  2. snapshot æ˜¯ç§¯æ(present/low_efficiency) è€Œ realtime é€€åŒ–(absent/pending) -> ä¿ç•™ snapshot
//  3. realtime under_review å¯ä»¥æŠŠ snapshot çš„ absent/pending æå‡ä¸º under_review
//  4. å…¶å®ƒä¿æŒ snapshot
// =====================
// =====================
// è®¡ç®—å•ä¸ªæ—¶é—´æ®µè€ƒå‹¤çŠ¶æ€ï¼ˆä½äº 60% å³ä½æ•ˆï¼›0 ç§’æ‰ç¼ºå‹¤ï¼‰
// status: present | absent | low_efficiency | pending | under_review
// =====================
// ğŸ”¥ ç»Ÿä¸€çš„è€ƒå‹¤çŠ¶æ€è®¡ç®—å‡½æ•°
function calculateAttendanceStatus(student, slot, realtimeStatus, practicedSec, opts = {}) {
  practicedSec = Number(practicedSec); if(isNaN(practicedSec)||practicedSec<0) practicedSec=0;
  const { lowEffImmediate=false, lowEffReviewRatio=0.3 } = opts;
  const now=Date.now();
  const slotStartMs=new Date(`${getTodayDateString()}T${slot.start}:00`).getTime();
  const slotEndMs=new Date(`${getTodayDateString()}T${slot.end}:00`).getTime();
  const effectiveTotalSec=(slot.effectiveTotalSec&&slot.effectiveTotalSec>0)?slot.effectiveTotalSec:((slot.totalPlannedMinutes||0)*60);
  const efficiencyThresholdSec=Math.floor(effectiveTotalSec*0.6);
  const practicedMin=Math.floor(practicedSec/60);
  const practicedText=`${practicedMin}åˆ†é’Ÿ`;
  let practiceRatio=0; if(effectiveTotalSec>0) practiceRatio=practicedSec/effectiveTotalSec;
  const isFinished = now>=slotEndMs || slot.slotPhase==='ended';
  const pack=(status,text)=>({finalAttendanceStatus:status,finalStatusText:text,practiceRatio,practicedText,practiceDetails:`${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`});
  if(!isFinished){
    if(practicedSec<=0) return pack('under_review','è¿›è¡Œä¸­');
    if(practicedSec < efficiencyThresholdSec){
      if(lowEffImmediate) return pack('low_efficiency',`ä½æ•ˆ(è¿›è¡Œä¸­ ${(practiceRatio*100).toFixed(1)}%)`);
      if(practiceRatio < lowEffReviewRatio) return pack('under_review','è¿›è¡Œä¸­');
      return pack('low_efficiency',`ä½æ•ˆ(è¿›è¡Œä¸­ ${(practiceRatio*100).toFixed(1)}%)`);
    }
    return pack('present',`å·²å®Œæˆ ${(practiceRatio*100).toFixed(1)}% (è¿›è¡Œä¸­)`);
  }
  if(practicedSec<=0) return pack('absent','ç¼ºå‹¤(å·²ç»“æŸ)');
  if(practicedSec >= efficiencyThresholdSec) return pack('present',`å·²å®Œæˆ ${(practiceRatio*100).toFixed(1)}%`);
  return pack('low_efficiency',`ä½æ•ˆ ${(practiceRatio*100).toFixed(1)}%`);
}


// ğŸ”¥ ç»Ÿä¸€çš„ helper å‡½æ•°ï¼šæ£€æŸ¥æŸä¸ªæ—¶é—´ç‚¹æ˜¯å¦åœ¨å‡†å¤‡æœŸ
function isInPreparingPeriod(timeMs, registerTimeMs) {
  if (!registerTimeMs || isNaN(registerTimeMs)) {
    return false;
  }
  const prepEnd = registerTimeMs + 60000; // 1åˆ†é’Ÿå‡†å¤‡æœŸ
  return timeMs >= registerTimeMs && timeMs < prepEnd;
}

// ğŸ”¥ ç»Ÿä¸€çš„ helper å‡½æ•°ï¼šè·å–æœ‰æ•ˆç»ƒç´å¼€å§‹æ—¶é—´
function getEffectivePracticeStart(registerTimeMs, slotStartMs) {
  if (!registerTimeMs || isNaN(registerTimeMs)) {
    return null;
  }
  const prepEnd = registerTimeMs + 60000; // 1åˆ†é’Ÿå‡†å¤‡æœŸ
  return Math.max(prepEnd, slotStartMs || 0);
}

// ğŸ”¥ ç»Ÿä¸€çš„ helper å‡½æ•°ï¼šè®¡ç®—æ—¶é—´ç‚¹çš„ç»ƒç´çŠ¶æ€
function getPracticeStatusAtTime(timeMs, studentName, registerTimeMs, dateStr) {
  const currentDate = new Date(timeMs);
  const currentMinutes = currentDate.getHours() * 60 + currentDate.getMinutes();
  const currentWeekday = currentDate.getDay();
  
  // æ£€æŸ¥æ˜¯å¦åœ¨æ’é™¤æ—¶é—´
  if (isExcludedTime(currentMinutes, currentWeekday)) {
    return {
      isValid: false,
      reason: 'excluded',
      inSlot: false,
      inPreparingSlot: false
    };
  }
  
  // æ£€æŸ¥æ˜¯å¦åœ¨å‡†å¤‡æœŸ
  if (isInPreparingPeriod(timeMs, registerTimeMs)) {
    const slots = getStudentTodaySlots(studentName);
    const slot = findCurrentTimeSlot(slots, timeMs);
    return {
      isValid: false,
      reason: 'preparing',
      inSlot: !!slot,
      inPreparingSlot: !!slot
    };
  }
  
  // æ£€æŸ¥æ˜¯å¦åœ¨æ—¶é—´æ®µå†…
  const slots = getStudentTodaySlots(studentName);
  const slot = findCurrentTimeSlot(slots, timeMs);
  
  return {
    isValid: true,
    reason: 'valid',
    inSlot: !!slot,
    inPreparingSlot: false,
    slot: slot
  };
}

// ğŸ”¥ é‡æ„åçš„ getStudentPracticeTimeInSlot
function getStudentPracticeTimeInSlot(studentName, slot, dateStr, registerTimeMs) {
  try {
    if (!slot || !slot.start || !slot.end) {
      return { seconds: 0, inPreparingSlot: false };
    }

    // å½“å‰æ—¶é—´ï¼ˆåªç”¨äºå½“å¤©ï¼›å†å²å›æ”¾å¯æ ¹æ®éœ€è¦ä¼ å…¥ä¸€ä¸ªå›ºå®šæ—¶é—´ï¼‰
    const now = Date.now();
    const todayStr = getTodayDateString();
    const isToday = (dateStr === todayStr);

    // å¦‚æœä¸æ˜¯ä»Šå¤©ï¼Œæˆ‘ä»¬ç”¨è¯¥æ—¥ slot ç»“æŸæ—¶é—´åš"è§‚å¯Ÿæ—¶é—´ç‚¹"
    const observeNow = isToday ? now : new Date(dateStr + 'T' + slot.end + ':00').getTime();

    // æ²¡æœ‰ registerTimeï¼ˆä¸åœ¨æˆ¿é—´ / æ²¡å¼€å§‹ï¼‰
    if (!registerTimeMs || isNaN(registerTimeMs)) {
      return { seconds: 0, inPreparingSlot: false };
    }

    const slotStartMs = new Date(`${dateStr}T${slot.start}:00`).getTime();
    const slotEndMs = new Date(`${dateStr}T${slot.end}:00`).getTime();

    // æœªè¿›å…¥è¯¥æ—¶é—´æ®µ
    if (observeNow <= slotStartMs) {
      return { seconds: 0, inPreparingSlot: false };
    }

    // å·²ç»è¿‡äº†æ—¶é—´æ®µ
    if (observeNow >= slotEndMs && registerTimeMs >= slotEndMs) {
      return { seconds: 0, inPreparingSlot: false };
    }

    // ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€æ£€æŸ¥
    const statusAtObserve = getPracticeStatusAtTime(observeNow, studentName, registerTimeMs, dateStr);
    
    // æƒ…å½¢ä¸€ï¼šè¿›å…¥æ®µå†…ä½†ä»åœ¨å‡†å¤‡æœŸ
    if (statusAtObserve.inPreparingSlot) {
      return { seconds: 0, inPreparingSlot: true };
    }

    // ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„æœ‰æ•ˆå¼€å§‹æ—¶é—´è®¡ç®—
    const effectiveStart = getEffectivePracticeStart(registerTimeMs, slotStartMs);
    if (!effectiveStart) {
      return { seconds: 0, inPreparingSlot: false };
    }

    // è§‚å¯Ÿç‚¹ä¸åº”è¶…è¿‡ slotEnd
    const effectiveObserve = Math.min(observeNow, slotEndMs);

    if (effectiveObserve <= effectiveStart) {
      // å¯èƒ½æ˜¯ï¼šå‡†å¤‡æœŸè¿˜æ²¡ç»“æŸ æˆ– slot å¾ˆçŸ­
      return {
        seconds: 0,
        inPreparingSlot: (observeNow > slotStartMs && observeNow <= effectiveStart)
      };
    }

    // ğŸ”¥ æŒ‰åˆ†é’Ÿè®¡ç®—ï¼Œæ’é™¤æ’é™¤æ—¶é—´
    let validSeconds = 0;
    const startMin = Math.floor(effectiveStart / 60000) * 60000;
    const endMin = Math.floor(effectiveObserve / 60000) * 60000;
    
    for(let t = startMin; t < endMin; t += 60000) {
      const status = getPracticeStatusAtTime(t, studentName, registerTimeMs, dateStr);
      if (status.isValid && status.inSlot) {
        validSeconds += 60;
      }
    }

    return {
      seconds: Math.max(0, validSeconds),
      inPreparingSlot: false
    };
    
  } catch (e) {
    console.error('getStudentPracticeTimeInSlot é”™è¯¯', e);
    return { seconds: 0, inPreparingSlot: false };
  }
}

// ğŸ”¥ é‡æ„åçš„ recalcSessionTimes
function recalcSessionTimes(sess) {
  if (!sess || !sess.studentName) {
    console.error('ä¼šè¯å¯¹è±¡æ— æ•ˆæˆ–ç¼ºå°‘å­¦ç”Ÿå§“å');
    return;
  }
  
  // ğŸ”¥ åˆå§‹åŒ–é»˜è®¤å€¼
  sess.inSlotTime = 0;
  sess.outSlotTime = 0;
  
  const endTime = sess.endTime || Date.now();
  
  if (!sess.actualStartTime || sess.actualStartTime >= endTime) {
    console.log(`ä¼šè¯æ—¶é—´æ— æ•ˆ: ${sess.studentName}, start=${sess.actualStartTime}, end=${endTime}`);
    return;
  }
  
  // ğŸ”¥ ç¡®ä¿æ—¶é—´èŒƒå›´åˆç†ï¼ˆä¸è¶…è¿‡24å°æ—¶ï¼‰
  const maxDuration = 24 * 60 * 60 * 1000; // 24å°æ—¶
  const actualEndTime = Math.min(endTime, sess.actualStartTime + maxDuration);
  
  const startMin = Math.floor(sess.actualStartTime / 60000) * 60000;
  const endMin = Math.floor(actualEndTime / 60000) * 60000;
  
  let inSeconds = 0;
  let outSeconds = 0;
  
  // ğŸ”¥ è·å–æ—¥æœŸå­—ç¬¦ä¸²ç”¨äºçŠ¶æ€æ£€æŸ¥
  const dateStr = formatDate(new Date(sess.actualStartTime));
  
  // ğŸ”¥ æŒ‰åˆ†é’Ÿéå†æ—¶é—´æ®µï¼Œä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€æ£€æŸ¥
  for (let t = startMin; t < endMin; t += 60000) {
    try {
      // ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„ç»ƒç´çŠ¶æ€æ£€æŸ¥å‡½æ•°
      const status = getPracticeStatusAtTime(t, sess.studentName, sess.actualStartTime, dateStr);
      
      // åªæœ‰æœ‰æ•ˆæ—¶é—´æ‰è®¡å…¥ç»ƒç´æ—¶é•¿
      if (status.isValid) {
        if (status.inSlot) {
          inSeconds += 60;
        } else {
          outSeconds += 60;
        }
      }
      // æ’é™¤æ—¶é—´å’Œå‡†å¤‡æœŸéƒ½ä¸è®¡å…¥ä»»ä½•æ—¶é•¿
      
    } catch (e) {
      console.error(`è®¡ç®—æ—¶é—´æ®µå‡ºé”™: ${new Date(t)}, é”™è¯¯:`, e);
      break;
    }
  }
  
  // ğŸ”¥ æœ€ç»ˆéªŒè¯å’Œèµ‹å€¼
  sess.inSlotTime = Math.max(0, Math.floor(inSeconds));
  sess.outSlotTime = Math.max(0, Math.floor(outSeconds));
  
  // ğŸ”¥ éªŒè¯ç»“æœ
  if (isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
    console.error(`è®¡ç®—ç»“æœä¸ºNaN: ${sess.studentName}, in=${inSeconds}, out=${outSeconds}`);
    sess.inSlotTime = 0;
    sess.outSlotTime = 0;
  }
  
  console.log(`é‡æ–°è®¡ç®—æ—¶é•¿: ${sess.studentName}, æ®µå†…=${Math.round(sess.inSlotTime/60)}åˆ†é’Ÿ, æ®µå¤–=${Math.round(sess.outSlotTime/60)}åˆ†é’Ÿ`);
}

// ğŸ”¥ é¢å¤–çš„ helperï¼šè·å–å­¦ç”ŸæŸå¤©çš„æ—¶é—´æ®µï¼ˆä¼˜åŒ–ç‰ˆï¼‰
function getStudentTodaySlots(studentName, dateStr = null) {
  const targetDate = dateStr ? new Date(dateStr) : new Date();
  const wd = targetDate.getDay();
  const map = {0:'sunday',1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday',6:'saturday'};
  const key = map[wd];
  const raw = studentTimeSlots[studentName] && studentTimeSlots[studentName][key];
  if(!Array.isArray(raw)) return [];
  return raw.map(s=>({
    start: s.start||s.startTime||s.s||s.begin,
    end: s.end||s.endTime||s.e||s.finish,
    startMinute: (function(str){ if(typeof str==='number') return str; if(!str) return NaN; const m=String(str).match(/^(\d{1,2}):(\d{1,2})$/); return m?parseInt(m[1])*60+parseInt(m[2]):NaN; })(s.start||s.startTime||s.s||s.begin),
    endMinute: (function(str){ if(typeof str==='number') return str; if(!str) return NaN; const m=String(str).match(/^(\d{1,2}):(\d{1,2})$/); return m?parseInt(m[1])*60+parseInt(m[2]):NaN; })(s.end||s.endTime||s.e||s.finish)
  })).filter(x=>Number.isFinite(x.startMinute)&&Number.isFinite(x.endMinute)&&x.endMinute>x.startMinute);
}

/**
 * å†³å®šä½¿ç”¨ä½•ç§æ„é€ é€»è¾‘å¹¶å±•ç¤º
 */
function showDayAttendanceDetail(studentName, date, dayNumber){
  // é˜²æ­¢å†’æ³¡ï¼ˆè‹¥ä¸æ˜¯äº‹ä»¶è§¦å‘å¯å¿½ç•¥ï¼‰
  if (typeof event !== 'undefined' && event.stopPropagation) {
    event.stopPropagation();
  }

  const isToday = (date === getTodayDateString());
  const dateKey = date.replace(/\//g, '-');
  
  // é¦–å…ˆæ£€æŸ¥è€ƒå‹¤è¯¦æƒ…å¿«ç…§
  const detailSnapshot = getAttendanceDetailSnapshot(studentName, dateKey);
  
  // å¦‚æœæœ‰å¿«ç…§ä¸”ä¸æ˜¯ä»Šå¤©ï¼Œç›´æ¥ä½¿ç”¨å¿«ç…§æ•°æ®
  if (detailSnapshot && !isToday) {
    console.log(`[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] ä½¿ç”¨ç¼“å­˜æ•°æ®: ${studentName} - ${date}`);
    showAttendanceDetailModal(studentName, date, dayNumber, detailSnapshot.detail);
    return;
  }
  
  // å¦‚æœæ²¡æœ‰å¿«ç…§ä¸”ä¸æ˜¯ä»Šå¤©ï¼Œå°è¯•ä»äº‘ç«¯ä¸‹è½½
  if (!detailSnapshot && !isToday) {
    downloadAttendanceDetailSnapshotsFromCloud(dateKey).then(cloudData => {
      if (cloudData && cloudData[studentName]) {
        console.log(`[è€ƒå‹¤è¯¦æƒ…å¿«ç…§] ä»äº‘ç«¯æ¢å¤æ•°æ®: ${studentName} - ${date}`);
        showAttendanceDetailModal(studentName, date, dayNumber, cloudData[studentName].detail);
        return;
      }
      // å¦‚æœäº‘ç«¯ä¹Ÿæ²¡æœ‰ï¼Œåˆ™è®¡ç®—å®æ—¶æ•°æ®
      calculateAndShowAttendanceDetail(studentName, date, dayNumber);
    }).catch(() => {
      // ä¸‹è½½å¤±è´¥ï¼Œè®¡ç®—å®æ—¶æ•°æ®
      calculateAndShowAttendanceDetail(studentName, date, dayNumber);
    });
    return;
  }
  
  // å¯¹äºä»Šå¤©æˆ–è€…æœ‰å¿«ç…§ä½†æ˜¯ä»Šå¤©çš„æƒ…å†µï¼Œè®¡ç®—å®æ—¶æ•°æ®
  calculateAndShowAttendanceDetail(studentName, date, dayNumber);
}

function calculateAndShowAttendanceDetail(studentName, date, dayNumber) {
  const isToday = (date === getTodayDateString());
  const rec = attendanceRecordsCache[date];
  const realtime = buildRealtimeAttendanceDetail(studentName, date);
  let finalDetail;

  if (isToday) {
    // ä»Šæ—¥å®Œå…¨ä½¿ç”¨å®æ—¶
    finalDetail = realtime;
  } else {
    // å†å²ï¼šä¼˜å…ˆ snapshotï¼Œè¿‡æœŸæˆ–ä¸å­˜åœ¨ç”¨ realtime
    let stale = false;
    if (rec && rec.lastUpdated) {
      if (Date.now() - rec.lastUpdated > SNAPSHOT_STALE_MS) stale = true;
    } else if (rec && !rec.lastUpdated) {
      stale = true;
    }
    
    if (!rec || stale) {
      // ğŸ”¥ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨å®æ—¶æ•°æ®
      finalDetail = realtime;
    } else {
      // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨å¿«ç…§æ•°æ®ï¼Œç§»é™¤ä¸å­˜åœ¨çš„ merge å‡½æ•°
      finalDetail = buildSnapshotAttendanceDetail(studentName, date, rec);
    }
  }

  // ä»…ä»Šå¤©åšç¼“å†²æœŸç¼ºå‹¤çº æ­£
  if (isToday) {
    postFixEarlyBufferAbsents(finalDetail, studentName);
  }
  
  // å¦‚æœä¸æ˜¯ä»Šå¤©ï¼Œä¿å­˜åˆ°è€ƒå‹¤è¯¦æƒ…å¿«ç…§
  if (!isToday && finalDetail) {
    const dateKey = date.replace(/\//g, '-');
    saveAttendanceDetailSnapshot(studentName, dateKey, finalDetail);
  }

  showAttendanceDetailModal(studentName, date, dayNumber, finalDetail);
}


// =====================
// äºŒæ¬¡ä¿®æ­£ï¼šæŠŠâ€œç¼“å†²æœŸç¼ºå‹¤â€çº æ­£æˆå®æ—¶çŠ¶æ€
// ä»…é’ˆå¯¹å½“å¤©ä¸” status='absent' ä¸” statusText å«â€œç¼“å†²/å‡†å¤‡â€
// =====================
function postFixEarlyBufferAbsents(detailObj, studentName) {
  if (!detailObj || !Array.isArray(detailObj.details)) return;
  const today = getTodayDateString();

  // ç”¨æœ€æ–°å®æ—¶é‡æ–°è·‘ä¸€æ¬¡
  const realtime = buildRealtimeAttendanceDetail(studentName, today);

  detailObj.details.forEach(d => {
    if (
      d.status === 'absent' &&
      /ç¼“å†²|å‡†å¤‡/.test(d.statusText)
    ) {
      const same = realtime.details.find(x => x.timeSlot === d.timeSlot);
      if (same && (same.status === 'present' || same.status === 'low_efficiency' || same.status === 'under_review')) {
        d.status = same.status;
        d.statusText =
          same.status === 'present'
            ? 'å‡ºå‹¤'
            : same.status === 'low_efficiency'
              ? 'ä½æ•ˆ'
              : 'è¿›è¡Œä¸­';
        d.practiceTime = same.practiceTime || same.practicedText || d.practiceTime;
        d.room = same.room || d.room;
      }
    }
  });

  // é‡æ–°æ±‡æ€»
  detailObj.present = 0;
  detailObj.absent = 0;
  detailObj.excused = 0;
  detailObj.lowEfficiency = 0;
  detailObj.pending = 0;
  detailObj.underReview = 0;
  detailObj.details.forEach(d => {
    switch (d.status) {
      case 'present': detailObj.present++; break;
      case 'excused': detailObj.excused++; break;
      case 'absent': detailObj.absent++; break;
      case 'low_efficiency': detailObj.lowEfficiency++; break;
      case 'under_review': detailObj.underReview++; break;
      default: detailObj.pending++; break;
    }
  });
}


/* =============== âœ… å¯é€‰ï¼šç”Ÿæˆä»Šæ—¥ attendance snapshotï¼ˆå« lastUpdatedï¼‰ =============== */
/* ä½ å¯ä»¥åœ¨æŸä¸ªç®¡ç†æŒ‰é’®æˆ–å®šæ—¶å™¨è°ƒç”¨ snapshotTodayAttendance() ä»¥å†™å…¥äº‘ç«¯â€œé˜¶æ®µæ€§å¿«ç…§â€ */
function snapshotTodayAttendance(){
  if(!isOnline || !database){
    addSyncLog('âš ï¸ æ— æ³•ç”Ÿæˆå¿«ç…§ï¼ˆç¦»çº¿ï¼‰');
    return;
  }
  const today = getTodayDateString();
  const students = flattenStudents();
  const now = new Date();
  const wd = now.getDay();
  const curMin = now.getHours()*60 + now.getMinutes();
  const presentSet = new Set();
  rooms.forEach(r => { if(r.student) presentSet.add(r.student); });
  const excuses = excuseData[today] || {};
  const map = {1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const dayKey = map[wd];

  const records = [];

  students.forEach(s=>{
    if(excuses[s.name]) return; // è¯·å‡ä¸ç»†åˆ† slot
    const slots = (dayKey && studentTimeSlots[s.name] && studentTimeSlots[s.name][dayKey]) ? studentTimeSlots[s.name][dayKey] : [];
    if(!slots.length){
      const st = getStudentCurrentStatus(s.name, presentSet, excuses, wd, curMin);
      records.push({
        name: s.name,
        start: '--',
        end: '--',
        finalAttendanceStatus: st,
        practicedText: '--',
        room: presentSet.has(s.name)? (rooms.find(r=>r.student===s.name)?.name || 'åœ¨ç´æˆ¿') : '',
        major: s.major,
        lastUpdated: Date.now()
      });
    }else{
      // ç®€å•æŒ‰å½“å‰åˆ†é’Ÿåˆ¤æ–­ï¼šå·²è¿‡ && äººä¸åœ¨æˆ¿é—´ -> absentï¼›åœ¨ä¸”åœ¨æˆ¿é—´ -> presentï¼›æœªåˆ° -> pending
      slots.forEach(slot=>{
        const sm = timeToMinutes(slot.start);
        const em = timeToMinutes(slot.end);
        let st='pending';
        if(curMin >= em){
          // å·²ç»“æŸï¼šç”¨ realTime åˆ¤æ–­ï¼ˆç²—ç³™ç‰ˆï¼Œå¯åç»­æ¢æˆ buildRealtimeAttendanceDetailï¼‰
          st = presentSet.has(s.name)? 'present' : 'absent';
        }else if(curMin >= sm && curMin < em){
          st = presentSet.has(s.name)? 'present' : 'absent';
        }else if(curMin < sm){
          st = 'pending';
        }
        records.push({
          name: s.name,
            start: slot.start,
            end: slot.end,
            finalAttendanceStatus: st,
            practicedText: '-',
            room: presentSet.has(s.name)? (rooms.find(r=>r.student===s.name)?.name || 'åœ¨ç´æˆ¿') : '',
            major: s.major,
            lastUpdated: Date.now()
        });
      });
    }
  });

  const snapshot = {
    students: records,
    endedSlots: [], // ä½ è‹¥æœ‰å·²ç»“æŸ slot ç»“æ„å¯å¡«
    lastUpdated: Date.now()
  };

  database.ref(`attendanceRecords/${today}`)
    .update(snapshot)
    .then(()=> addSyncLog('ğŸ“¤ å·²å†™å…¥ä»Šæ—¥è€ƒå‹¤å¿«ç…§'))
    .catch(e => addSyncLog('âŒ å¿«ç…§å¤±è´¥ '+e.message));
}

/* =============== æ˜¾ç¤ºè€ƒå‹¤è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆä¿æŒåŸæ ¼å¼ï¼‰ =============== */
function getDayDescription(dayNumber){
  if(currentLanguage==='en'){
    const desc={1:'Today',2:'Yesterday',3:'2 days ago',4:'3 days ago',5:'4 days ago',6:'5 days ago',7:'6 days ago'};
    return desc[dayNumber]||`${dayNumber-1} days ago`;
  }else{
    const desc={1:'ä»Šå¤©',2:'æ˜¨å¤©',3:'å‰å¤©',4:'ç¬¬4å¤©å‰',5:'ç¬¬5å¤©å‰',6:'ç¬¬6å¤©å‰',7:'ç¬¬7å¤©å‰'};
    return desc[dayNumber]||`ç¬¬${dayNumber}å¤©`;
  }
}
function showAttendanceDetailModal(studentName,date,dayNumber,detailInfo){
  const modal=document.getElementById('attendanceDetailModal');
  const content=`<div class="modal-header">
    <h3 class="modal-title">${studentName} - ${getDayDescription(dayNumber)}${t('attendance.detail.suffix','è€ƒå‹¤è¯¦æƒ…')}</h3>
    <button class="modal-close" onclick="closeModal('attendanceDetailModal')">&times;</button>
  </div>
  <div style="padding:25px 20px 20px 20px;">
    <div class="card" style="margin-bottom:25px;">
      <h4 style="margin-bottom:20px;">ğŸ“… ${date} ${t('attendance.summary','è€ƒå‹¤æ±‡æ€»')}</h4>
      <div class="stats-grid-detailed" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;">
        <div class="stat-item present"><div class="stat-icon">âœ…</div><div class="stat-content"><div class="stat-number">${detailInfo.present}</div><div class="stat-label">${t('stats.present','å‡ºå‹¤')}</div></div></div>
        <div class="stat-item absent"><div class="stat-icon">âŒ</div><div class="stat-content"><div class="stat-number">${detailInfo.absent}</div><div class="stat-label">${t('stats.absent','ç¼ºå‹¤')}</div></div></div>
  <div class="stat-item low-efficiency"><div class="stat-icon">âš ï¸</div><div class="stat-content"><div class="stat-number">${detailInfo.lowEfficiency}</div><div class="stat-label">${t('status.low_efficiency','ä½æ•ˆ')}</div></div></div>
        <div class="stat-item excused"><div class="stat-icon">ğŸ“</div><div class="stat-content"><div class="stat-number">${detailInfo.excused}</div><div class="stat-label">${t('stats.excused','è¯·å‡')}</div></div></div>
  
      </div>
    </div>
    <div class="card">
      <h4 style="margin-bottom:20px;">ğŸ“‹ ${t('attendance.detailed_records','è¯¦ç»†è®°å½•')}</h4>
      <div class="data-table-container" style="max-height:300px;overflow-y:auto;">
        <table class="data-table">
          <thead><tr>
            <th>${t('student.time_slot','æ—¶é—´æ®µ')}</th>
            <th>${t('filter.status','çŠ¶æ€')}</th>
            <th>${t('student.practice_duration','ç»ƒç´æ—¶é•¿')}</th>
            <th>${t('student.room','ç´æˆ¿')}</th>
            ${detailInfo.details.some(d=>d.excuseReason)?`<th>${t('attendance.remarks','å¤‡æ³¨')}</th>`:''}
          </tr></thead>
          <tbody>
            ${detailInfo.details.map(d=>`<tr>
              <td>${d.timeSlot}</td>
              <td><span class="table-status-badge ${d.status}">${d.statusText}</span></td>
              <td>${d.practiceTime||'--'}</td>
              <td>${d.room||''}</td>
              ${detailInfo.details.some(x=>x.excuseReason)?(`<td>${d.excuseReason||'-'}</td>`):''}
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>`;
  openModalSmooth('attendanceDetailModal', content);
}

/* =============== å­¦ç”Ÿè¯¦æƒ…ï¼ˆå¤ç”¨åŸé€»è¾‘ + ä¿®æ­£ï¼‰ =============== */
function getStudentPracticeStats(name,days=7){
  // é¦–å…ˆæ£€æŸ¥ä»Šå¤©çš„å¿«ç…§
  const today = new Date();
  const todayKey = formatDate(today).replace(/\//g, '-');
  const todaySnapshot = getStudentStatsSnapshot(name, todayKey);
  
  // å¦‚æœæœ‰ä»Šå¤©çš„å¿«ç…§ä¸”åŒ…å«è¶³å¤Ÿçš„ç»ƒç´æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
  if (todaySnapshot && todaySnapshot.practice && todaySnapshot.practice.dailyDetails && 
      todaySnapshot.practice.dailyDetails.length >= days) {
    console.log(`[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§] ä½¿ç”¨ç»ƒç´ç¼“å­˜æ•°æ®: ${name}`);
    return todaySnapshot.practice;
  }
  
  // å¦‚æœæ²¡æœ‰æœ¬åœ°å¿«ç…§ï¼Œå°è¯•ä»äº‘ç«¯ä¸‹è½½
  if (!todaySnapshot) {
    downloadStudentStatsFromCloud(todayKey).then(cloudData => {
      if (cloudData && cloudData[name]) {
        console.log(`[å­¦ç”Ÿç»Ÿè®¡å¿«ç…§] ä»äº‘ç«¯æ¢å¤ç»ƒç´æ•°æ®: ${name}`);
        // å¼‚æ­¥æ›´æ–°ï¼Œä¸å½±å“å½“å‰è¿”å›
      }
    }).catch(() => {});
  }
  
  const stats={totalDays:0,totalInSlot:0,totalOutSlot:0,totalSessions:0,dailyDetails:[]};
  
  for(let i=0;i<days;i++){
    const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
    const dk=formatDate(d);
    const rec=getStudentPracticeRecord(name,dk);
    const inSlot=Number(rec.inSlotSeconds||rec.inSlot||0);
    const outSlot=Number(rec.outSlotSeconds||rec.outSlot||0);
    const sessions=Number(rec.totalSessions||0);
    if(sessions>0){stats.totalDays++;stats.totalInSlot+=inSlot;stats.totalOutSlot+=outSlot;stats.totalSessions+=sessions;}
    stats.dailyDetails.push({date:dk,inSlot,outSlot,sessions});
  }
  
  // ä¿å­˜åˆ°å¿«ç…§ä¸­
  const existingSnapshot = getStudentStatsSnapshot(name, todayKey);
  const attendanceData = existingSnapshot ? existingSnapshot.attendance : null;
  saveStudentStatsSnapshot(name, todayKey, attendanceData, stats);
  
  return stats;
}
function aggregateDailyStatus(records){
  // records: åŒä¸€å¤©è¯¥å­¦ç”Ÿæ‰€æœ‰ slot æˆ–å¿«ç…§æ¡ç›®
  let hasExcused=false,hasPresent=false,hasLow=false,hasPending=false,hasAbsent=false;
  let totalSlots = 0, presentSlots = 0;
  
  records.forEach(r=>{
    const s=r.finalAttendanceStatus || r.status;
    totalSlots++;
    
    if(s==='excused') hasExcused=true;
    else if(s==='present') {
      hasPresent=true;
      presentSlots++;
    }
    else if(s==='low_efficiency') hasLow=true;
    else if(s==='pending') hasPending=true;
    else if(s==='absent') hasAbsent=true;
  });
  
  // ğŸ”¥ æ–°é€»è¾‘ï¼šå¦‚æœæœ‰ä»»ä½•å‡ºå‹¤è®°å½•ï¼Œä¼˜å…ˆæ˜¾ç¤ºç§¯æçŠ¶æ€
  // åªæœ‰å½“æ‰€æœ‰æ—¶é—´æ®µéƒ½æ˜¯ç¼ºå‹¤æ—¶ï¼Œæ‰æ˜¾ç¤ºç¼ºå‹¤
  if(hasExcused && !hasPresent && !hasLow && !hasAbsent && !hasPending) return 'excused'; // å…¨å¤©è¯·å‡
  if(hasPresent && presentSlots >= totalSlots * 0.5) return 'present'; // è¶…è¿‡ä¸€åŠæ—¶é—´æ®µå‡ºå‹¤
  if(hasPresent || hasLow) return hasPresent ? 'present' : 'low_efficiency'; // æœ‰å‡ºå‹¤æˆ–ä½æ•ˆ
  if(hasAbsent && !hasPending) return 'absent'; // æ˜ç¡®ç¼ºå‹¤ä¸”æ— å¾…è€ƒå‹¤
  if(hasPending) return 'pending'; // å¾…è€ƒå‹¤
  if(hasAbsent) return 'absent'; // ç¼ºå‹¤
  if(hasExcused) return 'excused'; // è¯·å‡
  return 'no-data';
}

// ğŸ”¥ æ–°å¢ï¼šä¸“é—¨ç”¨äºç»ƒç´æ˜ç»†è¡¨æ ¼çš„æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
function formatPracticeMinutes(minutes) {
  if (!minutes || minutes === 0) {
    return currentLanguage === 'zh' ? '0åˆ†é’Ÿ' : '0min';
  }
  
  if (minutes >= 60) {
    const hours = (minutes / 60).toFixed(1);
    return currentLanguage === 'zh' ? `${hours}å°æ—¶` : `${hours}h`;
  }
  
  return currentLanguage === 'zh' ? `${minutes}åˆ†é’Ÿ` : `${minutes}min`;
}

// ğŸ”¥ æ–°å¢ï¼šä¸“é—¨ç”¨äºä»Šæ—¥æ€»è®¡çš„æ—¶é—´æ ¼å¼åŒ–å‡½æ•°ï¼ˆæ˜¾ç¤ºå°æ—¶åˆ†é’Ÿæ ¼å¼ï¼‰
function formatTotalPracticeTime(minutes) {
  if (!minutes || minutes === 0) {
    return currentLanguage === 'zh' ? '0åˆ†é’Ÿ' : '0min';
  }
  
  const hours = Math.floor(minutes / 60);
  const remainingMinutes = minutes % 60;
  
  if (currentLanguage === 'zh') {
    if (hours > 0) {
      return `${hours}å°æ—¶${remainingMinutes}åˆ†é’Ÿ`;
    }
    return `${remainingMinutes}åˆ†é’Ÿ`;
  } else {
    if (hours > 0 && remainingMinutes > 0) {
      return `${hours}h ${remainingMinutes}min`;
    } else if (hours > 0) {
      return `${hours}h`;
    } else {
      return `${remainingMinutes}min`;
    }
  }
}

// ===== ä»Šæ—¥æ€»è®¡ç»ƒç´æ—¶é—´è·å–ï¼ˆä¾›å­¦ç”Ÿå¡ & å®æ—¶ç»ƒç´å¡ç»Ÿä¸€æ˜¾ç¤ºï¼‰=====
// è¯´æ˜ï¼šä¸è¯¦æƒ…å¼¹çª—â€œä»Šæ—¥æ€»è®¡â€ä¿æŒä¸€è‡´ï¼ŒåŒ…å«æ®µå†…+æ®µå¤–ï¼ˆå·²æŒ‰æ’é™¤è§„åˆ™æ‰£é™¤ï¼‰
// ä¸ºé¿å…é‡å¤ heavy è®¡ç®—ï¼Œåšç®€å•ç¼“å­˜ï¼›æ•°æ®æ›´æ–°æ—¶å¯è°ƒç”¨ window.invalidateTodayPracticeTotals()
window.__todayPracticeTotalsCache = { dateKey:null, map:{} };
window.invalidateTodayPracticeTotals = function(){ window.__todayPracticeTotalsCache.dateKey=null; window.__todayPracticeTotalsCache.map={}; };
function getTodayTotalPracticeMinutes(studentName){
  try {
    const todayKey = getTodayDateString();
    const cache = window.__todayPracticeTotalsCache;
    if(cache.dateKey !== todayKey){ cache.dateKey = todayKey; cache.map = {}; }
    if(cache.map[studentName] != null) return cache.map[studentName];
    const { totalSec } = computeDayInOut(studentName, todayKey);
    const totalMin = Math.floor(totalSec / 60);
    cache.map[studentName] = totalMin;
    return totalMin;
  } catch(e){ console.warn('[todayTotal] è®¡ç®—å¤±è´¥', studentName, e); return 0; }
}

function openStudentDetail(name){
  // è®¾ç½®å½“å‰å­¦ç”Ÿåç§°ç”¨äºåç»­å‰”é™¤æ¥æºæŒ‰é’®å¼•ç”¨
  window.__currentDetailStudent=name;
  // é¢„åŠ è½½æœ€è¿‘7å¤©ï¼ˆå¼‚æ­¥ï¼‰
  const today=new Date();
  const preload=[];
  for(let i=0;i<7;i++){
    const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
    const ds=formatDate(d);
    if(!attendanceRecordsCache[ds]&&isOnline&&database){
      preload.push(database.ref(`attendanceRecords/${ds}`).once('value').then(s=>{attendanceRecordsCache[ds]=s.val()||null;}));
    }
    if(!dailyPracticeRecords[ds]&&isOnline&&database){
      preload.push(database.ref(`practiceRecords/${ds}`).once('value').then(s=>{
        const v=s.val();if(v){dailyPracticeRecords[ds]=v;try{localStorage.setItem('practiceRecords_'+ds,JSON.stringify(v));}catch(e){}}
      }));
    }
  }
  Promise.all(preload).finally(()=>{
  const info=getStudentInfo(name);
    const practice=realTimePracticeMap[name];
    const todayKey=getTodayDateString();
    const excuse=(excuseData[todayKey]||{})[name];
    const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
    const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
    const todayExcuses=excuseData[todayKey]||{};
    const currentStatus=getStudentCurrentStatus(name,presentSet,todayExcuses,wd,curMin);
    
    // ğŸ”¥ è€ƒå‹¤å†å²è®°å½•
    const history=[];
    for(let i=0;i<7;i++){
      const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
      const ds=formatDate(d);
      
      const isToday=(ds===getTodayDateString());
      let st = 'no-data';
      
      if(isToday){
        // ä»Šæ—¥ï¼šä½¿ç”¨å®æ—¶æ•°æ®
        const realtimeDetail = buildRealtimeAttendanceDetail(name, ds);
        if(realtimeDetail.excused > 0) st = 'excused';
        else if(realtimeDetail.present > 0) st = 'present';
        else if(realtimeDetail.lowEfficiency > 0) st = 'low_efficiency';
        else if(realtimeDetail.absent > 0) st = 'absent';
        else st = 'pending';
      } else {
        // ğŸ”¥ å†å²æ—¥ï¼šç›´æ¥ä½¿ç”¨è¯¦ç»†è®°å½•æ„å»ºå‡½æ•°çš„ç»“æœ
        const isToday_check = (ds === getTodayDateString());
        const rec = attendanceRecordsCache[ds];
        let realtime = buildRealtimeAttendanceDetail(name, ds);
        let finalDetail;
        
        if(isToday_check){
          finalDetail = realtime;
        } else {
          let stale = false;
          if(rec && rec.lastUpdated){
            if(Date.now() - rec.lastUpdated > SNAPSHOT_STALE_MS) stale = true;
          } else if(rec && !rec.lastUpdated){
            stale = true;
          }
          
          if(!rec || stale){
            finalDetail = realtime;
          } else {
            const snapDetail = buildSnapshotAttendanceDetail(name, ds, rec);
            finalDetail = mergeAttendanceDetail(snapDetail, realtime);
          }
        }
        
        // ğŸ”¥ ç›´æ¥æ ¹æ®è¯¦ç»†è®°å½•çš„çŠ¶æ€åˆ†å¸ƒæ¥åˆ¤æ–­æ•´ä½“çŠ¶æ€
        if(finalDetail.excused > 0 && finalDetail.present === 0 && finalDetail.lowEfficiency === 0 && finalDetail.absent === 0) {
          st = 'excused'; // å…¨å¤©è¯·å‡
        } else if(finalDetail.present > 0) {
          st = 'present'; // æœ‰å‡ºå‹¤
        } else if(finalDetail.lowEfficiency > 0) {
          st = 'low_efficiency'; // æœ‰ä½æ•ˆ
        } else if(finalDetail.absent > 0) {
          st = 'absent'; // ğŸ”¥ æœ‰ç¼ºå‹¤è®°å½•å°±æ˜¾ç¤ºç¼ºå‹¤
        } else if(finalDetail.pending > 0) {
          st = 'pending'; // å¾…è€ƒå‹¤
        } else {
          st = 'no-data'; // æ— æ•°æ®
        }
      }
      
      history.push({date:ds,status:st});
    }

    // ğŸ”¥ ç»ƒç´æ˜ç»†ï¼šä½¿ç”¨ä¸è€ƒå‹¤è¯¦æƒ…ç›¸åŒçš„æ•°æ®æºå’Œè®¡ç®—é€»è¾‘
    const practiceRows=(function(){
      const rows=[];let aggExcluded=0;
      function mergeIntervalsBasic(arr){
        if(!arr||!arr.length) return [];
        const list=arr.map(iv=>({start:iv.start,end:iv.end})).sort((a,b)=>a.start-b.start);
        const merged=[list[0]];
        for(let i=1;i<list.length;i++){
          const last=merged[merged.length-1],cur=list[i];
            if(cur.start<=last.end){ if(cur.end>last.end) last.end=cur.end; }
            else merged.push({...cur});
        }
        return merged;
      }
      for(let i=0;i<7;i++){
        const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
        const dateStr=formatDate(d);const isToday=dateStr===todayKey;
        const {inSec,outSec,totalSec,rawIntervals,cleanIntervals,excludedBreakdown,outIntervals}=computeDayInOut(name,dateStr);
        // ä½¿ç”¨å¹¶é›†æ–¹å¼è®¡ç®—å‰”é™¤ç§’ï¼Œé¿å…é‡å åŒºé—´å¯¼è‡´ rawTotal è¿‡å¤§
        const rawUnion=mergeIntervalsBasic(rawIntervals);
        const cleanUnion=mergeIntervalsBasic(cleanIntervals);
        const rawUnionSec=rawUnion.reduce((s,iv)=>s+Math.floor((iv.end-iv.start)/1000),0);
        const cleanUnionSec=cleanUnion.reduce((s,iv)=>s+Math.floor((iv.end-iv.start)/1000),0);
        let excludedSec=Math.max(0,rawUnionSec-cleanUnionSec);
        // ç†è®ºä¸Šä¸Šé™ï¼šå…¨éƒ¨ä¼‘æ¯+å¤œé—´(150)ï¼›ç²—ç•¥ä¿æŠ¤ï¼šè‹¥è¶…è¿‡ 450 è®°å½•æ—¥å¿—
        if(excludedSec>450*60){ console.warn('[practiceRows] excludedSec unusually large', {student:name,date:dateStr,excludedSec}); }
        const excludedMin=Math.floor(excludedSec/60);aggExcluded+=excludedMin;
  rows.push({date:dateStr,isToday,inMin:Math.floor(inSec/60),outMin:Math.floor(outSec/60),total:Math.floor(totalSec/60),excludedMin,excludedBreakdown,outIntervals});
      }
      window.__lastPracticeExcludedAgg=aggExcluded;
      return rows.sort((a,b)=>b.date.localeCompare(a.date));
    })();

    // ğŸ”¥ ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
    const practiceRowsHtml = practiceRows.map(row => {
  const breakdownBtn = row.excludedBreakdown && row.excludedBreakdown.length ? `<button class=\"mini-help-btn\" onclick=\"showExcludedBreakdown(this,'${row.date}')\" title=\"${t('break.excluded_minutes','å‰”é™¤åˆ†é’Ÿ')}\">?</button>`:'';
      return `<tr ${row.isToday ? 'class=\"today-row\"' : ''}>
        <td class=\"date-cell\">${row.date}${row.isToday ? `<small style=\"color:#007bff;\">(${t('time.today', 'ä»Šå¤©')})</small>` : ''}<div style=\"font-size:10px;color:#888;\">${t('break.excluded_minutes','å‰”é™¤åˆ†é’Ÿ')}: ${row.excludedMin} ${breakdownBtn}</div></td>
        <td>${formatPracticeMinutes(row.inMin)}</td>
  <td>${formatPracticeMinutes(row.outMin)}${`<span data-outbtn='1'>${row.outMin>0?`<button class=\"mini-help-btn\" onclick=\"showOutSlotBreakdown(this,'${row.date}')\" title=\"${t('practice.out_slot_segments','æ®µå¤–ç»ƒç´åŒºé—´')}\">?</button>`:''}</span>`}</td>
        <td class=\"total-duration-cell\">${formatPracticeMinutes(row.total)}</td>
      </tr>`;
    }).join('') || `<tr><td colspan=\"4\" style=\"text-align:center;color:#999;\">${t('time.no_records', 'æ— è®°å½•')}</td></tr>`;

    // ğŸ”¥ ä»Šæ—¥æ€»æ—¶é•¿ä¹Ÿä½¿ç”¨ç»Ÿä¸€çš„æ ¼å¼åŒ–å‡½æ•°
    const todayRow = practiceRows.find(r => r.isToday);
    const todayTotalMin = todayRow ? todayRow.total : 0;
    const todayTotalHourText = formatTotalPracticeTime(todayTotalMin);

    const historyHtml=history.map((h,i)=>{
      const cls=(function(st){
        switch(st){
          case 'present':return 'present';
          case 'absent':return 'absent';
          case 'excused':return 'excused';
          case 'low_efficiency':return 'low-efficiency';
          case 'pending':return 'pending';
          default:return 'no-data';
        }
      })(h.status);
      const day=i+1;
      return `<div class="history-day ${cls}" onclick="showDayAttendanceDetail('${name}','${h.date}',${day})">${day}</div>`;
    }).join('');

    const statusNow=getStatusText(currentStatus);
    const dur=practice ? (() => {
      // è®¡ç®—å»é™¤å‡†å¤‡æ—¶é—´çš„å½“å‰ç»ƒä¹ æ—¶é•¿
      const currentSess = practiceSessionTracker.get(`${practice.name}__${practice.room}__${practice.startTime}`);
      if (currentSess && currentSess.isActive) {
        const now = Date.now();
        const activeStart = Math.max(currentSess.prepEndTime, currentSess.startTime + 60000);
        const effectiveSec = Math.max(0, Math.floor((now - activeStart) / 1000));
        return formatDuration(effectiveSec);
      }
      // å¦‚æœæ‰¾ä¸åˆ°ä¼šè¯è¿½è¸ªå™¨ï¼Œå›é€€åˆ°åŸé€»è¾‘ä½†å‡å»1åˆ†é’Ÿ
      const adjustedSec = Math.max(0, practice.currentSec - 60);
      return formatDuration(adjustedSec);
    })() : t('time.no_practice','0åˆ†é’Ÿ');
    const practiceStartText = practice
      ? new Date(practice.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'})
      : '--';

    const slotDayMap={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
    const key=slotDayMap[wd];
    let timeSlotInfo='';
    if(currentStatus!=='excused'){
      if(key && studentTimeSlots[name] && studentTimeSlots[name][key] && studentTimeSlots[name][key].length){
        const slots=studentTimeSlots[name][key];
        const slotHtml=slots.map(s=>{
          const sm=timeToMinutes(s.start),em=timeToMinutes(s.end);
          const isCur=curMin>=sm&&curMin<em;
          return `<span class="time-slot-tag${isCur?' current':''}">${isCur?'ğŸµ ':''}${s.start}-${s.end}</span>`;
        }).join('');
        timeSlotInfo=`<div class="metric-item time-slots-container">
          <div class="metric-icon">ğŸ“…</div>
          <div class="metric-content">
            <div class="metric-label">${t('student.time_slot', 'è€ƒå‹¤æ—¶é—´æ®µ')}</div>
            <div class="metric-value time-slots-wrapper">${slotHtml}</div>
          </div>
        </div>`;
      }else{
        timeSlotInfo=`<div class="metric-item">
          <div class="metric-icon">ğŸ“…</div>
          <div class="metric-content">
            <div class="metric-label">${t('student.time_slot', 'è€ƒå‹¤æ—¶é—´æ®µ')}</div>
            <div class="metric-value">${(wd===0||wd===6)?t('room.weekend', 'å‘¨æœ«'):t('room.no_arrangement', 'æ— å®‰æ’')}</div>
          </div>
        </div>`;
      }
    }
    
    // ğŸ”¥ è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
    document.getElementById('studentDetailTitle').textContent=name+' - '+t('student.detail.title','å­¦ç”Ÿè¯¦æƒ…');
    document.getElementById('studentDetailContent').innerHTML=`
      <div class="student-detail-content">
        <div class="student-profile-card">
          <h2 class="profile-name">${name}</h2>
          <div class="profile-meta">
            <span>${info.major||''}</span><span class="meta-divider">â€¢</span>
            <span>${info.grade||t('student.not_set','æœªè®¾ç½®')}</span>
          </div>
        </div>
        <div class="today-status-card ${getStatusClass(currentStatus)}">
          <div class="status-header">
            <h3 class="status-title">${t('student.today_attendance','ä»Šæ—¥è€ƒå‹¤')}</h3>
            <div class="status-badge ${getStatusClass(currentStatus)}">${getDetailedStatusText(name, currentStatus, practice, wd, curMin)}</div>
          </div>
          <div class="status-metrics">
            ${timeSlotInfo}
            <div class="metric-item practice-status-container">
              <div class="metric-icon">ğŸµ</div>
              <div class="metric-content">
                <div class="metric-label">${t('practice.status', 'ç»ƒç´çŠ¶æ€')}</div>
                <div class="metric-value practice-status-compact">
                  <div class="practice-info-row"><span class="practice-label">${t('practice.start_time', 'å¼€å§‹æ—¶é—´:')}</span><strong class="practice-value">${practiceStartText}</strong></div>
                  <div class="practice-info-row"><span class="practice-label">${t('practice.room', 'ç´æˆ¿:')}</span><strong class="practice-value">${practice?practice.room:t('student.not_in_room','ä¸åœ¨ç´æˆ¿')}</strong></div>
                  <div class="practice-info-row"><span class="practice-label">${t('practice.current_practice', 'å½“å‰ç»ƒä¹ :')}</span><strong class="practice-value current-practice">${dur}</strong></div>
                  <div class="practice-info-row"><span class="practice-label">${t('practice.today_total', 'ä»Šæ—¥æ€»è®¡:')}</span><strong class="practice-value total-practice">${todayTotalHourText}</strong></div>
                </div>
              </div>
            </div>
          </div>
          ${excuse?`<div class="excuse-info">
            <div class="excuse-header"><i class="excuse-icon">ğŸ“</i><span class="excuse-title">${t('excuse.reason','è¯·å‡åŸå› ')}</span></div>
            <div class="excuse-content">
              <p class="excuse-reason">${excuse.reason||''}</p>
              ${excuse.durationText?`<p class="excuse-approver">${t('excuse.duration_text','è¯·å‡æ—¶é•¿')}: ${excuse.durationText}</p>`:''}
              ${excuse.endDate?`<p class="excuse-approver">${t('excuse.end_date','ç»“æŸæ—¥æœŸ')}: ${excuse.endDate}</p>`:''}
            </div>
          </div>`:''}
        </div>
        <div class="card attendance-history">
          <div class="history-title">${t('attendance.history','æœ€è¿‘7å¤©è€ƒå‹¤')}</div>
          <div class="history-timeline">${historyHtml}</div>
        </div>
        <div class="card">
          <div class="card-header">
            <h4 class="card-title">${t('practice.recent_7days','ğŸ—“ï¸ æœ€è¿‘7å¤©ç»ƒç´æ˜ç»†')}</h4>
            <p style="font-size:.75rem;color:var(--medium-gray);margin:8px 0 0;">
              ${t('practice.time_slot_desc','æ®µå†…=è§„å®šç»ƒç´æ—¶æ®µ | æ®µå¤–=éè§„å®šæ—¶æ®µ')} 
              <span style="color:#007bff;">${t('practice.data_source','â€¢ æ•°æ®æ¥æºï¼šå®æ—¶è®¡ç®—')}</span>
            </p>
          </div>
          <div class="data-table-container" style="max-height:230px;overflow-y:auto;">
            <table class="data-table">
              <thead><tr><th>${t('report.date','æ—¥æœŸ')}</th><th>${t('practice.in_slot','æ®µå†…')}</th><th>${t('practice.out_slot','æ®µå¤–')}</th><th>${t('report.total','æ€»è®¡')}</th></tr></thead>
              <tbody>${practiceRowsHtml}</tbody>
            </table>
          </div>
        </div>
      </div>`;
    
    // ğŸ”¥ ä½¿ç”¨æ–°çš„æµç•…æ¨¡æ€æ¡†æ‰“å¼€å‡½æ•°
    openModalSmooth('studentDetailModal');

  });
}
function updatePracticeSessions(){
  const now = Date.now();
  let updatedCount = 0;
  
  practiceSessionTracker.forEach(sess => {
    if(!sess.isActive) return;
    
    try {
      // ğŸ”¥ æ›´æ–° _lastTick
      sess._lastTick = now;
      
      // ğŸ”¥ å¦‚æœè¶…è¿‡å‡†å¤‡æ—¶é—´ï¼Œå¼€å§‹æ­£å¼è®¡æ—¶
      if(now >= sess.prepEndTime && !sess.actualStartTime) {
        sess.actualStartTime = sess.prepEndTime;
        console.log(`å¼€å§‹æ­£å¼è®¡æ—¶: ${sess.studentName}`);
      }
      
      // ğŸ”¥ å®æ—¶æ›´æ–°æ—¶é•¿ï¼ˆä¸ä¿®æ”¹ endTimeï¼‰
      if(sess.actualStartTime && now > sess.actualStartTime) {
        const originalEndTime = sess.endTime;
        sess.endTime = now;
        recalcSessionTimes(sess);
        sess.endTime = originalEndTime; // æ¢å¤åŸå€¼
        
        // ğŸ”¥ éªŒè¯ç»“æœ
        if(isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
          console.error(`æ›´æ–°ä¼šè¯æ—¶å‘ç°NaN: ${sess.studentName}`);
          sess.inSlotTime = 0;
          sess.outSlotTime = 0;
        }
        
        updatedCount++;
      }
    } catch(e) {
      console.error(`æ›´æ–°ä¼šè¯å‡ºé”™: ${sess.studentName}`, e);
    }
  });
  
  if(updatedCount > 0) {
    addSyncLog(`ğŸ”„ æ›´æ–°äº† ${updatedCount} ä¸ªæ´»è·ƒä¼šè¯`);
  }
}
function getDetailedStatusText(studentName, currentStatus, practice, weekday, currentMinute) {
  // å¦‚æœæ˜¯è¯·å‡ï¼Œç›´æ¥è¿”å›è¯·å‡çŠ¶æ€
  if (currentStatus === 'excused') {
    return t('status.excused', 'è¯·å‡');
  }
  
  // è·å–å­¦ç”Ÿä»Šå¤©çš„æ—¶é—´æ®µ
  const slotDayMap = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = slotDayMap[weekday];
  
  // æ£€æŸ¥æ˜¯å¦åœ¨æ—¶é—´æ®µå†…
  let inTimeSlot = false;
  if (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) {
    const slots = studentTimeSlots[studentName][key];
    inTimeSlot = slots.some(slot => {
      const startMin = timeToMinutes(slot.start);
      const endMin = timeToMinutes(slot.end);
      return currentMinute >= startMin && currentMinute < endMin;
    });
  }
  
  if (inTimeSlot) {
    // åœ¨æ—¶é—´æ®µå†…ï¼šæ ¹æ®æ˜¯å¦åœ¨ç´æˆ¿åˆ¤æ–­çŠ¶æ€
    if (practice) {
      // åœ¨ç´æˆ¿ç»ƒç´
      return t('status.present', 'å‡ºå‹¤');
    } else {
      // ä¸åœ¨ç´æˆ¿
      return t('status.absent', 'ç¼ºå‹¤');
    }
  } else {
    // ä¸åœ¨æ—¶é—´æ®µå†…ï¼šæ ¹æ®æ˜¯å¦åœ¨ç´æˆ¿æ˜¾ç¤ºè‡ªä¸»ç»ƒç´çŠ¶æ€
    if (practice) {
      return currentLanguage === 'zh' ? 'è‡ªä¸»ç»ƒç´' : 'Self Practice';
    } else {
      return currentLanguage === 'zh' ? 'ç›®å‰æœªç»ƒç´' : 'Not Practicing';
    }
  }
}
// ğŸ†• åº”ç”¨æ’é™¤æ—¶é—´åˆ°æ—¶é—´åŒºé—´
function applyExclusionToInterval(startMs, endMs) {
  const res = [];
  let cursor = startMs;
  
  while(cursor < endMs) {
    const d = new Date(cursor);
    const min = d.getHours() * 60 + d.getMinutes();
    const wd = d.getDay();
    const next = Math.min(endMs, cursor + 60000);
    
    if(!isExcludedTime(min, wd)) {
      res.push([cursor, next]);
    }
    cursor = next;
  }
  
  return res;
}

// ğŸ†• åˆå¹¶è¿ç»­çš„æ—¶é—´ç‰‡æ®µ
function mergeConsecutiveSegments(segments) {
  if(segments.length === 0) return [];
  
  // æŒ‰å¼€å§‹æ—¶é—´æ’åº
  segments.sort((a, b) => a[0] - b[0]);
  
  const merged = [];
  let current = segments[0];
  
  for(let i = 1; i < segments.length; i++) {
    const next = segments[i];
    
    // å¦‚æœå½“å‰æ®µçš„ç»“æŸæ—¶é—´ç­‰äºä¸‹ä¸€æ®µçš„å¼€å§‹æ—¶é—´ï¼Œåˆå¹¶å®ƒä»¬
    if(current[1] === next[0]) {
      current[1] = next[1];
    } else {
      merged.push(current);
      current = next;
    }
  }
  
  merged.push(current);
  return merged;
}

// ğŸ†• å…±äº«å‡½æ•°ï¼šä»æ±‡æ€»æ•°æ®é‡å»ºæ—¶é—´åŒºé—´ï¼ˆå¢å¼ºç‰ˆï¼‰
function reconstructIntervalsFromSummary(studentName, date, rec, isToday = false) {
  const intervals = [];
  
  const inSlotSec = rec.inSlotSeconds || rec.inSlot || 0;
  const outSlotSec = rec.outSlotSeconds || rec.outSlot || 0;
  
  console.log(`${studentName} ${date} ä½¿ç”¨ç´¯è®¡æ—¶é•¿é‡æ„: æ®µå†…${Math.round(inSlotSec/60)}åˆ†é’Ÿ, æ®µå¤–${Math.round(outSlotSec/60)}åˆ†é’Ÿ`);
  
  if(inSlotSec === 0 && outSlotSec === 0) {
    return intervals;
  }
  
  // è·å–å­¦ç”Ÿå½“å¤©çš„æ—¶é—´æ®µå®‰æ’
  const target = new Date(date);
  const wd = target.getDay();
  const map = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = map[wd];
  const slots = (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) 
                  ? studentTimeSlots[studentName][key] : [];
  
  // ğŸ”¥ é‡æ„æ®µå†…ç»ƒç´åŒºé—´ï¼ˆåº”ç”¨æ’é™¤æ—¶é—´ï¼‰
  if(inSlotSec > 0 && slots.length > 0) {
    let remainingSec = inSlotSec;
    
    slots.forEach(slot => {
      if(remainingSec <= 0) return;
      
      const slotStartMs = new Date(`${date}T${slot.start}:00`).getTime();
      const slotEndMs = new Date(`${date}T${slot.end}:00`).getTime();
      
      // ğŸ”¥ åº”ç”¨æ’é™¤æ—¶é—´è¿‡æ»¤
      const validSegments = applyExclusionToInterval(slotStartMs, slotEndMs);
      const totalValidMs = validSegments.reduce((sum, seg) => sum + (seg[1] - seg[0]), 0);
      const totalValidSec = Math.floor(totalValidMs / 1000);
      
      if(totalValidSec > 0) {
        // è®¡ç®—è¿™ä¸ªæ—¶é—´æ®µåº”è¯¥ä½¿ç”¨å¤šå°‘ç§’
        const useSec = Math.min(remainingSec, totalValidSec);
        
        if(useSec > 0) {
          // ğŸ”¥ æŒ‰æ¯”ä¾‹åˆ†é…åˆ°æœ‰æ•ˆæ—¶é—´æ®µ
          let allocatedSec = 0;
          const mergedSegments = mergeConsecutiveSegments(validSegments);
          
          mergedSegments.forEach((segment, idx) => {
            if(allocatedSec >= useSec) return;
            
            const segmentDurMs = segment[1] - segment[0];
            const segmentDurSec = Math.floor(segmentDurMs / 1000);
            
            // è®¡ç®—è¿™ä¸ªç‰‡æ®µåº”è¯¥åˆ†é…å¤šå°‘æ—¶é—´
            let segmentUseSec;
            if(idx === mergedSegments.length - 1) {
              // æœ€åä¸€ä¸ªç‰‡æ®µï¼Œä½¿ç”¨å‰©ä½™æ—¶é—´
              segmentUseSec = useSec - allocatedSec;
            } else {
              // æŒ‰æ¯”ä¾‹åˆ†é…
              segmentUseSec = Math.min(
                Math.floor(useSec * segmentDurSec / totalValidSec),
                useSec - allocatedSec,
                segmentDurSec
              );
            }
            
            if(segmentUseSec > 0) {
              intervals.push({
                start: segment[0],
                end: segment[0] + segmentUseSec * 1000,
                room: isToday ? t('room.historical_rebuild', 'ï¼ˆå†å²é‡å»ºï¼‰') : t('room.practice_room', 'ç»ƒç´æˆ¿'),
                slotName: slot.name || `${slot.start}-${slot.end}`,
                type: 'inSlot'
              });
              
              allocatedSec += segmentUseSec;
              console.log(`æ·»åŠ æ®µå†…åŒºé—´: ${slot.start}-${slot.end}, ä½¿ç”¨${segmentUseSec}ç§’ (æ’é™¤å)`);
            }
          });
          
          remainingSec -= allocatedSec;
        }
      }
    });
    
    // å¦‚æœè¿˜æœ‰å‰©ä½™çš„æ®µå†…æ—¶é—´æ²¡æœ‰åˆ†é…å®Œ
    if(remainingSec > 0) {
      console.warn(`æ®µå†…æ—¶é—´æœªå®Œå…¨åˆ†é…ï¼Œå‰©ä½™${remainingSec}ç§’`);
    }
  }
  
  // ğŸ”¥ é‡æ„æ®µå¤–ç»ƒç´åŒºé—´ï¼ˆåº”ç”¨æ’é™¤æ—¶é—´ï¼‰
  if(outSlotSec > 0) {
    // é€‰æ‹©ä¸€ä¸ªæ®µå¤–æ—¶é—´è¿›è¡Œé‡æ„ï¼Œæ¯”å¦‚11:30å¼€å§‹
    const baseTime = new Date(`${date}T11:30:00`).getTime();
    const estimatedEndTime = baseTime + outSlotSec * 2000; // é¢„ä¼°éœ€è¦2å€æ—¶é—´æ¥å®¹çº³æ’é™¤æ—¶é—´
    
    // ğŸ”¥ åº”ç”¨æ’é™¤æ—¶é—´è¿‡æ»¤
    const validSegments = applyExclusionToInterval(baseTime, estimatedEndTime);
    
    let allocatedSec = 0;
    const mergedSegments = mergeConsecutiveSegments(validSegments);
    
    mergedSegments.forEach(segment => {
      if(allocatedSec >= outSlotSec) return;
      
      const segmentDurMs = segment[1] - segment[0];
      const segmentDurSec = Math.floor(segmentDurMs / 1000);
      const needSec = outSlotSec - allocatedSec;
      const useSec = Math.min(needSec, segmentDurSec);
      
      if(useSec > 0) {
        intervals.push({
          start: segment[0],
          end: segment[0] + useSec * 1000,
          room: isToday ? t('room.historical_rebuild', 'ï¼ˆå†å²é‡å»ºï¼‰') : t('room.practice_room', 'ç»ƒç´æˆ¿'),
          type: 'outSlot'
        });
        
        allocatedSec += useSec;
        console.log(`æ·»åŠ æ®µå¤–åŒºé—´: ${new Date(segment[0]).toLocaleTimeString()}, ä½¿ç”¨${useSec}ç§’ (æ’é™¤å)`);
      }
    });
    
    // å¦‚æœ11:30å¼€å§‹çš„æ—¶é—´ä¸å¤Ÿï¼Œå°è¯•å…¶ä»–æ—¶é—´ç‚¹
    if(allocatedSec < outSlotSec) {
      const remainingOutSec = outSlotSec - allocatedSec;
      console.log(`11:30æ—¶æ®µä¸å¤Ÿï¼Œå°è¯•å…¶ä»–æ—¶é—´åˆ†é…å‰©ä½™${remainingOutSec}ç§’`);
      
      // å°è¯•æ—©ä¸Š10:00
      const morningTime = new Date(`${date}T10:00:00`).getTime();
      const morningEndTime = morningTime + remainingOutSec * 2000;
      const morningSegments = applyExclusionToInterval(morningTime, morningEndTime);
      const morningMerged = mergeConsecutiveSegments(morningSegments);
      
      let morningAllocated = 0;
      morningMerged.forEach(segment => {
        if(morningAllocated >= remainingOutSec) return;
        
        const segmentDurSec = Math.floor((segment[1] - segment[0]) / 1000);
        const needSec = remainingOutSec - morningAllocated;
        const useSec = Math.min(needSec, segmentDurSec);
        
        if(useSec > 0) {
          intervals.push({
            start: segment[0],
            end: segment[0] + useSec * 1000,
            room: isToday ? t('room.historical_rebuild', 'ï¼ˆå†å²é‡å»ºï¼‰') : t('room.practice_room', 'ç»ƒç´æˆ¿'),
            type: 'outSlot'
          });
          
          morningAllocated += useSec;
          console.log(`æ·»åŠ æ—©é—´æ®µå¤–åŒºé—´: ${new Date(segment[0]).toLocaleTimeString()}, ä½¿ç”¨${useSec}ç§’ (æ’é™¤å)`);
        }
      });
    }
  }
  
  // ğŸ”¥ æŒ‰æ—¶é—´æ’åº
  intervals.sort((a, b) => a.start - b.start);
  
  console.log(`æœ€ç»ˆç”Ÿæˆ${intervals.length}ä¸ªç»ƒç´åŒºé—´ (å·²åº”ç”¨æ’é™¤æ—¶é—´è¿‡æ»¤)`);
  return intervals;
}


// ğŸ”¥ ä¿®å¤ï¼šè·å–å†å²æ—¥æœŸçš„ç»ƒç´åŒºé—´
function getHistoryIntervals(studentName, date){
  const intervals = [];
  
  // 1. é¦–å…ˆå°è¯•ä» dailyPracticeRecords è·å–è¯¦ç»†ä¼šè¯è®°å½•
  const rec = dailyPracticeRecords[date] && dailyPracticeRecords[date][studentName];
  
  if(rec && Array.isArray(rec.sessions) && rec.sessions.length > 0) {
    // ä½¿ç”¨è¯¦ç»†çš„ä¼šè¯è®°å½•é‡æ„åŒºé—´
    rec.sessions.forEach(session => {
      if(session.start && session.end) {
        const start = session.start + 60000; // å»é™¤1åˆ†é’Ÿå‡†å¤‡æ—¶é—´
        if(start < session.end) {
          intervals.push({
            start,
            end: session.end,
            room: session.room || t('room.practice_room', 'ç»ƒç´æˆ¿')
          });
        }
      }
    });
    
    console.log(`${studentName} ${date} ä½¿ç”¨è¯¦ç»†ä¼šè¯è®°å½•ï¼Œç”Ÿæˆ${intervals.length}ä¸ªåŒºé—´`);
    return intervals;
  }
  
  if(!rec) { console.log(`æ²¡æœ‰æ‰¾åˆ° ${studentName} åœ¨ ${date} çš„æ•°æ®`); return intervals; }
  // ä¸å† summary é‡å»º
  return intervals;
}

// ä¿®æ”¹ getStudentTodayIntervals å‡½æ•°
function getStudentTodayIntervals(studentName){
  const todayKey = getTodayDateString();
  const intervals = [];

  // 1. å·²ç»“æŸä¼šè¯ï¼ˆä¼˜å…ˆä½¿ç”¨è¯¦ç»†çš„ sessions æ•°æ®ï¼‰
  const rec = dailyPracticeRecords[todayKey] && dailyPracticeRecords[todayKey][studentName];
  if(rec && Array.isArray(rec.sessions)){
    rec.sessions.forEach(s=>{
      if(!s.start || !s.end) return;
      const start = s.start + 60000; // å»é™¤1åˆ†é’Ÿå‡†å¤‡
      if(start >= s.end) return;
      intervals.push({
        start,
        end: s.end,
        room: s.room || t('room.practice_room', 'ç»ƒç´æˆ¿')
      });
    });
  }

  // 2. æ­£åœ¨è¿›è¡Œçš„ä¼šè¯ï¼ˆpracticeSessionTrackerï¼‰
  practiceSessionTracker.forEach(sess=>{
    if(!sess.isActive) return;
    if(sess.studentName !== studentName) return;
    const activeStart = Math.max(sess.prepEndTime, sess.startTime + 60000);
    const end = Date.now();
    if(activeStart < end){
      intervals.push({
        start: activeStart,
        end,
        room: sess.roomName
      });
    }
  });

  // ä¸å† summary é‡å»º

  return intervals;
}


/* =============== æŠ¥å‘Š =============== */
function getDateSpan(start,end){const res=[];let d=new Date(start),ed=new Date(end);while(d<=ed){res.push(formatDate(d));d.setDate(d.getDate()+1);}return res;}
function loadAttendanceRange(start,end){
  if(!isOnline)return Promise.resolve();
  const dates=getDateSpan(start,end);
  const tasks=[];
  dates.forEach(d=>{
    if(!attendanceRecordsCache[d]){
      tasks.push(database.ref(`attendanceRecords/${d}`).once('value').then(s=>{attendanceRecordsCache[d]=s.val()||null;}));
    }
  });
  return Promise.all(tasks);
}
function collectReportData(start,end){
  const dates=getDateSpan(start,end);
  const daily=[],agg=new Map();
  dates.forEach(date=>{
    const rec=attendanceRecordsCache[date];
    if(!rec){daily.push({date,total:0,present:0,absent:0,excused:0,rate:0});return;}
    const all=[...(rec.students||[]),...(rec.endedSlots||[])];
    let present=0,excused=0,absent=0,total=all.length;
    all.forEach(s=>{
      const st=s.finalAttendanceStatus;
      if(st==='present')present++;
      else if(st==='excused')excused++;
      else if(st==='absent')absent++;
      if(!agg.has(s.name))agg.set(s.name,{name:s.name,major:s.major||'',present:0,absent:0,excused:0,total:0});
      const a=agg.get(s.name);
      a.total++;
      if(st==='present')a.present++;
      else if(st==='excused')a.excused++;
      else if(st==='absent')a.absent++;
    });
    const rate=total?((present+excused)/total*100).toFixed(1):'0';
    daily.push({date,total,present,absent,excused,rate});
  });
  const students=[...agg.values()].map(s=>{
    s.rate=s.total?((s.present+s.excused)/s.total*100).toFixed(1):'0.0';return s;
  }).sort((a,b)=>b.rate-a.rate);
  return {daily,students};
}
function renderReportHTML(data,start,end){
  return `
  <div class="card">
    <h4>${t('report.analysis_title','ğŸ“Š è€ƒå‹¤åˆ†ææŠ¥å‘Š')}</h4>
    <div class="student-details">
      <div class="detail-item"><div class="detail-label">${t('report.period','ç»Ÿè®¡å‘¨æœŸ')}</div><div class="detail-value">${start} ${t('report.to','è‡³')} ${end} (${data.daily.length}${t('report.days','å¤©')})</div></div>
      <div class="detail-item"><div class="detail-label">${t('report.participants','å‚ä¸å­¦ç”Ÿ')}</div><div class="detail-value">${data.students.length}${t('report.people','äºº')}</div></div>
    </div>
  </div>
  <div class="card">
    <h4>${t('report.daily_trend','ğŸ“ˆ æ¯æ—¥è€ƒå‹¤è¶‹åŠ¿')}</h4>
    <div class="data-table-container" style="max-height:300px;overflow-y:auto;">
      <table class="data-table daily-trend">
        <thead><tr>
          <th>${t('report.date','æ—¥æœŸ')}</th>
          <th>${t('report.total','åˆè®¡')}</th>
          <th>${t('stats.present','å‡ºå‹¤')}</th>
          <th>${t('stats.absent','ç¼ºå‹¤')}</th>
          <th>${t('stats.excused','è¯·å‡')}</th>
          <th>${t('attendance.rate','å‡ºå‹¤ç‡')}</th>
        </tr></thead>
        <tbody>${data.daily.map(d=>`<tr>
          <td>${d.date}</td><td>${d.total}</td><td>${d.present}</td><td>${d.absent}</td><td>${d.excused}</td><td>${d.rate}%</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <h4>${t('report.student_stats','ğŸ‘¥ å­¦ç”Ÿè€ƒå‹¤ç»Ÿè®¡')}</h4>
    <div class="data-table-container" style="max-height:400px;overflow-y:auto;">
      <table class="data-table student-stats">
        <thead><tr>
          <th>${t('student.name','å§“å')}</th>
          <th>${t('student.major','ä¸“ä¸š')}</th>
          <th>${t('stats.present','å‡ºå‹¤')}</th>
          <th>${t('stats.absent','ç¼ºå‹¤')}</th>
          <th>${t('stats.excused','è¯·å‡')}</th>
          <th>${t('attendance.rate','å‡ºå‹¤ç‡')}</th>
        </tr></thead>
        <tbody>${data.students.map(s=>`<tr>
          <td>${s.name}</td><td>${s.major}</td><td>${s.present}</td><td>${s.absent}</td><td>${s.excused}</td><td>${s.rate}%</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>
    <div class="export-options">
      <button class="btn btn-primary" onclick="generateReport()"><span>ğŸ”„</span>${t('report.regenerate','é‡æ–°ç”Ÿæˆ')}</button>
    </div>
  </div>`;
}
function generateReport(){
  const s=document.getElementById('startDate').value;
  const e=document.getElementById('endDate').value;
  if(!s||!e){alert(t('msg.select_dates','è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ'));return;}
  if(new Date(s)>new Date(e)){alert(t('msg.date_range_error','å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ'));return;}
  const cont=document.getElementById('reportContent');
  cont.innerHTML='<div class="loading"><div class="spinner"></div></div>';
  loadAttendanceRange(s,e).then(()=>{
    const data=collectReportData(s,e);
    cont.innerHTML=renderReportHTML(data,s,e);
  }).catch(err=>{
    cont.innerHTML=`<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div class="empty-state-title">${t('empty.load_failed','åŠ è½½å¤±è´¥')}</div><div class="empty-state-description">${err.message}</div></div>`;
  });
}

/* =============== åŒæ­¥ / ç¼“å­˜ =============== */
function loadAllCoreData(){
  if(!database)return;
  const ready={rooms:false,students:false,excuses:false,slots:false};
  function maybeInitialRender(){
    if(Object.values(ready).every(v=>v)){
      addSyncLog('âœ… é¦–å±æ•°æ®å°±ç»ªï¼Œæ‰§è¡Œåˆæ¬¡æ¸²æŸ“');
  updateStatsPanel();
  renderPracticeArea();
  renderExcusePanel();
  if(currentTab==='students')renderStudentList();
  // é¦–å±å®Œæˆåç«‹å³è®¡ç®—æ’è¡Œæ¦œï¼ˆé¿å…â€œå°šæœªè®¡ç®—â€åœç•™ï¼‰
  if(typeof computeLeaderboard==='function') computeLeaderboard();
    }
  }
  Promise.all([
  database.ref('rooms').once('value').then(s=>{if(Array.isArray(s.val())){rooms=s.val();buildRealTimePracticeFromRooms();}ready.rooms=true;maybeInitialRender();}),
  database.ref('studentDatabase').once('value').then(s=>{if(s.val())studentDatabase=s.val();ready.students=true;maybeInitialRender(); scheduleLeaderboardUpdate&&scheduleLeaderboardUpdate();}),
  database.ref('excuseData').once('value').then(s=>{if(s.val())excuseData=s.val();ready.excuses=true;maybeInitialRender();}),
  database.ref('studentTimeSlots').once('value').then(s=>{const raw=s.val()||{};const before=Object.values(raw).reduce((sum,x)=>sum + (x?.monday?.length||0)+(x?.tuesday?.length||0)+(x?.wednesday?.length||0)+(x?.thursday?.length||0)+(x?.friday?.length||0),0);studentTimeSlots=normalizeStudentTimeSlots(raw);const after=Object.values(studentTimeSlots).reduce((sum,x)=>sum + (x?.monday?.length||0)+(x?.tuesday?.length||0)+(x?.wednesday?.length||0)+(x?.thursday?.length||0)+(x?.friday?.length||0),0);addSyncLog(`ğŸ§® é¦–æ¬¡åŠ è½½ timeSlots å½’ä¸€åŒ– ${before} -> ${after}`);ready.slots=true;maybeInitialRender(); scheduleLeaderboardUpdate&&scheduleLeaderboardUpdate();})
  ]).catch(e=>addSyncLog('âŒ åŠ è½½å¤±è´¥ '+e.message));
}
function forceSync(){
  if(!isOnline){alert(t('msg.sync_required','éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½åŒæ­¥æ•°æ®'));return;}
  addSyncLog('ğŸ”„ '+t('sync.force_sync','å¼ºåˆ¶åŒæ­¥'));
  loadAllCoreData();
}
function clearLocalCache(){
  if(!confirm(t('msg.clear_cache_confirm','ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ç¼“å­˜å—ï¼Ÿ')))return;
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith('practiceRecords_'))localStorage.removeItem(k);
  });
  addSyncLog('ğŸ—‘ï¸ '+t('msg.cache_cleared','æœ¬åœ°ç¼“å­˜å·²æ¸…é™¤'));
  alert(t('msg.cache_cleared','æœ¬åœ°ç¼“å­˜å·²æ¸…é™¤'));
}

/* =============== Tab åˆ‡æ¢ =============== */
function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick').includes(tab)));
  document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
  const host = document.getElementById(tab+'Tab');
  if(host) host.style.display='block';
  if(tab==='dashboard'){
    updateStatsPanel();
    renderPracticeArea();
    renderExcusePanel();
  } else if(tab==='students'){
    renderStudentList();
  } else if(tab==='leaderboard'){
    // è¿›å…¥æ’è¡Œæ¦œæ—¶è‹¥æ•°æ®ä¸ºç©ºæˆ–è¶…è¿‡5åˆ†é’Ÿï¼Œé‡æ–°è®¡ç®—
    const now=Date.now();
    if(!leaderboardState.raw.length || (now - leaderboardState.lastCompute > 5*60*1000)){
      computeLeaderboard();
    }
  }
}
function refreshCurrentTabContent(){
  if(currentTab==='dashboard'){updateStatsPanel();renderPracticeArea();renderExcusePanel();}
  else if(currentTab==='students'){renderStudentList();}
}
/* ===== æ€§èƒ½ï¼šæ¸²æŸ“å‡½æ•°å»æŠ–ä¸åˆæ‰¹ ===== */
;(function(){
  const DEBOUNCE_MS=120; // è¶³å¤ŸçŸ­ï¼Œä¸å½±å“ä½“éªŒ
  function debounce(fn,delay){let t;return function(){const ctx=this,args=arguments;clearTimeout(t);t=setTimeout(()=>fn.apply(ctx,args),delay);};}
  // å¦‚æœåŸå‡½æ•°å·²ç»å­˜åœ¨ï¼Œåˆ™æ›¿æ¢ä¸ºå»æŠ–åŒ…è£…ç‰ˆæœ¬ï¼ˆä¿ç•™åç§°ç”¨äºæ ˆè¿½è¸ªï¼‰
  if(typeof window.renderPracticeArea==='function') window.renderPracticeArea = debounce(window.renderPracticeArea,DEBOUNCE_MS);
  if(typeof window.renderStudentList==='function') window.renderStudentList = debounce(window.renderStudentList,DEBOUNCE_MS);
  if(typeof window.updateStatsPanel==='function') window.updateStatsPanel = debounce(window.updateStatsPanel,DEBOUNCE_MS);
  if(typeof window.renderExcusePanel==='function') window.renderExcusePanel = debounce(window.renderExcusePanel,DEBOUNCE_MS);
})();

/* ===== æ€§èƒ½ï¼šæ•°æ®æ›´æ–°åˆæ‰¹è°ƒåº¦ ===== */
;(function(){
  const pendingKeys=new Set();
  let scheduled=false;
  function flush(){scheduled=false;const keys=[...pendingKeys];pendingKeys.clear();
    // ç®€å•ç­–ç•¥ï¼šæŒ‰é”®è§¦å‘å¯¹åº”æ¸²æŸ“
    if(keys.includes('practice')){ if(currentTab==='dashboard'){renderPracticeArea();} }
    if(keys.includes('students')){ if(currentTab==='students'){renderStudentList();} }
    if(keys.includes('stats')){ if(currentTab==='dashboard'){updateStatsPanel();} }
    if(keys.includes('excuse')){ if(currentTab==='dashboard'){renderExcusePanel();} }
  }
  window.scheduleDataUpdate=function(key){pendingKeys.add(key);if(!scheduled){scheduled=true;queueDomUpdate(flush);}}
})();
/* =============== è°ƒè¯•å‡½æ•° =============== */
function debugStudentData(studentName, date) {
  console.log(`=== è°ƒè¯•å­¦ç”Ÿæ•°æ®: ${studentName} ${date} ===`);
  
  // æ£€æŸ¥åŸå§‹æ•°æ®
  const rec = dailyPracticeRecords[date] && dailyPracticeRecords[date][studentName];
  console.log('åŸå§‹ç»ƒç´è®°å½•:', rec);
  
  // æ£€æŸ¥é‡æ„çš„åŒºé—´
  const intervals = getHistoryIntervals(studentName, date);
  console.log('é‡æ„åŒºé—´:', intervals);
  intervals.forEach((interval, index) => {
    const startTime = new Date(interval.start).toLocaleTimeString();
    const endTime = new Date(interval.end).toLocaleTimeString();
    const duration = Math.round((interval.end - interval.start) / 60000);
    console.log(`  åŒºé—´${index + 1}: ${startTime} - ${endTime} (${duration}åˆ†é’Ÿ) æˆ¿é—´: ${interval.room}`);
  });
  
  // æ£€æŸ¥æ—¶é—´æ®µå®‰æ’
  const target = new Date(date);
  const wd = target.getDay();
  const map = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = map[wd];
  const slots = (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) 
                  ? studentTimeSlots[studentName][key] : [];
  console.log('æ—¶é—´æ®µå®‰æ’:', slots);
  
  // æ£€æŸ¥æ¯ä¸ªæ—¶é—´æ®µçš„é‡å è®¡ç®—
  if (slots.length > 0) {
    slots.forEach((slot, index) => {
      const slotStartMs = new Date(`${date}T${slot.start}:00`).getTime();
      const slotEndMs = new Date(`${date}T${slot.end}:00`).getTime();
      const slotDurSec = (slotEndMs - slotStartMs) / 1000;
      const overlapSec = calcOverlapSeconds(intervals, slotStartMs, slotEndMs);
      
      console.log(`æ—¶é—´æ®µ${index + 1}: ${slot.start}-${slot.end}`);
      console.log(`  æ—¶é—´æ®µé•¿åº¦: ${Math.round(slotDurSec/60)}åˆ†é’Ÿ`);
      console.log(`  é‡å æ—¶é•¿: ${Math.round(overlapSec/60)}åˆ†é’Ÿ`);
      console.log(`  å‡ºå‹¤é˜ˆå€¼: ${Math.round(slotDurSec * 0.6/60)}åˆ†é’Ÿ`);
      console.log(`  åˆ¤æ–­ç»“æœ: ${overlapSec >= slotDurSec * 0.6 ? 'å‡ºå‹¤' : overlapSec >= 300 ? 'ä½æ•ˆ' : 'ç¼ºå‹¤'}`);
    });
  }
  
  return {rec, intervals, slots};
}
/* =============== æš´éœ²å‡½æ•° =============== */
window.switchLanguage=switchLanguage;
window.switchTab=switchTab;
window.filterPracticeStatus=filterPracticeStatus;
window.clearPracticeFilters=()=>{document.getElementById('practiceMajorFilter').value='';document.getElementById('practiceGradeFilter').value='';document.getElementById('practiceStudentSearch').value='';filterPracticeStatus();};
window.openStudentDetail=openStudentDetail;
window.closeModal=closeModal;
window.generateReport=generateReport;
window.forceSync=forceSync;
window.clearLocalCache=clearLocalCache;
window.filterStudents=renderStudentList;
window.showDayAttendanceDetail=showDayAttendanceDetail;
window.snapshotTodayAttendance=snapshotTodayAttendance;
window.updatePracticeSessions = updatePracticeSessions; // ğŸ”¥ æ–°å¢
// window.runLeaderboardSimulation = runLeaderboardSimulation; // å·²ç§»é™¤æ¨¡æ‹Ÿå‡½æ•°
window.showLeaderboardDetail = showLeaderboardDetail; // ğŸ”¥ è§„åˆ™è¯´æ˜
window.showStudentLeaderboardDetail = showStudentLeaderboardDetail; // ğŸ”¥ å­¦ç”Ÿè¯¦æƒ…

// ================== å†å²è¶‹åŠ¿è¾…åŠ©ï¼ˆæœ€è¿‘å·¥ä½œæ—¥ D1/D2/D3ï¼‰ ==================
if(typeof window.getStudentRecentDimensionHistory !== 'function'){
  window.getStudentRecentDimensionHistory = function(name, limit=5){
    try{
      const store = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      const arr = Object.values(store).filter(x=>x && Array.isArray(x.data));
      arr.sort((a,b)=> a.date<b.date?1:-1); // desc
      const res=[];
      for(const e of arr){
        if(res.length>=limit) break;
        const d = new Date(e.date);
        const wd=d.getDay(); if(wd===0||wd===6) continue; // è·³è¿‡å‘¨æœ«
        const row = e.data.find(r=>r.n===name);
        if(row) res.push({date:e.date,d1:row.d1,d2:row.d2,d3:row.d3});
      }
      return res.reverse();
    }catch{return[];}
  };
}
if(typeof window.renderSparkline!=='function'){
  window.renderSparkline = function(data){
    if(!data.length) return '<div style="font-size:12px;color:var(--text-secondary);">æš‚æ— è¶‹åŠ¿æ•°æ®</div>';
    const w=200,h=56,pad=4;const scaleY=v=>h-(v/40)*h;const step=data.length>1?(w-pad*2)/(data.length-1):0;
    function points(key){return data.map((p,i)=>({x:pad+i*step,y:scaleY(p[key]),v:p[key],date:p.date}));}
    const P={d1:points('d1'),d2:points('d2'),d3:points('d3')};
    function toPolyline(arr){return arr.map(p=>`${p.x},${p.y}`).join(' ');} 
    const dates=data.map(d=>d.date.slice(5));
    const svgId='spark-'+Math.random().toString(36).slice(2,8);
    // åˆå§‹å…¨éƒ¨æ˜¾ç¤º
    const html = `<div class="lb-spark-wrap" data-svg="${svgId}" style="display:flex;flex-direction:column;gap:6px;max-width:${w+20}px;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <label style="font-size:11px;display:flex;align-items:center;gap:4px;">
          <input type="checkbox" data-dim="d1" checked style="margin:0;"> <span style="display:inline-flex;align-items:center;gap:4px;"><i class="lb-dot" style="background:#1976d2"></i>D1</span>
        </label>
        <label style="font-size:11px;display:flex;align-items:center;gap:4px;">
          <input type="checkbox" data-dim="d2" checked style="margin:0;"> <span style="display:inline-flex;align-items:center;gap:4px;"><i class="lb-dot" style="background:#8e24aa"></i>D2</span>
        </label>
        <label style="font-size:11px;display:flex;align-items:center;gap:4px;">
          <input type="checkbox" data-dim="d3" checked style="margin:0;"> <span style="display:inline-flex;align-items:center;gap:4px;"><i class="lb-dot" style="background:#f57c00"></i>D3</span>
        </label>
        <span style="font-size:10px;color:var(--text-secondary);">${dates.join(' / ')}</span>
      </div>
      <div style="position:relative;">
        <svg id="${svgId}" class="lb-sparkline" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" style="width:100%;height:${h}px;">
          <g data-line="d1"><polyline points="${toPolyline(P.d1)}" fill="none" stroke="#1976d2" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" /></g>
          <g data-line="d2"><polyline points="${toPolyline(P.d2)}" fill="none" stroke="#8e24aa" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" /></g>
          <g data-line="d3"><polyline points="${toPolyline(P.d3)}" fill="none" stroke="#f57c00" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" /></g>
          <g data-points></g>
        </svg>
        <div class="lb-spark-tooltip" style="position:absolute;top:4px;left:4px;padding:6px 8px;font-size:11px;background:rgba(0,0,0,.75);color:#fff;border-radius:6px;pointer-events:none;opacity:0;transform:translateY(-4px);transition:.15s;backdrop-filter:blur(4px);"></div>
      </div>
    </div>`;
    // å»¶è¿Ÿç»‘å®šäº¤äº’
    setTimeout(()=>{
      const wrap=document.querySelector(`.lb-spark-wrap[data-svg='${svgId}']`); if(!wrap) return;
      const svg=wrap.querySelector('svg'); const tip=wrap.querySelector('.lb-spark-tooltip');
      const pointLayer=svg.querySelector('[data-points]');
      const dims={d1:'#1976d2',d2:'#8e24aa',d3:'#f57c00'};
      function drawPoints(){
        pointLayer.innerHTML='';
        Object.keys(P).forEach(k=>{
          if(!wrap.querySelector(`input[data-dim='${k}']`).checked) return;
            P[k].forEach(pt=>{
              const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
              c.setAttribute('cx',pt.x);c.setAttribute('cy',pt.y);c.setAttribute('r',3.2);c.setAttribute('fill',dims[k]);
              c.addEventListener('mouseenter',()=>{tip.style.opacity=1;tip.innerHTML=`<b>${pt.date.slice(5)}</b><br>${k.toUpperCase()}: ${pt.v.toFixed(1)}`;});
              c.addEventListener('mouseleave',()=>{tip.style.opacity=0;});
              c.addEventListener('mousemove',(e)=>{const rect=svg.getBoundingClientRect();tip.style.left=(e.clientX-rect.left+8)+'px';tip.style.top=(e.clientY-rect.top+8)+'px';});
              pointLayer.appendChild(c);
            });
        });
      }
      wrap.querySelectorAll('input[type=checkbox][data-dim]').forEach(cb=>{
        cb.addEventListener('change',()=>{
          const k=cb.dataset.dim; const g=svg.querySelector(`[data-line='${k}']`); if(g){g.style.display=cb.checked?'block':'none';}
          drawPoints();
        });
      });
      drawPoints();
    },0);
    return html;
  };
}

/* =============== åˆå§‹åŒ– =============== */
document.addEventListener('DOMContentLoaded',()=>{
  const saved=localStorage.getItem('preferred_language');if(saved)currentLanguage=saved;
  // ğŸ”¥ ä¿®å¤ï¼šåŒæ­¥æŒ‰é’®çŠ¶æ€å’Œé¡µé¢è¯­è¨€
  syncLanguageButtons();
  updatePageLanguage();
  initFirebase();
  initClock();
  
  // åˆå§‹åŒ–å­¦ç”Ÿç»Ÿè®¡å¿«ç…§ç³»ç»Ÿ
  cleanOldStudentStatsSnapshots(30); // æ¸…ç†30å¤©å‰çš„å¿«ç…§
  cleanOldAttendanceDetailSnapshots(30); // æ¸…ç†30å¤©å‰çš„è€ƒå‹¤è¯¦æƒ…å¿«ç…§
  
  addSyncLog('ğŸš€ ç³»ç»Ÿå¯åŠ¨');
});

/* =============== å®šæ—¶ä»»åŠ¡ =============== */
// ï¼ˆå·²è¿ç§»åˆ°ç»Ÿä¸€è°ƒåº¦å™¨ï¼‰åŸ 30s / 10s setInterval å·²ç¦ç”¨ï¼Œé¿å…é‡å¤æ‰§è¡Œ
// ä¿ç•™ä»£ç ä½ç½®ä½œä¸ºæ–‡æ¡£å‚è€ƒï¼Œå¦‚éœ€æ¢å¤å¯è§£å¼€ä¸‹é¢æ³¨é‡Š
/*
// setInterval(()=>{ // 30s åˆ·æ–°  
//   ...
// },30000);
// setInterval(()=>{ // 10s ä¼šè¯æ£€æŸ¥  
//   ...
// },10000);
*/

/* ================= æ€§èƒ½ä¼˜åŒ–å†…æ ¸æ’å…¥å¼€å§‹ ================= */
// ğŸ”§ ç»Ÿä¸€è°ƒåº¦å™¨ï¼ˆæ›¿ä»£åˆ†æ•£çš„ setIntervalï¼‰
;(function(){
  const tasks=[]; // {interval,lastRun,fn}
  function addTask(interval,fn){tasks.push({interval,lastRun:performance.now(),fn});}
  // æ³¨å†ŒåŸæœ‰ä¸¤ä¸ªå‘¨æœŸä»»åŠ¡ï¼ˆä¿æŒé€»è¾‘ä¸å˜ï¼‰
  // 30ç§’ä»»åŠ¡ï¼šç»ƒç´UIåˆ·æ–°ï¼ˆæ›¿æ¢åŸ setIntervalï¼‰
  const old30 = ()=>{
    const now=Date.now();
    Object.keys(realTimePracticeMap).forEach(n=>{const p=realTimePracticeMap[n];p.currentSec=Math.floor((now-p.startTime)/1000);});
    if(currentTab==='dashboard')renderPracticeArea();
    if(currentTab==='students')renderStudentList();
  };
  // 10ç§’ä»»åŠ¡ï¼šä¼šè¯æ£€æŸ¥ + å¢é‡åŒæ­¥ï¼ˆæ›¿æ¢åŸ setIntervalï¼‰
  const old10 = ()=>{
    const now=Date.now();
    if(now-lastPracticeSessionSweep>=PRACTICE_UPDATE_INTERVAL_MS-500){
      updatePracticeSessions();
      lastPracticeSessionSweep=now;
    }
    syncActiveSessionsIncrement();
  };
  // åœç”¨ä¸Šé¢çš„ setIntervalï¼ˆä¿ç•™åŸå®ç°å·²æ‰§è¡Œä¸€æ¬¡ï¼Œä¸å†ç»§ç»­ï¼‰
  // ä½¿ç”¨ç»Ÿä¸€å¿ƒè·³ 1000msï¼ˆè¶³å¤Ÿä½å¼€é”€ï¼‰
  addTask(10000, old10);
  addTask(30000, old30);
  let running=false;
  function heartbeat(){
    const now=performance.now();
    for(const t of tasks){
      if(now - t.lastRun >= t.interval){
        try{t.fn();}catch(e){console.error('[Scheduler]',e);}finally{t.lastRun=now;}
      }
    }
    if(running) setTimeout(heartbeat,1000); // ç”¨ setTimeout é™ä½ä¸ rAF çš„ç«äº‰
  }
  running=true;heartbeat();
  window.__perfSchedulerAdd = addTask;
})();

// ğŸ”§ DOM æ›´æ–°æ‰¹å¤„ç†å±‚ queueDomUpdate
;(function(){
  const q=[];let scheduled=false;
  function flush(){scheduled=false;const copy=q.splice(0);for(const job of copy){try{job();}catch(e){console.error('[DOMQ]',e);}}}
  window.queueDomUpdate=function(fn){q.push(fn);if(!scheduled){scheduled=true;requestAnimationFrame(flush);}}
})();

/* å·²å…³é—­ FPS ç›‘æ§ä¸è‡ªåŠ¨æ€§èƒ½æ¨¡å¼ */
;(function(){ console.info('[FPS] å·²ç¦ç”¨å®æ—¶ FPS å°çƒä¸è‡ªåŠ¨æ€§èƒ½æ¨¡å¼'); })();

// ğŸ”§ å¯è§†åŒºåŸŸåŠ¨ç”»æš‚åœï¼ˆèŠ‚èƒ½ï¼‰
;(function(){
  if(!('IntersectionObserver' in window)) return;
  const animatedSel='[data-anim="loop"], .pulse, .glow';
  function refresh(){
    document.querySelectorAll(animatedSel).forEach(el=>observer.observe(el));
  }
  const observer=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){e.target.classList.remove('anim-paused');}
      else {e.target.classList.add('anim-paused');}
    });
  },{root:null,threshold:0});
  document.addEventListener('DOMContentLoaded',refresh);
  setTimeout(refresh,2000);
})();

// ğŸ”§ è¢«åŠ¨äº‹ä»¶ä¼˜åŒ–
;(function(){
  const origAdd=EventTarget.prototype.addEventListener;
  EventTarget.prototype.addEventListener=function(type,listener,options){
    // ä»…å¯¹è§¦æ‘¸/æ»šåŠ¨ç¼ºçœæ³¨å…¥ passive:true
    if((type==='touchstart'||type==='touchmove'||type==='wheel') ){
      if(options===undefined) options={passive:true};
      else if(typeof options==='boolean') options={capture:options, passive:true};
      else if(options && options.passive===undefined) options.passive=true;
    }
    return origAdd.call(this,type,listener,options);
  };
})();

// ğŸ”§ ç»Ÿä¸€æ•°å­—æ¸è¿›æ›´æ–°ï¼ˆç¤ºä¾‹ï¼šå¯ç”¨ queueDomUpdate åŒ…è£… setTextï¼‰
window.safeSetText=function(id,val){queueDomUpdate(()=>{const el=document.getElementById(id);if(el&&el.textContent!==val)el.textContent=val;});};

// å¯æ‰©å±•æ¥å£

/* =============== ğŸ›ï¸ æ•°æ®ä¼ è¾“ä¼˜åŒ–æ§åˆ¶å° =============== */

// ä¸ºå¼€å‘è€…å’Œç®¡ç†å‘˜æä¾›çš„æ•°æ®ä¼ è¾“ä¼˜åŒ–å·¥å…·
window.DataTransferOptimizer = {
  // è·å–ä¼˜åŒ–çŠ¶æ€æŠ¥å‘Š
  getStatusReport() {
    return {
      dataSync: {
        localVersions: DataSyncOptimizer.localVersions,
        networkQuality: DataSyncOptimizer.networkQuality,
        compressionEnabled: DataSyncOptimizer.compressionEnabled,
        pendingChanges: DataSyncOptimizer.pendingChanges.size
      },
      cache: SmartCacheManager.getStats(),
      network: NetworkMonitor.getStatusReport(),
      batchUpload: {
        queueStatus: BatchUploadManager.getQueueStatus(),
        config: BatchUploadManager.config
      }
    };
  },
  
  // æ‰‹åŠ¨è§¦å‘æ•°æ®å‹ç¼©æµ‹è¯•
  testCompression(data = null) {
    const testData = data || {
      rooms: rooms,
      studentDatabase: studentDatabase,
      timestamp: Date.now()
    };
    
    const compressed = DataSyncOptimizer.compressData(testData);
    const result = {
      originalSize: JSON.stringify(testData).length,
      compressedSize: compressed.compressed ? compressed.compressedSize : 'N/A',
      compressionRatio: compressed.compressed ? 
        ((1 - compressed.compressedSize / compressed.originalSize) * 100).toFixed(2) + '%' : 'N/A',
      effective: compressed.compressed && compressed.compressedSize < compressed.originalSize * 0.8
    };
    
    console.log('ğŸ“¦ æ•°æ®å‹ç¼©æµ‹è¯•ç»“æœ:', result);
    return result;
  },
  
  // å¼ºåˆ¶æ¸…ç†æ‰€æœ‰ç¼“å­˜
  clearAllCache() {
    // æ¸…ç†æ™ºèƒ½ç¼“å­˜
    SmartCacheManager.performCleanup();
    
    // æ¸…ç†ç‰ˆæœ¬ç¼“å­˜
    localStorage.removeItem('dataVersions');
    DataSyncOptimizer.initVersions();
    
    // æ¸…ç†æ—§çš„ç»ƒç´è®°å½•ç¼“å­˜
    for (let i = localStorage.length - 1; i >= 0; i--) {
      const key = localStorage.key(i);
      if (key && key.startsWith('practiceRecords_')) {
        localStorage.removeItem(key);
      }
    }
    
    console.log('ğŸ§¹ æ‰€æœ‰ç¼“å­˜å·²æ¸…ç†');
    addSyncLog('ğŸ§¹ ç®¡ç†å‘˜æ¸…ç†äº†æ‰€æœ‰ç¼“å­˜');
  },
  
  // æ‰‹åŠ¨è§¦å‘ç½‘ç»œè´¨é‡æ£€æµ‹
  async testNetworkQuality() {
    console.log('ğŸŒ å¼€å§‹æ‰‹åŠ¨ç½‘ç»œè´¨é‡æ£€æµ‹...');
    await NetworkMonitor.checkNetworkQuality();
    return NetworkMonitor.getStatusReport();
  },
  
  // å¼ºåˆ¶ä¸Šä¼ æ‰€æœ‰å¾…å¤„ç†çš„æ‰¹æ¬¡
  async flushAllBatches() {
    console.log('ğŸ“¤ å¼ºåˆ¶ä¸Šä¼ æ‰€æœ‰å¾…å¤„ç†æ‰¹æ¬¡...');
    await BatchUploadManager.flushAll();
    console.log('âœ… æ‰€æœ‰æ‰¹æ¬¡å·²å¼ºåˆ¶ä¸Šä¼ ');
  },
  
  // è®¾ç½®å‹ç¼©é˜ˆå€¼
  setCompressionThreshold(enabled = true) {
    DataSyncOptimizer.compressionEnabled = enabled;
    console.log(`ğŸ“¦ æ•°æ®å‹ç¼©å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
    addSyncLog(`ğŸ“¦ æ•°æ®å‹ç¼©å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
  },
  
  // è°ƒæ•´æ‰¹é‡ä¸Šä¼ é…ç½®
  setBatchConfig(config = {}) {
    Object.assign(BatchUploadManager.config, config);
    console.log('âš™ï¸ æ‰¹é‡ä¸Šä¼ é…ç½®å·²æ›´æ–°:', BatchUploadManager.config);
  },
  
  // æ¨¡æ‹Ÿç½‘ç»œæ¡ä»¶ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  simulateNetworkCondition(quality = 'good') {
    DataSyncOptimizer.networkQuality = quality;
    NetworkMonitor.status.quality = quality;
    console.log(`ğŸ­ æ¨¡æ‹Ÿç½‘ç»œæ¡ä»¶: ${quality}`);
    NetworkMonitor.onStatusChange();
  },
  
  // ç”Ÿæˆæ•°æ®ä¼ è¾“ä¼˜åŒ–æŠ¥å‘Š
  generateOptimizationReport() {
    const report = {
      timestamp: new Date().toISOString(),
      summary: this.getStatusReport(),
      recommendations: this.getOptimizationRecommendations(),
      metrics: this.calculateOptimizationMetrics()
    };
    
    console.log('ğŸ“Š æ•°æ®ä¼ è¾“ä¼˜åŒ–æŠ¥å‘Š:', report);
    return report;
  },
  
  // è·å–ä¼˜åŒ–å»ºè®®
  getOptimizationRecommendations() {
    const status = this.getStatusReport();
    const recommendations = [];
    
    // ç¼“å­˜å‘½ä¸­ç‡å»ºè®®
    const hitRate = parseFloat(status.cache.hitRate);
    if (hitRate < 70) {
      recommendations.push({
        type: 'cache',
        priority: 'high',
        message: `ç¼“å­˜å‘½ä¸­ç‡è¾ƒä½ (${status.cache.hitRate})ï¼Œå»ºè®®å¢åŠ é¢„åŠ è½½ç­–ç•¥`
      });
    }
    
    // ç½‘ç»œè´¨é‡å»ºè®®
    if (status.network.quality === 'poor') {
      recommendations.push({
        type: 'network',
        priority: 'high',
        message: 'ç½‘ç»œè´¨é‡è¾ƒå·®ï¼Œå»ºè®®å¯ç”¨æ•°æ®å‹ç¼©å’Œå¢åŠ æ‰¹é‡å¤§å°'
      });
    }
    
    // æ‰¹é‡é˜Ÿåˆ—å»ºè®®
    const queueCount = Object.keys(status.batchUpload.queueStatus).length;
    if (queueCount > 5) {
      recommendations.push({
        type: 'batch',
        priority: 'medium',
        message: `æ‰¹é‡é˜Ÿåˆ—ç§¯å‹è¾ƒå¤š (${queueCount} ä¸ª)ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œçŠ¶å†µ`
      });
    }
    
    return recommendations;
  },
  
  // è®¡ç®—ä¼˜åŒ–æŒ‡æ ‡
  calculateOptimizationMetrics() {
    const status = this.getStatusReport();
    
    return {
      dataEfficiency: {
        compressionEnabled: status.dataSync.compressionEnabled,
        pendingChanges: status.dataSync.pendingChanges,
        cacheHitRate: status.cache.hitRate
      },
      networkPerformance: {
        quality: status.network.quality,
        latency: status.network.latency,
        bandwidth: status.network.bandwidth
      },
      uploadEfficiency: {
        queuedBatches: Object.keys(status.batchUpload.queueStatus).length,
        batchSize: status.batchUpload.config.maxBatchSize,
        timeout: status.batchUpload.config.batchTimeout
      }
    };
  }
};

// åœ¨æ§åˆ¶å°ä¸­æä¾›å¿«é€Ÿè®¿é—®
console.log('ğŸ›ï¸ æ•°æ®ä¼ è¾“ä¼˜åŒ–å·¥å…·å·²åŠ è½½');
console.log('ä½¿ç”¨ DataTransferOptimizer.getStatusReport() æŸ¥çœ‹çŠ¶æ€');
console.log('ä½¿ç”¨ DataTransferOptimizer.generateOptimizationReport() ç”ŸæˆæŠ¥å‘Š');

// æ¯åˆ†é’Ÿè‡ªåŠ¨è®°å½•ä¸€æ¬¡ä¼˜åŒ–æŒ‡æ ‡
setInterval(() => {
  const metrics = window.DataTransferOptimizer.calculateOptimizationMetrics();
  console.log('ğŸ“Š ä¼ è¾“ä¼˜åŒ–æŒ‡æ ‡:', metrics);
}, 60000);
window.__perfAPI={queueDomUpdate, addPeriodicTask:window.__perfSchedulerAdd};
/* ================= æ€§èƒ½ä¼˜åŒ–å†…æ ¸æ’å…¥ç»“æŸ ================= */

/* ===== è‡ªåŠ¨å¾ªç¯åŠ¨ç”»æ‰“æ ‡ï¼šä¸ºåŠ¨æ€ç”Ÿæˆçš„å…ƒç´ æ·»åŠ  data-anim="loop"ï¼Œä¾¿äºç»Ÿä¸€æš‚åœ/æ¢å¤ ===== */
;(function(){
  const LOOP_SELECTOR='.practice-indicator, .time-slot-tag.current, .connection-status.syncing';
  function tag(el){ if(!el || el.dataset.anim==='loop') return; el.dataset.anim='loop'; }
  function scan(root){ (root||document).querySelectorAll(LOOP_SELECTOR).forEach(tag); }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',()=>scan(document)); else scan(document);
  const mo=new MutationObserver(list=>{
    for(const m of list){
      if(m.type==='childList'){
        m.addedNodes.forEach(n=>{ if(n.nodeType===1){ if(n.matches && n.matches(LOOP_SELECTOR)) tag(n); if(n.querySelectorAll) n.querySelectorAll(LOOP_SELECTOR).forEach(tag);} });
      } else if(m.type==='attributes' && m.target && m.target.nodeType===1){
        const el=m.target; if(el.matches && el.matches(LOOP_SELECTOR)) tag(el);
      }
    }
  });
  mo.observe(document.documentElement,{subtree:true,childList:true,attributes:true,attributeFilter:['class']});
})();

</script>
</body>
</html>
<!-- æ‰‹åŠ¨æ€§èƒ½æ¨¡å¼æŒ‰é’®ä¸è„šæœ¬ -->
<style id="perf-toggle-style">
.perf-toggle-btn{position:fixed;z-index:2500;right:14px;bottom:14px;width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,#1f6feb,#388bfd);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;cursor:pointer;user-select:none;box-shadow:0 4px 12px rgba(0,0,0,.25);transition:box-shadow .25s,transform .25s;}
.perf-toggle-btn:hover{box-shadow:0 6px 18px rgba(0,0,0,.35);}
.perf-toggle-btn:active{transform:scale(.92);} 
.perf-toggle-btn small{display:block;font-size:9px;line-height:10px;font-weight:500;opacity:.85;}
html.performance-mode .perf-toggle-btn{background:linear-gradient(135deg,#6e7681,#484f58);} 
html.performance-mode .perf-toggle-btn::after{content:'LOW';position:absolute;bottom:-14px;font-size:10px;color:#888;}
@media (max-width:768px){.perf-toggle-btn{right:10px;bottom:10px;width:42px;height:42px;font-size:11px;}}
</style>
<!-- FPS æŒ‰é’®å·²ç¦ç”¨ -->
<style>.perf-toggle-btn{display:none!important;}</style>
<script>
(function(){
  const btn=document.getElementById('perfToggle');if(!btn)return;
  let manual=false; // æ‰‹åŠ¨é”å®šçŠ¶æ€
  btn.addEventListener('click',()=>{
    manual=!manual;
    if(manual){
      if(!document.documentElement.classList.contains('performance-mode')){
        document.documentElement.classList.add('performance-mode');
      } else {
        document.documentElement.classList.remove('performance-mode');
      }
      btn.classList.add('manual');
    } else {
      btn.classList.remove('manual');
    }
  });
  // åŠ¨æ€æ˜¾ç¤ºå½“å‰å¹³å‡FPSï¼ˆå¤ç”¨å‰é¢ç›‘æ§ï¼Œå¦‚æœªæš´éœ²åˆ™è‡ªè¡Œç®€å•ç»Ÿè®¡ï¼‰
  let last=performance.now(),frames=0,fps=60;function loop(){frames++;const now=performance.now();if(now-last>=1000){fps=Math.round(frames*1000/(now-last));frames=0;last=now;btn.textContent=fps;}
    requestAnimationFrame(loop);}requestAnimationFrame(loop);
})();
</script>
</html>
<!-- çŠ¶æ€å¾½ç« æ·±è‰²æ¨¡å¼çº¯è‰²è¦†ç›–ï¼šé˜²æ­¢æ®‹ç•™æ¸å˜ -->
<style id="status-badge-override">
/* æµ…è‰²æ¨¡å¼ï¼šçŠ¶æ€å¾½ç« é¢œè‰²åŒºåˆ† */
.student-status.present, .student-status-compact.present, .status-badge.present { 
  background: #d4edda !important; 
  color: #155724 !important; 
  border: 1px solid #c3e6cb !important; 
  background-image: none !important; 
}
.student-status.absent, .student-status-compact.absent, .status-badge.absent { 
  background: #f8d7da !important; 
  color: #721c24 !important; 
  border: 1px solid #f5c6cb !important; 
  background-image: none !important; 
}
.student-status.practicing-unscheduled, .student-status-compact.practicing-unscheduled, .status-badge.practicing-unscheduled { 
  background: #d1ecf1 !important; 
  color: #0c5460 !important; 
  border: 1px solid #bee5eb !important; 
  background-image: none !important; 
}
.student-status.not-practicing, .student-status-compact.not-practicing, .status-badge.not-practicing { 
  background: #e2e3e5 !important; 
  color: #383d41 !important; 
  border: 1px solid #d6d8db !important; 
  background-image: none !important; 
}
.student-status.excused, .student-status-compact.excused, .status-badge.excused { 
  background: #fff3cd !important; 
  color: #856404 !important; 
  border: 1px solid #ffeaa7 !important; 
  background-image: none !important; 
}
.student-status.pending, .student-status-compact.pending, .status-badge.pending { 
  background: #f8f9fa !important; 
  color: #6c757d !important; 
  border: 1px solid #dee2e6 !important; 
  background-image: none !important; 
}
.student-status.weekend, .student-status-compact.weekend, .status-badge.weekend { 
  background: #e9ecef !important; 
  color: #495057 !important; 
  border: 1px solid #ced4da !important; 
  background-image: none !important; 
}
.student-status.low-efficiency, .student-status-compact.low-efficiency, .status-badge.low-efficiency { 
  background: #ffeaa7 !important; 
  color: #6c5ce7 !important; 
  border: 1px solid #fdcb6e !important; 
  background-image: none !important; 
}

/* ğŸ”¥ æµ…è‰²æ¨¡å¼ä¸‹å­¦ç”Ÿè¯¦æƒ…ä¸­å­¦ç”Ÿå§“åå¡ç‰‡ä¸ºæµ…ç°è‰² */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  .student-profile-card {
    background: #f8f9fa !important;
    background-image: none !important;
    color: #333 !important;
    border: 1px solid #e9ecef !important;
  }
  
  .profile-name {
    color: #333 !important;
  }
  
  .profile-details {
    color: #666 !important;
  }
}

@media (prefers-color-scheme: dark) {
  /* ç»Ÿä¸€çº¯è‰²ï¼ˆåŠé€æ˜ï¼‰ */
  .student-status.present, .student-status-compact.present, .status-badge.present, .table-status-badge.present { background: rgba(30,95,63,0.65) !important; background-image: none !important; }
  .student-status.absent, .student-status-compact.absent, .status-badge.absent, .table-status-badge.absent { background: rgba(122,31,31,0.6) !important; background-image: none !important; }
  .student-status.practicing-unscheduled, .student-status-compact.practicing-unscheduled, .status-badge.practicing-unscheduled, .table-status-badge.practicing-unscheduled { background: rgba(88,166,255,0.6) !important; background-image: none !important; }
  .student-status.excused, .student-status-compact.excused, .status-badge.excused, .table-status-badge.excused { background: rgba(139,95,34,0.55) !important; background-image: none !important; }
  .student-status.low-efficiency, .student-status-compact.low-efficiency, .status-badge.low-efficiency, .table-status-badge.low-efficiency { background: rgba(243,156,18,0.75) !important; background-image: none !important; }
  .student-status.pending, .student-status-compact.pending, .status-badge.pending, .table-status-badge.pending { background: rgba(108,117,125,0.55) !important; background-image: none !important; }
  .student-status.not-practicing, .student-status-compact.not-practicing, .status-badge.not-practicing, .table-status-badge.not-practicing { background: rgba(139,149,158,0.5) !important; background-image: none !important; }
  .student-status.weekend, .student-status-compact.weekend, .status-badge.weekend, .table-status-badge.weekend { background: rgba(139,149,158,0.5) !important; background-image: none !important; }
  .practice-duration, .practice-duration-large { background: rgba(155,89,182,0.55) !important; background-image: none !important; }
  
  /* ğŸ”¥ æ·±è‰²æ¨¡å¼ä¸‹æ‰€æœ‰çŠ¶æ€æ ‡ç­¾çš„æ–‡å­—é¢œè‰²ç»Ÿä¸€ä¸ºç™½è‰² */
  .student-status, .student-status-compact, .status-badge, .table-status-badge,
  .student-status.present, .student-status-compact.present, .status-badge.present, .table-status-badge.present,
  .student-status.absent, .student-status-compact.absent, .status-badge.absent, .table-status-badge.absent,
  .student-status.practicing-unscheduled, .student-status-compact.practicing-unscheduled, .status-badge.practicing-unscheduled, .table-status-badge.practicing-unscheduled,
  .student-status.excused, .student-status-compact.excused, .status-badge.excused, .table-status-badge.excused,
  .student-status.low-efficiency, .student-status-compact.low-efficiency, .status-badge.low-efficiency, .table-status-badge.low-efficiency,
  .student-status.pending, .student-status-compact.pending, .status-badge.pending, .table-status-badge.pending,
  .student-status.not-practicing, .student-status-compact.not-practicing, .status-badge.not-practicing, .table-status-badge.not-practicing,
  .student-status.weekend, .student-status-compact.weekend, .status-badge.weekend, .table-status-badge.weekend {
    color: #ffffff !important;
  }
  
  /* ç§»é™¤ä»»ä½•ç”± gradient å˜é‡å¸¦æ¥çš„èƒŒæ™¯ */
  .student-status[class*="present"], .status-badge[class*="present"], .table-status-badge[class*="present"] { box-shadow: none !important; }
  
  /* ğŸ”¥ ç‰¹åˆ«ç¡®ä¿è¡¨æ ¼ä¸­çš„ä½æ•ˆçŠ¶æ€ä¸ºæ©™è‰²çº¯è‰²èƒŒæ™¯ */
  .table-status-badge.low-efficiency {
    background: rgba(243,156,18,0.75) !important;
    background-image: none !important;
    color: #ffffff !important;
  }
  
  /* åŒæ—¶ç¡®ä¿æ‰€æœ‰å…¶ä»–ä½¿ç”¨ gradient-excused çš„ä½æ•ˆçŠ¶æ€å…ƒç´  */
  .status-badge.low-efficiency,
  .student-status.low-efficiency,
  .student-status-compact.low-efficiency {
    background: rgba(243,156,18,0.75) !important;
    background-image: none !important;
    color: #ffffff !important;
  }
  
  /* æœ€é«˜ä¼˜å…ˆçº§ï¼šç¡®ä¿è¡¨æ ¼çŠ¶æ€æ ‡ç­¾çš„æ©™è‰² */
  .data-table .table-status-badge.low-efficiency,
  .data-table-container .table-status-badge.low-efficiency,
  table .table-status-badge.low-efficiency,
  tbody .table-status-badge.low-efficiency {
    background: rgba(243,156,18,0.8) !important;
    background-image: none !important;
    background-color: rgba(243,156,18,0.8) !important;
    color: #ffffff !important;
  }
}

/* é¢å¤–ï¼šå¦‚æœä»æœ‰å†…è”æˆ–æ›´æ—©å®šä¹‰çš„æ¸å˜ï¼Œé€šè¿‡å±æ€§é€‰æ‹©å™¨å…œåº•å»é™¤ */
[class*="status"], [class*="student-status"], [class*="status-badge"] {
  background-repeat: no-repeat;
}

/* ğŸ”¥ å½“å‰æ—¶é—´æ˜¾ç¤ºï¼šçº¯æ–‡æœ¬æ ·å¼ï¼Œæ— èƒŒæ™¯æ— å®¹å™¨ */
.current-time-display {
  color: #666 !important;
  font-size: 14px !important;
  background: none !important;
  border: none !important;
  padding: 0 !important;
  margin: 0 !important;
  box-shadow: none !important;
}

/* æ·±è‰²æ¨¡å¼ä¸‹çš„å½“å‰æ—¶é—´ */
@media (prefers-color-scheme: dark) {
  .current-time-display {
    color: #aaa !important;
  }
}

/* ç¡®ä¿å½“å‰æ—¶é—´æ‰€åœ¨çš„date-pickerå®¹å™¨åœ¨ç§»åŠ¨ç«¯ä¸å½±å“æ—¶é—´æ˜¾ç¤º */
@media (max-width: 768px) {
  .date-picker {
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
  }
}

/* ğŸ”¥ ç»Ÿä¸€æœ€è¿‘ä¸ƒå¤©è€ƒå‹¤çš„æ–‡å­—æ ·å¼ï¼Œä¸ç»ƒç´æ˜ç»†ä¿æŒä¸€è‡´ */
.history-title {
  display: flex !important;
  align-items: center !important;
  gap: 8px !important;
  font-size: 1.2rem !important;
  font-weight: 600 !important;
  color: var(--text-color) !important;
  margin: 0 0 15px 0 !important;
}

/* ğŸ”¥ è€ƒå‹¤æ—¶æ®µæ ‡ç­¾å¢å¼ºæ˜¾ç¤ºæ•ˆæœ */
.time-slot-tag {
  background: #f8f9fa !important;
  color: #495057 !important;
  border: 1px solid #dee2e6 !important;
  padding: 4px 8px !important;
  margin: 2px 4px 2px 0 !important;
  border-radius: 4px !important;
  font-size: 0.85rem !important;
  font-weight: 500 !important;
  transition: all 0.2s ease !important;
}

.time-slot-tag:hover {
  background: #e9ecef !important;
  color: #212529 !important;
  border-color: #adb5bd !important;
}

/* ğŸ”¥ å½“å‰æ—¶é—´æ®µé«˜äº®å¢å¼º */
.time-slot-tag.current {
  background: linear-gradient(135deg, #cfe2ff, #b6d4fe) !important;
  color: #084298 !important;
  border: 1px solid #0d6efd !important;
  padding: 6px 12px !important;
  border-radius: 16px !important;
  font-weight: 600 !important;
  font-size: 0.9rem !important;
  box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2) !important;
}

/* ğŸ”¥ æ·±è‰²æ¨¡å¼ä¸‹çš„è€ƒå‹¤æ—¶æ®µå’Œç»ƒç´çŠ¶æ€ */
@media (prefers-color-scheme: dark) {
  .time-slot-tag {
    background: #343a40 !important;
    color: #adb5bd !important;
    border: 1px solid #495057 !important;
  }
  
  .time-slot-tag:hover {
    background: #495057 !important;
    color: #f8f9fa !important;
    border-color: #6c757d !important;
  }
  
  .time-slot-tag.current {
    background: linear-gradient(135deg, #1e3a5f, #2c5282) !important;
    color: #cfe2ff !important;
    border: 1px solid #4dabf7 !important;
    box-shadow: 0 2px 4px rgba(77, 171, 247, 0.3) !important;
  }
}
</style>

<!-- ğŸ”¥ å¼ºåˆ¶ä¿®å¤æ·±è‰²æ¨¡å¼ä½æ•ˆçŠ¶æ€æ ·å¼ -->
<style>
@media (prefers-color-scheme: dark) {
  .table-status-badge.low-efficiency {
    background: rgba(243,156,18,0.8) !important;
    background-color: rgba(243,156,18,0.8) !important;
    background-image: none !important;
    color: #ffffff !important;
  }
  
  /* å¢åŠ æ›´é«˜ç‰¹å¼‚æ€§çš„é€‰æ‹©å™¨ */
  .data-table .table-status-badge.low-efficiency,
  tbody .table-status-badge.low-efficiency,
  tr .table-status-badge.low-efficiency {
    background: rgba(243,156,18,0.8) !important;
    background-color: rgba(243,156,18,0.8) !important;
    background-image: none !important;
    color: #ffffff !important;
  }
}
</style>

<script>
// ğŸ”¥ å¼ºåˆ¶ä¿®å¤æ·±è‰²æ¨¡å¼ä¸‹çš„ä½æ•ˆçŠ¶æ€æ ·å¼
document.addEventListener('DOMContentLoaded', function() {
  function fixLowEfficiencyStyles() {
    console.log('æ‰§è¡Œä½æ•ˆçŠ¶æ€æ ·å¼ä¿®å¤...');
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºæ·±è‰²æ¨¡å¼
    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    console.log('å½“å‰æ˜¯å¦ä¸ºæ·±è‰²æ¨¡å¼:', isDarkMode);
    
    if (isDarkMode) {
      // æŸ¥æ‰¾æ‰€æœ‰ä½æ•ˆçŠ¶æ€çš„è¡¨æ ¼æ ‡ç­¾
      const lowEfficiencyBadges = document.querySelectorAll('.table-status-badge.low-efficiency');
      console.log('æ‰¾åˆ°ä½æ•ˆçŠ¶æ€æ ‡ç­¾æ•°é‡:', lowEfficiencyBadges.length);
      
      lowEfficiencyBadges.forEach((badge, index) => {
        console.log(`ä¿®å¤ç¬¬${index + 1}ä¸ªä½æ•ˆçŠ¶æ€æ ‡ç­¾:`, badge);
        badge.style.setProperty('background', 'rgba(243,156,18,0.8)', 'important');
        badge.style.setProperty('background-image', 'none', 'important');
        badge.style.setProperty('background-color', 'rgba(243,156,18,0.8)', 'important');
        badge.style.setProperty('color', '#ffffff', 'important');
        
        // éªŒè¯æ ·å¼æ˜¯å¦åº”ç”¨æˆåŠŸ
        const computedStyle = window.getComputedStyle(badge);
        console.log(`ç¬¬${index + 1}ä¸ªæ ‡ç­¾æœ€ç»ˆèƒŒæ™¯è‰²:`, computedStyle.backgroundColor);
      });
      
      // åŒæ—¶å¤„ç†å¯èƒ½çš„å…¶ä»–å‘½åæ–¹å¼
      const altBadges = document.querySelectorAll('.table-status-badge.low_efficiency');
      console.log('æ‰¾åˆ°å¤‡ç”¨å‘½åçš„ä½æ•ˆçŠ¶æ€æ ‡ç­¾æ•°é‡:', altBadges.length);
      
      altBadges.forEach((badge, index) => {
        console.log(`ä¿®å¤ç¬¬${index + 1}ä¸ªå¤‡ç”¨ä½æ•ˆçŠ¶æ€æ ‡ç­¾:`, badge);
        badge.style.setProperty('background', 'rgba(243,156,18,0.8)', 'important');
        badge.style.setProperty('background-image', 'none', 'important');
        badge.style.setProperty('background-color', 'rgba(243,156,18,0.8)', 'important');
        badge.style.setProperty('color', '#ffffff', 'important');
      });
    }
  }
  
  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹ä¿®å¤æ ·å¼...');
  fixLowEfficiencyStyles();
  
  // å»¶è¿Ÿå†æ‰§è¡Œä¸€æ¬¡ï¼Œç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½å·²æ¸²æŸ“
  setTimeout(() => {
    console.log('å»¶è¿Ÿæ‰§è¡Œæ ·å¼ä¿®å¤...');
    fixLowEfficiencyStyles();
  }, 500);
  
  // ç›‘å¬é¡µé¢å†…å®¹å˜åŒ–ï¼ˆå¦‚æœä½¿ç”¨åŠ¨æ€åŠ è½½ï¼‰
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¡¨æ ¼çŠ¶æ€æ ‡ç­¾
        const hasNewBadges = Array.from(mutation.addedNodes).some(node => 
          node.nodeType === 1 && (
            node.querySelector && node.querySelector('.table-status-badge') ||
            node.classList && node.classList.contains('table-status-badge')
          )
        );
        
        if (hasNewBadges) {
          console.log('æ£€æµ‹åˆ°æ–°çš„çŠ¶æ€æ ‡ç­¾ï¼Œé‡æ–°æ‰§è¡Œä¿®å¤...');
          setTimeout(fixLowEfficiencyStyles, 50);
        }
      }
    });
  });
  
  // å¼€å§‹è§‚å¯Ÿæ–‡æ¡£å˜åŒ–
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
  
  // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
  if (window.matchMedia) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function() {
      console.log('ç³»ç»Ÿä¸»é¢˜å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°æ‰§è¡Œä¿®å¤...');
      setTimeout(fixLowEfficiencyStyles, 100);
    });
  }
});
</script>