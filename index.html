<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>青岛梅纽因音乐学校练琴跟踪系统</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<style>
/* ===============================================
   青岛梅纽因音乐学校练琴跟踪系统 - 完整样式文件
   =============================================== */

/* ===== 1. CSS变量定义 ===== */
:root {
    /* 主色调 */
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --success-color: #27ae60;
    
    /* 背景和文本 */
    --background-color: #f8f9fa;
    --card-bg: #ffffff;
    --card-hover-bg: #f8f9fa;
    --text-color: #2c3e50;
    --text-secondary: #6c757d;
    --text-muted: #adb5bd;
    --border-color: #dee2e6;
    --light-gray: #f1f3f4;
    --medium-gray: #6c757d;
    --dark-gray: #495057;
    --shadow-color: rgba(0,0,0,0.1);
    
    /* 阴影和圆角 */
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-hover: 0 5px 20px rgba(0,0,0,0.15);
    --radius: 12px;
    --radius-small: 6px;
    --radius-large: 20px;
    
    /* 移动端适配 */
    --mobile-padding: 15px;
    --mobile-font-size: 16px;
    --touch-target-size: 44px;
    
    /* 渐变色 */
    --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    --gradient-card: linear-gradient(135deg, #f8f9fa, #ffffff);
}


/* ===== 2. 基础重置和全局样式 ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    overflow-x: hidden;
}

/* ===== 3. 容器和布局 ===== */
/* 确保两个 metric-item 容器大小一致 */
.status-metrics .metric-item {
    flex: 1;
    min-width: 0;
}

/* 或者给练琴状态容器添加相同的样式类 */
.metric-item.practice-status-container {
    /* 与时间段容器相同的样式 */
}

.container {
    width: 100%;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom);
    box-sizing: border-box;
}

/* 🔥 新增：确保实时练琴状态区域没有额外的内边距 */
.container .card {
    margin-left: 0;
    margin-right: 0;
}

/* 🔥 新增：确保学生网格从最左侧开始 */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(12px, 2vw, 20px);
    width: 100%;
    padding: 0;
    margin: 0; /* 确保没有外边距 */
    padding-left: 0 !important; /* 强制去除左内边距 */
}



/* 响应式容器 */
@media (min-width: 1500px) {
    .container {
        max-width: none;
        padding: 20px 40px;
    }
}

@media (min-width: 1800px) {
    .container {
        padding: 20px 60px;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 10px;
    }
}
/* ===== 练琴状态紧凑布局样式 - 四行显示 ===== */
/* ===== 确保时间段和练琴状态容器大小完全一致 ===== */
.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: stretch; /* 🔥 改为 stretch，让所有项目高度一致 */
}

.metric-item {
    display: flex;
    align-items: flex-start; /* 🔥 顶部对齐 */
    gap: 12px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    height: 100%; /* 🔥 新增：占满容器高度 */
    box-sizing: border-box; /* 🔥 新增：确保padding计算正确 */
}

.metric-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    height: 100%; /* 🔥 新增：占满父容器高度 */
}

.metric-label {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-bottom: 6px;
    color: var(--medium-gray);
    flex-shrink: 0; /* 🔥 新增：标签不收缩 */
}

.metric-value {
    flex: 1; /* 🔥 新增：内容区域占满剩余空间 */
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* 🔥 新增：内容从顶部开始 */
}

/* ===== 练琴状态紧凑布局样式优化 ===== */
.metric-value.practice-status-compact {
    line-height: 1.4; /* 🔥 从 1.3 增加到 1.4 */
    font-size: 15px; /* 🔥 从 14px 增加到 15px */
    min-height: 95px; /* 🔥 从 80px 增加到 95px，容纳更大间距 */
    padding: 4px 0; /* 🔥 新增：上下内边距 */
}

.practice-info-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px; /* 🔥 从 4px 增加到 8px，更宽的行间距 */
    min-height: 22px; /* 🔥 从 18px 增加到 22px，更高的行高 */
    justify-content: flex-start;
    padding: 2px 0; /* 🔥 新增：每行上下内边距 */
}

.practice-info-row:last-child {
    margin-bottom: 0;
}

.practice-info-item {
    display: flex;
    align-items: center;
    gap: 6px; /* 🔥 从 4px 增加到 6px */
}

.practice-label {
    color: #666;
    font-size: 13px; /* 🔥 从 12px 增加到 13px */
    font-weight: 500; /* 🔥 从 400 增加到 500，更清晰 */
    white-space: nowrap;
    min-width: 60px; /* 🔥 从 55px 增加到 60px */
}

.practice-value {
    font-weight: 600;
    font-size: 14px; /* 🔥 从 13px 增加到 14px */
    color: var(--text-color);
}

.practice-value.current-practice {
    color: #2196F3;
    font-size: 14px; /* 🔥 保持与其他值一致 */
}

.practice-value.total-practice {
    color: var(--primary-color);
    font-size: 15px; /* 🔥 从 13px 增加到 15px，突出显示 */
    font-weight: 700; /* 🔥 增加字重，更突出 */
}

/* ===== 时间段容器对齐优化 ===== */
.time-slots-container .metric-value {
    margin-top: 0;
    line-height: 1.4; /* 🔥 从 1.3 增加到 1.4 */
    min-height: 95px; /* 🔥 从 80px 增加到 95px，与练琴状态容器保持一致 */
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding: 4px 0; /* 🔥 新增：与练琴状态保持一致的内边距 */
}

.time-slots-wrapper {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    gap: 4px; /* 🔥 从 0 增加到 4px，增加时间段标签间距 */
    margin-top: 4px; /* 🔥 从 2px 增加到 4px */
    flex: 1;
}

/* 移动端优化 */
@media (max-width: 768px) {
    .status-metrics {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .metric-value.practice-status-compact {
        min-height: 85px; /* 🔥 从 70px 增加到 85px */
        font-size: 14px; /* 🔥 保持较大字体 */
        padding: 3px 0;
    }
    
    .time-slots-container .metric-value {
        min-height: 85px; /* 🔥 从 70px 增加到 85px */
        padding: 3px 0;
    }
    
    .practice-info-row {
        margin-bottom: 6px; /* 🔥 从 3px 增加到 6px */
        min-height: 20px; /* 🔥 从 16px 增加到 20px */
        padding: 1px 0;
    }
    
    .practice-label {
        font-size: 12px; /* 🔥 从 11px 增加到 12px */
        min-width: 55px; /* 🔥 从 50px 增加到 55px */
        font-weight: 500;
    }
    
    .practice-value {
        font-size: 13px; /* 🔥 从 12px 增加到 13px */
    }
    
    .practice-value.total-practice {
        font-size: 14px; /* 🔥 从 12px 增加到 14px */
        font-weight: 700;
    }
    
    .metric-item {
        padding: 12px;
    }
    
    .metric-label {
        margin-bottom: 4px;
    }
    
    .time-slots-wrapper {
        gap: 3px; /* 🔥 移动端时间段间距 */
        margin-top: 3px;
    }
}

@media (max-width: 480px) {
    .metric-value.practice-status-compact {
        min-height: 75px; /* 🔥 从 60px 增加到 75px */
        font-size: 13px; /* 🔥 保持可读性 */
        padding: 2px 0;
    }
    
    .time-slots-container .metric-value {
        min-height: 75px; /* 🔥 从 60px 增加到 75px */
        padding: 2px 0;
    }
    
    .practice-info-row {
        margin-bottom: 5px; /* 🔥 从 2px 增加到 5px */
        min-height: 18px; /* 🔥 从 14px 增加到 18px */
    }
    
    .practice-label {
        font-size: 11px; /* 🔥 从 10px 增加到 11px */
        min-width: 50px; /* 🔥 从 45px 增加到 50px */
        font-weight: 500;
    }
    
    .practice-value {
        font-size: 12px; /* 🔥 从 11px 增加到 12px */
    }
    
    .practice-value.total-practice {
        font-size: 13px; /* 🔥 从 11px 增加到 13px */
        font-weight: 700;
    }
    
    .metric-item {
        padding: 10px;
    }
    
    .time-slots-wrapper {
        gap: 2px;
        margin-top: 2px;
    }
}

/* 深色模式适配 */
@media (prefers-color-scheme: dark) {
    .practice-label {
        color: var(--medium-gray);
        font-weight: 500; /* 🔥 确保深色模式下也有足够字重 */
    }
    
    .practice-value {
        color: var(--text-color);
    }
    
    .practice-value.current-practice {
        color: #58a6ff;
    }
    
    .practice-value.total-practice {
        color: var(--primary-color);
        font-weight: 700; /* 🔥 确保深色模式下也保持粗体 */
    }
}

/* 🔥 新增：为了更好的视觉效果，可以添加一些微妙的样式 */
.practice-info-row {
    transition: all 0.2s ease; /* 🔥 平滑过渡效果 */
}

.practice-info-row:hover {
    transform: translateX(2px); /* 🔥 悬停时轻微移动 */
}

.practice-value.total-practice {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); /* 🔥 文字阴影，增强可读性 */
}

/* 🔥 为当前练习时长添加一些视觉强调 */
.practice-value.current-practice {
    position: relative;
}

.practice-value.current-practice::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #2196F3, rgba(33, 150, 243, 0.3));
    border-radius: 1px;
    animation: pulse-underline 2s infinite;
}

@keyframes pulse-underline {
    0%, 100% {
        opacity: 0.6;
        transform: scaleX(1);
    }
    50% {
        opacity: 1;
        transform: scaleX(1.05);
    }
}

/* ===== 4. 语言切换器 ===== */
.language-switcher {
    position: fixed;
    bottom: max(20px, env(safe-area-inset-bottom) + 10px);
    left: 20px;
    z-index: 1001;
    display: flex;
    background: white;
    border-radius: var(--radius-large);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.lang-btn {
    padding: 8px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 40px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lang-btn.active {
    background: var(--primary-color);
    color: white;
}

.lang-btn:hover:not(.active) {
    background: rgba(52, 152, 219, 0.1);
}

/* 移动端语言切换器 */
@media (max-width: 768px) {
    .language-switcher {
        bottom: max(10px, env(safe-area-inset-bottom) + 5px);
        left: 10px;
        border-radius: 16px;
    }
    
    .lang-btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 35px;
        height: 28px;
    }
}

/* ===== 5. 头部样式 ===== */
.header {
    background: var(--gradient-primary);
    color: white;
    padding: max(30px, env(safe-area-inset-top) + 20px) 20px 30px 20px;
    margin-bottom: 30px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
}

.header h1 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    margin-bottom: 10px;
    font-weight: 300;
    line-height: 1.2;
}

.header .subtitle {
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    opacity: 0.9;
    line-height: 1.3;
}

@media (max-width: 768px) {
    .header {
        padding: max(25px, env(safe-area-inset-top) + 15px) 15px 25px 15px;
        margin-bottom: 20px;
    }
}

/* ===== 6. 连接状态指示器 ===== */
.connection-status {
    position: fixed;
    top: max(20px, env(safe-area-inset-top) + 10px);
    right: 20px;
    padding: 8px 12px;
    border-radius: var(--radius-large);
    font-size: 13px;
    font-weight: 600;
    z-index: 1000;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.connection-status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--danger-color);
}

.connection-status.online::before {
    background: var(--success-color);
}

.connection-status.syncing::before {
    background: var(--warning-color);
    animation: pulse 1.5s infinite;
}

.connection-status.online {
    background: white;
    color: var(--success-color);
    border: 1px solid var(--success-color);
}

.connection-status.offline {
    background: white;
    color: var(--danger-color);
    border: 1px solid var(--danger-color);
}

.connection-status.syncing {
    background: white;
    color: var(--warning-color);
    border: 1px solid var(--warning-color);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@media (max-width: 768px) {
    .connection-status {
        top: max(15px, env(safe-area-inset-top) + 5px);
        right: 15px;
        padding: 6px 10px;
        font-size: 12px;
        min-height: 36px;
    }
}

/* ===== 7. 主导航标签 ===== */
.nav-tabs {
    display: flex;
    background: white;
    border-radius: var(--radius);
    padding: 5px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.nav-tabs::-webkit-scrollbar {
    display: none;
}

.nav-tab {
    flex: 1;
    padding: 12px 16px;
    text-align: center;
    background: transparent;
    border: none;
    border-radius: calc(var(--radius) - 5px);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: clamp(14px, 3vw, 16px);
    font-weight: 500;
    white-space: nowrap;
    min-width: 120px;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
}

.nav-tab:hover {
    background: rgba(52, 152, 219, 0.1);
}

.nav-tab.active {
    background: var(--primary-color);
    color: white;
}

@media (max-width: 768px) {
    .nav-tabs {
        margin-bottom: 20px;
        padding: 3px;
    }
    
    .nav-tab {
        padding: 10px 12px;
        font-size: 14px;
        min-width: 100px;
        min-height: 40px;
    }
}

/* ===== 8. 卡片容器基础样式 ===== */
.card {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.card.success {
    border-left-color: var(--success-color);
}

.card.warning {
    border-left-color: var(--warning-color);
}

.card.danger {
    border-left-color: var(--danger-color);
}

@media (max-width: 768px) {
    .card {
        padding: 20px 15px;
        margin-bottom: 20px;
    }
}

/* ===== 9. 统计面板 ===== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.stat-card:hover::before {
    left: 100%;
}

.stat-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 10px;
    line-height: 1;
}

.stat-label {
    font-size: 1.1rem;
    color: var(--medium-gray);
    margin-bottom: 5px;
    font-weight: 600;
}

.stat-description {
    font-size: 0.9rem;
    color: #999;
    line-height: 1.3;
}

/* 统计卡片颜色主题 */
.stat-card.present .stat-number { color: var(--success-color); }
.stat-card.absent .stat-number { color: var(--danger-color); }
.stat-card.excused .stat-number { color: var(--warning-color); }
.stat-card.unscheduled .stat-number { color: #9b59b6; }
.stat-card.weekend .stat-number { color: #95a5a6; }
.stat-card.pending .stat-number { color: #6c757d; }


@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        padding: 20px 15px;
    }
    
    .stat-number {
        font-size: 2.2rem;
    }
    
    .stat-label {
        font-size: 1rem;
    }
    
    .stat-description {
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        gap: 8px;
    }
    
    .stat-card {
        padding: 15px 10px;
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
}

/* ===== 10. 学生网格布局系统 ===== */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(12px, 2vw, 20px);
    width: 100%;
    padding: 0;
}

/* 限制最大列数为4列 */
@media (min-width: 1400px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
        margin: 0 auto;
        gap: 24px;
    }
}

/* 不同屏幕宽度的响应式设置 */
@media (max-width: 1399px) and (min-width: 1100px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }
}

@media (max-width: 1099px) and (min-width: 800px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
}

@media (max-width: 799px) {
    .student-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

/* 小屏幕优化 */
@media (max-width: 599px) {
    .student-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (max-width: 360px) {
    .student-grid {
        gap: 8px;
    }
}

/* 大屏幕优化 */
@media (min-width: 1600px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
        gap: 24px;
    }
}


/* ===== 11. 学生卡片和练琴状态卡片 ===== */
.student-card,
.practice-status-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    border-left: 4px solid var(--border-color);
    cursor: pointer;
    width: 100%;
    max-width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    height: auto;
    min-height: 280px;
    box-sizing: border-box;
    justify-self: stretch;
    align-self: stretch;
    color: var(--text-color);
}

.student-card:hover,
.practice-status-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
    background: var(--card-hover-bg);
}

.practice-status-card.compact {
    min-height: 120px;
    padding: 10px 12px;
    margin-bottom: 8px;
}
/* 待考勤状态样式 */
.student-status.pending,
.student-status-compact.pending,
.table-status-badge.pending,
.status-badge.pending {
    background: #e9ecef;
    color: #6c757d;
    border-color: #dee2e6;
}
.table-status-badge.low_efficiency { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.practice-status-card.pending,
.student-card.pending {
    border-left-color: #6c757d;
}

/* 待考勤状态的卡片 */
.practice-status-card.pending,
.student-card.pending {
    background: var(--card-bg);
    border-left-color: var(--medium-gray);
}


.compact-content {
    display: flex;
    flex-direction: column;
    gap: 4px;                     /* 从6px改为4px */
    flex: 1;
}


.student-name-compact {
    font-size: 1.2rem;              /* 🔥 从1rem增加到1.2rem */
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 2px;
}



.student-info-row {
    display: flex;
    align-items: center;
    gap: 6px;                     /* 从8px改为6px */
    font-size: 0.75rem;           /* 从0.8rem改为0.75rem */
    color: var(--medium-gray);
    flex-wrap: wrap;
}


.info-item {
    display: flex;
    align-items: center;
    gap: 2px;
}

.info-divider {
    opacity: 0.6;
    margin: 0 2px;
}

.status-duration-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
    gap: 10px;
}

.practice-duration-large {
    font-size: 1rem;              /* 从1.1rem改为1rem */
    font-weight: 600;
    color: var(--primary-color);
    background: rgba(52, 152, 219, 0.1);
    padding: 3px 6px;             /* 从4px 8px改为3px 6px */
    border-radius: var(--radius-small);
}



/* 移动端卡片优化 */
@media (max-width: 768px) {
    .student-card,
    .practice-status-card {
        min-height: 140px;
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .practice-status-card.compact {
        min-height: 120px;
        padding: 10px;
    }
    
    .student-name-compact {
        font-size: 1rem;
    }
    
    .student-info-row {
        font-size: 0.75rem;
        gap: 6px;
    }
    
    .practice-duration-large {
        font-size: 1rem;
        padding: 3px 6px;
    }
}

@media (max-width: 480px) {
    .student-card,
    .practice-status-card {
        min-height: 120px;
        padding: 8px;
    }
    
    .practice-status-card.compact {
        min-height: 100px;
        padding: 8px;
    }
    
    .student-name-compact {
        font-size: 0.95rem;
    }
    
    .student-info-row {
        font-size: 0.7rem;
        gap: 4px;
    }
    
    .practice-duration-large {
        font-size: 0.9rem;
        padding: 2px 4px;
    }
}

/* ===== 12. 卡片边框颜色 ===== */
.practice-status-card { 
    border-left-color: #9b59b6; 
    background: white;
}

.student-card.weekend,
.practice-status-card.weekend { 
    border-left-color: #95a5a6; 
    background: var(--gradient-card);
}

.practice-status-card.present,
.student-card.present { 
    border-left-color: var(--success-color); 
}

.practice-status-card.absent,
.student-card.absent { 
    border-left-color: var(--danger-color); 
}

.practice-status-card.excused,
.student-card.excused { 
    border-left-color: var(--warning-color); 
}

.practice-status-card.low-efficiency,
.student-card.low-efficiency { 
    border-left-color: #f39c12; 
}

.practice-status-card.practicing-unscheduled,
.student-card.practicing-unscheduled { 
    border-left-color: #9b59b6; 
}

/* ===== 13. 卡片内容样式 ===== */
.student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.student-name {
    font-size: 1.5rem;              /* 🔥 从1.3rem增加到1.5rem */
    font-weight: 600;
    color: var(--text-color);
    line-height: 1.2;
}



.student-details,
.practice-details {
    width: 100%;
    margin-bottom: 15px;
}

/* 在更大屏幕上使用两列，但学生区域仍然全宽 */
@media (min-width: 1200px) {
    .student-details,
    .practice-details {
        grid-template-columns: 1fr 1fr;
    }
    
    /* 学生卡片区域跨越两列 */
    .student-grid,
    .department-section,
    .room-section {
        grid-column: 1 / -1;
    }
}


.detail-item {
    display: flex;
    flex-direction: column;
    padding: 4px 0;
}

.detail-label {
    font-size: 0.75rem;
    color: var(--medium-gray);
    margin-bottom: 2px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-color);
    line-height: 1.3;
}

/* 状态标签样式 */
.student-status,
.student-status-compact,
.practice-duration {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    white-space: nowrap;
    text-align: center;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    transition: all 0.15s ease-in-out;
}

/* 学生状态颜色 */
.student-status.present,
.student-status-compact.present { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb;
}

.student-status.absent,
.student-status-compact.absent { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}

.student-status.excused,
.student-status-compact.excused { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.student-status.low-efficiency,
.student-status-compact.low-efficiency { 
    background: #ffeaa7; 
    color: #b06000; 
    border-color: #ffdc7a;
}

.student-status.practicing-unscheduled,
.student-status-compact.practicing-unscheduled { 
    background: #e8d5f2; 
    color: #6a1b9a; 
    border-color: #dcc7e8;
}

.student-status.weekend,
.student-status-compact.weekend { 
    background: #ecf0f1; 
    color: #2c3e50; 
    border-color: #d5dbdb;
}

/* 练琴时长标签颜色 */
.practice-duration {
    background: #e8d5f2;
    color: #6a1b9a;
    border-color: #dcc7e8;
}

@media (max-width: 768px) {
    .student-header {
        margin-bottom: 8px;
    }
    
    .student-name {
        font-size: 1.3rem;
    }
    
    .student-details,
    .practice-details {
        grid-template-columns: 1fr;
        gap: 6px;
        margin-bottom: 10px;
    }
    
    .detail-label {
        font-size: 0.7rem;
    }
    
    .detail-value {
        font-size: 0.8rem;
    }
    
    .student-status,
    .student-status-compact,
    .practice-duration {
        padding: 3px 8px;
        font-size: 0.7rem;
        border-radius: 12px;
    }
}

/* ===== 14. 实时练琴指示器 ===== */
.practice-indicator {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    background: var(--success-color);
    border-radius: 50%;
    animation: pulse 2s infinite;
    box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
}

.practice-status-card.compact .practice-indicator {
    top: 12px;
    right: 12px;
    width: 10px;
    height: 10px;
}

@keyframes pulse {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
    }
    
    70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(39, 174, 96, 0);
    }
    
    100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0);
    }
}

@media (max-width: 768px) {
    .practice-indicator {
        width: 8px;
        height: 8px;
        top: 10px;
        right: 10px;
    }
    
    .practice-status-card.compact .practice-indicator {
        width: 6px;
        height: 6px;
        top: 8px;
        right: 8px;
    }
}

/* ===== 15. 考勤历史时间轴 ===== */
.attendance-history {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.history-title {
    font-size: 0.9rem;
    color: var(--medium-gray);
    margin-bottom: 10px;
    font-weight: 500;
}

.history-timeline {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px 0;
    justify-content: center;
}

.history-timeline-container {
    padding: 15px 0;
}

.history-day {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    border: 2px solid transparent;
}

.history-day:hover {
    transform: scale(1.15);
    z-index: 1;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.history-day.present { 
    background: var(--success-color); 
    color: white; 
    border-color: var(--success-color);
}

.history-day.absent { 
    background: var(--danger-color); 
    color: white; 
    border-color: var(--danger-color);
}

.history-day.excused { 
    background: var(--warning-color); 
    color: white; 
    border-color: var(--warning-color);
}

.history-day.no-data { 
    background: var(--light-gray); 
    color: var(--medium-gray); 
    border-color: var(--border-color);
}

.history-day.low-efficiency {
    background: #f39c12;
    border-color: #f39c12;
    color: white;
}

.history-day.practicing-unscheduled {
    background: #9b59b6;
    border-color: #9b59b6;
    color: white;
}

.history-day.weekend {
    background: #95a5a6;
    border-color: #95a5a6;
    color: white;
}

/* 移动端考勤历史优化 */
@media (max-width: 768px) {
    .attendance-history {
        margin-top: 10px;
        padding-top: 10px;
    }
    
    .history-timeline {
        gap: 6px;
    }
    
    .history-day {
        width: 35px;
        height: 35px;
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .history-timeline {
        gap: 4px;
    }
    
    .history-day {
        width: 30px;
        height: 30px;
        font-size: 0.75rem;
    }
}

/* ===== 16. 空状态样式 ===== */
.practice-empty-state,
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--medium-gray);
}

.practice-empty-state-icon,
.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.practice-empty-state-title,
.empty-state-title {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--text-color);
    font-weight: 600;
}

.practice-empty-state-description,
.empty-state-description {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--medium-gray);
}

.empty-state {
    padding: 60px 20px;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.empty-state-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
}

.empty-state-description {
    font-size: 1rem;
    line-height: 1.6;
}

/* 移动端空状态优化 */
@media (max-width: 768px) {
    .empty-state {
        padding: 40px 15px;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .empty-state-title {
        font-size: 1.2rem;
        margin-bottom: 8px;
    }
    
    .empty-state-description {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .practice-empty-state {
        padding: 30px 15px;
    }
    
    .practice-empty-state-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
    }
    
    .practice-empty-state-title {
        font-size: 1.1rem;
        margin-bottom: 6px;
    }
    
    .practice-empty-state-description {
        font-size: 0.85rem;
    }
}

/* ===== 17. 筛选器样式 ===== */
.filters,
.practice-filters {
    background: white;
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 25px;
    box-shadow: var(--shadow);
}

.filter-row,
.practice-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
}

.practice-filter-row {
    gap: 12px;
}

.filter-group,
.practice-filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
    flex: 1;
}

.practice-filter-group {
    min-width: 120px;
}

.filter-label,
.practice-filter-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    margin-bottom: 5px;
    font-weight: 500;
}

.practice-filter-label {
    font-size: 0.85rem;
    margin-bottom: 4px;
}

.filter-select, 
.filter-input,
.practice-filter-select,
.practice-filter-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-small);
    font-size: 14px;
    transition: all 0.3s ease;
    background: white;
    color: var(--text-color);
}

.practice-filter-select,
.practice-filter-input {
    padding: 8px 10px;
}

.filter-select:focus, 
.filter-input:focus,
.practice-filter-select:focus,
.practice-filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

.filter-select:hover,
.filter-input:hover,
.practice-filter-select:hover,
.practice-filter-input:hover {
    border-color: var(--primary-color);
}

/* 快速筛选标签 */
.quick-filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
    justify-content: flex-start;
}

.quick-filter-tag {
    padding: 8px 16px;           /* 统一内边距 */
    font-size: 14px;             /* 统一字体大小 */
    font-weight: 500;            /* 统一字重 */
    border-radius: 20px;         /* 统一圆角 */
    height: 36px;                /* 统一高度 */
    display: inline-flex;        /* 统一对齐方式 */
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    background: var(--light-gray);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    min-width: auto;
}

.quick-filter-tag:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.quick-filter-tag.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}


/* 移动端筛选器优化 */
@media (max-width: 768px) {
    .filters {
        padding: 15px;
        margin: 0 -5px 20px -5px;
    }
    
    .practice-filters {
        padding: 12px;
        margin: 0 -5px 15px -5px;
    }
    
    .filter-row,
    .practice-filter-row {
        flex-direction: column;
        gap: 12px;
    }
    
    .practice-filter-row {
        gap: 10px;
    }
    
    .filter-group,
    .practice-filter-group {
        min-width: auto;
        width: 100%;
    }
    
    .filter-select,
    .filter-input,
    .practice-filter-select,
    .practice-filter-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }
    
    .practice-filter-select,
    .practice-filter-input {
        padding: 10px 12px;
    }
    
    .filter-select:focus,
    .filter-input:focus,
    .practice-filter-select:focus,
    .practice-filter-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .quick-filter-tags {
        justify-content: center;
        margin-top: 12px;
    }
    
    .quick-filter-tag {
        padding: 6px 12px;
        font-size: 13px;
        height: 32px;
    }
}

/* 筛选器内的学生网格样式调整 */
.practice-filters .student-grid {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

/* 移动端优化 */
@media (max-width: 768px) {
    .practice-filters .student-grid {
        margin-top: 15px;
        padding-top: 15px;
    }
}


/* ===== 18. 操作按钮样式 ===== */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: var(--mobile-font-size);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: var(--touch-target-size);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    -webkit-appearance: none;
    text-decoration: none;
    line-height: 1;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.btn:active {
    transform: scale(0.95);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* 按钮颜色变体 */
.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-warning {
    background: var(--warning-color);
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-secondary {
    background: var(--medium-gray);
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-outline {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

/* 导出选项 */
.export-options {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

/* 移动端按钮优化 */
@media (max-width: 768px) {
    .action-buttons {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 15px;
        margin: 20px -15px -15px -15px;
        border-top: 1px solid #eee;
        z-index: 10;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .export-options {
        flex-direction: column;
        gap: 8px;
        margin-top: 15px;
    }
    
    .export-options .btn {
        width: 100%;
    }
    
    .btn {
        padding: 14px 20px;
        font-size: 16px;
        border-radius: 10px;
    }
}

/* ===== 19. 模态框样式优化（移动端流畅动画） ===== */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
    opacity: 1;
}

.modal.hiding {
    opacity: 0;
}

.modal-content {
    background: white;
    border-radius: var(--radius-large);
    padding: 25px;
    max-width: min(800px, 95vw);
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 20px 50px rgba(0,0,0,0.35);
    transform: scale(0.9) translateY(20px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.modal.show .modal-content {
    transform: scale(1) translateY(0);
    opacity: 1;
}

.modal.hiding .modal-content {
    transform: scale(0.95) translateY(10px);
    opacity: 0;
}

/* 🔥 移动端专用流畅动画 */
@media (max-width: 768px) {
    .modal {
        padding: 0;
        align-items: flex-end;
        transition: opacity 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    .modal-content {
        width: 100%;
        max-width: 100%;
        max-height: 90vh;
        border-radius: var(--radius-large) var(--radius-large) 0 0;
        margin: 0;
        /* 🔥 移动端滑入动画 */
        transform: translateY(100%);
        opacity: 1;
        transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        will-change: transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
    }
    
    .modal.show .modal-content {
        transform: translateY(0);
    }
    
    .modal.hiding .modal-content {
        transform: translateY(100%);
    }
    
    /* 🔥 添加弹性回弹效果 */
    .modal.show .modal-content {
        animation: slideUpBounce 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    
    .modal.hiding .modal-content {
        animation: slideDownSmooth 0.3s cubic-bezier(0.55, 0.06, 0.68, 0.19) forwards;
    }
}

/* 🔥 移动端动画关键帧 */
@keyframes slideUpBounce {
    0% {
        transform: translateY(100%);
    }
    70% {
        transform: translateY(-2%);
    }
    100% {
        transform: translateY(0);
    }
}

@keyframes slideDownSmooth {
    0% {
        transform: translateY(0);
    }
    100% {
        transform: translateY(100%);
    }
}

/* 🔥 超小屏幕优化 */
@media (max-width: 480px) {
    .modal-content {
        border-radius: 16px 16px 0 0;
        max-height: 92vh;
    }
    
    .modal.show .modal-content {
        animation: slideUpBounceSmall 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
}

@keyframes slideUpBounceSmall {
    0% {
        transform: translateY(100%);
    }
    80% {
        transform: translateY(-1%);
    }
    100% {
        transform: translateY(0);
    }
}

/* 🔥 添加触摸反馈 */
@media (max-width: 768px) {
    .modal-close {
        transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        transform: scale(1);
    }
    
    .modal-close:active {
        transform: scale(0.9);
        background: var(--danger-color);
        color: #fff;
    }
}


/* 深色模式适配保持 */
@media (prefers-color-scheme: dark) {
    .modal-content {
        background: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    }
    
    .modal-close {
        background: var(--card-hover-bg);
        color: var(--medium-gray);
    }
    
    .modal-close:hover {
        background: var(--danger-color);
        color: #0d1117;
    }
}

/* ===== 20. 表格样式 ===== */
.data-table,
.detail-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    font-size: 0.9rem;
}

.detail-table {
    margin: 0;
}

.data-table th,
.data-table td,
.detail-table th,
.detail-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    min-width: 80px;
    vertical-align: middle;
}

.data-table th,
.detail-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
}

.detail-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.data-table tr:hover,
.detail-table tr:hover {
    background: var(--light-gray);
}

.detail-table tr:last-child td {
    border-bottom: none;
}

/* 表格容器 */
.data-table-container,
.table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-radius: var(--radius);
}

.history-table-card .table-container {
    max-height: 300px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

/* 表格单元格样式 */
.date-cell {
    font-weight: 500;
    color: var(--dark-gray);
    min-width: 100px;
}

.table-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    display: inline-block;
    border: 1px solid transparent;
}

.table-status-badge.present { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb;
}

.table-status-badge.absent { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}

.table-status-badge.excused { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.table-status-badge.low-efficiency { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.table-status-badge.practicing-unscheduled { 
    background: #e8d5f2; 
    color: #6a1b9a; 
    border-color: #dcc7e8;
}

.table-status-badge.weekend { 
    background: #ecf0f1; 
    color: #2c3e50; 
    border-color: #d5dbdb;
}

.table-status-badge.no-data { 
    background: var(--light-gray); 
    color: var(--medium-gray); 
    border-color: var(--border-color);
}

.duration-cell {
    color: var(--medium-gray);
    font-weight: 500;
    text-align: right;
    min-width: 80px;
}

.total-duration-cell {
    font-weight: 600;
    color: var(--primary-color);
    text-align: right;
    min-width: 90px;
}

/* 表格滚动提示 */
.table-scroll-hint {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 5;
}

.table-container:hover .table-scroll-hint {
    opacity: 1;
}

/* 表格空状态 */
.table-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--medium-gray);
}

.table-empty-state-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    opacity: 0.5;
}

.table-empty-state-title {
    font-size: 1rem;
    margin-bottom: 5px;
    color: var(--text-color);
    font-weight: 600;
}

.table-empty-state-description {
    font-size: 0.85rem;
    line-height: 1.4;
}

/* 移动端表格优化 */
@media (max-width: 768px) {
    .data-table-container {
        margin: 0 -20px;
        padding: 0 20px;
    }
    
    .data-table {
        min-width: 600px;
    }
    
    .data-table th,
    .data-table td {
        padding: 10px 8px;
        font-size: 13px;
    }
    
    .history-table-card .table-container {
        max-height: 250px;
        margin: 0 -10px;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    .detail-table {
        font-size: 0.8rem;
        min-width: 500px;
    }
    
    .detail-table th,
    .detail-table td {
        padding: 8px 10px;
    }
    
    .detail-table th {
        font-size: 0.75rem;
        background: var(--light-gray);
    }
    
    .history-table-card .table-container::-webkit-scrollbar {
        width: 3px;
        height: 3px;
    }
}

@media (max-width: 480px) {
    .history-table-card .table-container {
        max-height: 200px;
    }
    
    .detail-table {
        font-size: 0.75rem;
        min-width: 450px;
    }
    
    .detail-table th,
    .detail-table td {
        padding: 6px 8px;
    }
}
/* 今日行样式 */
.today-row {
    background: #f0f8ff;
}

/* 深色模式下的今日行 */
@media (prefers-color-scheme: dark) {
    .today-row {
        background: rgba(88, 166, 255, 0.15) !important;
    }
    
    .today-row .date-cell {
        color: var(--text-color);
    }
    
    .today-row .date-cell small {
        color: var(--primary-color) !important;
    }
}


/* ===== 21. 加载动画 ===== */
.loading {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--light-gray);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 15px;
    color: var(--medium-gray);
    font-size: 0.9rem;
}

/* 移动端加载动画优化 */
@media (max-width: 768px) {
    .loading {
        padding: 30px 20px;
    }
    
    .spinner {
        width: 35px;
        height: 35px;
        border-width: 3px;
    }
    
    .loading-text {
        margin-top: 12px;
        font-size: 0.85rem;
    }
}

/* ===== 22. 日期选择器样式 ===== */
.date-picker {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.date-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-small);
    font-size: 14px;
    color: var(--text-color);
    background: white;
    transition: all 0.3s ease;
}

.date-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

/* 移动端日期选择器优化 */
@media (max-width: 768px) {
    .date-picker {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 15px;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-bottom: 20px;
    }
    
    .date-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
    }
    
    .date-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}
/* ===== 学生详情模态框表格滚动修复 ===== */
#studentDetailModal .data-table-container {
    max-height: 230px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    /* 🔥 修复：确保表格容器居中且不超出边界 */
    width: 100%;
    box-sizing: border-box;
    margin: 0 auto; /* 🔥 居中显示 */
    padding: 0;
}

/* 🔥 移动端优化 - 修复边距问题 */
@media (max-width: 768px) {
    #studentDetailModal .data-table-container {
        max-height: 200px;
        margin: 0; /* 🔥 修复：移除负边距，避免超出边界 */
        border-radius: 8px; /* 🔥 保持圆角 */
        border: 1px solid #e9ecef; /* 🔥 保持边框 */
    }
    
    #studentDetailModal .modal-content {
        padding: 20px; /* 🔥 确保模态框有足够内边距 */
    }
}

@media (max-width: 480px) {
    #studentDetailModal .data-table-container {
        max-height: 180px;
        margin: 0; /* 🔥 修复：超小屏幕也移除负边距 */
    }
    
    #studentDetailModal .modal-content {
        padding: 15px; /* 🔥 超小屏幕减少内边距 */
    }
}

/* ===== 23. 学生详情页面特殊样式 ===== */
.student-detail-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 800px;
    margin: 0 auto;
}

/* 学生档案卡片 */
.student-profile-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: var(--radius-large);
    text-align: center;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.profile-info {
    width: 100%;
}

.profile-name {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 15px 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    line-height: 1.1;
}

.profile-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-size: 1.1rem;
    opacity: 0.9;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.meta-icon {
    font-size: 1rem;
}

.meta-divider {
    opacity: 0.6;
    margin: 0 4px;
    font-size: 1.2rem;
}

/* 今日状态卡片 */
.today-status-card {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border-left: 5px solid var(--primary-color);
}

.today-status-card.present { border-left-color: var(--success-color); }
.today-status-card.absent { border-left-color: var(--danger-color); }
.today-status-card.excused { border-left-color: var(--warning-color); }
.today-status-card.low-efficiency { border-left-color: #f39c12; }
.today-status-card.practicing-unscheduled { border-left-color: #9b59b6; }
.today-status-card.weekend { border-left-color: #95a5a6; }

.status-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.status-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.status-badge {
    padding: 8px 16px;
    border-radius: var(--radius-large);
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid transparent;
}

.status-badge.present { background: #d4edda; color: #155724; border-color: #c3e6cb; }
.status-badge.absent { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
.status-badge.excused { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
.status-badge.low-efficiency { background: #ffeaa7; color: #b06000; border-color: #ffdc7a; }
.status-badge.practicing-unscheduled { background: #e8d5f2; color: #6a1b9a; border-color: #dcc7e8; }
.status-badge.weekend { background: #ecf0f1; color: #2c3e50; border-color: #d5dbdb; }

.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.metric-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
}

.metric-item:hover {
    transform: translateY(-2px);
}

.metric-icon {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
}

.metric-content {
    flex: 1;
}

.metric-label {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-bottom: 2px;
    color: var(--medium-gray);
}

.metric-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-color);
}
/* 请假信息 */
.excuse-info {
    margin-top: 20px;
    padding: 16px;
    background: rgba(243, 156, 18, 0.1);
    border-radius: var(--radius);
    border-left: 4px solid #f39c12;
}

.excuse-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.excuse-icon {
    font-size: 1.2rem;
}

.excuse-title {
    font-weight: 600;
    color: #b06000;
}

.excuse-content {
    padding-left: 28px;
}

.excuse-reason {
    margin: 0 0 4px 0;
    color: #856404;
    font-weight: 500;
}

.excuse-approver {
    margin: 0;
    font-size: 0.9rem;
    color: #6c5700;
}

/* 通用卡片样式 */
.card-header {
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--light-gray);
}

.card-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.title-icon {
    font-size: 1.3rem;
}

.title-subtitle {
    font-size: 0.85rem;
    font-weight: 400;
    color: var(--medium-gray);
    margin-left: 4px;
}

/* 统计网格详细版 */
.stats-grid-detailed {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    max-width: 100%;
}

.stats-grid-detailed .stat-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px;
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    min-height: 80px;
}

.stats-grid-detailed .stat-item:hover {
    transform: translateY(-3px);
}

.stats-grid-detailed .stat-item.present { 
    background: linear-gradient(135deg, #d4edda, #c3e6cb); 
}

.stats-grid-detailed .stat-item.absent { 
    background: linear-gradient(135deg, #f8d7da, #f5c6cb); 
}

.stats-grid-detailed .stat-item.excused { 
    background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
}

.stats-grid-detailed .stat-item.rate { 
    background: linear-gradient(135deg, #cce7ff, #b3d9ff); 
}

.stats-grid-detailed .stat-icon {
    font-size: 1.5rem;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 50%;
    flex-shrink: 0;
}

.stats-grid-detailed .stat-content {
    flex: 1;
    min-width: 0;
}

.stats-grid-detailed .stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
    color: var(--text-color);
}

.stats-grid-detailed .stat-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    font-weight: 500;
    line-height: 1.2;
}

/* 移动端学生详情页面优化 */
@media (max-width: 768px) {
    .student-detail-content {
        gap: 16px;
    }
    
    .student-profile-card {
        padding: 25px 20px;
    }
    
    .profile-name {
        font-size: 2rem;
    }
    
    .profile-meta {
        font-size: 1rem;
        gap: 10px;
    }
    
    .status-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .status-metrics {
        grid-template-columns: 1fr;
    }
    
    .stats-grid-detailed {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 16px;
        min-height: 70px;
    }
    
    .stats-grid-detailed .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1.3rem;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.5rem;
    }
    
    .stats-grid-detailed .stat-label {
        font-size: 0.85rem;
    }
}

@media (max-width: 480px) {
    .student-detail-content {
        gap: 16px;
    }
    
    .card {
        padding: 20px 16px;
    }
    
    .profile-name {
        font-size: 1.8rem;
    }
    
    .profile-meta {
        font-size: 0.9rem;
        gap: 8px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 14px;
        min-height: 60px;
        gap: 10px;
    }
    
    .stats-grid-detailed .stat-icon {
        width: 35px;
        height: 35px;
        font-size: 1.2rem;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.3rem;
    }
    
    .stats-grid-detailed .stat-label {
        font-size: 0.8rem;
    }
}

/* 中等屏幕统计网格优化 */
@media (min-width: 769px) and (max-width: 1024px) {
    .stats-grid-detailed {
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 18px;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.6rem;
    }
}

/* 大屏幕统计网格优化 */
@media (min-width: 1200px) {
    .stats-grid-detailed {
        max-width: 600px;
        margin: 0 auto;
    }
}

/* ===== 24. 加载更多提示 ===== */
.load-more-hint {
    text-align: center;
    padding: 15px;
    color: var(--medium-gray);
    font-size: 0.85rem;
    border-top: 1px solid #eee;
    background: var(--light-gray);
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.load-more-hint:hover {
    background: #e9ecef;
}

.load-more-hint.loading {
    color: var(--primary-color);
    cursor: not-allowed;
}

/* ===== 25. 触摸优化 ===== */
.student-card, 
.practice-status-card, 
.stat-card, 
.btn, 
.nav-tab,
.quick-filter-tag,
.history-day {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
    tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.student-card:active, 
.practice-status-card:active, 
.stat-card:active {
    transform: scale(0.98);
}

.btn:active {
    transform: scale(0.95);
}

.quick-filter-tag:active,
.history-day:active {
    transform: scale(0.95);
}

/* ===== 26. iOS安全区域适配 ===== */
@supports (padding: max(0px)) {
    .container {
        padding-left: max(20px, env(safe-area-inset-left));
        padding-right: max(20px, env(safe-area-inset-right));
    }
    
    @media (max-width: 768px) {
        .container {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }
    }
}

/* ===== 27. 横屏模式优化 ===== */
@media (max-width: 768px) and (orientation: landscape) {
    .header {
        padding: max(15px, env(safe-area-inset-top) + 10px) 20px 15px 20px;
    }
    
    .header h1 {
        font-size: 1.8rem;
        margin-bottom: 5px;
    }
    
    .header .subtitle {
        font-size: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .modal-content {
        max-height: 80vh;
    }
    
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* ===== 28. iOS Safari 特殊优化 ===== */
@supports (-webkit-touch-callout: none) {
    .nav-tabs {
        -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
        -webkit-overflow-scrolling: touch;
    }
    
    input, select, textarea {
        -webkit-appearance: none;
        border-radius: 8px;
    }
    
    .btn {
        -webkit-appearance: none;
    }
}

/* ===== 29. 滚动条样式 ===== */
* {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

*::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

*::-webkit-scrollbar-track {
    background: transparent;
}

*::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

*::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0, 0, 0, 0.4);
}

/* 移动端滚动条 */
@media (max-width: 768px) {
    *::-webkit-scrollbar {
        width: 3px;
        height: 3px;
    }
}

/* ===== 30. 可访问性优化 ===== */
.student-card:focus,
.practice-status-card:focus,
.btn:focus,
.nav-tab:focus,
.quick-filter-tag:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

button:focus,
input:focus,
select:focus,
textarea:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 1px;
}

/* 高对比度模式支持 */
@media (prefers-contrast: high) {
    :root {
        --border-color: #000;
        --text-color: #000;
        --background-color: #fff;
    }
    
    .card {
        border: 2px solid #000;
    }
    
    .btn {
        border: 2px solid currentColor;
    }
}

/* 减少动画偏好 */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .practice-indicator {
        animation: none;
    }
    
    .spinner {
        animation: none;
    }
}

/* ===== 31. 打印样式优化 ===== */
@media print {
    .language-switcher,
    .connection-status,
    .nav-tabs,
    .action-buttons,
    .btn,
    .modal,
    .practice-indicator {
        display: none !important;
    }
    
    .container {
        max-width: none;
        padding: 0;
    }
    
    .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
        margin-bottom: 15px;
    }
    
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .student-card,
    .practice-status-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .header {
        background: none !important;
        color: #000 !important;
        box-shadow: none;
    }
    
    body {
        background: white !important;
        color: black !important;
    }
}

/* ===== 32. 统一的状态颜色系统 ===== */
.present, 
.student-status.present, 
.student-status-compact.present, 
.table-status-badge.present,
.status-badge.present { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb;
}

.absent, 
.student-status.absent, 
.student-status-compact.absent, 
.table-status-badge.absent,
.status-badge.absent { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}

.pending,
.student-status.pending,
.student-status-compact.pending,
.table-status-badge.pending,
.status-badge.pending {
    background: #f8f9fa;
    color: #6c757d;
    border-color: #dee2e6;
}


.excused, 
.student-status.excused, 
.student-status-compact.excused, 
.table-status-badge.excused,
.status-badge.excused { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.low-efficiency, 
.student-status.low-efficiency, 
.student-status-compact.low-efficiency, 
.table-status-badge.low-efficiency,
.status-badge.low-efficiency { 
    background: #f8d7da;  /* 🔥 修改：与缺勤样式统一 */
    color: #721c24;       /* 🔥 修改：与缺勤样式统一 */
    border-color: #f5c6cb; /* 🔥 修改：与缺勤样式统一 */
}
.practicing-unscheduled, 
.student-status.practicing-unscheduled, 
.student-status-compact.practicing-unscheduled, 
.table-status-badge.practicing-unscheduled,
.status-badge.practicing-unscheduled { 
    background: #e8d5f2; 
    color: #6a1b9a; 
    border-color: #dcc7e8;
}

.weekend, 
.student-status.weekend, 
.student-status-compact.weekend, 
.table-status-badge.weekend,
.status-badge.weekend { 
    background: #ecf0f1; 
    color: #2c3e50; 
    border-color: #d5dbdb;
}

/* ===== 33. 文本和排版优化 ===== */
p, div, span {
    line-height: 1.5;
}

h1, h2, h3, h4, h5, h6 {
    line-height: 1.2;
    margin-bottom: 0.5em;
    font-weight: 600;
}

/* 确保所有文本输入框在iOS上不会被缩放 */
input, select, textarea, button {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

/* 确保触摸目标足够大 */
.nav-tab,
.btn,
.lang-btn,
.connection-status,
.student-card,
.practice-status-card,
.history-day,
.quick-filter-tag {
    min-height: 44px;
    min-width: 44px;
}

/* 小屏幕下的触摸目标调整 */
@media (max-width: 480px) {
    .nav-tab,
    .btn {
        min-height: 40px;
    }
    
    .lang-btn {
        min-height: 32px;
        min-width: 32px;
    }
    
    .history-day {
        min-height: 32px;
        min-width: 32px;
    }
}

/* ===== 34. 特殊内容处理 ===== */
.detail-item[style*="grid-column: 1 / -1"] .detail-value {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-top: 2px;
}

.detail-item .detail-value[style*="color: #f39c12"] {
    background: rgba(243, 156, 18, 0.1);
    padding: 6px 8px;
    border-radius: var(--radius-small);
    font-size: 0.8rem;
    line-height: 1.3;
}
/* ===== 时间段标签美化样式 - 增大文字并左对齐 ===== */
.time-slot-tag {
    display: inline-block;
    background: transparent;
    color: #6c757d;
    border: none;
    padding: 2px 4px;
    margin: 2px 4px 2px 0;
    border-radius: 0;
    font-size: 0.9rem;         /* 🔥 从 0.8rem 增加到 0.9rem */
    font-weight: 500;          /* 🔥 从 400 增加到 500 */
    box-shadow: none;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.time-slot-tag:hover {
    color: #495057;
    transform: none;
    box-shadow: none;
    background: transparent;
}

.time-slots-wrapper {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;     /* 🔥 改为 flex-start，顶部对齐 */
    justify-content: flex-start; /* 🔥 强制左对齐 */
    gap: 0;
    margin-top: 4px;
    width: 100%;                 /* 🔥 确保占满宽度 */
    margin-left: 0;              /* 🔥 新增：确保没有左边距 */
    padding-left: 0;             /* 🔥 新增：确保没有左内边距 */
}

.time-slots-container {
    width: 100%;                 /* 🔥 容器占满宽度 */
}

.time-slots-container .metric-value {
    line-height: 1.4;            /* 🔥 从 1.2 增加到 1.4 */
    text-align: left;            /* 🔥 文本左对齐 */
    width: 100%;                 /* 🔥 占满宽度 */
    margin-left: 0;              /* 🔥 新增：确保没有左边距 */
    padding-left: 0;             /* 🔥 新增：确保没有左内边距 */
}

/* 🔥 新增：确保时间段容器在网格中左对齐 */
.time-slots-container.metric-item {
    justify-content: flex-start;
    align-items: flex-start;
}

.time-slots-container .metric-content {
    width: 100%;
    text-align: left;
    margin-left: 0;              /* 🔥 新增：确保没有左边距 */
    padding-left: 0;             /* 🔥 新增：确保没有左内边距 */
}

/* 🔥 新增：确保标签行与标题完全左对齐 */
.metric-content .metric-label {
    margin-left: 0;
    padding-left: 0;
    text-align: left;
}

.metric-content .metric-value.time-slots-wrapper {
    margin-left: 0 !important;   /* 🔥 强制去除左边距 */
    padding-left: 0 !important;  /* 🔥 强制去除左内边距 */
    text-align: left;
    justify-content: flex-start !important;
}

/* 当前时间段高亮 - 只有这个状态才有背景和形状 */
.time-slot-tag.current {
    background: linear-gradient(135deg, #d1ecf1, #bee5eb);
    color: #0c5460;
    border: 1px solid #b8daff;
    padding: 6px 14px;         /* 🔥 从 4px 12px 增加到 6px 14px */
    border-radius: 18px;       /* 🔥 从 16px 增加到 18px */
    font-weight: 600;          /* 🔥 从 500 增加到 600 */
    font-size: 0.95rem;        /* 🔥 新增：当前时间段字体更大 */
    box-shadow: 0 1px 3px rgba(12, 84, 96, 0.2);
    animation: pulse-glow 2s infinite;
}

.time-slot-tag.current:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(12, 84, 96, 0.3);
}

@keyframes pulse-glow {
    0%, 100% { 
        box-shadow: 0 1px 3px rgba(12, 84, 96, 0.2);
    }
    50% { 
        box-shadow: 0 2px 8px rgba(12, 84, 96, 0.3);
    }
}

/* 🔥 新增：确保状态指标网格中的对齐 */
.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: start;
}

.status-metrics .metric-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    text-align: left;            /* 🔥 确保内容左对齐 */
}

/* 🔥 新增：特别针对时间段容器的对齐处理 */
.status-metrics .time-slots-container.metric-item .metric-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;     /* 🔥 内容左对齐 */
    width: 100%;
}

.status-metrics .time-slots-container.metric-item .metric-label {
    align-self: flex-start;      /* 🔥 标签左对齐 */
    margin-left: 0;
    padding-left: 0;
}

.status-metrics .time-slots-container.metric-item .metric-value {
    align-self: flex-start;      /* 🔥 值左对齐 */
    width: 100%;
    margin-left: 0;
    padding-left: 0;
}

/* 移动端优化 */
@media (max-width: 768px) {
    .time-slot-tag {
        font-size: 0.85rem;      /* 🔥 从 0.75rem 增加到 0.85rem */
        padding: 3px 4px;        /* 🔥 从 2px 3px 增加到 3px 4px */
        margin: 1px 3px 1px 0;
        font-weight: 500;        /* 🔥 确保移动端也有足够字重 */
    }
    
    .time-slot-tag.current {
        padding: 5px 12px;       /* 🔥 从 3px 10px 增加到 5px 12px */
        font-size: 0.9rem;       /* 🔥 移动端当前时间段也增大 */
    }
    
    .time-slots-container .metric-value {
        line-height: 1.5;        /* 🔥 移动端行高也增加 */
        text-align: left;        /* 🔥 确保移动端也左对齐 */
        margin-left: 0;
        padding-left: 0;
    }
    
    .time-slots-wrapper {
        justify-content: flex-start; /* 🔥 移动端也强制左对齐 */
        margin-left: 0;
        padding-left: 0;
    }
    
    .status-metrics {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (max-width: 480px) {
    .time-slot-tag {
        font-size: 0.8rem;       /* 🔥 超小屏幕适当调整 */
        padding: 2px 3px;
        margin: 1px 2px 1px 0;
    }
    
    .time-slot-tag.current {
        padding: 4px 10px;
        font-size: 0.85rem;
    }
    
    .time-slots-wrapper {
        margin-top: 2px;
        justify-content: flex-start; /* 🔥 超小屏幕也左对齐 */
        margin-left: 0;
        padding-left: 0;
    }
    
    .time-slots-container .metric-value {
        margin-left: 0;
        padding-left: 0;
    }
}

/* 深色模式适配 */
@media (prefers-color-scheme: dark) {
    .time-slot-tag {
        background: transparent;
        color: #8b949e;
        border: none;
        box-shadow: none;
        font-weight: 500;        /* 🔥 确保深色模式也有足够字重 */
    }
    
    .time-slot-tag:hover {
        color: #f0f6fc;
        background: transparent;
        box-shadow: none;
    }
    
    .time-slot-tag.current {
        background: linear-gradient(135deg, #1f2937, #374151);
        color: #93c5fd;
        border: 1px solid #60a5fa;
        box-shadow: 0 1px 3px rgba(147, 197, 253, 0.2);
        font-weight: 600;        /* 🔥 深色模式当前时间段保持粗体 */
    }
    
    .time-slot-tag.current:hover {
        box-shadow: 0 2px 6px rgba(147, 197, 253, 0.3);
    }
    
    @keyframes pulse-glow {
        0%, 100% { 
            box-shadow: 0 1px 3px rgba(147, 197, 253, 0.2);
        }
        50% { 
            box-shadow: 0 2px 8px rgba(147, 197, 253, 0.3);
        }
    }
}

/* 🔥 新增：RTL语言支持时的对齐 */
[dir="rtl"] .time-slots-wrapper {
    justify-content: flex-end;
}

[dir="rtl"] .time-slots-container .metric-value {
    text-align: right;
}

[dir="rtl"] .time-slot-tag {
    margin: 2px 0 2px 4px;
}

/* ===== 35. 动画和过渡效果 ===== */
.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

.slide-up {
    animation: slideUp 0.5s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.bounce-in {
    animation: bounceIn 0.6s ease-out;
}

@keyframes bounceIn {
    0% {
        transform: scale(0.3);
        opacity: 0;
    }
    50% {
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.9);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}
/* ===== 36. 深色模式 ===== */
/* ===== 深色模式变量定义和完美适配 ===== */
@media (prefers-color-scheme: dark) {
    :root {
        /* 深色模式颜色变量重定义 */
        --background-color: #0d1117;
        --card-bg: #21262d;
        --card-hover-bg: #30363d;
        --text-color: #f0f6fc;
        --text-secondary: #8b949e;
        --text-muted: #6e7681;
        --border-color: #30363d;
        --light-gray: #21262d;
        --medium-gray: #8b949e;
        --dark-gray: #f0f6fc;
        --shadow-color: rgba(0,0,0,0.4);
        
        /* 深色模式下的主色调调整 */
        --primary-color: #58a6ff;
        --secondary-color: #3fb950;
        --warning-color: #d29922;
        --danger-color: #f85149;
        --success-color: #3fb950;
        
        /* 深色模式渐变色 */
        --gradient-primary: linear-gradient(135deg, #58a6ff, #3fb950);
        --gradient-card: linear-gradient(135deg, #21262d, #30363d);
        
        /* 深色模式阴影 */
        --shadow: 0 2px 10px rgba(0,0,0,0.4);
        --shadow-hover: 0 5px 20px rgba(0,0,0,0.6);
    }
    
    /* 基础元素深色适配 */
    body {
        background: var(--background-color);
        color: var(--text-color);
    }
    
    /* 卡片和容器深色适配 */
    .card,
    .student-card,
    .practice-status-card,
    .stat-card,
    .today-status-card {
        background: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .card:hover,
    .student-card:hover,
    .practice-status-card:hover {
        background: var(--card-hover-bg);
    }
    
    /* 导航和标签深色适配 */
    .nav-tabs {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .nav-tab {
        color: var(--medium-gray);
    }
    
    .nav-tab:hover {
        background: rgba(88, 166, 255, 0.1);
        color: var(--primary-color);
    }
    
    .nav-tab.active {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 语言切换器深色适配 */
    .language-switcher {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .lang-btn {
        color: var(--medium-gray);
    }
    
    .lang-btn:hover:not(.active) {
        background: rgba(88, 166, 255, 0.1);
        color: var(--primary-color);
    }
    
    .lang-btn.active {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 连接状态指示器深色适配 */
    .connection-status.online {
        background: var(--card-bg);
        color: var(--success-color);
        border-color: var(--success-color);
    }
    
    .connection-status.offline {
        background: var(--card-bg);
        color: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .connection-status.syncing {
        background: var(--card-bg);
        color: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    /* 筛选器深色适配 */
    .filters,
    .practice-filters {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    /* 🔥 新增：特定容器的筛选器深色适配 */
    #todaySnapshot .practice-filters,
    #practiceStatusContainer .practice-filters {
        background: var(--card-bg) !important;
        border: 1px solid var(--border-color) !important;
    }
    
    /* 筛选器内的网格容器深色适配 */
    .practice-filters .student-grid {
        border-top-color: var(--border-color);
    }
    
    /* 筛选器标签和输入框深色适配 */
    .practice-filter-label,
    .filter-label {
        color: var(--medium-gray);
    }
    /* 移动端筛选器深色适配 */
    @media (max-width: 768px) {
        .filters {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        
        .practice-filters {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        
        #todaySnapshot .practice-filters,
        #practiceStatusContainer .practice-filters {
            background: var(--card-bg) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        .date-picker {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }
    }    
    .filter-select,
    .filter-input,
    .practice-filter-select,
    .practice-filter-input,
    .date-input {
        background: var(--background-color);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .filter-select:focus,
    .filter-input:focus,
    .practice-filter-select:focus,
    .practice-filter-input:focus,
    .date-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3);
    }
    
    .filter-select:hover,
    .filter-input:hover,
    .practice-filter-select:hover,
    .practice-filter-input:hover,
    .date-input:hover {
        border-color: var(--primary-color);
    }
    
    /* 快速筛选标签深色适配 */
    .quick-filter-tag {
        background: var(--card-hover-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .quick-filter-tag:hover {
        background: #484f58;
        transform: translateY(-1px);
    }
    
    .quick-filter-tag.active {
        background: var(--primary-color);
        color: #0d1117;
        border-color: var(--primary-color);
    }

    
    /* 按钮深色适配 */
    .btn-primary {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    .btn-primary:hover {
        background: #1f6feb;
    }
    
    .btn-success {
        background: var(--success-color);
        color: #0d1117;
    }
    
    .btn-success:hover {
        background: #2ea043;
    }
    
    .btn-warning {
        background: var(--warning-color);
        color: #0d1117;
    }
    
    .btn-warning:hover {
        background: #bb8009;
    }
    
    .btn-danger {
        background: var(--danger-color);
        color: #0d1117;
    }
    
    .btn-danger:hover {
        background: #da3633;
    }
    
    .btn-secondary {
        background: var(--medium-gray);
        color: #0d1117;
    }
    
    .btn-secondary:hover {
        background: #6e7681;
    }
    
    .btn-outline {
        background: transparent;
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-outline:hover {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 模态框深色适配 */
    .modal {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .modal-content {
        background: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    .modal-close {
        background: var(--card-hover-bg);
        color: var(--medium-gray);
    }
    
    .modal-close:hover {
        background: var(--danger-color);
        color: #0d1117;
    }
    
    /* 表格深色适配 */
    .data-table,
    .detail-table {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .data-table th,
    .data-table td,
    .detail-table th,
    .detail-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    .data-table th,
    .detail-table th {
        background: var(--card-hover-bg);
        color: var(--text-color);
        border-bottom-color: var(--border-color);
    }
    
    .data-table tr:hover,
    .detail-table tr:hover {
        background: var(--card-hover-bg);
    }
    
    .history-table-card .table-container {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
    /* 状态标签深色模式适配 */
    .student-status.present,
    .student-status-compact.present,
    .table-status-badge.present,
    .status-badge.present {
        background: #238636;
        color: #aff5b4;
        border-color: #2ea043;
    }
    
    .student-status.absent,
    .student-status-compact.absent,
    .table-status-badge.absent,
    .status-badge.absent {
        background: #da3633;
        color: #ffdcd7;
        border-color: #f85149;
    }
    
    .student-status.excused,
    .student-status-compact.excused,
    .table-status-badge.excused,
    .status-badge.excused {
        background: #bb8009;
        color: #f2cc60;
        border-color: #d29922;
    }
    
    .student-status.low-efficiency,
    .student-status-compact.low-efficiency,
    .table-status-badge.low-efficiency,
    .table-status-badge.low_efficiency,
    .status-badge.low-efficiency {
        background: #da3633;
        color: #ffdcd7;
        border-color: #f85149;
    }

    
    .student-status.practicing-unscheduled,
    .student-status-compact.practicing-unscheduled,
    .table-status-badge.practicing-unscheduled,
    .status-badge.practicing-unscheduled {
        background: #8250df;
        color: #d2a8ff;
        border-color: #a475f9;
    }
    
    .student-status.weekend,
    .student-status-compact.weekend,
    .table-status-badge.weekend,
    .status-badge.weekend {
        background: #6e7681;
        color: #f0f6fc;
        border-color: #8b949e;
    }
    
    .student-status.pending,
    .student-status-compact.pending,
    .table-status-badge.pending,
    .status-badge.pending {
        background: #30363d;
        color: #8b949e;
        border-color: #484f58;
    }
    
    /* 练琴时长标签深色适配 */
    .practice-duration,
    .practice-duration-large {
        background: #8250df;
        color: #d2a8ff;
        border-color: #a475f9;
    }
    
    /* 考勤历史时间轴深色适配 */
    .history-day.present {
        background: var(--success-color);
        border-color: var(--success-color);
    }
    
    .history-day.absent {
        background: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .history-day.excused {
        background: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    .history-day.no-data {
        background: var(--card-hover-bg);
        color: var(--medium-gray);
        border-color: var(--border-color);
    }
    
    .history-day.low-efficiency {
        background: #9a6700;
        border-color: #bb8009;
    }
    
    .history-day.practicing-unscheduled {
        background: #8250df;
        border-color: #a475f9;
    }
    
    .history-day.weekend {
        background: #6e7681;
        border-color: #8b949e;
    }
    
    /* 卡片边框颜色深色适配 */
    .practice-status-card.present,
    .student-card.present {
        border-left-color: var(--success-color);
    }
    
    .practice-status-card.absent,
    .student-card.absent {
        border-left-color: var(--danger-color);
    }
    
    .practice-status-card.excused,
    .student-card.excused {
        border-left-color: var(--warning-color);
    }
    
    .practice-status-card.low-efficiency,
    .student-card.low-efficiency {
        border-left-color: #bb8009;
    }
    
    .practice-status-card.practicing-unscheduled,
    .student-card.practicing-unscheduled {
        border-left-color: #8250df;
    }
    
    .practice-status-card.weekend,
    .student-card.weekend {
        border-left-color: #6e7681;
        background: var(--gradient-card);
    }
    
    .practice-status-card.pending,
    .student-card.pending {
        border-left-color: var(--medium-gray);
    }
    
    /* 统计卡片深色适配 */
    .stats-grid-detailed .stat-item.present {
        background: linear-gradient(135deg, #0d2818, #238636);
    }
    
    .stats-grid-detailed .stat-item.absent {
        background: linear-gradient(135deg, #2c0e0e, #da3633);
    }
    
    .stats-grid-detailed .stat-item.excused {
        background: linear-gradient(135deg, #2d1b00, #bb8009);
    }
    
    .stats-grid-detailed .stat-item.rate {
        background: linear-gradient(135deg, #0c1929, #1f6feb);
    }
    
    /* 统计图标背景深色适配 */
    .stats-grid-detailed .stat-icon,
    .metric-icon {
        background: rgba(240, 246, 252, 0.1);
    }
    
    /* 请假信息深色适配 */
    .excuse-info {
        background: rgba(187, 128, 9, 0.15);
        border-left-color: var(--warning-color);
    }
    
    .excuse-title {
        color: var(--warning-color);
    }
    
    .excuse-reason {
        color: #f2cc60;
    }
    
    .excuse-approver {
        color: #d29922;
    }
    
    /* 空状态深色适配 */
    .empty-state,
    .practice-empty-state,
    .table-empty-state {
        color: var(--medium-gray);
    }
    
    .empty-state-title,
    .practice-empty-state-title,
    .table-empty-state-title {
        color: var(--text-color);
    }
    
    /* 加载动画深色适配 */
    .spinner {
        border-color: var(--card-hover-bg);
        border-top-color: var(--primary-color);
    }
    
    .loading-text {
        color: var(--medium-gray);
    }
    
    /* 滚动条深色适配 */
    *::-webkit-scrollbar-track {
        background: var(--background-color);
    }
    
    *::-webkit-scrollbar-thumb {
        background-color: var(--card-hover-bg);
    }
    
    *::-webkit-scrollbar-thumb:hover {
        background-color: #484f58;
    }
    
    /* 表格滚动提示深色适配 */
    .table-scroll-hint {
        background: rgba(13, 17, 23, 0.9);
        color: var(--text-color);
    }
    
    /* 详情标签深色适配 */
    .detail-label {
        color: var(--medium-gray);
    }
    
    .detail-value {
        color: var(--text-color);
    }
    
    /* 特殊内容处理深色适配 */
    .detail-item .detail-value[style*="color: #f39c12"] {
        background: rgba(187, 128, 9, 0.15) !important;
        color: #f2cc60 !important;
    }
    
    /* 同步日志深色适配 */
    #syncLogs {
        background: var(--background-color) !important;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    /* 日期选择器深色适配 */
    .date-picker {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    /* 学生档案卡片深色渐变 */
    .student-profile-card {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    }
    
    /* 今日状态卡片深色适配 */
    .today-status-card.present { border-left-color: var(--success-color); }
    .today-status-card.absent { border-left-color: var(--danger-color); }
    .today-status-card.excused { border-left-color: var(--warning-color); }
    .today-status-card.low-efficiency { border-left-color: #bb8009; }
    .today-status-card.practicing-unscheduled { border-left-color: #8250df; }
    .today-status-card.weekend { border-left-color: #6e7681; }
    
    /* 指标项深色适配 */
    .metric-item {
        background: var(--card-hover-bg);
    }
    
    .metric-content {
        color: var(--text-color);
    }
    
    .metric-label {
        color: var(--medium-gray);
    }
    
    .metric-value {
        color: var(--text-color);
    }
    
    /* 卡片标题深色适配 */
    .card-title,
    .status-title,
    .modal-title {
        color: var(--text-color);
    }
    
    .title-subtitle {
        color: var(--medium-gray);
    }
    
    /* 考勤历史边框深色适配 */
    .attendance-history {
        border-top-color: var(--border-color);
    }
    
    /* 头部深色适配 */
    .header {
        background: var(--gradient-primary);
    }
    
    /* 移动端按钮背景深色适配 */
    @media (max-width: 768px) {
        .action-buttons {
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
        }
    }
    
    /* 高对比度模式下的深色适配 */
    @media (prefers-contrast: high) {
        :root {
            --border-color: #58a6ff;
            --text-color: #ffffff;
            --background-color: #000000;
        }
        
        .card {
            border: 2px solid var(--primary-color);
        }
        
        .btn {
            border: 2px solid currentColor;
        }
    }
}

/* ===== 37. 优化和清理 ===== */
/* 确保所有交互元素都有合适的过渡效果 */
button,
input,
select,
textarea,
.card,
.student-card,
.practice-status-card,
.stat-card,
.btn,
.nav-tab,
.quick-filter-tag,
.history-day {
    transition: all 0.3s ease;
}

/* 防止文本选择在某些交互元素上 */
.nav-tab,
.btn,
.student-status,
.student-status-compact,
.practice-duration,
.quick-filter-tag,
.history-day,
.stat-card {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

/* 确保图标和emoji正确显示 */
.title-icon,
.meta-icon,
.metric-icon,
.excuse-icon,
.stat-icon,
.practice-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* 最终的响应式优化 */
@media (max-width: 320px) {
    .container {
        padding: 8px;
    }
    
    .card {
        padding: 15px 10px;
    }
    
    .student-card,
    .practice-status-card {
        padding: 10px 8px;
        min-height: 100px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
}
/* ===== 考勤详情模态框优化 ===== */
#attendanceDetailModal .modal-content {
    max-width: 800px;
    width: 95%;
}

/* 响应式优化 */
@media (max-width: 768px) {
    #attendanceDetailModal .stats-grid-detailed {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px;
    }
    
    #attendanceDetailModal .stat-item {
        padding: 12px;
        min-height: 60px;
    }
    
    #attendanceDetailModal .stat-number {
        font-size: 1.2rem;
    }
    
    #attendanceDetailModal .stat-label {
        font-size: 0.8rem;
    }
}

/* 点击提示 */
.history-day {
    cursor: pointer;
    transition: all 0.3s ease;
}

.history-day:hover {
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* ===== 防止模态框背景滚动 ===== */
body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
}

/* 移动端防滚动优化 */
@media (max-width: 768px) {
    body.modal-open {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        -webkit-overflow-scrolling: none;
    }
}
/* ===== 考勤详情模态框表格滚动修复 ===== */
#attendanceDetailModal .data-table-container {
    max-height: 300px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    /* 🔥 修复：确保表格容器居中且不超出边界 */
    width: 100%;
    box-sizing: border-box;
    margin: 0 auto; /* 🔥 居中显示 */
    padding: 0;
}

/* 🔥 移动端优化 - 修复边距问题 */
@media (max-width: 768px) {
    #attendanceDetailModal .data-table-container {
        max-height: 250px;
        margin: 0; /* 🔥 修复：移除负边距，避免超出边界 */
        border-radius: 8px; /* 🔥 保持圆角 */
        border: 1px solid #e9ecef; /* 🔥 保持边框 */
    }
}

@media (max-width: 480px) {
    #attendanceDetailModal .data-table-container {
        max-height: 200px;
        margin: 0; /* 🔥 修复：超小屏幕也移除负边距 */
    }
}


#attendanceDetailModal .data-table {
    width: 100%;
    min-width: 500px; /* 🔥 设置最小宽度确保表格可读性 */
    border-collapse: collapse;
    margin: 0;
    background: white;
    border-radius: 0; /* 🔥 移除表格圆角，由容器控制 */
    overflow: hidden;
    box-shadow: none; /* 🔥 移除表格阴影，由容器控制 */
    font-size: 0.85rem; /* 🔥 稍微减小字体以适应更多内容 */
}

#attendanceDetailModal .data-table th,
#attendanceDetailModal .data-table td {
    padding: 10px 12px; /* 🔥 减少内边距 */
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    vertical-align: middle;
    /* 🔥 新增：设置最小和最大宽度 */
    min-width: 80px;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
}

#attendanceDetailModal .data-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.75rem; /* 🔥 表头字体更小 */
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10;
}

/* 🔥 新增：特定列宽度控制 */
#attendanceDetailModal .data-table th:nth-child(1),
#attendanceDetailModal .data-table td:nth-child(1) {
    min-width: 120px; /* 时间段列 */
    max-width: 150px;
}

#attendanceDetailModal .data-table th:nth-child(2),
#attendanceDetailModal .data-table td:nth-child(2) {
    min-width: 80px; /* 状态列 */
    max-width: 100px;
}

#attendanceDetailModal .data-table th:nth-child(3),
#attendanceDetailModal .data-table td:nth-child(3) {
    min-width: 90px; /* 练琴时长列 */
    max-width: 120px;
}

#attendanceDetailModal .data-table th:nth-child(4),
#attendanceDetailModal .data-table td:nth-child(4) {
    min-width: 80px; /* 琴房列 */
    max-width: 100px;
}

#attendanceDetailModal .data-table th:nth-child(5),
#attendanceDetailModal .data-table td:nth-child(5) {
    min-width: 100px; /* 备注列 */
    max-width: 200px;
}

/* 🔥 新增：表格行悬停效果优化 */
#attendanceDetailModal .data-table tr:hover {
    background: var(--light-gray);
}

#attendanceDetailModal .data-table tr:last-child td {
    border-bottom: none;
}

/* 🔥 新增：状态标签在表格中的样式调整 */
#attendanceDetailModal .table-status-badge {
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    white-space: nowrap;
    display: inline-block;
    border: 1px solid transparent;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 🔥 新增：滚动条样式优化 */
#attendanceDetailModal .data-table-container::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

#attendanceDetailModal .data-table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#attendanceDetailModal .data-table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#attendanceDetailModal .data-table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 🔥 新增：移动端优化 */
@media (max-width: 768px) {
    #attendanceDetailModal .data-table-container {
        max-height: 250px;
        margin: 0 -10px; /* 🔥 移动端扩展到边缘 */
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    #attendanceDetailModal .data-table {
        min-width: 450px; /* 🔥 移动端最小宽度 */
        font-size: 0.8rem;
    }
    
    #attendanceDetailModal .data-table th,
    #attendanceDetailModal .data-table td {
        padding: 8px 6px; /* 🔥 移动端更紧凑的内边距 */
        min-width: 60px;
    }
    
    #attendanceDetailModal .data-table th {
        font-size: 0.7rem;
    }
    
    #attendanceDetailModal .table-status-badge {
        padding: 2px 6px;
        font-size: 0.6rem;
        border-radius: 8px;
    }
    
    /* 🔥 移动端列宽调整 */
    #attendanceDetailModal .data-table th:nth-child(1),
    #attendanceDetailModal .data-table td:nth-child(1) {
        min-width: 100px;
        max-width: 120px;
    }
    
    #attendanceDetailModal .data-table th:nth-child(2),
    #attendanceDetailModal .data-table td:nth-child(2) {
        min-width: 70px;
        max-width: 80px;
    }
    
    #attendanceDetailModal .data-table th:nth-child(3),
    #attendanceDetailModal .data-table td:nth-child(3) {
        min-width: 80px;
        max-width: 100px;
    }
    
    #attendanceDetailModal .data-table th:nth-child(4),
    #attendanceDetailModal .data-table td:nth-child(4) {
        min-width: 70px;
        max-width: 90px;
    }
    
    #attendanceDetailModal .data-table th:nth-child(5),
    #attendanceDetailModal .data-table td:nth-child(5) {
        min-width: 90px;
        max-width: 150px;
    }
}

@media (max-width: 480px) {
    #attendanceDetailModal .data-table-container {
        max-height: 200px;
    }
    
    #attendanceDetailModal .data-table {
        min-width: 400px;
        font-size: 0.75rem;
    }
    
    #attendanceDetailModal .data-table th,
    #attendanceDetailModal .data-table td {
        padding: 6px 4px;
        min-width: 50px;
    }
    
    #attendanceDetailModal .data-table th {
        font-size: 0.65rem;
    }
    
    #attendanceDetailModal .table-status-badge {
        padding: 1px 4px;
        font-size: 0.55rem;
        border-radius: 6px;
    }
}

/* 🔥 新增：滚动提示 */
#attendanceDetailModal .data-table-container::after {
    content: '← 左右滑动查看更多 →';
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 5;
}

#attendanceDetailModal .data-table-container:hover::after {
    opacity: 1;
}

/* 🔥 移动端滚动提示 */
@media (max-width: 768px) {
    #attendanceDetailModal .data-table-container::after {
        content: '← 滑动 →';
        font-size: 0.65rem;
        padding: 3px 6px;
        bottom: 6px;
        right: 6px;
    }
}

/* 🔥 新增：深色模式适配 */
@media (prefers-color-scheme: dark) {
    #attendanceDetailModal .data-table-container {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
    #attendanceDetailModal .data-table {
        background: var(--card-bg);
    }
    
    #attendanceDetailModal .data-table th,
    #attendanceDetailModal .data-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    #attendanceDetailModal .data-table th {
        background: var(--card-hover-bg);
        color: var(--text-color);
    }
    
    #attendanceDetailModal .data-table tr:hover {
        background: var(--card-hover-bg);
    }
    
    #attendanceDetailModal .data-table-container::-webkit-scrollbar-track {
        background: var(--card-hover-bg);
    }
    
    #attendanceDetailModal .data-table-container::-webkit-scrollbar-thumb {
        background: var(--medium-gray);
    }
    
    #attendanceDetailModal .data-table-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }
    
    #attendanceDetailModal .data-table-container::after {
        background: rgba(13, 17, 23, 0.9);
        color: var(--text-color);
    }
}
/* ===== 学生详情模态框表格滚动修复 ===== */
#studentDetailModal .data-table-container {
    max-height: 230px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    /* 🔥 新增：确保滚动容器不超出边界 */
    width: 100%;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

#studentDetailModal .data-table {
    width: 100%;
    min-width: 400px; /* 🔥 设置最小宽度确保表格可读性 */
    border-collapse: collapse;
    margin: 0;
    background: white;
    border-radius: 0; /* 🔥 移除表格圆角，由容器控制 */
    overflow: hidden;
    box-shadow: none; /* 🔥 移除表格阴影，由容器控制 */
    font-size: 0.85rem; /* 🔥 稍微减小字体以适应更多内容 */
}

#studentDetailModal .data-table th,
#studentDetailModal .data-table td {
    padding: 8px 10px; /* 🔥 减少内边距 */
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    vertical-align: middle;
    /* 🔥 新增：设置最小和最大宽度 */
    min-width: 70px;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
}

#studentDetailModal .data-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.75rem; /* 🔥 表头字体更小 */
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10;
}

/* 🔥 新增：练琴明细表格特定列宽度控制 */
#studentDetailModal .data-table th:nth-child(1),
#studentDetailModal .data-table td:nth-child(1) {
    min-width: 120px; /* 日期列 */
    max-width: 140px;
}

#studentDetailModal .data-table th:nth-child(2),
#studentDetailModal .data-table td:nth-child(2) {
    min-width: 60px; /* 段内列 */
    max-width: 80px;
    text-align: center;
}

#studentDetailModal .data-table th:nth-child(3),
#studentDetailModal .data-table td:nth-child(3) {
    min-width: 60px; /* 段外列 */
    max-width: 80px;
    text-align: center;
}

#studentDetailModal .data-table th:nth-child(4),
#studentDetailModal .data-table td:nth-child(4) {
    min-width: 70px; /* 总计列 */
    max-width: 90px;
    text-align: center;
    font-weight: 600;
}

/* 🔥 新增：表格行悬停效果优化 */
#studentDetailModal .data-table tr:hover {
    background: var(--light-gray);
}

#studentDetailModal .data-table tr:last-child td {
    border-bottom: none;
}

/* 🔥 新增：今日行特殊样式保持 */
#studentDetailModal .data-table .today-row {
    background: #f0f8ff;
}

#studentDetailModal .data-table .today-row:hover {
    background: #e6f3ff;
}

/* 🔥 新增：滚动条样式优化 */
#studentDetailModal .data-table-container::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

#studentDetailModal .data-table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#studentDetailModal .data-table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#studentDetailModal .data-table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 🔥 新增：移动端优化 */
@media (max-width: 768px) {
    #studentDetailModal .data-table-container {
        max-height: 200px;
        margin: 0 -20px; /* 🔥 修复：扩展到模态框边缘，消除右侧空白 */
        border-radius: 0;
        border-left: none;
        border-right: none;
    }

    }
    
    #studentDetailModal .data-table {
        min-width: 350px; /* 🔥 移动端最小宽度 */
        font-size: 0.8rem;
    }
    
    #studentDetailModal .data-table th,
    #studentDetailModal .data-table td {
        padding: 6px 8px; /* 🔥 移动端更紧凑的内边距 */
        min-width: 50px;
    }
    
    #studentDetailModal .data-table th {
        font-size: 0.7rem;
    }
    
    /* 🔥 移动端列宽调整 */
    #studentDetailModal .data-table th:nth-child(1),
    #studentDetailModal .data-table td:nth-child(1) {
        min-width: 100px;
        max-width: 120px;
    }
    
    #studentDetailModal .data-table th:nth-child(2),
    #studentDetailModal .data-table td:nth-child(2) {
        min-width: 50px;
        max-width: 60px;
    }
    
    #studentDetailModal .data-table th:nth-child(3),
    #studentDetailModal .data-table td:nth-child(3) {
        min-width: 50px;
        max-width: 60px;
    }
    
    #studentDetailModal .data-table th:nth-child(4),
    #studentDetailModal .data-table td:nth-child(4) {
        min-width: 60px;
        max-width: 70px;
    }
}

@media (max-width: 480px) {
    #studentDetailModal .data-table-container {
        max-height: 180px;
        margin: 0 -25px; /* 🔥 修复：超小屏幕进一步扩展，确保完全居中 */
    }
    
    #studentDetailModal .data-table {
        min-width: 320px;
        font-size: 0.75rem;
    }
    
    #studentDetailModal .data-table th,
    #studentDetailModal .data-table td {
        padding: 5px 6px;
        min-width: 45px;
    }
    
    #studentDetailModal .data-table th {
        font-size: 0.65rem;
    }
    
    /* 🔥 超小屏幕列宽调整 */
    #studentDetailModal .data-table th:nth-child(1),
    #studentDetailModal .data-table td:nth-child(1) {
        min-width: 90px;
        max-width: 100px;
    }
    
    #studentDetailModal .data-table th:nth-child(2),
    #studentDetailModal .data-table td:nth-child(2) {
        min-width: 45px;
        max-width: 50px;
    }
    
    #studentDetailModal .data-table th:nth-child(3),
    #studentDetailModal .data-table td:nth-child(3) {
        min-width: 45px;
        max-width: 50px;
    }
    
    #studentDetailModal .data-table th:nth-child(4),
    #studentDetailModal .data-table td:nth-child(4) {
        min-width: 50px;
        max-width: 60px;
    }
}
/* ===== 模态框头部和关闭按钮优化 ===== */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding: 15px 0 15px 0; /* 🔥 上方留出空间 */
    border-bottom: 2px solid var(--light-gray);
    position: relative;
    min-height: 60px; /* 🔥 增加最小高度 */
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
    flex: 1;
    line-height: 1.3;
    padding-right: 60px; /* 🔥 增加右侧空间给关闭按钮 */
    padding-top: 5px; /* 🔥 顶部留出一点空间 */
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.modal-close {
    position: absolute;
    top: 10px; /* 🔥 从顶部留出10px空间 */
    right: 10px; /* 🔥 从右侧留出10px空间 */
    width: 44px;
    height: 44px;
    background: transparent;
    border: none;
    font-size: 28px;
    font-weight: 300;
    color: var(--medium-gray);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
    z-index: 10;
    line-height: 1;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

.modal-close:hover {
    background: rgba(231, 76, 60, 0.1);
    color: var(--danger-color);
    transform: scale(1.1);
}

.modal-close:active {
    transform: scale(0.95);
    background: rgba(231, 76, 60, 0.2);
}

/* 🔥 模态框内容区域调整 */
.modal-content {
    position: relative;
    padding: 20px; /* 🔥 统一内边距 */
    max-width: min(800px, 95vw);
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    background: white;
    border-radius: var(--radius-large);
    box-shadow: 0 20px 50px rgba(0,0,0,0.35);
}

/* 🔥 学生详情内容区域 */
#studentDetailContent {
    padding: 0; /* 🔥 移除额外内边距，由内部元素控制 */
}

/* 🔥 移动端优化 */
@media (max-width: 768px) {
    .modal-header {
        padding: 10px 0 12px 0;
        min-height: 50px;
    }
    
    .modal-title {
        font-size: 1.3rem;
        padding-right: 50px;
        padding-top: 3px;
    }
    
    .modal-close {
        width: 40px;
        height: 40px;
        font-size: 24px;
        top: 8px;
        right: 8px;
    }
    
    .modal-content {
        padding: 15px;
        width: 100%;
        max-width: 100%;
        border-radius: var(--radius-large) var(--radius-large) 0 0;
        margin: 0;
    }
}

@media (max-width: 480px) {
    .modal-header {
        padding: 8px 0 10px 0;
        min-height: 45px;
    }
    
    .modal-title {
        font-size: 1.2rem;
        padding-right: 45px;
        padding-top: 2px;
    }
    
    .modal-close {
        width: 36px;
        height: 36px;
        font-size: 22px;
        top: 6px;
        right: 6px;
    }
    
    .modal-content {
        padding: 12px;
    }
}

/* 🔥 深色模式适配 */
@media (prefers-color-scheme: dark) {
    .modal-close {
        color: var(--medium-gray);
    }
    
    .modal-close:hover {
        background: rgba(248, 81, 73, 0.15);
        color: var(--danger-color);
    }
    
    .modal-close:active {
        background: rgba(248, 81, 73, 0.25);
    }
    
    .modal-header {
        border-bottom-color: var(--border-color);
    }
    
    .modal-title {
        color: var(--text-color);
    }
}

/* 🔥 确保考勤详情模态框也使用相同样式 */
#attendanceDetailModal .modal-header {
    padding: 15px 0 15px 0;
    min-height: 60px;
}

#attendanceDetailModal .modal-title {
    padding-right: 60px;
    padding-top: 5px;
}

#attendanceDetailModal .modal-close {
    top: 10px;
    right: 10px;
}

@media (max-width: 768px) {
    #attendanceDetailModal .modal-header {
        padding: 10px 0 12px 0;
        min-height: 50px;
    }
    
    #attendanceDetailModal .modal-title {
        padding-right: 50px;
        padding-top: 3px;
    }
    
    #attendanceDetailModal .modal-close {
        top: 8px;
        right: 8px;
    }
}

@media (max-width: 480px) {
    #attendanceDetailModal .modal-header {
        padding: 8px 0 10px 0;
        min-height: 45px;
    }
    
    #attendanceDetailModal .modal-title {
        padding-right: 45px;
        padding-top: 2px;
    }
    
    #attendanceDetailModal .modal-close {
        top: 6px;
        right: 6px;
    }
}

/* 🔥 高对比度模式支持 */
@media (prefers-contrast: high) {
    .modal-close {
        border: 2px solid var(--medium-gray);
        background: var(--card-bg);
    }
    
    .modal-close:hover {
        border-color: var(--danger-color);
        background: var(--danger-color);
        color: #fff;
    }
}

/* 🔥 减少动画偏好支持 */
@media (prefers-reduced-motion: reduce) {
    .modal-close {
        transition: none;
    }
    
    .modal-close:hover,
    .modal-close:active {
        transform: none;
    }
}

/* 🔥 焦点样式优化 */
.modal-close:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

.modal-close:focus:not(:focus-visible) {
    outline: none;
}

/* 🔥 确保关闭按钮在所有模态框中都正确显示 */
#studentDetailModal .modal-close,
#attendanceDetailModal .modal-close {
    position: absolute;
    top: 0;
    right: 0;
    z-index: 10;
}

/* 🔥 防止标题文本与关闭按钮重叠 */
#studentDetailModal .modal-title,
#attendanceDetailModal .modal-title {
    padding-right: 50px; /* 给关闭按钮留出足够空间 */
}

@media (max-width: 768px) {
    #studentDetailModal .modal-title,
    #attendanceDetailModal .modal-title {
        padding-right: 45px;
    }
}

@media (max-width: 480px) {
    #studentDetailModal .modal-title,
    #attendanceDetailModal .modal-title {
        padding-right: 40px;
    }
}

/* 🔥 新增：滚动提示 */
#studentDetailModal .data-table-container::after {
    content: '← 左右滑动查看更多 →';
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 5;
}

#studentDetailModal .data-table-container:hover::after {
    opacity: 1;
}

/* 🔥 移动端滚动提示 */
@media (max-width: 768px) {
    #studentDetailModal .data-table-container::after {
        content: '← 滑动 →';
        font-size: 0.65rem;
        padding: 3px 6px;
        bottom: 6px;
        right: 6px;
    }
}

/* 🔥 新增：深色模式适配 */
@media (prefers-color-scheme: dark) {
    #studentDetailModal .data-table-container {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
    #studentDetailModal .data-table {
        background: var(--card-bg);
    }
    
    #studentDetailModal .data-table th,
    #studentDetailModal .data-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    #studentDetailModal .data-table th {
        background: var(--card-hover-bg);
        color: var(--text-color);
    }
    
    #studentDetailModal .data-table tr:hover {
        background: var(--card-hover-bg);
    }
    
    #studentDetailModal .data-table .today-row {
        background: rgba(88, 166, 255, 0.15) !important;
    }
    
    #studentDetailModal .data-table .today-row:hover {
        background: rgba(88, 166, 255, 0.25) !important;
    }
    
    #studentDetailModal .data-table .today-row .date-cell small {
        color: var(--primary-color) !important;
    }
    
    #studentDetailModal .data-table-container::-webkit-scrollbar-track {
        background: var(--card-hover-bg);
    }
    
    #studentDetailModal .data-table-container::-webkit-scrollbar-thumb {
        background: var(--medium-gray);
    }
    
    #studentDetailModal .data-table-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }
    
    #studentDetailModal .data-table-container::after {
        background: rgba(13, 17, 23, 0.9);
        color: var(--text-color);
    }
}
/* 🔥 性能优化 */
.modal,
.modal-content {
    /* 启用硬件加速 */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    will-change: transform, opacity;
}

/* 🔥 减少重绘 */
@media (max-width: 768px) {
    .modal-content {
        contain: layout style paint;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        -webkit-perspective: 1000px;
        perspective: 1000px;
    }
}

/* 🔥 优化滚动性能 */
.modal-content {
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
}

/* ===== 报告页面表格滚动修复 ===== */
#reportsTab .data-table-container {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    /* 🔥 修复：确保表格容器居中且不超出边界 */
    width: 100%;
    box-sizing: border-box;
    margin: 0 auto; /* 🔥 居中显示 */
    padding: 0;
}

/* 🔥 移动端优化 - 修复边距问题 */
@media (max-width: 768px) {
    #reportsTab .data-table-container {
        margin: 0; /* 🔥 修复：移除负边距，避免超出边界 */
        border-radius: 8px; /* 🔥 保持圆角 */
        border: 1px solid #e9ecef; /* 🔥 保持边框 */
    }
    
    /* 每日考勤趋势表格移动端优化 */
    #reportsTab .data-table-container:first-of-type {
        max-height: 250px;
    }
    
    /* 学生考勤统计表格移动端优化 */
    #reportsTab .data-table-container:last-of-type {
        max-height: 300px;
    }
}


#reportsTab .data-table {
    width: 100%;
    min-width: 500px; /* 🔥 设置最小宽度确保表格可读性 */
    border-collapse: collapse;
    margin: 0;
    background: white;
    border-radius: 0; /* 🔥 移除表格圆角，由容器控制 */
    overflow: hidden;
    box-shadow: none; /* 🔥 移除表格阴影，由容器控制 */
    font-size: 0.85rem; /* 🔥 稍微减小字体以适应更多内容 */
}

#reportsTab .data-table th,
#reportsTab .data-table td {
    padding: 8px 10px; /* 🔥 减少内边距 */
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    vertical-align: middle;
    /* 🔥 新增：设置最小和最大宽度 */
    min-width: 70px;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
}

#reportsTab .data-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.75rem; /* 🔥 表头字体更小 */
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10;
}

/* 🔥 新增：每日考勤趋势表格列宽控制 */
#reportsTab .data-table.daily-trend th:nth-child(1),
#reportsTab .data-table.daily-trend td:nth-child(1) {
    min-width: 100px; /* 日期列 */
    max-width: 120px;
}

#reportsTab .data-table.daily-trend th:nth-child(2),
#reportsTab .data-table.daily-trend td:nth-child(2) {
    min-width: 60px; /* 合计列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.daily-trend th:nth-child(3),
#reportsTab .data-table.daily-trend td:nth-child(3) {
    min-width: 60px; /* 出勤列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.daily-trend th:nth-child(4),
#reportsTab .data-table.daily-trend td:nth-child(4) {
    min-width: 60px; /* 缺勤列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.daily-trend th:nth-child(5),
#reportsTab .data-table.daily-trend td:nth-child(5) {
    min-width: 60px; /* 请假列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.daily-trend th:nth-child(6),
#reportsTab .data-table.daily-trend td:nth-child(6) {
    min-width: 80px; /* 出勤率列 */
    max-width: 100px;
    text-align: center;
    font-weight: 600;
}

/* 🔥 新增：学生考勤统计表格列宽控制 */
#reportsTab .data-table.student-stats th:nth-child(1),
#reportsTab .data-table.student-stats td:nth-child(1) {
    min-width: 100px; /* 姓名列 */
    max-width: 150px;
}

#reportsTab .data-table.student-stats th:nth-child(2),
#reportsTab .data-table.student-stats td:nth-child(2) {
    min-width: 80px; /* 专业列 */
    max-width: 120px;
}

#reportsTab .data-table.student-stats th:nth-child(3),
#reportsTab .data-table.student-stats td:nth-child(3) {
    min-width: 60px; /* 出勤列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.student-stats th:nth-child(4),
#reportsTab .data-table.student-stats td:nth-child(4) {
    min-width: 60px; /* 缺勤列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.student-stats th:nth-child(5),
#reportsTab .data-table.student-stats td:nth-child(5) {
    min-width: 60px; /* 请假列 */
    max-width: 80px;
    text-align: center;
}

#reportsTab .data-table.student-stats th:nth-child(6),
#reportsTab .data-table.student-stats td:nth-child(6) {
    min-width: 80px; /* 出勤率列 */
    max-width: 100px;
    text-align: center;
    font-weight: 600;
}

/* 🔥 新增：表格行悬停效果优化 */
#reportsTab .data-table tr:hover {
    background: var(--light-gray);
}

#reportsTab .data-table tr:last-child td {
    border-bottom: none;
}

/* 🔥 新增：滚动条样式优化 */
#reportsTab .data-table-container::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

#reportsTab .data-table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#reportsTab .data-table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#reportsTab .data-table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 🔥 新增：移动端优化 */
@media (max-width: 768px) {
    #reportsTab .data-table-container {
        margin: 0 -15px; /* 🔥 移动端扩展到边缘 */
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    /* 每日考勤趋势表格移动端优化 */
    #reportsTab .data-table-container:first-of-type {
        max-height: 250px;
    }
    
    /* 学生考勤统计表格移动端优化 */
    #reportsTab .data-table-container:last-of-type {
        max-height: 300px;
    }
    
    #reportsTab .data-table {
        font-size: 0.8rem;
    }
    
    #reportsTab .data-table th,
    #reportsTab .data-table td {
        padding: 6px 8px; /* 🔥 移动端更紧凑的内边距 */
        min-width: 50px;
    }
    
    #reportsTab .data-table th {
        font-size: 0.7rem;
    }
    
    /* 🔥 移动端每日趋势表格列宽调整 */
    #reportsTab .data-table.daily-trend {
        min-width: 450px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(1),
    #reportsTab .data-table.daily-trend td:nth-child(1) {
        min-width: 90px;
        max-width: 100px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(2),
    #reportsTab .data-table.daily-trend td:nth-child(2),
    #reportsTab .data-table.daily-trend th:nth-child(3),
    #reportsTab .data-table.daily-trend td:nth-child(3),
    #reportsTab .data-table.daily-trend th:nth-child(4),
    #reportsTab .data-table.daily-trend td:nth-child(4),
    #reportsTab .data-table.daily-trend th:nth-child(5),
    #reportsTab .data-table.daily-trend td:nth-child(5) {
        min-width: 50px;
        max-width: 60px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(6),
    #reportsTab .data-table.daily-trend td:nth-child(6) {
        min-width: 70px;
        max-width: 80px;
    }
    
    /* 🔥 移动端学生统计表格列宽调整 */
    #reportsTab .data-table.student-stats {
        min-width: 480px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(1),
    #reportsTab .data-table.student-stats td:nth-child(1) {
        min-width: 80px;
        max-width: 100px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(2),
    #reportsTab .data-table.student-stats td:nth-child(2) {
        min-width: 70px;
        max-width: 90px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(3),
    #reportsTab .data-table.student-stats td:nth-child(3),
    #reportsTab .data-table.student-stats th:nth-child(4),
    #reportsTab .data-table.student-stats td:nth-child(4),
    #reportsTab .data-table.student-stats th:nth-child(5),
    #reportsTab .data-table.student-stats td:nth-child(5) {
        min-width: 50px;
        max-width: 60px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(6),
    #reportsTab .data-table.student-stats td:nth-child(6) {
        min-width: 70px;
        max-width: 80px;
    }
}

@media (max-width: 480px) {
    #reportsTab .data-table-container:first-of-type {
        max-height: 200px;
    }
    
    #reportsTab .data-table-container:last-of-type {
        max-height: 250px;
    }
    
    #reportsTab .data-table {
        font-size: 0.75rem;
    }
    
    #reportsTab .data-table th,
    #reportsTab .data-table td {
        padding: 5px 6px;
        min-width: 45px;
    }
    
    #reportsTab .data-table th {
        font-size: 0.65rem;
    }
    
    /* 🔥 超小屏幕每日趋势表格优化 */
    #reportsTab .data-table.daily-trend {
        min-width: 400px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(1),
    #reportsTab .data-table.daily-trend td:nth-child(1) {
        min-width: 80px;
        max-width: 90px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(2),
    #reportsTab .data-table.daily-trend td:nth-child(2),
    #reportsTab .data-table.daily-trend th:nth-child(3),
    #reportsTab .data-table.daily-trend td:nth-child(3),
    #reportsTab .data-table.daily-trend th:nth-child(4),
    #reportsTab .data-table.daily-trend td:nth-child(4),
    #reportsTab .data-table.daily-trend th:nth-child(5),
    #reportsTab .data-table.daily-trend td:nth-child(5) {
        min-width: 45px;
        max-width: 50px;
    }
    
    #reportsTab .data-table.daily-trend th:nth-child(6),
    #reportsTab .data-table.daily-trend td:nth-child(6) {
        min-width: 60px;
        max-width: 70px;
    }
    
    /* 🔥 超小屏幕学生统计表格优化 */
    #reportsTab .data-table.student-stats {
        min-width: 420px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(1),
    #reportsTab .data-table.student-stats td:nth-child(1) {
        min-width: 70px;
        max-width: 80px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(2),
    #reportsTab .data-table.student-stats td:nth-child(2) {
        min-width: 60px;
        max-width: 70px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(3),
    #reportsTab .data-table.student-stats td:nth-child(3),
    #reportsTab .data-table.student-stats th:nth-child(4),
    #reportsTab .data-table.student-stats td:nth-child(4),
    #reportsTab .data-table.student-stats th:nth-child(5),
    #reportsTab .data-table.student-stats td:nth-child(5) {
        min-width: 45px;
        max-width: 50px;
    }
    
    #reportsTab .data-table.student-stats th:nth-child(6),
    #reportsTab .data-table.student-stats td:nth-child(6) {
        min-width: 60px;
        max-width: 70px;
    }
}

/* 🔥 新增：滚动提示 */
#reportsTab .data-table-container::after {
    content: '← 左右滑动查看更多 →';
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 5;
}

#reportsTab .data-table-container:hover::after {
    opacity: 1;
}

/* 🔥 移动端滚动提示 */
@media (max-width: 768px) {
    #reportsTab .data-table-container::after {
        content: '← 滑动 →';
        font-size: 0.65rem;
        padding: 3px 6px;
        bottom: 6px;
        right: 6px;
    }
}

/* 🔥 新增：深色模式适配 */
@media (prefers-color-scheme: dark) {
    #reportsTab .data-table-container {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
    #reportsTab .data-table {
        background: var(--card-bg);
    }
    
    #reportsTab .data-table th,
    #reportsTab .data-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    #reportsTab .data-table th {
        background: var(--card-hover-bg);
        color: var(--text-color);
    }
    
    #reportsTab .data-table tr:hover {
        background: var(--card-hover-bg);
    }
    
    #reportsTab .data-table-container::-webkit-scrollbar-track {
        background: var(--card-hover-bg);
    }
    
    #reportsTab .data-table-container::-webkit-scrollbar-thumb {
        background: var(--medium-gray);
    }
    
    #reportsTab .data-table-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }
    
    #reportsTab .data-table-container::after {
        background: rgba(13, 17, 23, 0.9);
        color: var(--text-color);
    }
}

/* ===== 新增：目前未练琴状态样式 ===== */
.student-status.not-practicing,
.student-status-compact.not-practicing,
.table-status-badge.not-practicing,
.status-badge.not-practicing {
    background: #f8f9fa;
    color: #6c757d;
    border-color: #dee2e6;
}

.practice-status-card.not-practicing,
.student-card.not-practicing {
    border-left-color: #6c757d;
}

/* ===== 考勤历史时间轴样式 ===== */
.history-day.not-practicing {
    background: #6c757d;
    border-color: #6c757d;
    color: white;
}

/* ===== 深色模式适配 ===== */
@media (prefers-color-scheme: dark) {
    .student-status.not-practicing,
    .student-status-compact.not-practicing,
    .table-status-badge.not-practicing,
    .status-badge.not-practicing {
        background: #30363d;
        color: #8b949e;
        border-color: #484f58;
    }
    
    .practice-status-card.not-practicing,
    .student-card.not-practicing {
        border-left-color: #8b949e;
    }
    
    .history-day.not-practicing {
        background: #6e7681;
        border-color: #8b949e;
    }
}

/* ===== 样式文件结束 ===== */
</style>
</head>
<body>
<!-- ===== 页面主体（与你原始版本一致，这里保持不动） ===== -->
<div class="container">
  <div class="language-switcher">
    <button class="lang-btn active" onclick="switchLanguage('zh')" data-lang="zh">中文</button>
    <button class="lang-btn" onclick="switchLanguage('en')" data-lang="en">EN</button>
  </div>
  <div id="connectionStatus" class="connection-status offline">
    <span data-i18n="status.offline">🔴 离线模式</span>
  </div>
  <div class="header">
    <h1><span data-i18n="header.title">🎼 青岛耶胡迪梅纽因学校</span></h1>
    <div class="subtitle" data-i18n="header.subtitle">实时练琴跟踪系统</div>
  </div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('dashboard')"><span data-i18n="nav.dashboard">📊 考勤概览</span></button>
    <button class="nav-tab" onclick="switchTab('students')"><span data-i18n="nav.students">👥 学生详情</span></button>
    <button class="nav-tab" onclick="switchTab('reports')"><span data-i18n="nav.reports">📈 历史报告</span></button>
    <button class="nav-tab" onclick="switchTab('sync')"><span data-i18n="nav.sync">🔄 数据同步</span></button>
  </div>

  <div id="dashboardTab" class="tab-content">
    <div class="stats-grid">
      <div class="stat-card present">
        <div class="stat-number" id="presentCount">0</div>
        <div class="stat-label" data-i18n="stats.present">出勤</div>
        <div class="stat-description" data-i18n="stats.present.desc">当前在琴房</div>
      </div>
      <div class="stat-card absent">
        <div class="stat-number" id="absentCount">0</div>
        <div class="stat-label" data-i18n="stats.absent">缺勤</div>
        <div class="stat-description" data-i18n="stats.absent.desc">应到未到</div>
      </div>
      <div class="stat-card excused">
        <div class="stat-number" id="excusedCount">0</div>
        <div class="stat-label" data-i18n="stats.excused">请假</div>
        <div class="stat-description" data-i18n="stats.excused.desc">已批准请假</div>
      </div>
      <div class="stat-card pending">
        <div class="stat-number" id="pendingCount">0</div>
        <div class="stat-label" data-i18n="stats.pending">待考勤</div>
        <div class="stat-description" data-i18n="stats.pending.desc">非练琴时间</div>
      </div>
    </div>
    <div class="card" id="excuseInfoPanel" style="display:none;">
      <h3 data-i18n="excuse.title">📝 今日请假信息</h3>
      <div id="excuseInfoContainer"></div>
    </div>
    <div class="card">
      <h3 data-i18n="practice.title">🎹 实时练琴状态</h3>
      <div class="date-picker">
        <span style="color:#666;font-size:14px;">
          <span data-i18n="practice.current_time">当前时间：</span>
          <span id="currentTime"></span>
        </span>
      </div>
      <div id="practiceStatusContainer"></div>
    </div>
  </div>

  <div id="studentsTab" class="tab-content" style="display:none;">
    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.major">专业筛选</label>
          <select id="majorFilter" class="filter-select" onchange="filterStudents()">
            <option value="" data-i18n="filter.all_majors">所有专业</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.grade">年级筛选</label>
          <select id="gradeFilter" class="filter-select" onchange="filterStudents()">
            <option value="" data-i18n="filter.all_grades">所有年级</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.status">考勤状态</label>
          <select id="statusFilter" class="filter-select" onchange="filterStudents()">
            <option value="" data-i18n="filter.all_status">所有状态</option>
            <option value="present" data-i18n="status.present">出勤</option>
            <option value="absent" data-i18n="status.absent">缺勤</option>
            <option value="excused" data-i18n="status.excused">请假</option>
            <option value="self_practice">自主练琴</option>
            <option value="not_practicing">目前未练琴</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.search">搜索学生</label>
          <input type="text" id="studentSearch" class="filter-input" data-i18n-placeholder="filter.search_placeholder" placeholder="输入学生姓名..." oninput="filterStudents()">
        </div>
      </div>
    </div>
    <div id="studentList" class="student-grid"></div>
  </div>

  <div id="reportsTab" class="tab-content" style="display:none;">
    <div class="card">
      <h3 data-i18n="report.title">📈 考勤历史分析</h3>
      <div class="date-picker">
        <label data-i18n="report.start_date">开始日期：</label>
        <input type="date" id="startDate" class="date-input">
        <label data-i18n="report.end_date">结束日期：</label>
        <input type="date" id="endDate" class="date-input">
        <button class="btn btn-primary" onclick="generateReport()">
          <span>📊</span><span data-i18n="btn.generate_report">生成报告</span>
        </button>
      </div>
      <div id="reportContent">
        <div class="empty-state">
          <div class="empty-state-icon">📊</div>
          <div class="empty-state-title" data-i18n="report.empty.title">选择日期范围生成报告</div>
          <div class="empty-state-description" data-i18n="report.empty.desc">选择开始和结束日期，然后点击"生成报告"</div>
        </div>
      </div>
    </div>
  </div>

  <div id="syncTab" class="tab-content" style="display:none;">
    <div class="card">
      <h3 data-i18n="sync.title">🔄 数据同步管理</h3>
      <div class="card success" id="syncStatus">
        <h4 data-i18n="sync.status">同步状态</h4>
        <p id="syncStatusText" data-i18n="sync.checking">正在检查连接状态...</p>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="forceSync()"><span>🔄</span><span data-i18n="btn.force_sync">强制同步</span></button>
          <button class="btn btn-warning" onclick="clearLocalCache()"><span>🗑️</span><span data-i18n="btn.clear_cache">清除缓存</span></button>
        </div>
      </div>
      <div class="card">
        <h4 data-i18n="sync.logs">📋 同步日志</h4>
        <div id="syncLogs" style="max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px;white-space:pre-line;"></div>
      </div>
    </div>
  </div>
</div>

<!-- 学生详情模态 -->
<div id="studentDetailModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="studentDetailTitle" data-i18n="student.detail.title">学生详情</h3>
      <button class="modal-close" onclick="closeModal('studentDetailModal')">&times;</button>
    </div>
    <div id="studentDetailContent"></div>
  </div>
</div>

<!-- 考勤详情模态（动态创建时也会使用这个ID） -->
<div id="attendanceDetailModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:800px;"></div>
</div>

<script>
/* =============================
   1. 国际化配置（保留原结构）
   ============================= */
const i18n = {
  zh: {
    // 头部
    'header.title': '🎼 青岛耶胡迪梅纽因学校',
    'header.subtitle': '实时练琴跟踪系统',


    
    // 导航
    'nav.dashboard': '📊 考勤概览',
    'nav.students': '👥 学生详情', 
    'nav.reports': '📈 历史报告',
    'nav.sync': '🔄 数据同步',
    
    // 连接状态
    'status.online': '🟢 已连接',
    'status.offline': '🔴 离线模式',
    'status.syncing': '🟡 同步中',
    
    // 考勤状态
    'status.present': '出勤',
    'status.absent': '缺勤',
    'status.excused': '请假',
    'status.pending': '待考勤',
    'status.low_efficiency': '低效',
    'stats.absent.desc': '应到未到',
    'status.self_practice': '自主练琴',
    'status.not_practicing': '目前未练琴',


    // 统计
    'stats.total': '总学生数',
    'stats.total.desc': '已登记学生',
    'stats.present': '出勤',
    'stats.present.desc': '当前在琴房',
    'stats.absent': '缺勤',
    'stats.absent.desc': '应到未到',
    'stats.excused': '请假',
    'stats.excused.desc': '已批准请假',
    'stats.pending': '待考勤',
    'stats.pending.desc': '非练琴时间',

    
    // 练琴相关
    'practice.title': '🎹 实时练琴状态',
    'practice.current_time': '当前时间：',
    'practice.empty.title': '当前没有学生在练琴',
    'practice.empty.desc.weekday': '等待学生开始练琴',
    'practice.in_slot': '段内',
    'practice.out_slot': '段外',
    
    // 考勤相关
    'attendance.title': '📅 今日考勤快照',
    'attendance.select_date': '选择日期：',
    'attendance.history': '最近7天考勤',
    'attendance.rate': '出勤率',
    'attendance.detail.suffix': '考勤详情',
    'attendance.summary': '考勤汇总',
    'attendance.detailed_records': '详细记录',
    'attendance.remarks': '备注',
    
    // 筛选器
    'filter.major': '专业筛选',
    'filter.grade': '年级筛选',
    'filter.status': '考勤状态',
    'filter.search': '搜索学生',
    'filter.all_majors': '所有专业',
    'filter.all_grades': '所有年级',
    'filter.all_status': '所有状态',
    'filter.search_placeholder': '输入学生姓名...',
    'filter.no_results': '没有符合条件的学生',
    'filter.try_different': '请尝试调整筛选条件',
    'filter.clear': '清除',
    
    // 学生信息
    'student.name': '姓名',
    'student.major': '专业',
    'student.grade': '年级',
    'student.room': '所在琴房',
    'student.time_slot': '时间段',
    'student.practice_duration': '练琴时长',
    'student.start_time': '最近开始',
    'student.not_in_room': '不在琴房',
    'student.not_started': '未开始',
    'student.not_set': '未设置',
    'student.unknown_major': '未知专业',
    'student.detail.title': '学生详情',
    'student.today_attendance': '今日考勤',
    'student.today_practice': '今日练琴时长',
    
    // 时间相关
    'time.hours': '小时',
    'time.minutes': '分钟',
    'time.seconds': '秒',
    'time.no_practice': '0分钟',
    
    // 请假相关
    'excuse.title': '📝 今日请假信息',
    'excuse.reason': '请假原因',
    'excuse.duration_text': '请假时长',
    'excuse.end_date': '结束日期',
    'excuse.not_filled': '未填写',
    
    // 报告相关
    'report.title': '📈 考勤历史分析',
    'report.start_date': '开始日期：',
    'report.end_date': '结束日期：',
    'report.empty.title': '选择日期范围生成报告',
    'report.empty.desc': '选择开始和结束日期，然后点击"生成报告"',
    'report.analysis_title': '📊 考勤分析报告',
    'report.period': '统计周期',
    'report.to': '至',
    'report.days': '天',
    'report.participants': '参与学生',
    'report.people': '人',
    'report.daily_trend': '📈 每日考勤趋势',
    'report.date': '日期',
    'report.total': '合计',
    'report.student_stats': '👥 学生考勤统计',
    'report.regenerate': '重新生成',
    
    // 同步相关
    'sync.title': '🔄 数据同步管理',
    'sync.status': '同步状态',
    'sync.checking': '正在检查连接状态...',
    'sync.logs': '📋 同步日志',
    'sync.force_sync': '强制同步',
    
    // 按钮
    'btn.generate_report': '生成报告',
    'btn.force_sync': '强制同步',
    'btn.clear_cache': '清除缓存',
    
    // 消息提示
    'msg.loading': '加载中...',
    'msg.no_data': '暂无数据',
    'msg.select_dates': '请选择开始和结束日期',
    'msg.date_range_error': '开始日期不能晚于结束日期',
    'msg.sync_required': '需要网络连接才能同步数据',
    'msg.clear_cache_confirm': '确定要清除本地缓存吗？',
    'msg.cache_cleared': '本地缓存已清除',
    
    // 空状态
    'empty.no_students': '暂无学生数据',
    'empty.no_attendance': '还没有考勤记录',
    'empty.load_failed': '加载失败'
  },
  
  en: {
    // 头部
    'header.title': '🎼 Qingdao Yehudi Menuhin School',
    'header.subtitle': 'Real-time Practice Tracking System',
    
    // 导航
    'nav.dashboard': '📊 Attendance Overview',
    'nav.students': '👥 Student Details',
    'nav.reports': '📈 Historical Reports',
    'nav.sync': '🔄 Data Sync',
    
    // 连接状态
    'status.online': '🟢 Connected',
    'status.offline': '🔴 Offline Mode',
    'status.syncing': '🟡 Syncing',
    
    // 考勤状态
    'status.present': 'Present',
    'status.absent': 'Absent',
    'status.excused': 'Excused',
    'status.pending': 'Pending',
    'status.low_efficiency': 'Low Efficiency',
    'stats.absent.desc': 'Should be Present',
    'status.self_practice': 'Self Practice',
    'status.not_practicing': 'Not Practicing',
    
    // 统计
    'stats.total': 'Total Students',
    'stats.total.desc': 'Registered Students',
    'stats.present': 'Present',
    'stats.present.desc': 'Currently in Rooms',
    'stats.absent': 'Absent',
    'stats.absent.desc': 'Should be Present',
    'stats.excused': 'Excused',
    'stats.excused.desc': 'Approved Leave',
    'stats.pending': 'Pending',
    'stats.pending.desc': 'Non-practice Time',

    
    // 练琴相关
    'practice.title': '🎹 Real-time Practice Status',
    'practice.current_time': 'Current Time: ',
    'practice.empty.title': 'No students currently practicing',
    'practice.empty.desc.weekday': 'Waiting for students to start practicing',    
    'practice.in_slot': 'In-Slot',
    'practice.out_slot': 'Out-Slot',
    // 考勤相关
    'attendance.title': '📅 Today\'s Attendance Snapshot',
    'attendance.select_date': 'Select Date: ',
    'attendance.history': 'Last 7 Days Attendance',
    'attendance.rate': 'Attendance Rate',
    'attendance.detail.suffix': ' Attendance Details',
    'attendance.summary': 'Attendance Summary',
    'attendance.detailed_records': 'Detailed Records',
    'attendance.remarks': 'Remarks',

    
    // 筛选器
    'filter.major': 'Major Filter',
    'filter.grade': 'Grade Filter',
    'filter.status': 'Attendance Status',
    'filter.search': 'Search Students',
    'filter.all_majors': 'All Majors',
    'filter.all_grades': 'All Grades',
    'filter.all_status': 'All Status',
    'filter.search_placeholder': 'Enter student name...',
    'filter.no_results': 'No matching students found',
    'filter.try_different': 'Please try adjusting filter criteria',
    'filter.clear': 'Clear',
    
    // 学生信息
    'student.name': 'Name',
    'student.major': 'Major',
    'student.grade': 'Grade',
    'student.room': 'Room',
    'student.time_slot': 'Time Slot',
    'student.practice_duration': 'Practice Duration',
    'student.start_time': 'Recent Start',
    'student.not_in_room': 'Not in Room',
    'student.not_started': 'Not Started',
    'student.not_set': 'Not Set',
    'student.unknown_major': 'Unknown Major',
    'student.detail.title': 'Student Details',
    'student.today_attendance': 'Today\'s Attendance',
    'student.today_practice': 'Today\'s Practice Time',
    
    // 时间相关
    'time.hours': 'h',
    'time.minutes': 'min',
    'time.seconds': 's',
    'time.no_practice': '0 min',
    
    // 请假相关
    'excuse.title': '📝 Today\'s Leave Information',
    'excuse.reason': 'Leave Reason',
    'excuse.duration_text': 'Leave Duration',
    'excuse.end_date': 'End Date',
    'excuse.not_filled': 'Not Filled',
    
    // 报告相关
    'report.title': '📈 Attendance History Analysis',
    'report.start_date': 'Start Date: ',
    'report.end_date': 'End Date: ',
    'report.empty.title': 'Select date range to generate report',
    'report.empty.desc': 'Choose start and end dates, then click "Generate Report"',
    'report.analysis_title': '📊 Attendance Analysis Report',
    'report.period': 'Statistical Period',
    'report.to': 'to',
    'report.days': ' days',
    'report.participants': 'Participating Students',
    'report.people': ' students',
    'report.daily_trend': '📈 Daily Attendance Trend',
    'report.date': 'Date',
    'report.total': 'Total',
    'report.student_stats': '👥 Student Attendance Statistics',
    'report.regenerate': 'Regenerate',
    
    // 同步相关
    'sync.title': '🔄 Data Sync Management',
    'sync.status': 'Sync Status',
    'sync.checking': 'Checking connection status...',
    'sync.logs': '📋 Sync Logs',
    'sync.force_sync': 'Force Sync',
    
    // 按钮
    'btn.generate_report': 'Generate Report',
    'btn.force_sync': 'Force Sync',
    'btn.clear_cache': 'Clear Cache',
    
    // 消息提示
    'msg.loading': 'Loading...',
    'msg.no_data': 'No Data',
    'msg.select_dates': 'Please select start and end dates',
    'msg.date_range_error': 'Start date cannot be later than end date',
    'msg.sync_required': 'Network connection required for data sync',
    'msg.clear_cache_confirm': 'Are you sure you want to clear local cache?',
    'msg.cache_cleared': 'Local cache cleared',
    
    // 空状态
    'empty.no_students': 'No student data available',
    'empty.no_attendance': 'No attendance records yet',
    'empty.load_failed': 'Loading failed'
  }
};

let currentLanguage='zh';
function t(k,f=''){const p=i18n[currentLanguage]||{};return p[k]||f||k;}
function switchLanguage(lang){if(lang===currentLanguage)return;currentLanguage=lang;document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.dataset.lang===lang));updatePageLanguage();localStorage.setItem('preferred_language',lang);addSyncLog(`🌐 ${lang==='zh'?'语言切换为中文':'Language switched to English'}`);refreshCurrentTabContent();}
function updatePageLanguage(){const pack=i18n[currentLanguage]||{};document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(pack[k]) el.textContent=pack[k];});document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{const k=el.getAttribute('data-i18n-placeholder');if(pack[k]) el.placeholder=pack[k];});document.title=currentLanguage==='zh'?'青岛梅纽因音乐学校练琴跟踪系统':'Qingdao Menuhin Music School Practice Tracking System';}

/* =============== Firebase =============== */
const firebaseConfig={
  apiKey:"AIzaSyBfRjrAKsVUAHBl5WbBl96YONrkRe1UWUo",
  authDomain:"menuhin-studio-system.firebaseapp.com",
  databaseURL:"https://menuhin-studio-system-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"menuhin-studio-system",
  storageBucket:"menuhin-studio-system.firebasestorage.app",
  messagingSenderId:"218592951152",
  appId:"1:218592951152:web:650d080726b6c44f5a2db5",
  measurementId:"G-P49SZQTLT7"
};
let database=null,isOnline=false;

/* =============== 全局数据结构 =============== */
let rooms=[];
let studentDatabase={};
let excuseData={};
let attendanceRecordsCache={};
let realTimePracticeMap={};
let syncLogs=[];
let currentTab='dashboard';

let studentTimeSlots={};
let dailyPracticeRecords={};
let practiceSessionTracker=new Map();
let lastPracticeSessionSweep=0;
const PRACTICE_UPDATE_INTERVAL_MS=60000;

/* ==== 增量练琴写入节流 ==== */
const SYNC_INCREMENT_INTERVAL_MS=90000; // 90秒写云端一次（可调）
let lastIncrementSync=0;

/* ==== Snapshot 过期阈值 ==== */
const SNAPSHOT_STALE_MS=2*60*1000; // 2分钟

/* =============== 工具函数 =============== */
function addSyncLog(msg){const time=new Date().toLocaleString();syncLogs.unshift(`[${time}] ${msg}`);if(syncLogs.length>300)syncLogs.length=300;const box=document.getElementById('syncLogs');if(box) box.textContent=syncLogs.join('\n');}
function updateConnectionStatus(){const el=document.getElementById('connectionStatus');if(!el)return;if(isOnline){el.className='connection-status online';el.innerHTML='<span>'+t('status.online','已连接')+'</span>';}else{el.className='connection-status offline';el.innerHTML='<span>'+t('status.offline','离线模式')+'</span>';}}
function formatDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function initClock(){(function loop(){const now=new Date();const el=document.getElementById('currentTime');if(el)el.textContent=now.toLocaleString(currentLanguage==='zh'?'zh-CN':'en-US');setTimeout(loop,1000);})();}
function setText(id,v){const el=document.getElementById(id);if(el)el.textContent=v;}
function timeToMinutes(str){if(!str||typeof str!=='string')return 0;const p=str.split(':');if(p.length!==2)return 0;const h=parseInt(p[0],10),m=parseInt(p[1],10);if(isNaN(h)||isNaN(m))return 0;return h*60+m;}
function getTodayDateString(){return formatDate(new Date());}
function flattenStudents(){const arr=[];Object.keys(studentDatabase).forEach(major=>{const list=studentDatabase[major];if(Array.isArray(list)){list.forEach(s=>{if(typeof s==='string')arr.push({name:s,major});else if(s&&typeof s==='object')arr.push({name:s.name,major,grade:s.grade||''});});}});return arr;}
function getStudentInfo(name){for(const [major,arr] of Object.entries(studentDatabase)){if(Array.isArray(arr)){for(const s of arr){if(typeof s==='string'&&s===name)return {name,major,grade:''};if(typeof s==='object'&&s.name===name)return {name,major,grade:s.grade||''};}}}return {name,major:t('student.unknown_major','未知专业'),grade:''};}

/* =============== 模态框优化控制 =============== */
/* =============== 模态框优化控制 =============== */
function closeModal(id) {
    const ids = id ? [id] : ['studentDetailModal', 'attendanceDetailModal'];
    let closed = false;
    
    ids.forEach(cid => {
        const el = document.getElementById(cid);
        if (el && el.classList.contains('show')) {
            el.classList.add('hiding');
            el.classList.remove('show');
            closed = true;
            
            // 🔥 优化：根据设备类型使用不同的延迟时间
            const isMobile = window.innerWidth <= 768;
            const delay = isMobile ? 350 : 300; // 移动端稍长的动画时间
            
            setTimeout(() => {
                if (el.classList.contains('hiding')) {
                    el.style.display = 'none';
                    el.classList.remove('hiding');
                }
            }, delay);
        }
    });
    
    if (closed) {
        // 🔥 优化：延迟恢复滚动，等待动画完成
        const isMobile = window.innerWidth <= 768;
        const scrollDelay = isMobile ? 100 : 50;
        
        setTimeout(() => {
            document.body.classList.remove('modal-open');
            
            if (document.body.dataset.scrollY) {
                const scrollY = document.body.dataset.scrollY;
                document.body.style.cssText = '';
                window.scrollTo(0, parseInt(scrollY));
                delete document.body.dataset.scrollY;
            }
        }, scrollDelay);
    }
}

// 🔥 优化模态框打开函数
function openModalSmooth(modalId, contentHtml) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    // 设置内容
    if (contentHtml) {
        modal.querySelector('.modal-content').innerHTML = contentHtml;
    }
    
    // 🔥 防止背景滚动
    if (!document.body.classList.contains('modal-open')) {
        const scrollY = window.scrollY;
        document.body.dataset.scrollY = scrollY;
        document.body.style.cssText = `
            position: fixed !important;
            top: -${scrollY}px !important;
            width: 100% !important;
            overflow: hidden !important;
        `;
    }
    document.body.classList.add('modal-open');
    
    // 🔥 显示模态框
    modal.style.display = 'flex';
    
    // 🔥 使用 requestAnimationFrame 确保流畅动画
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            modal.classList.add('show');
        });
    });
}




/* =============== Firebase 初始化与监听 =============== */
function initFirebase(){
  try{
    firebase.initializeApp(firebaseConfig);
    database=firebase.database();
    database.ref('.info/connected').on('value',snap=>{
      isOnline=snap.val()===true;
      updateConnectionStatus();
      if(isOnline){addSyncLog('✅ 已连接云端');loadAllCoreData();}else addSyncLog('⚠️ 已离线');
    });
    database.ref('rooms').on('value',snap=>{
      const v=snap.val();if(Array.isArray(v)){rooms=v;buildRealTimePracticeFromRooms();if(currentTab==='dashboard')renderPracticeArea();updateStatsPanel();}
    });
    database.ref('studentDatabase').on('value',snap=>{
      const v=snap.val();if(v){studentDatabase=v;populateFilters();if(currentTab==='students')renderStudentList();updateStatsPanel();}
    });
    database.ref('excuseData').on('value',snap=>{
      const v=snap.val();if(v){excuseData=v;if(currentTab==='dashboard')renderExcusePanel();updateStatsPanel();}
    });
    database.ref('studentTimeSlots').on('value',snap=>{
      studentTimeSlots=snap.val()||{};addSyncLog('📥 已同步 studentTimeSlots');
    });
    database.ref('attendanceRecords').on('value',snap=>{
      const v=snap.val();if(v&&typeof v==='object'){const cutoff=new Date();cutoff.setDate(cutoff.getDate()-30);const cutoffStr=formatDate(cutoff);Object.keys(v).forEach(d=>{if(d>=cutoffStr)attendanceRecordsCache[d]=v[d];});addSyncLog('📥 已同步考勤记录');if(currentTab==='students')renderStudentList();}
    });
    database.ref('practiceRecords').on('value',snap=>{
      const v=snap.val();if(v&&typeof v==='object'){Object.keys(v).forEach(dateKey=>{if(!dailyPracticeRecords[dateKey])dailyPracticeRecords[dateKey]={};Object.keys(v[dateKey]).forEach(student=>{const cloud=v[dateKey][student];const local=dailyPracticeRecords[dateKey][student];if(!local||cloud.lastUpdated>local.lastUpdated){dailyPracticeRecords[dateKey][student]=cloud;try{localStorage.setItem('practiceRecords_'+dateKey,JSON.stringify(dailyPracticeRecords[dateKey]));}catch(e){}}});});addSyncLog('📥 已同步练琴记录');}
    });

    // 定期清理过期本地缓存
    setInterval(()=>{
      const cutoff=new Date();cutoff.setDate(cutoff.getDate()-30);const cut=formatDate(cutoff);
      Object.keys(attendanceRecordsCache).forEach(d=>{if(d<cut)delete attendanceRecordsCache[d];});
      Object.keys(dailyPracticeRecords).forEach(d=>{if(d<cut){delete dailyPracticeRecords[d];localStorage.removeItem('practiceRecords_'+d);}});
      addSyncLog('🧹 已清理过期数据');
    },24*60*60*1000);
  }catch(e){addSyncLog('❌ Firebase 初始化失败: '+e.message);console.error(e);}
}

/* =============== 练琴实时/会话 =============== */
function buildRealTimePracticeFromRooms(){
  const now=Date.now(),map={},active=new Set();
  rooms.forEach(r=>{
    if(r&&r.student&&r.registerTime){
      const reg=Number(r.registerTime);
      if(!isNaN(reg)&&reg>0&&(now-reg)<12*3600*1000){
        const sec=Math.max(0,Math.floor((now-reg)/1000));
        map[r.student]={room:r.name,startTime:reg,currentSec:sec};
        const sid=`${r.student}__${r.name}__${r.registerTime}`;
        active.add(sid);
        if(!practiceSessionTracker.has(sid)) startPracticeSession(r.student,r.name,r.registerTime);
      }
    }
  });
  for(const [sid,sess] of practiceSessionTracker.entries()){
    if(!active.has(sid)) endPracticeSession(sid,Date.now(),'房间释放');
  }
  realTimePracticeMap=map;
}
function getStudentTodaySlots(name){
  const wd=new Date().getDay();
  const M={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const key=M[wd];if(!key||!studentTimeSlots[name])return [];
  return studentTimeSlots[name][key]||[];
}
function findCurrentTimeSlot(slots,ts){
  const d=new Date(ts);
  const m=d.getHours()*60+d.getMinutes();
  const weekday = d.getDay(); // 0=周日, 1=周一, ..., 6=周六
  
  // 检查是否在排除时间内
  if (isExcludedTime(m, weekday)) {
    return null; // 排除时间不算在时间段内
  }
  
  return slots.find(s=>{const sm=timeToMinutes(s.start),em=timeToMinutes(s.end);return m>=sm&&m<em;})||null;
}

// 新增：判断是否为排除时间的函数
function isExcludedTime(minutes, weekday) {
  // 每天晚上21:30以后不计入练琴时长
  if (minutes >= 21 * 60 + 30) { // 21:30 = 1290分钟
    return true;
  }
  
  // 周一、周二、周四、周五的用餐时间
  if (weekday === 1 || weekday === 2 || weekday === 4 || weekday === 5) {
    // 中午12:00-13:00
    if (minutes >= 12 * 60 && minutes < 13 * 60) {
      return true;
    }
    // 晚上18:00-19:00
    if (minutes >= 18 * 60 && minutes < 19 * 60) {
      return true;
    }
  }
  
  // 周三的用餐时间
  if (weekday === 3) {
    // 中午12:00-13:30
    if (minutes >= 12 * 60 && minutes < 13 * 60 + 30) {
      return true;
    }
    // 晚上18:30-19:30
    if (minutes >= 18 * 60 + 30 && minutes < 19 * 60 + 30) {
      return true;
    }
  }
  
  return false;
}

// 🔥 修复 startPracticeSession 函数，确保初始值正确
function startPracticeSession(student, room, registerTime){
  const sid = `${student}__${room}__${registerTime}`;
  if(practiceSessionTracker.has(sid)) return practiceSessionTracker.get(sid);
  
  const now = Date.now();
  const slots = getStudentTodaySlots(student);
  const cur = findCurrentTimeSlot(slots, now);
  
  const sess = {
    sessionId: sid,
    studentName: student,
    roomName: room,
    startTime: Number(registerTime) || now, // 🔥 确保是数字
    prepEndTime: (Number(registerTime) || now) + 60000,
    actualStartTime: null,
    endTime: null,
    inSlotTime: 0,        // 🔥 明确初始化为 0
    outSlotTime: 0,       // 🔥 明确初始化为 0
    currentSlot: cur,
    slotTransitions: [],
    isActive: true,
    _lastTick: now
  };
  
  practiceSessionTracker.set(sid, sess);
  console.log(`开始练琴会话: ${student} 在 ${room}`);
  return sess;
}

function endPracticeSession(sid, endTime, reason = '结束'){
  const sess = practiceSessionTracker.get(sid);
  if(!sess || !sess.isActive) return;
  
  sess.isActive = false;
  sess.endTime = Number(endTime) || Date.now(); // 🔥 确保是数字
  sess.endReason = reason;
  
  // 🔥 如果练琴时间太短（小于1分钟），直接删除不记录
  if(sess.endTime < sess.prepEndTime) {
    console.log(`练琴时间过短，不记录: ${sess.studentName}`);
    practiceSessionTracker.delete(sid);
    return;
  }
  
  // 🔥 设置实际开始时间
  if(!sess.actualStartTime) {
    sess.actualStartTime = sess.prepEndTime;
  }
  
  // 🔥 重新计算时长
  try {
    recalcSessionTimes(sess);
    
    // 🔥 最终验证
    if(isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
      console.error(`结束会话时发现NaN: ${sess.studentName}`);
      sess.inSlotTime = 0;
      sess.outSlotTime = 0;
    }
    
    // 🔥 只有有效时长才记录
    if(sess.inSlotTime > 0 || sess.outSlotTime > 0) {
      recordDailyPractice(sess);
    } else {
      console.log(`无有效练琴时长，不记录: ${sess.studentName}`);
    }
  } catch(e) {
    console.error(`结束会话时出错: ${sess.studentName}`, e);
  }
  
  practiceSessionTracker.delete(sid);
}
function recalcSessionTimes(sess){
  // 🔥 初始化默认值
  sess.inSlotTime = 0;
  sess.outSlotTime = 0;
  
  const endTime = sess.endTime || Date.now();
  
  if(!sess.actualStartTime || sess.actualStartTime >= endTime) {
    console.log(`会话时间无效: ${sess.studentName}, start=${sess.actualStartTime}, end=${endTime}`);
    return;
  }
  
  // 🔥 确保时间范围合理（不超过24小时）
  const maxDuration = 24 * 60 * 60 * 1000; // 24小时
  const actualEndTime = Math.min(endTime, sess.actualStartTime + maxDuration);
  
  const startMin = Math.floor(sess.actualStartTime / 60000) * 60000;
  const endMin = Math.floor(actualEndTime / 60000) * 60000;
  const slots = getStudentTodaySlots(sess.studentName);
  
  let inSeconds = 0;
  let outSeconds = 0;
  
  // 🔥 按分钟遍历时间段
  for(let t = startMin; t < endMin; t += 60000) {
    try {
      const currentDate = new Date(t);
      const currentMinutes = currentDate.getHours() * 60 + currentDate.getMinutes();
      const currentWeekday = currentDate.getDay();
      
      // 只有不在排除时间内才计入练琴时长
      if (!isExcludedTime(currentMinutes, currentWeekday)) {
        const slot = findCurrentTimeSlot(slots, t);
        if(slot) {
          inSeconds += 60;
        } else {
          outSeconds += 60;
        }
      }
    } catch(e) {
      console.error(`计算时间段出错: ${new Date(t)}, 错误:`, e);
      break;
    }
  }
  
  // 🔥 最终验证和赋值
  sess.inSlotTime = Math.max(0, Math.floor(inSeconds));
  sess.outSlotTime = Math.max(0, Math.floor(outSeconds));
  
  // 🔥 验证结果
  if(isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
    console.error(`计算结果为NaN: ${sess.studentName}, in=${inSeconds}, out=${outSeconds}`);
    sess.inSlotTime = 0;
    sess.outSlotTime = 0;
  }
  
  console.log(`重新计算时长: ${sess.studentName}, 段内=${Math.round(sess.inSlotTime/60)}分钟, 段外=${Math.round(sess.outSlotTime/60)}分钟`);
}
function recordDailyPractice(sess){
  try {
    const dk = formatDate(new Date(sess.startTime));
    
    // 🔥 验证输入数据
    if(!sess.studentName || !dk) {
      console.error('无效的会话数据:', sess);
      return;
    }
    
    // 🔥 验证时长数据
    let inSlotTime = Number(sess.inSlotTime) || 0;
    let outSlotTime = Number(sess.outSlotTime) || 0;
    
    if(isNaN(inSlotTime) || isNaN(outSlotTime)) {
      console.error(`时长数据为NaN: ${sess.studentName}, in=${sess.inSlotTime}, out=${sess.outSlotTime}`);
      inSlotTime = 0;
      outSlotTime = 0;
    }
    
    // 🔥 合理性检查（不超过24小时）
    const maxSeconds = 24 * 60 * 60;
    if(inSlotTime > maxSeconds || outSlotTime > maxSeconds) {
      console.error(`时长数据异常: ${sess.studentName}, in=${inSlotTime}, out=${outSlotTime}`);
      return;
    }
    
    // 🔥 如果时长为0，不记录
    if(inSlotTime === 0 && outSlotTime === 0) {
      console.log(`无有效时长，跳过记录: ${sess.studentName}`);
      return;
    }
    
    // 🔥 初始化数据结构
    if(!dailyPracticeRecords[dk]) {
      dailyPracticeRecords[dk] = {};
    }
    
    if(!dailyPracticeRecords[dk][sess.studentName]) {
      dailyPracticeRecords[dk][sess.studentName] = {
        inSlot: 0,
        outSlot: 0,
        totalSessions: 0,
        sessions: [],
        lastUpdated: 0
      };
    }
    
    const rec = dailyPracticeRecords[dk][sess.studentName];
    
    // 🔥 确保 sessions 数组存在
    if(!Array.isArray(rec.sessions)) {
      rec.sessions = [];
    }
    
    // 🔥 更新累计数据
    rec.inSlot = (Number(rec.inSlot) || 0) + inSlotTime;
    rec.outSlot = (Number(rec.outSlot) || 0) + outSlotTime;
    rec.totalSessions = (Number(rec.totalSessions) || 0) + 1;
    rec.lastUpdated = Date.now();
    
    // 🔥 添加会话记录
    rec.sessions.push({
      room: sess.roomName || '练琴房',
      start: sess.startTime || Date.now(),
      end: sess.endTime || Date.now(),
      inSlot: inSlotTime,
      outSlot: outSlotTime,
      endReason: sess.endReason || '正常'
    });
    
    // 🔥 保存到本地存储
    try {
      localStorage.setItem('practiceRecords_' + dk, JSON.stringify(dailyPracticeRecords[dk]));
    } catch(e) {
      console.error('保存本地存储失败:', e);
    }
    
    // 🔥 同步到云端
    if(isOnline && database) {
      const cloudData = {
        inSlotSeconds: Math.floor(rec.inSlot),
        outSlotSeconds: Math.floor(rec.outSlot),
        totalSessions: Math.floor(rec.totalSessions),
        sessions: rec.sessions,
        lastUpdated: rec.lastUpdated,
        running: false
      };
      
      // 🔥 最终NaN检查
      Object.keys(cloudData).forEach(key => {
        if(typeof cloudData[key] === 'number' && (isNaN(cloudData[key]) || !isFinite(cloudData[key]))) {
          console.error(`发现无效数值 ${key}: ${cloudData[key]}`);
          if(key === 'inSlotSeconds' || key === 'outSlotSeconds') {
            cloudData[key] = 0;
          } else if(key === 'totalSessions') {
            cloudData[key] = 1;
          } else if(key === 'lastUpdated') {
            cloudData[key] = Date.now();
          }
        }
      });
      
      database.ref(`practiceRecords/${dk}/${sess.studentName}`).set(cloudData)
        .then(() => {
          console.log(`云端同步成功: ${sess.studentName}, 段内${Math.round(inSlotTime/60)}分钟, 段外${Math.round(outSlotTime/60)}分钟`);
        })
        .catch(e => {
          console.error('云端同步失败:', e);
        });
    }
    
    addSyncLog(`📝 记录练琴: ${sess.studentName} 段内${Math.round(inSlotTime/60)}分钟 段外${Math.round(outSlotTime/60)}分钟`);
    
  } catch(e) {
    console.error('recordDailyPractice 出错:', e, sess);
  }
}

function getStudentPracticeRecord(name,dk){
  if(!dk)dk=getTodayDateString();
  if(dailyPracticeRecords[dk]&&dailyPracticeRecords[dk][name])return dailyPracticeRecords[dk][name];
  if(!dailyPracticeRecords[dk]){
    const raw=localStorage.getItem('practiceRecords_'+dk);
    if(raw){try{dailyPracticeRecords[dk]=JSON.parse(raw);}catch(e){dailyPracticeRecords[dk]={};}}
  }
  if(dailyPracticeRecords[dk]&&dailyPracticeRecords[dk][name])return dailyPracticeRecords[dk][name];
  // 触发一次异步获取（不阻塞）
  if(isOnline&&database){
    database.ref(`practiceRecords/${dk}/${name}`).once('value').then(s=>{
      const v=s.val();if(v){if(!dailyPracticeRecords[dk])dailyPracticeRecords[dk]={};dailyPracticeRecords[dk][name]=v;
        try{localStorage.setItem('practiceRecords_'+dk,JSON.stringify(dailyPracticeRecords[dk]));}catch(e){}
      }
    });
  }
  return {inSlot:0,outSlot:0,totalSessions:0,sessions:[],lastUpdated:0};
}
function estimateLiveSessionInOut(sess){
  if(!sess.isActive)return null;
  const now=Date.now();if(now<sess.prepEndTime)return {tempIn:0,tempOut:0};
  const baseIn=sess.inSlotTime,baseOut=sess.outSlotTime;
  let extra=0;
  if(sess._lastTick){
    const dt=Math.floor((now-sess._lastTick)/1000);
    if(dt>0&&dt<900)extra=dt;
  }
  const cur=findCurrentTimeSlot(getStudentTodaySlots(sess.studentName),now);
  if(cur)return {tempIn:baseIn+extra,tempOut:baseOut};
  return {tempIn:baseIn,tempOut:baseOut+extra};
}

/* =============== ✅ 实时考勤增强：增量练琴时长同步 =============== */
// 🔥 修复 5: 增强 syncActiveSessionsIncrement 函数
function syncActiveSessionsIncrement(){
  const now = Date.now();
  if(now - lastIncrementSync < SYNC_INCREMENT_INTERVAL_MS) return;
  lastIncrementSync = now;
  const today = getTodayDateString();
  
  practiceSessionTracker.forEach(sess => {
    if(!sess.isActive) return;
    if(Date.now() < sess.prepEndTime) return;
    
    try {
      // 🔥 临时计算当前时长
      const tempEndTime = sess.endTime;
      sess.endTime = now;
      recalcSessionTimes(sess);
      sess.endTime = tempEndTime; // 恢复原值
      
      // 🔥 验证计算结果
      if(isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
        console.error(`增量同步时发现NaN: ${sess.studentName}`);
        return;
      }
      
      if(!dailyPracticeRecords[today]) {
        dailyPracticeRecords[today] = {};
      }
      
      if(!dailyPracticeRecords[today][sess.studentName]) {
        dailyPracticeRecords[today][sess.studentName] = {
          inSlot: 0,
          outSlot: 0,
          totalSessions: 0,
          sessions: [],
          lastUpdated: 0
        };
      }
      
      const rec = dailyPracticeRecords[today][sess.studentName];
      
      // 🔥 更新累计时长
      rec.inSlot = Math.max(0, Math.floor(sess.inSlotTime));
      rec.outSlot = Math.max(0, Math.floor(sess.outSlotTime));
      rec.lastUpdated = now;
      
      // 🔥 保存到本地
      try {
        localStorage.setItem('practiceRecords_' + today, JSON.stringify(dailyPracticeRecords[today]));
      } catch(e) {
        console.error('增量同步本地存储失败:', e);
      }
      
      // 🔥 同步到云端
      if(isOnline && database) {
        const updateData = {
          inSlotSeconds: rec.inSlot,
          outSlotSeconds: rec.outSlot,
          lastUpdated: rec.lastUpdated,
          totalSessions: rec.totalSessions || 0,
          running: true
        };
        
        // 🔥 验证数据
        Object.keys(updateData).forEach(key => {
          if(typeof updateData[key] === 'number' && (isNaN(updateData[key]) || !isFinite(updateData[key]))) {
            console.error(`增量同步发现无效数值 ${key}: ${updateData[key]}`);
            updateData[key] = 0;
          }
        });
        
        database.ref(`practiceRecords/${today}/${sess.studentName}`).update(updateData)
          .catch(e => console.error('增量同步失败:', e));
      }
      
    } catch(e) {
      console.error(`增量同步出错: ${sess.studentName}`, e);
    }
  });
}
/* =============== 出勤状态 / 统计 =============== */
function shouldStudentBePresent(name,wd,curMin){
  if(wd===0||wd===6)return false;
  const map={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const key=map[wd];
  if(!key||!studentTimeSlots[name]||!studentTimeSlots[name][key])return false;
  return studentTimeSlots[name][key].some(s=>{
    const sm=timeToMinutes(s.start),em=timeToMinutes(s.end);
    return curMin>=sm&&curMin<em;
  });
}
function getStudentCurrentStatus(name,presentSet,excuses,wd,curMin){
  if(excuses[name])return 'excused';
  if(presentSet.has(name))return 'present';
  const map={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const key=map[wd];
  if(!key||!studentTimeSlots[name]||!studentTimeSlots[name][key])return 'pending';
  const slots=studentTimeSlots[name][key];
  let hasCurrent=false,hasPassed=false,hasFuture=false;
  slots.forEach(sl=>{
    const sm=timeToMinutes(sl.start),em=timeToMinutes(sl.end);
    if(curMin>=sm&&curMin<em)hasCurrent=true;
    else if(curMin>=em)hasPassed=true;
    else if(curMin<sm)hasFuture=true;
  });
  if(hasCurrent)return 'absent'; // 在段内但不在房间
  if(hasPassed&&!hasFuture)return 'absent';
  if(hasPassed&&hasFuture)return 'pending';
  return 'pending';
}
function getStatusClass(s){
  switch(s){
    case 'present':return 'present';
    case 'absent':return 'absent';
    case 'excused':return 'excused';
    case 'pending':return 'pending';
    case 'self_practice':return 'present'; // 🔥 修改：使用绿色样式，和出勤一样
    case 'not_practicing':return 'not-practicing'; // 灰色样式
    default:return 'pending';
  }
}
function getStatusText(s){
  switch(s){
    case 'present':return t('status.present','出勤');
    case 'absent':return t('status.absent','缺勤');
    case 'excused':return t('status.excused','请假');
    case 'pending':return t('status.pending','待考勤');
    case 'low_efficiency':return t('status.low_efficiency','低效');
    default:return t('status.pending','待考勤');
  }
}
function updateStatsPanel(){
  const students=flattenStudents();
  const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
  const today=formatDate(new Date());
  const excuses=excuseData[today]||{};
  const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
  let present=0,absent=0,excused=0,pending=0;
  students.forEach(s=>{
    const st=getStudentCurrentStatus(s.name,presentSet,excuses,wd,curMin);
    if(st==='present')present++;
    else if(st==='absent')absent++;
    else if(st==='excused')excused++;
    else pending++;
  });
  setText('presentCount',present);
  setText('absentCount',absent);
  setText('excusedCount',excused);
  setText('pendingCount',pending);
}

/* =============== 实时练琴列表 =============== */
function formatDuration(sec, mode='auto'){
  // mode = 'auto' | 'minuteOnly'
  if(sec==null || isNaN(sec)) return currentLanguage==='en' ? '0min' : '0分钟';
  sec = Math.max(0, Math.floor(sec)); // 统一转为整数秒
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;

  if(currentLanguage === 'en'){
    if(h){
      if(m) return `${h}h ${m}m`;
      return `${h}h`;
    }
    if(m){
      if(s && mode!=='minuteOnly') return `${m}m ${s}s`;
      return `${m}m`;
    }
    return `${s}s`;
  }else{
    if(h){
      if(m) return `${h}小时${m}分钟`;
      return `${h}小时`;
    }
    if(m){
      if(s && mode!=='minuteOnly') return `${m}分钟${s}秒`;
      return `${m}分钟`;
    }
    return `${s}秒`;
  }
}

function renderPracticeArea(){
  const el=document.getElementById('practiceStatusContainer');if(!el)return;
  const names=Object.keys(realTimePracticeMap);
  if(!names.length){
    el.innerHTML=`<div class="practice-filters"><div class="practice-filter-row">
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.major','专业筛选')}</label>
      <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
        <option value="">${t('filter.all_majors','所有专业')}</option></select></div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.grade','年级筛选')}</label>
      <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
        <option value="">${t('filter.all_grades','所有年级')}</option></select></div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.search','搜索学生')}</label>
      <input id="practiceStudentSearch" class="practice-filter-input" placeholder="${t('filter.search_placeholder','输入学生姓名...')}" oninput="filterPracticeStatus()"></div>
    </div>
    <div id="practiceStudentList" class="student-grid" style="margin-top:20px;">
      <div class="practice-empty-state" style="grid-column:1/-1;">
        <div class="practice-empty-state-icon">🎵</div>
        <div class="practice-empty-state-title">${t('practice.empty.title','当前没有学生在练琴')}</div>
        <div class="practice-empty-state-description">${t('practice.empty.desc.weekday','等待学生开始练琴')}</div>
      </div>
    </div></div>`;
    return;
  }
  names.sort((a,b)=>realTimePracticeMap[b].currentSec-realTimePracticeMap[a].currentSec);
  const majors=new Set(),grades=new Set();
  names.forEach(n=>{const info=getStudentInfo(n);if(info.major)majors.add(info.major);if(info.grade)grades.add(info.grade);});
  let mf=[...majors].sort().map(m=>`<option value="${m}">${m}</option>`).join('');
  let gf=[...grades].sort().map(g=>`<option value="${g}">${g}</option>`).join('');
  let cards=names.map(n=>{
      const info=getStudentInfo(n),p=realTimePracticeMap[n];
      const st=new Date(p.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'});
      // 🔥 获取当前时间信息用于状态判断
      const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
      const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
      const todayExcuses=excuseData[getTodayDateString()]||{};
      const currentStatus=getStudentCurrentStatus(n,presentSet,todayExcuses,wd,curMin);
      const statusText=getDetailedStatusText(n,currentStatus,p,wd,curMin);
      const statusClass=getStatusClass(currentStatus);
      
      return `<div class="practice-status-card compact ${statusClass}" onclick="openStudentDetail('${n}')">
        <div class="practice-indicator"></div>
        <div class="compact-content">
          <div class="student-name-compact">${n}</div>
          <div class="student-info-row"><span>${info.major||''}</span><span class="info-divider">•</span><span>${info.grade||t('student.not_set','未设置')}</span></div>
          <div class="student-info-row"><span>🕐 ${st}</span><span class="info-divider">•</span><span>🏠 ${p.room}</span></div>
          <div class="status-duration-row">
            <div class="student-status-compact ${statusClass}">${statusText}</div>
            <div class="practice-duration-large">${formatDuration(p.currentSec)}</div>
          </div>
        </div></div>`;
    }).join('');
  el.innerHTML=`
  <div class="practice-filters">
    <div class="practice-filter-row">
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.major','专业筛选')}</label>
        <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
          <option value="">${t('filter.all_majors','所有专业')}</option>${mf}
        </select>
      </div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.grade','年级筛选')}</label>
        <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
          <option value="">${t('filter.all_grades','所有年级')}</option>${gf}
        </select>
      </div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.search','搜索学生')}</label>
        <input type="text" id="practiceStudentSearch" class="practice-filter-input" placeholder="${t('filter.search_placeholder','输入学生姓名...')}" oninput="filterPracticeStatus()">
      </div>
    </div>
    <div id="practiceStudentList" class="student-grid" style="margin-top:20px;">${cards}</div>
  </div>`;
}
function filterPracticeStatus(){
  const major=document.getElementById('practiceMajorFilter')?.value||'';
  const grade=document.getElementById('practiceGradeFilter')?.value||'';
  const kw=document.getElementById('practiceStudentSearch')?.value.trim().toLowerCase()||'';
  const list=document.getElementById('practiceStudentList');
  if(!list)return;
  let names=Object.keys(realTimePracticeMap);
  names=names.filter(n=>{
    const info=getStudentInfo(n);
    if(major && info.major!==major) return false;
    if(grade && info.grade!==grade) return false;
    if(kw && !n.toLowerCase().includes(kw)) return false;
    return true;
  });
  if(!names.length){
    list.innerHTML=`<div class="practice-empty-state" style="grid-column:1/-1;">
      <div class="practice-empty-state-icon">🔍</div>
      <div class="practice-empty-state-title">${t('filter.no_results','没有符合条件的学生')}</div>
      <div class="practice-empty-state-description">${t('filter.try_different','请尝试调整筛选条件')}</div>
    </div>`;
    return;
  }
  names.sort((a,b)=>realTimePracticeMap[b].currentSec-realTimePracticeMap[a].currentSec);
  list.innerHTML=names.map(n=>{
    const info=getStudentInfo(n),p=realTimePracticeMap[n];
    const st=new Date(p.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'});
    return `<div class="practice-status-card compact" onclick="openStudentDetail('${n}')">
      <div class="practice-indicator"></div>
      <div class="compact-content">
        <div class="student-name-compact">${n}</div>
        <div class="student-info-row"><span>${info.major||''}</span><span class="info-divider">•</span><span>${info.grade||''}</span></div>
        <div class="student-info-row"><span>🕐 ${st}</span><span class="info-divider">•</span><span>🏠 ${p.room}</span></div>
        <div class="practice-duration-large">${formatDuration(p.currentSec)}</div>
      </div></div>`;
  }).join('');
}

/* =============== 学生列表 =============== */
function populateFilters(){
  const majorSel=document.getElementById('majorFilter');
  const gradeSel=document.getElementById('gradeFilter');
  if(majorSel){
    const cur=majorSel.value;
    majorSel.innerHTML=`<option value="">${t('filter.all_majors','所有专业')}</option>`+
      Object.keys(studentDatabase).sort().map(m=>`<option value="${m}">${m}</option>`).join('');
    if(cur && Object.keys(studentDatabase).includes(cur))majorSel.value=cur;
  }
  if(gradeSel){
    const set=new Set();flattenStudents().forEach(s=>{if(s.grade)set.add(s.grade);});
    const cur=gradeSel.value;
    gradeSel.innerHTML=`<option value="">${t('filter.all_grades','所有年级')}</option>`+
      [...set].sort().map(g=>`<option value="${g}">${g}</option>`).join('');
    if(cur && set.has(cur))gradeSel.value=cur;
  }
}
function renderStudentList(){
  const container=document.getElementById('studentList');if(!container)return;
  const all=flattenStudents();
  if(!all.length){container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">📂</div><div class="empty-state-title">${t('empty.no_students','暂无学生数据')}</div></div>`;return;}
  const major=document.getElementById('majorFilter').value;
  const grade=document.getElementById('gradeFilter').value;
  const status=document.getElementById('statusFilter').value;
  const kw=document.getElementById('studentSearch').value.trim().toLowerCase();
  const today=formatDate(new Date());
  const excuses=excuseData[today]||{};
  const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
  const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
  let list = all.filter(s => {
    if (major && s.major !== major) return false;
    if (grade && s.grade !== grade) return false;
    if (kw && !s.name.toLowerCase().includes(kw)) return false;
    
    const p = realTimePracticeMap[s.name];
    const basicStatus = getStudentCurrentStatus(s.name, presentSet, excuses, wd, curMin);
    const detailedStatus = getDetailedStatus(s.name, basicStatus, p, wd, curMin);
    
    s._status = basicStatus;        // 用于样式类
    s._detailedStatus = detailedStatus; // 用于筛选
    
    if (status && status !== detailedStatus) return false;
    return true;
  });

  if(!list.length){container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">🔍</div><div class="empty-state-title">${t('filter.no_results','没有符合条件的学生')}</div></div>`;return;}
  list.sort((a,b)=>a.name.localeCompare(b.name,'zh-CN'));
  container.innerHTML = list.map(s => {
    const p = realTimePracticeMap[s.name];
    const room = p ? p.room : t('student.not_in_room','不在琴房');
    const dur = p ? formatDuration(p.currentSec) : t('time.no_practice','0分钟');
    
    // 🔥 修改：使用详细状态来确定样式类
    const detailedStatus = getDetailedStatus(s.name, s._status, p, wd, curMin);
    const cls = getStatusClass(detailedStatus);
    const statusText = getDetailedStatusText(s.name, s._status, p, wd, curMin);
    
    return `<div class="practice-status-card compact ${cls}" onclick="openStudentDetail('${s.name}')">
      ${p ? '<div class="practice-indicator"></div>' : ''}
      <div class="compact-content">
        <div class="student-name-compact">${s.name}</div>
        <div class="student-info-row"><span>${s.major||''}</span><span class="info-divider">•</span><span>${s.grade||t('student.not_set','未设置')}</span></div>
        <div class="student-info-row"><span>${room}</span></div>
        <div class="status-duration-row">
          <div class="student-status-compact ${cls}">${statusText}</div>
          <div class="practice-duration-large">${dur}</div>
        </div>
      </div></div>`;
  }).join('');
}
function filterStudents(){renderStudentList();}
function getDetailedStatus(studentName, currentStatus, practice, weekday, currentMinute) {
  // 如果是请假，直接返回请假状态
  if (currentStatus === 'excused') {
    return 'excused';
  }
  
  // 获取学生今天的时间段
  const slotDayMap = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = slotDayMap[weekday];
  
  // 检查是否在时间段内
  let inTimeSlot = false;
  if (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) {
    const slots = studentTimeSlots[studentName][key];
    inTimeSlot = slots.some(slot => {
      const startMin = timeToMinutes(slot.start);
      const endMin = timeToMinutes(slot.end);
      return currentMinute >= startMin && currentMinute < endMin;
    });
  }
  
  if (inTimeSlot) {
    // 在时间段内：根据是否在琴房判断状态
    if (practice) {
      return 'present'; // 在琴房练琴
    } else {
      return 'absent'; // 不在琴房
    }
  } else {
    // 不在时间段内：根据是否在琴房显示自主练琴状态
    if (practice) {
      return 'self_practice'; // 自主练琴
    } else {
      return 'not_practicing'; // 目前未练琴
    }
  }
}

/* =============== 请假面板 =============== */
function renderExcusePanel(){
  const today=formatDate(new Date());
  const data=excuseData[today]||{};
  const keys=Object.keys(data);
  const panel=document.getElementById('excuseInfoPanel');
  const box=document.getElementById('excuseInfoContainer');
  if(!keys.length){panel.style.display='none';return;}
  panel.style.display='block';
  box.innerHTML='<div class="student-grid">'+keys.map(n=>{
    const ex=data[n];
    return `<div class="student-card excused" style="min-height:180px;">
      <div class="student-header">
        <div class="student-name">${n}</div>
        <div class="student-status excused">${t('status.excused','请假')}</div>
      </div>
      <div class="student-details">
        <div class="detail-item"><div class="detail-label">${t('excuse.reason','请假原因')}</div><div class="detail-value">${ex.reason||t('excuse.not_filled','未填写')}</div></div>
        ${ex.durationText?`<div class="detail-item"><div class="detail-label">${t('excuse.duration_text','请假时长')}</div><div class="detail-value">${ex.durationText}</div></div>`:''}
        ${ex.endDate?`<div class="detail-item"><div class="detail-label">${t('excuse.end_date','结束日期')}</div><div class="detail-value">${ex.endDate}</div></div>`:''}
      </div></div>`;
  }).join('')+'</div>';
}

/* =============== ✅ 实时考勤增强：实时 / 快照 / 合并构建函数 =============== */

/**** ======= 新增辅助函数 开始 ======= ****/

/**
 * 获取学生今天所有练琴区间（含正在进行的）
 * 每个区间：{ start: ms, end: ms, room: string }
 * prep 时间（首分钟）不计入正式时长：start 用 prepEndTime
 */
function getStudentTodayIntervals(studentName){
  const todayKey = getTodayDateString();
  const intervals = [];

  // 1. 已结束会话（优先使用详细的 sessions 数据）
  const rec = dailyPracticeRecords[todayKey] && dailyPracticeRecords[todayKey][studentName];
  if(rec && Array.isArray(rec.sessions)){
    rec.sessions.forEach(s=>{
      if(!s.start || !s.end) return;
      const start = s.start + 60000; // 去除1分钟准备
      if(start >= s.end) return;
      intervals.push({
        start,
        end: s.end,
        room: s.room || '练琴房'
      });
    });
  }

  // 2. 正在进行的会话（practiceSessionTracker）
  practiceSessionTracker.forEach(sess=>{
    if(!sess.isActive) return;
    if(sess.studentName !== studentName) return;
    const activeStart = Math.max(sess.prepEndTime, sess.startTime + 60000);
    const end = Date.now();
    if(activeStart < end){
      intervals.push({
        start: activeStart,
        end,
        room: sess.roomName
      });
    }
  });

  return intervals;
}

// 🔥 新增：数据一致性检查函数
function validatePracticeData(studentName, date) {
  const rec = dailyPracticeRecords[date] && dailyPracticeRecords[date][studentName];
  if(!rec) return false;
  
  // 检查是否有详细会话记录
  if(!rec.sessions || !Array.isArray(rec.sessions) || rec.sessions.length === 0) {
    console.warn(`${studentName} ${date} 缺少详细会话记录`);
    return false;
  }
  
  // 检查累计时长是否与会话记录匹配
  let totalInSlot = 0, totalOutSlot = 0;
  rec.sessions.forEach(s => {
    totalInSlot += (s.inSlot || 0);
    totalOutSlot += (s.outSlot || 0);
  });
  
  const recordedInSlot = rec.inSlotSeconds || rec.inSlot || 0;
  const recordedOutSlot = rec.outSlotSeconds || rec.outSlot || 0;
  
  if(Math.abs(totalInSlot - recordedInSlot) > 60 || Math.abs(totalOutSlot - recordedOutSlot) > 60) {
    console.warn(`${studentName} ${date} 数据不一致: 会话累计(${totalInSlot},${totalOutSlot}) vs 记录(${recordedInSlot},${recordedOutSlot})`);
    return false;
  }
  
  return true;
}

/**
 * 计算一个区间数组与目标(timeStart,timeEnd) 的总重叠秒数
 */
function calcOverlapSeconds(intervals, slotStartMs, slotEndMs){
  // 先累计毫秒，再一次性 floor，避免浮点误差
  let totalMs = 0;
  for(const it of intervals){
    const st = Math.max(it.start, slotStartMs);
    const en = Math.min(it.end, slotEndMs);
    if(en > st){
      totalMs += (en - st);
    }
  }
  return Math.floor(totalMs / 1000); // 返回整数秒
}


/**
 * 选取与该 slot 重叠时长最多的房间（用于历史已结束 slot 的房间显示）
 */
function pickDominantRoom(intervals, slotStartMs, slotEndMs){
  const map = new Map();
  intervals.forEach(it=>{
    const st = Math.max(it.start, slotStartMs);
    const en = Math.min(it.end, slotEndMs);
    if(en > st){
      const sec = (en - st)/1000;
      map.set(it.room, (map.get(it.room)||0)+sec);
    }
  });
  let bestRoom = '';
  let maxSec = 0;
  for(const [room,sec] of map.entries()){
    if(sec > maxSec){
      maxSec = sec;
      bestRoom = room;
    }
  }
  return bestRoom;
}

/**** ======= 新增辅助函数 结束 ======= ****/


/**
 * 替换后的 buildRealtimeAttendanceDetail
 * 实现：利用当天所有练琴区间对每个排课 slot 做重叠计算
 */
function buildRealtimeAttendanceDetail(studentName, date){
  const detail = {present:0, absent:0, excused:0, lowEfficiency:0, pending:0, details:[]};
  
  // 1. 检查请假状态
  const excuses = excuseData[date] || {};
  if(excuses[studentName]){
    detail.excused++;
    detail.details.push({
      timeSlot: '全天',
      status: 'excused',
      practiceTime: '请假',
      room: '请假',
      statusText: '请假',
      excuseReason: excuses[studentName].reason || ''
    });
    return detail;
  }

  // 2. 获取日期信息
  const target = new Date(date);
  const wd = target.getDay();
  const map = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = map[wd];
  const isToday = (date === getTodayDateString());

  // 3. 获取学生当天的时间段安排
  const slots = (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) 
                  ? studentTimeSlots[studentName][key] : [];

  // 4. 🔥 修复：获取练琴区间（支持历史日期）
  const intervals = isToday ? getStudentTodayIntervals(studentName) : getHistoryIntervals(studentName, date);
  const now = isToday ? Date.now() : new Date(date + 'T23:59:59').getTime();

  // 5. 考勤判断的阈值常量
  const MIN_PRESENT_SEC = 5 * 60;         // >=5分钟才认可基本出勤
  const EFFICIENCY_RATIO = 0.6;           // 60% 时长达到才是"出勤"
  const MIN_ACTIVE_SEC_FOR_ONGOING = 60;  // 正在进行的段内重叠 < 60秒仍显示 pending

  // 6. 处理无时间段安排的情况
  if(!slots.length){
    detail.pending++;
    const activeRoom = intervals.length ? (intervals[intervals.length-1].room || '在琴房') : '无安排';
    const totalPracticeTime = intervals.length ? 
      formatDuration(calcOverlapSeconds(intervals, new Date(date).getTime(), now)) : '—';
    
    detail.details.push({
      timeSlot: (wd === 0 || wd === 6) ? '周末' : '无安排',
      status: intervals.length ? 'present' : 'pending',
      practiceTime: totalPracticeTime,
      room: intervals.length ? activeRoom : '无安排',
      statusText: intervals.length ? '出勤(段外)' : '待考勤'
    });
    
    if(intervals.length){
      detail.present++;
      detail.pending--;
    }
    return detail;
  }

  // 7. 处理每个时间段
  slots.forEach(slot => {
    const slotLabel = `${slot.start} - ${slot.end}`;
    const slotStartMs = new Date(`${date}T${slot.start}:00`).getTime();
    const slotEndMs = new Date(`${date}T${slot.end}:00`).getTime();
    const slotDurSec = (slotEndMs - slotStartMs) / 1000;

    let status = 'pending';
    let statusText = '待考勤';
    let practiceTime = '--';
    let room = '--';

    // 计算该时间段内的练琴重叠时长
    const overlapSec = calcOverlapSeconds(intervals, slotStartMs, slotEndMs);

    if(!isToday){
      // 历史日期：根据实际练琴时长判断
      if(overlapSec >= slotDurSec * EFFICIENCY_RATIO){
        status = 'present';
        statusText = '出勤';
      } else if(overlapSec >= MIN_PRESENT_SEC){
        status = 'low_efficiency';
        statusText = '低效';
      } else {
        status = 'absent';
        statusText = '缺勤';
      }
      
      practiceTime = overlapSec > 0 ? formatDuration(overlapSec, 'minuteOnly') : '0分钟';
      
      if(overlapSec > 0){
        room = pickDominantRoom(intervals, slotStartMs, slotEndMs) || '在琴房';
      } else {
        room = '不在琴房';
      }
    } else {
      // 今日实时判断
      if(now < slotStartMs){
        // 未来时间段
        status = 'pending';
        statusText = '待考勤';
      } else if(now >= slotEndMs){
        // 已结束时间段
        if(overlapSec >= slotDurSec * EFFICIENCY_RATIO){
          status = 'present';
          statusText = '出勤';
        } else if(overlapSec >= MIN_PRESENT_SEC){
          status = 'low_efficiency';
          statusText = '低效';
        } else {
          status = 'absent';
          statusText = '缺勤';
        }
        
        practiceTime = overlapSec > 0 ? formatDuration(overlapSec, 'minuteOnly') : '0分钟';
        
        if(overlapSec > 0){
          room = pickDominantRoom(intervals, slotStartMs, slotEndMs) || '在琴房';
        } else {
          room = '不在琴房';
        }
      } else {
        // 正在进行中的时间段
        const expectedSec = (now - slotStartMs) / 1000;
        
        if(overlapSec < MIN_ACTIVE_SEC_FOR_ONGOING){
          status = 'pending';
          statusText = '待考勤'; // 刚开始不立刻判缺勤
        } else {
          if(overlapSec >= expectedSec * EFFICIENCY_RATIO){
            status = 'present';
            statusText = '出勤';
          } else {
            status = 'low_efficiency';
            statusText = '低效';
          }
        }
        
        practiceTime = overlapSec > 0 ? formatDuration(overlapSec, 'minuteOnly') : '--';
        
        // 当前房间：取 active interval 最后一个房间
        const activeInterval = intervals[intervals.length - 1];
        room = activeInterval ? activeInterval.room : (overlapSec > 0 ? '在琴房' : '不在琴房');
      }
    }

    // 统计各状态数量
    switch(status){
      case 'present': detail.present++; break;
      case 'absent': detail.absent++; break;
      case 'excused': detail.excused++; break;
      case 'low_efficiency': detail.lowEfficiency++; break;
      case 'pending': detail.pending++; break;
    }

    // 添加详情记录
    detail.details.push({
      timeSlot: slotLabel,
      status,
      practiceTime,
      room,
      statusText
    });
  });

  return detail;
}

/**
 * 构造 snapshot 视图
 */
function buildSnapshotAttendanceDetail(studentName,date,rec){
  const detail={present:0,absent:0,excused:0,lowEfficiency:0,pending:0,details:[]};
  if(!rec){detail.pending++;detail.details.push({timeSlot:'无记录',status:'pending',practiceTime:'--',room:'--',statusText:'待考勤'});return detail;}
  const all=[...(rec.students||[]),...(rec.endedSlots||[])];
  const seg=all.filter(s=>s.name===studentName);
  if(!seg.length){
    detail.pending++;
    detail.details.push({timeSlot:'无记录',status:'pending',practiceTime:'--',room:'--',statusText:'待考勤'});
    return detail;
  }
  seg.forEach(s=>{
    const stat=s.finalAttendanceStatus||'absent';
    let text=getStatusText(stat);
    if(stat==='present')detail.present++;
    else if(stat==='excused')detail.excused++;
    else if(stat==='absent')detail.absent++;
    else if(stat==='low_efficiency')detail.lowEfficiency++;
    else detail.pending++;
    detail.details.push({
      timeSlot:`${s.start}-${s.end}`,
      status:stat,
      practiceTime:s.practicedText||'0分钟',
      room:s.room|| (stat==='present'?'在琴房':'不在琴房'),
      statusText:text
    });
  });
  return detail;
}

/**
 * 合并实时与 snapshot
 * 规则：
 *  - snapshot 缺勤/待考勤 -> 若 realtime present/low_efficiency 则覆盖
 *  - snapshot present 且实时没在房间：不回退，只在 room 后加 (已离开)
 */
function mergeAttendanceDetail(snapshotDetail,realtimeDetail){
  const map=new Map();
  snapshotDetail.details.forEach(d=>map.set(d.timeSlot,d));
  realtimeDetail.details.forEach(r=>{
    if(!map.has(r.timeSlot)){
      map.set(r.timeSlot,r);
      return;
    }
    const base=map.get(r.timeSlot);
    if((base.status==='absent'||base.status==='pending') && (r.status==='present'||r.status==='low_efficiency')){
      map.set(r.timeSlot,r);
    }else if((base.status==='present'||base.status==='low_efficiency') && (r.status==='absent'||r.status==='pending')){
      // 保留 base，但如果 base 是 present & 当前无房间，则在房间追加离开标记
      if(!r.room || r.room==='不在琴房'){
        if(!/已离开/.test(base.room)) base.room = base.room + ' (已离开)';
      }
    }else if(r.status==='present' && base.status==='low_efficiency'){
      // 允许 present 覆盖低效
      map.set(r.timeSlot,r);
    }
  });
  // 重新统计
  const merged={present:0,absent:0,excused:0,lowEfficiency:0,pending:0,details:[...map.values()]};
  merged.details.forEach(d=>{
    if(d.status==='present')merged.present++;
    else if(d.status==='excused')merged.excused++;
    else if(d.status==='absent')merged.absent++;
    else if(d.status==='low_efficiency')merged.lowEfficiency++;
    else merged.pending++;
  });
  return merged;
}

/**
 * 决定使用何种构造逻辑并展示
 */
function showDayAttendanceDetail(studentName,date,dayNumber){
  event.stopPropagation();
  const isToday=(date===getTodayDateString());
  const rec=attendanceRecordsCache[date];
  let realtime = buildRealtimeAttendanceDetail(studentName,date);
  let finalDetail;
  if(isToday){
    // 今日：完全实时，不看 snapshot
    finalDetail=realtime;
  }else{
    let stale=false;
    if(rec && rec.lastUpdated){
      if(Date.now()-rec.lastUpdated>SNAPSHOT_STALE_MS) stale=true;
    }else if(rec && !rec.lastUpdated){
      stale=true; // 没有时间戳，一律当作 stale
    }
    if(!rec || stale){
      // 无 snapshot 或过期 -> pure realtime
      finalDetail=realtime;
    }else{
      const snapDetail=buildSnapshotAttendanceDetail(studentName,date,rec);
      // overlay
      finalDetail=mergeAttendanceDetail(snapDetail,realtime);
    }
  }
  showAttendanceDetailModal(studentName,date,dayNumber,finalDetail);
}

/* =============== ✅ 可选：生成今日 attendance snapshot（含 lastUpdated） =============== */
/* 你可以在某个管理按钮或定时器调用 snapshotTodayAttendance() 以写入云端“阶段性快照” */
function snapshotTodayAttendance(){
  if(!isOnline||!database){addSyncLog('⚠️ 无法生成快照（离线）');return;}
  const today=getTodayDateString();
  const students=flattenStudents();
  const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
  const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
  const excuses=excuseData[today]||{};
  const records=[];
  students.forEach(s=>{
    const status=getStudentCurrentStatus(s.name,presentSet,excuses,wd,curMin);
    if(status==='excused')return; // 请假不上 slot 细分（可按需要扩展）
    // 展开他今天的 slot
    const map={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
    const key=map[wd];
    const slots=(key&&studentTimeSlots[s.name]&&studentTimeSlots[s.name][key])?studentTimeSlots[s.name][key]:[];
    if(!slots.length){
      records.push({name:s.name,start:'--',end:'--',finalAttendanceStatus:status,practicedText:'--',room:presentSet.has(s.name)?(rooms.find(r=>r.student===s.name)?.name||'在琴房'):'',major:s.major,lastUpdated:Date.now()});
    }else{
      slots.forEach(slot=>{
        records.push({
          name:s.name,
          start:slot.start,
          end:slot.end,
            finalAttendanceStatus:presentSet.has(s.name)?'present':(excuses[s.name]?'excused':'absent'),
          practicedText:'--',
          room:presentSet.has(s.name)?(rooms.find(r=>r.student===s.name)?.name||''):'',
          major:s.major,
          lastUpdated:Date.now()
        });
      });
    }
  });
  const snapshot={students:records,endedSlots:[],lastUpdated:Date.now()};
  database.ref(`attendanceRecords/${today}`).update(snapshot).then(()=>addSyncLog('📤 已写入今日考勤快照')).catch(e=>addSyncLog('❌ 快照失败 '+e.message));
}

/* =============== 显示考勤详情模态框（保持原格式） =============== */
function getDayDescription(dayNumber){
  if(currentLanguage==='en'){
    const desc={1:'Today',2:'Yesterday',3:'2 days ago',4:'3 days ago',5:'4 days ago',6:'5 days ago',7:'6 days ago'};
    return desc[dayNumber]||`${dayNumber-1} days ago`;
  }else{
    const desc={1:'今天',2:'昨天',3:'前天',4:'第4天前',5:'第5天前',6:'第6天前',7:'第7天前'};
    return desc[dayNumber]||`第${dayNumber}天`;
  }
}
function showAttendanceDetailModal(studentName,date,dayNumber,detailInfo){
  const modal=document.getElementById('attendanceDetailModal');
  const content=`<div class="modal-header">
    <h3 class="modal-title">${studentName} - ${getDayDescription(dayNumber)}${t('attendance.detail.suffix','考勤详情')}</h3>
    <button class="modal-close" onclick="closeModal('attendanceDetailModal')">&times;</button>
  </div>
  <div style="padding:25px 20px 20px 20px;">
    <div class="card" style="margin-bottom:25px;">
      <h4 style="margin-bottom:20px;">📅 ${date} ${t('attendance.summary','考勤汇总')}</h4>
      <div class="stats-grid-detailed" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;">
        <div class="stat-item present"><div class="stat-icon">✅</div><div class="stat-content"><div class="stat-number">${detailInfo.present}</div><div class="stat-label">${t('stats.present','出勤')}</div></div></div>
        <div class="stat-item absent"><div class="stat-icon">❌</div><div class="stat-content"><div class="stat-number">${detailInfo.absent}</div><div class="stat-label">${t('stats.absent','缺勤')}</div></div></div>
        <div class="stat-item" style="background:linear-gradient(135deg,#ffeaa7,#fdcb6e);"><div class="stat-icon">⚠️</div><div class="stat-content"><div class="stat-number">${detailInfo.lowEfficiency}</div><div class="stat-label">${t('status.low_efficiency','低效')}</div></div></div>
        <div class="stat-item excused"><div class="stat-icon">📝</div><div class="stat-content"><div class="stat-number">${detailInfo.excused}</div><div class="stat-label">${t('stats.excused','请假')}</div></div></div>
        ${detailInfo.pending?`<div class="stat-item" style="background:linear-gradient(135deg,#f8f9fa,#e9ecef);"><div class="stat-icon">⏳</div><div class="stat-content"><div class="stat-number">${detailInfo.pending}</div><div class="stat-label">${t('status.pending','待考勤')}</div></div></div>`:''}
      </div>
    </div>
    <div class="card">
      <h4 style="margin-bottom:20px;">📋 ${t('attendance.detailed_records','详细记录')}</h4>
      <div class="data-table-container" style="max-height:300px;overflow-y:auto;">
        <table class="data-table">
          <thead><tr>
            <th>${t('student.time_slot','时间段')}</th>
            <th>${t('filter.status','状态')}</th>
            <th>${t('student.practice_duration','练琴时长')}</th>
            <th>${t('student.room','琴房')}</th>
            ${detailInfo.details.some(d=>d.excuseReason)?`<th>${t('attendance.remarks','备注')}</th>`:''}
          </tr></thead>
          <tbody>
            ${detailInfo.details.map(d=>`<tr>
              <td>${d.timeSlot}</td>
              <td><span class="table-status-badge ${d.status}">${d.statusText}</span></td>
              <td>${d.practiceTime||'--'}</td>
              <td>${d.room||''}</td>
              ${detailInfo.details.some(x=>x.excuseReason)?(`<td>${d.excuseReason||'-'}</td>`):''}
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>`;
  openModalSmooth('attendanceDetailModal', content);
}

/* =============== 学生详情（复用原逻辑 + 修正） =============== */
function getStudentPracticeStats(name,days=7){
  const stats={totalDays:0,totalInSlot:0,totalOutSlot:0,totalSessions:0,dailyDetails:[]};
  const today=new Date();
  for(let i=0;i<days;i++){
    const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
    const dk=formatDate(d);
    const rec=getStudentPracticeRecord(name,dk);
    const inSlot=Number(rec.inSlotSeconds||rec.inSlot||0);
    const outSlot=Number(rec.outSlotSeconds||rec.outSlot||0);
    const sessions=Number(rec.totalSessions||0);
    if(sessions>0){stats.totalDays++;stats.totalInSlot+=inSlot;stats.totalOutSlot+=outSlot;stats.totalSessions+=sessions;}
    stats.dailyDetails.push({date:dk,inSlot,outSlot,sessions});
  }
  return stats;
}
function aggregateDailyStatus(records){
  // records: 同一天该学生所有 slot 或快照条目
  let hasExcused=false,hasPresent=false,hasLow=false,hasPending=false,hasAbsent=false;
  let totalSlots = 0, presentSlots = 0;
  
  records.forEach(r=>{
    const s=r.finalAttendanceStatus || r.status;
    totalSlots++;
    
    if(s==='excused') hasExcused=true;
    else if(s==='present') {
      hasPresent=true;
      presentSlots++;
    }
    else if(s==='low_efficiency') hasLow=true;
    else if(s==='pending') hasPending=true;
    else if(s==='absent') hasAbsent=true;
  });
  
  // 🔥 新逻辑：如果有任何出勤记录，优先显示积极状态
  // 只有当所有时间段都是缺勤时，才显示缺勤
  if(hasExcused && !hasPresent && !hasLow && !hasAbsent && !hasPending) return 'excused'; // 全天请假
  if(hasPresent && presentSlots >= totalSlots * 0.5) return 'present'; // 超过一半时间段出勤
  if(hasPresent || hasLow) return hasPresent ? 'present' : 'low_efficiency'; // 有出勤或低效
  if(hasAbsent && !hasPending) return 'absent'; // 明确缺勤且无待考勤
  if(hasPending) return 'pending'; // 待考勤
  if(hasAbsent) return 'absent'; // 缺勤
  if(hasExcused) return 'excused'; // 请假
  return 'no-data';
}

// 🔥 新增：专门用于练琴明细表格的时间格式化函数
function formatPracticeMinutes(minutes) {
  if (!minutes || minutes === 0) {
    return currentLanguage === 'zh' ? '0分钟' : '0min';
  }
  
  if (minutes >= 60) {
    const hours = (minutes / 60).toFixed(1);
    return currentLanguage === 'zh' ? `${hours}小时` : `${hours}h`;
  }
  
  return currentLanguage === 'zh' ? `${minutes}分钟` : `${minutes}min`;
}

// 🔥 新增：专门用于今日总计的时间格式化函数（显示小时分钟格式）
function formatTotalPracticeTime(minutes) {
  if (!minutes || minutes === 0) {
    return currentLanguage === 'zh' ? '0分钟' : '0min';
  }
  
  const hours = Math.floor(minutes / 60);
  const remainingMinutes = minutes % 60;
  
  if (currentLanguage === 'zh') {
    if (hours > 0 && remainingMinutes > 0) {
      return `${hours}小时${remainingMinutes}分钟`;
    } else if (hours > 0) {
      return `${hours}小时`;
    } else {
      return `${remainingMinutes}分钟`;
    }
  } else {
    if (hours > 0 && remainingMinutes > 0) {
      return `${hours}h ${remainingMinutes}min`;
    } else if (hours > 0) {
      return `${hours}h`;
    } else {
      return `${remainingMinutes}min`;
    }
  }
}

function openStudentDetail(name){
  // 预加载最近7天（异步）
  const today=new Date();
  const preload=[];
  for(let i=0;i<7;i++){
    const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
    const ds=formatDate(d);
    if(!attendanceRecordsCache[ds]&&isOnline&&database){
      preload.push(database.ref(`attendanceRecords/${ds}`).once('value').then(s=>{attendanceRecordsCache[ds]=s.val()||null;}));
    }
    if(!dailyPracticeRecords[ds]&&isOnline&&database){
      preload.push(database.ref(`practiceRecords/${ds}`).once('value').then(s=>{
        const v=s.val();if(v){dailyPracticeRecords[ds]=v;try{localStorage.setItem('practiceRecords_'+ds,JSON.stringify(v));}catch(e){}}
      }));
    }
  }
  Promise.all(preload).finally(()=>{
    const info=getStudentInfo(name);
    const practice=realTimePracticeMap[name];
    const todayKey=getTodayDateString();
    const excuse=(excuseData[todayKey]||{})[name];
    const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
    const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
    const todayExcuses=excuseData[todayKey]||{};
    const currentStatus=getStudentCurrentStatus(name,presentSet,todayExcuses,wd,curMin);
    
    // 🔥 考勤历史记录
    const history=[];
    for(let i=0;i<7;i++){
      const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
      const ds=formatDate(d);
      
      const isToday=(ds===getTodayDateString());
      let st = 'no-data';
      
      if(isToday){
        // 今日：使用实时数据
        const realtimeDetail = buildRealtimeAttendanceDetail(name, ds);
        if(realtimeDetail.excused > 0) st = 'excused';
        else if(realtimeDetail.present > 0) st = 'present';
        else if(realtimeDetail.lowEfficiency > 0) st = 'low_efficiency';
        else if(realtimeDetail.absent > 0) st = 'absent';
        else st = 'pending';
      } else {
        // 🔥 历史日：直接使用详细记录构建函数的结果
        const isToday_check = (ds === getTodayDateString());
        const rec = attendanceRecordsCache[ds];
        let realtime = buildRealtimeAttendanceDetail(name, ds);
        let finalDetail;
        
        if(isToday_check){
          finalDetail = realtime;
        } else {
          let stale = false;
          if(rec && rec.lastUpdated){
            if(Date.now() - rec.lastUpdated > SNAPSHOT_STALE_MS) stale = true;
          } else if(rec && !rec.lastUpdated){
            stale = true;
          }
          
          if(!rec || stale){
            finalDetail = realtime;
          } else {
            const snapDetail = buildSnapshotAttendanceDetail(name, ds, rec);
            finalDetail = mergeAttendanceDetail(snapDetail, realtime);
          }
        }
        
        // 🔥 直接根据详细记录的状态分布来判断整体状态
        if(finalDetail.excused > 0 && finalDetail.present === 0 && finalDetail.lowEfficiency === 0 && finalDetail.absent === 0) {
          st = 'excused'; // 全天请假
        } else if(finalDetail.present > 0) {
          st = 'present'; // 有出勤
        } else if(finalDetail.lowEfficiency > 0) {
          st = 'low_efficiency'; // 有低效
        } else if(finalDetail.absent > 0) {
          st = 'absent'; // 🔥 有缺勤记录就显示缺勤
        } else if(finalDetail.pending > 0) {
          st = 'pending'; // 待考勤
        } else {
          st = 'no-data'; // 无数据
        }
      }
      
      history.push({date:ds,status:st});
    }

    // 🔥 练琴明细：使用与考勤详情相同的数据源和计算逻辑
    const practiceRows = (function(){
      const rows = [];
      for(let i = 0; i < 7; i++){
        const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
        const dateStr = formatDate(d);
        const isToday = dateStr === todayKey;
        
        // 🔥 使用与考勤详情相同的计算逻辑
        let inMin = 0, outMin = 0;
        
        if(isToday){
          // 今日：使用实时计算
          const intervals = getStudentTodayIntervals(name);
          const slots = getStudentTodaySlots(name);
          
          // 计算段内时长
          slots.forEach(slot => {
            const slotStartMs = new Date(`${dateStr}T${slot.start}:00`).getTime();
            const slotEndMs = new Date(`${dateStr}T${slot.end}:00`).getTime();
            const overlapSec = calcOverlapSeconds(intervals, slotStartMs, slotEndMs);
            inMin += Math.floor(overlapSec / 60);
          });
          
          // 计算段外时长（总时长 - 段内时长）
          const totalSec = intervals.reduce((sum, interval) => {
            return sum + Math.floor((interval.end - interval.start) / 1000);
          }, 0);
          const totalMin = Math.floor(totalSec / 60);
          outMin = Math.max(0, totalMin - inMin);
          
        } else {
          // 历史日期：使用相同的区间重构逻辑
          const intervals = getHistoryIntervals(name, dateStr);
          
          // 获取当天的时间段安排
          const target = new Date(dateStr);
          const wd = target.getDay();
          const map = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
          const key = map[wd];
          const slots = (key && studentTimeSlots[name] && studentTimeSlots[name][key]) 
                        ? studentTimeSlots[name][key] : [];
          
          // 计算段内时长
          slots.forEach(slot => {
            const slotStartMs = new Date(`${dateStr}T${slot.start}:00`).getTime();
            const slotEndMs = new Date(`${dateStr}T${slot.end}:00`).getTime();
            const overlapSec = calcOverlapSeconds(intervals, slotStartMs, slotEndMs);
            inMin += Math.floor(overlapSec / 60);
          });
          
          // 计算段外时长
          const totalSec = intervals.reduce((sum, interval) => {
            return sum + Math.floor((interval.end - interval.start) / 1000);
          }, 0);
          const totalMin = Math.floor(totalSec / 60);
          outMin = Math.max(0, totalMin - inMin);
        }
        
        const total = inMin + outMin;
        
        rows.push({
          date: dateStr,
          isToday,
          inMin,
          outMin,
          total
        });
      }
      
      return rows.sort((a, b) => b.date.localeCompare(a.date));
    })();

    // 🔥 修改：使用新的时间格式化函数
    const practiceRowsHtml = practiceRows.map(row => {
      return `<tr ${row.isToday ? 'class="today-row"' : ''}>
        <td class="date-cell">${row.date}${row.isToday ? '<small style="color:#007bff;">(今天)</small>' : ''}</td>
        <td>${formatPracticeMinutes(row.inMin)}</td>
        <td>${formatPracticeMinutes(row.outMin)}</td>
        <td class="total-duration-cell">${formatPracticeMinutes(row.total)}</td>
      </tr>`;
    }).join('') || `<tr><td colspan="4" style="text-align:center;color:#999;">无记录</td></tr>`;

    // 🔥 今日总时长也使用统一的格式化函数
    const todayRow = practiceRows.find(r => r.isToday);
    const todayTotalMin = todayRow ? todayRow.total : 0;
    const todayTotalHourText = formatTotalPracticeTime(todayTotalMin);

    const historyHtml=history.map((h,i)=>{
      const cls=(function(st){
        switch(st){
          case 'present':return 'present';
          case 'absent':return 'absent';
          case 'excused':return 'excused';
          case 'low_efficiency':return 'low-efficiency';
          case 'pending':return 'pending';
          default:return 'no-data';
        }
      })(h.status);
      const day=i+1;
      return `<div class="history-day ${cls}" onclick="showDayAttendanceDetail('${name}','${h.date}',${day})">${day}</div>`;
    }).join('');

    const statusNow=getStatusText(currentStatus);
    const dur=practice?formatDuration(practice.currentSec):t('time.no_practice','0分钟');
    const practiceStartText = practice
      ? new Date(practice.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'})
      : '--';

    const slotDayMap={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
    const key=slotDayMap[wd];
    let timeSlotInfo='';
    if(currentStatus!=='excused'){
      if(key && studentTimeSlots[name] && studentTimeSlots[name][key] && studentTimeSlots[name][key].length){
        const slots=studentTimeSlots[name][key];
        const slotHtml=slots.map(s=>{
          const sm=timeToMinutes(s.start),em=timeToMinutes(s.end);
          const isCur=curMin>=sm&&curMin<em;
          return `<span class="time-slot-tag${isCur?' current':''}">${isCur?'🎵 ':''}${s.start}-${s.end}</span>`;
        }).join('');
        timeSlotInfo=`<div class="metric-item time-slots-container">
          <div class="metric-icon">📅</div>
          <div class="metric-content">
            <div class="metric-label">考勤时间段</div>
            <div class="metric-value time-slots-wrapper">${slotHtml}</div>
          </div>
        </div>`;
      }else{
        timeSlotInfo=`<div class="metric-item">
          <div class="metric-icon">📅</div>
          <div class="metric-content">
            <div class="metric-label">考勤时间段</div>
            <div class="metric-value">${(wd===0||wd===6)?'周末':'无安排'}</div>
          </div>
        </div>`;
      }
    }
    
    // 🔥 设置模态框内容
    document.getElementById('studentDetailTitle').textContent=name+' - '+t('student.detail.title','学生详情');
    document.getElementById('studentDetailContent').innerHTML=`
      <div class="student-detail-content">
        <div class="student-profile-card">
          <h2 class="profile-name">${name}</h2>
          <div class="profile-meta">
            <span>${info.major||''}</span><span class="meta-divider">•</span>
            <span>${info.grade||t('student.not_set','未设置')}</span>
          </div>
        </div>
        <div class="today-status-card ${getStatusClass(currentStatus)}">
          <div class="status-header">
            <h3 class="status-title">${t('student.today_attendance','今日考勤')}</h3>
            <div class="status-badge ${getStatusClass(currentStatus)}">${getDetailedStatusText(name, currentStatus, practice, wd, curMin)}</div>
          </div>
          <div class="status-metrics">
            ${timeSlotInfo}
            <div class="metric-item practice-status-container">
              <div class="metric-icon">🎵</div>
              <div class="metric-content">
                <div class="metric-label">练琴状态</div>
                <div class="metric-value practice-status-compact">
                  <div class="practice-info-row"><span class="practice-label">开始时间:</span><strong class="practice-value">${practiceStartText}</strong></div>
                  <div class="practice-info-row"><span class="practice-label">琴房:</span><strong class="practice-value">${practice?practice.room:t('student.not_in_room','不在琴房')}</strong></div>
                  <div class="practice-info-row"><span class="practice-label">当前练习:</span><strong class="practice-value current-practice">${dur}</strong></div>
                  <div class="practice-info-row"><span class="practice-label">今日总计:</span><strong class="practice-value total-practice">${todayTotalHourText}</strong></div>
                </div>
              </div>
            </div>
          </div>
          ${excuse?`<div class="excuse-info">
            <div class="excuse-header"><i class="excuse-icon">📝</i><span class="excuse-title">${t('excuse.reason','请假原因')}</span></div>
            <div class="excuse-content">
              <p class="excuse-reason">${excuse.reason||''}</p>
              ${excuse.durationText?`<p class="excuse-approver">${t('excuse.duration_text','请假时长')}: ${excuse.durationText}</p>`:''}
              ${excuse.endDate?`<p class="excuse-approver">${t('excuse.end_date','结束日期')}: ${excuse.endDate}</p>`:''}
            </div>
          </div>`:''}
        </div>
        <div class="card attendance-history">
          <div class="history-title">${t('attendance.history','最近7天考勤')}</div>
          <div class="history-timeline">${historyHtml}</div>
        </div>
        <div class="card">
          <div class="card-header">
            <h4 class="card-title">🗓️ 最近7天练琴明细</h4>
            <p style="font-size:.75rem;color:var(--medium-gray);margin:8px 0 0;">
              段内=规定练琴时段 | 段外=非规定时段 
              <span style="color:#007bff;">• 数据来源：实时计算</span>
            </p>
          </div>
          <div class="data-table-container" style="max-height:230px;overflow-y:auto;">
            <table class="data-table">
              <thead><tr><th>${t('report.date','日期')}</th><th>${t('practice.in_slot','段内')}</th><th>${t('practice.out_slot','段外')}</th><th>${t('report.total','总计')}</th></tr></thead>
              <tbody>${practiceRowsHtml}</tbody>
            </table>
          </div>
        </div>
      </div>`;
    
    // 🔥 使用新的流畅模态框打开函数
    openModalSmooth('studentDetailModal');

  });
}
function updatePracticeSessions(){
  const now = Date.now();
  let updatedCount = 0;
  
  practiceSessionTracker.forEach(sess => {
    if(!sess.isActive) return;
    
    try {
      // 🔥 更新 _lastTick
      sess._lastTick = now;
      
      // 🔥 如果超过准备时间，开始正式计时
      if(now >= sess.prepEndTime && !sess.actualStartTime) {
        sess.actualStartTime = sess.prepEndTime;
        console.log(`开始正式计时: ${sess.studentName}`);
      }
      
      // 🔥 实时更新时长（不修改 endTime）
      if(sess.actualStartTime && now > sess.actualStartTime) {
        const originalEndTime = sess.endTime;
        sess.endTime = now;
        recalcSessionTimes(sess);
        sess.endTime = originalEndTime; // 恢复原值
        
        // 🔥 验证结果
        if(isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
          console.error(`更新会话时发现NaN: ${sess.studentName}`);
          sess.inSlotTime = 0;
          sess.outSlotTime = 0;
        }
        
        updatedCount++;
      }
    } catch(e) {
      console.error(`更新会话出错: ${sess.studentName}`, e);
    }
  });
  
  if(updatedCount > 0) {
    addSyncLog(`🔄 更新了 ${updatedCount} 个活跃会话`);
  }
}
function getDetailedStatusText(studentName, currentStatus, practice, weekday, currentMinute) {
  // 如果是请假，直接返回请假状态
  if (currentStatus === 'excused') {
    return t('status.excused', '请假');
  }
  
  // 获取学生今天的时间段
  const slotDayMap = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = slotDayMap[weekday];
  
  // 检查是否在时间段内
  let inTimeSlot = false;
  if (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) {
    const slots = studentTimeSlots[studentName][key];
    inTimeSlot = slots.some(slot => {
      const startMin = timeToMinutes(slot.start);
      const endMin = timeToMinutes(slot.end);
      return currentMinute >= startMin && currentMinute < endMin;
    });
  }
  
  if (inTimeSlot) {
    // 在时间段内：根据是否在琴房判断状态
    if (practice) {
      // 在琴房练琴
      return t('status.present', '出勤');
    } else {
      // 不在琴房
      return t('status.absent', '缺勤');
    }
  } else {
    // 不在时间段内：根据是否在琴房显示自主练琴状态
    if (practice) {
      return currentLanguage === 'zh' ? '自主练琴' : 'Self Practice';
    } else {
      return currentLanguage === 'zh' ? '目前未练琴' : 'Not Practicing';
    }
  }
}
// 🔥 修复：获取历史日期的练琴区间
function getHistoryIntervals(studentName, date){
  const intervals = [];
  
  // 1. 首先尝试从 dailyPracticeRecords 获取详细会话记录
  const rec = dailyPracticeRecords[date] && dailyPracticeRecords[date][studentName];
  
  if(rec && Array.isArray(rec.sessions) && rec.sessions.length > 0) {
    // 使用详细的会话记录重构区间
    rec.sessions.forEach(session => {
      if(session.start && session.end) {
        const start = session.start + 60000; // 去除1分钟准备时间
        if(start < session.end) {
          intervals.push({
            start,
            end: session.end,
            room: session.room || '练琴房'
          });
        }
      }
    });
    
    console.log(`${studentName} ${date} 使用详细会话记录，生成${intervals.length}个区间`);
    return intervals;
  }
  
  // 2. 如果没有详细会话记录，使用累计时长重构（兜底方案）
  if(!rec) {
    console.log(`没有找到 ${studentName} 在 ${date} 的数据`);
    return intervals;
  }
  
  const inSlotSec = rec.inSlotSeconds || rec.inSlot || 0;
  const outSlotSec = rec.outSlotSeconds || rec.outSlot || 0;
  
  console.log(`${studentName} ${date} 使用累计时长重构: 段内${Math.round(inSlotSec/60)}分钟, 段外${Math.round(outSlotSec/60)}分钟`);
  
  if(inSlotSec === 0 && outSlotSec === 0) {
    return intervals;
  }
  
  // 获取学生当天的时间段安排
  const target = new Date(date);
  const wd = target.getDay();
  const map = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = map[wd];
  const slots = (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) 
                  ? studentTimeSlots[studentName][key] : [];
  
  // 重构段内练琴区间
  if(inSlotSec > 0 && slots.length > 0){
    let remainingSec = inSlotSec;
    
    slots.forEach(slot => {
      if(remainingSec <= 0) return;
      
      const slotStartMs = new Date(`${date}T${slot.start}:00`).getTime();
      const slotEndMs = new Date(`${date}T${slot.end}:00`).getTime();
      const slotDurSec = (slotEndMs - slotStartMs) / 1000;
      
      // 使用实际练琴时长，但不超过时间段长度
      const useSec = Math.min(remainingSec, slotDurSec);
      
      if(useSec > 0) {
        intervals.push({
          start: slotStartMs,
          end: slotStartMs + useSec * 1000,
          room: '练琴房'
        });
        
        remainingSec -= useSec;
        console.log(`添加段内区间: ${slot.start}-${slot.end}, 使用${useSec}秒`);
      }
    });
  }
  
  // 重构段外练琴区间
  if(outSlotSec > 0){
    // 🔥 改进：将段外时间分散到非时间段时间
    const baseTime = new Date(`${date}T11:30:00`).getTime(); // 放在11:30
    intervals.push({
      start: baseTime,
      end: baseTime + outSlotSec * 1000,
      room: '练琴房'
    });
    console.log(`添加段外区间: 11:30开始, ${outSlotSec}秒`);
  }
  
  console.log(`最终生成${intervals.length}个练琴区间`);
  return intervals;
}

/* =============== 报告 =============== */
function getDateSpan(start,end){const res=[];let d=new Date(start),ed=new Date(end);while(d<=ed){res.push(formatDate(d));d.setDate(d.getDate()+1);}return res;}
function loadAttendanceRange(start,end){
  if(!isOnline)return Promise.resolve();
  const dates=getDateSpan(start,end);
  const tasks=[];
  dates.forEach(d=>{
    if(!attendanceRecordsCache[d]){
      tasks.push(database.ref(`attendanceRecords/${d}`).once('value').then(s=>{attendanceRecordsCache[d]=s.val()||null;}));
    }
  });
  return Promise.all(tasks);
}
function collectReportData(start,end){
  const dates=getDateSpan(start,end);
  const daily=[],agg=new Map();
  dates.forEach(date=>{
    const rec=attendanceRecordsCache[date];
    if(!rec){daily.push({date,total:0,present:0,absent:0,excused:0,rate:0});return;}
    const all=[...(rec.students||[]),...(rec.endedSlots||[])];
    let present=0,excused=0,absent=0,total=all.length;
    all.forEach(s=>{
      const st=s.finalAttendanceStatus;
      if(st==='present')present++;
      else if(st==='excused')excused++;
      else if(st==='absent')absent++;
      if(!agg.has(s.name))agg.set(s.name,{name:s.name,major:s.major||'',present:0,absent:0,excused:0,total:0});
      const a=agg.get(s.name);
      a.total++;
      if(st==='present')a.present++;
      else if(st==='excused')a.excused++;
      else if(st==='absent')a.absent++;
    });
    const rate=total?((present+excused)/total*100).toFixed(1):'0';
    daily.push({date,total,present,absent,excused,rate});
  });
  const students=[...agg.values()].map(s=>{
    s.rate=s.total?((s.present+s.excused)/s.total*100).toFixed(1):'0.0';return s;
  }).sort((a,b)=>b.rate-a.rate);
  return {daily,students};
}
function renderReportHTML(data,start,end){
  return `
  <div class="card">
    <h4>${t('report.analysis_title','📊 考勤分析报告')}</h4>
    <div class="student-details">
      <div class="detail-item"><div class="detail-label">${t('report.period','统计周期')}</div><div class="detail-value">${start} ${t('report.to','至')} ${end} (${data.daily.length}${t('report.days','天')})</div></div>
      <div class="detail-item"><div class="detail-label">${t('report.participants','参与学生')}</div><div class="detail-value">${data.students.length}${t('report.people','人')}</div></div>
    </div>
  </div>
  <div class="card">
    <h4>${t('report.daily_trend','📈 每日考勤趋势')}</h4>
    <div class="data-table-container" style="max-height:300px;overflow-y:auto;">
      <table class="data-table daily-trend">
        <thead><tr>
          <th>${t('report.date','日期')}</th>
          <th>${t('report.total','合计')}</th>
          <th>${t('stats.present','出勤')}</th>
          <th>${t('stats.absent','缺勤')}</th>
          <th>${t('stats.excused','请假')}</th>
          <th>${t('attendance.rate','出勤率')}</th>
        </tr></thead>
        <tbody>${data.daily.map(d=>`<tr>
          <td>${d.date}</td><td>${d.total}</td><td>${d.present}</td><td>${d.absent}</td><td>${d.excused}</td><td>${d.rate}%</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <h4>${t('report.student_stats','👥 学生考勤统计')}</h4>
    <div class="data-table-container" style="max-height:400px;overflow-y:auto;">
      <table class="data-table student-stats">
        <thead><tr>
          <th>${t('student.name','姓名')}</th>
          <th>${t('student.major','专业')}</th>
          <th>${t('stats.present','出勤')}</th>
          <th>${t('stats.absent','缺勤')}</th>
          <th>${t('stats.excused','请假')}</th>
          <th>${t('attendance.rate','出勤率')}</th>
        </tr></thead>
        <tbody>${data.students.map(s=>`<tr>
          <td>${s.name}</td><td>${s.major}</td><td>${s.present}</td><td>${s.absent}</td><td>${s.excused}</td><td>${s.rate}%</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>
    <div class="export-options">
      <button class="btn btn-primary" onclick="generateReport()"><span>🔄</span>${t('report.regenerate','重新生成')}</button>
    </div>
  </div>`;
}
function generateReport(){
  const s=document.getElementById('startDate').value;
  const e=document.getElementById('endDate').value;
  if(!s||!e){alert(t('msg.select_dates','请选择开始和结束日期'));return;}
  if(new Date(s)>new Date(e)){alert(t('msg.date_range_error','开始日期不能晚于结束日期'));return;}
  const cont=document.getElementById('reportContent');
  cont.innerHTML='<div class="loading"><div class="spinner"></div></div>';
  loadAttendanceRange(s,e).then(()=>{
    const data=collectReportData(s,e);
    cont.innerHTML=renderReportHTML(data,s,e);
  }).catch(err=>{
    cont.innerHTML=`<div class="empty-state"><div class="empty-state-icon">⚠️</div><div class="empty-state-title">${t('empty.load_failed','加载失败')}</div><div class="empty-state-description">${err.message}</div></div>`;
  });
}

/* =============== 同步 / 缓存 =============== */
function loadAllCoreData(){
  if(!database)return;
  Promise.all([
    database.ref('rooms').once('value').then(s=>{if(Array.isArray(s.val())){rooms=s.val();buildRealTimePracticeFromRooms();}}),
    database.ref('studentDatabase').once('value').then(s=>{if(s.val())studentDatabase=s.val();}),
    database.ref('excuseData').once('value').then(s=>{if(s.val())excuseData=s.val();})
  ]).then(()=>{
    addSyncLog('✅ 核心数据加载完成');
    updateStatsPanel();renderPracticeArea();renderExcusePanel();
    if(currentTab==='students')renderStudentList();
  }).catch(e=>addSyncLog('❌ 加载失败 '+e.message));
}
function forceSync(){
  if(!isOnline){alert(t('msg.sync_required','需要网络连接才能同步数据'));return;}
  addSyncLog('🔄 '+t('sync.force_sync','强制同步'));
  loadAllCoreData();
}
function clearLocalCache(){
  if(!confirm(t('msg.clear_cache_confirm','确定要清除本地缓存吗？')))return;
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith('practiceRecords_'))localStorage.removeItem(k);
  });
  addSyncLog('🗑️ '+t('msg.cache_cleared','本地缓存已清除'));
  alert(t('msg.cache_cleared','本地缓存已清除'));
}

/* =============== Tab 切换 =============== */
function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick').includes(tab)));
  document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
  document.getElementById(tab+'Tab').style.display='block';
  if(tab==='dashboard'){updateStatsPanel();renderPracticeArea();renderExcusePanel();}
  else if(tab==='students'){renderStudentList();}
}
function refreshCurrentTabContent(){
  if(currentTab==='dashboard'){updateStatsPanel();renderPracticeArea();renderExcusePanel();}
  else if(currentTab==='students'){renderStudentList();}
}

/* =============== 暴露函数 =============== */
window.switchLanguage=switchLanguage;
window.switchTab=switchTab;
window.filterPracticeStatus=filterPracticeStatus;
window.clearPracticeFilters=()=>{document.getElementById('practiceMajorFilter').value='';document.getElementById('practiceGradeFilter').value='';document.getElementById('practiceStudentSearch').value='';filterPracticeStatus();};
window.openStudentDetail=openStudentDetail;
window.closeModal=closeModal;
window.generateReport=generateReport;
window.forceSync=forceSync;
window.clearLocalCache=clearLocalCache;
window.filterStudents=renderStudentList;
window.showDayAttendanceDetail=showDayAttendanceDetail;
window.snapshotTodayAttendance=snapshotTodayAttendance;
window.updatePracticeSessions = updatePracticeSessions; // 🔥 新增

/* =============== 初始化 =============== */
document.addEventListener('DOMContentLoaded',()=>{
  const saved=localStorage.getItem('preferred_language');if(saved)currentLanguage=saved;
  updatePageLanguage();
  initFirebase();
  initClock();
  addSyncLog('🚀 系统启动');
});

/* =============== 定时任务 =============== */
// 练琴 UI 每30秒刷新显示
setInterval(()=>{
  const now=Date.now();
  Object.keys(realTimePracticeMap).forEach(n=>{
    const p=realTimePracticeMap[n];
    p.currentSec=Math.floor((now-p.startTime)/1000);
  });
  if(currentTab==='dashboard')renderPracticeArea();
  if(currentTab==='students')renderStudentList();
},30000);

// 会话逻辑 10 秒检查一次 + 每 90 秒增量同步 inSlot/outSlot
setInterval(()=>{
  const now=Date.now();
  if(now-lastPracticeSessionSweep>=PRACTICE_UPDATE_INTERVAL_MS-500){
    updatePracticeSessions();
    lastPracticeSessionSweep=now;
  }
  syncActiveSessionsIncrement();
},10000);

</script>
</body>
</html>
