<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡è€ƒå‹¤åŒæ­¥ç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root {
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --success-color: #27ae60;
    --background-color: #f8f9fa;
    --text-color: #2c3e50;
    --border-color: #dee2e6;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --radius: 12px;
    --mobile-padding: 15px;
    --mobile-font-size: 16px;
    --touch-target-size: 44px;
}


* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    overflow-x: hidden;
}


.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom);
}


/* å¤´éƒ¨æ ·å¼ */
.header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: max(30px, env(safe-area-inset-top) + 20px) 20px 30px 20px;
    margin-bottom: 30px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
}

.header h1 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    margin-bottom: 10px;
    font-weight: 300;
    line-height: 1.2;
}

.header .subtitle {
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    opacity: 0.9;
    line-height: 1.3;
}

/* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
.connection-status {
    position: fixed;
    top: max(20px, env(safe-area-inset-top) + 10px);
    right: 20px;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    z-index: 1000;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
}


.connection-status.online {
    background: var(--success-color);
    color: white;
}

.connection-status.offline {
    background: var(--danger-color);
    color: white;
}

.connection-status.syncing {
    background: var(--warning-color);
    color: white;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* ä¸»å¯¼èˆª */
.nav-tabs {
    display: flex;
    background: white;
    border-radius: var(--radius);
    padding: 5px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.nav-tabs::-webkit-scrollbar {
    display: none;
}


.nav-tab {
    flex: 1;
    padding: 12px 16px;
    text-align: center;
    background: transparent;
    border: none;
    border-radius: calc(var(--radius) - 5px);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: clamp(14px, 3vw, 16px);
    font-weight: 500;
    white-space: nowrap;
    min-width: 120px;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
}


.nav-tab:hover {
    background: rgba(52, 152, 219, 0.1);
}

.nav-tab.active {
    background: var(--primary-color);
    color: white;
}

/* å¡ç‰‡å®¹å™¨ */
.card {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
}

.card.success {
    border-left-color: var(--success-color);
}

.card.warning {
    border-left-color: var(--warning-color);
}

.card.danger {
    border-left-color: var(--danger-color);
}

/* ç»Ÿè®¡é¢æ¿ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
    gap: 15px;
    margin-bottom: 30px;
}


.stat-card {
    background: white;
    padding: 25px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 10px;
}

.stat-label {
    font-size: 1.1rem;
    color: #666;
    margin-bottom: 5px;
}

.stat-description {
    font-size: 0.9rem;
    color: #999;
}

.stat-card.present .stat-number { color: var(--success-color); }
.stat-card.absent .stat-number { color: var(--danger-color); }
.stat-card.excused .stat-number { color: var(--warning-color); }
.stat-card.total .stat-number { color: var(--primary-color); }

/* å­¦ç”Ÿåˆ—è¡¨ */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(350px, 100%), 1fr));
    gap: 15px;
    margin-top: 20px;
}


.student-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    border-left: 4px solid #ddd;
}

.student-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.student-card.present { border-left-color: var(--success-color); }
.student-card.absent { border-left-color: var(--danger-color); }
.student-card.excused { border-left-color: var(--warning-color); }
.student-card.low-efficiency { border-left-color: #f39c12; }
.student-card.practicing-unscheduled { 
    border-left-color: #9b59b6; 
    background: linear-gradient(135deg, #f8f4ff, #ffffff);
}

.student-status.practicing-unscheduled { 
    background: #e8d5f2; 
    color: #6a1b9a; 
}

.stat-card.unscheduled .stat-number { 
    color: #9b59b6; 
}

.student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.student-name {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
}

.student-status {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
}

.student-status.present { background: #d4edda; color: #155724; }
.student-status.absent { background: #f8d7da; color: #721c24; }
.student-status.excused { background: #fff3cd; color: #856404; }
.student-status.low-efficiency { background: #ffeaa7; color: #b06000; }

.student-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
}

.detail-item {
    display: flex;
    flex-direction: column;
}

.detail-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 3px;
}

.detail-value {
    font-weight: 600;
    color: var(--text-color);
}

.attendance-history {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.history-title {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 10px;
}

.history-timeline {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.history-day {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.history-day.present { background: var(--success-color); color: white; }
.history-day.absent { background: var(--danger-color); color: white; }
.history-day.excused { background: var(--warning-color); color: white; }
.history-day.no-data { background: #f8f9fa; color: #999; }

.history-day:hover {
    transform: scale(1.1);
}
/* åœ¨ç°æœ‰CSSä¸­æ·»åŠ  */
.student-card.weekend { 
    border-left-color: #95a5a6; 
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
}

.student-status.weekend { 
    background: #ecf0f1; 
    color: #2c3e50; 
}

.stat-card.weekend .stat-number { 
    color: #95a5a6; 
}
/* å®æ—¶ç»ƒç´çŠ¶æ€æ ·å¼ */
.practice-status-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    border-left: 4px solid #9b59b6;
    background: linear-gradient(135deg, #f8f4ff, #ffffff);
    position: relative;
}

.practice-status-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.practice-status-card .practice-indicator {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    background: #27ae60;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.practice-status-card .student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.practice-status-card .student-name {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
}

.practice-status-card .practice-duration {
    background: #e8d5f2;
    color: #6a1b9a;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.practice-status-card .practice-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
}

.practice-status-card .detail-item {
    display: flex;
    flex-direction: column;
}

.practice-status-card .detail-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 3px;
}

.practice-status-card .detail-value {
    font-weight: 600;
    color: var(--text-color);
}

.practice-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.practice-empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.practice-empty-state-title {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--text-color);
}

.practice-empty-state-description {
    font-size: 0.9rem;
    line-height: 1.4;
}

/* ç­›é€‰å™¨ */
.filters {
    background: white;
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 25px;
    box-shadow: var(--shadow);
}

.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
}

.filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
}

.filter-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 5px;
}

.filter-select, .filter-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.filter-select:focus, .filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* æ“ä½œæŒ‰é’® */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: var(--mobile-font-size);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: var(--touch-target-size);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}


.btn:hover {
    transform: translateY(-2px);
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-warning {
    background: var(--warning-color);
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

/* æ¨¡æ€æ¡† */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    animation: fadeIn 0.3s ease;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    max-width: min(600px, 95vw);
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideIn 0.3s ease;
    margin: env(safe-area-inset-top) auto env(safe-area-inset-bottom) auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    color: var(--danger-color);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* è¡¨æ ¼æ ·å¼ */
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
}

.data-table th,
.data-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: var(--text-color);
}

.data-table tr:hover {
    background: #f8f9fa;
}

@media (max-width: 768px) {
    .container {
        padding: var(--mobile-padding);
    }
    
    .header {
        margin-bottom: 20px;
        padding: max(20px, env(safe-area-inset-top) + 15px) 15px 20px 15px;
    }
    
    .nav-tabs {
        margin-bottom: 20px;
        padding: 3px;
    }
    
    .nav-tab {
        padding: 10px 12px;
        font-size: 14px;
        min-width: 100px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
    }
    
    .stat-card {
        padding: 15px;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .student-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .student-card {
        padding: 15px;
    }
    
    .student-details {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .filter-row {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .filter-group {
        min-width: auto;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 8px;
    }
    
    .btn {
        width: 100%;
        padding: 15px 20px;
        font-size: 16px;
    }
    
    .modal-content {
        padding: 20px;
        border-radius: 12px 12px 0 0;
        max-height: 85vh;
    }
    
    .data-table {
        font-size: 14px;
        overflow-x: auto;
        display: block;
        white-space: nowrap;
    }
    
    .data-table th,
    .data-table td {
        padding: 8px 10px;
        min-width: 80px;
    }
    
    .connection-status {
        top: max(10px, env(safe-area-inset-top) + 5px);
        right: 10px;
        font-size: 12px;
        padding: 6px 10px;
    }
    
    .sync-indicator {
        bottom: max(10px, env(safe-area-inset-bottom) + 5px);
        right: 10px;
        font-size: 13px;
        padding: 8px 12px;
    }
    
    .history-timeline {
        justify-content: center;
    }
    
    .history-day {
        width: 28px;
        height: 28px;
        font-size: 0.75rem;
    }
    
    .card {
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .date-picker {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .date-input, .filter-select, .filter-input {
        font-size: 16px;
        padding: 12px;
        border-radius: 8px;
    }
}

/* è¶…å°å±å¹•ä¼˜åŒ– */
@media (max-width: 480px) {
    .container {
        padding: 10px;
    }
    
    .header h1 {
        font-size: 1.5rem;
    }
    
    .header .subtitle {
        font-size: 0.9rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
    
    .student-name {
        font-size: 1.1rem;
    }
    
    .detail-label {
        font-size: 0.8rem;
    }
    
    .detail-value {
        font-size: 0.9rem;
    }
}

/* iOS Safari ç‰¹æ®Šä¼˜åŒ– */
@supports (-webkit-touch-callout: none) {
    .nav-tabs {
        -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
        -webkit-overflow-scrolling: touch;
    }
    
    input, select, textarea {
        -webkit-appearance: none;
        border-radius: 8px;
    }
    
    .btn {
        -webkit-appearance: none;
    }
}

/* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
@media (max-width: 768px) and (orientation: landscape) {
    .header {
        padding: max(15px, env(safe-area-inset-top) + 10px) 20px 15px 20px;
    }
    
    .header h1 {
        font-size: 1.8rem;
        margin-bottom: 5px;
    }
    
    .header .subtitle {
        font-size: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .modal-content {
        max-height: 80vh;
    }
}

/* åŠ è½½åŠ¨ç”» */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ç©ºçŠ¶æ€ */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: var(--text-color);
}

.empty-state-description {
    font-size: 1rem;
    line-height: 1.6;
}

/* æ—¥æœŸé€‰æ‹©å™¨æ ·å¼ */
.date-picker {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.date-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
}

/* å¯¼å‡ºæŒ‰é’®æ ·å¼ */
.export-options {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
.sync-indicator {
    position: fixed;
    bottom: max(20px, env(safe-area-inset-bottom) + 10px);
    right: 20px;
    padding: 10px 15px;
    background: white;
    border-radius: 25px;
    box-shadow: var(--shadow);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 1000;
    min-height: var(--touch-target-size);
}


.sync-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success-color);
}

.sync-dot.syncing {
    background: var(--warning-color);
    animation: pulse 1s infinite;
}

.sync-dot.error {
    background: var(--danger-color);
}
/* è§¦æ‘¸ä¼˜åŒ– */
.student-card, .stat-card, .btn, .nav-tab {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
    tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.student-card:active, .stat-card:active {
    transform: scale(0.98);
}

.btn:active {
    transform: scale(0.95);
}

/* iOSå®‰å…¨åŒºåŸŸé€‚é… */
@supports (padding: max(0px)) {
    .container {
        padding-left: max(20px, env(safe-area-inset-left));
        padding-right: max(20px, env(safe-area-inset-right));
    }
    
    @media (max-width: 768px) {
        .container {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }
    }
}

/* é˜²æ­¢ç¼©æ”¾ */
input[type="text"], input[type="date"], select, textarea {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

/* æ»šåŠ¨æ¡ä¼˜åŒ– */
.modal-content, .sync-logs {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

.modal-content::-webkit-scrollbar, .sync-logs::-webkit-scrollbar {
    width: 4px;
}

.modal-content::-webkit-scrollbar-track, .sync-logs::-webkit-scrollbar-track {
    background: transparent;
}

.modal-content::-webkit-scrollbar-thumb, .sync-logs::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 2px;
}

</style>
</head>

<body>
<div class="container">
    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="connectionStatus" class="connection-status offline">
        ğŸ”´ ç¦»çº¿æ¨¡å¼
    </div>

    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>ğŸ¼ é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ </h1>
        <div class="subtitle">å­¦ç”Ÿå®æ—¶è€ƒå‹¤/ç»ƒç´æ•°æ®æŸ¥çœ‹ç³»ç»Ÿ</div>
    </div>

    <!-- å¯¼èˆªæ ‡ç­¾ -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')">ğŸ“Š è€ƒå‹¤æ¦‚è§ˆ</button>
        <button class="nav-tab" onclick="switchTab('students')">ğŸ‘¥ å­¦ç”Ÿè¯¦æƒ…</button>
        <button class="nav-tab" onclick="switchTab('reports')">ğŸ“ˆ å†å²æŠ¥å‘Š</button>
        <button class="nav-tab" onclick="switchTab('sync')">ğŸ”„ æ•°æ®åŒæ­¥</button>
    </div>

    <!-- è€ƒå‹¤æ¦‚è§ˆæ ‡ç­¾é¡µ -->
    <div id="dashboardTab" class="tab-content">
        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label">æ€»å­¦ç”Ÿæ•°</div>
                <div class="stat-description">å·²ç™»è®°å­¦ç”Ÿ</div>
            </div>
            <div class="stat-card present">
                <div class="stat-number" id="presentCount">0</div>
                <div class="stat-label">æ­£å¸¸å‡ºå‹¤</div>
                <div class="stat-description">ä»Šæ—¥å‡ºå‹¤ç‡</div>
            </div>
            <div class="stat-card absent">
                <div class="stat-number" id="absentCount">0</div>
                <div class="stat-label">ç¼ºå‹¤å­¦ç”Ÿ</div>
                <div class="stat-description">éœ€è¦å…³æ³¨</div>
            </div>
            <div class="stat-card excused">
                <div class="stat-number" id="excusedCount">0</div>
                <div class="stat-label">è¯·å‡å­¦ç”Ÿ</div>
                <div class="stat-description">å·²æ‰¹å‡†è¯·å‡</div>
            </div>
        </div>
        <!-- å®æ—¶ç»ƒç´çŠ¶æ€ -->
        <div class="card">
            <h3>ğŸ¹ å®æ—¶ç»ƒç´çŠ¶æ€</h3>
            <div class="date-picker">
                <span style="color: #666; font-size: 14px;">å½“å‰æ—¶é—´ï¼š<span id="currentTime"></span></span>
                <button class="btn btn-primary" onclick="refreshPracticeStatus()">
                    <span>ğŸ”„</span> åˆ·æ–°çŠ¶æ€
                </button>
            </div>
            <div id="practiceStatusContainer">
                <div id="practiceStudentList" class="student-grid">
                    <!-- æ­£åœ¨ç»ƒç´çš„å­¦ç”Ÿå¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥è€ƒå‹¤å¿«ç…§ -->
        <div class="card">
            <h3>ğŸ“… ä»Šæ—¥è€ƒå‹¤å¿«ç…§</h3>
            <div class="date-picker">
                <label for="dateSelect">é€‰æ‹©æ—¥æœŸï¼š</label>
                <input type="date" id="dateSelect" class="date-input" onchange="loadAttendanceData()">
                <button class="btn btn-primary" onclick="refreshData()">
                    <span>ğŸ”„</span> åˆ·æ–°æ•°æ®
                </button>
            </div>
            <div id="todaySnapshot" class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- å­¦ç”Ÿè¯¦æƒ…æ ‡ç­¾é¡µ -->
    <div id="studentsTab" class="tab-content" style="display: none;">
        <!-- ç­›é€‰å™¨ -->
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">ä¸“ä¸šç­›é€‰</label>
                    <select id="majorFilter" class="filter-select" onchange="filterStudents()">
                        <option value="">æ‰€æœ‰ä¸“ä¸š</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">å¹´çº§ç­›é€‰</label>
                    <select id="gradeFilter" class="filter-select" onchange="filterStudents()">
                        <option value="">æ‰€æœ‰å¹´çº§</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">è€ƒå‹¤çŠ¶æ€</label>
                    <select id="statusFilter" class="filter-select" onchange="filterStudents()">
                        <option value="">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="present">æ­£å¸¸å‡ºå‹¤</option>
                        <option value="absent">ç¼ºå‹¤</option>
                        <option value="excused">è¯·å‡</option>
                        <option value="low-efficiency">ä½æ•ˆå‡ºå‹¤</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">æœç´¢å­¦ç”Ÿ</label>
                    <input type="text" id="studentSearch" class="filter-input" placeholder="è¾“å…¥å­¦ç”Ÿå§“å..." oninput="filterStudents()">
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="refreshData()">
                <span>ğŸ”„</span> åˆ·æ–°æ•°æ®
            </button>
        </div>

        <!-- å­¦ç”Ÿåˆ—è¡¨ -->
        <div id="studentList" class="student-grid">
            <!-- å­¦ç”Ÿå¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- å†å²æŠ¥å‘Šæ ‡ç­¾é¡µ -->
    <div id="reportsTab" class="tab-content" style="display: none;">
        <div class="card">
            <h3>ğŸ“ˆ è€ƒå‹¤å†å²åˆ†æ</h3>
            
            <!-- æ—¥æœŸèŒƒå›´é€‰æ‹© -->
            <div class="date-picker">
                <label for="startDate">å¼€å§‹æ—¥æœŸï¼š</label>
                <input type="date" id="startDate" class="date-input">
                <label for="endDate">ç»“æŸæ—¥æœŸï¼š</label>
                <input type="date" id="endDate" class="date-input">
                <button class="btn btn-primary" onclick="generateReport()">
                    <span>ğŸ“Š</span> ç”ŸæˆæŠ¥å‘Š
                </button>
            </div>

            <!-- æŠ¥å‘Šå†…å®¹ -->
            <div id="reportContent">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“Š</div>
                    <div class="empty-state-title">é€‰æ‹©æ—¥æœŸèŒƒå›´ç”ŸæˆæŠ¥å‘Š</div>
                    <div class="empty-state-description">é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼Œç„¶åç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"æŒ‰é’®æŸ¥çœ‹è¯¦ç»†çš„è€ƒå‹¤åˆ†æ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®åŒæ­¥æ ‡ç­¾é¡µ -->
    <div id="syncTab" class="tab-content" style="display: none;">
        <div class="card">
            <h3>ğŸ”„ æ•°æ®åŒæ­¥ç®¡ç†</h3>
            
            <!-- åŒæ­¥çŠ¶æ€ -->
            <div class="card success" id="syncStatus">
                <h4>åŒæ­¥çŠ¶æ€</h4>
                <p id="syncStatusText">æ­£åœ¨æ£€æŸ¥è¿æ¥çŠ¶æ€...</p>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="forceSyncData()">
                        <span>ğŸ”„</span> å¼ºåˆ¶åŒæ­¥
                    </button>
                    <button class="btn btn-warning" onclick="clearLocalCache()">
                        <span>ğŸ—‘ï¸</span> æ¸…é™¤ç¼“å­˜
                    </button>
                </div>
            </div>

            <!-- åŒæ­¥æ—¥å¿— -->
            <div class="card">
                <h4>ğŸ“‹ åŒæ­¥æ—¥å¿—</h4>
                <div id="syncLogs" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 14px;">
                    <!-- åŒæ­¥æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <!-- åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="syncIndicator" class="sync-indicator">
        <div class="sync-dot" id="syncDot"></div>
        <span id="syncText">ç¦»çº¿æ¨¡å¼</span>
    </div>
</div>

<!-- å­¦ç”Ÿè¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="studentDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="studentDetailTitle">å­¦ç”Ÿè¯¦æƒ…</h3>
            <button class="modal-close" onclick="closeModal('studentDetailModal')">&times;</button>
        </div>
        <div id="studentDetailContent">
            <!-- å­¦ç”Ÿè¯¦ç»†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>
</div>

<script>
// Firebase é…ç½®
const firebaseConfig = {
  apiKey: "AIzaSyBfRjrAKsVUAHBl5WbBl96YONrkRe1UWUo",
  authDomain: "menuhin-studio-system.firebaseapp.com",
  databaseURL: "https://menuhin-studio-system-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "menuhin-studio-system",
  storageBucket: "menuhin-studio-system.firebasestorage.app",
  messagingSenderId: "218592951152",
  appId: "1:218592951152:web:650d080726b6c44f5a2db5",
  measurementId: "G-P49SZQTLT7"
};

// å…¨å±€å˜é‡
let database = null;
let isOnline = false;
let currentTab = 'dashboard';
let attendanceData = {};
let studentData = {};
let syncLogs = [];
let rooms = [];

// åˆå§‹åŒ– Firebase
function initFirebase() {
    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        
        // ç›‘å¬è¿æ¥çŠ¶æ€
        database.ref('.info/connected').on('value', (snapshot) => {
            isOnline = snapshot.val() === true;
            updateConnectionStatus();
            
            if (isOnline) {
                addSyncLog('âœ… å·²è¿æ¥åˆ°Firebaseæ•°æ®åº“');
                loadInitialData();
            } else {
                addSyncLog('âŒ ä¸Firebaseæ•°æ®åº“æ–­å¼€è¿æ¥');
            }
        });
        
        // ç›‘å¬è€ƒå‹¤æ•°æ®å˜åŒ–
        database.ref('attendanceData').on('value', (snapshot) => {
            if (snapshot.exists()) {
                attendanceData = snapshot.val();
                addSyncLog('ğŸ“¥ è€ƒå‹¤æ•°æ®å·²æ›´æ–°');
                updateDashboard();
                updateStudentList();
            }
        });
        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬å®æ—¶ç»ƒç´çŠ¶æ€å˜åŒ–
        database.ref('realTimePracticeStatus').on('value', (snapshot) => {
            if (snapshot.exists()) {
                handleRemoteRealTimePracticeUpdate(snapshot.val());
            }
        });
        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬ç´æˆ¿çŠ¶æ€å˜åŒ–
        database.ref('rooms').on('value', (snapshot) => {
            if (snapshot.exists()) {
                handleRoomsUpdate(snapshot.val());
            }
        });

        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬å®æ—¶ç»ƒç´çŠ¶æ€
        database.ref('realTimePracticeStatus').on('value', (snapshot) => {
            if (snapshot.exists()) {
                handleRealTimePracticeUpdate(snapshot.val());
            }
        });

        
        // ç›‘å¬å­¦ç”Ÿæ•°æ®å˜åŒ–
        database.ref('studentDatabase').on('value', (snapshot) => {
            if (snapshot.exists()) {
                studentData = snapshot.val();
                addSyncLog('ğŸ“¥ å­¦ç”Ÿæ•°æ®å·²æ›´æ–°');
                updateFilters();
                updateStudentList();
            }
        });
        
    } catch (error) {
        console.error('Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
        addSyncLog('âŒ Firebaseåˆå§‹åŒ–å¤±è´¥: ' + error.message);
    }
}
    // ğŸ”¥ æ–°å¢ï¼šå¤„ç†ç´æˆ¿çŠ¶æ€æ›´æ–°
    function handleRoomsUpdate(roomsData) {
        if (!roomsData || !Array.isArray(roomsData)) return;
        
        console.log('ğŸ  æ”¶åˆ°ç´æˆ¿çŠ¶æ€æ›´æ–°:', roomsData);
        
        // æ›´æ–°å…¨å±€ç´æˆ¿çŠ¶æ€
        rooms = roomsData;
        
        // æå–å®æ—¶ç»ƒç´çŠ¶æ€
        const realTimePractice = {};
        
        roomsData.forEach(room => {
            if (room.student && room.student !== 'ç©ºé—²') {
                const studentName = room.student;
                const now = Date.now();
                const registerTime = new Date(room.registerTime).getTime();
                const currentDuration = Math.floor((now - registerTime) / 1000);
                
                realTimePractice[studentName] = {
                    room: room.name,
                    startTime: room.registerTime,
                    currentDuration: currentDuration,
                    status: 'practicing',
                    lastUpdated: now,
                    syncSource: 'rooms'
                };
            }
        });
        
        // ç¡®ä¿ attendanceData å­˜åœ¨
        if (!attendanceData) {
            attendanceData = {};
        }
        
        // æ›´æ–°å®æ—¶ç»ƒç´çŠ¶æ€
        if (!attendanceData.realTimePractice) {
            attendanceData.realTimePractice = {};
        }
        
        // åˆå¹¶çŠ¶æ€ï¼ˆä¿ç•™ç°æœ‰çŠ¶æ€ï¼Œæ›´æ–°æ–°çŠ¶æ€ï¼‰
        Object.keys(realTimePractice).forEach(studentName => {
            attendanceData.realTimePractice[studentName] = realTimePractice[studentName];
        });
        
        // æ¸…ç†å·²ç¦»å¼€ç´æˆ¿çš„å­¦ç”Ÿ
        Object.keys(attendanceData.realTimePractice).forEach(studentName => {
            if (!realTimePractice[studentName]) {
                delete attendanceData.realTimePractice[studentName];
                console.log(`ğŸ§¹ æ¸…ç†å·²ç¦»å¼€ç´æˆ¿çš„å­¦ç”Ÿ: ${studentName}`);
            }
        });
        
        // åˆ·æ–°æ˜¾ç¤º
        if (isAttendanceModalOpen) {
            renderAttendanceList(false);
        }
        
        addSyncLog('ğŸ  ç´æˆ¿çŠ¶æ€å·²åŒæ­¥');
    }

    // ğŸ”¥ æ–°å¢ï¼šå¤„ç†å®æ—¶ç»ƒç´çŠ¶æ€æ›´æ–°
    function handleRealTimePracticeUpdate(practiceData) {
        if (!practiceData || typeof practiceData !== 'object') return;
        
        console.log('ğŸ¹ æ”¶åˆ°å®æ—¶ç»ƒç´çŠ¶æ€æ›´æ–°:', practiceData);
        
        // ç¡®ä¿ attendanceData å­˜åœ¨
        if (!attendanceData) {
            attendanceData = {};
        }
        
        if (!attendanceData.realTimePractice) {
            attendanceData.realTimePractice = {};
        }
        
        let hasChanges = false;
        
        // æ›´æ–°ç»ƒç´çŠ¶æ€
        Object.keys(practiceData).forEach(studentName => {
            const newStatus = practiceData[studentName];
            const currentStatus = attendanceData.realTimePractice[studentName];
            
            if (!currentStatus || JSON.stringify(currentStatus) !== JSON.stringify(newStatus)) {
                attendanceData.realTimePractice[studentName] = {
                    ...newStatus,
                    lastUpdated: Date.now(),
                    syncSource: 'realTime'
                };
                hasChanges = true;
            }
        });
        
        // æ¸…ç†ä¸å­˜åœ¨çš„çŠ¶æ€
        Object.keys(attendanceData.realTimePractice).forEach(studentName => {
            if (!practiceData[studentName]) {
                delete attendanceData.realTimePractice[studentName];
                hasChanges = true;
            }
        });
        
        if (hasChanges) {
            // åˆ·æ–°æ˜¾ç¤º
            if (isAttendanceModalOpen) {
                renderAttendanceList(false);
            }
            
            addSyncLog('ğŸ¹ å®æ—¶ç»ƒç´çŠ¶æ€å·²åŒæ­¥');
        }
    }
// ğŸ”¥ æ–°å¢ï¼šå®šæœŸåˆ·æ–°å®æ—¶çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
setInterval(() => {
    if (currentTab === 'dashboard' || currentTab === 'students') {
        // åªåœ¨ç›¸å…³æ ‡ç­¾é¡µæ—¶åˆ·æ–°
        updateRealTimeDisplay();
    }
}, 30000);

// ğŸ”¥ æ–°å¢ï¼šæ›´æ–°å®æ—¶æ˜¾ç¤º
function updateRealTimeDisplay() {
    if (currentTab === 'dashboard') {
        loadAttendanceData();
    } else if (currentTab === 'students') {
        loadStudentList();
    }
}

// ğŸ”¥ ä¿®æ”¹ï¼šå¤„ç†å®æ—¶ç»ƒç´çŠ¶æ€æ›´æ–°æ—¶ç«‹å³åˆ·æ–°æ˜¾ç¤º
function handleRemoteRealTimePracticeUpdate(practiceStatusData) {
    if (!practiceStatusData || typeof practiceStatusData !== 'object') return;
    
    console.log('ğŸ“¥ æ”¶åˆ°å®æ—¶ç»ƒç´çŠ¶æ€æ›´æ–°:', practiceStatusData);
    
    // ç¡®ä¿è€ƒå‹¤æ•°æ®ç»“æ„å­˜åœ¨
    if (!attendanceData.realTimePractice) {
        attendanceData.realTimePractice = {};
    }
    
    let hasChanges = false;
    
    // å¤„ç†æ¯ä¸ªå­¦ç”Ÿçš„å®æ—¶çŠ¶æ€
    Object.keys(practiceStatusData).forEach(studentName => {
        const remoteStatus = practiceStatusData[studentName];
        const currentStatus = attendanceData.realTimePractice[studentName];
        
        if (!currentStatus || JSON.stringify(currentStatus) !== JSON.stringify(remoteStatus)) {
            attendanceData.realTimePractice[studentName] = {
                ...remoteStatus,
                lastUpdated: Date.now(),
                syncSource: 'remote'
            };
            hasChanges = true;
        }
    });
    
    // æ¸…ç†ä¸å†å­˜åœ¨çš„å­¦ç”ŸçŠ¶æ€
    if (attendanceData.realTimePractice) {
        Object.keys(attendanceData.realTimePractice).forEach(studentName => {
            if (!practiceStatusData[studentName]) {
                delete attendanceData.realTimePractice[studentName];
                hasChanges = true;
            }
        });
    }
    
    if (hasChanges) {
        // ğŸ”¥ å…³é”®ï¼šç«‹å³åˆ·æ–°æ˜¾ç¤ºï¼Œæ— è®ºæ˜¯å¦å·¥ä½œæ—¥
        updateRealTimeDisplay();
        
        // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°é¦–é¡µå®æ—¶ç»ƒç´çŠ¶æ€
        if (currentTab === 'dashboard') {
            displayPracticeStatus();
        }

        // æŒä¹…åŒ–åˆ°æœ¬åœ°
        localStorage.setItem('realTimePracticeStatus', JSON.stringify(attendanceData.realTimePractice));
        
        addSyncLog('ğŸ¹ å®æ—¶ç»ƒç´çŠ¶æ€å·²åŒæ­¥');
    }
}

// æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
function updateConnectionStatus() {
    const statusEl = document.getElementById('connectionStatus');
    const syncDot = document.getElementById('syncDot');
    const syncText = document.getElementById('syncText');
    
    if (isOnline) {
        statusEl.className = 'connection-status online';
        statusEl.innerHTML = 'ğŸŸ¢ å·²è¿æ¥';
        syncDot.className = 'sync-dot';
        syncText.textContent = 'å®æ—¶åŒæ­¥';
    } else {
        statusEl.className = 'connection-status offline';
        statusEl.innerHTML = 'ğŸ”´ ç¦»çº¿æ¨¡å¼';
        syncDot.className = 'sync-dot error';
        syncText.textContent = 'ç¦»çº¿æ¨¡å¼';
    }
}

// æ·»åŠ åŒæ­¥æ—¥å¿—
function addSyncLog(message) {
    const timestamp = new Date().toLocaleString();
    const logEntry = `[${timestamp}] ${message}`;
    syncLogs.unshift(logEntry);
    
    // é™åˆ¶æ—¥å¿—æ•°é‡
    if (syncLogs.length > 100) {
        syncLogs = syncLogs.slice(0, 100);
    }
    
    updateSyncLogsDisplay();
}

// æ›´æ–°åŒæ­¥æ—¥å¿—æ˜¾ç¤º
function updateSyncLogsDisplay() {
    const logsEl = document.getElementById('syncLogs');
    if (logsEl) {
        logsEl.innerHTML = syncLogs.join('\n');
        logsEl.scrollTop = 0;
    }
}

// åŠ è½½åˆå§‹æ•°æ®
function loadInitialData() {
    if (!isOnline) return;
    
    addSyncLog('ğŸ”„ å¼€å§‹åŠ è½½æ•°æ®...');
    
    // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = today;
    
    loadAttendanceData();
}

// åŠ è½½è€ƒå‹¤æ•°æ®
function loadAttendanceData() {
    const selectedDate = document.getElementById('dateSelect').value;
    if (!selectedDate) return;
    
    showLoading('todaySnapshot');
    
    if (isOnline) {
        // ä»FirebaseåŠ è½½æ•°æ®
        database.ref(`attendanceData/${selectedDate}`).once('value')
            .then((snapshot) => {
                const data = snapshot.val() || {};
                displayAttendanceSnapshot(data, selectedDate);
                addSyncLog(`ğŸ“Š å·²åŠ è½½ ${selectedDate} çš„è€ƒå‹¤æ•°æ®`);
            })
            .catch((error) => {
                console.error('åŠ è½½è€ƒå‹¤æ•°æ®å¤±è´¥:', error);
                addSyncLog('âŒ åŠ è½½è€ƒå‹¤æ•°æ®å¤±è´¥: ' + error.message);
                showEmptyState('todaySnapshot', 'åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½è€ƒå‹¤æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
    } else {
        // ç¦»çº¿æ¨¡å¼ï¼Œä»æœ¬åœ°å­˜å‚¨åŠ è½½
        const localData = localStorage.getItem(`attendance_${selectedDate}`);
        if (localData) {
            displayAttendanceSnapshot(JSON.parse(localData), selectedDate);
        } else {
            showEmptyState('todaySnapshot', 'æš‚æ— æ•°æ®', 'ç¦»çº¿æ¨¡å¼ä¸‹æ²¡æœ‰æ‰¾åˆ°è¯¥æ—¥æœŸçš„è€ƒå‹¤æ•°æ®');
        }
        
        // ğŸ”¥ æ–°å¢ï¼šç¦»çº¿æ¨¡å¼ä¸‹ä¹Ÿæ˜¾ç¤ºå®æ—¶ç»ƒç´çŠ¶æ€
        displayPracticeStatus();

        // ğŸ”¥ æ–°å¢ï¼šåˆå¹¶å®æ—¶ç»ƒç´çŠ¶æ€
        if (window.globalAttendanceData && window.globalAttendanceData.realTimePractice) {
            // å°†å®æ—¶ç»ƒç´çŠ¶æ€åˆå¹¶åˆ°å½“å‰åŠ è½½çš„æ•°æ®ä¸­
            if (!attendanceData) attendanceData = {};
            attendanceData.realTimePractice = window.globalAttendanceData.realTimePractice;
            attendanceData = mergeRealTimePracticeStatus(attendanceData);
        }

    }

}

// æ˜¾ç¤ºè€ƒå‹¤å¿«ç…§
function displayAttendanceSnapshot(data, date) {
    const container = document.getElementById('todaySnapshot');
    
    if (!data || Object.keys(data).length === 0) {
        showEmptyState('todaySnapshot', 'æš‚æ— æ•°æ®', `${date} è¿˜æ²¡æœ‰è€ƒå‹¤è®°å½•`);
        return;
    }
    
    let html = '<div class="student-grid">';
    
    // æŒ‰ä¸“ä¸šåˆ†ç»„æ˜¾ç¤º
    const groupedByMajor = {};
    Object.values(data).forEach(student => {
        const major = student.major || 'å…¶ä»–';
        if (!groupedByMajor[major]) {
            groupedByMajor[major] = [];
        }
        groupedByMajor[major].push(student);
    });
    
    Object.keys(groupedByMajor).sort().forEach(major => {
        html += `<div style="grid-column: 1 / -1; margin: 20px 0 10px 0;">
                    <h4 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">
                        ${major} (${groupedByMajor[major].length}äºº)
                    </h4>
                </div>`;
        
        groupedByMajor[major].forEach(student => {
            html += createStudentCard(student, true);
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
    

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    updateStatistics(data);
    
    // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°å®æ—¶ç»ƒç´çŠ¶æ€æ˜¾ç¤º
    displayPracticeStatus();

}

// åˆ›å»ºå­¦ç”Ÿå¡ç‰‡
function createStudentCard(student, isSnapshot = false) {
    const statusClass = getStatusClass(student.finalAttendanceStatus);
    const statusText = getStatusText(student.finalAttendanceStatus);
    
    return `
        <div class="student-card ${statusClass}" onclick="showStudentDetail('${student.name}')">
            <div class="student-header">
                <div class="student-name">${student.name}</div>
                <div class="student-status ${statusClass}">${statusText}</div>
            </div>
            <div class="student-details">
                <div class="detail-item">
                    <div class="detail-label">ä¸“ä¸š</div>
                    <div class="detail-value">${student.major || 'æœªè®¾ç½®'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">å¹´çº§</div>
                    <div class="detail-value">${student.grade || 'æœªè®¾ç½®'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">æ—¶é—´æ®µ</div>
                    <div class="detail-value">${student.start || ''} - ${student.end || ''}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ç»ƒç´æ—¶é•¿</div>
                    <div class="detail-value">${student.practicedText || '0åˆ†é’Ÿ'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">æ‰€åœ¨ç´æˆ¿</div>
                    <div class="detail-value">${student.room || 'ä¸åœ¨ç´æˆ¿'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">å‡ºå‹¤ç‡</div>
                    <div class="detail-value">${calculateAttendanceRate(student)}%</div>
                </div>
            </div>
            ${!isSnapshot ? createAttendanceHistory(student) : ''}
        </div>
    `;
}

// åˆ›å»ºè€ƒå‹¤å†å²æ—¶é—´è½´
function createAttendanceHistory(student) {
    const history = student.attendanceHistory || [];
    const last7Days = getLast7Days();
    
    let historyHtml = '<div class="attendance-history"><div class="history-title">æœ€è¿‘7å¤©è€ƒå‹¤</div><div class="history-timeline">';
    
    last7Days.forEach(date => {
        const dayData = history.find(h => h.date === date);
        const status = dayData ? dayData.status : 'no-data';
        const day = new Date(date).getDate();
        
        historyHtml += `<div class="history-day ${status}" title="${date} - ${getStatusText(status)}">${day}</div>`;
    });
    
    historyHtml += '</div></div>';
    return historyHtml;
}

// è·å–æœ€è¿‘7å¤©æ—¥æœŸ
function getLast7Days() {
    const dates = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toISOString().split('T')[0]);
    }
    return dates;
}

// ä¿®æ”¹çŠ¶æ€æ ·å¼å’Œæ–‡æœ¬
function getStatusClass(status) {
    const statusMap = {
        'present': 'present',
        'absent': 'absent',
        'excused': 'excused',
        'low_efficiency': 'low-efficiency',
        'under_review': 'low-efficiency',
        'practicing_unscheduled': 'practicing-unscheduled',
        'weekend': 'weekend' // ğŸ”¥ æ–°å¢å‘¨æœ«çŠ¶æ€
    };
    return statusMap[status] || 'absent';
}

function getStatusText(status) {
    const statusMap = {
        'present': 'æ­£å¸¸å‡ºå‹¤',
        'absent': 'ç¼ºå‹¤',
        'excused': 'è¯·å‡',
        'low_efficiency': 'ä½æ•ˆå‡ºå‹¤',
        'under_review': 'å¾…è§‚å¯Ÿ',
        'no-data': 'æ— æ•°æ®',
        'practicing_unscheduled': 'æ—¶é—´æ®µå¤–ç»ƒç´',
        'weekend': 'å‘¨æœ«' // ğŸ”¥ æ–°å¢
    };
    return statusMap[status] || 'æœªçŸ¥';
}

// è®¡ç®—å‡ºå‹¤ç‡
function calculateAttendanceRate(student) {
    if (!student.attendanceHistory || student.attendanceHistory.length === 0) {
        return 0;
    }
    
    const totalDays = student.attendanceHistory.length;
    const presentDays = student.attendanceHistory.filter(h => 
        h.status === 'present' || h.status === 'low_efficiency'
    ).length;
    
    return Math.round((presentDays / totalDays) * 100);
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®
// ä¿®æ”¹ç»Ÿè®¡æ›´æ–°å‡½æ•°
function updateStatistics(data) {
    const students = Object.values(data);
    const total = students.length;
    const present = students.filter(s => s.finalAttendanceStatus === 'present').length;
    const absent = students.filter(s => s.finalAttendanceStatus === 'absent').length;
    const excused = students.filter(s => s.finalAttendanceStatus === 'excused').length;
    const unscheduled = students.filter(s => s.finalAttendanceStatus === 'practicing_unscheduled').length;
    const weekend = students.filter(s => s.finalAttendanceStatus === 'weekend').length;
    
    // ğŸ”¥ æ ¹æ®æ—¥æœŸç±»å‹æ˜¾ç¤ºä¸åŒçš„ç»Ÿè®¡å¡ç‰‡
    if (isWeekend()) {
        // å‘¨æœ«æ˜¾ç¤ºç»ƒç´ç»Ÿè®¡
        updateWeekendStats(total, unscheduled, weekend - unscheduled);
    } else {
        // å·¥ä½œæ—¥æ˜¾ç¤ºè€ƒå‹¤ç»Ÿè®¡
        updateWeekdayStats(total, present, absent, excused, unscheduled);
    }
}
// ğŸ”¥ æ–°å¢ï¼šåˆ·æ–°ç»ƒç´çŠ¶æ€
function refreshPracticeStatus() {
    updateCurrentTime();
    displayPracticeStatus();
    addSyncLog('ğŸ¹ å·²åˆ·æ–°å®æ—¶ç»ƒç´çŠ¶æ€');
}

// ğŸ”¥ æ–°å¢ï¼šæ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const currentTimeEl = document.getElementById('currentTime');
    if (currentTimeEl) {
        currentTimeEl.textContent = timeString;
    }
}

// ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºå®æ—¶ç»ƒç´çŠ¶æ€
function displayPracticeStatus() {
    const container = document.getElementById('practiceStudentList');
    if (!container) return;
    
    // è·å–å®æ—¶ç»ƒç´æ•°æ®
    const practiceData = attendanceData.realTimePractice || {};
    const practiceStudents = Object.keys(practiceData);
    
    if (practiceStudents.length === 0) {
        container.innerHTML = `
            <div class="practice-empty-state" style="grid-column: 1 / -1;">
                <div class="practice-empty-state-icon">ğŸ¹</div>
                <div class="practice-empty-state-title">å½“å‰æ²¡æœ‰å­¦ç”Ÿåœ¨ç»ƒç´</div>
                <div class="practice-empty-state-description">
                    ${isWeekend() ? 'å‘¨æœ«æ—¶é—´ï¼Œå­¦ç”Ÿå¯è‡ªä¸»å®‰æ’ç»ƒç´' : 'å·¥ä½œæ—¥æ—¶é—´ï¼Œç­‰å¾…å­¦ç”Ÿå¼€å§‹ç»ƒç´'}
                </div>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    // æŒ‰ç»ƒç´æ—¶é•¿æ’åºï¼ˆæ—¶é—´é•¿çš„åœ¨å‰ï¼‰
    const sortedStudents = practiceStudents.sort((a, b) => {
        const durationA = practiceData[a].currentDuration || 0;
        const durationB = practiceData[b].currentDuration || 0;
        return durationB - durationA;
    });
    
    sortedStudents.forEach(studentName => {
        const practiceInfo = practiceData[studentName];
        const studentInfo = getStudentInfoFromDatabase(studentName);
        const duration = formatPracticeDuration(practiceInfo.currentDuration || 0);
        const startTime = new Date(practiceInfo.startTime).toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        html += `
            <div class="practice-status-card" onclick="showStudentDetail('${studentName}')">
                <div class="practice-indicator"></div>
                <div class="student-header">
                    <div class="student-name">${studentName}</div>
                    <div class="practice-duration">${duration}</div>
                </div>
                <div class="practice-details">
                    <div class="detail-item">
                        <div class="detail-label">æ‰€åœ¨ç´æˆ¿</div>
                        <div class="detail-value">${practiceInfo.room || 'æœªçŸ¥ç´æˆ¿'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å¼€å§‹æ—¶é—´</div>
                        <div class="detail-value">${startTime}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ä¸“ä¸š</div>
                        <div class="detail-value">${studentInfo.major}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ç»ƒç´ç±»å‹</div>
                        <div class="detail-value">${isWeekend() ? 'å‘¨æœ«è‡ªä¸»ç»ƒç´' : 'æ—¶é—´æ®µå¤–ç»ƒç´'}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ğŸ”¥ æ–°å¢ï¼šåˆå§‹åŒ–å®æ—¶ç»ƒç´çŠ¶æ€æ˜¾ç¤º
function initPracticeStatusDisplay() {
    updateCurrentTime();
    displayPracticeStatus();
    
    // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´å’ŒçŠ¶æ€
    setInterval(() => {
        updateCurrentTime();
        if (currentTab === 'dashboard') {
            displayPracticeStatus();
        }
    }, 30000);
    
    // æ¯ç§’æ›´æ–°æ—¶é—´æ˜¾ç¤º
    setInterval(updateCurrentTime, 1000);
}

function updateWeekendStats(total, practicing, resting) {
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('presentCount').textContent = practicing;
    document.getElementById('absentCount').textContent = resting;
    document.getElementById('excusedCount').textContent = 0;
    
    // æ›´æ–°æ ‡ç­¾æ–‡å­—
    document.querySelector('#presentCount').parentElement.querySelector('.stat-label').textContent = 'æ­£åœ¨ç»ƒç´';
    document.querySelector('#absentCount').parentElement.querySelector('.stat-label').textContent = 'æœªåœ¨ç»ƒç´';
    document.querySelector('#excusedCount').parentElement.querySelector('.stat-label').textContent = 'å‘¨æœ«';
}

function updateWeekdayStats(total, present, absent, excused, unscheduled) {
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('excusedCount').textContent = excused;
    
    // æ¢å¤å·¥ä½œæ—¥æ ‡ç­¾
    document.querySelector('#presentCount').parentElement.querySelector('.stat-label').textContent = 'æ­£å¸¸å‡ºå‹¤';
    document.querySelector('#absentCount').parentElement.querySelector('.stat-label').textContent = 'ç¼ºå‹¤å­¦ç”Ÿ';
    document.querySelector('#excusedCount').parentElement.querySelector('.stat-label').textContent = 'è¯·å‡å­¦ç”Ÿ';
}


// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(tabName) {
    // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
    document.getElementById(tabName + 'Tab').style.display = 'block';
    
    // æ·»åŠ æ´»åŠ¨çŠ¶æ€åˆ°é€‰ä¸­çš„æ ‡ç­¾
    event.target.classList.add('active');
    
    currentTab = tabName;
    
    // æ ¹æ®æ ‡ç­¾é¡µæ‰§è¡Œç›¸åº”çš„åˆå§‹åŒ–
    switch(tabName) {
        case 'students':
            loadStudentList();
            break;
        case 'reports':
            initReportsTab();
            break;
        case 'sync':
            updateSyncStatus();
            break;
    }
}

// åŠ è½½å­¦ç”Ÿåˆ—è¡¨
function loadStudentList() {
    if (!isOnline) {
        showEmptyState('studentList', 'ç¦»çº¿æ¨¡å¼', 'éœ€è¦è¿æ¥åˆ°ç½‘ç»œæ‰èƒ½æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…');
        return;
    }
    
    showLoading('studentList');
    
    // åˆå¹¶è€ƒå‹¤æ•°æ®å’Œå­¦ç”Ÿæ•°æ®
    const combinedData = combineStudentAndAttendanceData();
    displayStudentList(combinedData);
}

// ä¿®æ”¹ combineStudentAndAttendanceData å‡½æ•°
function combineStudentAndAttendanceData() {
    const combined = {};
    const today = new Date().toISOString().split('T')[0];
    const todayAttendance = attendanceData[today] || {};
    
    // ä»å­¦ç”Ÿæ•°æ®åº“è·å–æ‰€æœ‰å­¦ç”Ÿ
    Object.keys(studentData).forEach(major => {
        if (Array.isArray(studentData[major])) {
            studentData[major].forEach(student => {
                const studentName = typeof student === 'string' ? student : student.name;
                const studentGrade = typeof student === 'object' ? student.grade : '';
                
                combined[studentName] = {
                    name: studentName,
                    major: major,
                    grade: studentGrade,
                    // ğŸ”¥ ä¿®æ”¹ï¼šéå·¥ä½œæ—¥ä¹Ÿæ˜¾ç¤ºåŸºæœ¬çŠ¶æ€
                    finalAttendanceStatus: isWeekend() ? 'weekend' : 'absent',
                    finalStatusText: isWeekend() ? 'å‘¨æœ«' : 'ç¼ºå‹¤',
                    practicedText: '0åˆ†é’Ÿ',
                    room: 'ä¸åœ¨ç´æˆ¿',
                    start: '',
                    end: '',
                    attendanceHistory: getStudentAttendanceHistory(studentName)
                };
            });
        }
    });
    
    // ğŸ”¥ å…³é”®ï¼šæ— è®ºæ˜¯å¦å·¥ä½œæ—¥éƒ½åˆå¹¶å®æ—¶ç»ƒç´çŠ¶æ€
    if (attendanceData.realTimePractice) {
        Object.keys(attendanceData.realTimePractice).forEach(studentName => {
            const practiceStatus = attendanceData.realTimePractice[studentName];
            
            // å¦‚æœå­¦ç”Ÿä¸åœ¨å·²æœ‰æ•°æ®ä¸­ï¼Œåˆ›å»ºæ–°è®°å½•
            if (!combined[studentName]) {
                // è·å–å­¦ç”ŸåŸºæœ¬ä¿¡æ¯
                const studentInfo = getStudentInfoFromDatabase(studentName);
                
                combined[studentName] = {
                    name: studentName,
                    major: studentInfo.major,
                    grade: studentInfo.grade,
                    finalAttendanceStatus: 'practicing_unscheduled',
                    finalStatusText: isWeekend() ? 'å‘¨æœ«è‡ªä¸»ç»ƒç´' : 'æ—¶é—´æ®µå¤–ç»ƒç´',
                    practicedText: formatPracticeDuration(practiceStatus.currentDuration || 0),
                    room: practiceStatus.room || 'æœªçŸ¥ç´æˆ¿',
                    start: 'è‡ªä¸»ç»ƒç´',
                    end: 'è‡ªä¸»ç»ƒç´',
                    attendanceHistory: [],
                    isUnscheduledPractice: true,
                    practiceStartTime: practiceStatus.startTime,
                    practiceType: isWeekend() ? 'weekend' : 'unscheduled'
                };
            } else {
                // æ›´æ–°ç°æœ‰å­¦ç”Ÿçš„å®æ—¶ç»ƒç´ä¿¡æ¯
                combined[studentName].finalAttendanceStatus = 'practicing_unscheduled';
                combined[studentName].finalStatusText = isWeekend() ? 'å‘¨æœ«è‡ªä¸»ç»ƒç´' : 'æ—¶é—´æ®µå¤–ç»ƒç´';
                combined[studentName].room = practiceStatus.room || 'æœªçŸ¥ç´æˆ¿';
                combined[studentName].practicedText = formatPracticeDuration(practiceStatus.currentDuration || 0);
                combined[studentName].realTimePractice = {
                    room: practiceStatus.room,
                    duration: practiceStatus.currentDuration || 0,
                    isActive: true
                };
            }
        });
    }
    
    return combined;
}

// ğŸ”¥ æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«
function isWeekend() {
    const day = new Date().getDay();
    return day === 0 || day === 6; // 0=å‘¨æ—¥, 6=å‘¨å…­
}

// ğŸ”¥ æ–°å¢ï¼šä»å­¦ç”Ÿæ•°æ®åº“è·å–å­¦ç”Ÿä¿¡æ¯
function getStudentInfoFromDatabase(studentName) {
    for (const [major, students] of Object.entries(studentData)) {
        if (Array.isArray(students)) {
            const found = students.find(student => {
                const name = typeof student === 'string' ? student : student.name;
                return name === studentName;
            });
            if (found) {
                return {
                    major: major,
                    grade: typeof found === 'object' ? found.grade || '' : ''
                };
            }
        }
    }
    return { major: 'æœªçŸ¥ä¸“ä¸š', grade: '' };
}

// ğŸ”¥ æ–°å¢ï¼šæ ¼å¼åŒ–ç»ƒç´æ—¶é•¿
function formatPracticeDuration(seconds) {
    if (!seconds || seconds <= 0) return '0åˆ†é’Ÿ';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}å°æ—¶${minutes > 0 ? minutes + 'åˆ†é’Ÿ' : ''}`;
    } else if (minutes > 0) {
        return `${minutes}åˆ†é’Ÿ${secs > 0 ? secs + 'ç§’' : ''}`;
    } else {
        return `${secs}ç§’`;
    }
}

// è·å–å­¦ç”Ÿè€ƒå‹¤å†å²
function getStudentAttendanceHistory(studentName) {
    const history = [];
    const last30Days = getLast30Days();
    
    last30Days.forEach(date => {
        const dayData = attendanceData[date];
        if (dayData && dayData[studentName]) {
            history.push({
                date: date,
                status: dayData[studentName].finalAttendanceStatus
            });
        }
    });
    
    return history;
}

// è·å–æœ€è¿‘30å¤©æ—¥æœŸ
function getLast30Days() {
    const dates = [];
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toISOString().split('T')[0]);
    }
    return dates;
}

// æ˜¾ç¤ºå­¦ç”Ÿåˆ—è¡¨
function displayStudentList(data) {
    const container = document.getElementById('studentList');
    const students = Object.values(data);
    
    if (students.length === 0) {
        showEmptyState('studentList', 'æš‚æ— å­¦ç”Ÿæ•°æ®', 'è¯·ç¡®ä¿å­¦ç”Ÿæ•°æ®å·²æ­£ç¡®åŒæ­¥');
        return;
    }
    
    let html = '';
    students.forEach(student => {
        html += createStudentCard(student, false);
    });
    
    container.innerHTML = html;
}

// æ›´æ–°ç­›é€‰å™¨
function updateFilters() {
    updateMajorFilter();
    updateGradeFilter();
}

// æ›´æ–°ä¸“ä¸šç­›é€‰å™¨
function updateMajorFilter() {
    const select = document.getElementById('majorFilter');
    if (!select) return;
    
    const majors = Object.keys(studentData).sort();
    select.innerHTML = '<option value="">æ‰€æœ‰ä¸“ä¸š</option>';
    
    majors.forEach(major => {
        const option = document.createElement('option');
        option.value = major;
        option.textContent = major;
        select.appendChild(option);
    });
}

// æ›´æ–°å¹´çº§ç­›é€‰å™¨
function updateGradeFilter() {
    const select = document.getElementById('gradeFilter');
    if (!select) return;
    
    const grades = new Set();
    Object.values(studentData).forEach(students => {
        if (Array.isArray(students)) {
            students.forEach(student => {
                if (typeof student === 'object' && student.grade) {
                    grades.add(student.grade);
                }
            });
        }
    });
    
    select.innerHTML = '<option value="">æ‰€æœ‰å¹´çº§</option>';
    Array.from(grades).sort().forEach(grade => {
        const option = document.createElement('option');
        option.value = grade;
        option.textContent = grade;
        select.appendChild(option);
    });
}

// ç­›é€‰å­¦ç”Ÿ
function filterStudents() {
    const majorFilter = document.getElementById('majorFilter').value;
    const gradeFilter = document.getElementById('gradeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const searchText = document.getElementById('studentSearch').value.toLowerCase();
    
    const allCards = document.querySelectorAll('#studentList .student-card');
    
    allCards.forEach(card => {
        const studentName = card.querySelector('.student-name').textContent;
        const major = card.querySelector('.detail-value').textContent;
        const grade = card.querySelectorAll('.detail-value')[1].textContent;
        const status = card.classList.contains('present') ? 'present' :
                      card.classList.contains('absent') ? 'absent' :
                      card.classList.contains('excused') ? 'excused' :
                      card.classList.contains('low-efficiency') ? 'low-efficiency' : '';
        
        let show = true;
        
        if (majorFilter && major !== majorFilter) show = false;
        if (gradeFilter && grade !== gradeFilter) show = false;
        if (statusFilter && status !== statusFilter) show = false;
        if (searchText && !studentName.toLowerCase().includes(searchText)) show = false;
        
        card.style.display = show ? 'block' : 'none';
    });
}

// æ˜¾ç¤ºå­¦ç”Ÿè¯¦æƒ…
function showStudentDetail(studentName) {
    const modal = document.getElementById('studentDetailModal');
    const title = document.getElementById('studentDetailTitle');
    const content = document.getElementById('studentDetailContent');
    
    title.textContent = `${studentName} - è¯¦ç»†ä¿¡æ¯`;
    
    // è·å–å­¦ç”Ÿæ•°æ®
    const combinedData = combineStudentAndAttendanceData();
    const student = combinedData[studentName];
    
    if (!student) {
        content.innerHTML = '<p>æœªæ‰¾åˆ°å­¦ç”Ÿä¿¡æ¯</p>';
        modal.classList.add('show');
        return;
    }
    
    // ç”Ÿæˆè¯¦ç»†ä¿¡æ¯HTML
    const detailHtml = `
        <div class="student-details" style="grid-template-columns: 1fr;">
            <div class="detail-item">
                <div class="detail-label">åŸºæœ¬ä¿¡æ¯</div>
                <div class="detail-value">
                    <strong>å§“åï¼š</strong>${student.name}<br>
                    <strong>ä¸“ä¸šï¼š</strong>${student.major}<br>
                    <strong>å¹´çº§ï¼š</strong>${student.grade || 'æœªè®¾ç½®'}
                </div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label">ä»Šæ—¥è€ƒå‹¤</div>
                <div class="detail-value">
                    <strong>çŠ¶æ€ï¼š</strong><span class="student-status ${getStatusClass(student.finalAttendanceStatus)}">${student.finalStatusText}</span><br>
                    <strong>æ—¶é—´æ®µï¼š</strong>${student.start} - ${student.end}<br>
                    <strong>ç»ƒç´æ—¶é•¿ï¼š</strong>${student.practicedText}<br>
                    <strong>æ‰€åœ¨ç´æˆ¿ï¼š</strong>${student.room}
                </div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label">è€ƒå‹¤ç»Ÿè®¡</div>
                <div class="detail-value">
                    <strong>å‡ºå‹¤ç‡ï¼š</strong>${calculateAttendanceRate(student)}%<br>
                    <strong>å†å²è®°å½•ï¼š</strong>${student.attendanceHistory ? student.attendanceHistory.length : 0} å¤©
                </div>
            </div>
        </div>
        
        ${createAttendanceHistory(student)}
        
        <div class="action-buttons" style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="closeModal('studentDetailModal')">
                <span>âœ…</span> å…³é—­
            </button>
        </div>

    `;
    
    content.innerHTML = detailHtml;
    modal.classList.add('show');
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
}

// æ˜¾ç¤ºç©ºçŠ¶æ€
function showEmptyState(containerId, title, description) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <div class="empty-state-title">${title}</div>
            <div class="empty-state-description">${description}</div>
        </div>
    `;
}

// åˆ·æ–°æ•°æ®
function refreshData() {
    addSyncLog('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æ•°æ®...');
    loadAttendanceData();
    if (currentTab === 'students') {
        loadStudentList();
    }
}

// å¼ºåˆ¶åŒæ­¥æ•°æ®
function forceSyncData() {
    if (!isOnline) {
        alert('éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½åŒæ­¥æ•°æ®');
        return;
    }
    
    const syncDot = document.getElementById('syncDot');
    const syncText = document.getElementById('syncText');
    
    syncDot.className = 'sync-dot syncing';
    syncText.textContent = 'åŒæ­¥ä¸­...';
    
    addSyncLog('ğŸ”„ å¼€å§‹å¼ºåˆ¶åŒæ­¥...');
    
    // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
    loadInitialData();
    
    setTimeout(() => {
        syncDot.className = 'sync-dot';
        syncText.textContent = 'å®æ—¶åŒæ­¥';
        addSyncLog('âœ… å¼ºåˆ¶åŒæ­¥å®Œæˆ');
    }, 2000);
}






// ç”ŸæˆæŠ¥å‘Š
function generateReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
        return;
    }
    
    showLoading('reportContent');
    
    // ç”ŸæˆæŠ¥å‘Šæ•°æ®
    const reportData = generateReportData(startDate, endDate);
    displayReport(reportData, startDate, endDate);
}

// ç”ŸæˆæŠ¥å‘Šæ•°æ®
function generateReportData(startDate, endDate) {
    const report = {
        totalDays: 0,
        totalStudents: 0,
        dailyStats: {},
        studentStats: {},
        overallStats: {
            present: 0,
            absent: 0,
            excused: 0,
            lowEfficiency: 0
        }
    };
    
    // è®¡ç®—æ—¥æœŸèŒƒå›´å†…çš„å¤©æ•°
    const start = new Date(startDate);
    const end = new Date(endDate);
    const dayCount = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    report.totalDays = dayCount;
    
    // åˆ†ææ¯å¤©çš„æ•°æ®
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayData = attendanceData[dateStr] || {};
        
        report.dailyStats[dateStr] = {
            present: 0,
            absent: 0,
            excused: 0,
            lowEfficiency: 0,
            total: 0
        };
        
        Object.values(dayData).forEach(student => {
            const status = student.finalAttendanceStatus;
            report.dailyStats[dateStr][status] = (report.dailyStats[dateStr][status] || 0) + 1;
            report.dailyStats[dateStr].total++;
            report.overallStats[status] = (report.overallStats[status] || 0) + 1;
            
            // å­¦ç”Ÿç»Ÿè®¡
            if (!report.studentStats[student.name]) {
                report.studentStats[student.name] = {
                    name: student.name,
                    major: student.major,
                    present: 0,
                    absent: 0,
                    excused: 0,
                    lowEfficiency: 0,
                    total: 0
                };
            }
            report.studentStats[student.name][status]++;
            report.studentStats[student.name].total++;
        });
    }
    
    // è®¡ç®—æ€»å­¦ç”Ÿæ•°
    report.totalStudents = Object.keys(report.studentStats).length;
    
    return report;
}

// æ˜¾ç¤ºæŠ¥å‘Š
function displayReport(reportData, startDate, endDate) {
    const container = document.getElementById('reportContent');
    
    const html = `
        <div class="card">
            <h4>ğŸ“Š è€ƒå‹¤åˆ†ææŠ¥å‘Š</h4>
            <p><strong>ç»Ÿè®¡å‘¨æœŸï¼š</strong>${startDate} è‡³ ${endDate} (${reportData.totalDays}å¤©)</p>
            <p><strong>å‚ä¸å­¦ç”Ÿï¼š</strong>${reportData.totalStudents}äºº</p>
            
            <div class="stats-grid" style="margin: 20px 0;">
                <div class="stat-card present">
                    <div class="stat-number">${reportData.overallStats.present || 0}</div>
                    <div class="stat-label">æ­£å¸¸å‡ºå‹¤</div>
                </div>
                <div class="stat-card absent">
                    <div class="stat-number">${reportData.overallStats.absent || 0}</div>
                    <div class="stat-label">ç¼ºå‹¤</div>
                </div>
                <div class="stat-card excused">
                    <div class="stat-number">${reportData.overallStats.excused || 0}</div>
                    <div class="stat-label">è¯·å‡</div>
                </div>
                <div class="stat-card total">
                    <div class="stat-number">${reportData.overallStats.lowEfficiency || 0}</div>
                    <div class="stat-label">ä½æ•ˆå‡ºå‹¤</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h4>ğŸ“ˆ æ¯æ—¥è€ƒå‹¤è¶‹åŠ¿</h4>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æ€»äººæ•°</th>
                        <th>æ­£å¸¸å‡ºå‹¤</th>
                        <th>ç¼ºå‹¤</th>
                        <th>è¯·å‡</th>
                        <th>ä½æ•ˆå‡ºå‹¤</th>
                        <th>å‡ºå‹¤ç‡</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(reportData.dailyStats).sort().map(date => {
                        const stats = reportData.dailyStats[date];
                        const rate = stats.total > 0 ? Math.round(((stats.present || 0) + (stats.lowEfficiency || 0)) / stats.total * 100) : 0;
                        return `
                            <tr>
                                <td>${date}</td>
                                <td>${stats.total}</td>
                                <td>${stats.present || 0}</td>
                                <td>${stats.absent || 0}</td>
                                <td>${stats.excused || 0}</td>
                                <td>${stats.lowEfficiency || 0}</td>
                                <td>${rate}%</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        
        <div class="card">
            <h4>ğŸ‘¥ å­¦ç”Ÿè€ƒå‹¤ç»Ÿè®¡</h4>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>ä¸“ä¸š</th>
                        <th>æ€»å¤©æ•°</th>
                        <th>æ­£å¸¸å‡ºå‹¤</th>
                        <th>ç¼ºå‹¤</th>
                        <th>è¯·å‡</th>
                        <th>ä½æ•ˆå‡ºå‹¤</th>
                        <th>å‡ºå‹¤ç‡</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.values(reportData.studentStats).sort((a, b) => a.name.localeCompare(b.name)).map(student => {
                        const rate = student.total > 0 ? Math.round(((student.present || 0) + (student.lowEfficiency || 0)) / student.total * 100) : 0;
                        return `
                            <tr>
                                <td>${student.name}</td>
                                <td>${student.major}</td>
                                <td>${student.total}</td>
                                <td>${student.present || 0}</td>
                                <td>${student.absent || 0}</td>
                                <td>${student.excused || 0}</td>
                                <td>${student.lowEfficiency || 0}</td>
                                <td>${rate}%</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        
        <div class="export-options">
            <button class="btn btn-primary" onclick="generateReport()">
                <span>ğŸ”„</span> é‡æ–°ç”Ÿæˆ
            </button>
        </div>

    `;
    
    container.innerHTML = html;
    addSyncLog(`ğŸ“ˆ å·²ç”Ÿæˆ ${startDate} è‡³ ${endDate} çš„è€ƒå‹¤æŠ¥å‘Š`);
}





// æ›´æ–°åŒæ­¥çŠ¶æ€
function updateSyncStatus() {
    const statusEl = document.getElementById('syncStatus');
    const statusTextEl = document.getElementById('syncStatusText');
    
    if (isOnline) {
        statusEl.className = 'card success';
        statusTextEl.innerHTML = `
            <strong>âœ… å·²è¿æ¥åˆ°Firebaseæ•°æ®åº“</strong><br>
            æ•°æ®æ­£åœ¨å®æ—¶åŒæ­¥ä¸­...<br>
            <small>æœ€ååŒæ­¥æ—¶é—´: ${new Date().toLocaleString()}</small>
        `;
    } else {
        statusEl.className = 'card danger';
        statusTextEl.innerHTML = `
            <strong>âŒ æœªè¿æ¥åˆ°æ•°æ®åº“</strong><br>
            å½“å‰å¤„äºç¦»çº¿æ¨¡å¼ï¼Œéƒ¨åˆ†åŠŸèƒ½å—é™<br>
            <small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</small>
        `;
    }
}

// æ¸…é™¤æœ¬åœ°ç¼“å­˜
function clearLocalCache() {
    if (confirm('ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç¦»çº¿æ•°æ®ã€‚')) {
        localStorage.clear();
        addSyncLog('ğŸ—‘ï¸ å·²æ¸…é™¤æœ¬åœ°ç¼“å­˜');
        alert('æœ¬åœ°ç¼“å­˜å·²æ¸…é™¤');
    }
}


// åˆå§‹åŒ–æŠ¥å‘Šæ ‡ç­¾é¡µ
function initReportsTab() {
    // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ€è¿‘30å¤©ï¼‰
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–Firebase
    initFirebase();
    
    // æ·»åŠ åˆå§‹æ—¥å¿—
    addSyncLog('ğŸš€ è€ƒå‹¤åŒæ­¥ç³»ç»Ÿå·²å¯åŠ¨');
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸ
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = today;
    
    // åˆå§‹åŒ–æŠ¥å‘Šæ ‡ç­¾é¡µçš„æ—¥æœŸ
    initReportsTab();
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('show');
        }
    });
    
    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal.show').forEach(modal => {
                modal.classList.remove('show');
            });
        }
    });
    
    // å®šæœŸæ›´æ–°åŒæ­¥çŠ¶æ€
    setInterval(updateSyncStatus, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
    // ğŸ”¥ æ–°å¢ï¼šåˆå§‹åŒ–å®æ—¶ç»ƒç´çŠ¶æ€æ˜¾ç¤º
    initPracticeStatusDisplay();
    
    console.log('âœ… è€ƒå‹¤åŒæ­¥ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
});

// ç›‘å¬çª—å£å…³é—­ï¼Œä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
window.addEventListener('beforeunload', function() {
    if (attendanceData && Object.keys(attendanceData).length > 0) {
        Object.keys(attendanceData).forEach(date => {
            localStorage.setItem(`attendance_${date}`, JSON.stringify(attendanceData[date]));
        });
    }
    
    if (studentData && Object.keys(studentData).length > 0) {
        localStorage.setItem('studentData', JSON.stringify(studentData));
    }
    
    localStorage.setItem('syncLogs', JSON.stringify(syncLogs));
});

// é¡µé¢åŠ è½½æ—¶æ¢å¤æœ¬åœ°æ•°æ®
window.addEventListener('load', function() {
    // æ¢å¤åŒæ­¥æ—¥å¿—
    const savedLogs = localStorage.getItem('syncLogs');
    if (savedLogs) {
        syncLogs = JSON.parse(savedLogs);
        updateSyncLogsDisplay();
    }
    // ğŸ”¥ æ–°å¢ï¼šæ¢å¤å®æ—¶ç»ƒç´çŠ¶æ€
    const savedRealTimePractice = localStorage.getItem('realTimePracticeStatus');
    if (savedRealTimePractice) {
        if (!attendanceData.realTimePractice) {
            attendanceData.realTimePractice = {};
        }
        Object.assign(attendanceData.realTimePractice, JSON.parse(savedRealTimePractice));
        addSyncLog('ğŸ“‚ å·²æ¢å¤å®æ—¶ç»ƒç´çŠ¶æ€æ•°æ®');
    }

    
    // æ¢å¤å­¦ç”Ÿæ•°æ®
    const savedStudentData = localStorage.getItem('studentData');
    if (savedStudentData) {
        studentData = JSON.parse(savedStudentData);
        updateFilters();
    }
    
    // å¦‚æœç¦»çº¿ï¼Œå°è¯•æ¢å¤è€ƒå‹¤æ•°æ®
    if (!isOnline) {
        const today = new Date().toISOString().split('T')[0];
        const savedAttendance = localStorage.getItem(`attendance_${today}`);
        if (savedAttendance) {
            attendanceData[today] = JSON.parse(savedAttendance);
            displayAttendanceSnapshot(attendanceData[today], today);
        }
    }
});
</script>

</body>
</html>
