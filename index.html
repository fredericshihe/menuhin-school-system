<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>青岛梅纽因音乐学校练琴跟踪系统</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
/* ===============================================
   青岛梅纽因音乐学校练琴跟踪系统 - 完整样式文件
   =============================================== */

/* ===== 1. CSS变量定义 ===== */
:root {
    /* 主色调 */
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --success-color: #27ae60;
    
    /* 背景和文本 */
    --background-color: #f8f9fa;
    --text-color: #2c3e50;
    --border-color: #dee2e6;
    --light-gray: #f1f3f4;
    --medium-gray: #6c757d;
    --dark-gray: #495057;
    
    /* 阴影和圆角 */
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-hover: 0 5px 20px rgba(0,0,0,0.15);
    --radius: 12px;
    --radius-small: 6px;
    --radius-large: 20px;
    
    /* 移动端适配 */
    --mobile-padding: 15px;
    --mobile-font-size: 16px;
    --touch-target-size: 44px;
    
    /* 渐变色 */
    --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    --gradient-card: linear-gradient(135deg, #f8f9fa, #ffffff);
}

/* ===== 2. 基础重置和全局样式 ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    overflow-x: hidden;
}

/* ===== 3. 容器和布局 ===== */
.container {
    width: 100%;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom);
    box-sizing: border-box;
}

/* 🔥 新增：确保实时练琴状态区域没有额外的内边距 */
.container .card {
    margin-left: 0;
    margin-right: 0;
}

/* 🔥 新增：确保学生网格从最左侧开始 */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(12px, 2vw, 20px);
    width: 100%;
    padding: 0;
    margin: 0; /* 确保没有外边距 */
    padding-left: 0 !important; /* 强制去除左内边距 */
}



/* 响应式容器 */
@media (min-width: 1500px) {
    .container {
        max-width: none;
        padding: 20px 40px;
    }
}

@media (min-width: 1800px) {
    .container {
        padding: 20px 60px;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 10px;
    }
}

/* ===== 4. 语言切换器 ===== */
.language-switcher {
    position: fixed;
    bottom: max(20px, env(safe-area-inset-bottom) + 10px);
    left: 20px;
    z-index: 1001;
    display: flex;
    background: white;
    border-radius: var(--radius-large);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.lang-btn {
    padding: 8px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 40px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lang-btn.active {
    background: var(--primary-color);
    color: white;
}

.lang-btn:hover:not(.active) {
    background: rgba(52, 152, 219, 0.1);
}

/* 移动端语言切换器 */
@media (max-width: 768px) {
    .language-switcher {
        bottom: max(10px, env(safe-area-inset-bottom) + 5px);
        left: 10px;
        border-radius: 16px;
    }
    
    .lang-btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 35px;
        height: 28px;
    }
}

/* ===== 5. 头部样式 ===== */
.header {
    background: var(--gradient-primary);
    color: white;
    padding: max(30px, env(safe-area-inset-top) + 20px) 20px 30px 20px;
    margin-bottom: 30px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
}

.header h1 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    margin-bottom: 10px;
    font-weight: 300;
    line-height: 1.2;
}

.header .subtitle {
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    opacity: 0.9;
    line-height: 1.3;
}

@media (max-width: 768px) {
    .header {
        padding: max(25px, env(safe-area-inset-top) + 15px) 15px 25px 15px;
        margin-bottom: 20px;
    }
}

/* ===== 6. 连接状态指示器 ===== */
.connection-status {
    position: fixed;
    top: max(20px, env(safe-area-inset-top) + 10px);
    right: 20px;
    padding: 8px 12px;
    border-radius: var(--radius-large);
    font-size: 13px;
    font-weight: 600;
    z-index: 1000;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.connection-status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--danger-color);
}

.connection-status.online::before {
    background: var(--success-color);
}

.connection-status.syncing::before {
    background: var(--warning-color);
    animation: pulse 1.5s infinite;
}

.connection-status.online {
    background: white;
    color: var(--success-color);
    border: 1px solid var(--success-color);
}

.connection-status.offline {
    background: white;
    color: var(--danger-color);
    border: 1px solid var(--danger-color);
}

.connection-status.syncing {
    background: white;
    color: var(--warning-color);
    border: 1px solid var(--warning-color);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@media (max-width: 768px) {
    .connection-status {
        top: max(15px, env(safe-area-inset-top) + 5px);
        right: 15px;
        padding: 6px 10px;
        font-size: 12px;
        min-height: 36px;
    }
}

/* ===== 7. 主导航标签 ===== */
.nav-tabs {
    display: flex;
    background: white;
    border-radius: var(--radius);
    padding: 5px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.nav-tabs::-webkit-scrollbar {
    display: none;
}

.nav-tab {
    flex: 1;
    padding: 12px 16px;
    text-align: center;
    background: transparent;
    border: none;
    border-radius: calc(var(--radius) - 5px);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: clamp(14px, 3vw, 16px);
    font-weight: 500;
    white-space: nowrap;
    min-width: 120px;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
}

.nav-tab:hover {
    background: rgba(52, 152, 219, 0.1);
}

.nav-tab.active {
    background: var(--primary-color);
    color: white;
}

@media (max-width: 768px) {
    .nav-tabs {
        margin-bottom: 20px;
        padding: 3px;
    }
    
    .nav-tab {
        padding: 10px 12px;
        font-size: 14px;
        min-width: 100px;
        min-height: 40px;
    }
}

/* ===== 8. 卡片容器基础样式 ===== */
.card {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.card.success {
    border-left-color: var(--success-color);
}

.card.warning {
    border-left-color: var(--warning-color);
}

.card.danger {
    border-left-color: var(--danger-color);
}

@media (max-width: 768px) {
    .card {
        padding: 20px 15px;
        margin-bottom: 20px;
    }
}

/* ===== 9. 统计面板 ===== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.stat-card:hover::before {
    left: 100%;
}

.stat-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 10px;
    line-height: 1;
}

.stat-label {
    font-size: 1.1rem;
    color: var(--medium-gray);
    margin-bottom: 5px;
    font-weight: 600;
}

.stat-description {
    font-size: 0.9rem;
    color: #999;
    line-height: 1.3;
}

/* 统计卡片颜色主题 */
.stat-card.present .stat-number { color: var(--success-color); }
.stat-card.absent .stat-number { color: var(--danger-color); }
.stat-card.excused .stat-number { color: var(--warning-color); }
.stat-card.total .stat-number { color: var(--primary-color); }
.stat-card.unscheduled .stat-number { color: #9b59b6; }
.stat-card.weekend .stat-number { color: #95a5a6; }

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        padding: 20px 15px;
    }
    
    .stat-number {
        font-size: 2.2rem;
    }
    
    .stat-label {
        font-size: 1rem;
    }
    
    .stat-description {
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        gap: 8px;
    }
    
    .stat-card {
        padding: 15px 10px;
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
}

/* ===== 10. 学生网格布局系统 ===== */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(12px, 2vw, 20px);
    width: 100%;
    padding: 0;
}

/* 限制最大列数为4列 */
@media (min-width: 1400px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
        margin: 0 auto;
        gap: 24px;
    }
}

/* 不同屏幕宽度的响应式设置 */
@media (max-width: 1399px) and (min-width: 1100px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }
}

@media (max-width: 1099px) and (min-width: 800px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
}

@media (max-width: 799px) {
    .student-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

/* 小屏幕优化 */
@media (max-width: 599px) {
    .student-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (max-width: 360px) {
    .student-grid {
        gap: 8px;
    }
}

/* 大屏幕优化 */
@media (min-width: 1600px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
        gap: 24px;
    }
}


/* ===== 11. 学生卡片和练琴状态卡片 ===== */
.student-card,
.practice-status-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    border-left: 4px solid #ddd;
    cursor: pointer;
    width: 100%;
    max-width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    height: auto;
    min-height: 280px;
    box-sizing: border-box;
    justify-self: stretch;
    align-self: stretch;
}


.student-card:hover,
.practice-status-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
}

.practice-status-card.compact {
    min-height: 120px;            /* 从140px改为120px */
    padding: 10px 12px;           /* 从12px 16px改为10px 12px */
    margin-bottom: 8px;           /* 从12px改为8px */
}


/* 待考勤状态的卡片使用白色背景 */
.practice-status-card.pending,
.student-card.pending {
    background: white;
    border-left-color: #6c757d;
}

.compact-content {
    display: flex;
    flex-direction: column;
    gap: 4px;                     /* 从6px改为4px */
    flex: 1;
}


.student-name-compact {
    font-size: 1rem;              /* 从1.1rem改为1rem */
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 2px;           /* 从4px改为2px */
}


.student-info-row {
    display: flex;
    align-items: center;
    gap: 6px;                     /* 从8px改为6px */
    font-size: 0.75rem;           /* 从0.8rem改为0.75rem */
    color: var(--medium-gray);
    flex-wrap: wrap;
}


.info-item {
    display: flex;
    align-items: center;
    gap: 2px;
}

.info-divider {
    opacity: 0.6;
    margin: 0 2px;
}

.status-duration-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
    gap: 10px;
}

.practice-duration-large {
    font-size: 1rem;              /* 从1.1rem改为1rem */
    font-weight: 600;
    color: var(--primary-color);
    background: rgba(52, 152, 219, 0.1);
    padding: 3px 6px;             /* 从4px 8px改为3px 6px */
    border-radius: var(--radius-small);
}



/* 移动端卡片优化 */
@media (max-width: 768px) {
    .student-card,
    .practice-status-card {
        min-height: 140px;
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .practice-status-card.compact {
        min-height: 120px;
        padding: 10px;
    }
    
    .student-name-compact {
        font-size: 1rem;
    }
    
    .student-info-row {
        font-size: 0.75rem;
        gap: 6px;
    }
    
    .practice-duration-large {
        font-size: 1rem;
        padding: 3px 6px;
    }
}

@media (max-width: 480px) {
    .student-card,
    .practice-status-card {
        min-height: 120px;
        padding: 8px;
    }
    
    .practice-status-card.compact {
        min-height: 100px;
        padding: 8px;
    }
    
    .student-name-compact {
        font-size: 0.95rem;
    }
    
    .student-info-row {
        font-size: 0.7rem;
        gap: 4px;
    }
    
    .practice-duration-large {
        font-size: 0.9rem;
        padding: 2px 4px;
    }
}

/* ===== 12. 卡片边框颜色 ===== */
.practice-status-card { 
    border-left-color: #9b59b6; 
    background: white;
}

.student-card.weekend,
.practice-status-card.weekend { 
    border-left-color: #95a5a6; 
    background: var(--gradient-card);
}

.practice-status-card.present,
.student-card.present { 
    border-left-color: var(--success-color); 
}

.practice-status-card.absent,
.student-card.absent { 
    border-left-color: var(--danger-color); 
}

.practice-status-card.excused,
.student-card.excused { 
    border-left-color: var(--warning-color); 
}

.practice-status-card.low-efficiency,
.student-card.low-efficiency { 
    border-left-color: #f39c12; 
}

.practice-status-card.practicing-unscheduled,
.student-card.practicing-unscheduled { 
    border-left-color: #9b59b6; 
}

/* ===== 13. 卡片内容样式 ===== */
.student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.student-name {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
    line-height: 1.2;
}


.student-details,
.practice-details {
    width: 100%;
    margin-bottom: 15px;
}

/* 在更大屏幕上使用两列，但学生区域仍然全宽 */
@media (min-width: 1200px) {
    .student-details,
    .practice-details {
        grid-template-columns: 1fr 1fr;
    }
    
    /* 学生卡片区域跨越两列 */
    .student-grid,
    .department-section,
    .room-section {
        grid-column: 1 / -1;
    }
}


.detail-item {
    display: flex;
    flex-direction: column;
    padding: 4px 0;
}

.detail-label {
    font-size: 0.75rem;
    color: var(--medium-gray);
    margin-bottom: 2px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-color);
    line-height: 1.3;
}

/* 状态标签样式 */
.student-status,
.student-status-compact,
.practice-duration {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    white-space: nowrap;
    text-align: center;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    transition: all 0.15s ease-in-out;
}

/* 学生状态颜色 */
.student-status.present,
.student-status-compact.present { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb;
}

.student-status.absent,
.student-status-compact.absent { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}

.student-status.excused,
.student-status-compact.excused { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.student-status.low-efficiency,
.student-status-compact.low-efficiency { 
    background: #ffeaa7; 
    color: #b06000; 
    border-color: #ffdc7a;
}

.student-status.practicing-unscheduled,
.student-status-compact.practicing-unscheduled { 
    background: #e8d5f2; 
    color: #6a1b9a; 
    border-color: #dcc7e8;
}

.student-status.weekend,
.student-status-compact.weekend { 
    background: #ecf0f1; 
    color: #2c3e50; 
    border-color: #d5dbdb;
}

/* 练琴时长标签颜色 */
.practice-duration {
    background: #e8d5f2;
    color: #6a1b9a;
    border-color: #dcc7e8;
}

@media (max-width: 768px) {
    .student-header {
        margin-bottom: 8px;
    }
    
    .student-name {
        font-size: 1.1rem;
    }
    
    .student-details,
    .practice-details {
        grid-template-columns: 1fr;
        gap: 6px;
        margin-bottom: 10px;
    }
    
    .detail-label {
        font-size: 0.7rem;
    }
    
    .detail-value {
        font-size: 0.8rem;
    }
    
    .student-status,
    .student-status-compact,
    .practice-duration {
        padding: 3px 8px;
        font-size: 0.7rem;
        border-radius: 12px;
    }
}

/* ===== 14. 实时练琴指示器 ===== */
.practice-indicator {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    background: var(--success-color);
    border-radius: 50%;
    animation: pulse 2s infinite;
    box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
}

.practice-status-card.compact .practice-indicator {
    top: 12px;
    right: 12px;
    width: 10px;
    height: 10px;
}

@keyframes pulse {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
    }
    
    70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(39, 174, 96, 0);
    }
    
    100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0);
    }
}

@media (max-width: 768px) {
    .practice-indicator {
        width: 8px;
        height: 8px;
        top: 10px;
        right: 10px;
    }
    
    .practice-status-card.compact .practice-indicator {
        width: 6px;
        height: 6px;
        top: 8px;
        right: 8px;
    }
}

/* ===== 15. 考勤历史时间轴 ===== */
.attendance-history {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.history-title {
    font-size: 0.9rem;
    color: var(--medium-gray);
    margin-bottom: 10px;
    font-weight: 500;
}

.history-timeline {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px 0;
    justify-content: center;
}

.history-timeline-container {
    padding: 15px 0;
}

.history-day {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    border: 2px solid transparent;
}

.history-day:hover {
    transform: scale(1.15);
    z-index: 1;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.history-day.present { 
    background: var(--success-color); 
    color: white; 
    border-color: var(--success-color);
}

.history-day.absent { 
    background: var(--danger-color); 
    color: white; 
    border-color: var(--danger-color);
}

.history-day.excused { 
    background: var(--warning-color); 
    color: white; 
    border-color: var(--warning-color);
}

.history-day.no-data { 
    background: var(--light-gray); 
    color: var(--medium-gray); 
    border-color: var(--border-color);
}

.history-day.low-efficiency {
    background: #f39c12;
    border-color: #f39c12;
    color: white;
}

.history-day.practicing-unscheduled {
    background: #9b59b6;
    border-color: #9b59b6;
    color: white;
}

.history-day.weekend {
    background: #95a5a6;
    border-color: #95a5a6;
    color: white;
}

/* 移动端考勤历史优化 */
@media (max-width: 768px) {
    .attendance-history {
        margin-top: 10px;
        padding-top: 10px;
    }
    
    .history-timeline {
        gap: 6px;
    }
    
    .history-day {
        width: 35px;
        height: 35px;
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .history-timeline {
        gap: 4px;
    }
    
    .history-day {
        width: 30px;
        height: 30px;
        font-size: 0.75rem;
    }
}

/* ===== 16. 空状态样式 ===== */
.practice-empty-state,
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--medium-gray);
}

.practice-empty-state-icon,
.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.practice-empty-state-title,
.empty-state-title {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--text-color);
    font-weight: 600;
}

.practice-empty-state-description,
.empty-state-description {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--medium-gray);
}

.empty-state {
    padding: 60px 20px;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.empty-state-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
}

.empty-state-description {
    font-size: 1rem;
    line-height: 1.6;
}

/* 移动端空状态优化 */
@media (max-width: 768px) {
    .empty-state {
        padding: 40px 15px;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .empty-state-title {
        font-size: 1.2rem;
        margin-bottom: 8px;
    }
    
    .empty-state-description {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .practice-empty-state {
        padding: 30px 15px;
    }
    
    .practice-empty-state-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
    }
    
    .practice-empty-state-title {
        font-size: 1.1rem;
        margin-bottom: 6px;
    }
    
    .practice-empty-state-description {
        font-size: 0.85rem;
    }
}

/* ===== 17. 筛选器样式 ===== */
.filters,
.practice-filters {
    background: white;
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 25px;
    box-shadow: var(--shadow);
}

.practice-filters {
    padding: 15px;
    margin-bottom: 20px;
}

.filter-row,
.practice-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
}

.practice-filter-row {
    gap: 12px;
}

.filter-group,
.practice-filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
    flex: 1;
}

.practice-filter-group {
    min-width: 120px;
}

.filter-label,
.practice-filter-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    margin-bottom: 5px;
    font-weight: 500;
}

.practice-filter-label {
    font-size: 0.85rem;
    margin-bottom: 4px;
}

.filter-select, 
.filter-input,
.practice-filter-select,
.practice-filter-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-small);
    font-size: 14px;
    transition: all 0.3s ease;
    background: white;
    color: var(--text-color);
}

.practice-filter-select,
.practice-filter-input {
    padding: 8px 10px;
}

.filter-select:focus, 
.filter-input:focus,
.practice-filter-select:focus,
.practice-filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

.filter-select:hover,
.filter-input:hover,
.practice-filter-select:hover,
.practice-filter-input:hover {
    border-color: var(--primary-color);
}

/* 快速筛选标签 */
.quick-filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
    justify-content: flex-start;
}

.quick-filter-tag {
    padding: 8px 16px;           /* 统一内边距 */
    font-size: 14px;             /* 统一字体大小 */
    font-weight: 500;            /* 统一字重 */
    border-radius: 20px;         /* 统一圆角 */
    height: 36px;                /* 统一高度 */
    display: inline-flex;        /* 统一对齐方式 */
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    background: var(--light-gray);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    min-width: auto;
}

.quick-filter-tag:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.quick-filter-tag.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}


/* 移动端筛选器优化 */
@media (max-width: 768px) {
    .filters {
        padding: 15px;
        margin: 0 -5px 20px -5px;
    }
    
    .practice-filters {
        padding: 12px;
        margin: 0 -5px 15px -5px;
    }
    
    .filter-row,
    .practice-filter-row {
        flex-direction: column;
        gap: 12px;
    }
    
    .practice-filter-row {
        gap: 10px;
    }
    
    .filter-group,
    .practice-filter-group {
        min-width: auto;
        width: 100%;
    }
    
    .filter-select,
    .filter-input,
    .practice-filter-select,
    .practice-filter-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }
    
    .practice-filter-select,
    .practice-filter-input {
        padding: 10px 12px;
    }
    
    .filter-select:focus,
    .filter-input:focus,
    .practice-filter-select:focus,
    .practice-filter-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .quick-filter-tags {
        justify-content: center;
        margin-top: 12px;
    }
    
    .quick-filter-tag {
        padding: 6px 12px;
        font-size: 13px;
        height: 32px;
    }
}

/* ===== 18. 操作按钮样式 ===== */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: var(--mobile-font-size);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: var(--touch-target-size);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    -webkit-appearance: none;
    text-decoration: none;
    line-height: 1;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.btn:active {
    transform: scale(0.95);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* 按钮颜色变体 */
.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-warning {
    background: var(--warning-color);
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-secondary {
    background: var(--medium-gray);
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-outline {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

/* 导出选项 */
.export-options {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

/* 移动端按钮优化 */
@media (max-width: 768px) {
    .action-buttons {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 15px;
        margin: 20px -15px -15px -15px;
        border-top: 1px solid #eee;
        z-index: 10;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .export-options {
        flex-direction: column;
        gap: 8px;
        margin-top: 15px;
    }
    
    .export-options .btn {
        width: 100%;
    }
    
    .btn {
        padding: 14px 20px;
        font-size: 16px;
        border-radius: 10px;
    }
}

/* ===== 19. 模态框样式 ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    animation: fadeIn 0.3s ease;
    backdrop-filter: blur(4px);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    max-width: min(600px, 95vw);
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideIn 0.3s ease;
    margin: env(safe-area-inset-top) auto env(safe-area-inset-bottom) auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--light-gray);
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.modal-close {
    background: var(--light-gray);
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--medium-gray);
    padding: 0;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: var(--danger-color);
    color: white;
    transform: scale(1.1);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* 移动端模态框优化 */
@media (max-width: 768px) {
    .modal {
        padding: 0;
        align-items: flex-end;
    }
    
    .modal-content {
        width: 100%;
        max-width: 100%;
        max-height: 90vh;
        border-radius: var(--radius-large) var(--radius-large) 0 0;
        margin: 0;
        animation: slideUpIn 0.3s ease;
    }
    
    @keyframes slideUpIn {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-header {
        padding-bottom: 20px;
        border-bottom: 2px solid #eee;
    }
    
    .modal-title {
        font-size: 1.3rem;
    }
    
    .modal-close {
        width: 40px;
        height: 40px;
        font-size: 1.8rem;
    }
}

/* ===== 20. 表格样式 ===== */
.data-table,
.detail-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    font-size: 0.9rem;
}

.detail-table {
    margin: 0;
}

.data-table th,
.data-table td,
.detail-table th,
.detail-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    min-width: 80px;
    vertical-align: middle;
}

.data-table th,
.detail-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
}

.detail-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.data-table tr:hover,
.detail-table tr:hover {
    background: var(--light-gray);
}

.detail-table tr:last-child td {
    border-bottom: none;
}

/* 表格容器 */
.data-table-container,
.table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-radius: var(--radius);
}

.history-table-card .table-container {
    max-height: 300px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

/* 表格单元格样式 */
.date-cell {
    font-weight: 500;
    color: var(--dark-gray);
    min-width: 100px;
}

.table-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    display: inline-block;
    border: 1px solid transparent;
}

.table-status-badge.present { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb;
}

.table-status-badge.absent { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}

.table-status-badge.excused { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.table-status-badge.low-efficiency { 
    background: #ffeaa7; 
    color: #b06000; 
    border-color: #ffdc7a;
}

.table-status-badge.practicing-unscheduled { 
    background: #e8d5f2; 
    color: #6a1b9a; 
    border-color: #dcc7e8;
}

.table-status-badge.weekend { 
    background: #ecf0f1; 
    color: #2c3e50; 
    border-color: #d5dbdb;
}

.table-status-badge.no-data { 
    background: var(--light-gray); 
    color: var(--medium-gray); 
    border-color: var(--border-color);
}

.duration-cell {
    color: var(--medium-gray);
    font-weight: 500;
    text-align: right;
    min-width: 80px;
}

.total-duration-cell {
    font-weight: 600;
    color: var(--primary-color);
    text-align: right;
    min-width: 90px;
}

/* 表格滚动提示 */
.table-scroll-hint {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 5;
}

.table-container:hover .table-scroll-hint {
    opacity: 1;
}

/* 表格空状态 */
.table-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--medium-gray);
}

.table-empty-state-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    opacity: 0.5;
}

.table-empty-state-title {
    font-size: 1rem;
    margin-bottom: 5px;
    color: var(--text-color);
    font-weight: 600;
}

.table-empty-state-description {
    font-size: 0.85rem;
    line-height: 1.4;
}

/* 移动端表格优化 */
@media (max-width: 768px) {
    .data-table-container {
        margin: 0 -20px;
        padding: 0 20px;
    }
    
    .data-table {
        min-width: 600px;
    }
    
    .data-table th,
    .data-table td {
        padding: 10px 8px;
        font-size: 13px;
    }
    
    .history-table-card .table-container {
        max-height: 250px;
        margin: 0 -10px;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    .detail-table {
        font-size: 0.8rem;
        min-width: 500px;
    }
    
    .detail-table th,
    .detail-table td {
        padding: 8px 10px;
    }
    
    .detail-table th {
        font-size: 0.75rem;
        background: var(--light-gray);
    }
    
    .history-table-card .table-container::-webkit-scrollbar {
        width: 3px;
        height: 3px;
    }
}

@media (max-width: 480px) {
    .history-table-card .table-container {
        max-height: 200px;
    }
    
    .detail-table {
        font-size: 0.75rem;
        min-width: 450px;
    }
    
    .detail-table th,
    .detail-table td {
        padding: 6px 8px;
    }
}
/* 今日行样式 */
.today-row {
    background: #f0f8ff;
}

/* 深色模式下的今日行 */
@media (prefers-color-scheme: dark) {
    .today-row {
        background: rgba(88, 166, 255, 0.15) !important;
    }
    
    .today-row .date-cell {
        color: var(--text-color);
    }
    
    .today-row .date-cell small {
        color: var(--primary-color) !important;
    }
}


/* ===== 21. 加载动画 ===== */
.loading {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--light-gray);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 15px;
    color: var(--medium-gray);
    font-size: 0.9rem;
}

/* 移动端加载动画优化 */
@media (max-width: 768px) {
    .loading {
        padding: 30px 20px;
    }
    
    .spinner {
        width: 35px;
        height: 35px;
        border-width: 3px;
    }
    
    .loading-text {
        margin-top: 12px;
        font-size: 0.85rem;
    }
}

/* ===== 22. 日期选择器样式 ===== */
.date-picker {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.date-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-small);
    font-size: 14px;
    color: var(--text-color);
    background: white;
    transition: all 0.3s ease;
}

.date-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

/* 移动端日期选择器优化 */
@media (max-width: 768px) {
    .date-picker {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 15px;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-bottom: 20px;
    }
    
    .date-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
    }
    
    .date-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}

/* ===== 23. 学生详情页面特殊样式 ===== */
.student-detail-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 800px;
    margin: 0 auto;
}

/* 学生档案卡片 */
.student-profile-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: var(--radius-large);
    text-align: center;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.profile-info {
    width: 100%;
}

.profile-name {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 15px 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    line-height: 1.1;
}

.profile-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-size: 1.1rem;
    opacity: 0.9;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.meta-icon {
    font-size: 1rem;
}

.meta-divider {
    opacity: 0.6;
    margin: 0 4px;
    font-size: 1.2rem;
}

/* 今日状态卡片 */
.today-status-card {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border-left: 5px solid var(--primary-color);
}

.today-status-card.present { border-left-color: var(--success-color); }
.today-status-card.absent { border-left-color: var(--danger-color); }
.today-status-card.excused { border-left-color: var(--warning-color); }
.today-status-card.low-efficiency { border-left-color: #f39c12; }
.today-status-card.practicing-unscheduled { border-left-color: #9b59b6; }
.today-status-card.weekend { border-left-color: #95a5a6; }

.status-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.status-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.status-badge {
    padding: 8px 16px;
    border-radius: var(--radius-large);
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid transparent;
}

.status-badge.present { background: #d4edda; color: #155724; border-color: #c3e6cb; }
.status-badge.absent { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
.status-badge.excused { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
.status-badge.low-efficiency { background: #ffeaa7; color: #b06000; border-color: #ffdc7a; }
.status-badge.practicing-unscheduled { background: #e8d5f2; color: #6a1b9a; border-color: #dcc7e8; }
.status-badge.weekend { background: #ecf0f1; color: #2c3e50; border-color: #d5dbdb; }

.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.metric-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
}

.metric-item:hover {
    transform: translateY(-2px);
}

.metric-icon {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
}

.metric-content {
    flex: 1;
}

.metric-label {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-bottom: 2px;
    color: var(--medium-gray);
}

.metric-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-color);
}
/* 请假信息 */
.excuse-info {
    margin-top: 20px;
    padding: 16px;
    background: rgba(243, 156, 18, 0.1);
    border-radius: var(--radius);
    border-left: 4px solid #f39c12;
}

.excuse-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.excuse-icon {
    font-size: 1.2rem;
}

.excuse-title {
    font-weight: 600;
    color: #b06000;
}

.excuse-content {
    padding-left: 28px;
}

.excuse-reason {
    margin: 0 0 4px 0;
    color: #856404;
    font-weight: 500;
}

.excuse-approver {
    margin: 0;
    font-size: 0.9rem;
    color: #6c5700;
}

/* 通用卡片样式 */
.card-header {
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--light-gray);
}

.card-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.title-icon {
    font-size: 1.3rem;
}

.title-subtitle {
    font-size: 0.85rem;
    font-weight: 400;
    color: var(--medium-gray);
    margin-left: 4px;
}

/* 统计网格详细版 */
.stats-grid-detailed {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    max-width: 100%;
}

.stats-grid-detailed .stat-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px;
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    min-height: 80px;
}

.stats-grid-detailed .stat-item:hover {
    transform: translateY(-3px);
}

.stats-grid-detailed .stat-item.present { 
    background: linear-gradient(135deg, #d4edda, #c3e6cb); 
}

.stats-grid-detailed .stat-item.absent { 
    background: linear-gradient(135deg, #f8d7da, #f5c6cb); 
}

.stats-grid-detailed .stat-item.excused { 
    background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
}

.stats-grid-detailed .stat-item.rate { 
    background: linear-gradient(135deg, #cce7ff, #b3d9ff); 
}

.stats-grid-detailed .stat-icon {
    font-size: 1.5rem;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 50%;
    flex-shrink: 0;
}

.stats-grid-detailed .stat-content {
    flex: 1;
    min-width: 0;
}

.stats-grid-detailed .stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
    color: var(--text-color);
}

.stats-grid-detailed .stat-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    font-weight: 500;
    line-height: 1.2;
}

/* 移动端学生详情页面优化 */
@media (max-width: 768px) {
    .student-detail-content {
        gap: 16px;
    }
    
    .student-profile-card {
        padding: 25px 20px;
    }
    
    .profile-name {
        font-size: 2rem;
    }
    
    .profile-meta {
        font-size: 1rem;
        gap: 10px;
    }
    
    .status-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .status-metrics {
        grid-template-columns: 1fr;
    }
    
    .stats-grid-detailed {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 16px;
        min-height: 70px;
    }
    
    .stats-grid-detailed .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1.3rem;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.5rem;
    }
    
    .stats-grid-detailed .stat-label {
        font-size: 0.85rem;
    }
}

@media (max-width: 480px) {
    .student-detail-content {
        gap: 16px;
    }
    
    .card {
        padding: 20px 16px;
    }
    
    .profile-name {
        font-size: 1.8rem;
    }
    
    .profile-meta {
        font-size: 0.9rem;
        gap: 8px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 14px;
        min-height: 60px;
        gap: 10px;
    }
    
    .stats-grid-detailed .stat-icon {
        width: 35px;
        height: 35px;
        font-size: 1.2rem;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.3rem;
    }
    
    .stats-grid-detailed .stat-label {
        font-size: 0.8rem;
    }
}

/* 中等屏幕统计网格优化 */
@media (min-width: 769px) and (max-width: 1024px) {
    .stats-grid-detailed {
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 18px;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.6rem;
    }
}

/* 大屏幕统计网格优化 */
@media (min-width: 1200px) {
    .stats-grid-detailed {
        max-width: 600px;
        margin: 0 auto;
    }
}

/* ===== 24. 加载更多提示 ===== */
.load-more-hint {
    text-align: center;
    padding: 15px;
    color: var(--medium-gray);
    font-size: 0.85rem;
    border-top: 1px solid #eee;
    background: var(--light-gray);
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.load-more-hint:hover {
    background: #e9ecef;
}

.load-more-hint.loading {
    color: var(--primary-color);
    cursor: not-allowed;
}

/* ===== 25. 触摸优化 ===== */
.student-card, 
.practice-status-card, 
.stat-card, 
.btn, 
.nav-tab,
.quick-filter-tag,
.history-day {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
    tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.student-card:active, 
.practice-status-card:active, 
.stat-card:active {
    transform: scale(0.98);
}

.btn:active {
    transform: scale(0.95);
}

.quick-filter-tag:active,
.history-day:active {
    transform: scale(0.95);
}

/* ===== 26. iOS安全区域适配 ===== */
@supports (padding: max(0px)) {
    .container {
        padding-left: max(20px, env(safe-area-inset-left));
        padding-right: max(20px, env(safe-area-inset-right));
    }
    
    @media (max-width: 768px) {
        .container {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }
    }
}

/* ===== 27. 横屏模式优化 ===== */
@media (max-width: 768px) and (orientation: landscape) {
    .header {
        padding: max(15px, env(safe-area-inset-top) + 10px) 20px 15px 20px;
    }
    
    .header h1 {
        font-size: 1.8rem;
        margin-bottom: 5px;
    }
    
    .header .subtitle {
        font-size: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .modal-content {
        max-height: 80vh;
    }
    
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* ===== 28. iOS Safari 特殊优化 ===== */
@supports (-webkit-touch-callout: none) {
    .nav-tabs {
        -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
        -webkit-overflow-scrolling: touch;
    }
    
    input, select, textarea {
        -webkit-appearance: none;
        border-radius: 8px;
    }
    
    .btn {
        -webkit-appearance: none;
    }
}

/* ===== 29. 滚动条样式 ===== */
* {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

*::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

*::-webkit-scrollbar-track {
    background: transparent;
}

*::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

*::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0, 0, 0, 0.4);
}

/* 移动端滚动条 */
@media (max-width: 768px) {
    *::-webkit-scrollbar {
        width: 3px;
        height: 3px;
    }
}

/* ===== 30. 可访问性优化 ===== */
.student-card:focus,
.practice-status-card:focus,
.btn:focus,
.nav-tab:focus,
.quick-filter-tag:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

button:focus,
input:focus,
select:focus,
textarea:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 1px;
}

/* 高对比度模式支持 */
@media (prefers-contrast: high) {
    :root {
        --border-color: #000;
        --text-color: #000;
        --background-color: #fff;
    }
    
    .card {
        border: 2px solid #000;
    }
    
    .btn {
        border: 2px solid currentColor;
    }
}

/* 减少动画偏好 */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .practice-indicator {
        animation: none;
    }
    
    .spinner {
        animation: none;
    }
}

/* ===== 31. 打印样式优化 ===== */
@media print {
    .language-switcher,
    .connection-status,
    .nav-tabs,
    .action-buttons,
    .btn,
    .modal,
    .practice-indicator {
        display: none !important;
    }
    
    .container {
        max-width: none;
        padding: 0;
    }
    
    .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
        margin-bottom: 15px;
    }
    
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .student-card,
    .practice-status-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .header {
        background: none !important;
        color: #000 !important;
        box-shadow: none;
    }
    
    body {
        background: white !important;
        color: black !important;
    }
}

/* ===== 32. 统一的状态颜色系统 ===== */
.present, 
.student-status.present, 
.student-status-compact.present, 
.table-status-badge.present,
.status-badge.present { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb;
}

.absent, 
.student-status.absent, 
.student-status-compact.absent, 
.table-status-badge.absent,
.status-badge.absent { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}

.pending,
.student-status.pending,
.student-status-compact.pending,
.table-status-badge.pending,
.status-badge.pending {
    background: #f8f9fa;
    color: #6c757d;
    border-color: #dee2e6;
}


.excused, 
.student-status.excused, 
.student-status-compact.excused, 
.table-status-badge.excused,
.status-badge.excused { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}

.low-efficiency, 
.student-status.low-efficiency, 
.student-status-compact.low-efficiency, 
.table-status-badge.low-efficiency,
.status-badge.low-efficiency { 
    background: #ffeaa7; 
    color: #b06000; 
    border-color: #ffdc7a;
}

.practicing-unscheduled, 
.student-status.practicing-unscheduled, 
.student-status-compact.practicing-unscheduled, 
.table-status-badge.practicing-unscheduled,
.status-badge.practicing-unscheduled { 
    background: #e8d5f2; 
    color: #6a1b9a; 
    border-color: #dcc7e8;
}

.weekend, 
.student-status.weekend, 
.student-status-compact.weekend, 
.table-status-badge.weekend,
.status-badge.weekend { 
    background: #ecf0f1; 
    color: #2c3e50; 
    border-color: #d5dbdb;
}

/* ===== 33. 文本和排版优化 ===== */
p, div, span {
    line-height: 1.5;
}

h1, h2, h3, h4, h5, h6 {
    line-height: 1.2;
    margin-bottom: 0.5em;
    font-weight: 600;
}

/* 确保所有文本输入框在iOS上不会被缩放 */
input, select, textarea, button {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

/* 确保触摸目标足够大 */
.nav-tab,
.btn,
.lang-btn,
.connection-status,
.student-card,
.practice-status-card,
.history-day,
.quick-filter-tag {
    min-height: 44px;
    min-width: 44px;
}

/* 小屏幕下的触摸目标调整 */
@media (max-width: 480px) {
    .nav-tab,
    .btn {
        min-height: 40px;
    }
    
    .lang-btn {
        min-height: 32px;
        min-width: 32px;
    }
    
    .history-day {
        min-height: 32px;
        min-width: 32px;
    }
}

/* ===== 34. 特殊内容处理 ===== */
.detail-item[style*="grid-column: 1 / -1"] .detail-value {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-top: 2px;
}

.detail-item .detail-value[style*="color: #f39c12"] {
    background: rgba(243, 156, 18, 0.1);
    padding: 6px 8px;
    border-radius: var(--radius-small);
    font-size: 0.8rem;
    line-height: 1.3;
}

/* ===== 35. 动画和过渡效果 ===== */
.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

.slide-up {
    animation: slideUp 0.5s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.bounce-in {
    animation: bounceIn 0.6s ease-out;
}

@keyframes bounceIn {
    0% {
        transform: scale(0.3);
        opacity: 0;
    }
    50% {
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.9);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* ===== 36. 深色模式完美适配 ===== */
@media (prefers-color-scheme: dark) {
    :root {
        /* 深色模式颜色变量重定义 */
        --background-color: #0d1117;
        --text-color: #f0f6fc;
        --border-color: #30363d;
        --light-gray: #21262d;
        --medium-gray: #8b949e;
        --dark-gray: #f0f6fc;
        
        /* 深色模式下的主色调调整 */
        --primary-color: #58a6ff;
        --secondary-color: #3fb950;
        --warning-color: #d29922;
        --danger-color: #f85149;
        --success-color: #3fb950;
        
        /* 深色模式渐变色 */
        --gradient-primary: linear-gradient(135deg, #58a6ff, #3fb950);
        --gradient-card: linear-gradient(135deg, #21262d, #30363d);
        
        /* 深色模式阴影 */
        --shadow: 0 2px 10px rgba(0,0,0,0.4);
        --shadow-hover: 0 5px 20px rgba(0,0,0,0.6);
    }
    
    /* 基础元素 */
    body {
        background: var(--background-color);
        color: var(--text-color);
    }
    
    /* 卡片和容器 */
    .card,
    .student-card,
    .practice-status-card,
    .stat-card,
    .today-status-card,
    .student-profile-card {
        background: var(--light-gray);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    /* 导航和标签 */
    .nav-tabs {
        background: var(--light-gray);
        border: 1px solid var(--border-color);
    }
    
    .nav-tab {
        color: var(--medium-gray);
    }
    
    .nav-tab:hover {
        background: rgba(88, 166, 255, 0.1);
        color: var(--primary-color);
    }
    
    .nav-tab.active {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 语言切换器 */
    .language-switcher {
        background: var(--light-gray);
        border: 1px solid var(--border-color);
    }
    
    .lang-btn {
        color: var(--medium-gray);
    }
    
    .lang-btn:hover:not(.active) {
        background: rgba(88, 166, 255, 0.1);
        color: var(--primary-color);
    }
    
    .lang-btn.active {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 连接状态指示器 */
    .connection-status.online {
        background: var(--light-gray);
        color: var(--success-color);
        border-color: var(--success-color);
    }
    
    .connection-status.offline {
        background: var(--light-gray);
        color: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .connection-status.syncing {
        background: var(--light-gray);
        color: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    /* 筛选器 */
    .filters,
    .practice-filters {
        background: var(--light-gray);
        border: 1px solid var(--border-color);
    }
    
    .filter-select,
    .filter-input,
    .practice-filter-select,
    .practice-filter-input,
    .date-input {
        background: #0d1117;
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .filter-select:focus,
    .filter-input:focus,
    .practice-filter-select:focus,
    .practice-filter-input:focus,
    .date-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3);
    }
    
    .filter-select:hover,
    .filter-input:hover,
    .practice-filter-select:hover,
    .practice-filter-input:hover,
    .date-input:hover {
        border-color: var(--primary-color);
    }
    
    /* 快速筛选标签 */
    .quick-filter-tag {
        background: #30363d;
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .quick-filter-tag:hover {
        background: #484f58;
        transform: translateY(-1px);
    }
    
    .quick-filter-tag.active {
        background: var(--primary-color);
        color: #0d1117;
        border-color: var(--primary-color);
    }
    
    /* 按钮 */
    .btn-primary {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    .btn-primary:hover {
        background: #1f6feb;
    }
    
    .btn-success {
        background: var(--success-color);
        color: #0d1117;
    }
    
    .btn-success:hover {
        background: #2ea043;
    }
    
    .btn-warning {
        background: var(--warning-color);
        color: #0d1117;
    }
    
    .btn-warning:hover {
        background: #bb8009;
    }
    
    .btn-danger {
        background: var(--danger-color);
        color: #0d1117;
    }
    
    .btn-danger:hover {
        background: #da3633;
    }
    
    .btn-secondary {
        background: var(--medium-gray);
        color: #0d1117;
    }
    
    .btn-secondary:hover {
        background: #6e7681;
    }
    
    .btn-outline {
        background: transparent;
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-outline:hover {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 模态框 */
    .modal {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .modal-content {
        background: var(--light-gray);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    .modal-close {
        background: #30363d;
        color: var(--medium-gray);
    }
    
    .modal-close:hover {
        background: var(--danger-color);
        color: #0d1117;
    }
    
    /* 表格 */
    .data-table,
    .detail-table {
        background: var(--light-gray);
        border: 1px solid var(--border-color);
    }
    
    .data-table th,
    .data-table td,
    .detail-table th,
    .detail-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    .data-table th,
    .detail-table th {
        background: #30363d;
        color: var(--text-color);
        border-bottom-color: var(--border-color);
    }
    
    .data-table tr:hover,
    .detail-table tr:hover {
        background: #30363d;
    }
    
    .history-table-card .table-container {
        background: var(--light-gray);
        border-color: var(--border-color);
    }

    
    /* 状态标签深色模式适配 */
    .student-status.present,
    .student-status-compact.present,
    .table-status-badge.present,
    .status-badge.present {
        background: #238636;
        color: #aff5b4;
        border-color: #2ea043;
    }
    
    .student-status.absent,
    .student-status-compact.absent,
    .table-status-badge.absent,
    .status-badge.absent {
        background: #da3633;
        color: #ffdcd7;
        border-color: #f85149;
    }
    
    .student-status.excused,
    .student-status-compact.excused,
    .table-status-badge.excused,
    .status-badge.excused {
        background: #bb8009;
        color: #f2cc60;
        border-color: #d29922;
    }
    
    .student-status.low-efficiency,
    .student-status-compact.low-efficiency,
    .table-status-badge.low-efficiency,
    .status-badge.low-efficiency {
        background: #9a6700;
        color: #f2cc60;
        border-color: #bb8009;
    }
    
    .student-status.practicing-unscheduled,
    .student-status-compact.practicing-unscheduled,
    .table-status-badge.practicing-unscheduled,
    .status-badge.practicing-unscheduled {
        background: #8250df;
        color: #d2a8ff;
        border-color: #a475f9;
    }
    
    .student-status.weekend,
    .student-status-compact.weekend,
    .table-status-badge.weekend,
    .status-badge.weekend {
        background: #6e7681;
        color: #f0f6fc;
        border-color: #8b949e;
    }
    
    /* 练琴时长标签 */
    .practice-duration,
    .practice-duration-large {
        background: #8250df;
        color: #d2a8ff;
        border-color: #a475f9;
    }
    
    /* 考勤历史时间轴 */
    .history-day.present {
        background: var(--success-color);
        border-color: var(--success-color);
    }
    
    .history-day.absent {
        background: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .history-day.excused {
        background: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    .history-day.no-data {
        background: #30363d;
        color: var(--medium-gray);
        border-color: var(--border-color);
    }
    
    .history-day.low-efficiency {
        background: #9a6700;
        border-color: #bb8009;
    }
    
    .history-day.practicing-unscheduled {
        background: #8250df;
        border-color: #a475f9;
    }
    
    .history-day.weekend {
        background: #6e7681;
        border-color: #8b949e;
    }
    
    /* 卡片边框颜色深色适配 */
    .practice-status-card.present,
    .student-card.present {
        border-left-color: var(--success-color);
    }
    
    .practice-status-card.absent,
    .student-card.absent {
        border-left-color: var(--danger-color);
    }
    
    .practice-status-card.excused,
    .student-card.excused {
        border-left-color: var(--warning-color);
    }
    
    .practice-status-card.low-efficiency,
    .student-card.low-efficiency {
        border-left-color: #bb8009;
    }
    
    .practice-status-card.practicing-unscheduled,
    .student-card.practicing-unscheduled {
        border-left-color: #8250df;
    }
    
    .practice-status-card.weekend,
    .student-card.weekend {
        border-left-color: #6e7681;
        background: var(--gradient-card);
    }
    
    /* 统计卡片深色适配 */
    .stats-grid-detailed .stat-item.present {
        background: linear-gradient(135deg, #0d2818, #238636);
    }
    
    .stats-grid-detailed .stat-item.absent {
        background: linear-gradient(135deg, #2c0e0e, #da3633);
    }
    
    .stats-grid-detailed .stat-item.excused {
        background: linear-gradient(135deg, #2d1b00, #bb8009);
    }
    
    .stats-grid-detailed .stat-item.rate {
        background: linear-gradient(135deg, #0c1929, #1f6feb);
    }
    
    /* 统计图标背景 */
    .stats-grid-detailed .stat-icon,
    .metric-icon {
        background: rgba(240, 246, 252, 0.1);
    }
    
    /* 请假信息 */
    .excuse-info {
        background: rgba(187, 128, 9, 0.15);
        border-left-color: var(--warning-color);
    }
    
    .excuse-title {
        color: var(--warning-color);
    }
    
    .excuse-reason {
        color: #f2cc60;
    }
    
    .excuse-approver {
        color: #d29922;
    }
    
    /* 空状态 */
    .empty-state,
    .practice-empty-state,
    .table-empty-state {
        color: var(--medium-gray);
    }
    
    .empty-state-title,
    .practice-empty-state-title,
    .table-empty-state-title {
        color: var(--text-color);
    }
    
    /* 加载动画 */
    .spinner {
        border-color: #30363d;
        border-top-color: var(--primary-color);
    }
    
    .loading-text {
        color: var(--medium-gray);
    }
    
    /* 滚动条深色适配 */
    *::-webkit-scrollbar-track {
        background: #0d1117;
    }
    
    *::-webkit-scrollbar-thumb {
        background-color: #30363d;
    }
    
    *::-webkit-scrollbar-thumb:hover {
        background-color: #484f58;
    }
    
    /* 表格滚动提示 */
    .table-scroll-hint {
        background: rgba(13, 17, 23, 0.9);
        color: var(--text-color);
    }
    
    /* 详情标签 */
    .detail-label {
        color: var(--medium-gray);
    }
    
    .detail-value {
        color: var(--text-color);
    }
    
    /* 特殊内容处理深色适配 */
    .detail-item .detail-value[style*="color: #f39c12"] {
        background: rgba(187, 128, 9, 0.15) !important;
        color: #f2cc60 !important;
    }
    
    /* 同步日志 */
    #syncLogs {
        background: #0d1117 !important;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    /* 日期选择器深色适配 */
    .date-picker {
        background: var(--light-gray);
        border: 1px solid var(--border-color);
    }
    
    /* 学生档案卡片深色渐变 */
    .student-profile-card {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    }
    
    /* 今日状态卡片深色适配 */
    .today-status-card.present { border-left-color: var(--success-color); }
    .today-status-card.absent { border-left-color: var(--danger-color); }
    .today-status-card.excused { border-left-color: var(--warning-color); }
    .today-status-card.low-efficiency { border-left-color: #bb8009; }
    .today-status-card.practicing-unscheduled { border-left-color: #8250df; }
    .today-status-card.weekend { border-left-color: #6e7681; }
    
    /* 指标项深色适配 */
    .metric-item {
        background: #30363d;
    }
    
    .metric-content {
        color: var(--text-color);
    }
    
    .metric-label {
        color: var(--medium-gray);
    }
    
    .metric-value {
        color: var(--text-color);
    }
    
    /* 卡片标题深色适配 */
    .card-title,
    .status-title,
    .modal-title {
        color: var(--text-color);
    }
    
    .title-subtitle {
        color: var(--medium-gray);
    }
    
    /* 考勤历史边框 */
    .attendance-history {
        border-top-color: var(--border-color);
    }
    
    /* 头部深色适配 */
    .header {
        background: var(--gradient-primary);
    }
    
    /* 高对比度模式下的深色适配 */
    @media (prefers-contrast: high) {
        :root {
            --border-color: #58a6ff;
            --text-color: #ffffff;
            --background-color: #000000;
        }
        
        .card {
            border: 2px solid var(--primary-color);
        }
        
        .btn {
            border: 2px solid currentColor;
        }
    }
}


/* ===== 37. 最终优化和清理 ===== */
/* 确保所有交互元素都有合适的过渡效果 */
button,
input,
select,
textarea,
.card,
.student-card,
.practice-status-card,
.stat-card,
.btn,
.nav-tab,
.quick-filter-tag,
.history-day {
    transition: all 0.3s ease;
}

/* 防止文本选择在某些交互元素上 */
.nav-tab,
.btn,
.student-status,
.student-status-compact,
.practice-duration,
.quick-filter-tag,
.history-day,
.stat-card {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

/* 确保图标和emoji正确显示 */
.title-icon,
.meta-icon,
.metric-icon,
.excuse-icon,
.stat-icon,
.practice-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* 最终的响应式优化 */
@media (max-width: 320px) {
    .container {
        padding: 8px;
    }
    
    .card {
        padding: 15px 10px;
    }
    
    .student-card,
    .practice-status-card {
        padding: 10px 8px;
        min-height: 100px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
}

/* ===== 样式文件结束 ===== */

</style>
</head>

<body>
<div class="container">
    <!-- 语言切换器 -->
    <div class="language-switcher">
        <button class="lang-btn active" onclick="switchLanguage('zh')" data-lang="zh">中文</button>
        <button class="lang-btn" onclick="switchLanguage('en')" data-lang="en">EN</button>
    </div>

    <!-- 连接状态指示器 -->
    <div id="connectionStatus" class="connection-status offline">
        <span data-i18n="status.offline">🔴 离线模式</span>
    </div>

    <!-- 头部 -->
    <div class="header">
        <h1><span data-i18n="header.title">🎼 青岛耶胡迪梅纽因学校</span></h1>
        <div class="subtitle" data-i18n="header.subtitle">实时练琴跟踪系统</div>
    </div>

    <!-- 导航标签 -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')">
            <span data-i18n="nav.dashboard">📊 考勤概览</span>
        </button>
        <button class="nav-tab" onclick="switchTab('students')">
            <span data-i18n="nav.students">👥 学生详情</span>
        </button>
        <button class="nav-tab" onclick="switchTab('reports')">
            <span data-i18n="nav.reports">📈 历史报告</span>
        </button>
        <button class="nav-tab" onclick="switchTab('sync')">
            <span data-i18n="nav.sync">🔄 数据同步</span>
        </button>
    </div>

    <!-- 考勤概览标签页 -->
    <div id="dashboardTab" class="tab-content">
        <!-- 统计面板 -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label" data-i18n="stats.total">总数</div>
                <div class="stat-description" data-i18n="stats.total.desc">已登记学生</div>
            </div>
            <div class="stat-card present">
                <div class="stat-number" id="presentCount">0</div>
                <div class="stat-label" data-i18n="stats.present">正常</div>
                <div class="stat-description" data-i18n="stats.present.desc">今日出勤率</div>
            </div>
            <div class="stat-card absent">
                <div class="stat-number" id="absentCount">0</div>
                <div class="stat-label" data-i18n="stats.absent">缺勤</div>
                <div class="stat-description" data-i18n="stats.absent.desc">需要关注</div>
            </div>
            <div class="stat-card excused">
                <div class="stat-number" id="excusedCount">0</div>
                <div class="stat-label" data-i18n="stats.excused">请假</div>
                <div class="stat-description" data-i18n="stats.excused.desc">已批准请假</div>
            </div>
        </div>

        <!-- 请假信息面板 -->
        <div class="card" id="excuseInfoPanel" style="display: none;">
            <h3 data-i18n="excuse.title">📝 今日请假信息</h3>
            <div id="excuseInfoContainer">
                <!-- 请假信息将在这里显示 -->
            </div>
        </div>

        <!-- 实时练琴状态 -->
        <div class="card">
            <h3 data-i18n="practice.title">🎹 实时练琴状态</h3>
            <div class="date-picker">
                <span style="color: #666; font-size: 14px;">
                    <span data-i18n="practice.current_time">当前时间：</span>
                    <span id="currentTime"></span>
                </span>
                <button class="btn btn-primary" onclick="refreshPracticeStatus()">
                    <span>🔄</span> <span data-i18n="btn.refresh_status">刷新状态</span>
                </button>
            </div>

            <!-- 🔥 新增：实时练琴筛选器 -->
            <div class="practice-filters">
                <div class="practice-filter-row">
                    <div class="practice-filter-group">
                        <label class="practice-filter-label" data-i18n="filter.major">专业筛选</label>
                        <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
                            <option value="" data-i18n="filter.all_majors">所有专业</option>
                        </select>
                    </div>
                    <div class="practice-filter-group">
                        <label class="practice-filter-label" data-i18n="filter.grade">年级筛选</label>
                        <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
                            <option value="" data-i18n="filter.all_grades">所有年级</option>
                        </select>
                    </div>
                    <div class="practice-filter-group">
                        <label class="practice-filter-label" data-i18n="filter.search">搜索学生</label>
                        <input type="text" id="practiceStudentSearch" class="practice-filter-input" 
                               data-i18n-placeholder="filter.search_placeholder" placeholder="输入学生姓名..." 
                               oninput="filterPracticeStatus()">
                    </div>
                </div>
                
                <!-- 🔥 新增：快速筛选标签 -->
                <div class="quick-filter-tags" id="practiceQuickFilters">
                    <!-- 快速筛选标签将在这里动态生成 -->
                </div>
            </div>

            <div id="practiceStatusContainer">
                <div id="practiceStudentList" class="student-grid">
                    <!-- 正在练琴的学生卡片将在这里显示 -->
                </div>
            </div>
        </div>

        <!-- 今日考勤快照 -->
        <div class="card">
            <h3 data-i18n="attendance.title">📅 今日考勤快照</h3>
            <div class="date-picker">
                <label for="dateSelect" data-i18n="attendance.select_date">选择日期：</label>
                <input type="date" id="dateSelect" class="date-input" onchange="loadAttendanceData()">
                <button class="btn btn-primary" onclick="refreshData()">
                    <span>🔄</span> <span data-i18n="btn.refresh_data">刷新数据</span>
                </button>
            </div>
            <div id="todaySnapshot" class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- 学生详情标签页 -->
    <div id="studentsTab" class="tab-content" style="display: none;">
        <!-- 筛选器 -->
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.major">专业筛选</label>
                    <select id="majorFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_majors">所有专业</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.grade">年级筛选</label>
                    <select id="gradeFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_grades">所有年级</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.status">考勤状态</label>
                    <select id="statusFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_status">所有状态</option>
                        <option value="present" data-i18n="status.present">出勤</option>
                        <option value="absent" data-i18n="status.absent">缺勤</option>
                        <option value="excused" data-i18n="status.excused">请假</option>
                        <option value="low-efficiency" data-i18n="status.low_efficiency">低效出勤</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.search">搜索学生</label>
                    <input type="text" id="studentSearch" class="filter-input" data-i18n-placeholder="filter.search_placeholder" placeholder="输入学生姓名..." oninput="filterStudents()">
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="refreshData()">
                <span>🔄</span> <span data-i18n="btn.refresh_data">刷新数据</span>
            </button>
        </div>

        <!-- 学生列表 -->
        <div id="studentList" class="student-grid">
            <!-- 学生卡片将在这里动态生成 -->
        </div>
    </div>

    <!-- 历史报告标签页 -->
    <div id="reportsTab" class="tab-content" style="display: none;">
        <div class="card">
            <h3 data-i18n="report.title">📈 考勤历史分析</h3>
            
            <!-- 日期范围选择 -->
            <div class="date-picker">
                <label for="startDate" data-i18n="report.start_date">开始日期：</label>
                <input type="date" id="startDate" class="date-input">
                <label for="endDate" data-i18n="report.end_date">结束日期：</label>
                <input type="date" id="endDate" class="date-input">
                <button class="btn btn-primary" onclick="generateReport()">
                    <span>📊</span> <span data-i18n="btn.generate_report">生成报告</span>
                </button>
            </div>

            <!-- 报告内容 -->
            <div id="reportContent">
                <div class="empty-state">
                    <div class="empty-state-icon">📊</div>
                    <div class="empty-state-title" data-i18n="report.empty.title">选择日期范围生成报告</div>
                    <div class="empty-state-description" data-i18n="report.empty.desc">选择开始和结束日期，然后点击"生成报告"按钮查看详细的考勤分析</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据同步标签页 -->
    <div id="syncTab" class="tab-content" style="display: none;">
        <div class="card">
            <h3 data-i18n="sync.title">🔄 数据同步管理</h3>
            
            <!-- 同步状态 -->
            <div class="card success" id="syncStatus">
                <h4 data-i18n="sync.status">同步状态</h4>
                <p id="syncStatusText" data-i18n="sync.checking">正在检查连接状态...</p>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="forceSyncData()">
                        <span>🔄</span> <span data-i18n="btn.force_sync">强制同步</span>
                    </button>
                    <button class="btn btn-warning" onclick="clearLocalCache()">
                        <span>🗑️</span> <span data-i18n="btn.clear_cache">清除缓存</span>
                    </button>
                </div>
            </div>

            <!-- 同步日志 -->
            <div class="card">
                <h4 data-i18n="sync.logs">📋 同步日志</h4>
                <div id="syncLogs" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 14px;">
                    <!-- 同步日志将在这里显示 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 学生详情模态框 -->
<div id="studentDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="studentDetailTitle" data-i18n="student.detail.title">学生详情</h3>
            <button class="modal-close" onclick="closeModal('studentDetailModal')">&times;</button>
        </div>
        <div id="studentDetailContent">
            <!-- 学生详细信息将在这里显示 -->
        </div>
    </div>
</div>

<script>
// 🌐 国际化配置
const i18n = {
    zh: {
        // 头部
        'header.title': '🎼 青岛耶胡迪梅纽因学校',
        'header.subtitle': '实时练琴跟踪系统',
        
        // 导航
        'nav.dashboard': '📊 考勤概览',
        'nav.students': '👥 学生详情',
        'nav.reports': '📈 历史报告',
        'nav.sync': '🔄 数据同步',
        
        // 状态
        'status.online': '已连接',
        'status.offline': '离线模式',
        'status.syncing': '同步中',
        'status.present': '出勤',
        'status.absent': '缺勤',
        'status.excused': '请假',
        'status.low_efficiency': '低效出勤',
        'status.practicing_unscheduled': '时间段外练琴',
        'status.weekend': '周末',
        'status.no_data': '无数据',      
        'status.pending': '待考勤',
 
        // 统计
        'stats.total': '总学生数',
        'stats.total.desc': '已登记学生',
        'stats.present': '出勤',
        'stats.present.desc': '今日出勤率',
        'stats.pending': '待考勤',              // 🔥 新增
        'stats.pending.desc': '等待考勤确认',  
        'stats.absent': '缺勤',
        'stats.absent.desc': '需要关注',
        'stats.excused': '请假',
        'stats.excused.desc': '已批准请假',
        'stats.practicing': '正在练琴',
        'stats.not_practicing': '未在练琴',
        'table.scroll_to_view': '滑动查看',
        'table.scroll_hint': '滑动查看更多',
        'table.no_records': '暂无历史记录',
        'table.no_records_desc': '该学生还没有考勤记录',
        'student.daily_total_duration': '当日累计练琴',
        'student.start_time': '开始时间',
        'student.not_started': '未开始',
        'attendance.status': '状态',
        'table.scroll_to_view': '滑动查看',
        'table.scroll_hint': '滑动查看更多',
        'table.no_records': '暂无历史记录',
        'table.no_records_desc': '该学生还没有考勤记录',
        'student.daily_total_duration': '当日累计练琴',
        'student.start_time': '开始时间',
        'student.not_started': '未开始',
        'attendance.status': '状态',
        
        // 按钮
        'btn.refresh_status': '刷新状态',
        'btn.refresh_data': '刷新数据',
        'btn.generate_report': '生成报告',
        'btn.force_sync': '强制同步',
        'btn.clear_cache': '清除缓存',
        'btn.close': '关闭',
        
        // 筛选器
        'filter.major': '专业筛选',
        'filter.grade': '年级筛选',
        'filter.status': '考勤状态',
        'filter.search': '搜索学生',
        'filter.all_majors': '所有专业',
        'filter.all_grades': '所有年级',
        'filter.all_status': '所有状态',
        'filter.search_placeholder': '输入学生姓名...',
        
        // 练琴状态
        'practice.title': '🎹 实时练琴状态',
        'practice.current_time': '当前时间：',
        'practice.empty.title': '当前没有学生在练琴',
        'practice.empty.desc.weekday': '工作日时间，等待学生开始练琴',
        'practice.empty.desc.weekend': '周末时间，学生可自主安排练琴',
        'practice.duration': '练琴时长',
        'practice.room': '所在琴房',
        'practice.start_time': '开始时间',
        'practice.type.weekend': '周末自主练琴',
        'practice.type.unscheduled': '时间段外练琴',
        
        // 考勤
        'attendance.title': '📅 今日考勤快照',
        'attendance.select_date': '选择日期：',
        'attendance.history': '最近7天考勤',
        'attendance.rate': '出勤率',
        
        // 学生信息
        'student.name': '姓名',
        'student.major': '专业',
        'student.grade': '年级',
        'student.time_slot': '时间段',
        'student.practice_duration': '练琴时长',
        'student.room': '所在琴房',
        'student.not_in_room': '不在琴房',
        'student.detail.title': '学生详情',
        'student.basic_info': '基本信息',
        'student.today_attendance': '当前状态',
        'student.attendance_stats': '考勤统计',
        'student.history_records': '历史记录',
        'student.no_schedule': '无',
        'student.self_practice': '自主练琴',
        'student.unknown_major': '未知专业',
        'student.not_set': '未设置',
        
        // 请假
        'excuse.title': '📝 今日请假信息',
        'excuse.reason': '请假原因',
        'excuse.time': '请假时间',
        'excuse.approver': '批准人',
        'excuse.submit_time': '提交时间',
        'excuse.status.approved': '已批准',
        'excuse.status.pending': '待审核',
        'excuse.status.rejected': '已拒绝',
        'excuse.not_filled': '未填写',
        'excuse.end_date': '结束日期',
        'excuse.duration_text': '请假时长',
        
        // 报告
        'report.title': '📈 考勤历史分析',
        'report.start_date': '开始日期：',
        'report.end_date': '结束日期：',
        'report.empty.title': '选择日期范围生成报告',
        'report.empty.desc': '选择开始和结束日期，然后点击"生成报告"按钮查看详细的考勤分析',
        'report.analysis_title': '📊 考勤分析报告',
        'report.period': '统计周期：',
        'report.participants': '参与学生：',
        'report.daily_trend': '📈 每日考勤趋势',
        'report.student_stats': '👥 学生考勤统计',
        'report.date': '日期',
        'report.total': '总人数',
        'report.days': '天',
        'report.people': '人',
        'report.regenerate': '重新生成',
        
        // 同步
        'sync.title': '🔄 数据同步管理',
        'sync.status': '同步状态',
        'sync.checking': '正在检查连接状态...',
        'sync.connected': '✅ 已连接到Firebase数据库',
        'sync.disconnected': '❌ 未连接到数据库',
        'sync.realtime': '数据正在实时同步中...',
        'sync.offline_mode': '当前处于离线模式，部分功能受限',
        'sync.last_sync': '最后同步时间: ',
        'sync.check_network': '请检查网络连接',
        'sync.logs': '📋 同步日志',
        'sync.offline': '离线模式',
        'sync.realtime_sync': '实时同步',
        
        // 消息
        'msg.no_data': '暂无数据',
        'msg.loading': '加载中...',
        'msg.network_required': '需要网络连接才能查看学生详情',
        'msg.sync_required': '需要网络连接才能同步数据',
        'msg.clear_cache_confirm': '确定要清除本地缓存吗？这将删除所有离线数据。',
        'msg.cache_cleared': '本地缓存已清除',
        'msg.date_range_error': '开始日期不能晚于结束日期',
        'msg.select_dates': '请选择开始和结束日期',
        'msg.student_not_found': '未找到学生信息',
        
        // 时间
        'time.minutes': '分钟',
        'time.hours': '小时',
        'time.seconds': '秒',
        'time.no_practice': '0分钟',
        
        // 空状态
        'empty.no_students': '暂无学生数据',
        'empty.ensure_sync': '请确保学生数据已正确同步',
        'empty.no_attendance': '还没有考勤记录',
        'empty.offline_no_data': '离线模式下没有找到该日期的考勤数据',
        'empty.load_failed': '加载失败',
        'empty.network_error': '无法加载考勤数据，请检查网络连接',

        // 筛选
        'filter.clear': '清除',
        'filter.no_results': '没有符合条件的学生',
        'filter.try_different': '请尝试调整筛选条件',
        'practice.scheduled': '规定时段',
        'practice.unscheduled': '时段外',
        'practice.total': '总时长',
        'report.last_30_days': '最近30天',
        'report.to': '至',
    },
    
    en: {
        // Header
        'header.title': '🎼 Qingdao Yehudi Menuhin School',
        'header.subtitle': 'Real-time Practice Tracking System',
        
        // Navigation
        'nav.dashboard': '📊 Dashboard',
        'nav.students': '👥 Students',
        'nav.reports': '📈 Reports',
        'nav.sync': '🔄 Sync',
        
        // Status
        'status.online': 'Online',
        'status.offline': 'Offline',
        'status.syncing': 'Syncing',

        'status.present': 'Present',
        'status.absent': 'Absent',
        'status.excused': 'Excused',
        'status.low_efficiency': 'Low Efficiency',
        'status.practicing_unscheduled': 'Unscheduled Practice',
        'status.weekend': 'Weekend',
        'status.no_data': 'No Data',
        'status.pending': 'Pending', 
        
        // Statistics
        'stats.total': 'Total Students',
        'stats.total.desc': 'Registered Students',
        'stats.present': 'Present',
        'stats.present.desc': 'Today\'s Attendance',
        'stats.pending': 'Pending',              // 🔥 新增
        'stats.pending.desc': 'Awaiting Check', 
        'stats.absent': 'Absent',
        'stats.absent.desc': 'Need Attention',
        'stats.excused': 'Excused',
        'stats.excused.desc': 'Approved Leave',
        'stats.practicing': 'Practicing',
        'stats.not_practicing': 'Not Practicing',
        'table.scroll_to_view': 'Scroll to View',
        'table.scroll_hint': 'Scroll for More',
        'table.no_records': 'No Records',
        'table.no_records_desc': 'No attendance records for this student',
        'student.daily_total_duration': 'Daily Total Duration',
        'student.start_time': 'Start Time',
        'student.not_started': 'Not Started',
        'attendance.status': 'Status',
        
        // Buttons
        'btn.refresh_status': 'Refresh Status',
        'btn.refresh_data': 'Refresh Data',
        'btn.generate_report': 'Generate Report',
        'btn.force_sync': 'Force Sync',
        'btn.clear_cache': 'Clear Cache',
        'btn.close': 'Close',
        
        // Filters
        'filter.major': 'Major Filter',
        'filter.grade': 'Grade Filter',
        'filter.status': 'Status Filter',
        'filter.search': 'Search Student',
        'filter.all_majors': 'All Majors',
        'filter.all_grades': 'All Grades',
        'filter.all_status': 'All Status',
        'filter.search_placeholder': 'Enter student name...',
        
        // Practice Status
        'practice.title': '🎹 Real-time Practice Status',
        'practice.current_time': 'Current Time: ',
        'practice.empty.title': 'No students practicing currently',
        'practice.empty.desc.weekday': 'Weekday time, waiting for students to start practicing',
        'practice.empty.desc.weekend': 'Weekend time, students can arrange practice freely',
        'practice.duration': 'Practice Duration',
        'practice.room': 'Practice Room',
        'practice.start_time': 'Start Time',
        'practice.type.weekend': 'Weekend Self Practice',
        'practice.type.unscheduled': 'Unscheduled Practice',
        
        // Attendance
        'attendance.title': '📅 Today\'s Attendance Snapshot',
        'attendance.select_date': 'Select Date: ',
        'attendance.history': 'Last 7 Days Attendance',
        'attendance.rate': 'Attendance Rate',
        
        // Student Information
        'student.name': 'Name',
        'student.major': 'Major',
        'student.grade': 'Grade',
        'student.time_slot': 'Time Slot',
        'student.practice_duration': 'Practice Duration',
        'student.room': 'Practice Room',
        'student.not_in_room': 'Not in Room',
        'student.detail.title': 'Student Details',
        'student.basic_info': 'Basic Information',
        'student.today_attendance': 'Today\'s Attendance',
        'student.attendance_stats': 'Attendance Statistics',
        'student.history_records': 'History Records',
        'student.no_schedule': 'None',
        'student.self_practice': 'Self Practice',
        'student.unknown_major': 'Unknown Major',
        'student.not_set': 'Not Set',
        
        // Leave/Excuse
        'excuse.title': '📝 Today\'s Leave Information',
        'excuse.reason': 'Leave Reason',
        'excuse.time': 'Leave Time',
        'excuse.approver': 'Approver',
        'excuse.submit_time': 'Submit Time',
        'excuse.status.approved': 'Approved',
        'excuse.status.pending': 'Pending',
        'excuse.status.rejected': 'Rejected',
        'excuse.not_filled': 'Not Filled',
        'excuse.end_date': 'End Date',
        'excuse.duration_text': 'Leave Duration',
        
        // Reports
        'report.title': '📈 Attendance History Analysis',
        'report.start_date': 'Start Date: ',
        'report.end_date': 'End Date: ',
        'report.empty.title': 'Select date range to generate report',
        'report.empty.desc': 'Select start and end dates, then click "Generate Report" to view detailed attendance analysis',
        'report.analysis_title': '📊 Attendance Analysis Report',
        'report.period': 'Period: ',
        'report.participants': 'Participants: ',
        'report.daily_trend': '📈 Daily Attendance Trend',
        'report.student_stats': '👥 Student Attendance Statistics',
        'report.date': 'Date',
        'report.total': 'Total',
        'report.days': ' days',
        'report.people': ' people',
        'report.regenerate': 'Regenerate',
        
        // Sync
        'sync.title': '🔄 Data Sync Management',
        'sync.status': 'Sync Status',
        'sync.checking': 'Checking connection status...',
        'sync.connected': '✅ Connected to Firebase database',
        'sync.disconnected': '❌ Not connected to database',
        'sync.realtime': 'Data is syncing in real-time...',
        'sync.offline_mode': 'Currently in offline mode, some features are limited',
        'sync.last_sync': 'Last sync time: ',
        'sync.check_network': 'Please check network connection',
        'sync.logs': '📋 Sync Logs',
        'sync.offline': 'Offline Mode',
        'sync.realtime_sync': 'Real-time Sync',
        
        // Messages
        'msg.no_data': 'No Data',
        'msg.loading': 'Loading...',
        'msg.network_required': 'Network connection required to view student details',
        'msg.sync_required': 'Network connection required to sync data',
        'msg.clear_cache_confirm': 'Are you sure you want to clear local cache? This will delete all offline data.',
        'msg.cache_cleared': 'Local cache cleared',
        'msg.date_range_error': 'Start date cannot be later than end date',
        'msg.select_dates': 'Please select start and end dates',
        'msg.student_not_found': 'Student information not found',
        
        // Time
        'time.minutes': ' minutes',
        'time.hours': ' hours',
        'time.seconds': ' seconds',
        'time.no_practice': '0 minutes',
        
        // Empty States
        'empty.no_students': 'No student data',
        'empty.ensure_sync': 'Please ensure student data is properly synced',
        'empty.no_attendance': 'No attendance records yet',
        'empty.offline_no_data': 'No attendance data found for this date in offline mode',
        'empty.load_failed': 'Load Failed',
        'empty.network_error': 'Unable to load attendance data, please check network connection',
        //shaixuan
        'filter.clear': 'Clear',
        'filter.no_results': 'No matching students',
        'filter.try_different': 'Please try different filter criteria',
        'practice.scheduled': 'Scheduled',
        'practice.unscheduled': 'Unscheduled', 
        'practice.total': 'Total',
        'report.last_30_days': 'Last 30 Days',
        'report.to': 'to'
    }
};

// 当前语言
let currentLanguage = 'zh';

// 语言切换函数
function switchLanguage(lang) {
    if (lang === currentLanguage) return;
    
    currentLanguage = lang;
    
    // 更新按钮状态
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-lang') === lang) {
            btn.classList.add('active');
        }
    });
    
    // 更新页面文本
    updatePageLanguage();
    
    // 保存语言偏好
    localStorage.setItem('preferred_language', lang);
    
    // 重新渲染当前页面内容
    refreshCurrentTabContent();
    
    addSyncLog(`🌐 语言已切换为 ${lang === 'zh' ? '中文' : 'English'}`);
}

// 更新页面语言
function updatePageLanguage() {
    const texts = i18n[currentLanguage];
    
    // 更新所有带有 data-i18n 属性的元素
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (texts[key]) {
            element.textContent = texts[key];
        }
    });
    
    // 更新 placeholder 文本
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (texts[key]) {
            element.placeholder = texts[key];
        }
    });
    
    // 更新页面标题
    document.title = currentLanguage === 'zh' ? 
        '青岛梅纽因音乐学校练琴跟踪系统' : 
        'Qingdao Menuhin Music School Practice Tracking System';
}

// 获取翻译文本
function t(key, fallback = '') {
    const texts = i18n[currentLanguage];
    return texts[key] || fallback || key;
}

// 刷新当前标签页内容
function refreshCurrentTabContent() {
    switch(currentTab) {
        case 'dashboard':
            if (attendanceData && Object.keys(attendanceData).length > 0) {
                updateDashboard();
                displayPracticeStatus();
            }
            break;
        case 'students':
            if (Object.keys(studentData).length > 0) {
                loadStudentList();
                updateStatusFilterOptions();
            }
            break;
        case 'reports':
            // 报告页面不需要特殊刷新
            break;
        case 'sync':
            updateSyncStatus();
            break;
    }
}

// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyBfRjrAKsVUAHBl5WbBl96YONrkRe1UWUo",
  authDomain: "menuhin-studio-system.firebaseapp.com",
  databaseURL: "https://menuhin-studio-system-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "menuhin-studio-system",
  storageBucket: "menuhin-studio-system.firebasestorage.app",
  messagingSenderId: "218592951152",
  appId: "1:218592951152:web:650d080726b6c44f5a2db5",
  measurementId: "G-P49SZQTLT7"
};


// 全局变量
let database = null;
let isOnline = false;
let currentTab = 'dashboard';
let attendanceData = {
    realTimePractice: {}
};
let studentData = {};
let excuseData = {};
let syncLogs = [];
let rooms = [];

let syncTimers = new Set();
let isInitialized = false;
let debugMode = true;
// 🔥 新增：实时练琴状态相关变量（变化驱动版）
let realTimePracticeStatus = {}; // 存储每个学生的实时状态
let lastRealTimePracticeHash = ''; // 用于检测变化的哈希值
let practiceStatusUpdateTimeout = null; // 防抖定时器

// 调试日志函数
function debugLog(message, data = null) {
    if (debugMode) {
        console.log(`[DEBUG] ${message}`, data || '');
        addSyncLog(`🔍 ${message}${data ? ': ' + JSON.stringify(data) : ''}`);
    }
}

// 初始化 Firebase
function initFirebase() {
    if (isInitialized) {
        console.log('Firebase已经初始化，跳过重复初始化');
        return;
    }
    
    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        isInitialized = true;
        
        // 监听连接状态
        database.ref('.info/connected').on('value', (snapshot) => {
            const wasOnline = isOnline;
            isOnline = snapshot.val() === true;
            updateConnectionStatus();
            
            if (isOnline && !wasOnline) {
                addSyncLog('✅ ' + t('sync.connected', '已连接到Firebase数据库'));
                setTimeout(() => {
                    loadInitialData();
                }, 1000);
            } else if (!isOnline && wasOnline) {
                addSyncLog('❌ ' + t('sync.disconnected', '与Firebase数据库断开连接'));
            }
        });
        
        // 监听考勤数据变化
        database.ref('attendanceData').on('value', (snapshot) => {
            try {
                if (snapshot.exists()) {
                    const newData = snapshot.val();
                    if (newData && typeof newData === 'object') {
                        attendanceData = { ...attendanceData, ...newData };
                        addSyncLog('📥 ' + t('sync.attendance_updated', '考勤数据已更新'));
                        updateDashboard();
                        if (currentTab === 'students') {
                            loadStudentList();
                        }
                    }
                }
            } catch (error) {
                console.error('处理考勤数据更新失败:', error);
                addSyncLog('❌ ' + t('sync.attendance_failed', '考勤数据更新失败') + ': ' + error.message);
            }
        }, (error) => {
            console.error('监听考勤数据失败:', error);
            addSyncLog('❌ ' + t('sync.listen_failed', '监听考勤数据失败') + ': ' + error.message);
        });

        // 监听实时练琴状态变化
        let practiceUpdateTimeout;
        database.ref('realTimePracticeStatus').on('value', (snapshot) => {
            try {
                clearTimeout(practiceUpdateTimeout);
                practiceUpdateTimeout = setTimeout(() => {
                    if (snapshot.exists()) {
                        handleRemoteRealTimePracticeUpdate(snapshot.val());
                    } else {
                        handleRemoteRealTimePracticeUpdate({});
                    }
                }, 500);
            } catch (error) {
                console.error('处理实时练琴状态更新失败:', error);
                addSyncLog('❌ ' + t('sync.practice_failed', '实时练琴状态更新失败') + ': ' + error.message);
            }
        }, (error) => {
            console.error('监听实时练琴状态失败:', error);
            addSyncLog('❌ ' + t('sync.practice_listen_failed', '监听实时练琴状态失败') + ': ' + error.message);
        });
        
        // 监听琴房状态变化
        let roomsUpdateTimeout;
        database.ref('rooms').on('value', (snapshot) => {
            try {
                clearTimeout(roomsUpdateTimeout);
                roomsUpdateTimeout = setTimeout(() => {
                    if (snapshot.exists()) {
                        handleRoomsUpdate(snapshot.val());
                    } else {
                        handleRoomsUpdate([]);
                    }
                }, 500);
            } catch (error) {
                console.error('处理琴房状态更新失败:', error);
                addSyncLog('❌ ' + t('sync.rooms_failed', '琴房状态更新失败') + ': ' + error.message);
            }
        }, (error) => {
            console.error('监听琴房状态失败:', error);
            addSyncLog('❌ ' + t('sync.rooms_listen_failed', '监听琴房状态失败') + ': ' + error.message);
        });
        
        // 监听学生数据变化（包含本地存储）
        database.ref('studentDatabase').on('value', (snapshot) => {
            try {
                if (snapshot.exists()) {
                    const newStudentData = snapshot.val();
                    if (newStudentData && typeof newStudentData === 'object') {
                        studentData = newStudentData;
                        
                        // 保存到本地存储
                        try {
                            localStorage.setItem('studentData', JSON.stringify(newStudentData));
                        } catch (e) {
                            console.warn('保存学生数据到本地存储失败:', e);
                        }
                        
                        addSyncLog('📥 ' + t('sync.student_updated', '学生数据已更新'));
                        updateFilters();
                        if (currentTab === 'students') {
                            loadStudentList();
                        }
                    }
                }
            } catch (error) {
                console.error('处理学生数据更新失败:', error);
                addSyncLog('❌ ' + t('sync.student_failed', '学生数据更新失败') + ': ' + error.message);
            }
        }, (error) => {
            console.error('监听学生数据失败:', error);
            addSyncLog('❌ ' + t('sync.student_listen_failed', '监听学生数据失败') + ': ' + error.message);
        });

        // 监听请假数据变化（包含本地存储）
        database.ref('excuseData').on('value', (snapshot) => {
            try {
                if (snapshot.exists()) {
                    const newExcuseData = snapshot.val();
                    if (newExcuseData && typeof newExcuseData === 'object') {
                        excuseData = newExcuseData;
                        
                        // 保存到本地存储
                        try {
                            localStorage.setItem('excuseData', JSON.stringify(newExcuseData));
                        } catch (e) {
                            console.warn('保存请假数据到本地存储失败:', e);
                        }
                        
                        addSyncLog('📥 ' + t('sync.excuse_updated', '请假数据已更新'));
                        if (currentTab === 'dashboard') {
                            updateDashboard();
                        } else if (currentTab === 'students') {
                            loadStudentList();
                        }
                    }
                }
            } catch (error) {
                console.error('处理请假数据更新失败:', error);
                addSyncLog('❌ ' + t('sync.excuse_failed', '请假数据更新失败') + ': ' + error.message);
            }
        }, (error) => {
            console.error('监听请假数据失败:', error);
            addSyncLog('❌ ' + t('sync.excuse_listen_failed', '监听请假数据失败') + ': ' + error.message);
        });
        
    } catch (error) {
        console.error('Firebase初始化失败:', error);
        addSyncLog('❌ Firebase初始化失败: ' + error.message);
        isInitialized = false;
    }
}

function handleRoomsUpdate(roomsData) {
    debugLog('收到琴房状态更新', roomsData ? roomsData.length + '间琴房' : '空数据');
    
    if (!roomsData || !Array.isArray(roomsData) || roomsData.length === 0) {
        debugLog('琴房数据为空，强制清理所有练琴状态');
        
        // 🔥 修复：确保 realTimePractice 结构正确
        if (!attendanceData.realTimePractice) {
            attendanceData.realTimePractice = {};
        }
        
        if (Object.keys(attendanceData.realTimePractice).length > 0) {
            const clearedStudents = Object.keys(attendanceData.realTimePractice);
            attendanceData.realTimePractice = {};
            
            displayPracticeStatus();
            
            addSyncLog(`🧹 琴房系统已清空，强制清理 ${clearedStudents.length} 个练琴状态`);
            console.log('🧹 已清理所有练琴状态:', clearedStudents);
        }
        
        rooms = [];
        return;
    }

    console.log('🏠 收到琴房状态更新:', roomsData.length, '间琴房');
    rooms = roomsData;
    
    // 🔥 修复：确保数据结构正确初始化
    if (!attendanceData.realTimePractice) {
        attendanceData.realTimePractice = {};
    }
    
    // 构建当前活跃的练琴学生列表
    const currentActivePractice = {};
    const now = Date.now();
    
    roomsData.forEach(room => {
        // 🔥 修复：正确访问 room 对象的属性
        if (room && typeof room === 'object' && 
            room.student && 
            room.student !== '空闲' && 
            room.student !== null && 
            room.registerTime) {
            
            const studentName = room.student;
            const registerTime = new Date(room.registerTime).getTime();
            
            // 验证时间有效性
            if (registerTime > 0 && registerTime <= now && (now - registerTime) < 12 * 60 * 60 * 1000) {
                const currentDuration = Math.floor((now - registerTime) / 1000);
                
                currentActivePractice[studentName] = {
                    room: room.name || '未知琴房',
                    startTime: room.registerTime,
                    currentDuration: currentDuration,
                    status: 'practicing',
                    lastUpdated: now,
                    syncSource: 'rooms'
                };
            }
        }
    });
    
    let hasChanges = false;
    const currentStudents = Object.keys(attendanceData.realTimePractice);
    const activeStudents = Object.keys(currentActivePractice);
    
    // 清理不在活跃列表中的学生
    currentStudents.forEach(studentName => {
        const currentRecord = attendanceData.realTimePractice[studentName];
        
        if (!activeStudents.includes(studentName) && 
            (currentRecord.syncSource === 'rooms' || currentRecord.room)) {
            console.log(`🧹 学生已离开琴房，清理状态: ${studentName}`);
            delete attendanceData.realTimePractice[studentName];
            hasChanges = true;
        }
    });
    
    // 更新或添加活跃学生的状态
    activeStudents.forEach(studentName => {
        const newRecord = currentActivePractice[studentName];
        const currentRecord = attendanceData.realTimePractice[studentName];
        
        if (!currentRecord || 
            currentRecord.room !== newRecord.room ||
            Math.abs((currentRecord.currentDuration || 0) - newRecord.currentDuration) > 30) {
            
            attendanceData.realTimePractice[studentName] = newRecord;
            hasChanges = true;
            console.log(`🔄 更新琴房练琴状态: ${studentName} in ${newRecord.room}`);
        }
    });
    
    if (hasChanges) {
        if (currentTab === 'dashboard') {
            displayPracticeStatus();
        }
        
        const activeCount = Object.keys(currentActivePractice).length;
        addSyncLog(`🏠 琴房状态已同步 (${activeCount}名学生在练琴)`);
        
        if (activeCount === 0) {
            addSyncLog('✅ 所有琴房已清空，无学生在练琴');
        }
        
        if (isOnline) {
            triggerRealTimePracticeStatusUpdate();
        }
    }
}


/* =============== 实时练琴状态同步系统（变化驱动版） =============== */

/**
 * 计算学生的实时练琴状态
 */
function calculateRealTimePracticeStatus(studentName) {
    const practiceData = attendanceData.realTimePractice || {};
    const studentPractice = practiceData[studentName];
    
    if (!studentPractice || !studentPractice.startTime) {
        return null;
    }
    
    const now = Date.now();
    const startTime = new Date(studentPractice.startTime).getTime();
    
    // 验证时间有效性
    if (isNaN(startTime) || startTime > now || (now - startTime) > 12 * 60 * 60 * 1000) {
        return null;
    }
    
    const currentDuration = Math.floor((now - startTime) / 1000);
    
    return {
        currentDuration,
        lastUpdated: now,
        room: studentPractice.room || '未知琴房',
        startTime: studentPractice.startTime,
        status: 'practicing'
    };
}

/**
 * 生成实时状态的哈希值，用于检测变化
 */
function generateRealTimePracticeHash(statusData) {
    // 只包含关键状态信息，排除时间戳
    const keyData = {};
    Object.keys(statusData).forEach(studentName => {
        const status = statusData[studentName];
        if (status) {
            keyData[studentName] = {
                room: status.room,
                status: status.status,
                // 将时长按10秒取整，减少微小变化
                durationRounded: Math.floor((status.currentDuration || 0) / 10) * 10
            };
        }
    });
    return JSON.stringify(keyData);
}

/**
 * 检查并更新实时练琴状态（仅在有变化时同步）
 */
function checkAndUpdateRealTimePracticeStatus(forceUpdate = false) {
    const newStatus = {};
    
    // 遍历所有正在练琴的学生
    if (attendanceData.realTimePractice) {
        Object.keys(attendanceData.realTimePractice).forEach(studentName => {
            const status = calculateRealTimePracticeStatus(studentName);
            if (status) {
                newStatus[studentName] = status;
            }
        });
    }
    
    // 生成新的哈希值
    const newHash = generateRealTimePracticeHash(newStatus);
    
    // 检查是否有实质性变化
    const hasSignificantChange = newHash !== lastRealTimePracticeHash || forceUpdate;
    
    if (hasSignificantChange) {
        debugLog('检测到实时练琴状态变化，准备同步', Object.keys(newStatus));
        
        // 更新状态和哈希值
        realTimePracticeStatus = newStatus;
        lastRealTimePracticeHash = newHash;
        
        // 防抖同步：短时间内多次变化只同步最后一次
        if (practiceStatusUpdateTimeout) {
            clearTimeout(practiceStatusUpdateTimeout);
        }
        
        practiceStatusUpdateTimeout = setTimeout(() => {
            syncRealTimePracticeStatusToFirebase();
            practiceStatusUpdateTimeout = null;
        }, 1000); // 1秒防抖
        
        // 🔥 移除：不再保存到本地存储
        
        return true; // 有变化
    }
    
    return false; // 无变化
}


/**
 * 同步实时练琴状态到 Firebase
 */
function syncRealTimePracticeStatusToFirebase() {
    if (!database || !isOnline) {
        debugLog('跳过实时状态同步', { database: !!database, isOnline });
        return;
    }
    
    // 清理数据，确保兼容 Firebase
    const cleanData = cleanDataForFirebase(realTimePracticeStatus);
    
    debugLog('同步实时练琴状态到云端，学生数量', Object.keys(cleanData).length);
    
    database.ref('realTimePracticeStatus').set(cleanData)
        .then(() => {
            addSyncLog('✅ 实时练琴状态同步成功');
            debugLog('实时练琴状态同步成功');
        })
        .catch(error => {
            console.error('实时练琴状态同步失败:', error);
            addSyncLog('❌ 实时练琴状态同步失败: ' + error.message);
        });
}

/**
 * 清理Firebase数据，确保兼容性
 */
function cleanDataForFirebase(data) {
    if (!data || typeof data !== 'object') return {};
    
    const cleaned = {};
    Object.keys(data).forEach(key => {
        if (key && data[key] && typeof data[key] === 'object') {
            cleaned[key] = { ...data[key] };
            
            // 确保所有时间戳都是有效的数字
            if (cleaned[key].lastUpdated) {
                cleaned[key].lastUpdated = Number(cleaned[key].lastUpdated) || Date.now();
            }
            if (cleaned[key].startTime) {
                const startTime = new Date(cleaned[key].startTime).getTime();
                cleaned[key].startTime = isNaN(startTime) ? Date.now() : startTime;
            }
            if (cleaned[key].currentDuration) {
                cleaned[key].currentDuration = Number(cleaned[key].currentDuration) || 0;
            }
        }
    });
    
    return cleaned;
}

/**
 * 立即触发实时状态检查和同步（用于关键操作后）
 */
function triggerRealTimePracticeStatusUpdate() {
    // 立即检查并同步，跳过防抖
    if (practiceStatusUpdateTimeout) {
        clearTimeout(practiceStatusUpdateTimeout);
        practiceStatusUpdateTimeout = null;
    }
    
    setTimeout(() => {
        checkAndUpdateRealTimePracticeStatus(true);
    }, 100);
}

/**
 * 定期检查状态变化（用于捕获时间推移导致的状态变化）
 */
function periodicRealTimePracticeStatusCheck() {
    // 只检查，不强制更新
    checkAndUpdateRealTimePracticeStatus(false);
}

/**
 * 清理已结束练琴的学生状态
 */
function cleanupEndedPracticeStatus() {
    if (!attendanceData.realTimePractice) return;
    
    const activeStudents = new Set(Object.keys(attendanceData.realTimePractice));
    let hasChanges = false;
    
    Object.keys(realTimePracticeStatus).forEach(studentName => {
        if (!activeStudents.has(studentName)) {
            delete realTimePracticeStatus[studentName];
            hasChanges = true;
        }
    });
    
    if (hasChanges) {
        debugLog('清理已结束练琴的学生状态');
        lastRealTimePracticeHash = generateRealTimePracticeHash(realTimePracticeStatus);
        // 🔥 移除：不再保存到本地存储
        syncRealTimePracticeStatusToFirebase();
    }
}

/**
 * 获取指定学生的实时练琴状态
 */
function getStudentRealTimePracticeStatus(studentName) {
    return realTimePracticeStatus[studentName] || null;
}

/**
 * 处理远程实时练琴状态更新
 */
function handleRemoteRealTimePracticeUpdate(remoteStatus) {
    try {
        debugLog('收到远程实时练琴状态更新', remoteStatus);
        
        if (!attendanceData) {
            attendanceData = {};
        }
        if (!attendanceData.realTimePractice) {
            attendanceData.realTimePractice = {};
        }
        
        // 🔥 关键修复：如果远程数据为空，强制清空本地状态
        if (!remoteStatus || typeof remoteStatus !== 'object' || Object.keys(remoteStatus).length === 0) {
            debugLog('远程练琴数据为空，强制清空本地状态');
            
            const clearedCount = Object.keys(attendanceData.realTimePractice).length;
            attendanceData.realTimePractice = {};
            
            // 🔥 同时清理同步状态
            realTimePracticeStatus = {};
            lastRealTimePracticeHash = '';
            
            // 🔥 移除：不再操作本地存储
            displayPracticeStatus();
            
            if (clearedCount > 0) {
                addSyncLog(`🧹 远程数据为空，已强制清空 ${clearedCount} 个练琴状态`);
            }
            return;
        }

        const remoteStudentNames = Object.keys(remoteStatus);
        const localStudentNames = Object.keys(attendanceData.realTimePractice);
        
        debugLog('远程练琴学生', remoteStudentNames);
        debugLog('本地练琴学生', localStudentNames);
        
        let hasChanges = false;
        const now = Date.now();
        
        // 🔥 关键修复：强制清理不在远程数据中的学生
        localStudentNames.forEach(studentName => {
            if (!remoteStudentNames.includes(studentName)) {
                debugLog(`强制清理不在远程数据中的学生: ${studentName}`);
                delete attendanceData.realTimePractice[studentName];
                hasChanges = true;
            }
        });

        // 更新远程数据中的学生状态
        remoteStudentNames.forEach(studentName => {
            const remoteRecord = remoteStatus[studentName];
            const currentStatus = attendanceData.realTimePractice[studentName];
            
            if (!remoteRecord || typeof remoteRecord !== 'object') {
                console.warn(`⚠️ 学生 ${studentName} 的远程数据无效:`, remoteRecord);
                return;
            }
            
            // 验证时间数据有效性
            const startTime = new Date(remoteRecord.startTime).getTime();
            if (isNaN(startTime) || startTime > now || (now - startTime) > 24 * 60 * 60 * 1000) {
                console.warn(`⚠️ 学生 ${studentName} 的时间数据异常，清理该记录`);
                if (attendanceData.realTimePractice[studentName]) {
                    delete attendanceData.realTimePractice[studentName];
                    hasChanges = true;
                }
                return;
            }
            
            const shouldUpdate = !currentStatus || 
                currentStatus.room !== remoteRecord.room ||
                Math.abs((currentStatus.currentDuration || 0) - (remoteRecord.currentDuration || 0)) > 10 ||
                currentStatus.startTime !== remoteRecord.startTime;
            
            if (shouldUpdate) {
                attendanceData.realTimePractice[studentName] = {
                    room: remoteRecord.room,
                    startTime: remoteRecord.startTime,
                    currentDuration: remoteRecord.currentDuration || 0,
                    lastUpdated: now,
                    syncSource: 'remote'
                };
                hasChanges = true;
                debugLog(`更新学生练琴状态: ${studentName}`, remoteRecord);
            }
        });
        
        if (hasChanges) {
            if (currentTab === 'dashboard') {
                displayPracticeStatus();
            }
            
            // 🔥 移除：不再保存到本地存储
            
            // 🔥 新增：同步更新本地同步状态
            setTimeout(() => {
                checkAndUpdateRealTimePracticeStatus(true);
            }, 500);
            
            const activeCount = remoteStudentNames.length;
            addSyncLog(`🎹 实时练琴状态已同步 (${activeCount}名学生)`);
            
            if (activeCount === 0) {
                addSyncLog('✅ 所有学生已结束练琴');
            }
        }
    } catch (error) {
        console.error('处理实时练琴状态更新失败:', error);
        addSyncLog('❌ 实时练琴状态更新失败: ' + error.message);
    }
}

// 🔥 新增：强制同步验证函数
function forceValidateAndSync() {
    if (!isOnline || !database) {
        console.log('离线状态，跳过强制同步验证');
        return;
    }
    
    console.log('🔍 开始强制同步验证...');
    
    const promises = [];
    
    // 同时获取琴房和练琴状态数据
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            const roomsData = snapshot.exists() ? snapshot.val() : [];
            console.log('🏠 强制获取琴房数据:', roomsData);
            handleRoomsUpdate(roomsData);
        })
        .catch((error) => {
            console.error('强制获取琴房数据失败:', error);
        });
    
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            const practiceData = snapshot.exists() ? snapshot.val() : {};
            console.log('🎹 强制获取练琴数据:', practiceData);
            handleRemoteRealTimePracticeUpdate(practiceData);
        })
        .catch((error) => {
            console.error('强制获取练琴数据失败:', error);
        });
    
    promises.push(roomsPromise, practicePromise);
    
    Promise.all(promises).then(() => {
        console.log('✅ 强制同步验证完成');
        addSyncLog('🔍 强制同步验证完成');
    });
}
// 🔥 新增：强制验证实时练琴数据
function forceValidateRealTimePractice() {
    if (!isOnline || !database) return;
    
    const promises = [];
    
    // 获取远程练琴状态
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            const remoteData = snapshot.exists() ? snapshot.val() : {};
            debugLog('强制验证 - 远程练琴数据', remoteData);
            
            // 立即处理远程数据
            handleRemoteRealTimePracticeUpdate(remoteData);
        })
        .catch((error) => {
            console.error('强制验证练琴数据失败:', error);
        });
    
    // 获取琴房状态
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            const roomsData = snapshot.exists() ? snapshot.val() : [];
            debugLog('强制验证 - 琴房数据', roomsData);
            
            // 立即处理琴房数据
            handleRoomsUpdate(roomsData);
        })
        .catch((error) => {
            console.error('强制验证琴房数据失败:', error);
        });
    
    promises.push(practicePromise, roomsPromise);
    
    Promise.all(promises).then(() => {
        // 验证完成后立即清理过期数据
        validateAndCleanExpiredData();
        debugLog('强制验证完成');
    });
}

// 🔥 新增：深度验证和同步
function deepValidateAndSync() {
    if (!isOnline || !database) return;
    
    debugLog('开始深度验证和同步');
    
    // 先清理本地过期数据
    validateAndCleanExpiredData();
    
    // 然后获取最新的远程数据进行对比
    Promise.all([
        database.ref('realTimePracticeStatus').once('value'),
        database.ref('rooms').once('value')
    ]).then(([practiceSnapshot, roomsSnapshot]) => {
        const remotePracticeData = practiceSnapshot.exists() ? practiceSnapshot.val() : {};
        const remoteRoomsData = roomsSnapshot.exists() ? roomsSnapshot.val() : [];
        
        debugLog('深度验证 - 远程练琴数据', remotePracticeData);
        debugLog('深度验证 - 远程琴房数据', remoteRoomsData);
        debugLog('深度验证 - 本地练琴数据', attendanceData.realTimePractice);
        
        // 检查数据一致性
        const remoteStudents = Object.keys(remotePracticeData);
        const localStudents = Object.keys(attendanceData.realTimePractice || {});
        
        // 如果本地有学生但远程没有，强制清理
        const studentsToRemove = localStudents.filter(student => !remoteStudents.includes(student));
        if (studentsToRemove.length > 0) {
            debugLog('深度验证发现需要清理的学生', studentsToRemove);
            studentsToRemove.forEach(studentName => {
                delete attendanceData.realTimePractice[studentName];
            });
            localStorage.setItem('realTimePracticeStatus', JSON.stringify(attendanceData.realTimePractice));
            displayPracticeStatus();
            addSyncLog(`🧹 深度验证清理了 ${studentsToRemove.length} 个不一致的练琴状态`);
        }
        
        // 处理最新的远程数据
        handleRemoteRealTimePracticeUpdate(remotePracticeData);
        handleRoomsUpdate(remoteRoomsData);
        
    }).catch((error) => {
        console.error('深度验证失败:', error);
        addSyncLog('❌ 深度验证失败: ' + error.message);
    });
}

// 更新连接状态显示
function updateConnectionStatus() {
    const statusEl = document.getElementById('connectionStatus');
    
    if (isOnline) {
        statusEl.className = 'connection-status online';
        statusEl.innerHTML = '<span data-i18n="status.online">' + t('status.online', '已连接') + '</span>';
    } else {
        statusEl.className = 'connection-status offline';
        statusEl.innerHTML = '<span data-i18n="status.offline">' + t('status.offline', '离线模式') + '</span>';
    }
}


// 添加同步日志
function addSyncLog(message) {
    const timestamp = new Date().toLocaleString();
    const logEntry = `[${timestamp}] ${message}`;
    syncLogs.unshift(logEntry);
    
    if (syncLogs.length > 100) {
        syncLogs = syncLogs.slice(0, 100);
    }
    
    updateSyncLogsDisplay();
}

// 更新同步日志显示
function updateSyncLogsDisplay() {
    const logsEl = document.getElementById('syncLogs');
    if (logsEl) {
        logsEl.innerHTML = syncLogs.join('\n');
        logsEl.scrollTop = 0;
    }
}

function loadInitialData() {
    if (!isOnline) return;
    
    addSyncLog('🔄 ' + t('sync.loading_data', '开始加载数据...'));
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = today;
    
    preloadRecentAttendanceData();
    forceRefreshAllData();
}

function forceRefreshAllData() {
    addSyncLog('🔄 ' + t('sync.force_refresh', '正在强制刷新所有数据...'));
    
    const refreshPromises = [];
    
    const selectedDate = document.getElementById('dateSelect').value;
    if (selectedDate) {
        const attendancePromise = database.ref(`attendanceData/${selectedDate}`).once('value')
            .then((snapshot) => {
                const data = snapshot.val() || {};
                attendanceData[selectedDate] = data;
                displayAttendanceSnapshot(data, selectedDate);
                addSyncLog(`✅ 已刷新 ${selectedDate} 的考勤数据`);
            })
            .catch((error) => {
                addSyncLog(`❌ 刷新考勤数据失败: ${error.message}`);
            });
        refreshPromises.push(attendancePromise);
    }
    
    const studentPromise = database.ref('studentDatabase').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                studentData = snapshot.val();
                updateFilters();
                addSyncLog('✅ ' + t('sync.student_refreshed', '已刷新学生数据'));
            }
        })
        .catch((error) => {
            addSyncLog(`❌ 刷新学生数据失败: ${error.message}`);
        });
    refreshPromises.push(studentPromise);
    
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRemoteRealTimePracticeUpdate(snapshot.val());
                addSyncLog('✅ ' + t('sync.practice_refreshed', '已刷新实时练琴状态'));
            }
        })
        .catch((error) => {
            addSyncLog(`❌ 刷新实时练琴状态失败: ${error.message}`);
        });
    refreshPromises.push(practicePromise);
    
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRoomsUpdate(snapshot.val());
                addSyncLog('✅ ' + t('sync.rooms_refreshed', '已刷新琴房状态'));
            }
        })
        .catch((error) => {
            addSyncLog(`❌ 刷新琴房状态失败: ${error.message}`);
        });
    refreshPromises.push(roomsPromise);
    
    const excusePromise = database.ref('excuseData').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                excuseData = snapshot.val();
                addSyncLog('✅ ' + t('sync.excuse_refreshed', '已刷新请假数据'));
            }
        })
        .catch((error) => {
            addSyncLog(`❌ 刷新请假数据失败: ${error.message}`);
        });
    refreshPromises.push(excusePromise);
    
    Promise.all(refreshPromises).then(() => {
        addSyncLog('🎉 ' + t('sync.all_refreshed', '所有数据刷新完成'));
        updateDashboard();
        if (currentTab === 'students') {
            updateStudentList();
        }
        if (currentTab === 'dashboard') {
            displayPracticeStatus();
        }
    }).catch((error) => {
        addSyncLog(`⚠️ 部分数据刷新失败: ${error.message}`);
    });
}

function updateStudentList() {
    if (currentTab === 'students') {
        const combinedData = combineStudentAndAttendanceData();
        displayStudentList(combinedData);
        addSyncLog('🔄 ' + t('sync.student_list_updated', '学生列表已更新'));
    }
}

// 加载考勤数据
function loadAttendanceData() {
    const selectedDate = document.getElementById('dateSelect').value;
    if (!selectedDate) return;
    
    showLoading('todaySnapshot');
    
    if (isOnline) {
        database.ref(`attendanceData/${selectedDate}`).once('value')
            .then((snapshot) => {
                const data = snapshot.val() || {};
                displayAttendanceSnapshot(data, selectedDate);
                addSyncLog(`📊 已加载 ${selectedDate} 的考勤数据`);
            })
            .catch((error) => {
                console.error('加载考勤数据失败:', error);
                addSyncLog('❌ ' + t('sync.load_failed', '加载考勤数据失败') + ': ' + error.message);
                showEmptyState('todaySnapshot', t('empty.load_failed', '加载失败'), t('empty.network_error', '无法加载考勤数据，请检查网络连接'));
            });
    } else {
        const localData = localStorage.getItem(`attendance_${selectedDate}`);
        if (localData) {
            displayAttendanceSnapshot(JSON.parse(localData), selectedDate);
        } else {
            showEmptyState('todaySnapshot', t('msg.no_data', '暂无数据'), t('empty.offline_no_data', '离线模式下没有找到该日期的考勤数据'));
        }
        
        displayPracticeStatus();
    }
}

// 🔥 保留：显示考勤快照时的本地存储功能
function displayAttendanceSnapshot(data, date) {
    const container = document.getElementById('todaySnapshot');
    
    if (!data || Object.keys(data).length === 0) {
        showEmptyState('todaySnapshot', t('msg.no_data', '暂无数据'), `${date} ` + t('empty.no_attendance', '还没有考勤记录'));
        return;
    }
    
    // 🔥 保留：保存考勤数据到本地存储
    try {
        localStorage.setItem(`attendance_${date}`, JSON.stringify(data));
    } catch (e) {
        console.warn('保存考勤数据到本地存储失败:', e);
    }
    
    // 其余显示逻辑保持不变...
    let html = '<div class="student-grid">';
    
    const groupedByMajor = {};
    Object.values(data).forEach(student => {
        const major = student.major || t('student.unknown_major', '其他');
        if (!groupedByMajor[major]) {
            groupedByMajor[major] = [];
        }
        groupedByMajor[major].push(student);
    });
    
    Object.keys(groupedByMajor).sort().forEach(major => {
        html += `<div style="grid-column: 1 / -1; margin: 20px 0 10px 0;">
                    <h4 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">
                        ${major} (${groupedByMajor[major].length}${t('report.people', '人')})
                    </h4>
                </div>`;
        
        groupedByMajor[major].forEach(student => {
            html += createStudentCard(student, true);
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    updateStatistics(data);
    displayPracticeStatus();
}


// 创建学生卡片
function createStudentCard(student, isSnapshot = false) {
    const statusClass = getStatusClass(student.finalAttendanceStatus);
    const statusText = getStatusText(student.finalAttendanceStatus);
    
    return `
        <div class="student-card ${statusClass}" onclick="showStudentDetail('${student.name}')">
            <div class="student-header">
                <div class="student-name">${student.name}</div>
                <div class="student-status ${statusClass}">${statusText}</div>
            </div>
            <div class="student-details">
                <div class="detail-item">
                    <div class="detail-label">${t('student.major', '专业')}</div>
                    <div class="detail-value">${student.major || t('student.not_set', '未设置')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.grade', '年级')}</div>
                    <div class="detail-value">${student.grade || t('student.not_set', '未设置')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.time_slot', '时间段')}</div>
                    <div class="detail-value">${student.start || t('student.no_schedule', '无')} - ${student.end || t('student.no_schedule', '无')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.practice_duration', '练琴时长')}</div>
                    <div class="detail-value">${student.practicedText || t('time.no_practice', '0分钟')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.room', '所在琴房')}</div>
                    <div class="detail-value">${student.room || t('student.not_in_room', '不在琴房')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('attendance.rate', '出勤率')}</div>
                    <div class="detail-value">${calculateAttendanceRate(student)}%</div>
                </div>
                ${student.excuseInfo ? `
                <div class="detail-item" style="grid-column: 1 / -1;">
                    <div class="detail-label">${t('excuse.reason', '请假信息')}</div>
                    <div class="detail-value" style="color: #f39c12;">
                        ${student.excuseInfo.reason || t('status.excused', '已请假')}
                        ${student.excuseInfo.approvedBy ? `<br><small>${t('excuse.approver', '批准人')}: ${student.excuseInfo.approvedBy}</small>` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// 🔥 新增：筛选实时练琴状态
function filterPracticeStatus() {
    const majorFilter = document.getElementById('practiceMajorFilter').value;
    const gradeFilter = document.getElementById('practiceGradeFilter').value;
    const searchText = document.getElementById('practiceStudentSearch').value.toLowerCase();
    
    const container = document.getElementById('practiceStudentList');
    if (!container) return;
    
    const practiceData = attendanceData.realTimePractice || {};
    const practiceStudents = Object.keys(practiceData);
    
    if (practiceStudents.length === 0) {
        displayEmptyPracticeState();
        return;
    }
    
    // 筛选学生
    const filteredStudents = practiceStudents.filter(studentName => {
        const studentInfo = getStudentInfoFromDatabase(studentName);
        
        // 专业筛选
        if (majorFilter && studentInfo.major !== majorFilter) return false;
        
        // 年级筛选
        if (gradeFilter && studentInfo.grade !== gradeFilter) return false;
        
        // 姓名搜索
        if (searchText && !studentName.toLowerCase().includes(searchText)) return false;
        
        return true;
    });
    
    if (filteredStudents.length === 0) {
        container.innerHTML = `
            <div class="practice-empty-state" style="grid-column: 1 / -1;">
                <div class="practice-empty-state-icon">🔍</div>
                <div class="practice-empty-state-title">${t('filter.no_results', '没有符合条件的学生')}</div>
                <div class="practice-empty-state-description">${t('filter.try_different', '请尝试调整筛选条件')}</div>
            </div>
        `;
        return;
    }
    
    displayFilteredPracticeStatus(filteredStudents);
}

// 🔥 新增：显示筛选后的练琴状态（包含开始时间）
function displayFilteredPracticeStatus(filteredStudents) {
    const container = document.getElementById('practiceStudentList');
    const practiceData = attendanceData.realTimePractice || {};
    
    let html = '';
    
    const sortedStudents = filteredStudents.sort((a, b) => {
        const durationA = practiceData[a].currentDuration || 0;
        const durationB = practiceData[b].currentDuration || 0;
        return durationB - durationA;
    });
    
    sortedStudents.forEach(studentName => {
        const practiceInfo = practiceData[studentName];
        const studentInfo = getStudentInfoFromDatabase(studentName);
        
        let currentDuration = practiceInfo.currentDuration || 0;
        if (practiceInfo.startTime) {
            const now = Date.now();
            const startTime = new Date(practiceInfo.startTime).getTime();
            currentDuration = Math.floor((now - startTime) / 1000);
            
            practiceData[studentName].currentDuration = currentDuration;
        }
        
        const duration = formatPracticeDuration(currentDuration);
        const startTime = practiceInfo.startTime ? 
            new Date(practiceInfo.startTime).toLocaleTimeString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', {
                hour: '2-digit',
                minute: '2-digit'
            }) : t('student.not_started', '未开始');
        
        html += `
            <div class="practice-status-card compact" onclick="showStudentDetail('${studentName}')">
                <div class="practice-indicator"></div>
                <div class="compact-content">
                    <div class="student-name-compact">${studentName}</div>
                    <div class="student-info-row">
                        <span class="info-item">${studentInfo.major || t('student.unknown_major', '未知专业')}</span>
                        <span class="info-divider">•</span>
                        <span class="info-item">${studentInfo.grade || t('student.not_set', '未设置')}</span>
                    </div>
                    <div class="student-info-row" style="margin-top: 4px;">
                        <span class="info-item">🕐 ${startTime}</span>
                        <span class="info-divider">•</span>
                        <span class="info-item">🏠 ${practiceInfo.room || t('student.not_in_room', '未知琴房')}</span>
                    </div>
                    <div class="practice-duration-large">${duration}</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// 🔥 新增：显示空的练琴状态
function displayEmptyPracticeState() {
    const container = document.getElementById('practiceStudentList');
    const emptyDesc = isWeekend() ? 
        t('practice.empty.desc.weekend', '周末时间，学生可自主安排练琴') : 
        t('practice.empty.desc.weekday', '工作日时间，等待学生开始练琴');
        
    container.innerHTML = `
        <div class="practice-empty-state" style="grid-column: 1 / -1;">
            <div class="practice-empty-state-icon">🎵</div>
            <div class="practice-empty-state-title">${t('practice.empty.title', '当前没有学生在练琴')}</div>
            <div class="practice-empty-state-description">${emptyDesc}</div>
        </div>
    `;
}

// 🔥 新增：更新练琴筛选器选项
function updatePracticeFilterOptions() {
    const practiceData = attendanceData.realTimePractice || {};
    const practiceStudents = Object.keys(practiceData);
    
    if (practiceStudents.length === 0) {
        return;
    }
    
    // 更新专业筛选
    const majorFilter = document.getElementById('practiceMajorFilter');
    const gradeFilter = document.getElementById('practiceGradeFilter');
    
    if (!majorFilter || !gradeFilter) return;
    
    const currentMajor = majorFilter.value;
    const currentGrade = gradeFilter.value;
    
    // 收集正在练琴学生的专业和年级
    const majors = new Set();
    const grades = new Set();
    
    practiceStudents.forEach(studentName => {
        const studentInfo = getStudentInfoFromDatabase(studentName);
        if (studentInfo.major) majors.add(studentInfo.major);
        if (studentInfo.grade) grades.add(studentInfo.grade);
    });
    
    // 更新专业选项
    majorFilter.innerHTML = `<option value="">${t('filter.all_majors', '所有专业')}</option>`;
    Array.from(majors).sort().forEach(major => {
        const option = document.createElement('option');
        option.value = major;
        option.textContent = major;
        if (major === currentMajor) option.selected = true;
        majorFilter.appendChild(option);
    });
    
    // 更新年级选项
    gradeFilter.innerHTML = `<option value="">${t('filter.all_grades', '所有年级')}</option>`;
    Array.from(grades).sort().forEach(grade => {
        const option = document.createElement('option');
        option.value = grade;
        option.textContent = grade;
        if (grade === currentGrade) option.selected = true;
        gradeFilter.appendChild(option);
    });
    
    // 生成快速筛选标签
    generatePracticeQuickFilters(majors, grades);
}

// 🔥 新增：生成快速筛选标签
function generatePracticeQuickFilters(majors, grades) {
    const container = document.getElementById('practiceQuickFilters');
    if (!container) return;
    
    let html = '';
    
    // 专业快速筛选
    Array.from(majors).sort().forEach(major => {
        html += `<div class="quick-filter-tag" onclick="setQuickFilter('major', '${major}')">${major}</div>`;
    });
    
    // 年级快速筛选
    Array.from(grades).sort().forEach(grade => {
        html += `<div class="quick-filter-tag" onclick="setQuickFilter('grade', '${grade}')">${grade}</div>`;
    });
    
    // 清除筛选
    if (majors.size > 0 || grades.size > 0) {
        html += `<div class="quick-filter-tag" onclick="clearPracticeFilters()" style="background: #f8d7da; color: #721c24; border-color: #f5c6cb;">✕ ${t('filter.clear', '清除')}</div>`;
    }
    
    container.innerHTML = html;
}

// 🔥 新增：设置快速筛选
function setQuickFilter(type, value) {
    if (type === 'major') {
        document.getElementById('practiceMajorFilter').value = value;
        document.getElementById('practiceGradeFilter').value = '';
    } else if (type === 'grade') {
        document.getElementById('practiceGradeFilter').value = value;
        document.getElementById('practiceMajorFilter').value = '';
    }
    
    document.getElementById('practiceStudentSearch').value = '';
    
    // 更新标签状态
    document.querySelectorAll('.quick-filter-tag').forEach(tag => {
        tag.classList.remove('active');
        if (tag.textContent.trim() === value) {
            tag.classList.add('active');
        }
    });
    
    filterPracticeStatus();
}

// 🔥 新增：清除练琴筛选
function clearPracticeFilters() {
    document.getElementById('practiceMajorFilter').value = '';
    document.getElementById('practiceGradeFilter').value = '';
    document.getElementById('practiceStudentSearch').value = '';
    
    document.querySelectorAll('.quick-filter-tag').forEach(tag => {
        tag.classList.remove('active');
    });
    
    displayPracticeStatus();
}
// 🔥 新增：获取学生练琴开始时间
function getStudentStartTime(studentName) {
    const practiceData = attendanceData.realTimePractice || {};
    const practiceInfo = practiceData[studentName];
    
    if (!practiceInfo || !practiceInfo.startTime) {
        return null;
    }
    
    return new Date(practiceInfo.startTime).toLocaleTimeString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

// 创建考勤历史时间轴（用于详情页面）
function createAttendanceHistoryTimeline(student) {
    const history = student.attendanceHistory || [];
    const last7Days = getLast7Days();
    
    let historyHtml = '';
    
    // 对于时间轴显示，我们反转顺序，让最远的日期在左边，最近的在右边
    const reversedDays = [...last7Days].reverse();
    
    reversedDays.forEach(date => {
        const dayData = history.find(h => h.date === date);
        const status = dayData ? dayData.status : 'no-data';
        const day = new Date(date).getDate();
        
        const dayName = new Date(date).toLocaleDateString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', { weekday: 'short' });
        const statusText = getStatusText(status);
        const tooltipText = `${date} (${dayName}) - ${statusText}`;
        
        historyHtml += `<div class="history-day ${getStatusClass(status)}" 
                            title="${tooltipText}" 
                            data-date="${date}" 
                            data-status="${status}">${day}</div>`;
    });
    
    return historyHtml;
}

// 保留原函数用于向后兼容（但不再使用）
function createAttendanceHistory(student) {
    // 这个函数现在为空，因为考勤历史已移到详情页
    return '';
}



// 获取最近7天日期
function getLast7Days() {
    const dates = [];
    for (let i = 0; i < 7; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toISOString().split('T')[0]);
    }
    return dates;
}


// 获取状态样式类
function getStatusClass(status) {
    const statusMap = {
        'present': 'present',
        'absent': 'absent', 
        'excused': 'excused',
        'low_efficiency': 'low-efficiency',
        'low-efficiency': 'low-efficiency',
        'under_review': 'low-efficiency',
        'practicing_unscheduled': 'practicing-unscheduled',
        'weekend': 'weekend',
        'pending': 'pending',          // 🔥 新增：待考勤状态
        'no-data': 'no-data'
    };
    return statusMap[status] || 'pending';  // 🔥 修改：默认返回待考勤
}


// 获取状态文本
function getStatusText(status) {
    const statusMap = {
        'present': t('status.present', '出勤'),
        'absent': t('status.absent', '缺勤'),
        'excused': t('status.excused', '请假'),
        'low_efficiency': t('status.low_efficiency', '低效出勤'),
        'under_review': t('status.low_efficiency', '待观察'),
        'no-data': t('status.no_data', '无数据'),
        'practicing_unscheduled': t('status.practicing_unscheduled', '时间段外练琴'),
        'weekend': t('status.weekend', '周末'),
        'pending': t('status.pending', '待考勤')    // 🔥 新增：待考勤文本
    };
    return statusMap[status] || t('status.pending', '待考勤');  // 🔥 修改：默认返回待考勤
}


// 计算出勤率
function calculateAttendanceRate(student) {
    if (!student.attendanceHistory || student.attendanceHistory.length === 0) {
        return 0;
    }
    
    const totalDays = student.attendanceHistory.length;
    const presentDays = student.attendanceHistory.filter(h => 
        h.status === 'present' || h.status === 'low_efficiency'
    ).length;
    
    return Math.round((presentDays / totalDays) * 100);
}

// 更新仪表板
function updateDashboard() {
    const selectedDate = document.getElementById('dateSelect').value;
    if (selectedDate) {
        loadAttendanceData();
    }
    updateExcuseInfoDisplay();
}

function updateExcuseInfoDisplay() {
    const today = new Date().toISOString().split('T')[0];
    const excusePanel = document.getElementById('excuseInfoPanel');
    const excuseContainer = document.getElementById('excuseInfoContainer');
    
    // 🔥 修复：正确访问请假数据结构
    const todayExcuses = excuseData[today] || {};
    const excuseList = Object.keys(todayExcuses);
    
    if (excuseList.length === 0) {
        excusePanel.style.display = 'none';
        return;
    }
    
    excusePanel.style.display = 'block';
    
    let html = '<div class="student-grid">';
    
    excuseList.forEach(studentName => {
        const excuse = todayExcuses[studentName];
        
        // 🔥 修复：确保 excuse 对象存在且有效
        if (!excuse || typeof excuse !== 'object') {
            console.warn(`请假数据格式错误: ${studentName}`, excuse);
            return;
        }
        
        // 🔥 修复：根据实际数据结构显示信息
        const statusClass = 'success'; // 简化状态显示，因为实际数据中可能没有 status 字段
        const statusText = t('excuse.status.approved', '已批准');
        
        html += `
            <div class="student-card ${statusClass}">
                <div class="student-header">
                    <div class="student-name">${studentName}</div>
                    <div class="student-status ${statusClass}">${statusText}</div>
                </div>
                <div class="student-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.reason', '请假原因')}</div>
                        <div class="detail-value">${excuse.reason || t('excuse.not_filled', '未填写')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.time', '请假时长')}</div>
                        <div class="detail-value">${excuse.durationText || t('excuse.not_filled', '未填写')}</div>
                    </div>
                    ${excuse.endDate ? `
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.end_date', '结束日期')}</div>
                        <div class="detail-value">${excuse.endDate}</div>
                    </div>
                    ` : ''}
                    ${excuse.timestamp ? `
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.submit_time', '提交时间')}</div>
                        <div class="detail-value">${new Date(excuse.timestamp).toLocaleString()}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    excuseContainer.innerHTML = html;
}


// 更新统计数据
function updateStatistics(data) {
    const students = Object.values(data);
    const total = students.length;
    const present = students.filter(s => s.finalAttendanceStatus === 'present').length;
    const pending = students.filter(s => s.finalAttendanceStatus === 'pending').length;  // 🔥 新增：待考勤统计
    const absent = students.filter(s => s.finalAttendanceStatus === 'absent').length;
    const excused = students.filter(s => s.finalAttendanceStatus === 'excused').length;
    const unscheduled = students.filter(s => s.finalAttendanceStatus === 'practicing_unscheduled').length;
    const weekend = students.filter(s => s.finalAttendanceStatus === 'weekend').length;
    
    if (isWeekend()) {
        updateWeekendStats(total, unscheduled, weekend - unscheduled);
    } else {
        updateWeekdayStats(total, present, pending, absent, excused, unscheduled);  // 🔥 修改：传入待考勤数量
    }
}


function updateWeekendStats(total, practicing, resting) {
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('presentCount').textContent = practicing;
    document.getElementById('absentCount').textContent = resting;
    document.getElementById('excusedCount').textContent = 0;
    
    // 更新标签文字
    document.querySelector('#presentCount').parentElement.querySelector('.stat-label').textContent = t('stats.practicing', '正在练琴');
    document.querySelector('#absentCount').parentElement.querySelector('.stat-label').textContent = t('stats.not_practicing', '未在练琴');
    document.querySelector('#excusedCount').parentElement.querySelector('.stat-label').textContent = t('status.weekend', '周末');
}

function updateWeekdayStats(total, present, pending, absent, excused, unscheduled) { 
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = pending;     
    document.getElementById('excusedCount').textContent = excused;
    
    // 🔥 修改：更新标签文字为待考勤
    document.querySelector('#presentCount').parentElement.querySelector('.stat-label').textContent = t('stats.present', '出勤');
    document.querySelector('#absentCount').parentElement.querySelector('.stat-label').textContent = t('stats.pending', '待考勤');  // 🔥 修改
    document.querySelector('#excusedCount').parentElement.querySelector('.stat-label').textContent = t('stats.excused', '请假');
}

// 刷新练琴状态
function refreshPracticeStatus() {
    updateCurrentTime();
    
    if (isOnline) {
        addSyncLog('🔄 ' + t('sync.refreshing_practice', '正在刷新实时练琴状态...'));
        
        // 🔥 修改：先清理过期数据，再强制验证
        validateAndCleanExpiredData();
        triggerRealTimePracticeStatusUpdate();
        
        // 🔥 新增：延迟再次验证，确保数据同步
        setTimeout(() => {
            forceValidateRealTimePractice();
        }, 2000);
    } else {
        updatePracticeDurations();
        displayPracticeStatus();
    }
    
    addSyncLog('🎵 ' + t('sync.practice_refreshed', '已刷新实时练琴状态'));
}


// 更新当前时间显示
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const currentTimeEl = document.getElementById('currentTime');
    if (currentTimeEl) {
        currentTimeEl.textContent = timeString;
    }
}

// 显示实时练琴状态
function displayPracticeStatus() {
    const container = document.getElementById('practiceStudentList');
    if (!container) return;
    
    const practiceData = attendanceData.realTimePractice || {};
    const practiceStudents = Object.keys(practiceData);
    
    if (practiceStudents.length === 0) {
        displayEmptyPracticeState();
        // 清空筛选器
        const majorFilter = document.getElementById('practiceMajorFilter');
        const gradeFilter = document.getElementById('practiceGradeFilter');
        const quickFilters = document.getElementById('practiceQuickFilters');
        
        if (majorFilter) majorFilter.innerHTML = `<option value="">${t('filter.all_majors', '所有专业')}</option>`;
        if (gradeFilter) gradeFilter.innerHTML = `<option value="">${t('filter.all_grades', '所有年级')}</option>`;
        if (quickFilters) quickFilters.innerHTML = '';
        
        return;
    }
    
    // 更新筛选器选项
    updatePracticeFilterOptions();
    
    // 应用当前筛选条件
    filterPracticeStatus();
}


// 初始化实时练琴状态显示
function initPracticeStatusDisplay() {
    updateCurrentTime();
    displayPracticeStatus();
    
    // 🔥 修改：更频繁的数据刷新和验证
    setInterval(() => {
        updateCurrentTime();
        if (currentTab === 'dashboard') {
            if (isOnline) {
                // 每10秒检查一次状态变化并同步
                periodicRealTimePracticeStatusCheck();
                cleanupEndedPracticeStatus();
            } else {
                updatePracticeDurations();
                displayPracticeStatus();
            }
        }
    }, 10000);
    
    // 🔥 新增：每30秒进行一次强制验证
    setInterval(() => {
        if (isOnline && currentTab === 'dashboard') {
            validateAndCleanExpiredData();
            triggerRealTimePracticeStatusUpdate();
        }
    }, 30000);
    
    setInterval(updateCurrentTime, 1000);
    
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && currentTab === 'dashboard') {
            debugLog('页面变为可见，开始强制同步');
            setTimeout(() => {
                validateAndCleanExpiredData();
                
                if (isOnline) {
                    triggerRealTimePracticeStatusUpdate();
                } else {
                    displayPracticeStatus();
                }
            }, 1000);
        }
    });
}

// 专门刷新实时练琴数据的函数
function refreshRealTimePracticeData() {
    if (!isOnline || !database) return;
    
    const refreshPromises = [];
    
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRemoteRealTimePracticeUpdate(snapshot.val());
            }
        })
        .catch((error) => {
            console.log('刷新实时练琴状态失败:', error.message);
        });
    refreshPromises.push(practicePromise);
    
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRoomsUpdate(snapshot.val());
            }
        })
        .catch((error) => {
            console.log('刷新琴房状态失败:', error.message);
        });
    refreshPromises.push(roomsPromise);
    
    Promise.all(refreshPromises).then(() => {
        displayPracticeStatus();
        updatePracticeDurations();
    });
}
function calculateDailyTotalDuration(studentName) {
    let totalDuration = 0;
    
    // 1. 从考勤记录中获取已完成的练琴时长
    const todayDate = new Date().toISOString().split('T')[0];
    const todayAttendance = attendanceData[todayDate];
    
    if (todayAttendance && todayAttendance[studentName]) {
        const studentRecord = todayAttendance[studentName];
        
        // 🔥 修复：按照实际数据结构优先级获取练琴时长
        if (typeof studentRecord.practicedSec === 'number' && studentRecord.practicedSec > 0) {
            // 优先使用 practicedSec 字段
            totalDuration = studentRecord.practicedSec;
        } else if (typeof studentRecord.effectiveTotalSec === 'number' && studentRecord.effectiveTotalSec > 0) {
            // 其次使用 effectiveTotalSec 字段
            totalDuration = studentRecord.effectiveTotalSec;
        }
    }
    
    // 2. 加上当前正在进行的练琴时长
    if (attendanceData.realTimePractice && attendanceData.realTimePractice[studentName]) {
        const practiceInfo = attendanceData.realTimePractice[studentName];
        if (practiceInfo && practiceInfo.startTime) {
            const now = Date.now();
            const startTime = new Date(practiceInfo.startTime).getTime();
            
            // 验证时间有效性
            if (!isNaN(startTime) && startTime <= now && (now - startTime) < 12 * 60 * 60 * 1000) {
                const currentDuration = Math.floor((now - startTime) / 1000);
                totalDuration += currentDuration;
            }
        }
    }
    
    return totalDuration;
}

// 🔥 新增：格式化当日累计练琴时长显示
function formatDailyTotalDuration(studentName) {
    const totalSeconds = calculateDailyTotalDuration(studentName);
    return formatPracticeDuration(totalSeconds);
}

// 更新练琴时长显示
function updatePracticeDurations() {
    if (!attendanceData.realTimePractice) return;
    
    const now = Date.now();
    let hasUpdates = false;
    
    Object.keys(attendanceData.realTimePractice).forEach(studentName => {
        const practiceInfo = attendanceData.realTimePractice[studentName];
        if (practiceInfo.startTime) {
            const startTime = new Date(practiceInfo.startTime).getTime();
            const newDuration = Math.floor((now - startTime) / 1000);
            
            if (newDuration !== practiceInfo.currentDuration) {
                attendanceData.realTimePractice[studentName].currentDuration = newDuration;
                hasUpdates = true;
            }
        }
    });
    
    if (hasUpdates) {
        displayPracticeStatus();
        // 🔥 移除：不再保存到本地存储
        
        // 有更新时触发同步检查
        if (isOnline) {
            checkAndUpdateRealTimePracticeStatus(false);
        }
    }
}



// 判断是否为周末
function isWeekend() {
    const day = new Date().getDay();
    return day === 0 || day === 6;
}

// 从学生数据库获取学生信息
function getStudentInfoFromDatabase(studentName) {
    // 🔥 修复：正确处理 studentData 的数据结构
    for (const [major, students] of Object.entries(studentData)) {
        if (Array.isArray(students)) {
            const found = students.find(student => {
                // 🔥 修复：兼容新旧格式的学生数据
                if (typeof student === 'string') {
                    return student === studentName;
                } else if (typeof student === 'object' && student !== null) {
                    return student.name === studentName;
                }
                return false;
            });
            
            if (found) {
                return {
                    major: major,
                    grade: typeof found === 'object' && found.grade ? found.grade : ''
                };
            }
        }
    }
    return { 
        major: t('student.unknown_major', '未知专业'), 
        grade: '' 
    };
}


// 格式化练琴时长
function formatPracticeDuration(seconds) {
    if (!seconds || seconds <= 0) return t('time.no_practice', '0分钟');
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}${t('time.hours', '小时')}${minutes > 0 ? minutes + t('time.minutes', '分钟') : ''}`;
    } else if (minutes > 0) {
        return `${minutes}${t('time.minutes', '分钟')}${secs > 0 ? secs + t('time.seconds', '秒') : ''}`;
    } else {
        return `${secs}${t('time.seconds', '秒')}`;
    }
}

// 获取学生考勤历史
function getStudentAttendanceHistory(studentName) {
    const history = [];
    const last7Days = getLast7Days();
    
    last7Days.forEach(date => {
        const dayData = attendanceData[date];
        if (dayData && dayData[studentName]) {
            history.push({
                date: date,
                status: dayData[studentName].finalAttendanceStatus || 'no-data'
            });
        } else {
            history.push({
                date: date,
                status: 'no-data'
            });
        }
    });
    
    return history;
}

// 🔥 增强的过期数据清理函数
function validateAndCleanExpiredData() {
    if (!attendanceData.realTimePractice) return;
    
    const now = Date.now();
    const maxAge = 15 * 60 * 1000; // 🔥 进一步缩短到15分钟
    let cleaned = 0;
    
    Object.keys(attendanceData.realTimePractice).forEach(studentName => {
        const practiceInfo = attendanceData.realTimePractice[studentName];
        
        // 检查是否缺少必要字段
        if (!practiceInfo || !practiceInfo.lastUpdated || !practiceInfo.startTime) {
            debugLog(`清理缺少必要字段的记录: ${studentName}`);
            delete attendanceData.realTimePractice[studentName];
            cleaned++;
            return;
        }
        
        const lastUpdated = new Date(practiceInfo.lastUpdated).getTime();
        const startTime = new Date(practiceInfo.startTime).getTime();
        const age = now - lastUpdated;
        const practiceAge = now - startTime;
        
        // 🔥 更严格的过期检测
        if (isNaN(lastUpdated) || isNaN(startTime) || 
            age > maxAge || 
            practiceAge > 8 * 60 * 60 * 1000 || // 🔥 练琴超过8小时视为异常
            startTime > now) { // 开始时间在未来
            
            debugLog(`清理过期/异常记录: ${studentName} (更新${Math.round(age/60000)}分钟前, 练琴${Math.round(practiceAge/60000)}分钟)`);
            delete attendanceData.realTimePractice[studentName];
            cleaned++;
        }
    });
    
    if (cleaned > 0) {
        localStorage.setItem('realTimePracticeStatus', JSON.stringify(attendanceData.realTimePractice));
        displayPracticeStatus();
        addSyncLog(`🧹 已清理 ${cleaned} 个过期/异常的练琴记录`);
    }
}


// 切换标签页
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.getElementById(tabName + 'Tab').style.display = 'block';
    
    event.target.classList.add('active');
    
    currentTab = tabName;
    
    switch(tabName) {
        case 'dashboard':
            if (isOnline) {
                forceRefreshAllData();
            } else {
                loadAttendanceData();
                displayPracticeStatus();
            }
            break;
        case 'students':
            if (isOnline) {
                database.ref('studentDatabase').once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            studentData = snapshot.val();
                            updateFilters();
                        }
                        loadStudentList();
                        addSyncLog('✅ ' + t('sync.student_page_refreshed', '学生页面数据已刷新'));
                    })
                    .catch((error) => {
                        loadStudentList();
                        addSyncLog(`⚠️ 学生数据刷新失败: ${error.message}`);
                    });
            } else {
                loadStudentList();
            }
            break;
        case 'reports':
            initReportsTab();
            break;
        case 'sync':
            updateSyncStatus();
            break;
    }
}

// 加载学生列表
function loadStudentList() {
    if (!isOnline) {
        showEmptyState('studentList', t('sync.offline', '离线模式'), t('msg.network_required', '需要连接到网络才能查看学生详情'));
        return;
    }
    
    showLoading('studentList');
    
    const combinedData = combineStudentAndAttendanceData();
    
    console.log('合并后的学生数据数量:', Object.keys(combinedData).length);
    console.log('学生列表:', Object.keys(combinedData));
    
    displayStudentList(combinedData);
    updateStatusFilterOptions();
    
    addSyncLog(`📋 已加载 ${Object.keys(combinedData).length} 名学生的信息`);
}

// 合并学生和考勤数据
function combineStudentAndAttendanceData() {
    const combined = {};
    const today = new Date().toISOString().split('T')[0];
    
    // 🔥 修复：确保数据结构正确访问
    const todayAttendance = attendanceData[today] || {};
    const todayExcuses = excuseData[today] || {};
    
    // 处理学生数据库中的学生
    Object.keys(studentData).forEach(major => {
        const students = studentData[major];
        if (Array.isArray(students)) {
            students.forEach(student => {
                // 🔥 修复：兼容新旧格式
                const studentName = typeof student === 'string' ? student : student?.name;
                const studentGrade = typeof student === 'object' ? student?.grade || '' : '';
                
                if (!studentName) return;
                
                // 🔥 修复：正确访问请假信息
                const excuseInfo = todayExcuses[studentName] || null;
                let defaultStatus = isWeekend() ? 'weekend' : 'pending';
                let defaultStatusText = isWeekend() ? t('status.weekend', '周末') : t('status.pending', '待考勤');
                
                if (excuseInfo && excuseInfo.status === 'approved') {
                    defaultStatus = 'excused';
                    defaultStatusText = t('status.excused', '请假');
                }
                
                combined[studentName] = {
                    name: studentName,
                    major: major,
                    grade: studentGrade,
                    finalAttendanceStatus: defaultStatus,
                    finalStatusText: defaultStatusText,
                    practicedText: t('time.no_practice', '0分钟'),
                    room: t('student.not_in_room', '不在琴房'),
                    start: '',
                    end: '',
                    attendanceHistory: getStudentAttendanceHistory(studentName),
                    excuseInfo: excuseInfo
                };
            });
        }
    });
    
    // 合并今日考勤记录
    Object.keys(todayAttendance).forEach(studentName => {
        const attendanceRecord = todayAttendance[studentName];
        
        if (combined[studentName]) {
            combined[studentName] = {
                ...combined[studentName],
                ...attendanceRecord,
                attendanceHistory: getStudentAttendanceHistory(studentName)
            };
        } else {
            const studentInfo = getStudentInfoFromDatabase(studentName);
            combined[studentName] = {
                name: studentName,
                major: studentInfo.major,
                grade: studentInfo.grade,
                ...attendanceRecord,
                attendanceHistory: getStudentAttendanceHistory(studentName),
                excuseInfo: todayExcuses[studentName] || null
            };
        }
    });
    
    // 🔥 修复：正确处理实时练琴数据
    if (attendanceData.realTimePractice && typeof attendanceData.realTimePractice === 'object') {
        Object.keys(attendanceData.realTimePractice).forEach(studentName => {
            const practiceStatus = attendanceData.realTimePractice[studentName];
            
            if (!practiceStatus || typeof practiceStatus !== 'object') {
                console.warn(`实时练琴数据格式错误: ${studentName}`, practiceStatus);
                return;
            }
            
            if (!combined[studentName]) {
                const studentInfo = getStudentInfoFromDatabase(studentName);
                
                combined[studentName] = {
                    name: studentName,
                    major: studentInfo.major,
                    grade: studentInfo.grade,
                    finalAttendanceStatus: 'practicing_unscheduled',
                    finalStatusText: isWeekend() ? t('practice.type.weekend', '周末自主练琴') : t('practice.type.unscheduled', '时间段外练琴'),
                    practicedText: formatPracticeDuration(practiceStatus.currentDuration || 0),
                    room: practiceStatus.room || t('student.not_in_room', '不在琴房'),
                    start: '',
                    end: '',
                    attendanceHistory: getStudentAttendanceHistory(studentName),
                    excuseInfo: todayExcuses[studentName] || null
                };
            } else {
                combined[studentName].finalAttendanceStatus = 'practicing_unscheduled';
                combined[studentName].finalStatusText = isWeekend() ? 
                    t('practice.type.weekend', '周末自主练琴') : 
                    t('practice.type.unscheduled', '时间段外练琴');
                combined[studentName].practicedText = formatPracticeDuration(practiceStatus.currentDuration || 0);
                combined[studentName].room = practiceStatus.room || combined[studentName].room;
            }
        });
    }
    
    return combined;
}


// 🔥 修改：显示学生列表 - 使用与实时练琴一致的紧凑卡片样式
function displayStudentList(students) {
    const container = document.getElementById('studentList');
    
    if (!students || Object.keys(students).length === 0) {
        showEmptyState('studentList', t('empty.no_students', '暂无学生数据'), t('empty.ensure_sync', '请确保学生数据已正确同步'));
        return;
    }
    
    const filteredStudents = filterStudentsByCurrentFilters(students);
    
    if (filteredStudents.length === 0) {
        showEmptyState('studentList', t('filter.no_results', '没有符合条件的学生'), t('filter.try_different', '请尝试调整筛选条件'));
        return;
    }
    
    let html = '<div class="student-grid">';
    
    const groupedByMajor = {};
    filteredStudents.forEach(student => {
        const major = student.major || t('student.unknown_major', '其他');
        if (!groupedByMajor[major]) {
            groupedByMajor[major] = [];
        }
        groupedByMajor[major].push(student);
    });
    
    Object.keys(groupedByMajor).sort().forEach(major => {
        html += `<div style="grid-column: 1 / -1; margin: 20px 0 10px 0;">
                    <h4 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">
                        ${major} (${groupedByMajor[major].length}${t('report.people', '人')})
                    </h4>
                </div>`;
        
        // 🔥 修改：使用紧凑卡片样式而不是传统的详细卡片
        groupedByMajor[major].forEach(student => {
            html += createCompactStudentCard(student);
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// 🔥 新增：创建紧凑学生卡片（与实时练琴样式一致）
function createCompactStudentCard(student) {
    const statusClass = getStatusClass(student.finalAttendanceStatus);
    const statusText = student.finalStatusText || getStatusText(student.finalAttendanceStatus);
    
    // 检查是否正在练琴
    const isCurrentlyPracticing = attendanceData.realTimePractice && 
                                 attendanceData.realTimePractice[student.name];
    
    // 获取开始时间
    const startTime = getStudentStartTime(student.name) || t('student.not_started', '未开始');
    
    // 获取当日累计练琴时长
    const dailyDuration = formatDailyTotalDuration(student.name);
    
    return `
        <div class="practice-status-card compact ${statusClass}" onclick="showStudentDetail('${student.name}')">
            ${isCurrentlyPracticing ? '<div class="practice-indicator"></div>' : ''}
            <div class="compact-content">
                <div class="student-name-compact">${student.name}</div>
                <div class="student-info-row">
                    <span class="info-item">${student.major || t('student.unknown_major', '未知专业')}</span>
                    <span class="info-divider">•</span>
                    <span class="info-item">${student.grade || t('student.not_set', '未设置')}</span>
                </div>
                <div class="student-info-row" style="margin-top: 4px;">
                    <span class="info-item">🕐 ${startTime}</span>
                    <span class="info-divider">•</span>
                    <span class="info-item">🏠 ${student.room || t('student.not_in_room', '不在琴房')}</span>
                </div>
                <div class="status-duration-row" style="margin-top: 8px;">
                    <div class="student-status-compact ${statusClass}">
                        ${statusText}
                    </div>
                    <div class="practice-duration-large">
                        ${dailyDuration}
                    </div>
                </div>
            </div>
        </div>
    `;
}



// 根据当前筛选条件过滤学生
function filterStudentsByCurrentFilters(students) {
    const majorFilter = document.getElementById('majorFilter').value;
    const gradeFilter = document.getElementById('gradeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const searchText = document.getElementById('studentSearch').value.toLowerCase();
    
    return Object.values(students).filter(student => {
        if (majorFilter && student.major !== majorFilter) return false;
        if (gradeFilter && student.grade !== gradeFilter) return false;
        if (statusFilter && student.finalAttendanceStatus !== statusFilter) return false;
        if (searchText && !student.name.toLowerCase().includes(searchText)) return false;
        return true;
    });
}

// 筛选学生
function filterStudents() {
    if (currentTab === 'students') {
        const combinedData = combineStudentAndAttendanceData();
        displayStudentList(combinedData);
    }
}

// 更新筛选器选项
function updateFilters() {
    updateMajorFilterOptions();
    updateGradeFilterOptions();
    updateStatusFilterOptions();
}

// 更新专业筛选选项
function updateMajorFilterOptions() {
    const majorFilter = document.getElementById('majorFilter');
    const currentValue = majorFilter.value;
    
    majorFilter.innerHTML = `<option value="">${t('filter.all_majors', '所有专业')}</option>`;
    
    const majors = Object.keys(studentData).sort();
    majors.forEach(major => {
        const option = document.createElement('option');
        option.value = major;
        option.textContent = major;
        if (major === currentValue) {
            option.selected = true;
        }
        majorFilter.appendChild(option);
    });
}

// 更新年级筛选选项
function updateGradeFilterOptions() {
    const gradeFilter = document.getElementById('gradeFilter');
    const currentValue = gradeFilter.value;
    
    gradeFilter.innerHTML = `<option value="">${t('filter.all_grades', '所有年级')}</option>`;
    
    const grades = new Set();
    Object.values(studentData).forEach(students => {
        if (Array.isArray(students)) {
            students.forEach(student => {
                if (typeof student === 'object' && student.grade) {
                    grades.add(student.grade);
                }
            });
        }
    });
    
    Array.from(grades).sort().forEach(grade => {
        const option = document.createElement('option');
        option.value = grade;
        option.textContent = grade;
        if (grade === currentValue) {
            option.selected = true;
        }
        gradeFilter.appendChild(option);
    });
}

// 状态筛选选项
function updateStatusFilterOptions() {
    const statusFilter = document.getElementById('statusFilter');
    const currentValue = statusFilter.value;
    
    statusFilter.innerHTML = `
        <option value="">${t('filter.all_status', '所有状态')}</option>
        <option value="present">${t('status.present', '出勤')}</option>
        <option value="pending">${t('status.pending', '待考勤')}</option>
        <option value="absent">${t('status.absent', '缺勤')}</option>
        <option value="excused">${t('status.excused', '请假')}</option>
        <option value="low-efficiency">${t('status.low_efficiency', '低效出勤')}</option>
        <option value="practicing_unscheduled">${t('status.practicing_unscheduled', '时间段外练琴')}</option>
        <option value="weekend">${t('status.weekend', '周末')}</option>
    `;
    
    if (currentValue) {
        statusFilter.value = currentValue;
    }
}

// 显示学生详情
function showStudentDetail(studentName) {
    if (!isOnline) {
        alert(t('msg.network_required', '需要网络连接才能查看学生详情'));
        return;
    }
    
    const modal = document.getElementById('studentDetailModal');
    const title = document.getElementById('studentDetailTitle');
    const content = document.getElementById('studentDetailContent');
    
    title.textContent = `${studentName} - ${t('student.detail.title', '学生详情')}`;
    
    content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    modal.classList.add('show');
    
    loadStudentDetailData(studentName).then(studentData => {
        content.innerHTML = createStudentDetailContent(studentData);
    }).catch(error => {
        content.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">❌</div>
                <div class="empty-state-title">${t('msg.student_not_found', '未找到学生信息')}</div>
                <div class="empty-state-description">${error.message}</div>
            </div>
        `;
    });
}

// 加载学生详细数据
function loadStudentDetailData(studentName) {
    return new Promise((resolve, reject) => {
        const combinedData = combineStudentAndAttendanceData();
        const student = combinedData[studentName];
        
        if (!student) {
            reject(new Error(t('msg.student_not_found', '未找到学生信息')));
            return;
        }
        
        // 加载更多历史数据
        const promises = [];
        const last30Days = getLast30Days();
        
        last30Days.forEach(date => {
            if (isOnline && !attendanceData[date]) {
                const promise = database.ref(`attendanceData/${date}/${studentName}`).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            if (!attendanceData[date]) {
                                attendanceData[date] = {};
                            }
                            attendanceData[date][studentName] = snapshot.val();
                        }
                    })
                    .catch(error => {
                        console.warn(`加载 ${date} 的数据失败:`, error);
                    });
                promises.push(promise);
            }
        });
        
        Promise.all(promises).then(() => {
            student.extendedHistory = getExtendedAttendanceHistory(studentName);
            resolve(student);
        });
    });
}

// 获取最近30天日期
function getLast30Days() {
    const dates = [];
    for (let i = 0; i < 30; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toISOString().split('T')[0]);
    }
    return dates;
}

function getExtendedAttendanceHistory(studentName) {
    const history = [];
    const last30Days = getLast30Days();
    
    last30Days.forEach(date => {
        const dayData = attendanceData[date];
        if (dayData && dayData[studentName]) {
            const studentRecord = dayData[studentName];
            
            // 🔥 新增：获取练琴记录
            const todayRecord = getStudentPracticeRecord(studentName, date);
            
            // 🔥 修复：根据实际数据结构获取练琴时长
            let totalDuration = '0分钟';
            let inSlotDuration = '0分钟';
            let outSlotDuration = '0分钟';
            
            if (todayRecord && (todayRecord.inSlot > 0 || todayRecord.outSlot > 0)) {
                // 优先使用练琴记录系统的数据
                inSlotDuration = formatPracticeTime(todayRecord.inSlot);
                outSlotDuration = formatPracticeTime(todayRecord.outSlot);
                totalDuration = formatPracticeTime(todayRecord.inSlot + todayRecord.outSlot);
            } else {
                // 降级使用考勤记录中的数据
                if (typeof studentRecord.practicedSec === 'number' && studentRecord.practicedSec > 0) {
                    totalDuration = formatPracticeTime(studentRecord.practicedSec);
                } else if (typeof studentRecord.effectiveTotalSec === 'number' && studentRecord.effectiveTotalSec > 0) {
                    totalDuration = formatPracticeTime(studentRecord.effectiveTotalSec);
                } else if (studentRecord.practicedText) {
                    totalDuration = studentRecord.practicedText;
                }
            }

            history.push({
                date: date,
                status: studentRecord.finalAttendanceStatus || 'no-data',
                inSlotDuration: inSlotDuration,
                outSlotDuration: outSlotDuration,
                totalDuration: totalDuration,
                room: studentRecord.room || t('student.not_in_room', '不在琴房')
            });

        } else {
            history.push({
                date: date,
                status: 'no-data',
                inSlotDuration: t('time.no_practice', '0分钟'),
                outSlotDuration: t('time.no_practice', '0分钟'),
                totalDuration: t('time.no_practice', '0分钟'),
                room: t('student.not_in_room', '不在琴房')
            });
        }
    });
    
    return history;
}


function createStudentDetailContent(student) {
    const attendanceStats = calculateDetailedAttendanceStats(student.extendedHistory);
    
    return `
        <div class="student-detail-content">
            <!-- 学生基本信息卡片 -->
            <div class="student-profile-card">
                <div class="profile-info">
                    <h2 class="profile-name">${student.name}</h2>
                    <div class="profile-meta">
                        <span class="meta-item">
                            <i class="meta-icon">🎼</i>
                            ${student.major || t('student.not_set', '未设置')}
                        </span>
                        <span class="meta-divider">•</span>
                        <span class="meta-item">
                            <i class="meta-icon">📚</i>
                            ${student.grade || t('student.not_set', '未设置')}
                        </span>
                        <span class="meta-divider">•</span>
                        <span class="meta-item">
                            <i class="meta-icon">⏰</i>
                            ${student.start && student.end ? `${student.start}-${student.end}` : t('student.self_practice', '自主练琴')}
                        </span>
                    </div>
                </div>
            </div>

            <!-- 今日状态卡片 -->
            <div class="today-status-card ${getStatusClass(student.finalAttendanceStatus)}">
                <div class="status-header">
                    <h3 class="status-title">${t('student.today_attendance', '今日考勤')}</h3>
                    <div class="status-badge ${getStatusClass(student.finalAttendanceStatus)}">
                        ${student.finalStatusText || getStatusText(student.finalAttendanceStatus)}
                    </div>
                </div>
                
                <div class="status-metrics">
                    <div class="metric-item">
                        <div class="metric-icon">💼</div>
                        <div class="metric-content">
                            <div class="metric-label">${t('student.daily_total_duration', '当日累计练琴')}</div>
                            <div class="metric-value">${formatDailyTotalDuration(student.name)}</div>
                        </div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="metric-icon">🕐</div>
                        <div class="metric-content">
                            <div class="metric-label">${t('student.start_time', '开始时间')}</div>
                            <div class="metric-value">${getStudentStartTime(student.name) || t('student.not_started', '未开始')}</div>
                        </div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="metric-icon">🏠</div>
                        <div class="metric-content">
                            <div class="metric-label">${t('student.room', '所在琴房')}</div>
                            <div class="metric-value">${student.room || t('student.not_in_room', '不在琴房')}</div>
                        </div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="metric-icon">📊</div>
                        <div class="metric-content">
                            <div class="metric-label">${t('attendance.rate', '出勤率')}</div>
                            <div class="metric-value">${calculateAttendanceRate(student)}%</div>
                        </div>
                    </div>
                </div>

                ${student.excuseInfo ? `
                <div class="excuse-info">
                    <div class="excuse-header">
                        <i class="excuse-icon">📝</i>
                        <span class="excuse-title">${t('excuse.reason', '请假信息')}</span>
                    </div>
                    <div class="excuse-content">
                        <p class="excuse-reason">${student.excuseInfo.reason || t('status.excused', '已请假')}</p>
                        <p class="excuse-approver">${t('excuse.time', '请假时长')}: ${student.excuseInfo.durationText || t('excuse.not_filled', '未填写')}</p>
                    </div>
                </div>
                ` : ''}
            </div>

            <!-- 最近7天考勤历史 -->
            <div class="card attendance-history-card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="title-icon">📅</i>
                        ${t('attendance.history', '最近7天考勤')}
                    </h4>
                </div>
                <div class="history-timeline-container">
                    <div class="history-timeline">
                        ${createAttendanceHistoryTimeline(student)}
                    </div>
                </div>
            </div>

            <!-- 考勤统计 -->
            <div class="card stats-card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="title-icon">📈</i>
                        ${t('student.attendance_stats', '考勤统计')} 
                        <span class="title-subtitle">(${t('report.last_30_days', '最近30天')})</span>
                    </h4>
                </div>
                <div class="stats-grid-detailed">
                    <div class="stat-item present">
                        <div class="stat-icon">✅</div>
                        <div class="stat-content">
                            <div class="stat-number">${attendanceStats.present}</div>
                            <div class="stat-label">${t('stats.present', '正常出勤')}</div>
                        </div>
                    </div>
                    <div class="stat-item absent">
                        <div class="stat-icon">❌</div>
                        <div class="stat-content">
                            <div class="stat-number">${attendanceStats.absent}</div>
                            <div class="stat-label">${t('stats.absent', '缺勤')}</div>
                        </div>
                    </div>
                    <div class="stat-item excused">
                        <div class="stat-icon">📝</div>
                        <div class="stat-content">
                            <div class="stat-number">${attendanceStats.excused}</div>
                            <div class="stat-label">${t('stats.excused', '请假')}</div>
                        </div>
                    </div>
                    <div class="stat-item rate">
                        <div class="stat-icon">📊</div>
                        <div class="stat-content">
                            <div class="stat-number">${attendanceStats.rate}%</div>
                            <div class="stat-label">${t('attendance.rate', '出勤率')}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 🔥 新增：详细练琴时长历史记录表格 -->
            <div class="card history-table-card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="title-icon">📋</i>
                        ${t('student.history_records', '历史记录')} 
                        <span class="title-subtitle">(${t('report.last_30_days', '最近30天')} - ${t('table.scroll_to_view', '滑动查看')})</span>
                    </h4>
                </div>
                <div class="table-container">
                    ${student.extendedHistory && student.extendedHistory.length > 0 ? `
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th>${t('report.date', '日期')}</th>
                                    <th>${t('attendance.status', '状态')}</th>
                                    <th>${t('practice.scheduled', '规定时段')}</th>
                                    <th>${t('practice.unscheduled', '时段外')}</th>
                                    <th>${t('practice.total', '总时长')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${student.extendedHistory.map((record, index) => `
                                    <tr ${index === 0 ? 'class="today-row"' : ''}>
                                        <td class="date-cell">
                                            ${record.date}
                                            ${index === 0 ? '<small style="color: var(--primary-color); font-weight: 600;"> (今日)</small>' : ''}
                                        </td>
                                        <td>
                                            <span class="table-status-badge ${getStatusClass(record.status)}">
                                                ${getStatusText(record.status)}
                                            </span>
                                        </td>
                                        <td class="duration-cell">${record.inSlotDuration}</td>
                                        <td class="duration-cell">${record.outSlotDuration}</td>
                                        <td class="total-duration-cell">${record.totalDuration}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="table-scroll-hint">↕ ${t('table.scroll_hint', '滑动查看更多')}</div>
                    ` : `
                        <div class="table-empty-state">
                            <div class="table-empty-state-icon">📋</div>
                            <div class="table-empty-state-title">${t('table.no_records', '暂无历史记录')}</div>
                            <div class="table-empty-state-description">${t('table.no_records_desc', '该学生还没有考勤记录')}</div>
                        </div>
                    `}
                </div>
            </div>
        </div>
    `;
}

// 计算详细考勤统计
function calculateDetailedAttendanceStats(history) {
    const total = history.length;
    const present = history.filter(h => h.status === 'present' || h.status === 'low_efficiency').length;
    const absent = history.filter(h => h.status === 'absent').length;
    const excused = history.filter(h => h.status === 'excused').length;
    const validDays = history.filter(h => h.status !== 'no-data').length;
    
    const rate = validDays > 0 ? Math.round((present / validDays) * 100) : 0;
    
    return { total, present, absent, excused, rate };
}

// 关闭模态框
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
}

// 点击模态框外部关闭
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
    }
});

// 刷新数据
function refreshData() {
    if (!isOnline) {
        alert(t('msg.sync_required', '需要网络连接才能同步数据'));
        return;
    }
    
    addSyncLog('🔄 ' + t('sync.manual_refresh', '手动刷新数据...'));
    forceRefreshAllData();
}

// 报告相关功能
function initReportsTab() {
    const today = new Date();
    const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('startDate').value = oneWeekAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

// 生成报告
function generateReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert(t('msg.select_dates', '请选择开始和结束日期'));
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert(t('msg.date_range_error', '开始日期不能晚于结束日期'));
        return;
    }
    
    if (!isOnline) {
        generateOfflineReport(startDate, endDate);
        return;
    }
    
    const reportContent = document.getElementById('reportContent');
    reportContent.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    loadReportData(startDate, endDate).then(data => {
        displayReport(data, startDate, endDate);
        addSyncLog(`📊 已生成 ${startDate} 至 ${endDate} 的考勤报告`);
    }).catch(error => {
        reportContent.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">❌</div>
                <div class="empty-state-title">${t('report.generate_failed', '报告生成失败')}</div>
                <div class="empty-state-description">${error.message}</div>
            </div>
        `;
        addSyncLog(`❌ 报告生成失败: ${error.message}`);
    });
}

// 加载报告数据
function loadReportData(startDate, endDate) {
    return new Promise((resolve, reject) => {
        const promises = [];
        const reportData = {};
        
        const current = new Date(startDate);
        const end = new Date(endDate);
        
        while (current <= end) {
            const dateStr = current.toISOString().split('T')[0];
            
            if (attendanceData[dateStr]) {
                reportData[dateStr] = attendanceData[dateStr];
            } else {
                const promise = database.ref(`attendanceData/${dateStr}`).once('value')
                    .then(snapshot => {
                        reportData[dateStr] = snapshot.val() || {};
                    })
                    .catch(error => {
                        console.warn(`加载 ${dateStr} 数据失败:`, error);
                        reportData[dateStr] = {};
                    });
                promises.push(promise);
            }
            
            current.setDate(current.getDate() + 1);
        }
        
        Promise.all(promises).then(() => {
            resolve(reportData);
        }).catch(reject);
    });
}

// 生成离线报告
function generateOfflineReport(startDate, endDate) {
    const reportData = {};
    const current = new Date(startDate);
    const end = new Date(endDate);
    
    while (current <= end) {
        const dateStr = current.toISOString().split('T')[0];
        const localData = localStorage.getItem(`attendance_${dateStr}`);
        reportData[dateStr] = localData ? JSON.parse(localData) : {};
        current.setDate(current.getDate() + 1);
    }
    
    displayReport(reportData, startDate, endDate);
    addSyncLog(`📊 已生成离线报告 ${startDate} 至 ${endDate}`);
}

// 显示报告
function displayReport(data, startDate, endDate) {
    const reportContent = document.getElementById('reportContent');
    
    const analysis = analyzeReportData(data);
    const dateRange = calculateDateRange(startDate, endDate);
    
    let html = `
        <div class="card">
            <h4>${t('report.analysis_title', '📊 考勤分析报告')}</h4>
            <div class="student-details">
                <div class="detail-item">
                    <div class="detail-label">${t('report.period', '统计周期')}</div>
                    <div class="detail-value">${startDate} ${t('report.to', '至')} ${endDate} (${dateRange}${t('report.days', '天')})</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('report.participants', '参与学生')}</div>
                    <div class="detail-value">${analysis.totalStudents}${t('report.people', '人')}</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card present">
                <div class="stat-number">${analysis.totalPresent}</div>
                <div class="stat-label">${t('stats.present', '出勤')}</div>
                <div class="stat-description">${analysis.presentRate}%</div>
            </div>
            <div class="stat-card absent">
                <div class="stat-number">${analysis.totalAbsent}</div>
                <div class="stat-label">${t('stats.absent', '缺勤')}</div>
                <div class="stat-description">${analysis.absentRate}%</div>
            </div>
            <div class="stat-card excused">
                <div class="stat-number">${analysis.totalExcused}</div>
                <div class="stat-label">${t('stats.excused', '请假')}</div>
                <div class="stat-description">${analysis.excusedRate}%</div>
            </div>
            <div class="stat-card total">
                <div class="stat-number">${analysis.totalRecords}</div>
                <div class="stat-label">${t('report.total_records', '总记录数')}</div>
                <div class="stat-description">${t('report.all_data', '全部数据')}</div>
            </div>
        </div>

        <div class="card">
            <h4>${t('report.daily_trend', '📈 每日考勤趋势')}</h4>
            <div class="data-table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>${t('report.date', '日期')}</th>
                            <th>${t('report.total', '总人数')}</th>
                            <th>${t('stats.present', '出勤')}</th>
                            <th>${t('stats.absent', '缺勤')}</th>
                            <th>${t('stats.excused', '请假')}</th>
                            <th>${t('attendance.rate', '出勤率')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.dailyStats.map(day => `
                            <tr>
                                <td>${day.date}</td>
                                <td>${day.total}</td>
                                <td>${day.present}</td>
                                <td>${day.absent}</td>
                                <td>${day.excused}</td>
                                <td>${day.rate}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h4>${t('report.student_stats', '👥 学生考勤统计')}</h4>
            <div class="data-table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>${t('student.name', '姓名')}</th>
                            <th>${t('student.major', '专业')}</th>
                            <th>${t('stats.present', '出勤')}</th>
                            <th>${t('stats.absent', '缺勤')}</th>
                            <th>${t('stats.excused', '请假')}</th>
                            <th>${t('attendance.rate', '出勤率')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.studentStats.map(student => `
                            <tr>
                                <td>${student.name}</td>
                                <td>${student.major}</td>
                                <td>${student.present}</td>
                                <td>${student.absent}</td>
                                <td>${student.excused}</td>
                                <td>${student.rate}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="export-options">
            <button class="btn btn-primary" onclick="generateReport()">
                <span>🔄</span> ${t('report.regenerate', '重新生成')}
            </button>
        </div>
    `;
    
    reportContent.innerHTML = html;
}

// 分析报告数据
function analyzeReportData(data) {
    const studentStats = {};
    const dailyStats = [];
    let totalRecords = 0;
    let totalPresent = 0;
    let totalAbsent = 0;
    let totalExcused = 0;
    
    // 按日期排序
    const sortedDates = Object.keys(data).sort();
    
    sortedDates.forEach(date => {
        const dayData = data[date];
        const students = Object.values(dayData);
        
        const dayPresent = students.filter(s => s.finalAttendanceStatus === 'present').length;
        const dayAbsent = students.filter(s => s.finalAttendanceStatus === 'absent').length;
        const dayExcused = students.filter(s => s.finalAttendanceStatus === 'excused').length;
        const dayTotal = students.length;
        const dayRate = dayTotal > 0 ? Math.round((dayPresent / dayTotal) * 100) : 0;
        
        dailyStats.push({
            date: date,
            total: dayTotal,
            present: dayPresent,
            absent: dayAbsent,
            excused: dayExcused,
            rate: dayRate
        });
        
        totalRecords += dayTotal;
        totalPresent += dayPresent;
        totalAbsent += dayAbsent;
        totalExcused += dayExcused;
        
        // 统计每个学生的数据
        students.forEach(student => {
            if (!studentStats[student.name]) {
                studentStats[student.name] = {
                    name: student.name,
                    major: student.major || t('student.unknown_major', '未知专业'),
                    present: 0,
                    absent: 0,
                    excused: 0,
                    total: 0
                };
            }
            
            const stats = studentStats[student.name];
            stats.total++;
            
            switch (student.finalAttendanceStatus) {
                case 'present':
                    stats.present++;
                    break;
                case 'absent':
                    stats.absent++;
                    break;
                case 'excused':
                    stats.excused++;
                    break;
            }
        });
    });
    
    // 计算学生出勤率
    const studentStatsArray = Object.values(studentStats).map(student => ({
        ...student,
        rate: student.total > 0 ? Math.round((student.present / student.total) * 100) : 0
    })).sort((a, b) => b.rate - a.rate);
    
    const totalStudents = Object.keys(studentStats).length;
    const presentRate = totalRecords > 0 ? Math.round((totalPresent / totalRecords) * 100) : 0;
    const absentRate = totalRecords > 0 ? Math.round((totalAbsent / totalRecords) * 100) : 0;
    const excusedRate = totalRecords > 0 ? Math.round((totalExcused / totalRecords) * 100) : 0;
    
    return {
        totalStudents,
        totalRecords,
        totalPresent,
        totalAbsent,
        totalExcused,
        presentRate,
        absentRate,
        excusedRate,
        dailyStats,
        studentStats: studentStatsArray
    };
}

// 计算日期范围
function calculateDateRange(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    return diffDays;
}

// 同步管理功能
function updateSyncStatus() {
    const statusEl = document.getElementById('syncStatusText');
    
    if (isOnline) {
        statusEl.innerHTML = `
            <div style="color: #27ae60; margin-bottom: 10px;">
                ✅ ${t('sync.connected', '已连接到Firebase数据库')}
            </div>
            <div style="color: #666; font-size: 14px;">
                ${t('sync.realtime', '数据正在实时同步中...')}
            </div>
            <div style="color: #666; font-size: 12px; margin-top: 5px;">
                ${t('sync.last_sync', '最后同步时间: ')}${new Date().toLocaleString()}
            </div>
        `;
    } else {
        statusEl.innerHTML = `
            <div style="color: #e74c3c; margin-bottom: 10px;">
                ❌ ${t('sync.disconnected', '未连接到数据库')}
            </div>
            <div style="color: #f39c12; font-size: 14px;">
                ${t('sync.offline_mode', '当前处于离线模式，部分功能受限')}
            </div>
            <div style="color: #666; font-size: 12px; margin-top: 5px;">
                ${t('sync.check_network', '请检查网络连接')}
            </div>
        `;
    }
}

// 强制同步数据
function forceSyncData() {
    if (!isOnline) {
        alert(t('msg.sync_required', '需要网络连接才能同步数据'));
        return;
    }
    
    addSyncLog('🔄 ' + t('sync.force_start', '开始强制同步...'));
    
    // 清除本地缓存
    Object.keys(localStorage).forEach(key => {
        if (key.startsWith('attendance_') || key === 'realTimePracticeStatus') {
            localStorage.removeItem(key);
        }
    });
    
    // 重新初始化数据
    attendanceData = { realTimePractice: {} };
    studentData = {};
    excuseData = {};
    
    // 强制刷新所有数据
    forceRefreshAllData();
    
    addSyncLog('✅ ' + t('sync.force_complete', '强制同步完成'));
}

// 清除本地缓存
function clearLocalCache() {
    if (!confirm(t('msg.clear_cache_confirm', '确定要清除本地缓存吗？这将删除所有离线数据。'))) {
        return;
    }
    
    // 🔥 修改：清除所有本地存储数据（但实时练琴数据本来就不在本地存储中）
    const keysToRemove = [];
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (
            key.startsWith('attendance_') ||
            key === 'studentData' ||
            key === 'excuseData'
            // 注意：不包含实时练琴相关的键，因为它们已经不存储在本地了
        )) {
            keysToRemove.push(key);
        }
    }
    
    // 批量删除
    keysToRemove.forEach(key => {
        localStorage.removeItem(key);
    });
    
    // 🔥 重置数据
    studentData = {};
    excuseData = {};
    // 清空考勤历史数据，但保留实时练琴数据（因为它在内存中）
    const realTimePractice = attendanceData.realTimePractice; // 备份
    attendanceData = { realTimePractice }; // 重置但保留实时数据
    
    // 清空显示
    document.getElementById('todaySnapshot').innerHTML = '';
    document.getElementById('studentList').innerHTML = '';
    // 不清空练琴状态显示，因为数据仍在内存中
    
    addSyncLog(`🗑️ 已清除 ${keysToRemove.length} 个本地缓存项（实时练琴数据保留在内存中）`);
    alert(t('msg.cache_cleared', '本地缓存已清除'));
    
    // 如果在线，重新加载数据
    if (isOnline) {
        setTimeout(() => {
            forceRefreshAllData();
        }, 1000);
    }
}


// 🔥 保留：预加载最近的考勤数据（这个功能保持不变）
function preloadRecentAttendanceData() {
    if (!isOnline) return;
    
    const promises = [];
    const today = new Date();
    
    // 预加载最近7天的数据
    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        if (!attendanceData[dateStr]) {
            const promise = database.ref(`attendanceData/${dateStr}`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val() || {};
                    attendanceData[dateStr] = data;
                    
                    // 🔥 保留：保存到本地存储
                    try {
                        localStorage.setItem(`attendance_${dateStr}`, JSON.stringify(data));
                    } catch (e) {
                        console.warn('本地存储空间不足:', e);
                    }
                })
                .catch((error) => {
                    console.warn(`预加载 ${dateStr} 数据失败:`, error);
                });
            promises.push(promise);
        }
    }
    
    Promise.all(promises).then(() => {
        addSyncLog(`📥 已预加载最近7天的考勤数据`);
    });
}

// 显示加载状态
function showLoading(containerId) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <div style="margin-top: 10px; color: #666;">${t('msg.loading', '加载中...')}</div>
            </div>
        `;
    }
}

// 显示空状态
function showEmptyState(containerId, title, description) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📋</div>
                <div class="empty-state-title">${title}</div>
                <div class="empty-state-description">${description}</div>
            </div>
        `;
    }
}

// 错误处理
window.addEventListener('error', (event) => {
    console.error('全局错误:', event.error);
    addSyncLog(`❌ 系统错误: ${event.error?.message || '未知错误'}`);
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('未处理的Promise拒绝:', event.reason);
    addSyncLog(`❌ Promise错误: ${event.reason?.message || '未知错误'}`);
});

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 页面开始初始化...');
    
    // 恢复语言偏好
    const savedLanguage = localStorage.getItem('preferred_language');
    if (savedLanguage && savedLanguage !== currentLanguage) {
        switchLanguage(savedLanguage);
    } else {
        updatePageLanguage();
    }
    
    // 设置今天的日期
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = today;
    
    // 🔥 修改：恢复其他本地数据，但不恢复实时练琴状态
    restoreOtherLocalData();
    
    // 🔥 实时练琴状态初始化为空（不使用本地存储）
    attendanceData.realTimePractice = {};
    realTimePracticeStatus = {};
    lastRealTimePracticeHash = '';
    console.log('📱 实时练琴状态已初始化为空状态（不使用本地存储）');
    
    // 初始化Firebase
    initFirebase();
    
    // 初始化实时练琴状态显示
    initPracticeStatusDisplay();
    
    // 更新连接状态
    updateConnectionStatus();
    
    // 更新同步状态
    updateSyncStatus();
    
    // 初始化同步日志显示
    updateSyncLogsDisplay();
    
    // 添加初始化日志
    addSyncLog('🎼 青岛梅纽因学校练琴跟踪系统已启动');
    addSyncLog(`🌐 当前语言: ${currentLanguage === 'zh' ? '中文' : 'English'}`);
    addSyncLog('📱 实时练琴数据仅存储在内存中，考勤历史数据正常缓存');
    
    console.log('✅ 页面初始化完成');
});

/**
 * 恢复其他本地数据（保留考勤历史等）
 */
function restoreOtherLocalData() {
    try {
        // 🔥 保留：恢复学生数据
        const savedStudentData = localStorage.getItem('studentData');
        if (savedStudentData) {
            const studentDataParsed = JSON.parse(savedStudentData);
            if (studentDataParsed && typeof studentDataParsed === 'object') {
                studentData = studentDataParsed;
                console.log('📚 已恢复学生数据');
            }
        }
        
        // 🔥 保留：恢复请假数据
        const savedExcuseData = localStorage.getItem('excuseData');
        if (savedExcuseData) {
            const excuseDataParsed = JSON.parse(savedExcuseData);
            if (excuseDataParsed && typeof excuseDataParsed === 'object') {
                excuseData = excuseDataParsed;
                console.log('📝 已恢复请假数据');
            }
        }
        
        // 🔥 保留：恢复考勤历史数据
        let restoredDates = 0;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('attendance_')) {
                try {
                    const dateStr = key.replace('attendance_', '');
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data && typeof data === 'object') {
                        attendanceData[dateStr] = data;
                        restoredDates++;
                    }
                } catch (error) {
                    console.warn(`恢复考勤数据失败 ${key}:`, error);
                }
            }
        }
        
        if (restoredDates > 0) {
            console.log(`📅 已恢复 ${restoredDates} 天的考勤历史数据`);
        }
        
    } catch (error) {
        console.warn('恢复本地数据失败:', error);
    }
}


// 页面卸载时的清理
window.addEventListener('beforeunload', () => {
    // 清理定时器
    syncTimers.forEach(timer => clearTimeout(timer));
    syncTimers.clear();
    
    if (practiceStatusUpdateTimeout) {
        clearTimeout(practiceStatusUpdateTimeout);
        practiceStatusUpdateTimeout = null;
    }
    
    // 🔥 移除：不再保存实时练琴状态到本地存储
    
    console.log('🧹 页面卸载，实时练琴数据已清理（不保存到本地）');
});


// 网络状态监听
window.addEventListener('online', () => {
    console.log('🌐 网络已连接');
    addSyncLog('🌐 网络连接已恢复');
    
    // 延迟重新初始化Firebase连接
    setTimeout(() => {
        if (!isOnline) {
            initFirebase();
        }
    }, 2000);
});

window.addEventListener('offline', () => {
    console.log('📱 网络已断开');
    addSyncLog('📱 网络连接已断开，切换到离线模式');
    isOnline = false;
    updateConnectionStatus();
    updateSyncStatus();
});
// =============== 练琴记录系统 ===============

// 全局练琴记录数据
let dailyPracticeRecords = {};

/**
 * 获取学生单日练习记录
 * @param {string} studentName - 学生姓名
 * @param {string} date - 日期，格式 YYYY-MM-DD，默认为今天
 * @returns {Object} 练习记录对象
 */
function getStudentPracticeRecord(studentName, date = null) {
    if (!date) {
        date = new Date().toISOString().split('T')[0];
    }
    
    // 如果本地没有该日期的记录，尝试从考勤数据中构建
    if (!dailyPracticeRecords[date]) {
        dailyPracticeRecords[date] = {};
    }
    
    if (!dailyPracticeRecords[date][studentName]) {
        // 尝试从考勤数据构建练琴记录
        const attendanceRecord = attendanceData[date] && attendanceData[date][studentName];
        if (attendanceRecord) {
            const inSlot = attendanceRecord.practicedSec || 0;
            const outSlot = 0; // 考勤记录中通常没有区分时段内外
            
            dailyPracticeRecords[date][studentName] = {
                inSlot: inSlot,
                outSlot: outSlot,
                totalSessions: 1,
                sessions: [],
                lastUpdated: Date.now()
            };
        } else {
            // 返回空记录
            return {
                inSlot: 0,
                outSlot: 0,
                totalSessions: 0,
                sessions: [],
                lastUpdated: 0
            };
        }
    }
    
    return dailyPracticeRecords[date][studentName];
}

/**
 * 获取学生多日练习统计
 * @param {string} studentName - 学生姓名
 * @param {number} days - 统计天数，默认7天
 * @returns {Object} 统计数据对象
 */
function getStudentPracticeStats(studentName, days = 7) {
    const stats = {
        totalDays: 0,
        totalInSlot: 0,
        totalOutSlot: 0,
        totalSessions: 0,
        dailyDetails: []
    };
    
    const today = new Date();
    for (let i = 0; i < days; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        const record = getStudentPracticeRecord(studentName, dateStr);
        
        if (record.inSlot > 0 || record.outSlot > 0) {
            stats.totalDays++;
            stats.totalInSlot += record.inSlot;
            stats.totalOutSlot += record.outSlot;
            stats.totalSessions += record.totalSessions;
        }
        
        stats.dailyDetails.push({
            date: dateStr,
            inSlot: record.inSlot,
            outSlot: record.outSlot,
            sessions: record.totalSessions
        });
    }
    
    return stats;
}

/**
 * 格式化练习时长显示
 * @param {number} seconds - 秒数
 * @returns {string} 格式化的时长文本
 */
function formatPracticeTime(seconds) {
    if (!seconds || seconds <= 0) return '0分钟';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    let result = '';
    if (hours > 0) {
        result += `${hours}小时`;
    }
    if (minutes > 0) {
        result += `${minutes}分钟`;
    }
    if (secs > 0 && hours === 0) {
        result += `${secs}秒`;
    }
    
    return result || '0分钟';
}


// 导出全局函数供HTML调用
window.switchTab = switchTab;
window.switchLanguage = switchLanguage;
window.loadAttendanceData = loadAttendanceData;
window.refreshData = refreshData;
window.refreshPracticeStatus = refreshPracticeStatus;
window.filterStudents = filterStudents;
window.showStudentDetail = showStudentDetail;
window.closeModal = closeModal;
window.generateReport = generateReport;
window.forceSyncData = forceSyncData;
window.clearLocalCache = clearLocalCache;
window.updateSyncStatus = updateSyncStatus;
window.getStudentRealTimePracticeStatus = getStudentRealTimePracticeStatus;
window.checkAndUpdateRealTimePracticeStatus = checkAndUpdateRealTimePracticeStatus;
window.triggerRealTimePracticeStatusUpdate = triggerRealTimePracticeStatusUpdate;
window.cleanupEndedPracticeStatus = cleanupEndedPracticeStatus;
window.filterPracticeStatus = filterPracticeStatus;
window.setQuickFilter = setQuickFilter;
window.clearPracticeFilters = clearPracticeFilters;
// 在文件末尾的导出部分添加
window.createCompactStudentCard = createCompactStudentCard;

window.getStudentPracticeRecord = getStudentPracticeRecord;
window.getStudentPracticeStats = getStudentPracticeStats;
window.formatPracticeTime = formatPracticeTime;


console.log('📜 脚本加载完成，等待DOM初始化...');

</script>
</body>
</html>