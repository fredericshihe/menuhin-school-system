<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#f5f7fa" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>å­¦ç”Ÿç»ƒç´è·Ÿè¸ªç³»ç»Ÿ</title>
  <!-- å·²ç§»é™¤ Google Fontsï¼Œä½¿ç”¨ç³»ç»Ÿå­—ä½“ä»¥é¿å…å¤–éƒ¨ 400 æŠ¥é”™ -->
  
  <!--
  ====================================================================
  ğŸ“Š æ•°æ®åŒæ­¥ä¸è®¢é˜…é…ç½®æ£€æŸ¥æŠ¥å‘Š - å·²å®Œæˆå…¨é¢éªŒè¯ âœ…
  ====================================================================
  
  ğŸ¯ æ£€æŸ¥ç»“è®ºï¼šæ‰€æœ‰æ˜¾ç¤ºå†…å®¹éƒ½èƒ½åœ¨æ•°æ®å˜åŒ–æ—¶ç¬¬ä¸€æ—¶é—´åŒæ­¥æ›´æ–°
  
  âœ… 1. å®æ—¶æ•°æ®è®¢é˜…ï¼ˆSupabase Realtimeï¼‰
     - ç›‘å¬è¡¨ï¼šrooms, practice_logs, student_database, student_time_slots
     - å¤šè¡¨ç»Ÿä¸€ä¼˜åŒ–ï¼š4å¼ æ ¸å¿ƒè¡¨å…¨éƒ¨æ”¯æŒWebSocketç›´è¿+å¢é‡æ›´æ–°+ä¹è§‚é¢„æµ‹
     - è‡ªåŠ¨é‡è¿ï¼šæœ€å¤š5æ¬¡å°è¯•ï¼Œå¿ƒè·³ç›‘æ§è¿æ¥å¥åº·
     - é¡µé¢ä¼˜åŒ–ï¼šéšè—æ—¶é™ä½åŒæ­¥é¢‘ç‡ï¼Œå¯è§æ—¶æ¢å¤
  
  âœ… 2. å·®å¼‚åŒæ­¥æœºåˆ¶
     - æ•°æ®ç‰ˆæœ¬ç®¡ç†ï¼šåŸºäºå“ˆå¸Œå€¼æ£€æµ‹çœŸå®å˜åŒ–
     - æ™ºèƒ½æ›´æ–°ï¼šåªæœ‰å˜åŒ–æ•°æ®æ‰è§¦å‘UIæ›´æ–°
     - åˆ†è¡¨è·Ÿè¸ªï¼šæ¯ä¸ªè¡¨ç‹¬ç«‹ç‰ˆæœ¬ä¿¡æ¯
     - å®Œæ•´æ€§ä¿éšœï¼šæ”¯æŒåˆ†é¡µè·å–å¤§é‡æ•°æ®
  
  âœ… 3. å…·ä½“æ˜¾ç¤ºå†…å®¹å®æ—¶æ›´æ–°éªŒè¯
  
     ğŸ¯ æ—¶é—´è½´ï¼š
     - æ­£åœ¨è¿›è¡Œçš„ç»ƒç´ä¼šè¯ï¼šæ¯15ç§’æ›´æ–°æ—¶é•¿æ˜¾ç¤º
     - æ–°å¢ç»ƒç´è®°å½•ï¼šå®æ—¶è¿½åŠ åˆ°æ—¶é—´è½´
     - ç»ƒç´çŠ¶æ€å˜æ›´ï¼šç«‹å³åæ˜ assign/clearæ“ä½œ
     - æ™ºèƒ½åœæ­¢ï¼šæ— æ´»è·ƒä¼šè¯æ—¶è‡ªåŠ¨åœæ­¢æ›´æ–°
  
     ğŸ“Š æ’è¡Œæ¦œåˆ†æ•°ï¼š
     - æ—¥æ¦œæ›´æ–°ï¼šæ•°æ®å˜åŒ–æ—¶2ç§’å†…è§¦å‘é‡è®¡ç®—
     - å‘¨æ¦œæ›´æ–°ï¼š5ä¸ªå·¥ä½œæ—¥å¹³å‡åˆ†è‡ªåŠ¨é‡ç®—
     - åˆ†æ•°ç»´åº¦ï¼šD1/D2/D3 å…¨éƒ¨å®æ—¶æ›´æ–°
     - ç¼“å­˜ä¼˜åŒ–ï¼š30ç§’ç¼“å­˜ + 2-10ç§’é˜²æŠ–æœºåˆ¶
  
     ğŸ“ˆ è¯„åˆ†è¯¦æƒ…ï¼š
     - ç»´åº¦1åˆ†æ•°ï¼šæ®µå†…å®Œæˆç‡å®æ—¶è®¡ç®—
     - ç»´åº¦2åˆ†æ•°ï¼šè´¨é‡æ•ˆç‡å®æ—¶è¯„ä¼°
     - ç»´åº¦3åˆ†æ•°ï¼šæˆé•¿åŠ æˆåŠ¨æ€æ›´æ–°
     - æ‰£åˆ†è¯¦æƒ…ï¼šè¿Ÿåˆ°/ç¼ºå¸­/è¶…æ—¶å®æ—¶åæ˜ 
  
     ğŸ“‹ æ€»è®¡è¯¦æƒ…ï¼š
     - æ€»ç»ƒç´æ—¶é•¿ï¼šæ‰€æœ‰å­¦ç”Ÿç´¯è®¡æ—¶é•¿å®æ—¶æ›´æ–°
     - å¹³å‡æ—¶é•¿ï¼šåŠ¨æ€è®¡ç®—å¹³å‡å€¼
     - æ´»è·ƒå­¦ç”Ÿæ•°ï¼šå®æ—¶ç»Ÿè®¡åœ¨ç»ƒå­¦ç”Ÿ
     - æˆ¿é—´ä½¿ç”¨ç‡ï¼šå®æ—¶è®¡ç®—å ç”¨æ¯”ä¾‹
  
     ğŸ  é¦–é¡µæ¦‚è§ˆï¼š
     - ç»ƒç´ä¸­å­¦ç”Ÿæ•°é‡ï¼šå®æ—¶ç»Ÿè®¡
     - ä»Šæ—¥æ€»æ—¶é•¿ï¼šå®æ—¶ç´¯è®¡
     - æ´»è·ƒæˆ¿é—´çŠ¶æ€ï¼š2ç§’å†…åŒæ­¥
     - åˆ†ç±»ç»Ÿè®¡ï¼šæŒ‰å¹´çº§/ä¸“ä¸šå®æ—¶åˆ†ç»„
  
     ğŸ‘¤ å­¦ç”Ÿè¯¦æƒ…ï¼š
     - å½“å‰ç»ƒç´çŠ¶æ€ï¼šå®æ—¶æ˜¾ç¤ºï¼ˆç»ƒç´ä¸­/ç©ºé—²ï¼‰
     - å½“å‰æ—¶é•¿ï¼šæ¯30ç§’æ›´æ–°æ­£åœ¨è¿›è¡Œçš„ç»ƒç´æ—¶é•¿
     - ä»Šæ—¥ç´¯è®¡ï¼šå®æ—¶ç´¯åŠ ç»ƒç´æ—¶é•¿
     - å†å²7å¤©æ•°æ®ï¼šæ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨é‡ç®—
     - ä¸ªäººæ’åï¼šè·Ÿéšæ’è¡Œæ¦œåŒæ­¥æ›´æ–°
  
  âœ… 4. åŒæ­¥æ€§èƒ½ç›‘æ§
     - æ›´æ–°é¢‘ç‡ç›‘æ§ï¼šæ¯15ç§’è®°å½•æ›´æ–°æ¬¡æ•°
     - è¿æ¥è´¨é‡ç›‘æ§ï¼šå¿ƒè·³æ£€æµ‹ + è´¨é‡è¯„çº§
     - æ€§èƒ½è¿½è¸ªï¼šè®°å½•æ•°æ®å¤„ç†è€—æ—¶
     - æ•°æ®ç‰ˆæœ¬è¿½è¸ªï¼šç›‘æ§æ¯ä¸ªè¡¨åŒæ­¥çŠ¶æ€
  
  âœ… 5. å¤šå±‚åŒæ­¥ä¿éšœ
     - ä¸»è¦ï¼šå®æ—¶è®¢é˜…ï¼ˆSupabase Realtimeï¼‰
     - å¤‡ç”¨ï¼šå·®å¼‚åŒæ­¥æ£€æµ‹
     - å…œåº•ï¼šå®šæ—¶è½®è¯¢ï¼ˆè¿æ¥å¤±è´¥æ—¶ï¼‰
     - ä¼˜åŒ–ï¼šæ™ºèƒ½ç¼“å­˜ + é˜²æŠ–æ›´æ–°
  
  ğŸš€ ç³»ç»Ÿä¼˜åŠ¿æ€»ç»“ï¼š
     - å®Œæ•´çš„å®æ—¶åŒæ­¥è¦†ç›–æ‰€æœ‰æ˜¾ç¤ºå†…å®¹
     - æ™ºèƒ½æ€§èƒ½ä¼˜åŒ–å¹³è¡¡å®æ—¶æ€§ä¸èµ„æºæ¶ˆè€—  
     - ç¨³å®šè¿æ¥ç®¡ç†ç¡®ä¿æŒç»­æ•°æ®åŒæ­¥
     - ç²¾ç¡®å˜æ›´æ£€æµ‹é¿å…ä¸å¿…è¦çš„æ›´æ–°
  
  ğŸ“ ç»´æŠ¤è¦ç‚¹ï¼š
     - ç›‘æ§æ§åˆ¶å°åŒæ­¥æ—¥å¿—
     - è§‚å¯Ÿå³ä¸‹è§’è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨
     - å…³æ³¨æ›´æ–°é¢‘ç‡æ˜¯å¦åˆç†
     - å¿…è¦æ—¶æ‰‹åŠ¨æ¸…ç†ç¼“å­˜
  
  ğŸ¯ å…¬å¹³åŒ–æ”¹è¿›è®°å½•ï¼š
     - æ»¡å‹¤åŠ æˆç®€åŒ–ï¼š1æ®µ+0.5åˆ†ï¼Œ2æ®µ+1åˆ†ï¼Œâ‰¥3æ®µ+1.5åˆ†ï¼ˆå°é¡¶ï¼‰
     - è§£å†³æ—¶æ®µé…ç½®å°‘çš„å­¦ç”Ÿéš¾è·æ»¡å‹¤å¥–åŠ±çš„é—®é¢˜
     - é¿å…è¿‡åº¦å¥–åŠ±å¤šæ—¶æ®µï¼Œä½“ç°å…¬å¹³åŸåˆ™
  
  ====================================================================
  -->
  <style>
    :root{
      --bg-gradient-start:#f5f7fa;
      --bg-gradient-end:#c3cfe2;
      --surface:#ffffff;
      --surface-muted:#f6f8fa;
      --border:#e5e7eb;
      --border-strong:#d0d7de;
      --text:#1f2937;
      --text-muted:#6b7280;
      --primary:#6366f1;
      --primary-600:#5458ee;
      --primary-700:#4f46e5;
      --success:#22c55e;
      --warning:#f59e0b;
      --info:#0ea5e9;
      --shadow:0 8px 24px rgba(31,41,55,.08);
      --shadow-strong:0 12px 32px rgba(31,41,55,.12);
      --radius-lg:16px;
      --radius-md:12px;
      --radius-sm:8px;
      --card-pad:24px;
      --gap-md:16px;
    }
    /*
     * ==============================
     *  æ ·å¼åŒºï¼ˆCSSï¼‰â€” æ¦‚è§ˆ
     *  1) å…¨å±€ä¸å¸ƒå±€
     *  2) é¦–é¡µæ¦‚è§ˆï¼ˆå¡ç‰‡/åœ†ç¯/æ ‡ç­¾ï¼‰
     *  3) åˆ—è¡¨è§†å›¾
     *  4) å­¦ç”Ÿè¯¦æƒ…è§†å›¾ï¼ˆä¿¡æ¯/çŠ¶æ€/æ—¶é—´è½´/å†å²7å¤©ï¼‰
     *  æ³¨ï¼šä»…æ·»åŠ ç»“æ„åŒ–æ³¨é‡Šï¼Œä¸æ”¹ç°æœ‰æ ·å¼å«ä¹‰
     * ==============================
     */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      /* ç³»ç»Ÿ / æœ¬åœ°å­—ä½“æ ˆï¼šé¿å…å¤–éƒ¨å­—ä½“è¯·æ±‚å¤±è´¥ */
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, "Segoe UI", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", Roboto, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      color: #1d1d1f;
      /* overflow-y: auto; ç§»é™¤ä»¥é¿å…åŒé‡æ»šåŠ¨æ¡ */
      -webkit-overflow-scrolling: touch;
      
      /* ğŸš€ æ€§èƒ½ä¸ä½“éªŒä¼˜åŒ– */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      overscroll-behavior-y: none; /* é˜²æ­¢ä¸‹æ‹‰åˆ·æ–°å¯¼è‡´é¡µé¢æ•´ä½“æ‹–åŠ¨ */
    }
    
    html {
      scroll-behavior: smooth;
    }

    /* ä¼˜åŒ–ç‚¹å‡»è§¦æ„Ÿ */
    button, a, .ranking-item, .category-tab {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
    }

    /* ç¡¬ä»¶åŠ é€Ÿä¸æ¸²æŸ“ä¼˜åŒ– */
    .progress-fill, .ranking-item, .overview-card, .ranking-card {
      transform: translateZ(0);
      will-change: transform, opacity;
    }

    /* åˆ—è¡¨æ¸²æŸ“ä¼˜åŒ– */
    #rankingList, #rankingFullList {
      content-visibility: auto;
      contain-intrinsic-size: 60px; /* é¢„ä¼°é«˜åº¦ */
    }
    /* ä¿®æ­£ï¼šåˆ é™¤ iOS è¾¹ç¼˜æ»‘åŠ¨ç›¸å…³ä»£ç ï¼ˆCSS éƒ¨åˆ†å·²å»é™¤ï¼‰ */
    /* åŸåŠŸèƒ½è¯´æ˜ï¼šå±å¹•å·¦ç¼˜å³æ»‘è¿”å›ä¸Šä¸€è§†å›¾ï¼›å·²æŒ‰ç”¨æˆ·è¦æ±‚å®Œå…¨ç§»é™¤ã€‚ */

    /* å¸ƒå±€å®¹å™¨ */
    .container {
      width: 100%;
      max-width: 960px;
      padding: 24px 16px 32px;
      margin: 0 auto;
    }
    /* é¦–é¡µå±…ä¸­å±•ç¤º */
    #homeView { 
      min-height: 100vh;
      padding: 24px 16px;
      /* overflow-y: auto; ç§»é™¤ä»¥é¿å…åŒé‡æ»šåŠ¨æ¡ */
    }

    /* é¡µé¢æ ‡é¢˜ */
    .page-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #24292f;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .page-subtitle {
      font-size: 16px;
      color: #656d76;
      font-weight: 500;
    }

    /* æœç´¢åŒºåŸŸ */
    .search-section {
      margin-bottom: 32px;
      display: flex;
      justify-content: center;
    }

    .search-container {
      position: relative;
      width: 100%;
      max-width: 400px;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 2px solid #e1e4e8;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      background: #ffffff;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }

    .search-input:focus {
      outline: none;
      border-color: #0969da;
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #656d76;
      font-size: 16px;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 2px solid #e1e4e8;
      border-top: none;
      border-radius: 0 0 12px 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .search-result-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f6f8fa;
      transition: background-color 0.2s ease;
    }

    .search-result-item:hover {
      background-color: #f6f8fa;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-no-results {
      padding: 12px 16px;
      color: #656d76;
      text-align: center;
      font-style: italic;
    }

    /* æ¦‚è§ˆå¡ç‰‡å®¹å™¨è°ƒæ•´ */
    .overview-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }

    /* ä¸»å¡ç‰‡å®¹å™¨ */
    .overview-card {
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 32px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    /* æ’è¡Œæ¦œå¡ç‰‡ */
    .ranking-card {
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  padding: 24px 20px;
      width: 100%;
      max-width: 400px;
      margin-top: 24px;
    }

    /* æ’è¡Œæ¦œåˆ—è¡¨ */
  .ranking-list { margin: 0 4px 24px 4px; }

    .ranking-item {
      display: flex;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid #f6f8fa;
      transition: background-color 0.2s ease;
      position: relative;
      z-index: 0; /* åˆ›å»ºå †å ä¸Šä¸‹æ–‡ï¼Œä¾¿äº ::before æ”¾åˆ°å†…å®¹ä¸‹æ–¹ */
    }

    .ranking-item:last-child {
      border-bottom: none;
    }

  /* ç¨³å®šçš„ hover é«˜äº®ï¼šä¸æ”¹å˜ padding/å°ºå¯¸ï¼Œä½¿ç”¨å†…éƒ¨ä¼ªå…ƒç´ è¿‡æ¸¡ */
  .ranking-item { cursor: pointer; }
  .ranking-item::before {
    content: "";
    position: absolute;
    left: -8px; right: -8px; top: 4px; bottom: 4px;
    border-radius: 12px;
    background: transparent;
    transition: background .18s ease, box-shadow .18s ease;
    pointer-events: none;
    z-index: -1; /* ç½®äºæ–‡å­—ä¸‹æ–¹ï¼Œé¿å…é®æŒ¡ */
  }
  .ranking-item:hover { background: transparent; }
  .ranking-item:hover::before { background: var(--surface-0); box-shadow: var(--shadow-1); }

    .ranking-position {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      margin-right: 16px;
      flex-shrink: 0;
    }

    .ranking-position.rank-1 {
      background: linear-gradient(45deg, #ffd700, #ffa500);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }

    .ranking-position.rank-2 {
      background: linear-gradient(45deg, #c0c0c0, #a8a8a8);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(192, 192, 192, 0.3);
    }

    .ranking-position.rank-3 {
      background: linear-gradient(135deg, #cd7f32, #b8860b);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(205, 127, 50, 0.3);
    }

    .ranking-student-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-right: 16px;
    }

    .ranking-student-name {
      font-size: 16px;
      font-weight: 600;
      color: #24292f;
      margin-bottom: 4px;
    }

    .ranking-student-meta {
      font-size: 12px;
      color: #656d76;
    }

    .ranking-score {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .ranking-score-value {
      font-size: 18px;
      font-weight: 700;
      color: #0969da;
      margin-bottom: 2px;
    }

    .ranking-score-label {
      font-size: 12px;
      color: #656d76;
    }

    /* ===== æ’è¡Œæ¦œéª¨æ¶å± (é¦–å±åŠ é€Ÿæ„ŸçŸ¥) ===== */
    .ranking-item--skeleton { pointer-events: none; }
    .ranking-item--skeleton .sk-bar { 
      background: linear-gradient(90deg,#f1f5f9 25%,#e2e8f0 37%,#f1f5f9 63%);
      background-size: 400% 100%;
      height: 14px;
      border-radius: 4px;
      animation: skShine 1.3s ease infinite;
    }
    .ranking-item--skeleton .ranking-position { background:#e2e8f0; color:transparent; }
    .ranking-item--skeleton .ranking-student-name,
    .ranking-item--skeleton .ranking-student-meta,
    .ranking-item--skeleton .ranking-score-value,
    .ranking-item--skeleton .ranking-score-label { color:transparent; }
    @keyframes skShine { 0%{background-position:100% 0;} 100%{background-position:0 0;} }

/* å¹³æ»‘æ·¡å…¥åŠ¨ç”» */
#rankingFullList { position: relative; }
.ranking-fade-in { animation: rankingFade .28s ease; }
@keyframes rankingFade { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }

/* ç®¡ç†å‘˜æ¨¡å¼æ ·å¼ */
.admin-score-btn {
  animation: adminPulse 2s infinite;
}
@keyframes adminPulse {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3); }
}
.admin-score-btn:hover {
  animation: none !important;
  background: rgba(239, 68, 68, 1) !important;
  transform: scale(1.1);
}
.admin-adjustment {
  animation: adminGlow 3s ease-in-out infinite;
}
@keyframes adminGlow {
  0%, 100% { opacity: 0.9; }
  50% { opacity: 1; box-shadow: 0 0 8px rgba(16, 185, 129, 0.3); }
}
/* æ‰£åˆ†æŒ‰é’®æ ·å¼å¢å¼º */
.minus-btn {
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}
.minus-btn:hover {
  background: #fee2e2 !important;
  border-color: #f87171 !important;
  transform: translateY(-2px);
  box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.15);
}
.minus-btn:active {
  transform: translateY(0);
  box-shadow: none;
}
.minus-btn.selected {
  background: #dc2626 !important;
  color: white !important;
  border-color: #b91c1c !important;
  box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
}
/* å¤åŸæŒ‰é’®æ‚¬åœ */
#deltaResetBtn:hover {
  background: #f3f4f6 !important;
  border-color: #6b7280 !important;
  transform: translateY(-1px);
}
    /* æ’è¡Œæ¦œè¯¦æƒ…æŒ‰é’® */
    .ranking-details-btn {
      width: 100%;
      padding: 16px 24px;
      background: linear-gradient(135deg, #f6f8fa 0%, #ffffff 100%);
      border: 2px solid #e1e4e8;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      color: #24292f;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .ranking-details-btn:hover {
      background: linear-gradient(135deg, #e1e4e8 0%, #f6f8fa 100%);
      border-color: #d0d7de;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .ranking-details-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-subtitle {
      font-size: 14px;
      color: #656d76;
      font-weight: 500;
    }

    /* å¤´éƒ¨æ ‡é¢˜åŒºåŸŸ */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .card-title {
      font-size: 24px;
      font-weight: 700;
      color: #24292f;
      letter-spacing: -0.02em;
    }

    .card-date {
      font-size: 16px;
      font-weight: 500;
      color: #656d76;
      cursor: default;
    }

    /* åˆ†ç±»æ ‡ç­¾åŒºåŸŸ */
    .category-tabs {
      display: flex;
      background: #f6f8fa;
      border-radius: 16px;
      padding: 4px;
      margin-bottom: 32px;
      gap: 2px;
    }

    .category-tab {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: transparent;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      color: #656d76;
      cursor: pointer;
      transition: all 200ms ease;
      text-align: center;
    }

    .category-tab.active {
      background: #8b5cf6;
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }

    .category-tab:hover:not(.active) {
      background: #e5e7eb;
      color: #374151;
    }

    /* åœ†å½¢è¿›åº¦å›¾ */
    .progress-circle {
      position: relative;
      width: 160px;
      height: 160px;
      margin: 0 auto 24px;
    }

    .progress-circle svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .progress-bg {
      fill: none;
      stroke: #f1f3f4;
      stroke-width: 12;
      stroke-linecap: round;
    }

    .progress-fill {
      fill: none;
      /* stroke color will be set dynamically by JavaScript */
      stroke-width: 12;
      stroke-linecap: round;
      stroke-dasharray: 439.82;
      stroke-dashoffset: 439.82;
      transition: stroke-dashoffset 800ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ä¸­å¿ƒæ˜¾ç¤ºåŒºåŸŸ */
    .progress-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .progress-percentage {
      font-size: 32px;
      font-weight: 800;
      color: #24292f;
      line-height: 1;
      letter-spacing: -0.02em;
      display: inline;
    }

    .progress-percentage-symbol {
      font-size: 18px;
      color: #656d76;
      font-weight: 600;
      margin-left: 2px;
      display: inline;
    }

    /* è¿›åº¦æ¡ä¸‹æ–¹ä¿¡æ¯ */
    .progress-info {
      text-align: center;
      margin-bottom: 32px;
    }

    .progress-count {
      font-size: 24px;
      font-weight: 700;
      color: #24292f;
      margin-bottom: 4px;
    }

    .progress-count-unit {
      font-size: 16px;
      color: #656d76;
      margin-left: 4px;
    }

    .progress-description {
      font-size: 14px;
      color: #656d76;
      font-weight: 500;
    }

    /* æŸ¥çœ‹è¯¦æƒ…æŒ‰é’® */
    .view-details-btn {
      width: 100%;
      padding: 16px 24px;
      background: #8b5cf6;
      color: #ffffff;
      border: none;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 200ms ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .view-details-btn:hover {
      background: #7c3aed;
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
    }

    .view-details-btn:active {
      transform: translateY(0);
    }

    /* åˆ—è¡¨è§†å›¾ */
    .list-view {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      z-index: 100;
      transform: scale(0);
      opacity: 0;
      transform-origin: center center;
      transition: all 400ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
  will-change: transform, opacity;
    }
    .list-view.expanding {
      transform: scale(1);
      opacity: 1;
    }
    .list-view[hidden] { 
      display: none !important; 
    }

    .list-header { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin-bottom: 16px; 
      padding: 24px 16px 0;
      position: sticky;
      top: 0;
      /* ä¸ä¸»èƒŒæ™¯ç»Ÿä¸€ï¼Œæ— åº•è¾¹çº¿ */
      background: var(--bg);
      border-bottom: none;
      box-shadow: none;
      z-index: 10;
    }
    .back-btn {
      appearance: none; border: none; 
      background: #ffffff; 
      border-radius: 8px; padding: 8px 16px; cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
      border: 1px solid #d0d7de; 
      font-weight: 600; color: #24292f;
      transition: all 150ms ease;
    }
    .back-btn:hover { 
      background: #f6f8fa;
      border-color: #8c959f;
    }
    .list-title { 
      font-size: 20px; 
      font-weight: 600; 
      color: #24292f; 
      letter-spacing: -0.01em; 
    }

    /* æ’è¡Œæ¦œåˆ‡æ¢æ ‡ç­¾é¡µ */
    .ranking-header-tabs {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }
    .ranking-tab {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface-0);
      color: var(--text-2);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .ranking-tab:hover {
      background: var(--surface-1);
      border-color: var(--border-hover);
    }
    .ranking-tab.active {
      background: var(--brand-600);
      color: var(--text-on-accent);
      border-color: var(--brand-600);
    }
    .ranking-tab.active:hover {
      background: var(--brand-700);
      border-color: var(--brand-700);
    }

    /* æ’è¡Œæ¦œæ ‡é¢˜æ ·å¼ */
    .ranking-title {
      text-align: center;
      margin-bottom: 24px;
    }
    .ranking-title h2 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-1);
      margin: 0 0 4px 0;
      letter-spacing: -0.02em;
    }
    .ranking-subtitle {
      font-size: 14px;
      color: var(--text-2);
      margin: 0;
      font-weight: 500;
    }

    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 12px;
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      padding: 0 16px 32px;
    }
    .stu-card {
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #d0d7de;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      padding: 16px;
      display: flex; flex-direction: column; gap: 8px;
      transition: transform 150ms ease, box-shadow 150ms ease;
      opacity: 0;
      transform: translateY(20px);
      animation: slideInUp 300ms ease forwards;
      will-change: transform; /* ä¼˜åŒ–åŠ¨ç”»æ€§èƒ½ */
    }
    /* ç§»åŠ¨ç«¯ï¼šå»é™¤é€é¡¹å»¶è¿Ÿï¼Œæå‡ç‚¹å‡»å“åº”é€Ÿåº¦ */
    @media (max-width: 640px) {
      .stu-card { 
        animation-delay: 0ms !important; 
        animation-duration: 150ms !important; 
        touch-action: manipulation; 
      }
      .list-view { transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1); }
    }
    .stu-card:hover { 
      transform: translateY(-1px); 
      box-shadow: 0 3px 12px rgba(0,0,0,0.1);
      border-color: #8c959f;
    }

    /* æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘é‡ç»˜ */
    .stu-card, .ranking-item, .ranking-row, .info-card, .status-card {
      contain: layout;
    }
    
    @keyframes slideInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .stu-line1 { display: flex; align-items: center; gap: 8px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-dot.active { background: #22c55e; }
    .status-dot.offline { background: #9ca3af; }
    .status-dot.attendance { background: #22c55e; } /* å‡ºå‹¤ - ç»¿è‰² */
    .status-dot.absent { background: #ef4444; } /* ç¼ºå‹¤ - çº¢è‰² */
    .status-dot.self-practice { background: #f59e0b; } /* è‡ªä¸»ç»ƒç´ - æ©™è‰² */
    .status-dot.not-practice { background: #3b82f6; } /* æœªç»ƒç´ - è“è‰² */
    .stu-name { 
      font-weight: 600; 
      color: #24292f; 
      font-size: 15px; 
      letter-spacing: -0.005em; 
    }
    .stu-meta { 
      color: #656d76; 
      font-size: 13px; 
      font-weight: 500; 
    }
    .stu-mins { 
      margin-top: 2px; 
      font-weight: 700; 
      color: #24292f; 
      font-size: 18px; 
      letter-spacing: -0.01em; 
    }
    .stu-detail {
      color: #656d76;
      font-size: 11px;
      font-weight: 500;
      margin-top: 1px;
    }

    /* è¯¦æƒ…é¡µé¢æ ·å¼ */
    .detail-view {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      z-index: 200;
      transform: translateX(100%);
      transition: transform 400ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .detail-view.active {
      transform: translateX(0);
    }
    
    .detail-view[hidden] { 
      display: none !important; 
    }

    .detail-container {
      flex: 1;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    .detail-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 24px 16px 16px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .detail-title {
      font-size: 20px;
      font-weight: 600;
      color: #24292f;
      letter-spacing: -0.01em;
    }

  .detail-content { padding: 12px 16px 32px; display: flex; flex-direction: column; gap: var(--gap-md); }
  @media (max-width: 560px){ .detail-content { padding-top: 16px; } }

    /* ä¸ªäººä¿¡æ¯å¡ç‰‡ */
    .info-card, .status-card, .timeline-card, .history-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: var(--card-pad);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: box-shadow .2s ease, transform .15s ease, border-color .2s ease;
    }
    .info-card:hover, .status-card:hover, .timeline-card:hover, .history-card:hover {
      box-shadow: var(--shadow-strong);
      transform: translateY(-1px);
      border-color: var(--border-strong);
    }

  .student-info h2 { font-size: 28px; font-weight: 700; color: var(--text); margin: 0 0 4px 0; letter-spacing: -0.02em; }

  .student-meta { display: flex; align-items: center; gap: 8px; font-size: 16px; color: var(--text-muted); font-weight: 500; }

    .separator {
      color: #d0d7de;
    }

    /* å­¦ç”Ÿè¯¦æƒ…å¤´éƒ¨å³ä¾§ï¼šä»Šæ—¥æ’è¡Œæ¦œåˆ†å¾½ç«  */
    .info-head { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .today-score {
      display: inline-flex; align-items: center; gap: 10px;
      padding: 10px 12px;
      background: linear-gradient(135deg, var(--brand-600), var(--brand-700));
      color: var(--text-on-accent);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.28);
      box-shadow: 0 6px 18px rgba(2,6,23,0.18);
      white-space: nowrap;
    }
    .today-score-label { font-size: 12px; font-weight: 700; opacity: .92; letter-spacing: .02em; }
    .today-score-value { font-size: 22px; font-weight: 800; letter-spacing: -.02em; line-height: 1; }
    @media (prefers-color-scheme: light){
      .today-score { border-color: rgba(255,255,255,0.35); }
    }
    @media (max-width: 480px){
      .info-head { flex-direction: column; align-items: flex-start; gap: 10px; }
      .today-score { align-self: stretch; justify-content: space-between; width: 100%; }
    }

    /* çŠ¶æ€å¡ç‰‡ */
    .status-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

  .status-card h3, .timeline-card h3, .history-card h3 { font-size: 18px; font-weight: 600; color: var(--text); margin: 0 0 16px 0; letter-spacing: -0.01em; }

  .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--gap-md); }

  .status-item { position: relative; text-align: center; padding: 16px 12px; background: var(--surface-muted); border-radius: var(--radius-md); border: 1px solid var(--border); transition: background .2s ease, border-color .2s ease, transform .15s ease; }
  .status-item:hover { background: #eef2ff; border-color: #c7d2fe; transform: translateY(-1px); }

  .status-label { display: block; font-size: 12px; color: var(--text-muted); font-weight: 600; margin-bottom: 6px; letter-spacing: .02em; text-transform: uppercase; }

  .status-value { display: block; font-size: 20px; font-weight: 700; color: var(--text); letter-spacing: -0.01em; }

  .status-help-btn { 
    position: absolute; 
    top: 8px; 
    right: 8px; 
    width: 18px; 
    height: 18px; 
    border: none; 
    background: var(--primary); 
    color: white; 
    border-radius: 50%; 
    font-size: 11px; 
    font-weight: 600; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: all 0.2s ease; 
    opacity: 0.7; 
  }
  
  .status-help-btn:hover { 
    opacity: 1; 
    transform: scale(1.1); 
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3); 
  }

    /* æ—¶é—´è½´å¡ç‰‡ */
    .timeline-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

  /* æ—¶é—´è½´æ ‡é¢˜è¡Œï¼šå·¦æ ‡é¢˜ + å³ä¾§æ“ä½œæŒ‰é’® */
  .timeline-head { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px; }
  .timeline-actions { display: inline-flex; align-items: center; gap: 8px; }
  .timeline-head h3 { margin: 0; }

    .timeline-card h3 {
      font-size: 18px;
      font-weight: 600;
      color: #24292f;
      margin: 0 0 16px 0;
      letter-spacing: -0.01em;
    }

    .timeline-container {
      position: relative;
    }

  .timeline-item { display: flex; align-items: center; gap: 12px; padding: 12px 10px 12px 16px; border-left: 3px solid var(--border); margin-left: 8px; position: relative; border-radius: var(--radius-sm); }
  .timeline-item:hover { background: #f9fafb; }

  .timeline-item::before { content: ''; position: absolute; left: -6px; top: 18px; width: 8px; height: 8px; border-radius: 50%; background: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,.15); }

  .timeline-item.in-schedule::before { background: var(--success); box-shadow: 0 0 0 3px rgba(34,197,94,.15); }
  .timeline-item.out-schedule::before { background: var(--warning); box-shadow: 0 0 0 3px rgba(245,158,11,.15); }

  .timeline-time { font-size: 14px; font-weight: 700; color: var(--text); min-width: 120px; letter-spacing: -0.01em; }

  .ongoing-indicator {
    color: #666;
    font-weight: 500;
  }

  .timeline-duration { font-size: 14px; color: var(--text-muted); font-weight: 600; }
  
  .live-duration {
    color: var(--text-muted);
    font-weight: 600;
  }
  
  .live-indicator {
    margin-left: 2px;
    font-size: 12px;
  }

  .timeline-room { 
    font-size: 12px !important; 
    color: #3b82f6 !important; 
    background: #eef2ff !important; 
    padding: 2px 8px !important; 
    border-radius: 6px !important; 
    font-weight: 600 !important; 
    border: 1px solid #c7d2fe !important; 
    display: inline-block !important;
    margin-left: 8px !important;
    vertical-align: middle !important;
  }
  
  /* å¼ºåˆ¶æ ·å¼ - æµ‹è¯•ç”¨ */
  div[class*="timeline-room"] {
    background: #eef2ff !important;
    border: 2px solid #c7d2fe !important;
    color: #3b82f6 !important;
    padding: 4px 10px !important;
    border-radius: 8px !important;
    font-weight: bold !important;
    font-size: 12px !important;
    display: inline-block !important;
  }
  
  /* æ·±è‰²æ¨¡å¼ä¸‹çš„å¼ºåˆ¶æ ·å¼ */
  @media (prefers-color-scheme: dark) {
    div[class*="timeline-room"] {
      background: rgba(74, 141, 240, 0.12) !important;
      border: 2px solid rgba(74, 141, 240, 0.25) !important;
      color: #6b9cfc !important;
    }
  }
  
  html[data-theme="dark"] div[class*="timeline-room"] {
    background: rgba(74, 141, 240, 0.12) !important;
    border: 2px solid rgba(74, 141, 240, 0.25) !important;
    color: #6b9cfc !important;
  }
  
  /* ğŸš€ æ—¶é—´è½´å¢é‡æ›´æ–°åŠ¨ç”» */
  @keyframes timelineFadeIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  @keyframes timelineFadeOut {
    from { opacity: 1; transform: translateX(0); }
    to { opacity: 0; transform: translateX(20px); }
  }
  .timeline-item-new {
    background: rgba(34, 197, 94, 0.1);
    border-left-color: #22c55e !important;
  }
  
  /* ğŸ”® ä¹è§‚æ›´æ–°åŠ¨ç”» */
  @keyframes confirmUpdate {
    0% { background: rgba(245, 158, 11, 0.1); }
    50% { background: rgba(34, 197, 94, 0.2); }
    100% { background: transparent; }
  }
  @keyframes rollbackUpdate {
    0% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(0.8); }
  }
  @keyframes statUpdate {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); color: #22c55e; }
    100% { transform: scale(1); }
  }
  
  /* ğŸ”® å¤šè¡¨é¢„æµ‹çŠ¶æ€æ ·å¼ */
  .timeline-item[data-optimistic],
  .student-card[data-optimistic],
  .modal-content [data-optimistic] {
    border-left: 3px solid #f59e0b !important;
    background: rgba(245, 158, 11, 0.1) !important;
    position: relative;
  }
  
  .timeline-item[data-optimistic]::after {
    content: 'é¢„æµ‹ä¸­';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    color: #f59e0b;
    font-weight: 600;
    background: rgba(245, 158, 11, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid #f59e0b;
  }
  
  .student-card[data-optimistic]::after {
    content: 'æ›´æ–°ä¸­';
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 10px;
    color: #f59e0b;
    font-weight: 600;
    background: rgba(245, 158, 11, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid #f59e0b;
  }
  
  .optimistic-indicator {
    display: inline-block;
    animation: pulse 1.5s infinite;
    margin-left: 4px;
  }
  
  .archived-badge {
    position: absolute;
    top: 0;
    right: 0;
    background: #dc2626;
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 0 0 0 8px;
    font-weight: 600;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  /* ğŸ¨ UIæ›´æ–°åŠ¨ç”» */
  @keyframes cardUpdate {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); background: rgba(34, 197, 94, 0.1); }
    100% { transform: scale(1); }
  }
  
  @keyframes textUpdate {
    0% { color: #f59e0b; }
    100% { color: inherit; }
  }
  
  .slots-indicator {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 12px;
    background: rgba(34, 197, 94, 0.1);
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #22c55e;
  }
  
  .student-card.archived {
    filter: grayscale(0.7);
  }

    .timeline-empty {
      text-align: center;
      padding: 32px;
      color: #656d76;
      font-size: 16px;
    }

    /* å†å²æ€»ç»“å¡ç‰‡ */
  /* .history-card inherits card styles */

    .history-card h3 {
      font-size: 18px;
      font-weight: 600;
      color: #24292f;
      margin: 0 0 16px 0;
      letter-spacing: -0.01em;
    }

    /* å‘¨ç»ƒç´å›¾è¡¨ */
    .week-chart {
      padding-top: 20px;
    }

  .chart-container { display: flex; align-items: end; gap: 10px; height: 130px; padding: 0 8px; }

    .chart-bar {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
  cursor: pointer;
    }

    .bar-container {
      width: 100%;
      height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: end;
      align-items: center;
      position: relative;
    }

  .bar-fill { width: 18px; background: linear-gradient(to top, var(--primary-700) 0%, var(--primary) 100%); border-radius: 5px 5px 0 0; transition: height 500ms ease; min-height: 2px; }

  .bar-label { font-size: 12px; color: var(--text-muted); font-weight: 600; letter-spacing: .02em; }

  .bar-value { font-size: 10px; color: var(--text); font-weight: 700; position: absolute; top: -16px; white-space: nowrap; }

    /* äº¤äº’ä¸æç¤º */
    .chart-bar:hover .bar-fill { filter: brightness(1.06); }
    .bar-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translate(-50%, -6px);
      background: #111827;
      color: #fff;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 10px;
      line-height: 1.4;
      white-space: nowrap;
      box-shadow: 0 8px 24px rgba(140,149,159,0.2);
      opacity: 0;
      pointer-events: none;
      transition: opacity 150ms ease, transform 150ms ease;
    }
    .chart-bar.show-tooltip .bar-tooltip {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -10px);
    }

    /* å®Œæ•´æ’è¡Œæ¦œæ ·å¼ - ç®€æ´ä¸“ä¸š */
  .ranking-root { max-width: 1200px; margin: 0 auto; padding: 0 24px; }
  @media (max-width: 640px){ .ranking-root { padding: 0 16px; } }
    .ranking-hero {
      background: linear-gradient(135deg, #f8fafc, #ffffff);
      color: #1e293b;
      border-radius: 20px;
      border: 1px solid #e2e8f0;
      padding: 24px 20px 18px;
      margin: 16px 0 20px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.04), 0 1px 2px rgba(15,23,42,0.06);
    }
    .ranking-hero-sub { opacity: .85; margin-top: 6px; font-weight: 500; color: #64748b; font-size: 14px; }

  .top3-wrap { display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px; margin-top: 20px; align-items: end; }
  .top3-card { position: relative; background: #ffffff; color: #1e293b; border-radius: 16px; padding: 20px 18px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(15,23,42,0.06); text-align: center; transition: transform .2s ease, box-shadow .25s ease; cursor: pointer; }
    .top3-card.first-place { transform: translateY(-16px); box-shadow: 0 4px 12px rgba(15,23,42,0.08); }
    .top3-card.second-place { transform: translateY(6px); }
    .top3-card.third-place { transform: translateY(6px); }
    .top3-card:hover { box-shadow: 0 6px 20px rgba(15,23,42,0.12); }
  .top3-name { font-weight: 600; font-size: 16px; margin-top: 8px; letter-spacing: -0.01em; color: #1e293b; }
  .top3-points { font-size: 13px; color: #64748b; font-weight: 600; margin-top: 8px; }
  .rank-badge { position: absolute; top: -12px; right: -10px; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #ffffff; border: 3px solid #ffffff; box-shadow: 0 2px 8px rgba(15,23,42,0.12); }
  .rank-1 { background: linear-gradient(135deg,#f59e0b,#d97706); }
  .rank-2 { background: linear-gradient(135deg,#6b7280,#4b5563); }
  /* unify rank-3 color with list badge (bronze) */
  .rank-3 { background: linear-gradient(135deg,#cd7f32,#b8860b); }

  .ranking-section { padding: 12px 0 32px; }
  .ranking-rows { display: flex; flex-direction: column; gap: 12px; }
  .ranking-row { display: grid; grid-template-columns: 52px 1fr 130px; align-items: center; gap: 16px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 14px; padding: 16px 18px; box-shadow: 0 1px 3px rgba(15,23,42,0.04); transition: background .2s ease, box-shadow .25s ease, transform .15s ease, border-color .2s ease; cursor: pointer; }
  .ranking-row:hover { background: #f8fafc; box-shadow: 0 2px 8px rgba(15,23,42,0.08); border-color: #cbd5e1; }
  .rank-num { font-weight: 700; color: #64748b; text-align: center; font-size: 16px; }
  .row-user { display: flex; align-items: center; gap: 12px; min-width: 0; }
  .row-name { font-weight: 600; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 15px; }
  .row-points { text-align: right; font-weight: 700; color: #1e293b; font-size: 15px; }

    @media (prefers-reduced-motion: reduce) { 
      .bin-card, .back-btn, .detail-view, .bar-fill { 
        transition: none !important; 
      } 
    }

    /* ===== è¯„åˆ†è¯¦æƒ…æŒ‰é’®å’Œæ¨¡æ€æ¡†æ ·å¼ ===== */
    .score-detail-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      background: #f1f5f9;
      color: #3b82f6;
      font-size: 12px;
      font-weight: 600;
      line-height: 1;
      cursor: pointer;
      padding: 0;
      margin-left: 8px;
      transition: all 0.2s ease;
    }
    
    .score-detail-btn:hover {
      background: #3b82f6;
      color: #ffffff;
      border-color: #3b82f6;
      transform: scale(1.08);
      box-shadow: 0 2px 8px rgba(59,130,246,0.25);
    }
    
    .score-detail-btn:active {
      transform: scale(0.95);
    }

    /* è¯„åˆ†è¯¦æƒ…æ¨¡æ€æ¡† */
    .score-detail-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.45);
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.18s ease;
      backdrop-filter: blur(2px);
    }
    
    .score-detail-modal.show {
      opacity: 1;
    }
    
    .score-detail-content {
      background: #1f2429;
      color: #f0f6fc;
      border: 1px solid #30363d;
      border-radius: 14px;
      box-shadow: 0 12px 36px rgba(0,0,0,0.45);
      padding: 18px 20px 20px;
      width: min(480px, 90vw);
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      font-size: 13px;
      line-height: 1.55;
      animation: scoreModalIn 0.22s cubic-bezier(0.32, 0.72, 0.33, 1);
    }

    @keyframes scoreModalIn {
      from {
        opacity: 0;
        transform: translateY(6px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .score-detail-close {
      position: absolute;
      top: 8px;
      right: 10px;
      background: transparent;
      border: none;
      color: #8b949e;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 2px;
      border-radius: 6px;
    }
    
    .score-detail-close:hover {
      color: #fff;
      background: rgba(255,255,255,0.08);
    }

    /* è¯„åˆ†å¡ç‰‡æ ·å¼ */
    .dimension-card {
      background: rgba(255,255,255,0.04);
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      border-left: 3px solid;
    }
    
    .dimension-card.d1 { border-left-color: #1976d2; }
    .dimension-card.d2 { border-left-color: #8e24aa; }
    .dimension-card.d3 { border-left-color: #f57c00; }
    
    .dimension-title {
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .dimension-score {
      font-size: 18px;
      font-weight: 700;
      color: #58a6ff;
    }
    
    .score-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin: 6px 0;
    }
    
    .score-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    
    .score-fill.d1 { background: linear-gradient(90deg, #1976d2, #42a5f5); }
    .score-fill.d2 { background: linear-gradient(90deg, #8e24aa, #ab47bc); }
    .score-fill.d3 { background: linear-gradient(90deg, #f57c00, #ff9800); }

    /* æ—¥é—´æ¨¡å¼é€‚é… */
    @media (prefers-color-scheme: light) {
      .score-detail-content {
        background: #fff;
        color: #1f2937;
        border-color: #e5e7eb;
      }
      
      .score-detail-close {
        color: #6b7280;
      }
      
      .score-detail-close:hover {
        color: #1f2937;
        background: rgba(0,0,0,0.05);
      }
      
      .dimension-card {
        background: rgba(0,0,0,0.02);
      }
      
      .dimension-score {
        color: #1976d2;
      }
      
      .score-bar {
        background: rgba(0,0,0,0.08);
      }
    }

    /* ===== ç»Ÿä¸€å¼¹çª—/å¡ç‰‡/åˆ†åŒºæ ·å¼ï¼ˆä¸“ä¸š Â· ç®€æ´ï¼‰ ===== */
    .lb-modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(17,24,39,.5); backdrop-filter: blur(2px); z-index: 10000; opacity: 0; transition: opacity .2s ease; }
    .lb-modal.show { opacity: 1; }
    .lb-dialog { width: min(760px, 92vw); max-height: 84vh; display: flex; flex-direction: column; background: #0b1220; color: #e5e7eb; border: 1px solid rgba(148,163,184,.25); border-radius: 16px; box-shadow: 0 20px 60px rgba(2,6,23,.5); overflow: hidden; animation: lbIn .22s cubic-bezier(.32,.72,.33,1); }
    .lb-dialog__header { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 14px 16px; border-bottom: 1px solid rgba(148,163,184,.18); background: linear-gradient(180deg, rgba(148,163,184,.06), rgba(148,163,184,0)); }
    .lb-dialog__title { font-size: 16px; font-weight: 700; letter-spacing: .2px; color: #e2e8f0; }
    .lb-dialog__body { padding: 14px 16px 16px; overflow: auto; }
    .lb-dialog__close { appearance: none; background: transparent; border: none; color: #94a3b8; width: 28px; height: 28px; border-radius: 8px; font-size: 18px; line-height: 1; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
    .lb-dialog__close:hover { color: #e2e8f0; background: rgba(148,163,184,.12); }
    @keyframes lbIn { from { opacity: 0; transform: translateY(6px) scale(.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

    /* ç»Ÿä¸€åˆ†åŒºä¸å¡ç‰‡ */
    .lb-section { margin: 10px 0 14px; }
    .lb-section__title { margin: 0 0 8px; font-size: 14px; font-weight: 700; color: #cbd5e1; display: flex; align-items: center; gap: 8px; }
    .lb-section__title span { font-size: 12px; font-weight: 600; color: #60a5fa; background: rgba(56,189,248,.18); padding: 2px 8px; border-radius: 999px; }
    .lb-card { background: rgba(148,163,184,.06); border: 1px solid rgba(148,163,184,.18); border-radius: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(2,6,23,.25); transition: box-shadow .2s ease, transform .15s ease, border-color .2s ease; }
    .lb-card:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(2,6,23,.35); border-color: rgba(148,163,184,.35); }
    .lb-card h4 { margin: 0 0 6px; font-size: 14px; font-weight: 700; color: #e2e8f0; }
    .lb-card p { margin: 0; font-size: 12px; color: #94a3b8; }
  /* æ¸å˜å¡ç‰‡é«˜å¯¹æ¯”æ–‡æœ¬ï¼ˆæµ…è‰²/æ·±è‰²å‡å¼ºåˆ¶ç™½å­—ï¼‰ */
  .lb-card--gradient,
  .lb-card--gradient h1,
  .lb-card--gradient h2,
  .lb-card--gradient h3,
  .lb-card--gradient h4,
  .lb-card--gradient p,
  .lb-card--gradient .lb-kv,
  .lb-card--gradient .lb-kv span,
  .lb-card--gradient .lb-kv strong { color: #ffffff !important; text-shadow: 0 1px 2px rgba(0,0,0,.25); }
  .lb-grid { display: grid; gap: 10px; }
  .lb-grid--1 { grid-template-columns: minmax(0,1fr); }
    .lb-grid--2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .lb-grid--3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .lb-grid--4 { grid-template-columns: repeat(4, minmax(0,1fr)); }
    @media (max-width: 560px){ .lb-grid--3, .lb-grid--4 { grid-template-columns: repeat(2, minmax(0,1fr)); } }

    /* è¯„åˆ†è¯¦æƒ…ç»´åº¦å¡ç‰‡ä¸è¿›åº¦æ¡ç»Ÿä¸€è§†è§‰ */
    .lb-card--d1 { border-left: 3px solid #1976d2; }
    .lb-card--d2 { border-left: 3px solid #8e24aa; }
    .lb-card--d3 { border-left: 3px solid #f59e0b; }
    .lb-kv { display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 12px; color: #94a3b8; }
    .lb-kv strong { color: #e2e8f0; }

    /* è¯¦æƒ…/åˆ—è¡¨ç»Ÿä¸€æ ·å¼ */
    .lb-list { margin: 6px 0 0; padding-left: 18px; color: #94a3b8; font-size: 12px; }
    .lb-list li { margin: 2px 0; }

    /* ç»Ÿä¸€æ˜ç»†æ§ä»¶ */
    .lb-details summary { cursor: pointer; font-size: 12px; color: #94a3b8; }
    .lb-details[open] summary { color: #e2e8f0; }

    /* ğŸŒ™ æ’è¡Œæ¦œè§„åˆ™è¯´æ˜æ·±è‰²æ¨¡å¼ä¼˜åŒ– - è¦†ç›–å†…è”æ ·å¼ */
    /* é€šç”¨æ–‡æœ¬é¢œè‰² */
    .lb-card [style*="color:#475569"],
    .lb-card [style*="color:#1e293b"],
    .lb-card div[style*="color:#475569"],
    .lb-card p[style*="color:#475569"] { color: #cbd5e1 !important; }
    
    .lb-card strong { color: #e2e8f0 !important; }
    
    /* æ ‡é¢˜é¢œè‰²é€‚é… */
    .lb-card h4[style*="color:#2563eb"] { color: #60a5fa !important; }
    .lb-card h4[style*="color:#7c3aed"] { color: #a78bfa !important; }
    .lb-card h4[style*="color:#dc2626"] { color: #f87171 !important; }
    .lb-card h4[style*="color:#059669"] { color: #34d399 !important; }
    
    /* èƒŒæ™¯æ¡†é€‚é… */
    .lb-card [style*="background:#f8fafc"] { background: rgba(148,163,184,.08) !important; }
    .lb-card [style*="background:#ecfdf5"] { background: rgba(16,185,129,.12) !important; }
    .lb-card [style*="background:#fef3c7"] { background: rgba(245,158,11,.15) !important; border-color: rgba(245,158,11,.35) !important; }
    
    /* é»„è‰²è­¦å‘Šæ¡†å†…çš„æ–‡å­— */
    .lb-card [style*="background:#fef3c7"] strong[style*="color:#b45309"] { color: #fbbf24 !important; }
    .lb-card [style*="background:#fef3c7"] div[style*="color:#92400e"] { color: #fde68a !important; }
    
    /* â˜€ï¸ æµ…è‰²æ¨¡å¼ä¼˜åŒ– - ç¡®ä¿æ–‡å­—è¶³å¤Ÿæ¸…æ™°æ˜“è¯» */
    @media (prefers-color-scheme: light) {
      .lb-dialog { background: #ffffff; color: #1e293b; border-color: #e2e8f0; box-shadow: 0 20px 60px rgba(0,0,0,.15); }
      .lb-dialog__header { border-bottom-color: #e2e8f0; background: linear-gradient(180deg, #f8fafc, #ffffff); }
      .lb-dialog__title { color: #0f172a; }
      .lb-dialog__close { color: #64748b; }
      .lb-dialog__close:hover { color: #0f172a; background: #f1f5f9; }
      
      .lb-section__title { color: #0f172a; }
      .lb-section__title span { color: #2563eb; background: rgba(37,99,235,.1); }
      
      .lb-card { background: #f8fafc; border-color: #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
      .lb-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,.12); border-color: #cbd5e1; }
      .lb-card h4 { color: #0f172a; }
      .lb-card p { color: #475569; }
      
      .lb-kv { color: #475569; }
      .lb-kv strong { color: #0f172a; }
      
      .lb-list { color: #475569; }
      
      .lb-details summary { color: #64748b; }
      .lb-details[open] summary { color: #0f172a; }
      
      /* è¦†ç›–æ·±è‰²æ¨¡å¼çš„å†…è”æ ·å¼é€‚é… */
      .lb-card [style*="color:#475569"],
      .lb-card [style*="color:#1e293b"],
      .lb-card div[style*="color:#475569"],
      .lb-card p[style*="color:#475569"] { color: #475569 !important; }
      
      .lb-card strong { color: #0f172a !important; }
      
      /* æ ‡é¢˜é¢œè‰²é€‚é…ï¼ˆæµ…è‰²æ¨¡å¼ä½¿ç”¨æ›´æ·±çš„é¢œè‰²ï¼‰ */
      .lb-card h4[style*="color:#2563eb"] { color: #1d4ed8 !important; }
      .lb-card h4[style*="color:#7c3aed"] { color: #6d28d9 !important; }
      .lb-card h4[style*="color:#dc2626"] { color: #b91c1c !important; }
      .lb-card h4[style*="color:#059669"] { color: #047857 !important; }
      
      /* èƒŒæ™¯æ¡†é€‚é… */
      .lb-card [style*="background:#f8fafc"] { background: #f8fafc !important; }
      .lb-card [style*="background:#ecfdf5"] { background: #ecfdf5 !important; }
      .lb-card [style*="background:#fef3c7"] { background: #fef3c7 !important; border-color: #fbbf24 !important; }
      
      /* é»„è‰²è­¦å‘Šæ¡†å†…çš„æ–‡å­—ï¼ˆæµ…è‰²æ¨¡å¼ä½¿ç”¨æ·±è‰²ï¼‰ */
      .lb-card [style*="background:#fef3c7"] strong[style*="color:#b45309"] { color: #b45309 !important; }
      .lb-card [style*="background:#fef3c7"] div[style*="color:#92400e"] { color: #92400e !important; }
    }
    
    /* æ˜ç¡®å¼ºåˆ¶æµ…è‰²æ¨¡å¼ï¼ˆå½“ data-theme="light" æ—¶ï¼‰ */
    html[data-theme="light"] .lb-dialog { background: #ffffff; color: #1e293b; border-color: #e2e8f0; box-shadow: 0 20px 60px rgba(0,0,0,.15); }
    html[data-theme="light"] .lb-dialog__header { border-bottom-color: #e2e8f0; background: linear-gradient(180deg, #f8fafc, #ffffff); }
    html[data-theme="light"] .lb-dialog__title { color: #0f172a; }
    html[data-theme="light"] .lb-dialog__close { color: #64748b; }
    html[data-theme="light"] .lb-dialog__close:hover { color: #0f172a; background: #f1f5f9; }
    
    html[data-theme="light"] .lb-section__title { color: #0f172a; }
    html[data-theme="light"] .lb-section__title span { color: #2563eb; background: rgba(37,99,235,.1); }
    
    html[data-theme="light"] .lb-card { background: #f8fafc; border-color: #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
    html[data-theme="light"] .lb-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,.12); border-color: #cbd5e1; }
    html[data-theme="light"] .lb-card h4 { color: #0f172a; }
    html[data-theme="light"] .lb-card p { color: #475569; }
    
    /* ğŸ”§ "è®¡ç®—å…¬å¼"ç­‰è§„åˆ™æ–‡å­—åœ¨æµ…è‰²æ¨¡å¼ä¸‹å¿…é¡»æ¸…æ™° */
    html[data-theme="light"] .lb-card .lb-rule-text { color: #0f172a !important; }
    html[data-theme="light"] .lb-card .lb-rule-text strong { color: #0f172a !important; }
    html[data-theme="light"] .lb-card .lb-rule-subtext { color: #64748b !important; }
    
    /* è§„åˆ™æ ‡é¢˜é¢œè‰²é€‚é…ï¼ˆæµ…è‰²æ¨¡å¼ä½¿ç”¨æ›´æ·±çš„é¢œè‰²ï¼‰ */
    html[data-theme="light"] .lb-card .lb-rule-heading-blue { color: #1d4ed8 !important; }
    html[data-theme="light"] .lb-card .lb-rule-heading-purple { color: #6d28d9 !important; }
    html[data-theme="light"] .lb-card .lb-rule-heading-red { color: #b91c1c !important; }
    html[data-theme="light"] .lb-card .lb-rule-heading-green { color: #047857 !important; }
    
    /* è“è‰²è§„åˆ™æ¡†åœ¨æµ…è‰²æ¨¡å¼ä¸‹çš„é€‚é… */
    html[data-theme="light"] .lb-card.lb-rule-box-blue { background: #eff6ff !important; border-color: #93c5fd !important; }
    
    html[data-theme="light"] .lb-kv { color: #475569; }
    html[data-theme="light"] .lb-kv strong { color: #0f172a; }
    
    html[data-theme="light"] .lb-list { color: #475569; }
    
    html[data-theme="light"] .lb-details summary { color: #64748b; }
    html[data-theme="light"] .lb-details[open] summary { color: #0f172a; }
    
    html[data-theme="light"] .lb-card [style*="color:#475569"],
    html[data-theme="light"] .lb-card [style*="color:#1e293b"],
    html[data-theme="light"] .lb-card div[style*="color:#475569"],
    html[data-theme="light"] .lb-card p[style*="color:#475569"] { color: #475569 !important; }
    
    html[data-theme="light"] .lb-card strong { color: #0f172a !important; }
    
    html[data-theme="light"] .lb-card h4[style*="color:#2563eb"] { color: #1d4ed8 !important; }
    html[data-theme="light"] .lb-card h4[style*="color:#7c3aed"] { color: #6d28d9 !important; }
    html[data-theme="light"] .lb-card h4[style*="color:#dc2626"] { color: #b91c1c !important; }
    html[data-theme="light"] .lb-card h4[style*="color:#059669"] { color: #047857 !important; }
    
    html[data-theme="light"] .lb-card [style*="background:#f8fafc"] { background: #f8fafc !important; }
    html[data-theme="light"] .lb-card [style*="background:#ecfdf5"] { background: #ecfdf5 !important; }
    html[data-theme="light"] .lb-card [style*="background:#fef3c7"] { background: #fef3c7 !important; border-color: #fbbf24 !important; }
    
    html[data-theme="light"] .lb-card [style*="background:#fef3c7"] strong[style*="color:#b45309"] { color: #b45309 !important; }
    html[data-theme="light"] .lb-card [style*="background:#fef3c7"] div[style*="color:#92400e"] { color: #92400e !important; }
    
    /* ç»¿è‰²ç†å¿µæ¡†å†…çš„æ–‡å­— */
    .lb-card [style*="background:#ecfdf5"] h4[style*="color:#065f46"] { color: #6ee7b7 !important; }
    .lb-card [style*="background:#ecfdf5"] div[style*="color:#047857"] { color: #a7f3d0 !important; }
    .lb-card [style*="background:#ecfdf5"] div[style*="color:#047857"] strong { color: #d1fae5 !important; }
    
    /* CSSç±»æ–¹å¼ */
    .lb-card .lb-rule-text { color: #cbd5e1 !important; }
    .lb-card .lb-rule-text strong { color: #e2e8f0 !important; }
    .lb-card .lb-rule-heading-blue { color: #60a5fa !important; }
    .lb-card .lb-rule-heading-purple { color: #a78bfa !important; }
    .lb-card .lb-rule-heading-red { color: #f87171 !important; }
    .lb-card .lb-rule-heading-green { color: #34d399 !important; }
    .lb-card .lb-rule-subtext { color: #94a3b8 !important; }
    .lb-card.lb-rule-box-blue { background: rgba(59,130,246,.12) !important; border-color: rgba(59,130,246,.3) !important; }

    /* ç»Ÿä¸€æµ…è‰²æ¨¡å¼ */
    @media (prefers-color-scheme: light){
      .lb-dialog { background: #ffffff; color: #0f172a; border-color: #e5e7eb; box-shadow: 0 20px 60px rgba(15,23,42,.15); }
      .lb-dialog__header { border-color: #e5e7eb; background: linear-gradient(180deg,#f8fafc,#ffffff); }
      .lb-dialog__title { color: #0f172a; }
      .lb-dialog__close { color: #64748b; }
      .lb-dialog__close:hover { color: #0f172a; background: rgba(2,6,23,.06); }
      .lb-card { background: #ffffff; border-color: #e5e7eb; box-shadow: 0 1px 2px rgba(16,24,40,.06); }
      .lb-card:hover { box-shadow: 0 6px 14px rgba(16,24,40,.12); }
      .lb-card h4 { color: #0f172a; }
      .lb-card p, .lb-list { color: #475569; }
      .lb-section__title { color: #0f172a; }
      
      /* ğŸ”§ "è®¡ç®—å…¬å¼"ç­‰è§„åˆ™æ–‡å­—åœ¨æµ…è‰²æ¨¡å¼ä¸‹å¿…é¡»æ¸…æ™° */
      .lb-card .lb-rule-text { color: #0f172a !important; }
      .lb-card .lb-rule-text strong { color: #0f172a !important; }
      .lb-card .lb-rule-subtext { color: #64748b !important; }
      
      /* è§„åˆ™æ ‡é¢˜é¢œè‰²é€‚é…ï¼ˆæµ…è‰²æ¨¡å¼ä½¿ç”¨æ›´æ·±çš„é¢œè‰²ï¼‰ */
      .lb-card .lb-rule-heading-blue { color: #1d4ed8 !important; }
      .lb-card .lb-rule-heading-purple { color: #6d28d9 !important; }
      .lb-card .lb-rule-heading-red { color: #b91c1c !important; }
      .lb-card .lb-rule-heading-green { color: #047857 !important; }
      
      /* è“è‰²è§„åˆ™æ¡†åœ¨æµ…è‰²æ¨¡å¼ä¸‹çš„é€‚é… */
      .lb-card.lb-rule-box-blue { background: #eff6ff !important; border-color: #93c5fd !important; }
      
  /* æå‡æµ…è‰²æ¨¡å¼ä¸‹åˆ†ç±»å¾—åˆ†å¯è¯»æ€§ */
  .lb-kv { color: #64748b; }
  .lb-kv strong { color: #0f172a; }
  /* æ˜ç»† summary åœ¨æµ…è‰²æ¨¡å¼ä¸‹çš„å¯è¯»æ€§ */
  .lb-details summary { color: #64748b; }
  .lb-details[open] summary { color: #0f172a; }
    }
    /* è½»é‡æç¤ºï¼ˆToastï¼‰ */
    .lb-toast { position: fixed; left: 50%; bottom: 26px; transform: translateX(-50%) translateY(8px); z-index: 20000; pointer-events: none; opacity: 0; transition: opacity .18s ease, transform .18s ease; background: rgba(15,23,42,.92); color: #e5e7eb; border: 1px solid rgba(148,163,184,.28); border-radius: 12px; box-shadow: 0 8px 28px rgba(2,6,23,.45); padding: 10px 14px; font-size: 14px; font-weight: 600; letter-spacing: .01em; }
    .lb-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    @media (prefers-color-scheme: light){
      .lb-toast { background: rgba(255,255,255,.98); color: #0f172a; border-color: rgba(2,6,23,.08); box-shadow: 0 8px 24px rgba(15,23,42,.15); }
    }
    /* ===== ä¼‘æ¯æ—¶é—´æ˜ç»†æ–°æ ·å¼ ===== */
    .break-summary { background: color-mix(in oklab, var(--brand-600) 4%, var(--surface-1)); border:1px solid var(--border); border-radius:12px; padding:12px 14px; }
    .break-total { font-size:14px; font-weight:600; color: var(--text-1); margin-bottom:8px; }
    .break-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px; }
    .break-row { display:grid; grid-template-columns: 115px 1fr 48px; align-items:center; background: var(--surface-0); padding:6px 10px; border:1px solid var(--border); border-radius:8px; font-size:12px; gap:8px; }
    .break-row .br-time { font-weight:600; letter-spacing:.5px; color: var(--text-1); }
    .break-row .br-type { justify-self:start; padding:2px 8px; border-radius:999px; font-weight:600; font-size:11px; letter-spacing:.5px; background:var(--surface-1); border:1px solid var(--border); color: var(--text-2); }
    .break-row .br-dur { text-align:right; font-weight:600; color: var(--brand-600); }
    /* ç±»å‹è‰²å½©åŒºåˆ† */
    .br-small { background:linear-gradient(135deg,#f1f5f9,#e2e8f0); }
    .br-large { background:linear-gradient(135deg,#fee2e2,#fecaca); border-color:#fca5a5 !important; color:#b91c1c !important; }
    .br-meal { background:linear-gradient(135deg,#fef3c7,#fde68a); border-color:#fcd34d !important; color:#92400e !important; }
    .br-dinner { background:linear-gradient(135deg,#ede9fe,#ddd6fe); border-color:#c4b5fd !important; color:#5b21b6 !important; }
    .break-hint { margin-top:10px; font-size:11px; color: var(--text-3); line-height:1.5; }
    @media (prefers-color-scheme: dark){
      .break-summary { background: color-mix(in oklab, var(--brand-600) 8%, var(--surface-1)); }
      .break-row { background: color-mix(in oklab, var(--surface-0) 90%, black); }
      .br-small { background:linear-gradient(135deg,#1e293b,#334155); color:#e2e8f0 !important; }
      .br-large { background:linear-gradient(135deg,#3f2d2d,#5b3a3a); color:#fecaca !important; }
      .br-meal { background:linear-gradient(135deg,#3a2f17,#5c4420); color:#fde68a !important; }
      .br-dinner { background:linear-gradient(135deg,#2f2a55,#453c7d); color:#ddd6fe !important; }
    }
    /* è®¡ç®—è¿‡ç¨‹ç›’å­ä¸»é¢˜é€‚é… */
    .calc-box { background: var(--surface-0); padding:16px; border-radius:12px; font-size:14px; border:1px solid var(--border); }
    .calc-box .warn { color:#dc2626; }
    .calc-sep { border:none; border-top:1px solid var(--border); margin:12px 0; }
    @media (prefers-color-scheme: dark){
      .calc-box { background: color-mix(in oklab, var(--surface-1) 92%, black); }
    }

    /* ç»´åº¦ä¸‰å¾—åˆ†å±•ç¤ºç»Ÿä¸€æ ·å¼ */
    .d3-item {
      margin: 6px 0;
      padding: 0;
      list-style: none;
    }
    
    .d3-main {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 5px;
    }
    
    .d3-title {
      font-weight: 600;
      color: var(--text-1);
      min-width: 80px;
    }
    
    .d3-result {
      font-weight: 500;
      color: var(--success);
      flex: 1;
    }
    
    .d3-warning {
      font-size: 0.9em;
      color: var(--warning);
      font-weight: 500;
    }
    
    .d3-details {
      background: color-mix(in oklab, var(--brand-500) 3%, var(--surface-1));
      border: 1px solid color-mix(in oklab, var(--brand-500) 8%, var(--border));
      border-radius: var(--radius-md);
      padding: 10px 12px;
      margin-top: 5px;
      font-size: 0.9em;
    }
    
    .d3-explanation {
      margin-bottom: 8px;
    }
    
    .d3-explanation:last-child {
      margin-bottom: 0;
    }
    
    .detail-label {
      display: inline-block;
      font-weight: 600;
      color: var(--brand-600);
      margin-bottom: 4px;
    }
    
    .detail-content {
      margin-left: 6px;
    }
    
    .detail-content-inline {
      color: var(--text-2);
      font-size: 0.9em;
      line-height: 1.3;
      margin-left: 6px;
    }
    
    .detail-line {
      padding: 1px 0;
      margin: 1px 0;
      color: var(--text-2);
      font-size: 0.9em;
      line-height: 1.3;
    }
    
    .d3-calculation {
      border-top: 1px solid color-mix(in oklab, var(--brand-500) 15%, var(--border));
      padding-top: 8px;
    }
    
    .calc-details {
      margin-left: 6px;
    }
    
    .calc-details > div {
      padding: 2px 0;
      color: var(--text-2);
      line-height: 1.4;
    }
    
    .calc-details > div:last-child {
      font-weight: 600;
      color: var(--success);
      background: color-mix(in oklab, var(--success) 8%, transparent);
      border-radius: 4px;
      padding: 4px 6px;
      margin-top: 3px;
    }
    
    /* å‘¨è¿›æ­¥å›¾è¡¨æ ·å¼ */
    .d3-chart {
      border-top: 1px solid color-mix(in oklab, var(--brand-500) 15%, var(--border));
      padding-top: 8px;
      margin-top: 8px;
    }
    
    .chart-title {
      font-weight: 600;
      color: var(--brand-600);
      margin-bottom: 6px;
      font-size: 0.95em;
    }
    
    .d3-chart .sparkline {
      width: 140px;
      height: 34px;
      margin: 6px auto;
      display: block;
    }
    
    .chart-data {
      margin-top: 6px;
      font-size: 0.9em;
    }
    
    .chart-data > div {
      padding: 2px 0;
      margin: 2px 0;
      color: var(--text-2);
      line-height: 1.3;
      font-size: 0.9em;
    }
    
    @media (prefers-color-scheme: dark) {
      .d3-details {
        background: color-mix(in oklab, var(--brand-500) 5%, var(--surface-1));
        border-color: color-mix(in oklab, var(--brand-500) 15%, var(--border));
      }
      
      .d3-title {
        color: var(--text-1) !important;
      }
      
      .d3-result {
        color: var(--success) !important;
      }
      
      .detail-label {
        color: var(--brand-500) !important;
      }
      
      .detail-content-inline {
        color: var(--text-2) !important;
      }
      
      .detail-line {
        color: var(--text-2) !important;
      }
      
      .d3-calculation {
        border-top-color: color-mix(in oklab, var(--brand-500) 25%, var(--border));
      }
      
      .d3-chart {
        border-top-color: color-mix(in oklab, var(--brand-500) 25%, var(--border));
      }
      
      .calc-details > div {
        color: var(--text-2) !important;
      }
      
      .calc-details > div:last-child {
        background: color-mix(in oklab, var(--success) 12%, transparent);
        color: var(--success) !important;
      }
      
      .chart-data > div {
        color: var(--text-2) !important;
      }
      
      .chart-title {
        color: var(--brand-500) !important;
      }
      
      /* æ»¡å‹¤åŠ æˆå’Œç®¡ç†å‘˜è°ƒæ•´åœ¨æ·±è‰²æ¨¡å¼ä¸‹çš„é¢œè‰² */
      .bonus-line {
        color: #10b981 !important;
        border-left-color: #10b981 !important;
      }
      
      .admin-line {
        color: #94a3b8 !important;
        border-left-color: #94a3b8 !important;
      }
    }
  </style>
  <!-- ===== Global Design Layer: Tokens + Baseline + Components (Unified) ===== -->
  <style>
    /* Design Tokens (Light) */
    :root {
      /* brand */
      --brand-50:#eef6ff; --brand-100:#daeaff; --brand-200:#b9d6ff; --brand-300:#91bdff;
      --brand-400:#5fa1ff; --brand-500:#3b82f6; --brand-600:#2563eb; --brand-700:#1d4ed8; --brand-800:#1e40af; --brand-900:#1e3a8a;

      /* background & surface & border */
      --bg: #f7f9fc;               /* App background */
      --surface-0:#f1f5f9;         /* Secondary background */
      --surface-1:#ffffff;         /* Card/dialog background */
      --surface-2:#f8fafc;         /* Hero/strip background */
      --border:#e2e8f0;            /* Hairline */

      /* text */
      --text-1:#0f172a;            /* Primary text */
      --text-2:#334155;            /* Secondary */
      --text-3:#64748b;            /* Tertiary */
      --text-on-accent:#ffffff;    /* On brand */

      /* overlay */
      --backdrop: rgba(2, 6, 23, 0.55);

      /* radius */
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 20px;

      /* spacing */
      --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px; --space-5: 20px; --space-6: 24px; --space-8: 32px; --space-10: 40px;

      /* elevation */
      --shadow-1: 0 1px 2px rgba(15, 23, 42, 0.06), 0 1px 1px rgba(15, 23, 42, 0.04);
      --shadow-2: 0 6px 18px rgba(15, 23, 42, 0.08), 0 2px 8px rgba(15, 23, 42, 0.06);

      /* container widths */
      --container-xs: 640px; --container-sm: 768px; --container-md: 1024px; --container-lg: 1200px;

      /* typography */
      --font-sans: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Hiragino Sans GB', 'Noto Sans CJK SC', 'Microsoft YaHei', Arial, 'Helvetica Neue', Helvetica, sans-serif;
      --fs-xs: 12px; --fs-sm: 13.5px; --fs-base: 15px; --fs-md: 16.5px; --fs-lg: 18px; --fs-xl: 20px; --fs-2xl: 24px;
      --lh-tight: 1.2; --lh-base: 1.5; --lh-relaxed: 1.7;

      /* controls */
      --control-sm-h: 30px; --control-md-h: 36px; --control-lg-h: 44px;

      /* motion */
      --ease-1: cubic-bezier(.2,.7,.4,1); --dur-1: 160ms;
    }

    /* Tokens (Dark) - follows system */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg:#0b1220; --surface-0:#0e1627; --surface-1:#0f172a; --surface-2:#111b2e; --border:#22314a;
        --text-1:#e6edf6; --text-2:#c8d2e3; --text-3:#94a3b8;
        --brand-500:#5ea1ff; --brand-600:#4a8df0; --brand-700:#3b78e0;
        --shadow-1: 0 1px 2px rgba(0,0,0,0.35);
        --shadow-2: 0 12px 36px rgba(0,0,0,0.35), 0 2px 10px rgba(0,0,0,0.25);
        --backdrop: rgba(2, 6, 23, 0.7);
      }
    }

    /* Optional manual theme: <html data-theme="dark"> */
    html[data-theme="dark"] {
      --bg:#0b1220; --surface-0:#0e1627; --surface-1:#0f172a; --surface-2:#111b2e; --border:#22314a;
      --text-1:#e6edf6; --text-2:#c8d2e3; --text-3:#94a3b8;
      --brand-500:#5ea1ff; --brand-600:#4a8df0; --brand-700:#3b78e0;
      --shadow-1: 0 1px 2px rgba(0,0,0,0.35);
      --shadow-2: 0 12px 36px rgba(0,0,0,0.35), 0 2px 10px rgba(0,0,0,0.25);
      --backdrop: rgba(2, 6, 23, 0.7);
    }

    /* Baseline overrides (keep structure, unify look) */
    body {
      background: var(--bg) !important;
      color: var(--text-1);
      font-family: var(--font-sans);
      font-size: var(--fs-base);
      line-height: var(--lh-base);
    }

    .container {
      max-width: var(--container-lg) !important;
      padding-inline: var(--space-4) !important;
    }
    @media (max-width: 1024px) { .container { max-width: var(--container-md) !important; } }
    @media (max-width: 800px)  { .container { max-width: var(--container-sm) !important; padding-inline: var(--space-3) !important; } }
    @media (max-width: 640px)  { .container { max-width: var(--container-xs) !important; } }

    /* Headings & text */
    h1,h2,h3,h4 { color: var(--text-1); letter-spacing: -0.01em; line-height: var(--lh-tight); font-weight: 700; }
    h1 { font-size: var(--fs-2xl); }
    h2 { font-size: var(--fs-xl); }
    h3 { font-size: var(--fs-lg); }
    h4 { font-size: var(--fs-md); }
    p  { color: var(--text-2); }
    .text-muted { color: var(--text-3); }

    /* Cards unification: map existing classes to shared skin */
    .overview-card, .ranking-card, .info-card, .status-card, .timeline-card, .history-card, .stu-card, .ranking-row, .top3-card, .card {
      background: var(--surface-1) !important;
      border: 1px solid var(--border) !important;
      border-radius: var(--radius-lg) !important;
      box-shadow: var(--shadow-1) !important;
    }
    /* ä»…éæ¸å˜ç±»çš„ lb-card ä½¿ç”¨ç»Ÿä¸€çš®è‚¤ï¼Œä¿ç•™æ¸å˜å¡ç‰‡åŸæœ‰èƒŒæ™¯ä¸æ— è¾¹æ¡†è®¾è®¡ */
    .lb-card:not(.lb-card--gradient) {
      background: var(--surface-1) !important;
      border: 1px solid var(--border) !important;
      border-radius: var(--radius-lg) !important;
      box-shadow: var(--shadow-1) !important;
    }
    .overview-card, .ranking-card, .info-card, .status-card, .timeline-card, .history-card, .card, .lb-card { padding: var(--space-5) !important; }
    .stu-card { padding: var(--space-4) !important; }

    /* Hero/strips */
    .ranking-hero {
      background: linear-gradient(180deg, var(--surface-2), var(--surface-1)) !important;
      border: 1px solid var(--border) !important;
      border-radius: var(--radius-xl) !important;
      padding: var(--space-6) !important;
      box-shadow: var(--shadow-1) !important;
      color: var(--text-1) !important;
    }

  /* Ensure full ranking view uses the same width as container */
  .ranking-root { width: 100% !important; max-width: var(--container-lg) !important; margin-inline: auto !important; }
  #rankingFullList { width: 100% !important; }
  /* Relax row columns so the score column isn't cramped */
  .ranking-row { grid-template-columns: 64px 1fr 160px !important; }
  @media (max-width: 560px) { .ranking-row { grid-template-columns: 44px 1fr auto !important; } }

    /* Buttons unification */
    .view-details-btn, .ranking-details-btn, .back-btn, .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      height: var(--control-md-h); padding: 0 var(--space-4);
      font-size: var(--fs-sm); font-weight: 600;
      border-radius: var(--radius-md); border: 1px solid var(--border);
      background: var(--surface-1); color: var(--text-1);
      transition: all var(--dur-1) var(--ease-1);
    }
  .btn--sm { height: var(--control-sm-h); padding: 0 var(--space-3); font-size: var(--fs-xs); border-radius: 10px; }
  .btn--lg { height: var(--control-lg-h); padding: 0 var(--space-5); }
  .btn--ghost { background: var(--surface-0); }
  .btn--ghost:hover { background: var(--surface-1); }
    .view-details-btn, .ranking-details-btn { width: 100%; }
    .view-details-btn:hover, .ranking-details-btn:hover, .back-btn:hover, .btn:hover {
      border-color: color-mix(in oklab, var(--brand-600) 30%, var(--border));
      box-shadow: var(--shadow-1);
      transform: translateY(-1px);
    }
    .view-details-btn:active, .ranking-details-btn:active, .back-btn:active, .btn:active { transform: translateY(0); }
    .btn--primary, .view-details-btn.btn--primary { background: var(--brand-600); color: var(--text-on-accent); border-color: transparent; }
    .btn--primary:hover { background: var(--brand-700); color: var(--text-on-accent); }

    /* Score detail icon button keeps accent but adopts sizing */
    .score-detail-btn {
      width: 22px; height: 22px; border-radius: 6px;
      border: 1px solid var(--border); background: var(--surface-0); color: var(--brand-600);
      box-shadow: none; transition: all var(--dur-1) var(--ease-1);
    }
    .score-detail-btn:hover { background: var(--brand-600); color: var(--text-on-accent); border-color: var(--brand-600); box-shadow: 0 2px 8px rgba(59,130,246,0.25); transform: scale(1.06); }

    /* Lists & rows */
    .ranking-row { padding: var(--space-4) var(--space-5) !important; }
    .ranking-row:hover { border-color: color-mix(in oklab, var(--brand-600) 24%, var(--border)) !important; box-shadow: var(--shadow-1) !important; }
    .row-name { color: var(--text-1) !important; font-size: var(--fs-md) !important; }
    .row-points, .rank-num, .ranking-student-name { color: var(--text-1) !important; }
    .ranking-student-meta, .ranking-score-label { color: var(--text-3) !important; }

    /* Modals unify (lb-*) */
    .lb-modal { background: var(--backdrop) !important; }
    .lb-dialog { background: var(--surface-1) !important; border: 1px solid var(--border) !important; border-radius: var(--radius-xl) !important; box-shadow: var(--shadow-2) !important; }
    .lb-dialog__title { color: var(--text-1) !important; }
    .lb-dialog__body { color: var(--text-2) !important; }
    .lb-dialog__close { color: var(--text-3) !important; }
    .lb-dialog__close:hover { color: var(--text-1) !important; }

    /* Grid gap normalization */
    .lb-grid { gap: var(--space-4) !important; }

    /* Detail/list backgrounds unify */
    .list-view, .detail-view { background: var(--bg) !important; }
  .detail-header { background: linear-gradient(180deg, var(--surface-2), var(--surface-1)) !important; border-bottom: 1px solid var(--border); }

    /* Progress circle colors - allow dynamic setting */
    .progress-bg { stroke: color-mix(in oklab, var(--border) 85%, white); }
    /* Remove fixed stroke color to allow dynamic category colors */

    /* Section spacing */
    .section, .ranking-section, .overview-container { margin-bottom: var(--space-6); }

    /* Light/Dark readability helpers */
    .text-on-brand, .on-gradient { color: var(--text-on-accent) !important; text-shadow: 0 1px 0 rgba(0,0,0,.18); }
  </style>
    <!-- Accessibility & Contrast Fixes: enforce readable colors in light/dark -->
    <style>
      /* Primary text surfaces */
      .page-title, .card-title, .detail-title, .stu-name, .status-value,
      .ranking-student-name, .row-name, .row-points, .rank-num,
      .timeline-time, .progress-count, .progress-percentage,
      .lb-dialog__title { color: var(--text-1) !important; }
  /* åˆ—è¡¨æ ‡é¢˜ä¸åˆ†é’Ÿæ•°ï¼ˆä»æœ‰æµ…è‰²ç¡¬ç¼–ç ï¼‰ */
  .list-title, .stu-mins { color: var(--text-1) !important; }

      /* Secondary/tertiary text */
      .page-subtitle, .card-subtitle, .ranking-student-meta, .ranking-score-label,
      .progress-description, .stu-meta, .stu-detail, .status-label,
      .timeline-duration, .bar-label, .ranking-hero-sub,
      .lb-dialog__body, .lb-list, .text-muted { color: var(--text-3) !important; }

      /* Brand accents */
      .ranking-score-value, .bar-tooltip .em { color: var(--brand-600) !important; }
      
      /* Timeline room pill - æ·±è‰²æ¨¡å¼ä¸‹æ›´æŸ”å’Œçš„æ ·å¼ */
      .timeline-room { 
        color: #6b9cfc !important; 
        background: rgba(74, 141, 240, 0.12) !important; 
        border-color: rgba(74, 141, 240, 0.25) !important; 
      }

      /* Inputs & result lists */
      .search-input { color: var(--text-1) !important; background: var(--surface-1) !important; border-color: var(--border) !important; }
      .search-results { background: var(--surface-1) !important; border-color: var(--border) !important; }
      .search-result-item { color: var(--text-1) !important; }
      .search-result-item:hover { background: var(--surface-0) !important; }

  /* Hover rows in both themes */
  .timeline-item:hover { background: var(--surface-0) !important; }
  /* æ’è¡Œåˆ—è¡¨åˆ†éš”çº¿åœ¨æ·±è‰²ä¸‹å¯è§ */
  .ranking-item { border-bottom-color: var(--border) !important; }

      /* Timeline room pill - å·²åœ¨å‰é¢å®šä¹‰ï¼Œè¿™é‡Œåˆ é™¤é‡å¤å®šä¹‰ */

      /* Chart tooltip */
      .bar-tooltip { 
        background: color-mix(in oklab, var(--text-1) 92%, transparent) !important;
        color: var(--surface-1) !important; 
        border: 1px solid color-mix(in oklab, var(--border) 70%, var(--text-1));
        box-shadow: var(--shadow-2);
      }

      /* Additional text elements */
      .card-date, .progress-count-unit, .progress-percentage-symbol { color: var(--text-3) !important; }
      .separator { color: var(--border) !important; }

      /* Category tabs: theme-aware */
      .category-tabs { background: var(--surface-0) !important; }
      .category-tab { color: var(--text-2) !important; }
      .category-tab.active { background: var(--brand-600) !important; color: var(--text-on-accent) !important; box-shadow: 0 2px 8px color-mix(in oklab, var(--brand-600) 35%, transparent) !important; }
      .category-tab:hover:not(.active) { background: var(--surface-0) !important; color: var(--text-1) !important; }

      /* Inputs: focus ring brand-aware */
      .search-input:focus { border-color: var(--brand-600) !important; box-shadow: 0 0 0 3px color-mix(in oklab, var(--brand-600) 20%, transparent) !important; }

      /* Buttons hover on neutral surfaces */
      .back-btn:hover { background: var(--surface-0) !important; }

      /* Status item hover unify */
      .status-item:hover { background: color-mix(in oklab, var(--brand-600) 10%, transparent) !important; border-color: color-mix(in oklab, var(--brand-600) 45%, var(--border)) !important; }

      /* Bars adopt brand gradient */
      .bar-fill { background: linear-gradient(to top, var(--brand-700) 0%, var(--brand-500) 100%) !important; }
  
      /* Ensure ranking hover row background in dark */
      .ranking-row:hover { background: var(--surface-0) !important; }

      /* Top3 åŒºåŸŸåœ¨æ·±è‰²æ¨¡å¼ä¸‹çš„å¯è¯»æ€§ä¿®å¤ */
      .top3-card { background: var(--surface-1) !important; border-color: var(--border) !important; color: var(--text-1) !important; }
      .top3-card:hover { background: var(--surface-2) !important; }
      .top3-name { color: var(--text-1) !important; }
      .top3-points { color: var(--text-3) !important; }
      .ranking-hero-sub { color: var(--text-3) !important; }

      /* Top3 å¡ç‰‡å†…â€œè¯„åˆ†è¯¦æƒ… ?â€æŒ‰é’®å¢å¼ºå¯¹æ¯”åº¦ */
      .top3-card .score-detail-btn {
        color: var(--brand-600) !important;
        border-color: var(--brand-600) !important;
        background: color-mix(in oklab, var(--brand-600) 12%, transparent) !important;
      }
      .top3-card .score-detail-btn:hover {
        background: var(--brand-600) !important;
        color: var(--text-on-accent) !important;
        border-color: var(--brand-600) !important;
        box-shadow: 0 2px 10px rgba(59,130,246,.35) !important;
      }

  /* ç»†èŠ‚è¡¥é½ï¼šæ—§å˜é‡ var(--text) å®šä¹‰çš„æ ‡é¢˜åœ¨æ·±è‰²ä¸‹åæš— */
  .student-info h2,
  .status-card h3,
  .timeline-card h3,
  .history-card h3 { color: var(--text-1) !important; }
  .status-label { color: var(--text-3) !important; }
  .status-value { color: var(--text-1) !important; }

  /* çŠ¶æ€å°å¡é»˜è®¤åº•/è¾¹æ”¹ä¸ºä¸»é¢˜ä»¤ç‰Œï¼Œé¿å…æµ…è‰²ç¡¬ç¼–ç  */
  .status-item { background: var(--surface-0) !important; border-color: var(--border) !important; }

  /* æ’è¡ŒæŒ‰é’®ä¸æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®åœ¨æ·±è‰²ä¸‹ä¿æŒå¯¹æ¯”åº¦ */
  .ranking-details-btn,
  .view-details-btn { background: var(--surface-1) !important; border-color: var(--border) !important; color: var(--text-1) !important; }
  .ranking-details-btn:hover,
  .view-details-btn:hover { border-color: color-mix(in oklab, var(--brand-600) 30%, var(--border)) !important; box-shadow: var(--shadow-1) !important; }

  /* æŒ‡å®šä¸¤ä¸ªä¸»è¦æŒ‰é’®ä¸ºå“ç‰Œè“è‰²å¡«å……ï¼ˆè¦†ç›–ä¸Šé¢çš„ä¸­æ€§åº•è§„åˆ™ï¼‰ */
  #viewDetailsBtn,
  #rankingDetailsBtn { background: var(--brand-600) !important; color: var(--text-on-accent) !important; border-color: transparent !important; }
  #viewDetailsBtn:hover,
  #rankingDetailsBtn:hover { background: var(--brand-700) !important; box-shadow: 0 6px 16px rgba(59,130,246,.35) !important; }
  #viewDetailsBtn:active,
  #rankingDetailsBtn:active { background: var(--brand-800) !important; }

  /* ===== 442è¯„åˆ†è¶‹åŠ¿å›¾æ ·å¼ ===== */
  .trend-card { 
    background: var(--surface-1); 
    border: 1px solid var(--border); 
    border-radius: var(--radius-lg); 
    padding: 20px; 
    margin-top: var(--gap-md); 
  }

  .trend-card h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-1);
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .trend-container {
    position: relative;
    height: 200px;
    background: var(--surface-0);
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    overflow-x: auto;
    overflow-y: hidden;
  }

  .trend-chart {
    width: 100%;
    height: 100%;
  }

  .trend-grid-line {
    stroke: var(--border);
    stroke-width: 1;
    stroke-dasharray: 2,2;
    opacity: 0.5;
  }

  .trend-axis {
    stroke: var(--border);
    stroke-width: 1;
  }

  .trend-line {
    fill: none;
    stroke: var(--brand-600);
    stroke-width: 2.5;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  .trend-point {
    fill: #3b82f6; /* è“è‰² */
    stroke: #ffffff;
    stroke-width: 2;
    cursor: pointer;
    transition: fill 0.2s ease, stroke-width 0.2s ease;
  }

  .trend-point:hover {
    fill: #2563eb; /* æ·±è“è‰² */
    stroke-width: 3;
  }

  .trend-point.today {
    fill: #f59e0b; /* æ©™è‰²ï¼Œä»£è¡¨ä»Šæ—¥ */
    stroke: #ffffff;
    stroke-width: 3;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .trend-label {
    font-size: 11px;
    fill: var(--text-3);
    text-anchor: middle;
    dominant-baseline: central;
  }

  .trend-value-label {
    font-size: 11px;
    fill: var(--text-2);
    text-anchor: end;
    dominant-baseline: central;
  }

  .trend-tooltip {
    position: absolute;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    font-size: 12px;
    color: var(--text-1);
    pointer-events: none;
    z-index: 10;
    opacity: 0;
    transform: translateY(-5px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    box-shadow: var(--shadow-1);
  }

  .trend-tooltip.show {
    opacity: 1;
    transform: translateY(0);
  }

  .trend-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-3);
    font-size: 14px;
  }

  /* æ¯ä¸ªæ•°æ®ç‚¹ç®€åŒ–æ ‡ç­¾ï¼ˆåˆ†æ•° Â· åæ¬¡ï¼‰ */
  .trend-point-mini {
    font-size: 10px;
    fill: var(--text-2);
    text-anchor: middle;
    dominant-baseline: central;
  /* æ–‡æœ¬æè¾¹é¿å…è¢«è¶‹åŠ¿çº¿â€œç©¿è¿‡â€é€ æˆè§†è§‰é‡å  */
  paint-order: stroke fill;
  stroke: var(--surface-1);
  stroke-width: 3;
  pointer-events: none; /* ä¸æŠ¢å  hoverï¼Œé¿å…å½±å“ tooltip */
  }
  .trend-point-mini.today {
    fill: var(--warning);
    font-weight: 700;
  }
  .trend-point-mini .sub { 
    font-size: 9px; 
    fill: var(--text-3); 
    font-weight: 600;
  paint-order: stroke fill;
  stroke: var(--surface-1);
  stroke-width: 2;
  }
  /* === Progress Detail Delta Coloring & Sparkline === */
  .delta { font-weight:600; }
  .delta-pos { color:#16a34a; }
  .delta-neg { color:#dc2626; }
  .delta-zero { color:#64748b; }
  .sparkline { width:140px; height:34px; display:block; margin:6px 0 2px; }
  .spark-prev { stroke:#cbd5e1; fill:none; stroke-width:1.4; vector-effect:non-scaling-stroke; }
  .spark-cur { stroke:#2563eb; fill:none; stroke-width:1.6; vector-effect:non-scaling-stroke; }
  .spark-bg { stroke:#f1f5f9; fill:none; stroke-width:1; }
  .sparkline:hover .spark-cur { stroke:#1d4ed8; }
  
  /* ï¼ˆå·²ç§»é™¤ï¼šåŸ iOS è¾¹ç¼˜å³æ»‘è¿”å›æ‰‹åŠ¿æ ·å¼ï¼‰ */
    </style>
    <!-- Admin FAB style -->
    <style>
      .admin-fab {
        position: fixed; right: 16px; bottom: 84px; z-index: 12000;
        height: 44px; padding: 0 14px; border-radius: 12px;
        border: 1px solid var(--border); background: var(--brand-600);
        color: var(--text-on-accent); font-weight: 700; font-size: 13px;
        box-shadow: var(--shadow-2); cursor: pointer;
        display: inline-flex; align-items: center; gap: 8px;
      }
      .admin-fab:hover { background: var(--brand-700); }
      .admin-fab:active { background: var(--brand-800); transform: translateY(1px); }
    </style>
    
</head>
<body>
  <main class="container">
    <!-- é¦–é¡µï¼šä»Šæ—¥çºµè§ˆ -->
    <section id="homeView" class="home-view">
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="page-header">
        <h1 class="page-title">é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡</h1>
        <p class="page-subtitle">ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ</p>
      </div>

      <!-- æœç´¢åŠŸèƒ½ -->
      <div class="search-section">
        <div class="search-container">
          <span class="search-icon">ğŸ”</span>
          <input 
            type="text" 
            class="search-input" 
            placeholder="æœç´¢å­¦ç”Ÿå§“å..." 
            id="studentSearchInput"
          />
          <div class="search-results" id="searchResults"></div>
        </div>
      </div>

      <!-- æ¦‚è§ˆåŒºåŸŸ -->
      <div class="overview-container">
        <div class="overview-card">
          <!-- å¤´éƒ¨ -->
          <div class="card-header">
            <h1 class="card-title">å®æ—¶æ€»è§ˆ</h1>
            <div class="card-date" id="currentDate">9æœˆ16æ—¥</div>
          </div>

        <!-- åˆ†ç±»æ ‡ç­¾ -->
        <div class="category-tabs">
          <button class="category-tab" data-category="attendance">å‡ºå‹¤</button>
          <button class="category-tab" data-category="absent">ç¼ºå‹¤</button>
          <button class="category-tab" data-category="self-practice">è‡ªä¸»</button>
          <button class="category-tab" data-category="not-practice">æœªç»ƒ</button>
        </div>

        <!-- åœ†å½¢è¿›åº¦å›¾ -->
        <div class="progress-circle">
          <svg viewBox="0 0 160 160">
            <circle 
              class="progress-bg" 
              cx="80" 
              cy="80" 
              r="70"
            />
            <circle 
              id="progressPath"
              class="progress-fill" 
              cx="80" 
              cy="80" 
              r="70"
            />
          </svg>
          <div class="progress-center">
            <div style="white-space: nowrap;">
              <span class="progress-percentage" id="progressPercentage">0</span>
              <span class="progress-percentage-symbol">%</span>
            </div>
          </div>
        </div>

        <!-- è¿›åº¦æ¡ä¸‹æ–¹ä¿¡æ¯ -->
        <div class="progress-info">
          <div class="progress-count">
            <span id="progressCount">0</span>
            <span class="progress-count-unit">äºº</span>
          </div>
          <div class="progress-description" id="progressDescription">
            åœ¨è§„å®šæ—¶é—´æ®µç»ƒç´çš„äººæ•°å æ€»äººæ•°çš„æ¯”ä¾‹
          </div>
        </div>

        <!-- æŸ¥çœ‹è¯¦æƒ…æŒ‰é’® -->
        <button class="view-details-btn btn--primary btn--lg" id="viewDetailsBtn">
          <span>æŸ¥çœ‹è¯¦æƒ…</span>
        </button>
        </div>

        <!-- 442æ’è¡Œæ¦œ -->
        <div class="ranking-card">
          <!-- å¤´éƒ¨ -->
          <div class="card-header">
            <h2 class="card-title">442æ’è¡Œæ¦œ</h2>
            <div class="card-subtitle">æ¯æ—¥ç»ƒç´è´¨é‡æ’å</div>
          </div>

          <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
          <div class="ranking-list" id="rankingList">
            <!-- åŠ¨æ€ç”Ÿæˆæ’è¡Œæ¦œå†…å®¹ -->
          </div>

          <!-- æ’è¡Œè§„åˆ™è¯¦æƒ…æŒ‰é’® -->
          <button class="ranking-details-btn" id="rankingRulesBtn" style="margin-bottom:8px;">
            <span>ğŸ“Š æ’è¡Œè§„åˆ™è¯¦æƒ…</span>
          </button>

          <!-- æŸ¥çœ‹å®Œæ•´æ’è¡Œæ¦œæŒ‰é’® -->
          <button class="ranking-details-btn btn--primary btn--lg" id="rankingDetailsBtn">
            <span>æŸ¥çœ‹å®Œæ•´æ’è¡Œæ¦œ</span>
          </button>
        </div>
      </div>
    </section>

    <!-- åˆ—è¡¨ï¼šå¹³é“ºå­¦ç”Ÿå¡ç‰‡ -->
    <section id="listView" class="list-view" hidden>
      <div class="list-header">
        <button id="backBtn" class="back-btn" aria-label="è¿”å›">â† è¿”å›</button>
        <div class="list-title" id="listTitle">æ­£åœ¨ç»ƒç´</div>
      </div>
      <div id="studentGrid" class="student-grid"></div>
    </section>

    <!-- å®Œæ•´æ’è¡Œæ¦œè§†å›¾ -->
    <section id="rankingView" class="list-view" hidden>
      <div class="ranking-root">
        <div class="list-header">
          <button id="rankingBackBtn" class="back-btn" aria-label="è¿”å›">â† è¿”å›</button>
          <div class="ranking-header-tabs">
            <button id="dailyRankingTab" class="ranking-tab active">æ—¥æ¦œ</button>
            <button id="weeklyRankingTab" class="ranking-tab">å‘¨æ¦œ</button>
          </div>
        </div>
        <div id="rankingFullList"></div>
      </div>
    </section>

    <!-- å­¦ç”Ÿè¯¦æƒ…é¡µé¢ -->
    <section id="detailView" class="detail-view" hidden>
      <div class="detail-container">
        <div class="detail-header">
          <button id="detailBackBtn" class="back-btn" aria-label="è¿”å›">â† è¿”å›</button>
          <div class="detail-title" id="detailTitle">å­¦ç”Ÿè¯¦æƒ…</div>
        </div>
        
        <div class="detail-content">
          <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
          <div class="info-card">
            <div class="info-head">
              <div class="student-info">
                <h2 id="studentName">åŠ²è±ª</h2>
                <div class="student-meta">
                  <span id="studentGrade">2024çº§</span>
                  <span class="separator">Â·</span>
                  <span id="studentMajor">é’¢ç´ä¸“ä¸š</span>
                </div>
              </div>
              <div class="today-score" id="todayScoreBadge" title="ä»Šæ—¥ 442 ç»¼åˆåˆ†">
                <span class="today-score-label">ä»Šæ—¥442åˆ†</span>
                <span class="today-score-value" id="todayScoreValue">--</span>
                <button class="score-detail-btn" id="todayScoreDetailBtn" title="æŸ¥çœ‹è¯„åˆ†è¯¦æƒ…">?</button>
              </div>
            </div>
          </div>

          <!-- å½“å‰çŠ¶æ€å¡ç‰‡ -->
          <div class="status-card">
            <h3>å½“å‰çŠ¶æ€</h3>
            <div class="status-grid">
              <div class="status-item">
                <span class="status-label">ç»ƒç´å¼€å§‹æ—¶é—´</span>
                <span class="status-value" id="currentStartTime">--</span>
              </div>
              <div class="status-item">
                <span class="status-label">å½“å‰æ—¶é•¿</span>
                <span class="status-value" id="currentDuration">--</span>
              </div>
              <div class="status-item">
                <span class="status-label">å½“å‰ç´æˆ¿</span>
                <span class="status-value" id="currentRoom">--</span>
              </div>
              <div class="status-item">
                <span class="status-label">ä»Šæ—¥æ€»è®¡</span>
                <span class="status-value" id="todayTotal">0åˆ†é’Ÿ</span>
                <button class="status-help-btn" id="todayTotalHelpBtn" title="æŸ¥çœ‹æ—¶é—´è®¡ç®—è¯´æ˜">?</button>
              </div>
            </div>
          </div>

          <!-- ä»Šæ—¥æ—¶é—´è½´ -->
          <div class="timeline-card">
            <div class="timeline-head">
              <h3>ä»Šæ—¥ç»ƒç´æ—¶é—´è½´</h3>
              <div class="timeline-actions">
                <button class="btn btn--sm btn--ghost" id="viewWeekSlotsBtn" title="æŸ¥çœ‹æ¯å‘¨æ—¶æ®µ">ğŸ—“ æŸ¥çœ‹å‘¨æ—¶æ®µ</button>
              </div>
            </div>
            <div class="timeline-container" id="todayTimeline">
              <!-- æ—¶é—´è½´å†…å®¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
          </div>

          <!-- å†å²ä¸ƒå¤©æ€»ç»“ -->
          <div class="history-card">
            <h3>è¿‘ä¸ƒå¤©ç»ƒç´æ€»ç»“</h3>
            
            <!-- ä¸ƒå¤©ç»ƒç´æ¡å½¢å›¾ -->
            <div class="week-chart">
              <div class="chart-container" id="weekChart">
                <!-- æ¡å½¢å›¾å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
              </div>
            </div>
          </div>

          <!-- 442è¯„åˆ†è¶‹åŠ¿å›¾ -->
          <div class="trend-card">
            <h3>ğŸ“ˆ 442è¯„åˆ†è¶‹åŠ¿</h3>
            <div class="trend-container" id="trendChart">
              <!-- è¶‹åŠ¿å›¾å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
  // ====================================================================
  // ğŸš€ æ•°æ®åŒæ­¥ä¸è®¢é˜…é…ç½® - å·²å®Œæˆå…¨é¢ä¼˜åŒ–å’ŒéªŒè¯ âœ…
  // ====================================================================
  
  // ï¿½ è¡¨ç»“æ„å®Œæ•´æ€§éªŒè¯ï¼š
  // âœ… practice_logs: [id*, created_at, action*, room_name*, student_name*, timestamp*, location, piano_type, student_major, student_grade, session_start, session_end, practice_duration]
  // âœ… student_database: [id*, name*, major*, grade*, archived, remark, created_at, updated_at] - åªåŒæ­¥æœªå½’æ¡£å­¦ç”Ÿ
  // âœ… student_time_slots: [id*, weekday*, start_time*, end_time*, duration_minutes, created_at, student_name*, updated_at]
  // âœ… rooms: [name*, piano_type, location, remark, heartbeat_at, version, updated_at, occupant_student_name, register_time]
  
  // ğŸ”„ è®¢é˜…é…ç½®éªŒè¯ï¼š
  // âœ… å®æ—¶è®¢é˜…ï¼šç›‘å¬4ä¸ªæ ¸å¿ƒè¡¨çš„æ‰€æœ‰å˜æ›´äº‹ä»¶ï¼ˆINSERT/UPDATE/DELETEï¼‰
  // âœ… æ™ºèƒ½èŠ‚æµï¼šrooms(2s) = practice_logs(2s) > metadata(10s) ä¼˜åŒ–æ—¶é—´è½´å®æ—¶æ€§
  // âœ… æ•°æ®éªŒè¯ï¼šæ¯æ¬¡åŒæ­¥éƒ½è¿›è¡Œå®Œæ•´æ€§æ£€æŸ¥ï¼Œè®°å½•å’Œå¤„ç†ä¸å®Œæ•´æ•°æ®
  // âœ… ç‰ˆæœ¬ç®¡ç†ï¼šåŸºäºå“ˆå¸Œå€¼çš„æ™ºèƒ½å·®å¼‚æ£€æµ‹ï¼Œé¿å…æ— æ•ˆæ›´æ–°
  
  // ğŸ“Š UIæ¸²æŸ“åŒæ­¥éªŒè¯ï¼š
  // âœ… å…¨è¡¨ä¼˜åŒ–ï¼špractice_logs/student_time_slots/rooms/student_database å…¨é¢æ”¯æŒå¢é‡æ›´æ–°+WebSocket+ä¹è§‚é¢„æµ‹
  // âœ… æ’è¡Œæ¦œï¼šåˆ†æ•°å˜åŒ–2ç§’å†…é‡è®¡ç®—ï¼Œ30ç§’æ™ºèƒ½ç¼“å­˜ï¼Œé˜²æŠ–ä¼˜åŒ–
  // âœ… è¯„åˆ†è¯¦æƒ…ï¼šD1/D2/D3ç»´åº¦å®æ—¶æ›´æ–°ï¼Œæ‰£åˆ†é¡¹å®æ—¶åæ˜ 
  // âœ… æ€»è®¡è¯¦æƒ…ï¼šç´¯è®¡æ—¶é•¿ã€æ´»è·ƒç»Ÿè®¡ã€æˆ¿é—´çŠ¶æ€å®æ—¶åŒæ­¥
  // âœ… é¦–é¡µæ¦‚è§ˆï¼šç»ƒç´ä¸­æ•°é‡ã€ä»Šæ—¥æ€»æ—¶é•¿ã€æˆ¿é—´çŠ¶æ€2ç§’å†…åŒæ­¥
  // âœ… å­¦ç”Ÿè¯¦æƒ…ï¼šå½“å‰çŠ¶æ€å®æ—¶æ˜¾ç¤ºï¼Œæ—¶é•¿æ¯30ç§’æ›´æ–°ï¼Œæ’åè·ŸéšåŒæ­¥
  
  // ğŸ› ï¸ è°ƒè¯•å·¥å…·ï¼š
  // âœ… window.checkDataIntegrity() - æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
  // âœ… window.getDataSummary() - æ•°æ®æ¦‚è§ˆç»Ÿè®¡
  // âœ… Ctrl+Shift+D - è¿æ¥è°ƒè¯•é¢æ¿
  
  // ==== å®æ—¶åˆ·æ–°å¢å¼ºé…ç½® ====
  const REALTIME_LOG_THROTTLE_MS = 2000; // åŸ 8s -> 4s -> 2s è¿›ä¸€æ­¥ä¼˜åŒ–æ—¶é—´è½´å®æ—¶æ€§
  const HIDDEN_PAGE_DELAY_MS = 10000;    // åŸéšè—30s -> 10s
  const FALLBACK_POLL_INTERVAL_MS = 60000; // å…œåº•è½®è¯¢ 60s
  let fallbackPollTimer = null;

  // å»é‡è¾…åŠ©: ç»´æŠ¤å·²çŸ¥æ—¥å¿— id é›†åˆ (è‹¥è¡¨æœ‰ id)
  if(!window._knownPracticeLogIds) window._knownPracticeLogIds = new Set();

  function appendPracticeLogIncremental(row){
    if(!row) return false;
    // æ ‡å‡†åŒ–
    const norm = {
      id: row.id,
      student_name: row.student_name || row.student || row.studentName || '',
      room_name: row.room_name || row.room || row.roomName || '',
      action: (row.action||'').toLowerCase(),
      timestamp: row.timestamp,
      session_start: row.session_start || row.start_time || null,
      session_end: row.session_end || row.end_time || null,
      practice_duration: row.practice_duration || row.duration || null
    };
    // åŸºæœ¬å­—æ®µæ ¡éªŒ
    if(!norm.timestamp || !norm.student_name) return false;
    // å¦‚æœæœ‰ id å¹¶å·²å­˜åœ¨åˆ™è·³è¿‡
    if(norm.id && window._knownPracticeLogIds.has(norm.id)) return false;
    if(norm.id) window._knownPracticeLogIds.add(norm.id);

    // è¿½åŠ åˆ°åŸå§‹æ•°ç»„ä¸è§„èŒƒåŒ–æ•°ç»„
    if(!Array.isArray(window.practiceLogsData)) window.practiceLogsData = [];
    window.practiceLogsData.push(row);
    if(!Array.isArray(appState.practiceLogs)) appState.practiceLogs = [];
    appState.practiceLogs.push(row);
    if(!Array.isArray(appState.practiceLogsNormalized)) appState.practiceLogsNormalized = [];
    appState.practiceLogsNormalized.push(norm);

    // è§¦å‘æœ€å° UI æ›´æ–°ï¼šä»…å½“æ—¥æœŸåœ¨æœ€è¿‘ 8 å¤©çª—å£ï¼Œä¸”ä¸åœ¨æ•æ„Ÿæ—¶é—´
    try {
      const ts = new Date(norm.timestamp).getTime();
      const weekAgo = Date.now() - 8*24*3600*1000;
      
      // ğŸ›¡ï¸ æ—¶é—´çª—å£ä¿æŠ¤ï¼šé¿å…åœ¨æ•æ„Ÿæ—¶é—´è§¦å‘æ’è¡Œæ¦œæ›´æ–°
      const now = new Date();
      const minutesSinceMidnight = now.getHours() * 60 + now.getMinutes();
      const isInSensitiveWindow = minutesSinceMidnight < 30 || (minutesSinceMidnight >= 420 && minutesSinceMidnight < 450);
      
      if(ts >= weekAgo && !isInSensitiveWindow){
        // ğŸ”§ ä½¿ç”¨ç»Ÿä¸€çš„æ’è¡Œæ¦œåŒæ­¥ç³»ç»Ÿ
        if (window.__leaderboardSyncSystem) {
          window.__leaderboardSyncSystem.updateAllLeaderboards({ silent: true });
        } else if(typeof debouncedUpdateRanking === 'function') {
          // é™çº§ï¼šä½¿ç”¨æ—§çš„æ›´æ–°æ–¹å¼
          debouncedUpdateRanking();
        }
      }
    }catch(e){ console.warn('å¢é‡æ›´æ–°æ’åå¤±è´¥', e); }
    return true;
  }

  function startFallbackPolling(){
    if(fallbackPollTimer) return;
    fallbackPollTimer = setInterval(()=>{
      if(!navigator.onLine) return;
      
      // ğŸ›¡ï¸ å‘¨æœ«æ¨¡å¼ï¼šå…œåº•è½®è¯¢ä¿æŒè¿è¡Œï¼ˆç”¨äºæ•°æ®åŒæ­¥æ˜¾ç¤ºï¼‰
      // æ³¨æ„ï¼šæ‰€æœ‰æ’è¡Œæ¦œå†™å…¥å‡½æ•°å·²æ·»åŠ å‘¨æœ«ä¿æŠ¤ï¼Œä¸ä¼šæ±¡æŸ“æ•°æ®
      const now = new Date();
      const currentDayOfWeek = now.getDay();
      
      if (currentDayOfWeek === 0 || currentDayOfWeek === 6) {
        console.log('[å‘¨æœ«æ¨¡å¼] å…œåº•è½®è¯¢è¿è¡Œä¸­ï¼ˆä»…åŒæ­¥æ˜¾ç¤ºæ•°æ®ï¼Œæ’è¡Œæ¦œå†™å…¥å·²ç¦ç”¨ï¼‰');
      }
      
      fetchDataWithDiff('practice_logs');
    }, FALLBACK_POLL_INTERVAL_MS);
  }

  startFallbackPolling();

  /**
   * ==============================
   *  è„šæœ¬åŒºï¼ˆJSï¼‰â€” æºç å¯¼è§ˆ
   *  A. å¸¸é‡ä¸é…ç½®ï¼ˆSupabaseã€æ—¶é—´å¸¸é‡ã€ä¼‘æ¯æ—¶é—´ï¼‰
   *  B. å·¥å…·å‡½æ•°ï¼ˆutilsï¼šæ—¶é—´/æ ¼å¼åŒ–/åˆ¤æ–­ï¼‰
   *  C. å…¨å±€çŠ¶æ€ï¼ˆappStateã€è¿æ¥çŠ¶æ€ï¼‰
   *  D. æ•°æ®è·å–ï¼ˆfetchAllDataã€è®¢é˜…ï¼‰
   *  E. æ•°æ®åˆ†æè®¡ç®—ï¼ˆprocessStudentLogsã€calculateDayPracticeTime ç­‰ï¼‰
   *  F. UI æ¸²æŸ“ï¼ˆé¦–é¡µã€åˆ—è¡¨ã€è¯¦æƒ…ã€å›¾è¡¨ï¼‰
   *  G. äº¤äº’ä¸äº‹ä»¶ï¼ˆç‚¹å‡»ã€åˆ‡æ¢ã€æœç´¢ï¼‰
   *  H. åˆå§‹åŒ–ï¼ˆinitializeAppï¼‰
   *  
   *  ğŸš€ æ€§èƒ½ä¼˜åŒ–æ€»ç»“ï¼š
   *  - æ’è¡Œæ¦œæ›´æ–°é˜²æŠ–ä»150mså¢åŠ åˆ°2ç§’
   *  - å®æ—¶ç›‘å¬æ·»åŠ 5ç§’èŠ‚æµæ§åˆ¶
   *  - æ–°å¢30ç§’æ’è¡Œæ¦œç¼“å­˜æœºåˆ¶
   *  - æ•°æ®å˜åŒ–æ£€æµ‹ï¼šåªåœ¨çœŸæ­£å˜åŒ–æ—¶æ›´æ–°
   *  - å‘¨æœ«è·³è¿‡è‡ªåŠ¨åŒæ­¥ï¼Œå‡å°‘ä¸å¿…è¦è¯·æ±‚
   *  - æ·»åŠ æ›´æ–°é¢‘ç‡ç›‘æ§å’Œæ€§èƒ½æŒ‡æ ‡
   * ==============================
   */

  // === è°ƒè¯•æ—¥å¿—ç»Ÿä¸€å…¥å£ ===
  // å°† DEBUG ç½®ä¸º false å¯é™é»˜æ‰€æœ‰ dbg æ—¥å¿—ï¼Œè€Œä¸å½±å“ console.error/warnã€‚
  // âœ… é—®é¢˜å·²ä¿®å¤ï¼Œå…³é—­è°ƒè¯•æ¨¡å¼ä»¥æé«˜æ€§èƒ½
  const DEBUG = true; // ä¸´æ—¶å¼€å¯è°ƒè¯•æ¨¡å¼ï¼ŒæŸ¥çœ‹æˆ¿é—´æ ·å¼é—®é¢˜
  window.DEBUG = DEBUG; // è®¾ç½®ä¸ºå…¨å±€å˜é‡ä»¥ä¾¿å…¶ä»–ä»£ç è®¿é—®
  // æ—¥å¿—èŠ‚æµï¼šæ¯ç§’æœ€å¤šè¾“å‡º MAX_LOGS_PER_SEC æ¡ï¼›è¶…è¿‡çš„åˆå¹¶ä¸ºä¸€æ¡æ‘˜è¦ã€‚
  const MAX_LOGS_PER_SEC = 80; // å®‰å…¨ä¸Šé™ï¼ˆå¯è°ƒï¼‰
  let __logWindowStart = Date.now();
  let __logCount = 0;
  let __logBuffered = 0;
  let __logLastFlushTimer = null;
  function dbg(...args) {
    if (!DEBUG) return;
    const now = Date.now();
    if (now - __logWindowStart >= 1000) {
      // çª—å£æ›´æ–°å‰ï¼Œå¦‚æœæœ‰ç¼“å†²æ‘˜è¦å…ˆè¾“å‡º
      if (__logBuffered) {
        try { console.log(`[DBG][throttled] +${__logBuffered} logs suppressed`); } catch {}
        __logBuffered = 0;
      }
      __logWindowStart = now;
      __logCount = 0;
    }
    if (__logCount < MAX_LOGS_PER_SEC) {
      __logCount++;
      try { console.log('[DBG]', ...args); } catch {}
    } else {
      __logBuffered++;
      // å»¶è¿Ÿåœ¨å½“å‰ç§’ç»“æŸæˆ–ä¸‹ä¸€ä¸ª tick è¾“å‡ºä¸€æ¬¡æ‘˜è¦
      if (!__logLastFlushTimer) {
        __logLastFlushTimer = setTimeout(()=>{
          __logLastFlushTimer = null;
          if (!DEBUG) { __logBuffered = 0; return; }
            if (__logBuffered) {
              try { console.log(`[DBG][throttled] +${__logBuffered} logs suppressed`); } catch {}
              __logBuffered = 0;
            }
        }, Math.max(0, 1000 - (now - __logWindowStart)) + 10);
      }
    }
  }

  /** =============================================
   * æ€§èƒ½åŸºç¡€è®¾æ–½ (æ‰¹å¤„ç† / ç›‘æ§ / Worker é›å½¢)
   * ============================================== */
  // DOM æ‰¹å¤„ç†ï¼šæ”¶é›†ä»»åŠ¡åœ¨ rAF ä¸­é›†ä¸­å†™å…¥ï¼Œé¿å…å¸ƒå±€æŠ–åŠ¨ï¼›é»˜è®¤ 8ms é¢„ç®—ï¼Œå‰©ä½™ä»»åŠ¡ä¸‹ä¸€å¸§ç»§ç»­
  const __domQueue = [];
  let __domFlushScheduled = false;
  function scheduleDOM(task, priority = 1) {
    __domQueue.push({ task, priority, t: Date.now() });
    if (!__domFlushScheduled) {
      __domFlushScheduled = true;
      requestAnimationFrame(flushDOMQueue);
    }
  }
  function flushDOMQueue() {
    const start = performance.now();
    // ç¨³å®šæ’åºï¼ˆä¼˜å…ˆçº§ + ä»»åŠ¡åŠ å…¥é¡ºåºï¼‰
    __domQueue.sort((a, b) => a.priority - b.priority || a.t - b.t);
    while (__domQueue.length) {
      const item = __domQueue.shift();
      try { item.task(); } catch (e) { console.error('[dom-task-error]', e); }
      if (performance.now() - start > 8) break; // è¶…é¢„ç®—ï¼Œç•™åˆ°ä¸‹ä¸€å¸§
    }
    if (__domQueue.length) {
      requestAnimationFrame(flushDOMQueue);
    } else {
      __domFlushScheduled = false;
    }
  }

  // å…¨å±€æ€§èƒ½å¼€å…³ï¼ˆå¯åœ¨æ§åˆ¶å°åŠ¨æ€ä¿®æ”¹ï¼‰
  window.__perfFlags = Object.assign({
    chunkStudentList: true,
    chunkTimeline: true,
    monitorFPS: false,
    instrumentRanking: true,
    instrumentTimeline: true
  }, window.__perfFlags || {});

  // addEventListener è¢«åŠ¨ç›‘å¬å¢å¼ºï¼štouch / wheel é»˜è®¤ passive:trueï¼ˆè‹¥è°ƒç”¨æ–¹éœ€è¦é˜»æ­¢é»˜è®¤éœ€æ˜¾å¼ { passive:false }ï¼‰
  (function enhancePassive() {
    const orig = EventTarget.prototype.addEventListener;
    try {
      EventTarget.prototype.addEventListener = function(type, listener, options) {
        if (options == null) {
          if (type === 'touchstart' || type === 'touchmove' || type === 'wheel') {
            options = { passive: true };
          }
        } else if (typeof options === 'object') {
            if ((type === 'touchstart' || type === 'touchmove' || type === 'wheel') && options.passive === undefined) {
              options.passive = true;
            }
        }
        return orig.call(this, type, listener, options);
      };
    } catch (e) { /* ignore */ }
  })();

  // FPS + Long Task ç›‘æ§ï¼ˆ?perf=1 æ—¶æ˜¾ç¤ºè§’æ ‡ï¼‰
  function startPerfMon() {
    if (window.__perfStarted) return; window.__perfStarted = true;
    const showPanel = location.search.includes('perf=1');
    let fpsEl = null;
    if (showPanel) {
      fpsEl = document.createElement('div');
      fpsEl.textContent = '-- FPS';
      fpsEl.style.cssText = 'position:fixed;left:8px;bottom:8px;z-index:99999;background:rgba(0,0,0,.55);color:#fff;padding:2px 6px;font:12px/1 monospace;border-radius:4px;';
      document.body.appendChild(fpsEl);
    }
    let frames = 0, lastSec = performance.now();
    function loop(now) {
      frames++;
      if (now - lastSec >= 1000) {
        if (fpsEl) fpsEl.textContent = frames + ' FPS';
        frames = 0; lastSec = now;
      }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
    try {
      const po = new PerformanceObserver(list => {
        list.getEntries().forEach(en => {
          if (en.duration > 50 && fpsEl) {
            fpsEl.style.background = 'rgba(220,38,38,.75)';
            clearTimeout(fpsEl.__t); fpsEl.__t = setTimeout(() => fpsEl.style.background = 'rgba(0,0,0,.55)', 700);
          }
        });
      });
      po.observe({ type: 'longtask', buffered: true });
    } catch (e) { /* safari < 16 æ—  longtask */ }
  }
  document.addEventListener('DOMContentLoaded', () => startPerfMon(), { once: true });

  // è½»é‡ Worker é›å½¢ï¼šåç»­å¯æ‰©å±•å°†é‡è®¡ç®—/æ’åºè¿ç§»
  let __computeWorker = null;
  function getComputeWorker() {
    if (__computeWorker) return __computeWorker;
    const code = `self.__pending=new Map();self.onmessage=e=>{const {id,type,payload}=e.data;try{if(type==='hash'){let h=0,s=payload||'';for(let i=0;i<s.length;i++){h=(h*131+s.charCodeAt(i))>>>0;}postMessage({id,ok:true,hash:h});}else{postMessage({id,ok:false,reason:'unknown_task'});}}catch(err){postMessage({id,ok:false,error:err.message});}};`;
    const blob = new Blob([code], { type: 'application/javascript' });
    __computeWorker = new Worker(URL.createObjectURL(blob));
    __computeWorker.__wait = new Map();
    __computeWorker.onmessage = ev => { const { id, ...rest } = ev.data || {}; const cb = __computeWorker.__wait.get(id); if (cb) { __computeWorker.__wait.delete(id); cb(rest); } };
    return __computeWorker;
  }
  function workerHash(str) {
    return new Promise(resolve => {
      try {
        const w = getComputeWorker();
        const id = 'h_' + Math.random().toString(36).slice(2);
        w.__wait.set(id, res => resolve(res.hash || 0));
        w.postMessage({ id, type: 'hash', payload: str });
      } catch { resolve(0); }
    });
  }

  // å¯¼å‡ºåˆ°å…¨å±€ä¾¿äºä¸´æ—¶è°ƒè¯•
  window.__perfTools = { scheduleDOM, workerHash };

  // è½»é‡æç¤ºï¼šæ˜¾ç¤º 1.8s åè‡ªåŠ¨éšè—
  function showToast(message) {
    try {
      const el = document.getElementById('lbToast');
      if (!el) { alert(message); return; }
      el.textContent = message;
      el.hidden = false;
      // å¼ºåˆ¶å›æµä»¥åº”ç”¨è¿‡æ¸¡
      void el.offsetWidth;
      el.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => {
        el.classList.remove('show');
        // ç­‰è¿‡æ¸¡ç»“æŸå†éšè—
        setTimeout(() => { el.hidden = true; el.textContent = ''; }, 200);
      }, 1800);
    } catch { /* no-op */ }
  }

    // ==== æ€§èƒ½ä¼˜åŒ–å·¥å…·å‡½æ•° ====
    function debounce(func, wait, immediate) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          timeout = null;
          if (!immediate) func(...args);
        };
        const callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func(...args);
      };
    }

    function throttle(func, limit) {
      let inThrottle;
      return function executedFunction(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }

        // æ™ºèƒ½é˜²æŠ–æœºåˆ¶ï¼šæ ¹æ®é¡µé¢çŠ¶æ€åŠ¨æ€è°ƒæ•´å»¶è¿Ÿ
    const createSmartDebounce = (func, normalDelay, hiddenDelay) => {
      let timeout;
      return function executedFunction(...args) {
        const delay = (!document.hidden) ? normalDelay : hiddenDelay; // ç›´æ¥ä½¿ç”¨ document.hidden
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    };
    
    // é˜²æŠ–å‡½æ•°å°†åœ¨æ‰€æœ‰å‡½æ•°å®šä¹‰ååˆ›å»º
    let debouncedUpdateRanking;
    let debouncedRenderHomeBins;

    // å¢å¼ºç¼“å­˜æœºåˆ¶ï¼šé¿å…é‡å¤è®¡ç®—æ’è¡Œæ¦œ
    let lastRankingUpdateTime = 0;
    let rankingDataCache = null;
    let RANKING_CACHE_DURATION = 30000; // åŠ¨æ€ç¼“å­˜æ—¶é—´ï¼Œå°†åœ¨é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ›´æ–°
    
    // æ•°æ®å˜åŒ–æ£€æµ‹ä¼˜åŒ–
    let lastDataHash = null;
    let consecutiveNoChangeCount = 0; // è¿ç»­æ— å˜åŒ–è®¡æ•°å™¨
    
    // ç½‘ç»œçŠ¶æ€ç›‘å¬
    window.addEventListener('online', () => {
      dbg('ç½‘ç»œå·²è¿æ¥ï¼Œæ£€æŸ¥å®æ—¶è¿æ¥çŠ¶æ€');
      // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿å˜é‡å·²åˆå§‹åŒ–
      setTimeout(() => {
        if (!realtimeChannel && typeof isConnected !== 'undefined' && isConnected) {
          setupRealtime();
        }
      }, 1000);
    });
    
    window.addEventListener('offline', () => {
      dbg('ç½‘ç»œå·²æ–­å¼€ï¼Œè¿›å…¥ç¦»çº¿æ¨¡å¼');
      // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿ setConnectionStatus å‡½æ•°å·²å®šä¹‰
      setTimeout(() => {
        if (typeof setConnectionStatus === 'function') {
          setConnectionStatus('offline', 'ç½‘ç»œç¦»çº¿');
        }
      }, 100);
    });    // ç”Ÿæˆæ•°æ®å“ˆå¸Œå€¼ç”¨äºæ£€æµ‹å˜åŒ–
    function generateDataHash(students) {
      if (!students || !students.size) return '';
      const dataPoints = [];
      students.forEach((student, name) => {
        dataPoints.push(`${name}:${student.todayMinutes.in}:${student.todayMinutes.out}:${student.currentStatus}`);
      });
      // ä¿®å¤ï¼šä½¿ç”¨å®‰å…¨çš„å“ˆå¸Œæ–¹æ³•ï¼Œé¿å…ä¸­æ–‡å­—ç¬¦å¯¼è‡´çš„ btoa é”™è¯¯
      try {
        const dataString = dataPoints.sort().join('|');
        // ä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²å“ˆå¸Œç®—æ³•æ›¿ä»£ btoa
        let hash = 0;
        for (let i = 0; i < dataString.length; i++) {
          const char = dataString.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }
        return hash.toString();
      } catch (e) {
        console.warn('ç”Ÿæˆæ•°æ®å“ˆå¸Œå¤±è´¥:', e);
        return Date.now().toString(); // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ—¶é—´æˆ³
      }
    }

    // ==== é…ç½®å’Œå¸¸é‡ ====
    const SUPABASE_URL = 'https://waesizzoqodntrlvrwhw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhZXNpenpvcW9kbnRybHZyd2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjIyOTYsImV4cCI6MjA3MzM5ODI5Nn0.kE5gSV68q1nLo4z2IqgwqfTBVqNOJw5qs08f6r0SQH0';
  // æ‰‹åŠ¨åŒæ­¥å…¥å£å¼€å…³ï¼šç½®ä¸º false å¯å®Œå…¨ç¦ç”¨æ‰‹åŠ¨è°ƒç”¨å…¥å£ï¼ˆåŒ…æ‹¬æ§åˆ¶å°æ‰‹åŠ¨è§¦å‘ï¼‰
  const ENABLE_MANUAL_SYNC = false;

    // ä¼‘æ¯æ—¶é—´é…ç½® - å‰”é™¤å¤§è¯¾é—´ã€åˆé¤ã€æ™šé¤ç­‰ä¼‘æ¯æ—¶é—´
    const BREAK_SCHEDULE = {
      monTueThuFri: [
        {start: 8*60+50, end: 9*60},      // å¤§è¯¾é—´ 08:50-09:00
        {start: 9*60+50, end: 10*60},     // å¤§è¯¾é—´ 09:50-10:00
        {start: 10*60+50, end: 11*60},    // å¤§è¯¾é—´ 10:50-11:00
        {start: 12*60+10, end: 12*60+40}, // åˆé¤æ—¶é—´ 12:10-12:40ï¼ˆæ›´æ–°ï¼‰
        {start: 13*60+50, end: 14*60},    // å¤§è¯¾é—´ 13:50-14:00
        {start: 14*60+50, end: 15*60+10}, // å¤§è¯¾é—´ 14:50-15:10
        {start: 16*60, end: 16*60+10},    // å¤§è¯¾é—´ 16:00-16:10
        {start: 17*60, end: 17*60+10},    // å¤§è¯¾é—´ 17:00-17:10
        {start: 18*60+10, end: 18*60+40}  // æ™šé¤æ—¶é—´ 18:10-18:40ï¼ˆæ›´æ–°ï¼‰
      ],
      wed: [
        {start: 8*60+50, end: 9*60},      // å¤§è¯¾é—´ 08:50-09:00
        {start: 9*60+50, end: 10*60},     // å¤§è¯¾é—´ 09:50-10:00
        {start: 10*60+50, end: 11*60},    // å¤§è¯¾é—´ 10:50-11:00
        {start: 12*60+10, end: 13*60+20}, // åˆé¤æ—¶é—´ 12:10-13:20ï¼ˆæ›´æ–°ï¼‰
        {start: 14*60+20, end: 14*60+30}, // å¤§è¯¾é—´ 14:20-14:30
        {start: 15*60+20, end: 15*60+40}, // å¤§è¯¾é—´ 15:20-15:40
        {start: 16*60+30, end: 16*60+40}, // å¤§è¯¾é—´ 16:30-16:40
        {start: 17*60+30, end: 17*60+40}, // å¤§è¯¾é—´ 17:30-17:40
        {start: 18*60+40, end: 19*60+10}  // æ™šé¤æ—¶é—´ 18:40-19:10ï¼ˆæ›´æ–°ï¼‰
      ]
    };

  /**
   * é»˜è®¤â€œè§„å®šæ—¶é—´æ®µå†…â€çš„çª—å£ï¼ˆå½“å­¦ç”Ÿæœªé…ç½®ä¸ªæ€§åŒ–æ—¶æ®µæ—¶ä½¿ç”¨ï¼‰
   */
  // å…è®¸ç»Ÿè®¡çª—å£ï¼ˆæ’é™¤ 21:30-æ¬¡æ—¥07:30ï¼‰ã€‚éœ€æ±‚ï¼šä¸ç»Ÿè®¡ 21:30-07:30ã€‚
  const STATS_WINDOW = { start: 7*60+30, end: 21*60+30 }; // 07:30-21:30
  const DEFAULT_SCHEDULE_IN = { start: STATS_WINDOW.start, end: STATS_WINDOW.end };

  /**
   * ç³»ç»Ÿæœ‰æ•ˆç»Ÿè®¡æ—¶é—´çª—å£ï¼šæ‰€æœ‰å·¥ä½œæ—¥ç»Ÿä¸€ç»Ÿè®¡è‡³ 21:30ï¼›å‘¨æœ«ä¸ç»Ÿè®¡ã€‚
   */
  function getEffectiveDayWindow(date) {
    const weekday = date.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
  // å‘¨ä¸€åˆ°å‘¨æ—¥ç»Ÿä¸€ä½¿ç”¨ 07:30-21:30 æœ‰æ•ˆç»Ÿè®¡çª—å£
  return { start: STATS_WINDOW.start, end: STATS_WINDOW.end };
  }
  
  // ä¿æŒå…¼å®¹æ€§ï¼Œä½¿ç”¨é»˜è®¤æ—¶é—´çª—å£ï¼ˆå‘¨1245çš„æ—¶é—´ï¼‰
  const EFFECTIVE_DAY_WINDOW = { start: STATS_WINDOW.start, end: STATS_WINDOW.end };

    // ==== å…¨å±€çŠ¶æ€ ====
    let supabaseClient = null;
    let realtimeChannel = null;
    let isConnected = false;

    const appState = {
      students: new Map(), // studentName -> StudentData
  studentsMeta: new Map(), // studentName -> {major, grade} ï¼ˆexternal_id å·²ä¸‹çº¿ï¼‰
      timeSlots: new Map(), // studentName -> {1..7: [{start,end}]}
      practiceLogs: [],
      currentFilter: 'all',
  searchQuery: '',
  // ç¼“å­˜ï¼šåç«¯å¤‡ä»½çš„æ¯æ—¥æ’è¡Œæ¦œï¼ˆdateKey -> Map<student_key, rank>ï¼‰
  dailyLeaderboards: new Map()
    };

    // ==== å·¥å…·å‡½æ•° ====
    const utils = {
  // ISO æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆä¸å«æ—¶é—´ï¼‰
  toIsoDate: (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`,
        // ç»Ÿä¸€å­¦ç”Ÿå§“åï¼šå»é¦–å°¾ç©ºæ ¼ã€å‹ç¼©ä¸­é—´ç©ºç™½ã€æ ‡å‡†åŒ–å…¨è§’ç©ºæ ¼ä¸æ‹¬å·
        normalizeStudentName: (name) => {
          if (!name) return '';
          let s = String(name);
          // å»é™¤é›¶å®½ä¸ä¸å¯è§æ§åˆ¶å­—ç¬¦ã€BOM
          s = s.replace(/[\u200B-\u200D\uFEFF\u2060]/g, '');
          // å…¨è§’ç©ºæ ¼/ä¸é—´æ–­ç©ºæ ¼ -> åŠè§’ç©ºæ ¼
          s = s.replace(/[\u3000\u00A0]/g, ' ');
          // å…¨è§’æ‹¬å· -> åŠè§’
          s = s.replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')');
          // è§„èŒƒå°¾éƒ¨æ‹¬å·å†…éƒ¨ç©ºæ ¼
          s = s.replace(/[\(]\s*([^)]*?)\s*[)]$/, '($1)');
          // å»é¦–å°¾å¹¶å‹ç¼©å¤šä½™å†…éƒ¨ç©ºç™½
          s = s.trim().replace(/\s+/g, ' ');
          return s;
        },

        // å®‰å…¨è·å–æŒ‡å®šå­¦ç”Ÿçš„æ—¶æ®µ Mapï¼ˆå·²æ ‡å‡†åŒ–å§“åï¼Œå¹¶æ”¯æŒ weekday 0->7 å½’ä¸€åŒ–ï¼‰
        getStudentTimeSlots: (name) => {
          const key = utils.normalizeStudentName(name);
          const m = appState.timeSlots.get(key) || appState.timeSlots.get(name) || {};
          // å¤åˆ¶å¹¶å°† 0 å·æ˜ŸæœŸæ˜ å°„ä¸º 7ï¼Œé¿å…å–ä¸åˆ°
          const fixed = {};
          Object.keys(m || {}).forEach(k => {
            const wk = Number(k);
            if (!Number.isFinite(wk)) return;
            const norm = wk === 0 ? 7 : wk;
            fixed[norm] = (m[k] || []).slice();
          });
          return fixed;
        },
      formatTime: (date) => {
        return new Intl.DateTimeFormat('zh-CN', {
          hour: '2-digit',
          minute: '2-digit'
        }).format(date);
      },

      formatDuration: (minutes) => {
        if (minutes < 60) return `${Math.round(minutes)}åˆ†é’Ÿ`;
        const hours = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        return mins > 0 ? `${hours}å°æ—¶${mins}åˆ†é’Ÿ` : `${hours}å°æ—¶`;
      },

      // ç®€æ´æ ¼å¼ï¼Œç”¨äºè¿‘ä¸ƒå¤©ç»ƒç´æ€»ç»“
      formatDurationShort: (minutes) => {
        if (minutes < 60) return `${Math.round(minutes)}åˆ†`;
        const hours = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        return mins > 0 ? `${hours}æ—¶${mins}åˆ†` : `${hours}æ—¶`;
      },

      // å®Œæ•´æ ¼å¼ï¼Œç”¨äºå­¦ç”Ÿå¡ç‰‡
      formatDurationFull: (minutes) => {
        if (minutes < 60) return `${Math.round(minutes)}åˆ†é’Ÿ`;
        const hours = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        return mins > 0 ? `${hours}å°æ—¶${mins}åˆ†é’Ÿ` : `${hours}å°æ—¶`;
      },

      getDateKey: (timestamp) => {
        const date = new Date(timestamp);
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      },

      getWeekday: (date) => {
        const day = date.getDay();
        return day === 0 ? 7 : day;
      },

      minutesFromDayStart: (date) => {
        return date.getHours() * 60 + date.getMinutes();
      },

      parseTimeSlot: (timeStr) => {
        if (!timeStr) return null;
        // ç»Ÿä¸€å…¨è§’å†’å·/ç©ºç™½ä¸é›¶å®½å­—ç¬¦
        const raw = String(timeStr)
          .replace(/[\u200B-\u200D\uFEFF\u2060]/g, '')
          .replace(/[\u3000\u00A0]/g, ' ')
          .replace(/ï¼š/g, ':')
          .trim();
        const parts = raw.split(':').map(s => s.trim());
        if (parts.length < 2) return null;
        const hours = Number(parts[0]);
        const minutes = Number(parts[1]);
        if (!Number.isFinite(hours) || !Number.isFinite(minutes)) return null;
        return hours * 60 + minutes;
      },

      getStudentInitials: (name) => {
        if (!name) return '?';
        const parts = name.trim().split('');
        return parts.length >= 2 ? parts.slice(-2).join('') : parts[0] || '?';
      },

      // å°†å¤šç§æ˜ŸæœŸè¡¨ç¤ºå½’ä¸€åˆ° 1..7ï¼ˆå‘¨ä¸€..å‘¨æ—¥ï¼‰ï¼›æ— æ³•è¯†åˆ«æ—¶è¿”å› NaN
      normalizeWeekday: (val) => {
        if (val === null || val === undefined) return NaN;
        const n = Number(val);
        if (Number.isFinite(n)) {
          if (n === 0) return 7;
          if (n >= 1 && n <= 7) return n;
        }
        const s = String(val).trim();
        const map = {
          '1':1,'ä¸€':1,'å‘¨ä¸€':1,'æ˜ŸæœŸä¸€':1,'Mon':1,'Monday':1,
          '2':2,'äºŒ':2,'å‘¨äºŒ':2,'æ˜ŸæœŸäºŒ':2,'Tue':2,'Tues':2,'Tuesday':2,
          '3':3,'ä¸‰':3,'å‘¨ä¸‰':3,'æ˜ŸæœŸä¸‰':3,'Wed':3,'Wednesday':3,
          '4':4,'å››':4,'å‘¨å››':4,'æ˜ŸæœŸå››':4,'Thu':4,'Thur':4,'Thursday':4,
          '5':5,'äº”':5,'å‘¨äº”':5,'æ˜ŸæœŸäº”':5,'Fri':5,'Friday':5,
          '6':6,'å…­':6,'å‘¨å…­':6,'æ˜ŸæœŸå…­':6,'Sat':6,'Saturday':6,
          '7':7,'æ—¥':7,'å¤©':7,'å‘¨æ—¥':7,'æ˜ŸæœŸæ—¥':7,'æ˜ŸæœŸå¤©':7,'Sun':7,'Sunday':7
        };
        return map[s] ?? NaN;
      },

      // ç®€å•ç¼–è¾‘è·ç¦»ï¼ˆLevenshteinï¼‰ç”¨äºç›¸ä¼¼å§“åæ’æŸ¥
      editDistance: (a, b) => {
        a = String(a); b = String(b);
        const m = a.length, n = b.length;
        if (!m) return n; if (!n) return m;
        const dp = Array.from({length:m+1}, (_,i)=>Array(n+1).fill(0));
        for (let i=0;i<=m;i++) dp[i][0]=i;
        for (let j=0;j<=n;j++) dp[0][j]=j;
        for (let i=1;i<=m;i++){
          for (let j=1;j<=n;j++){
            const cost = a[i-1]===b[j-1]?0:1;
            dp[i][j] = Math.min(
              dp[i-1][j]+1,
              dp[i][j-1]+1,
              dp[i-1][j-1]+cost
            );
          }
        }
        return dp[m][n];
      },

      // åœ¨ timeSlots çš„é”®ä¸­æ‰¾ä¸ç»™å®šå§“åç›¸ä¼¼çš„å€™é€‰ï¼ˆè¿”å›å‰5ä¸ªï¼‰
  findSimilarStudentKeys: (name) => {
        const norm = utils.normalizeStudentName(name);
        const keys = Array.from(appState.timeSlots.keys());
        const scored = keys.map(k=>({k, d: utils.editDistance(norm, k)}));
        scored.sort((a,b)=>a.d-b.d);
        return scored.slice(0,5).map(x=>x.k);
  },

      isWithinTimeRange: (minutes, range) => {
        return minutes >= range.start && minutes < range.end;
      }
    };

    // ==== åç«¯å¤‡ä»½è¯»å–è¾…åŠ© ====
    // ç»Ÿè®¡ç”¨è‡ªç„¶æ—¥ keyï¼ˆä¸å—æ’è¡Œæ¦œ07:30åˆ‡æ¢å½±å“ï¼‰
    function getStatsDayKey(d){
      // ä½¿ç”¨æœ¬åœ°æ—¶åŒºè‡ªç„¶æ—¥ï¼šYYYY-MM-DD
      const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
  const ENABLE_DAILY_PRACTICE_SUMMARIES = false; // åç«¯è‹¥æ— è¯¥è¡¨ï¼Œä¿æŒ false é¿å… 404
    async function fetchDailyPracticeSummaries(studentName, startDate, endDate) {
      if (!ENABLE_DAILY_PRACTICE_SUMMARIES) return new Map();
      try {
        if (!supabaseClient) return new Map();
        const key = utils.normalizeStudentName(studentName);
        const from = utils.toIsoDate(startDate);
        const to = utils.toIsoDate(endDate);
        const { data, error } = await supabaseClient
          .from('daily_practice_summaries')
          .select('date,total_minutes')
          .eq('student_key', key)
          .gte('date', from)
          .lte('date', to)
          .order('date', { ascending: true });
  if (error) { console.warn('fetchDailyPracticeSummaries error:', error); return new Map(); }
        const map = new Map();
        (data||[]).forEach(r => map.set(r.date, Number(r.total_minutes)||0));
        return map;
      } catch (e) { console.warn('fetchDailyPracticeSummaries exception:', e); return new Map(); }
    }

    async function fetchDailyLeaderboardMap(date) {
      try {
        if (!supabaseClient) return null;
        const d = utils.toIsoDate(date);
        const { data, error } = await supabaseClient
          .from('leaderboard_daily')
          .select('student_key,rank')
          .eq('date', d);
        if (error) { console.warn('fetchDailyLeaderboardMap error:', error); return null; }
        if (!data || data.length === 0) return null;
        const m = new Map();
        data.forEach(r => m.set(utils.normalizeStudentName(r.student_key), r.rank));
        return m;
      } catch (e) { console.warn('fetchDailyLeaderboardMap exception:', e); return null; }
    }

  // è·å–å‘¨æ¦œæ•°æ®ï¼šæŸ¥è¯¢æœ€è¿‘5ä¸ªå·¥ä½œæ—¥çš„å¹³å‡åˆ†ï¼ˆ0åˆ†å¡«å…… + ä»Šæ—¥å®æ—¶è¦†ç›–ï¼‰
    async function fetchWeeklyLeaderboardData() {
      try {
        if (!supabaseClient) return [];

    // ç”¨ä¸æ—¥æ¦œä¸€è‡´çš„å£å¾„ï¼šæ´»è·ƒæ’è¡Œæ¦œæ—¥æœŸï¼ˆ07:30 åˆ‡æ¢ï¼‰
    const refDate = getActiveLeaderboardDate();
    const endWorkday = nearestWorkdayOnOrBefore(refDate);
    const workdayDates = getLastNWorkdayDates(endWorkday, 5); // æœ€è¿‘5ä¸ªå·¥ä½œæ—¥ï¼ˆå«ä»Šå¤©çš„æ´»è·ƒå£å¾„ï¼‰
    const workdays = workdayDates.map(d => utils.toIsoDate(d));
    const todayStr = utils.toIsoDate(refDate);
    const isIncludeToday = workdays.includes(todayStr);
        
        dbg('å‘¨æ¦œæŸ¥è¯¢æ—¥æœŸèŒƒå›´:', workdays);
        dbg('æ˜¯å¦åŒ…å«ä»Šå¤©:', isIncludeToday, todayStr);
        
  // æŸ¥è¯¢è¿™5å¤©çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…å« no_practice=true çš„è®°å½•ï¼Œç”¨0åˆ†å¡«å……ï¼‰
        const { data, error } = await supabaseClient
          .from('leaderboard_daily')
          .select('student_key, total, date, no_practice')
          .in('date', workdays);
          
        if (error) { 
          console.warn('fetchWeeklyLeaderboardData error:', error); 
          return []; 
        }
        
        // è·å–æ‰€æœ‰å­¦ç”Ÿåå•ï¼ˆä»å½“å‰æ´»è·ƒå­¦ç”Ÿå’Œå†å²æ•°æ®ä¸­ï¼‰
        const allStudentNames = new Set();
        
        // ä»å†å²æ•°æ®ä¸­è·å–å­¦ç”Ÿåå•
        if (data) {
          data.forEach(record => {
            allStudentNames.add(record.student_key);
          });
        }
        
  // ä»å½“å‰æ´»è·ƒå­¦ç”Ÿä¸­è·å–åå•
        try {
          const activeStudents = Array.from(appState.students?.values?.() || []);
          activeStudents.forEach(student => {
            allStudentNames.add(student.name);
          });
        } catch (e) {
          // å¦‚æœæ²¡æœ‰æ´»è·ƒå­¦ç”Ÿæ•°æ®ï¼Œä»studentsMetaè·å–
          try {
            const metaEntries = Array.from(appState.studentsMeta?.entries?.() || []);
            metaEntries.forEach(([name]) => {
              allStudentNames.add(name);
            });
          } catch (e2) {
            dbg('æ— æ³•è·å–å­¦ç”Ÿåå•:', e2);
          }
        }
        
        dbg('æ‰€æœ‰å­¦ç”Ÿåå•:', Array.from(allStudentNames));
        
        // æ„å»ºæ¯ä¸ªå­¦ç”Ÿçš„5å¤©æ•°æ®æ˜ å°„
        const studentScores = new Map();
        
        // åˆå§‹åŒ–æ‰€æœ‰å­¦ç”Ÿçš„5å¤©æ•°æ®ä¸º0åˆ†
        allStudentNames.forEach(studentName => {
          const normalizedName = utils.normalizeStudentName(studentName);
          const scoresByDate = {};
          workdays.forEach(date => {
            scoresByDate[date] = 0; // é»˜è®¤0åˆ†
          });
          
          studentScores.set(normalizedName, {
            studentName: studentName,
            scoresByDate: scoresByDate,
            scores: []
          });
        });
        
        // å¡«å…¥å†å²æ•°æ®
        if (data) {
          data.forEach(record => {
            const normalizedName = utils.normalizeStudentName(record.student_key);
            if (studentScores.has(normalizedName)) {
              const studentData = studentScores.get(normalizedName);
              studentData.scoresByDate[record.date] = record.no_practice ? 0 : (record.total || 0);
            }
          });
        }
        
        // å¦‚æœåŒ…å«ä»Šå¤©ï¼ˆæ´»è·ƒå£å¾„ï¼‰ï¼Œç”¨å®æ—¶åˆ†æ•°è¦†ç›–ä»Šå¤©çš„æ•°æ®ï¼ˆå¯¹æ‰€æœ‰å­¦ç”Ÿå°è¯•å®æ—¶è®¡ç®—ï¼‰
        if (isIncludeToday) {
          try {
            const names = Array.from(allStudentNames);
            for (const name of names) {
              const normalizedName = utils.normalizeStudentName(name);
              if (!studentScores.has(normalizedName)) continue;
              try {
                // computeScore442 ä»…ä¾èµ– nameï¼Œå› æ­¤å¯ç”¨å ä½å¯¹è±¡
                const realTimeScore = await computeScore442({ name });
                const studentData = studentScores.get(normalizedName);
                studentData.scoresByDate[todayStr] = realTimeScore.total || 0;
                // dbg(`${name} å®æ—¶åˆ†æ•°:`, realTimeScore.total);
              } catch (e) {
                // ä¿æŒé»˜è®¤çš„0åˆ†
                dbg(`è®¡ç®— ${name} å®æ—¶åˆ†æ•°å¤±è´¥:`, e);
              }
            }
          } catch (e) {
            dbg('è·å–å®æ—¶åˆ†æ•°å¤±è´¥:', e);
          }
        }
        
        // è®¡ç®—æ¯ä¸ªå­¦ç”Ÿçš„5å¤©å¹³å‡åˆ†
        const weeklyRanking = [];
        studentScores.forEach((data, normalizedName) => {
          const scores = workdays.map(date => data.scoresByDate[date] || 0);
          const totalScore = scores.reduce((sum, score) => sum + score, 0);
          const averageScore = totalScore / 5; // å›ºå®š5å¤©å¹³å‡
          
          weeklyRanking.push({
            studentKey: normalizedName,
            studentName: data.studentName,
            averageScore: +averageScore.toFixed(2),
            dayCount: 5, // å›ºå®šæ˜¾ç¤º5å¤©
            scores: scores // ä¿ç•™è¯¦ç»†åˆ†æ•°ç”¨äºè°ƒè¯•
          });
        });
        
        // æŒ‰å¹³å‡åˆ†æ’åº
        weeklyRanking.sort((a, b) => b.averageScore - a.averageScore);
        
        // æ·»åŠ æ’å
        weeklyRanking.forEach((item, index) => {
          item.rank = index + 1;
        });
        
  dbg('å‘¨æ¦œæ•°æ® (5å¤©å¹³å‡):', weeklyRanking.slice(0, 10)); // åªæ˜¾ç¤ºå‰10åé¿å…æ—¥å¿—è¿‡é•¿
        return weeklyRanking;
        
      } catch (e) { 
        console.warn('fetchWeeklyLeaderboardData exception:', e); 
        return []; 
      }
    }

    // ==== æ•°æ®å¤„ç† ====
    class StudentData {
      constructor(name) {
        this.name = name;
        this.todayMinutes = { in: 0, out: 0 };
        this.weekMinutes = { in: 0, out: 0 };
        this.isPresent = false;
        this.currentStatus = 'offline'; // 'practicing-in', 'practicing-out', 'offline'
        this.currentRoom = null;
        this.currentStartTime = null;
        this.achievementRate = 0;
        this.weekStreak = 0;
        this.totalSessions = 0;
      }
    }

    // ==== Supabase åˆå§‹åŒ– ====
    async function initializeSupabase() {
      try {
        setConnectionStatus('syncing', 'è¿æ¥ä¸­...');
        
        // å°è¯•åŠ è½½ Supabase
        if (!window.supabase && !window.Supabase) {
          await loadSupabaseScript();
        }
        
        const supabase = window.supabase || window.Supabase;
        if (!supabase) {
          throw new Error('Supabase åº“æœªæ‰¾åˆ°');
        }
        
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        isConnected = true;
        setConnectionStatus('online', 'å·²è¿æ¥');
        
        return true;
      } catch (error) {
        console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', error);
        setConnectionStatus('offline', 'è¿æ¥å¤±è´¥');
        return false;
      }
    }

    function loadSupabaseScript() {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.onload = resolve;
        script.onerror = () => {
          // å°è¯•å¤‡ç”¨ CDN
          const fallbackScript = document.createElement('script');
          fallbackScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';
          fallbackScript.onload = resolve;
          fallbackScript.onerror = reject;
          document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
      });
    }

    function setConnectionStatus(status, text) {
      const statusEl = document.getElementById('connectionStatus');
      if (!statusEl) return;
      
      statusEl.className = `connection-status ${status}`;
      statusEl.querySelector('span').textContent = text;
    }

    // é€šç”¨ï¼šåˆ†é¡µè·å–æ•´è¡¨/å¤§ç»“æœé›†ï¼ˆé¿å… 1000 è¡Œä¸Šé™ï¼‰
    async function fetchAllRowsPaginated({ table, select = '*', orderBy = 'id', ascending = true, pageSize = 1000, apply }) {
      if (!supabaseClient) throw new Error('Supabase æœªåˆå§‹åŒ–');
      const all = [];
      let from = 0;
      while (true) {
        let query = supabaseClient
          .from(table)
          .select(select)
          .order(orderBy, { ascending });
        if (typeof apply === 'function') {
          query = apply(query);
        }
        const { data, error } = await query.range(from, from + pageSize - 1);
        if (error) throw error;
        const batch = data || [];
        all.push(...batch);
        dbg(`[åˆ†é¡µ] ${table} æ‰¹æ¬¡ ${from}-${from + pageSize - 1} è¿”å› ${batch.length} è¡Œ`);
        if (batch.length < pageSize) break;
        from += pageSize;
      }
      dbg(`[åˆ†é¡µ] ${table} åˆè®¡åŠ è½½ ${all.length} è¡Œ`);
      return all;
    }

    // âœ… æ•°æ®å®Œæ•´æ€§ç»¼åˆæ£€æŸ¥å‡½æ•°
    function performDataIntegrityCheck() {
      const report = {
        timestamp: new Date().toISOString(),
        tables: {},
        issues: [],
        summary: {}
      };
      
      // ğŸ“ æ£€æŸ¥ç»ƒç´æ—¥å¿—å®Œæ•´æ€§
      const logs = appState.practiceLogs || [];
      const validLogs = logs.filter(r => r.student_name && r.room_name && r.action && r.timestamp);
      report.tables.practice_logs = {
        total: logs.length,
        valid: validLogs.length,
        invalid: logs.length - validLogs.length
      };
      
      if (report.tables.practice_logs.invalid > 0) {
        report.issues.push(`ç»ƒç´æ—¥å¿—ä¸­æœ‰${report.tables.practice_logs.invalid}æ¡ä¸å®Œæ•´è®°å½•`);
      }
      
      // ğŸ‘¥ æ£€æŸ¥å­¦ç”Ÿä¿¡æ¯å®Œæ•´æ€§
      const students = Array.from(appState.studentsMeta.entries());
      const placeholder = [];
      const studentDetailMissing = [];
      const validStudents = students.filter(([name, info]) => {
        if(!name) return false; 
        const missing = [];
        if(!info) { missing.push('record'); }
        else {
          if(!info.major) missing.push('major');
          if(!info.grade) missing.push('grade');
        }
        if(missing.length){
          placeholder.push(name);
          studentDetailMissing.push({ name, missing });
          return false;
        }
        return true;
      });
      report.tables.student_database = {
        total: students.length,
        valid: validStudents.length,
        invalid: students.length - validStudents.length,
        placeholder
      };
      
      if (report.tables.student_database.invalid > 0) {
        report.issues.push(`å­¦ç”Ÿä¿¡æ¯ä¸­æœ‰${report.tables.student_database.invalid}æ¡ä¸å®Œæ•´è®°å½•`);
        report.incompleteStudents = studentDetailMissing;
      }
      
      // â° æ£€æŸ¥æ—¶é—´æ®µé…ç½®å®Œæ•´æ€§
      const timeSlotEntries = Array.from(appState.timeSlots.entries());
      let totalSlots = 0;
      let validSlots = 0;
      
      timeSlotEntries.forEach(([studentName, weeklySlots]) => {
        Object.values(weeklySlots).forEach(daySlots => {
          if (Array.isArray(daySlots)) {
            totalSlots += daySlots.length;
            validSlots += daySlots.filter(slot => slot.start_time && slot.end_time).length;
          }
        });
      });
      
      report.tables.student_time_slots = {
        students: timeSlotEntries.length,
        totalSlots: totalSlots,
        validSlots: validSlots,
        invalidSlots: totalSlots - validSlots
      };
      
      if (report.tables.student_time_slots.invalidSlots > 0) {
        report.issues.push(`æ—¶é—´æ®µé…ç½®ä¸­æœ‰${report.tables.student_time_slots.invalidSlots}æ¡ä¸å®Œæ•´è®°å½•`);
      }
      
      // ğŸ“Š æ£€æŸ¥æˆ¿é—´æ•°æ®å®Œæ•´æ€§
      const rooms = window.roomsData || [];
      const validRooms = rooms.filter(room => room.name);
      report.tables.rooms = {
        total: rooms.length,
        valid: validRooms.length,
        invalid: rooms.length - validRooms.length,
        occupied: rooms.filter(room => room.occupant_student_name).length
      };
      
      if (report.tables.rooms.invalid > 0) {
        report.issues.push(`æˆ¿é—´æ•°æ®ä¸­æœ‰${report.tables.rooms.invalid}æ¡ä¸å®Œæ•´è®°å½•`);
      }
      
      // ç”Ÿæˆæ€»ç»“
      report.summary = {
        totalIssues: report.issues.length,
        overallHealth: report.issues.length === 0 ? 'å¥åº·' : report.issues.length <= 3 ? 'è‰¯å¥½' : 'éœ€è¦å…³æ³¨',
        recommendations: []
      };
      
      if (report.issues.length > 0) {
        report.summary.recommendations.push('å»ºè®®æ£€æŸ¥æ•°æ®åº“æ•°æ®å®Œæ•´æ€§');
        report.summary.recommendations.push('è€ƒè™‘æ·»åŠ æ•°æ®éªŒè¯çº¦æŸ');
      }
      
      // è¾“å‡ºæŠ¥å‘Šï¼ˆå¼€å‘æ¨¡å¼ä¸‹ï¼‰
      if (window.DEBUG || window.location.search.includes('debug=1')) {
        console.group('ğŸ” æ•°æ®å®Œæ•´æ€§æ£€æŸ¥æŠ¥å‘Š');
        console.log('ğŸ“Š è¡¨ç»Ÿè®¡:', report.tables);
        if (report.issues.length > 0) {
          console.warn('âš ï¸ å‘ç°é—®é¢˜:', report.issues);
        } else {
          console.log('âœ… æ•°æ®å®Œæ•´æ€§è‰¯å¥½');
        }
        console.groupEnd();
      }
      
      // æä¾›ä¸€ä¸ªå…¨å±€è°ƒè¯•å‡½æ•°åˆ—å‡ºå…·ä½“ç¼ºå¤±
      if(!window.listIncompleteStudents){
        window.listIncompleteStudents = function(){
          const r = performDataIntegrityCheck();
            if(!r.incompleteStudents || !r.incompleteStudents.length){
              console.log('âœ… æ²¡æœ‰ä¸å®Œæ•´å­¦ç”Ÿè®°å½•');
              return r;
            }
            console.group('ğŸ“‹ ä¸å®Œæ•´å­¦ç”Ÿå­—æ®µåˆ—è¡¨');
            r.incompleteStudents.forEach(s=>{
              console.warn(`- ${s.name}: ç¼ºå¤± -> ${s.missing.join(', ')}`);
            });
            console.groupEnd();
            console.info('ğŸ’¡ è§£å†³: åœ¨ student_database è¡¨è¡¥å…¨å¯¹åº”å­—æ®µ (major / grade)ã€‚');
            return r;
        }
      }
      return report;
    }

    // ==== æ•°æ®å·®å¼‚åŒæ­¥ç³»ç»Ÿ ====
    
    // æ•°æ®ç‰ˆæœ¬ç®¡ç†
    const dataVersions = {
      practice_logs: { lastSync: 0, hash: null, count: 0 },
      student_database: { lastSync: 0, hash: null, count: 0 },
      student_time_slots: { lastSync: 0, hash: null, count: 0 },
      rooms: { lastSync: 0, hash: null, count: 0 }
    };
    
    // è®¡ç®—æ•°æ®å“ˆå¸Œå€¼
    function calculateDataHash(data, tableName) {
      if (!data || !Array.isArray(data)) return null;
      
      try {
        // æ ¹æ®è¡¨ç±»å‹é€‰æ‹©å…³é”®å­—æ®µè¿›è¡Œå“ˆå¸Œ
        let keyFields;
        switch (tableName) {
          case 'practice_logs':
            keyFields = ['id', 'timestamp', 'student_name', 'room_name'];
            break;
          case 'student_database':
            keyFields = ['name', 'major', 'grade'];
            break;
          case 'student_time_slots':
            keyFields = ['id', 'student_name', 'day_of_week', 'time_slots'];
            break;
          case 'rooms':
            keyFields = ['id', 'name', 'room_type', 'updated_at'];
            break;
          default:
            keyFields = Object.keys(data[0] || {});
        }
        
        const hashData = data.map(item => 
          keyFields.map(field => item[field]).join('|')
        ).sort().join('||');
        
        // ç®€å•å“ˆå¸Œç®—æ³•
        let hash = 0;
        for (let i = 0; i < hashData.length; i++) {
          const char = hashData.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // è½¬ä¸º32ä½æ•´æ•°
        }
        
        return hash.toString();
      } catch (e) {
        console.warn(`è®¡ç®—${tableName}å“ˆå¸Œå¤±è´¥:`, e);
        return Date.now().toString();
      }
    }
    
    // æ£€æŸ¥æ•°æ®æ˜¯å¦éœ€è¦æ›´æ–°
    function needsDataUpdate(tableName, newData) {
      const version = dataVersions[tableName];
      if (!version) return true;
      
      const newHash = calculateDataHash(newData, tableName);
      const newCount = newData ? newData.length : 0;
      
      // æ£€æŸ¥æ•°æ®æ•°é‡æˆ–å“ˆå¸Œå€¼æ˜¯å¦å˜åŒ–
      const changed = version.hash !== newHash || version.count !== newCount;
      
      if (changed) {
        dbg(`${tableName} æ•°æ®å˜æ›´: æ•°é‡ ${version.count}->${newCount}, å“ˆå¸Œ ${version.hash?.substr(0,8)}->${newHash?.substr(0,8)}`);
        
        // æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
        dataVersions[tableName] = {
          lastSync: Date.now(),
          hash: newHash,
          count: newCount
        };
      }
      
      return changed;
    }
    
    // å·®å¼‚åŒæ­¥ç‰¹å®šè¡¨æ•°æ®
    async function fetchDataWithDiff(tables) {
      if (!isConnected) return;
      
      const tablesToSync = Array.isArray(tables) ? tables : [tables];
      let hasChanges = false;
      
      try {
        setConnectionStatus('syncing', 'æ£€æŸ¥æ•°æ®å˜æ›´...');
        
        for (const table of tablesToSync) {
          let data;
          
          // âœ… æ ¹æ®è¡¨ç±»å‹è·å–å®Œæ•´ç»“æ„åŒ–æ•°æ®ï¼ˆä¸fetchAllDataä¿æŒä¸€è‡´ï¼‰
          switch (table) {
            case 'practice_logs':
              const weekAgo = Date.now() - 8 * 24 * 60 * 60 * 1000;
              data = await fetchAllRowsPaginated({
                table: 'practice_logs',
                select: 'id, created_at, action, room_name, student_name, timestamp, location, piano_type, student_major, student_grade, session_start, session_end, practice_duration',
                orderBy: 'timestamp',
                ascending: true,
                pageSize: 1000,
                apply: (q) => q.gte('timestamp', new Date(weekAgo).toISOString())
              });
              break;
              
            case 'student_database':
              const result = await supabaseClient
                .from('student_database')
                .select('id, name, major, grade, archived, remark, created_at, updated_at')
                .eq('archived', false); // åªåŒæ­¥æœªå½’æ¡£å­¦ç”Ÿ
              data = result.data;
              if (result.error) {
                console.error('student_databaseå·®å¼‚åŒæ­¥é”™è¯¯:', result.error);
                throw result.error;
              }
              break;
              
            case 'student_time_slots':
              data = await fetchAllRowsPaginated({
                table: 'student_time_slots',
                select: 'id, weekday, start_time, end_time, duration_minutes, created_at, student_name, updated_at',
                orderBy: 'id',
                ascending: true,
                pageSize: 1000
              });
              break;
              
            case 'rooms':
              const roomsResult = await supabaseClient
                .from('rooms')
                .select('name, piano_type, location, remark, heartbeat_at, version, updated_at, occupant_student_name, register_time');
              data = roomsResult.data;
              if (roomsResult.error) {
                console.error('roomså·®å¼‚åŒæ­¥é”™è¯¯:', roomsResult.error);
                throw roomsResult.error;
              }
              break;
          }
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
          if (needsDataUpdate(table, data)) {
            hasChanges = true;
            
            // æ›´æ–°å¯¹åº”çš„å…¨å±€æ•°æ®
            switch (table) {
              case 'practice_logs':
                window.practiceLogsData = data || [];
                break;
              case 'student_database':
                window.studentDatabaseData = data || [];
                break;
              case 'student_time_slots':
                window.studentTimeSlotsData = data || [];
                break;
              case 'rooms':
                window.roomsData = data || [];
                break;
            }
            
            dbg(`${table} æ•°æ®å·²æ›´æ–° (${data?.length || 0} æ¡è®°å½•)`);
          } else {
            dbg(`${table} æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°`);
          }
        }
        
        if (hasChanges) {
          // åªæœ‰åœ¨æœ‰æ•°æ®å˜åŒ–æ—¶æ‰é‡æ–°å¤„ç†å’Œæ¸²æŸ“
          processAllData();
          setConnectionStatus('online', 'æ•°æ®å·²åŒæ­¥');
        } else {
          setConnectionStatus('online', 'æ•°æ®æœ€æ–°');
        }
        
      } catch (error) {
        console.error('å·®å¼‚åŒæ­¥å¤±è´¥:', error);
        setConnectionStatus('offline', 'åŒæ­¥å¤±è´¥');
        throw error;
      }
    }
    
    // å¤„ç†æ‰€æœ‰æ•°æ®çš„å‡½æ•°ï¼ˆä»fetchAllDataä¸­æå–ï¼‰
    function processAllData() {
      try {
        dbg('=== å¼€å§‹å¤„ç†æ•°æ® ===');
        dbg('ç»ƒç´æ—¥å¿—æ•°é‡:', window.practiceLogsData?.length || 0);
        dbg('å­¦ç”Ÿä¿¡æ¯æ•°é‡:', window.studentDatabaseData?.length || 0);
        dbg('æ—¶é—´æ®µæ•°æ®æ•°é‡:', window.studentTimeSlotsData?.length || 0);
        
        // âœ… å·®å¼‚åŒæ­¥æ•°æ®å¤„ç† - ä¸fetchAllDataä¿æŒä¸€è‡´çš„å¤„ç†é€»è¾‘
        if (window.practiceLogsData) {
          appState.practiceLogs = window.practiceLogsData;
          
          // ğŸ“ æ ‡å‡†åŒ–ç»ƒç´æ—¥å¿—ï¼ˆä¸fetchAllDataä¿æŒä¸€è‡´ï¼‰
          appState.practiceLogsNormalized = appState.practiceLogs.map(r => {
            if (!r.student_name || !r.room_name || !r.action || !r.timestamp) {
              console.warn('å·®å¼‚åŒæ­¥ä¸­å‘ç°ä¸å®Œæ•´çš„ç»ƒç´æ—¥å¿—:', r);
            }
            
            return {
              id: r.id,
              student_name: r.student_name || r.student || r.studentName || '',
              room_name: r.room_name || r.room || r.roomName || '',
              action: (r.action || '').toLowerCase(),
              timestamp: r.timestamp,
              location: r.location || '',
              piano_type: r.piano_type || '',
              student_major: r.student_major || '',
              student_grade: r.student_grade || '',
              session_start: r.session_start || r.start_time || null,
              session_end: r.session_end || r.end_time || null,
              practice_duration: r.practice_duration || r.duration || null,
              created_at: r.created_at || null
            };
          });
        }
        
        if (window.studentDatabaseData) {
          appState.studentsMeta.clear();
          window.studentDatabaseData.forEach(student => {
            if (!student.name) {
              console.warn('å·®å¼‚åŒæ­¥ä¸­å‘ç°ç¼ºå°‘å§“åçš„å­¦ç”Ÿä¿¡æ¯:', student);
              return;
            }
            
            const norm = utils.normalizeStudentName(student.name);
            appState.studentsMeta.set(norm, {
              id: student.id,
              major: student.major || '',
              grade: student.grade || '',
              archived: student.archived || false,
              remark: student.remark || '',
              created_at: student.created_at || null,
              updated_at: student.updated_at || null
            });
          });
        }
        
        if (window.studentTimeSlotsData) {
          appState.timeSlots.clear();
          let validSlotsCount = 0;
          let invalidSlotsCount = 0;
          
          window.studentTimeSlotsData.forEach(slot => {
            const studentName = slot.student_name;
            const weekdayRaw = slot.weekday;
            const startTime = slot.start_time;
            const endTime = slot.end_time;
            
            if (!studentName || weekdayRaw == null || !startTime || !endTime) {
              console.warn('å·®å¼‚åŒæ­¥ä¸­å‘ç°ä¸å®Œæ•´çš„æ—¶é—´æ®µ:', slot);
              invalidSlotsCount++;
              return;
            }
            
            const name = utils.normalizeStudentName(studentName);
            const weekday = utils.normalizeWeekday(weekdayRaw);
            
            if (!name || !isFinite(weekday)) {
              console.warn('å·®å¼‚åŒæ­¥ä¸­æ—¶é—´æ®µæ•°æ®å¤„ç†å¤±è´¥:', {
                originalName: studentName,
                normalizedName: name,
                originalWeekday: weekdayRaw,
                normalizedWeekday: weekday
              });
              invalidSlotsCount++;
              return;
            }
            
            if (!appState.timeSlots.has(name)) {
              appState.timeSlots.set(name, {});
            }
            const studentSlots = appState.timeSlots.get(name);
            if (!studentSlots[weekday]) studentSlots[weekday] = [];
            studentSlots[weekday].push({
              id: slot.id,
              start_time: startTime,
              end_time: endTime,
              duration_minutes: slot.duration_minutes || 0,
              created_at: slot.created_at || null,
              updated_at: slot.updated_at || null
            });
            validSlotsCount++;
          });
          
          dbg(`â° å·®å¼‚åŒæ­¥æ—¶é—´æ®µå¤„ç†: æœ‰æ•ˆ${validSlotsCount}æ¡, æ— æ•ˆ${invalidSlotsCount}æ¡`);
        }
        
        // é‡æ–°åˆ†æå­¦ç”Ÿæ•°æ®ï¼ˆè¿™ä¼šæ›´æ–° appState.studentsï¼‰
        analyzeStudentData(window.roomsData || []);
        
        // âœ… æ‰§è¡Œæ•°æ®å®Œæ•´æ€§æ£€æŸ¥
        const integrityReport = performDataIntegrityCheck();
        if (integrityReport.summary.totalIssues > 0) {
          const incomplete = (typeof listIncompleteStudents==='function') ? listIncompleteStudents() : [];
          console.warn('ğŸ” æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å‘ç°é—®é¢˜ æ€»è®¡='+integrityReport.summary.totalIssues, {
            issues: integrityReport.issues,
            incompleteStudents: incomplete
          });
        }
        
        // æ™ºèƒ½åŒæ­¥ï¼šæ£€æŸ¥æ•°æ®æ˜¯å¦çœŸæ­£å‘ç”Ÿå˜åŒ–å†æ›´æ–°æ’è¡Œæ¦œ
        const currentDataHash = generateDataHash();
        if (currentDataHash !== lastDataHash) {
          lastDataHash = currentDataHash;
          consecutiveNoChangeCount = 0;
          
          dbg('âœ… æ•°æ®ç¡®å®å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°æ’è¡Œæ¦œ');
          // ğŸ”§ ä½¿ç”¨ç»Ÿä¸€çš„æ’è¡Œæ¦œåŒæ­¥ç³»ç»Ÿ
          if (window.__leaderboardSyncSystem) {
            window.__leaderboardSyncSystem.updateAllLeaderboards({ silent: true });
          } else if (typeof debouncedUpdateRanking === 'function') {
            // é™çº§ï¼šä½¿ç”¨æ—§çš„æ›´æ–°æ–¹å¼
            debouncedUpdateRanking();
          }
          if (typeof debouncedRenderHomeBins === 'function') debouncedRenderHomeBins();
        } else {
          consecutiveNoChangeCount++;
          dbg(`æ•°æ®æ— å˜åŒ– (è¿ç»­${consecutiveNoChangeCount}æ¬¡)`);
          
          // å¦‚æœè¿ç»­å¤šæ¬¡æ— å˜åŒ–ï¼Œé™ä½æ›´æ–°é¢‘ç‡
          if (consecutiveNoChangeCount >= 5) {
            dbg('è¿ç»­æ— å˜åŒ–ï¼Œè·³è¿‡UIæ›´æ–°');
            return;
          }
        }
        
      } catch (error) {
        console.error('æ•°æ®å¤„ç†å¤±è´¥:', error);
        setConnectionStatus('offline', 'å¤„ç†å¤±è´¥');
      }
    }
    
    // ==== åŸå§‹æ•°æ®è·å–å‡½æ•°ï¼ˆå®Œæ•´åŒæ­¥ï¼‰ ====
    async function fetchAllData() {
      dbg('=== fetchAllData å¼€å§‹æ‰§è¡Œ ===');
      if (!isConnected) {
        dbg('fetchAllData: è¿æ¥æœªå»ºç«‹ï¼Œè·³è¿‡');
        return;
      }
      
      try {
        setConnectionStatus('syncing', 'åŒæ­¥æ•°æ®...');
        dbg('å¼€å§‹ Supabase æŸ¥è¯¢...');
        
        const now = Date.now();
        const weekAgo = now - 8 * 24 * 60 * 60 * 1000;
        
        // âœ… å®Œæ•´è¡¨ç»“æ„æ•°æ®è·å– - ç¡®ä¿æ‰€æœ‰å¿…è¦å­—æ®µéƒ½è¢«è·å–
        const [logsData, metaResult, slotsData, roomsResult] = await Promise.all([
          // ğŸ“ practice_logs: è·å–å®Œæ•´ç»ƒç´è®°å½•ï¼ˆåŒ…å«æ–°æ—§å­—æ®µå…¼å®¹æ€§ï¼‰
          fetchAllRowsPaginated({
            table: 'practice_logs',
            select: 'id, created_at, action, room_name, student_name, timestamp, location, piano_type, student_major, student_grade, session_start, session_end, practice_duration',
            orderBy: 'timestamp',
            ascending: true,
            pageSize: 1000,
            apply: (q) => q.gte('timestamp', new Date(weekAgo).toISOString())
          }),
          // ğŸ‘¥ student_database: è·å–å­¦ç”ŸåŸºæœ¬ä¿¡æ¯ï¼ˆæ’é™¤å·²å½’æ¡£å­¦ç”Ÿï¼‰
          supabaseClient
            .from('student_database')
            .select('id, name, major, grade, archived, remark, created_at, updated_at')
            .eq('archived', false), // åªè·å–æœªå½’æ¡£çš„å­¦ç”Ÿ
          // â° student_time_slots: è·å–å®Œæ•´æ—¶é—´æ®µé…ç½®
          fetchAllRowsPaginated({
            table: 'student_time_slots',
            select: 'id, weekday, start_time, end_time, duration_minutes, created_at, student_name, updated_at',
            orderBy: 'id',
            ascending: true,
            pageSize: 1000
          }),
          // ğŸ“Š rooms: è·å–å®Œæ•´æˆ¿é—´ä¿¡æ¯
          supabaseClient
            .from('rooms')
            .select('name, piano_type, location, remark, heartbeat_at, version, updated_at, occupant_student_name, register_time')
        ]);

        if (metaResult && metaResult.error) {
          console.error('å­¦ç”Ÿä¿¡æ¯æŸ¥è¯¢é”™è¯¯:', metaResult.error);
          throw metaResult.error;
        }
        if(!roomsResult || roomsResult.error){
          console.warn('æˆ¿é—´æ•°æ®æŸ¥è¯¢å¼‚å¸¸:', roomsResult && roomsResult.error ? roomsResult.error.message : 'è¿”å›ç©ºå¯¹è±¡');
        }
        
        dbg('=== å¼€å§‹å¤„ç†æ•°æ® ===');
        dbg('ç»ƒç´æ—¥å¿—æ•°é‡:', Array.isArray(logsData) ? logsData.length : 0);
        dbg('å­¦ç”Ÿä¿¡æ¯æ•°é‡:', metaResult.data?.length || 0);
        dbg('æ—¶é—´æ®µæ•°æ®æ•°é‡:', Array.isArray(slotsData) ? slotsData.length : 0);
        
        // å­˜å‚¨åˆ°å…¨å±€å˜é‡ä»¥ä¾›å·®å¼‚åŒæ­¥ä½¿ç”¨
        window.practiceLogsData = logsData || [];
        window.studentDatabaseData = metaResult.data || [];
        window.studentTimeSlotsData = slotsData || [];
        window.roomsData = roomsResult.data || [];
        
        // æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
        needsDataUpdate('practice_logs', window.practiceLogsData);
        needsDataUpdate('student_database', window.studentDatabaseData);
        needsDataUpdate('student_time_slots', window.studentTimeSlotsData);
        needsDataUpdate('rooms', window.roomsData);
        
        // âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯å’Œå¤„ç†
        appState.practiceLogs = logsData || [];
        
        // ğŸ“ ç»ƒç´æ—¥å¿—æ•°æ®éªŒè¯å’Œæ ‡å‡†åŒ–
        if(!Array.isArray(appState.practiceLogsNormalized)) appState.practiceLogsNormalized = [];
        appState.practiceLogsNormalized = appState.practiceLogs.map(r => {
          // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
          if (!r.student_name || !r.room_name || !r.action || !r.timestamp) {
            console.warn('ç»ƒç´æ—¥å¿—æ•°æ®ä¸å®Œæ•´:', r);
          }
          
          return {
            id: r.id,
            student_name: r.student_name || r.student || r.studentName || '',
            room_name: r.room_name || r.room || r.roomName || '',
            action: (r.action || '').toLowerCase(),
            timestamp: r.timestamp,
            location: r.location || '',
            piano_type: r.piano_type || '',
            student_major: r.student_major || '',
            student_grade: r.student_grade || '',
            // ä¼˜å…ˆä½¿ç”¨æ–°åˆ—ï¼Œå›é€€æ—§åˆ—
            session_start: r.session_start || r.start_time || null,
            session_end: r.session_end || r.end_time || null,
            practice_duration: r.practice_duration || r.duration || null,
            created_at: r.created_at || null
          };
        });
        
        // ğŸ“Š æ•°æ®è´¨é‡ç»Ÿè®¡
        const validLogs = appState.practiceLogsNormalized.filter(r => 
          r.student_name && r.room_name && r.action && r.timestamp
        );
        dbg(`ğŸ“ ç»ƒç´æ—¥å¿—è´¨é‡æ£€æŸ¥: æ€»è®¡${appState.practiceLogsNormalized.length}æ¡, æœ‰æ•ˆ${validLogs.length}æ¡`);
        
        if (validLogs.length !== appState.practiceLogsNormalized.length) {
          console.warn(`å‘ç°${appState.practiceLogsNormalized.length - validLogs.length}æ¡ä¸å®Œæ•´çš„ç»ƒç´æ—¥å¿—`);
        }
        
        // ğŸ‘¥ å­¦ç”Ÿä¿¡æ¯æ•°æ®éªŒè¯å’Œå¤„ç†
        appState.studentsMeta.clear();
        (metaResult.data || []).forEach(student => {
          // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
          if (!student.name) {
            console.warn('å­¦ç”Ÿä¿¡æ¯ç¼ºå°‘å§“å:', student);
            return;
          }
          
          const norm = utils.normalizeStudentName(student.name);
          appState.studentsMeta.set(norm, {
            id: student.id,
            major: student.major || '',
            grade: student.grade || '',
            archived: student.archived || false,
            remark: student.remark || '',
            created_at: student.created_at || null,
            updated_at: student.updated_at || null
            // external_id å­—æ®µå·²ä»åç«¯ç§»é™¤ï¼Œä¿ç•™æ³¨é‡Šé˜²æ­¢è¯¯ç”¨
          });
        });
        
        dbg(`ğŸ‘¥ å­¦ç”Ÿä¿¡æ¯å¤„ç†å®Œæˆ: ${appState.studentsMeta.size}åå­¦ç”Ÿ`);

        // === è¡¥ä¸ï¼šå‰”é™¤å·²ä¸åœ¨ student_database çš„æ—§ç¼“å­˜å­¦ç”Ÿ ===
        (function purgeRemovedStudents(){
          if(!appState.students || !(appState.students instanceof Map)) return;
          const currentNames = new Set((metaResult.data||[]).map(s=>utils.normalizeStudentName(s.name||'')));
          const removed = [];
          for(const name of Array.from(appState.students.keys())){
            if(!currentNames.has(utils.normalizeStudentName(name))){
              removed.push(name);
              appState.students.delete(name);
            }
          }
          if(removed.length){
            try{ localStorage.removeItem('rank_cache_v2'); }catch(_){ }
            if(window.__scoreCache) window.__scoreCache.clear();
            dbg('å·²å‰”é™¤å·²åˆ é™¤å­¦ç”Ÿå¹¶å¤±æ•ˆæ’è¡Œæ¦œç¼“å­˜:', removed);
          }
        })();
        
        // â° æ—¶é—´æ®µé…ç½®æ•°æ®éªŒè¯å’Œå¤„ç†
        appState.timeSlots.clear();
        dbg('â° æ—¶é—´æ®µåŸå§‹æ•°æ®:', Array.isArray(slotsData) ? `${slotsData.length}æ¡è®°å½•` : 'æ•°æ®æ ¼å¼å¼‚å¸¸');
        
        // å¤„ç†æ—¶é—´æ®µæ•°æ® - å¢å¼ºéªŒè¯ç‰ˆæœ¬
        if (Array.isArray(slotsData) && slotsData.length > 0) {
          let validSlots = 0;
          let invalidSlots = 0;
          
          slotsData.forEach(slot => {
            // æ•°æ®å®Œæ•´æ€§éªŒè¯
            const nameRaw = slot?.student_name ?? slot?.student ?? slot?.studentName ?? slot?.name ?? '';
            const weekdayRaw = slot.weekday ?? slot.day_of_week ?? slot.dow;
            const startTime = slot.start_time ?? slot.start; // å­—ç¬¦ä¸² "HH:MM"
            const endTime = slot.end_time ?? slot.end;       // å­—ç¬¦ä¸² "HH:MM"
            
            if (!nameRaw || weekdayRaw == null || !startTime || !endTime) {
              console.warn('æ—¶é—´æ®µæ•°æ®ä¸å®Œæ•´:', {
                id: slot.id,
                student_name: nameRaw,
                weekday: weekdayRaw,
                start_time: startTime,
                end_time: endTime
              });
              invalidSlots++;
              return;
            }
            
            const name = utils.normalizeStudentName(nameRaw);
            const weekday = utils.normalizeWeekday(weekdayRaw);
            
            if (!name || !isFinite(weekday)) {
              console.warn('æ—¶é—´æ®µæ•°æ®å¤„ç†å¤±è´¥:', {
                originalName: nameRaw,
                normalizedName: name,
                originalWeekday: weekdayRaw,
                normalizedWeekday: weekday
              });
              invalidSlots++;
              return;
            }
            
            if (!appState.timeSlots.has(name)) {
              appState.timeSlots.set(name, {});
            }
            const timeMap = appState.timeSlots.get(name);
            if (!timeMap[weekday]) timeMap[weekday] = [];
            timeMap[weekday].push({ 
                id: slot.id,
                start_time: startTime, 
                end_time: endTime,
                duration_minutes: slot.duration_minutes || 0,
                created_at: slot.created_at || null,
                updated_at: slot.updated_at || null
              });
            validSlots++;
          });
          
          dbg(`â° æ—¶é—´æ®µå¤„ç†å®Œæˆ: æœ‰æ•ˆ${validSlots}æ¡, æ— æ•ˆ${invalidSlots}æ¡, è¦†ç›–${appState.timeSlots.size}åå­¦ç”Ÿ`);
        }
        
        // ğŸ“Š æˆ¿é—´æ•°æ®éªŒè¯å’Œå¤„ç†
        const roomsData = (roomsResult && Array.isArray(roomsResult.data)) ? roomsResult.data : [];
        if (!roomsResult || !Array.isArray(roomsResult.data)) {
          console.warn('ğŸ“Š æˆ¿é—´æ•°æ®æ ¼å¼å¼‚å¸¸:', roomsResult);
          dbg('roomsResult éé¢„æœŸæ ¼å¼ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
        }
        
        // æˆ¿é—´æ•°æ®è´¨é‡æ£€æŸ¥
        let validRooms = 0;
        let occupiedRooms = 0;
        
        roomsData.forEach(room => {
          if (!room.name) {
            console.warn('æˆ¿é—´æ•°æ®ç¼ºå°‘åç§°:', room);
            return;
          }
          
          validRooms++;
          if (room.occupant_student_name) {
            occupiedRooms++;
          }
        });
        
        dbg(`ğŸ“Š æˆ¿é—´çŠ¶æ€ç»Ÿè®¡: æ€»è®¡${roomsData.length}é—´, æœ‰æ•ˆ${validRooms}é—´, å ç”¨${occupiedRooms}é—´`);
        
        // åˆ†ææ•°æ®å¹¶ç”Ÿæˆå­¦ç”ŸçŠ¶æ€
        analyzeStudentData(roomsData);
        
        // æ™ºèƒ½åŒæ­¥ï¼šæ£€æŸ¥æ•°æ®æ˜¯å¦çœŸæ­£å‘ç”Ÿå˜åŒ–å†æ›´æ–°æ’è¡Œæ¦œ
        const currentDataHash = generateDataHash(appState.students);
        if (!lastDataHash || lastDataHash !== currentDataHash) {
          dbg('æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ¸…é™¤ç¼“å­˜å¹¶æ›´æ–°æ’è¡Œæ¦œ');
          // ğŸ”§ ä½¿ç”¨ç»Ÿä¸€çš„æ’è¡Œæ¦œåŒæ­¥ç³»ç»Ÿ
          if (window.__leaderboardSyncSystem) {
            window.__leaderboardSyncSystem.updateAllLeaderboards({ force: true, silent: true });
          } else if (typeof debouncedUpdateRanking === 'function') {
            // é™çº§ï¼šä½¿ç”¨æ—§çš„æ›´æ–°æ–¹å¼
            // æ¸…é™¤æ‰€æœ‰ç¼“å­˜ç¡®ä¿ä¸€è‡´æ€§
            try {
              localStorage.removeItem('rank_cache_v2');
              rankingDataCache = null;
              lastRankingUpdateTime = 0;
            } catch(_) {}
            debouncedUpdateRanking();
          }
          lastDataHash = currentDataHash;
        } else {
          dbg('æ•°æ®æœªå˜åŒ–ï¼Œè·³è¿‡æ’è¡Œæ¦œæ›´æ–°');
        }
        
        setConnectionStatus('online', 'å·²è¿æ¥');
        
      } catch (error) {
        console.error('æ•°æ®è·å–å¤±è´¥:', error);
        try { showToast('æ•°æ®è·å–å¤±è´¥: '+ (error && error.message ? error.message : 'æœªçŸ¥é”™è¯¯')); } catch(_){}
        setConnectionStatus('offline', 'åŒæ­¥å¤±è´¥');
      }
    }

  function analyzeStudentData(roomsData) {
      appState.students.clear();
      
      // ä»ç»ƒç´æ—¥å¿—åˆ†ææ¯ä¸ªå­¦ç”Ÿçš„æ•°æ®
      const studentLogs = new Map();
      
      appState.practiceLogs.forEach(log => {
        const studentName = utils.normalizeStudentName(log.student_name || log.student || log.studentName);
        if (!studentName) return;
        
        if (!studentLogs.has(studentName)) {
          studentLogs.set(studentName, []);
        }
        studentLogs.get(studentName).push(log);
      });
      
      // è·å–æ‰€æœ‰å­¦ç”Ÿï¼ˆåŒ…æ‹¬æœ‰æ—¶é—´æ®µé…ç½®ä½†æ²¡æœ‰ç»ƒç´æ—¥å¿—çš„å­¦ç”Ÿï¼‰
      const allStudentNames = new Set();
      
      // ä»ç»ƒç´æ—¥å¿—ä¸­è·å–å­¦ç”Ÿåå•
      studentLogs.forEach((logs, studentName) => {
        allStudentNames.add(studentName);
      });
      
      // ä»å­¦ç”Ÿæ•°æ®åº“ä¸­è·å–å­¦ç”Ÿåå•
      appState.studentsMeta.forEach((meta, studentName) => {
        allStudentNames.add(studentName);
      });
      
      // ä»æ—¶é—´æ®µé…ç½®ä¸­è·å–å­¦ç”Ÿåå•
      appState.timeSlots.forEach((slots, studentName) => {
        allStudentNames.add(studentName);
      });
      
      // è°ƒè¯•æ—¶æ®µæ•°æ®çŠ¶æ€
      dbg('=== æ—¶æ®µæ•°æ®çŠ¶æ€æ£€æŸ¥ ===');
      dbg('timeSlots æ€»æ•°:', appState.timeSlots.size);
      dbg('timeSlots æ‰€æœ‰é”®:', Array.from(appState.timeSlots.keys()));
      dbg('ç‹ç”³å´šçš„æ—¶æ®µæ•°æ®:', appState.timeSlots.get('ç‹ç”³å´š'));
      
      // å¤„ç†æ¯ä¸ªå­¦ç”Ÿçš„æ•°æ®
  dbg('æ‰€æœ‰å­¦ç”Ÿåå•:', Array.from(allStudentNames));
      allStudentNames.forEach(studentName => {
        const studentData = new StudentData(studentName);
        const logs = studentLogs.get(studentName) || [];
        processStudentLogs(studentData, logs);
        
  dbg(`å­¦ç”Ÿ ${studentName} çš„æ•°æ®:`, {
          todayMinutes: studentData.todayMinutes,
          hasSchedule: hasScheduleToday(studentName),
          timeSlots: appState.timeSlots.get(studentName)
        });
        
        // æ£€æŸ¥å½“å‰çŠ¶æ€ï¼ˆä»roomsè¡¨ï¼‰ - æ”¯æŒå¤šäººç™»è®°
        const currentRoom = roomsData.find(room => {
          const occupant = utils.normalizeStudentName(room.occupant_student_name || room.occupant_student || room.occupant);
          if (!occupant) return false;
          // æ”¯æŒå¤šäººç™»è®°ï¼šæ£€æŸ¥å­¦ç”Ÿæ˜¯å¦åœ¨é€—å·åˆ†éš”çš„åˆ—è¡¨ä¸­
          const occupants = occupant.split(',').map(s => s.trim());
          return occupants.includes(studentName);
        });
        
        if (currentRoom) {
          // è·¨æ—¥/è¿‡æœŸä¼šè¯ä¿æŠ¤ï¼šåªåœ¨â€œè‡ªç„¶æ—¥â€ä¸ºä»Šå¤©ä¸”åœ¨ç»Ÿè®¡çª—å£(07:30-21:30)å†…æ‰è®¤å®šä¸ºå½“å‰ç»ƒç´
          let startTs = null;
          if (currentRoom.register_time) {
            try {
              startTs = new Date(currentRoom.register_time);
              // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆæ—¥æœŸ
              if (isNaN(startTs.getTime())) {
                startTs = null;
              }
            } catch (e) {
              console.warn('è§£ææ³¨å†Œæ—¶é—´å¤±è´¥:', currentRoom.register_time, e);
              startTs = null;
            }
          }
          
          const now = new Date();
          const isSameDay = startTs && startTs.getFullYear()===now.getFullYear() && startTs.getMonth()===now.getMonth() && startTs.getDate()===now.getDate();
          

          
          // âœ… ç§»é™¤æ—¶é—´çª—å£é™åˆ¶ï¼Œæ”¯æŒ24å°æ—¶çŠ¶æ€æ˜¾ç¤º
          if(isSameDay && startTs){
            studentData.currentStatus = getCurrentPracticeStatus(studentName);
            studentData.currentRoom = currentRoom.name || currentRoom.room_name || 'æœªçŸ¥æˆ¿é—´';
            studentData.currentStartTime = startTs;
          }else{
            // âœ… å¤‡ç”¨é€»è¾‘ï¼šä»ä»Šæ—¥æ—¥å¿—ä¸­æŸ¥æ‰¾æ­£åœ¨è¿›è¡Œçš„ä¼šè¯
            const todayLogs = (appState.practiceLogsNormalized || appState.practiceLogs || [])
              .filter(log => {
                if (log.student_name !== studentName) return false;
                const logDate = new Date(log.timestamp);
                return logDate.getFullYear() === now.getFullYear() && 
                       logDate.getMonth() === now.getMonth() && 
                       logDate.getDate() === now.getDate();
              });
            
            if (todayLogs.length > 0) {
              const sessions = buildPracticeSessions(todayLogs, studentName);
              const ongoingSession = sessions.find(s => !s.endTime);
              
              if (ongoingSession) {
                studentData.currentStatus = getCurrentPracticeStatus(studentName);
                studentData.currentRoom = currentRoom.name || currentRoom.room_name || 'æœªçŸ¥æˆ¿é—´';
                studentData.currentStartTime = ongoingSession.startTime;
              } else {
                // æœ‰æˆ¿é—´å ç”¨ä½†æ— æ­£åœ¨è¿›è¡Œçš„ä¼šè¯ï¼šå¯èƒ½æ˜¯è·¨æ—¥ä¼šè¯
                studentData.currentStatus = 'offline';
                studentData.currentRoom = null;
                studentData.currentStartTime = null;
              }
            } else {
              // è¿‡æœŸï¼šè§†ä¸ºç¦»çº¿
              studentData.currentStatus = 'offline';
              studentData.currentRoom = null;
              studentData.currentStartTime = null;
            }
          }
        }
        
        appState.students.set(studentName, studentData);
      });
      
  // æ›´æ–°UI
  updateStatistics();
  updateViews();
      // è¡¥å¿ï¼šè‹¥é€‰ä¸­å­¦ç”Ÿä»æ— å¼€å§‹æ—¶é—´ï¼Œå°è¯•ä»æ—¥å¿—æ¨å¯¼
      if(uiState.selectedStudent){
        deriveCurrentSessionForStudent(uiState.selectedStudent);
      }
    }

  /**
   * ğŸ”„ è¡¥å¿æ¨å¯¼å½“å‰ä¼šè¯ï¼ˆä¸æ”¹å˜ç»Ÿè®¡å£å¾„ï¼Œåªç”¨äº UI æ˜¾ç¤º currentStartTime / æ—¶é•¿ï¼‰
   */
  function deriveCurrentSessionForStudent(studentName){
    try{
      const student = appState.students.get(studentName);
      if(!student) return;
      // ç»Ÿä¸€å®Œå…¨ä½¿ç”¨æ—¥å¿—æ¨å¯¼ï¼Œä¸å†ä¾èµ– rooms å ç”¨ï¼›ç¡®ä¿çŠ¶æ€å•ä¸€æ¥æºé¿å…â€œæˆ¿é—´è¿˜æ²¡é‡Šæ”¾â€å‡é˜³æ€§
      const live = computeLiveSessionFromLogs(studentName);
      if(live.active){
        student.currentStartTime = live.start;
        student.currentRoom = live.room || 'æœªçŸ¥æˆ¿é—´';
        const scheduled = (typeof isCurrentlyScheduled==='function') ? isCurrentlyScheduled(studentName) : false;
        student.currentStatus = scheduled ? 'practicing-in' : 'practicing-out';
      } else {
        student.currentStatus = 'offline';
        student.currentRoom = null;
        student.currentStartTime = null;
      }
      if(uiState.view==='detail' && uiState.selectedStudent===studentName){
        const startEl=document.getElementById('currentStartTime');
        const durEl=document.getElementById('currentDuration');
        const roomEl=document.getElementById('currentRoom');
        if(startEl) startEl.textContent = student.currentStartTime ? utils.formatTime(student.currentStartTime) : '--';
        if(roomEl) roomEl.textContent = student.currentRoom || '--';
        if(durEl){
          if(student.currentStartTime){
            const now=new Date();
            const mins=Math.max(0,Math.round((now-student.currentStartTime)/60000));
            durEl.textContent = utils.formatDuration(mins);
          }else{
            durEl.textContent='--';
          }
        }
      }
    }catch(e){ console.warn('deriveCurrentSessionForStudent error', e); }
  }

  // æ˜¾å¼åˆ·æ–°æŸå­¦ç”Ÿ live çŠ¶æ€ï¼ˆä¾›å¢é‡æ—¥å¿—å›è°ƒ/é‡å¤ clear æ—¶ä½¿ç”¨ï¼‰
  function updateStudentLiveStatus(studentName){
    try{ deriveCurrentSessionForStudent(studentName); }catch(e){ console.warn('updateStudentLiveStatus error', e); }
  }

  // åŸºäº practice_logs æ¨å¯¼å½“å‰æ˜¯å¦æœ‰æœªç»“æŸä¼šè¯
  function computeLiveSessionFromLogs(studentName){
    try{
      const logs = (appState.practiceLogsNormalized || appState.practiceLogs || []).filter(l=> l.student_name===studentName);
      if(!logs.length) return {active:false};
      const today = new Date(); today.setHours(0,0,0,0);
      const nextDay = new Date(today.getTime()+86400000);
      const todayLogs = logs.filter(l=>{ const d=new Date(l.timestamp); return d>=today && d<nextDay; }).sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp));
      if(!todayLogs.length) return {active:false};
      // æ ¸å¿ƒï¼šå¯»æ‰¾æœ€åä¸€ä¸ª assign æœªè¢«å…¶åçš„ clear åŒ¹é…
      let stack=[]; // å…è®¸åµŒå¥—ä½†åŸºæœ¬ä¸ä¼šå‘ç”Ÿï¼›ç”¨æ ˆä¿è¯é¡ºåº
      for(const r of todayLogs){
        const act=(r.action||'').toLowerCase();
        if(act.includes('assign')){
          stack.push(r);
        }else if(act.includes('clear')){
          // åŒ¹é…æœ€è¿‘ä¸€æ¬¡ assign
            stack.pop();
        }
      }
      if(!stack.length) return {active:false};
      const lastAssign = stack[stack.length-1];
      return {active:true,start:new Date(lastAssign.timestamp),room:lastAssign.room_name||lastAssign.room||lastAssign.roomName||null};
    }catch(e){ console.warn('computeLiveSessionFromLogs error', e); return {active:false}; }
  }

  // Hook å¢é‡æ—¥å¿—è¿½åŠ ï¼šå®æ—¶è¡¥å¿å½“å‰ä¼šè¯æ˜¾ç¤º
  if(typeof appendPracticeLogIncremental === 'function' && !window.__appendPatched){
    window.__appendPatched = true;
    const __origAppend = appendPracticeLogIncremental;
    appendPracticeLogIncremental = function(row){
      const ret = __origAppend(row);
      if(uiState?.selectedStudent && row?.student_name === uiState.selectedStudent){
        updateStudentLiveStatus(uiState.selectedStudent);
      }
      // å¯¹ä»»æ„å­¦ç”Ÿï¼šå¦‚æœæ˜¯ clear/assign äº‹ä»¶ç«‹å³æ›´æ–°è¯¥å­¦ç”Ÿ live çŠ¶æ€
      try {
        if(row?.student_name && /(assign|clear|enter|exit)/i.test(row.action||'')){
          updateStudentLiveStatus(row.student_name);
        }
      } catch(e) { console.warn('global live refresh error', e); }
      return ret;
    }
  }

  /**
  * æ ¹æ®æ—¥å¿—æ„å»ºæ—¥åŒºé—´å¹¶è®¡ç®—ä»Šæ—¥/è¿‘7å¤©ç»ƒç´åˆ†é’Ÿæ•°ï¼ˆå‰”é™¤ä¼‘æ¯æ—¶é—´ä¸æ— æ•ˆæ—¶é—´æ®µï¼‰ã€‚
  * æ³¨ï¼šæ€»ä½“ç»Ÿè®¡çª—å£å·²é‡‡ç”¨ 07:30-21:30ï¼ˆå«å‘¨æœ«ï¼‰ï¼Œæ’è¡Œæ¦œä½¿ç”¨ç‹¬ç«‹çª—å£ï¼šå‘¨ä¸€/äºŒ/å››/äº” 08:00-19:00ï¼Œå‘¨ä¸‰ 08:00-19:30ï¼›æ’è¡Œæ¦œæ—¥ç•Œå®š 07:30 åˆ‡æ¢ã€‚
   */
  function processStudentLogs(studentData, logs) {
  // ä¸é¢„å…ˆè¿‡æ»¤æ—¥å¿—ï¼Œå…ˆæŒ‰ assign/clear é…å¯¹ï¼Œå†å°†æ‰€å¾—åŒºé—´è£å‰ªåˆ°æœ‰æ•ˆçª—å£
  // è¿™æ ·å¯é¿å…ä¸€ç«¯è½åœ¨çª—å£å¤–å¯¼è‡´æ•´æ®µè¢«ä¸¢å¼ƒçš„æƒ…å†µï¼ˆå¦‚ 07:59-08:20 æˆ– 18:50-19:10ï¼‰
  dbg(`å­¦ç”Ÿ ${studentData.name}: åŸå§‹æ—¥å¿— ${logs.length} æ¡ï¼ˆå°†å…ˆé…å¯¹åè£å‰ªï¼‰`);

  const sortedLogs = [...logs].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      
      const today = new Date();
      const todayKey = utils.getDateKey(today);
      const dayIntervals = new Map(); // dateKey -> intervals
      
      let currentSessionStart = null;
      
      // æ„å»ºç»ƒç´åŒºé—´
      sortedLogs.forEach(log => {
        const timestamp = new Date(log.timestamp);
        const dateKey = utils.getDateKey(timestamp);
        
        if (!dayIntervals.has(dateKey)) {
          dayIntervals.set(dateKey, []);
        }
        
        if (log.action === 'assign') {
          if (!currentSessionStart) {
            currentSessionStart = timestamp;
          }
        } else if (log.action === 'clear' && currentSessionStart) {
          // è®°å½•ä¸€ä¸ªå®Œæ•´çš„ç»ƒç´åŒºé—´
          const startDay = utils.getDateKey(currentSessionStart);
          const endDay = dateKey;
          
          if (startDay === endDay) {
            // åŒä¸€å¤©ï¼šè£å‰ªåˆ°å¯¹åº”æ˜ŸæœŸçš„æœ‰æ•ˆæ—¶é—´çª—å£
            const dayWindow = getEffectiveDayWindow(currentSessionStart);
            const rawStart = utils.minutesFromDayStart(currentSessionStart);
            const rawEnd = utils.minutesFromDayStart(timestamp);
            const clampedStart = Math.max(rawStart, dayWindow.start);
            const clampedEnd = Math.min(rawEnd, dayWindow.end);
            if (clampedEnd > clampedStart) {
              dayIntervals.get(dateKey).push({ start: clampedStart, end: clampedEnd });
              dbg(`åŒºé—´(åŒæ—¥) ${startDay} åŸå§‹ ${rawStart}-${rawEnd} è£å‰ªä¸º ${clampedStart}-${clampedEnd}`);
            } else {
              dbg(`ä¸¢å¼ƒåŒºé—´(åŒæ—¥) ${startDay} åŸå§‹ ${rawStart}-${rawEnd}ï¼ˆä¸æœ‰æ•ˆçª—å£æ— äº¤é›†ï¼‰`);
            }
          } else {
            // è·¨å¤©å¤„ç†ï¼š
            // ç¬¬ä¸€å¤©ï¼šmax(start, å½“å¤©å¼€å§‹æ—¶é—´) -> å½“å¤©ç»“æŸæ—¶é—´
            const firstDayWindow = getEffectiveDayWindow(currentSessionStart);
            const startMinutes = utils.minutesFromDayStart(currentSessionStart);
            const dayStartLimit = firstDayWindow.start;
            const dayEndLimit = firstDayWindow.end;
            const firstDayStart = Math.max(startMinutes, dayStartLimit);
            if (firstDayStart < dayEndLimit) {
              if (!dayIntervals.has(startDay)) dayIntervals.set(startDay, []);
              dayIntervals.get(startDay).push({ start: firstDayStart, end: dayEndLimit });
              dbg(`åŒºé—´(è·¨æ—¥-é¦–æ—¥) ${startDay} åŸå§‹ ${startMinutes}-? è£å‰ªä¸º ${firstDayStart}-${dayEndLimit}`);
            } else {
              dbg(`ä¸¢å¼ƒåŒºé—´(è·¨æ—¥-é¦–æ—¥) ${startDay} åŸå§‹ ${startMinutes}-?ï¼ˆä¸æœ‰æ•ˆçª—å£æ— äº¤é›†ï¼‰`);
            }

            // ç¬¬äºŒå¤©ï¼šå½“å¤©å¼€å§‹æ—¶é—´ -> min(clear, å½“å¤©ç»“æŸæ—¶é—´)
            const secondDayWindow = getEffectiveDayWindow(timestamp);
            const endMinutes = utils.minutesFromDayStart(timestamp);
            const secondDayEnd = Math.min(endMinutes, secondDayWindow.end);
            if (secondDayEnd > secondDayWindow.start) {
              if (!dayIntervals.has(endDay)) dayIntervals.set(endDay, []);
              dayIntervals.get(endDay).push({ start: secondDayWindow.start, end: secondDayEnd });
              dbg(`åŒºé—´(è·¨æ—¥-æ¬¡æ—¥) ${endDay} åŸå§‹ ?-${endMinutes} è£å‰ªä¸º ${secondDayWindow.start}-${secondDayEnd}`);
            } else {
              dbg(`ä¸¢å¼ƒåŒºé—´(è·¨æ—¥-æ¬¡æ—¥) ${endDay} åŸå§‹ ?-${endMinutes}ï¼ˆä¸æœ‰æ•ˆçª—å£æ— äº¤é›†ï¼‰`);
            }
          }
          
          currentSessionStart = null;
          studentData.totalSessions++;
        }
      });
      
      // å¦‚æœè¿˜æœ‰æœªç»“æŸçš„ä¼šè¯ï¼Œè®¡ç®—åˆ°ç°åœ¨æˆ–å½“æ—¥ç»Ÿè®¡æˆªæ­¢ï¼ˆ21:30ï¼‰ï¼Œä¸è¶…è¿‡å½“å¤©æœ‰æ•ˆæ—¶é—´
      if (currentSessionStart) {
        const now = new Date();
        const nowWindow = getEffectiveDayWindow(now);
        const nowMinutes = utils.minutesFromDayStart(now);
        
        // åªè¦å½“å‰æ—¶é—´æœªæ—©äºå¼€å§‹çª—å£ï¼Œå°±å°†ä¼šè¯ç»“ç®—åˆ° min(å½“å‰æ—¶åˆ», æˆªæ­¢ 21:30)
        if (nowMinutes >= nowWindow.start) {
          const startDay = utils.getDateKey(currentSessionStart);
          const nowDay = utils.getDateKey(now);
          
          if (startDay === nowDay) {
            const rawStart = utils.minutesFromDayStart(currentSessionStart);
            const clampedStart = Math.max(rawStart, nowWindow.start);
            const clampedEnd = Math.min(nowMinutes, nowWindow.end);
            if (clampedEnd > clampedStart) {
              if (!dayIntervals.has(nowDay)) {
                dayIntervals.set(nowDay, []);
              }
              dayIntervals.get(nowDay).push({ start: clampedStart, end: clampedEnd });
              dbg(`åŒºé—´(æœªç»“æŸ-åŒæ—¥) ${nowDay} åŸå§‹ ${rawStart}-${nowMinutes} è£å‰ªä¸º ${clampedStart}-${clampedEnd}`);
            }
          }
        }
        
        studentData.totalSessions++;
      }
      
      // è®¡ç®—ä»Šæ—¥å’Œæœ¬å‘¨çš„ç»ƒç´æ—¶é—´
      dayIntervals.forEach((intervals, dateKey) => {
        const date = new Date(dateKey + 'T00:00:00');
        const dayData = calculateDayPracticeTime(studentData.name, date, intervals);
        
        if (dateKey === todayKey) {
          studentData.todayMinutes = dayData;
          studentData.isPresent = dayData.in > 0;
        }
        
        // è®¡ç®—æ˜¯å¦åœ¨æœ¬å‘¨èŒƒå›´å†…ï¼ˆè¿‡å»7å¤©ï¼‰
        const daysDiff = Math.floor((today - date) / (24 * 60 * 60 * 1000));
        if (daysDiff >= 1 && daysDiff <= 7) {
          studentData.weekMinutes.in += dayData.in;
          studentData.weekMinutes.out += dayData.out;
        }
      });
      
      // è®¡ç®—æˆå°±ç‡å’Œè¿ç»­å¤©æ•°
      studentData.achievementRate = calculateAchievementRate(studentData.name, studentData.todayMinutes.in);
      studentData.weekStreak = calculateWeekStreak(studentData.name, dayIntervals);
    }

  /**
   * è®¡ç®—æŸæ—¥çš„â€œè§„å®šæ—¶é—´å†…â€å’Œâ€œè§„å®šæ—¶é—´å¤–â€çš„åˆ†é’Ÿæ•°ã€‚
   * ä¼šåœ¨å‰”é™¤ä¼‘æ¯æ—¶é—´åå†ä¸å­¦ç”Ÿä¸ªæ€§åŒ–æ—¶æ®µè¿›è¡Œäº¤é›†è®¡ç®—ã€‚
   */
  function calculateDayPracticeTime(studentName, date, intervals) {
      const dateKey = utils.getDateKey(date);
      
      // æ£€æŸ¥ practiceLogs æ˜¯å¦å­˜åœ¨
      if (!appState.practiceLogs || !Array.isArray(appState.practiceLogs)) {
        console.warn('practiceLogs not available for calculateDayPracticeTime');
        return { in: 0, out: 0 };
      }
      
      const studentLogs = appState.practiceLogs.filter(log => {
        const logStudentName = log.student_name || log.student || log.studentName;
        return logStudentName === studentName && utils.getDateKey(new Date(log.timestamp)) === dateKey;
      });

      if (studentLogs.length === 0) {
        return { in: 0, out: 0 };
      }

      // æ„å»ºå½“å¤©çš„ç»ƒç´é—´éš” - ä¸calculateDayDataä¿æŒä¸€è‡´
      const sessions = buildPracticeSessions(studentLogs, studentName);
      const dayWindow = getEffectiveDayWindow(date);
      const sessionIntervals = sessions.map(session => {
        const start = utils.minutesFromDayStart(new Date(session.start));
        const end = session.end ? utils.minutesFromDayStart(new Date(session.end)) : utils.minutesFromDayStart(new Date());
        // è£å‰ªåˆ°å½“å¤©çš„æœ‰æ•ˆæ—¶é—´çª—å£
        return { start: Math.max(start, dayWindow.start), end: Math.min(end, dayWindow.end) };
      }).filter(i => i.end > i.start);

      // å‰”é™¤ä¼‘æ¯æ—¶é—´ï¼ˆå‘¨æœ«ä¸å‰”é™¤ï¼‰
      const weekday = utils.getWeekday(date);
      let practiceIntervals;
      if (weekday === 6 || weekday === 7) {
        // å‘¨æœ«ï¼šç›´æ¥ä½¿ç”¨è£å‰ªåçš„ sessionIntervals
        practiceIntervals = sessionIntervals;
      } else {
        const breaks = weekday === 3 ? BREAK_SCHEDULE.wed : BREAK_SCHEDULE.monTueThuFri;
        practiceIntervals = subtractBreaks(sessionIntervals, breaks);
      }
      
      // è·å–å­¦ç”Ÿçš„ä¸ªæ€§åŒ–æ—¶é—´çª—å£
      const timeSlots = utils.getStudentTimeSlots(studentName);
      // å°†å­—ç¬¦ä¸²å½¢å¼çš„ä¸ªæ€§åŒ–æ—¶æ®µè½¬æ¢ä¸ºåˆ†é’ŸåŒºé—´ï¼Œè‹¥æ— é…ç½®åˆ™ä½¿ç”¨é»˜è®¤çª—å£
      const daySlots = (timeSlots && timeSlots[weekday] && timeSlots[weekday].length > 0)
        ? timeSlots[weekday].map(slot => {
            if (typeof slot.start === 'number' && typeof slot.end === 'number') return slot; // å·²æ˜¯æ•°å€¼çª—å£
            const start = utils.parseTimeSlot(slot.start_time || slot.start);
            const end = utils.parseTimeSlot(slot.end_time || slot.end);
            return { start, end };
          }).filter(w => Number.isFinite(w.start) && Number.isFinite(w.end) && w.end > w.start)
        : [
            typeof DEFAULT_SCHEDULE_IN.start === 'number' ? DEFAULT_SCHEDULE_IN : {
              start: utils.parseTimeSlot(DEFAULT_SCHEDULE_IN.start_time || DEFAULT_SCHEDULE_IN.start || '08:00'),
              end: utils.parseTimeSlot(DEFAULT_SCHEDULE_IN.end_time || DEFAULT_SCHEDULE_IN.end || '19:30')
            }
          ];
      
      // åˆ†ç¦»æ®µå†…å’Œæ®µå¤–æ—¶é—´
      const { inTime, outTime } = splitByTimeWindows(practiceIntervals, daySlots);
      
      return {
        in: inTime,
        out: outTime
      };
    }
    
    // éªŒè¯ç»ƒç´æ—¶é—´æ˜¯å¦åœ¨æœ‰æ•ˆç»Ÿè®¡èŒƒå›´å†…ï¼ˆæŒ‰æ˜ŸæœŸå‡ åˆ¤æ–­ï¼‰
    function isValidPracticeTime(timestamp) {
      const date = new Date(timestamp);
      const window = getEffectiveDayWindow(date);
      const minutes = date.getHours() * 60 + date.getMinutes();
      return minutes >= window.start && minutes <= window.end;
    }

    function subtractBreaks(intervals, breaks) {
      let result = [...intervals];
      
      breaks.forEach(breakTime => {
        result = result.flatMap(interval => {
          if (interval.end <= breakTime.start || interval.start >= breakTime.end) {
            return [interval];
          }
          
          const parts = [];
          if (interval.start < breakTime.start) {
            parts.push({
              start: interval.start,
              end: Math.min(interval.end, breakTime.start)
            });
          }
          if (interval.end > breakTime.end) {
            parts.push({
              start: Math.max(interval.start, breakTime.end),
              end: interval.end
            });
          }
          return parts;
        });
      });
      
      return result;
    }

  /**
   * å°†ç»™å®šåŒºé—´æŒ‰çª—å£é›†åˆæ‹†åˆ†ä¸º in/out ä¸¤ç±»åˆ†é’Ÿæ€»å’Œã€‚
   */
  function splitByTimeWindows(intervals, windows) {
      let inTime = 0;
      let outTime = 0;
      
      intervals.forEach(interval => {
        const duration = interval.end - interval.start;
        
        // æ£€æŸ¥æ˜¯å¦ä¸ä»»ä½•æ—¶é—´çª—å£é‡å  - ä½¿ç”¨æ›´å‡†ç¡®çš„é‡å æ£€æµ‹
        const isInWindow = windows.some(window => {
          // ä¸¤ä¸ªåŒºé—´é‡å çš„æ¡ä»¶ï¼šinterval.start < window.end && interval.end > window.start
          return interval.start < window.end && interval.end > window.start;
        });
        
        if (isInWindow) {
          inTime += duration;
        } else {
          outTime += duration;
        }
      });
      
      return { inTime, outTime };
    }

  /**
  * è·å–å½“å‰æ—¶åˆ»å­¦ç”Ÿç»ƒç´çŠ¶æ€ï¼š
  * - æœ‰æ•ˆæ—¶é—´çª—å£ï¼ˆæ€»ä½“ç»Ÿè®¡ï¼‰ä¹‹å¤–ä¸€å¾‹ offlineï¼ˆæ€»ä½“ç»Ÿè®¡çª—å£ 07:30-21:30ï¼‰
  * - æ’è¡Œæ¦œçª—å£ä¸æ­¤ä¸åŒï¼ˆå‘¨1/2/4/5 08:00-19:00ï¼›å‘¨3 08:00-19:30ï¼›07:30 æ—¥ç•Œå®šä»…ç”¨äºæ’åå¤©åˆ‡æ¢ï¼‰
  * - å…¶ä½™æ ¹æ®æ˜¯å¦è½å…¥â€œè§„å®šæ—¶é—´æ®µå†…â€è¿”å› practicing-in / practicing-out
   */
  function getCurrentPracticeStatus(studentName) {
  // æ”¹ä¸ºä»…ä½¿ç”¨æ—¥å¿—å®æ—¶æ¨å¯¼ï¼Œé¿å…æˆ¿é—´æ»ç•™é€ æˆè¯¯åˆ¤
  const live = (typeof computeLiveSessionFromLogs==='function') ? computeLiveSessionFromLogs(studentName) : {active:false};
  if(!live.active) return 'offline';
  const scheduled = (typeof isCurrentlyScheduled==='function') ? isCurrentlyScheduled(studentName) : false;
  return scheduled ? 'practicing-in' : 'practicing-out';
    }

  /**
   * è®¡ç®—ä»Šæ—¥æˆå°±ç‡ï¼šä»Šæ—¥â€œè§„å®šæ—¶é—´å†…â€åˆ†é’Ÿ / ä»Šæ—¥â€œè§„å®šæ—¶é—´å†…â€ç›®æ ‡åˆ†é’Ÿï¼ˆåŸºäºæ—¶æ®µé…ç½®ï¼‰ã€‚
   */
  function calculateAchievementRate(studentName, todayInMinutes) {
      const today = new Date();
      const weekday = utils.getWeekday(today);
  const timeSlots = utils.getStudentTimeSlots(studentName);
      
      if (!timeSlots || !timeSlots[weekday]) return 0;
      // ç»Ÿä¸€è½¬æ¢ä¸ºåˆ†é’Ÿçª—å£
      const windows = timeSlots[weekday]
        .map(slot => {
          if (typeof slot.start === 'number' && typeof slot.end === 'number') return slot;
          const start = utils.parseTimeSlot(slot.start_time || slot.start);
          const end = utils.parseTimeSlot(slot.end_time || slot.end);
          return { start, end };
        })
        .filter(w => Number.isFinite(w.start) && Number.isFinite(w.end) && w.end > w.start);

      const totalScheduled = windows.reduce((sum, w) => sum + (w.end - w.start), 0);
      
      return totalScheduled > 0 ? Math.min(100, Math.round((todayInMinutes / totalScheduled) * 100)) : 0;
    }

    function calculateWeekStreak(studentName, dayIntervals) {
      const today = new Date();
      let streak = 0;
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateKey = utils.getDateKey(date);
        
        const intervals = dayIntervals.get(dateKey) || [];
        const dayData = calculateDayPracticeTime(studentName, date, intervals);
        
        if (dayData.in > 0) {
          streak++;
        } else if (i === 0) {
          break; // ä»Šå¤©æ²¡ç»ƒï¼Œè¿ç»­è®°å½•ä¸­æ–­
        }
      }
      
      return streak;
    }

    function hasScheduleToday(studentName) {
      const today = new Date();
      const weekday = utils.getWeekday(today);
  const timeSlots = utils.getStudentTimeSlots(studentName);
      return timeSlots && timeSlots[weekday] && timeSlots[weekday].length > 0;
    }

  /** æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åœ¨å­¦ç”Ÿçš„ç»ƒç´æ—¶æ®µå†…ï¼ˆåŸºäºä¸ªæ€§åŒ–æ—¶æ®µé…ç½®ï¼‰ */
    function isCurrentlyScheduled(studentName) {
      const now = new Date();
      const weekday = utils.getWeekday(now);
      const currentTime = now.getHours() * 60 + now.getMinutes(); // å½“å‰æ—¶é—´è½¬æ¢ä¸ºåˆ†é’Ÿ
      
  const timeSlots = utils.getStudentTimeSlots(studentName);
      if (!timeSlots || !timeSlots[weekday]) {
  dbg(`å­¦ç”Ÿ ${studentName} åœ¨æ˜ŸæœŸ${weekday}æ²¡æœ‰æ—¶é—´æ®µé…ç½®`);
        return false;
      }
      
      const isScheduled = timeSlots[weekday].some(slot => {
        // æ”¯æŒä¸¤ç§æ ¼å¼ï¼šå­—ç¬¦ä¸² start_time/end_time æˆ–æ•°å€¼ start/end
        let startMinutes, endMinutes;
        if (typeof slot.start === 'number' && typeof slot.end === 'number') {
          startMinutes = slot.start; endMinutes = slot.end;
        } else {
          const start = utils.parseTimeSlot(slot.start_time || slot.start);
          const end = utils.parseTimeSlot(slot.end_time || slot.end);
          startMinutes = start; endMinutes = end;
        }
        const inRange = currentTime >= startMinutes && currentTime < endMinutes;
        dbg(`å­¦ç”Ÿ ${studentName} æ—¶é—´æ®µ ${startMinutes}-${endMinutes}ï¼Œå½“å‰ ${currentTime}ï¼ŒinRange=${inRange}`);
        return inRange;
      });
      
  dbg(`å­¦ç”Ÿ ${studentName} å½“å‰æ˜¯å¦åº”è¯¥ç»ƒç´: ${isScheduled}`);
      return isScheduled;
    }

    // ==== UI æ¸²æŸ“å’Œäº¤äº’ ====
    function updateStatistics() { /* ç²¾ç®€ç‰ˆï¼šä¸æ˜¾ç¤ºé¡¶éƒ¨ç»Ÿè®¡ï¼Œä¿ç•™æ•°æ®è®¡ç®—å¤‡ç”¨ */ }

    const uiState = { 
      view: 'home', // 'home', 'list', 'detail'
      category: 'attendance', // 'attendance', 'absent', 'self-practice', 'not-practice'
      clickedElement: null,
      selectedStudent: null,
  previousView: null, // è®°å½•ä¸Šä¸€ä¸ªè§†å›¾ï¼Œç”¨äºæ§åˆ¶åŠ¨ç”»
  rankingOrigin: null // è®°å½•è¿›å…¥â€œå®Œæ•´æ’è¡Œæ¦œâ€çš„æ¥æºï¼ˆhome æˆ– listï¼‰
    };

    // æ’è¡Œæ¦œæ˜¾ç¤ºæ¨¡å¼
    let rankingMode = 'daily'; // 'daily' æˆ– 'weekly'
    // æ’è¡Œæ¦œæ¨¡å¼ HTML å†…å­˜ç¼“å­˜ï¼Œé¿å…æ—¥/å‘¨åˆ‡æ¢é—ªçƒ
    if(!window.rankingModeHtmlCache){
      window.rankingModeHtmlCache = { daily: null, weekly: null };
    }
    const RANKING_FADE_CLASS = 'ranking-fade-in';

    // ç®¡ç†å‘˜æ¨¡å¼ç›¸å…³
    let adminMode = false;
  const ADMIN_PASSWORD = 'gaifen2022';
    // ä¸å†ä¾èµ– localStorage æŒä¹…åŒ–è°ƒåˆ†ï¼ˆä¹‹å‰å·²ç§»é™¤ï¼‰ï¼Œä»…å†…å­˜ç¼“å­˜
    const adminScoreAdjustments = {};
  // æ’è¡Œæ¦œç¼“å­˜ keyï¼ˆä¾›é¦–é¡µå°æ¦œä¸å®Œæ•´æ¦œå…±äº« & æ¸…ç†ï¼‰
  const RANK_CACHE_KEY = 'rank_cache_v2';
  // ç»Ÿä¸€è§„åˆ™ç‰ˆæœ¬ï¼ˆé¿å…ç¡¬ç¼–ç åˆ†æ•£ & ç¡®ä¿ NOT NULL çº¦æŸï¼‰
  const RULE_VERSION = 'LB442-2025-09-24';
    // è‡ªå®šä¹‰å¼‚æ­¥å¯†ç å¼¹çª—ï¼Œæ¯æ¬¡éƒ½è¦æ±‚è¾“å…¥å¯†ç 
    function ensureAdminAuthenticated(){
      return new Promise(resolve => {
        if(document.querySelector('.admin-auth-dialog')) return; // å·²å­˜åœ¨åˆ™ä¸é‡å¤
        const wrap = document.createElement('div');
        wrap.className = 'admin-auth-dialog';
        wrap.innerHTML = `
          <div class="admin-auth-backdrop"></div>
          <div class="admin-auth-content">
            <h3 style="margin:0 0 16px;font-size:18px;color:#111827;font-weight:600;">ç®¡ç†å‘˜éªŒè¯</h3>
            <label style="display:block;font-size:14px;color:#374151;margin-bottom:6px;">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </label>
            <div style="position:relative;">
              <input id="adminAuthPassword" type="password" autocomplete="off" placeholder="å¯†ç " style="width:100%;padding:10px 40px 10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;outline:none;">
              <button type="button" id="adminAuthToggle" aria-label="æ˜¾ç¤º/éšè—å¯†ç " style="position:absolute;right:8px;top:50%;transform:translateY(-50%);border:none;background:transparent;cursor:pointer;font-size:16px;">ğŸ‘ï¸</button>
            </div>
            <div id="adminAuthError" style="color:#ef4444;font-size:12px;min-height:16px;margin-top:6px;"></div>
            <div style="display:flex;justify-content:flex-end;margin-top:20px;gap:8px;">
              <button type="button" id="adminAuthCancel" style="padding:8px 16px;border:1px solid #d1d5db;background:white;border-radius:6px;cursor:pointer;font-size:14px;">å–æ¶ˆ</button>
              <button type="button" id="adminAuthOk" style="padding:8px 16px;background:#2563eb;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;">ç¡®è®¤</button>
            </div>
          </div>`;
        const style = document.createElement('style');
        style.textContent = `
          .admin-auth-dialog{position:fixed;inset:0;z-index:11000;display:flex;align-items:center;justify-content:center;font-family:inherit;}
          .admin-auth-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);}
          .admin-auth-content{position:relative;background:#fff;border-radius:10px;padding:24px 24px 20px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);width:90%;max-width:360px;animation:adminAuthPop .18s ease;}
          @keyframes adminAuthPop{0%{transform:scale(.92);opacity:0;}100%{transform:scale(1);opacity:1;}}
          .admin-auth-shake{animation:adminAuthShake .4s;}@keyframes adminAuthShake{10%,90%{transform:translateX(-1px);}20%,80%{transform:translateX(2px);}30%,50%,70%{transform:translateX(-4px);}40%,60%{transform:translateX(4px);}}
        `;
        document.head.appendChild(style);
        document.body.appendChild(wrap);
        const inputEl = wrap.querySelector('#adminAuthPassword');
        const errEl = wrap.querySelector('#adminAuthError');
        const okBtn = wrap.querySelector('#adminAuthOk');
        const cancelBtn = wrap.querySelector('#adminAuthCancel');
        const toggleBtn = wrap.querySelector('#adminAuthToggle');
        function close(res){ wrap.remove(); resolve(res); }
        toggleBtn.addEventListener('click',()=>{
          if(inputEl.type==='password'){ inputEl.type='text'; toggleBtn.textContent='ğŸ™ˆ'; }
          else { inputEl.type='password'; toggleBtn.textContent='ğŸ‘ï¸'; }
          inputEl.focus();
        });
        okBtn.addEventListener('click',()=>{
          const v = inputEl.value.trim();
          if(v===ADMIN_PASSWORD){ close(true); }
          else { errEl.textContent='å¯†ç é”™è¯¯'; wrap.querySelector('.admin-auth-content').classList.remove('admin-auth-shake'); void wrap.querySelector('.admin-auth-content').offsetWidth; wrap.querySelector('.admin-auth-content').classList.add('admin-auth-shake'); inputEl.focus(); inputEl.select(); }
        });
        cancelBtn.addEventListener('click',()=>close(false));
        wrap.querySelector('.admin-auth-backdrop').addEventListener('click',()=>close(false));
        inputEl.addEventListener('keydown',e=>{ if(e.key==='Enter') okBtn.click(); if(e.key==='Escape') close(false); });
        document.addEventListener('keydown',function escHandler(e){ if(e.key==='Escape'){ document.removeEventListener('keydown',escHandler); if(document.body.contains(wrap)) close(false);} });
        setTimeout(()=>inputEl.focus(),50);
      });
    }
    
    // ç›‘å¬å¿«æ·é”®è¿›å…¥ç®¡ç†å‘˜æ¨¡å¼ (Mac: Cmd+Shift+Option+A, Windows: Ctrl+Shift+Alt+A)
    document.addEventListener('keydown', async function(e) {
      const isMac = navigator.platform.toUpperCase().includes('MAC');
      const ctrlOrCmd = isMac ? e.metaKey : e.ctrlKey;
      const altOrOption = e.altKey;
      
      // ä½¿ç”¨ keyCode æˆ– code æ¥ç¡®ä¿è·¨å¹³å°å…¼å®¹æ€§
      const isAKey = e.key === 'A' || e.key === 'a' || e.code === 'KeyA' || e.keyCode === 65;
      
      if (ctrlOrCmd && e.shiftKey && altOrOption && isAKey) {
        e.preventDefault();
        if(!adminMode){
          const ok = await ensureAdminAuthenticated();
          if(!ok) return; // æœªé€šè¿‡éªŒè¯ä¸è¿›å…¥
        }
        toggleAdminMode();
      }
    });

    function mapStudentToCardData(s) {
      const meta = appState.studentsMeta.get(s.name) || {};
  // ç»Ÿä¸€ä»Šæ—¥æ€»æ—¶é•¿å£å¾„ï¼ˆæ®µå†…+æ®µå¤–ï¼‰ï¼Œæ’é™¤ NaN å¹¶å‘ä¸‹å–æ•´
  const totalMinutes = getTodayTotalMinutes(s);
      
      return {
        name: s.name,
        metaText: `${meta.grade || ''}${meta.grade ? ' Â· ' : ''}${meta.major || ''}`,
        minutes: Math.round(totalMinutes),
        status: s.currentStatus !== 'offline' ? 'active' : 'offline',
      };
    }

    // ç»Ÿä¸€ä»Šæ—¥æ€»æ—¶é•¿è®¡ç®—ï¼ˆåˆ—è¡¨ä¸è¯¦æƒ…å…±ç”¨ï¼‰
    function getTodayTotalMinutes(student){
      if(!student || !student.todayMinutes) return 0;
      const a = Number(student.todayMinutes.in)||0;
      const b = Number(student.todayMinutes.out)||0;
      return Math.max(0, Math.round(a + b));
    }

    // ====== åˆ—è¡¨å¡ç‰‡å®æ—¶åˆ·æ–°ï¼ˆä¸è¯¦æƒ…æ€»è®¡ä¿æŒåŒæ­¥ï¼‰ ======
    // æ€è·¯ï¼šè¯¦æƒ…é¡µä»Šæ—¥æ€»è®¡ä½¿ç”¨ calculateDayData(è¿›è¡Œä¸­ä¼šè¯æœªç»“æŸæ—¶ä»¥å½“å‰æ—¶é—´è®¡å…¥)ã€‚
    // åˆ—è¡¨åˆæ¬¡æ¸²æŸ“åŸºäº student.todayMinutesï¼ˆé™æ€ï¼‰ï¼Œæ— æ³•ä½“ç°â€œè¿›è¡Œä¸­â€å¢é•¿ã€‚
    // è¿™é‡Œä¸ºåˆ—è¡¨æ·»åŠ ä¸€ä¸ªè½»é‡å¢é‡åˆ·æ–°ï¼š
    // 1. æ¯ 30 ç§’ï¼ˆå«è¿›å…¥åˆ—è¡¨ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼‰éå†å¯è§ stu-card
    // 2. ä» appState.students å–å­¦ç”Ÿå¯¹è±¡ -> å¤åˆ¶å…¶ç›¸å…³æ—¥å¿—é‡æ–°ç”¨ calculateDayData è®¡ç®—ä»Šæ—¥æ€»è®¡
    // 3. è‹¥æ˜¾ç¤ºå€¼å˜åŒ–åˆ™æ›´æ–° DOMï¼Œæ·»åŠ è½»å¾®åŠ¨ç”»é¿å…é—ªçƒ
    // 4. ä¸é‡æ–°æ•´ä½“ renderStudentListï¼Œé¿å…æ‰“æ–­åŠ¨ç”»ä¸æ»šåŠ¨ä½ç½®
    // æ€§èƒ½ï¼šå‡è®¾æœ€å¤š N=200 å­¦ç”Ÿï¼Œæ¯æ¬¡è®¡ç®— O(N)ï¼›calculateDayData å†…éƒ¨è¿‡æ»¤å½“å¤©æ—¥å¿—ï¼Œå·²è¾ƒå°ï¼›30 ç§’ä¸€æ¬¡å½±å“å¯å¿½ç•¥ã€‚

    let listCardRefreshTimer = null;

    function computeLiveTodayTotal(student){
      try {
        // å¤ç”¨ calculateDayData ä»¥ä¿è¯å£å¾„ç»Ÿä¸€ï¼ˆåŒ…æ‹¬è¿›è¡Œä¸­ä¼šè¯è£å‰ªçª—å£é€»è¾‘ï¼‰
        return (calculateDayData(student.name, new Date()).in + calculateDayData(student.name, new Date()).out) || 0;
      } catch(e){
        return getTodayTotalMinutes(student);
      }
    }

    function refreshListCardTimes(){
      if(uiState.view !== 'list') return; // ä»…åœ¨åˆ—è¡¨è§†å›¾
      const grid = document.getElementById('studentGrid');
      if(!grid) return;
      const cards = grid.querySelectorAll('.stu-card');
      if(!cards.length) return;
      const now = Date.now();
      cards.forEach(card=>{
        const name = card.getAttribute('data-name');
        if(!name) return;
        const student = appState.students.get(name);
        if(!student) return;
        const domMinsEl = card.querySelector('.stu-mins');
        if(!domMinsEl) return;
        const liveTotal = computeLiveTodayTotal(student);
        const newText = utils.formatDurationFull(Math.max(0, liveTotal));
        if(domMinsEl.textContent !== newText){
          domMinsEl.textContent = newText;
          // è¿‡æ¸¡åŠ¨ç”»
          domMinsEl.style.animation = 'cardUpdate 0.6s ease';
          setTimeout(()=>{ domMinsEl.style.animation=''; }, 650);
        }
      });
    }

    function startListCardRefresh(){
      if(listCardRefreshTimer) return; // é˜²é‡
      refreshListCardTimes(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œä¿è¯è¿›å…¥åˆ—è¡¨åå³åŒæ­¥
      listCardRefreshTimer = setInterval(refreshListCardTimes, 30000); // 30 ç§’
      console.log('[åˆ—è¡¨å¡ç‰‡åˆ·æ–°] å¯åŠ¨');
    }

    function stopListCardRefresh(){
      if(listCardRefreshTimer){
        clearInterval(listCardRefreshTimer);
        listCardRefreshTimer = null;
        console.log('[åˆ—è¡¨å¡ç‰‡åˆ·æ–°] åœæ­¢');
      }
    }

  /**
   * é¦–é¡µåˆ†ç»„ç»Ÿè®¡ï¼š
   * - attendance: å½“å‰åº”ç»ƒä¸”å½“å‰æ­£åœ¨ç»ƒï¼ˆå®æ—¶ currentStatusï¼‰
   * - absent: å½“å‰åº”ç»ƒä½†å½“å‰æœªç»ƒ
   * - selfPractice: å½“å‰ä¸åº”ç»ƒä½†å½“å‰åœ¨ç»ƒ
   * - notPractice: å½“å‰ä¸åº”ç»ƒä¸”å½“å‰æœªç»ƒ
   */
  function getGroups() {
      const all = Array.from(appState.students.values());
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      const weekday = now.getDay();
      
  dbg(`å½“å‰æ—¶é—´: ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')} (${currentTime}åˆ†é’Ÿ), æ˜ŸæœŸ${weekday}`);
  dbg('æ‰€æœ‰å­¦ç”Ÿæ•°æ®:', all.map(s => ({ 
        name: s.name, 
        todayMinutes: s.todayMinutes, 
        currentStatus: s.currentStatus 
      })));
  dbg('æ—¶é—´æ®µé…ç½®:', Array.from(appState.timeSlots.entries()));
      
      // è·å–å½“å‰æ—¶é—´æ®µåº”è¯¥ç»ƒç´çš„å­¦ç”Ÿ
      const currentlyScheduled = all.filter(s => isCurrentlyScheduled(s.name));
      
  dbg('å½“å‰åº”è¯¥ç»ƒç´çš„å­¦ç”Ÿ:', currentlyScheduled.map(s => s.name));
      
      // åˆ†ç±»é€»è¾‘ï¼šåŸºäºå½“å‰æ—¶é—´æ®µå’Œå®æ—¶çŠ¶æ€
      // å‡ºå‹¤ï¼šå½“å‰æ—¶é—´æ®µåº”è¯¥ç»ƒç´ä¸”å½“å‰æ­£åœ¨ç»ƒç´çš„å­¦ç”Ÿ
      const attendance = currentlyScheduled.filter(s => s.currentStatus !== 'offline');
      
      // ç¼ºå‹¤ï¼šå½“å‰æ—¶é—´æ®µåº”è¯¥ç»ƒç´ä½†å½“å‰æ²¡æœ‰ç»ƒç´çš„å­¦ç”Ÿ
      const absent = currentlyScheduled.filter(s => s.currentStatus === 'offline');
      
      // è‡ªä¸»ç»ƒç´ï¼šå½“å‰æ—¶é—´æ®µä¸éœ€è¦ç»ƒç´ä½†å½“å‰æ­£åœ¨ç»ƒç´çš„å­¦ç”Ÿ
      const notScheduledNow = all.filter(s => !isCurrentlyScheduled(s.name));
      const selfPractice = notScheduledNow.filter(s => s.currentStatus !== 'offline');
      
      // æœªç»ƒç´ï¼šå½“å‰æ—¶é—´æ®µä¸éœ€è¦ç»ƒç´ä¸”å½“å‰æ²¡æœ‰ç»ƒç´çš„å­¦ç”Ÿ
      const notPractice = notScheduledNow.filter(s => s.currentStatus === 'offline');
      
      // å½“å‰åº”ç»ƒç´äººæ•°ï¼ˆå½“å‰æ—¶é—´æ®µåº”è¯¥ç»ƒç´çš„å­¦ç”Ÿï¼‰
      const shouldPracticeNow = currentlyScheduled.length;
      const totalCount = all.length;

  dbg(`åˆ†ç±»ç»“æœ: å‡ºå‹¤${attendance.length}äºº, ç¼ºå‹¤${absent.length}äºº, è‡ªä¸»ç»ƒç´${selfPractice.length}äºº, æœªç»ƒç´${notPractice.length}äºº`);
  dbg(`å½“å‰åº”ç»ƒç´äººæ•°: ${shouldPracticeNow}, æ€»äººæ•°: ${totalCount}`);
  dbg('è¯¦ç»†åˆ†ç±»:', {
        attendance: attendance.map(s => ({ name: s.name, status: s.currentStatus })),
        absent: absent.map(s => ({ name: s.name, status: s.currentStatus })),
        selfPractice: selfPractice.map(s => ({ name: s.name, status: s.currentStatus })),
        notPractice: notPractice.map(s => ({ name: s.name, status: s.currentStatus }))
      });

      return { attendance, absent, selfPractice, notPractice, shouldPracticeNow, totalCount, mapped: false };
    }

    // åˆå§‹åŠ è½½æ ‡å¿—å’Œç”¨æˆ·äº¤äº’æ ‡å¿—
    let isInitialLoad = true;
    let userHasInteracted = false;
    let smartSelectionApplied = false; // ç¡®ä¿æ™ºèƒ½é€‰æ‹©åªåº”ç”¨ä¸€æ¬¡
    
    // æ™ºèƒ½é€‰æ‹©ä¼˜å…ˆæ˜¾ç¤ºçš„åˆ†ç±»
    function selectPriorityCategory(groups) {
      const { attendance, selfPractice, notPractice } = groups;
      
      dbg(`ğŸ” æ™ºèƒ½é€‰æ‹©åˆ†æ:`);
      dbg(`  - å‡ºå‹¤: ${attendance.length}äºº ${attendance.map(s => s.name).join(', ')}`);
      dbg(`  - è‡ªä¸»: ${selfPractice.length}äºº ${selfPractice.map(s => s.name).join(', ')}`);
      dbg(`  - æœªç»ƒ: ${notPractice.length}äºº ${notPractice.map(s => s.name).join(', ')}`);
      
      // ä¼˜å…ˆçº§åˆ¤æ–­ï¼šå‡ºå‹¤ > è‡ªä¸» > æœªç»ƒ
      if (attendance.length > 0) {
        dbg(`ğŸ¯ æ™ºèƒ½é€‰æ‹©ç»“æœ: "å‡ºå‹¤" (${attendance.length}äºº)`);
        return 'attendance';
      } else if (selfPractice.length > 0) {
        dbg(`ğŸ¯ æ™ºèƒ½é€‰æ‹©ç»“æœ: "è‡ªä¸»" (${selfPractice.length}äºº)`);
        return 'self-practice';
      } else {
        dbg(`ğŸ¯ æ™ºèƒ½é€‰æ‹©ç»“æœ: "æœªç»ƒ" (${notPractice.length}äºº) - é»˜è®¤é€‰é¡¹`);
        return 'not-practice'; // é»˜è®¤æœªç»ƒ
      }
    }
    
    // æ›´æ–°åˆ†ç±»æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
    function updateCategoryTabs(selectedCategory) {
      const categoryTabs = document.querySelectorAll('.category-tab');
      let foundTab = false;
      categoryTabs.forEach(tab => {
        if (tab.dataset.category === selectedCategory) {
          tab.classList.add('active');
          foundTab = true;
        } else {
          tab.classList.remove('active');
        }
      });
      
      if (foundTab) {
        dbg(`âœ… åˆ†ç±»æŒ‰é’®å·²æ›´æ–°ä¸º: ${selectedCategory}`);
      } else {
        dbg(`âš ï¸ æœªæ‰¾åˆ°åˆ†ç±»æŒ‰é’®: ${selectedCategory}`);
      }
    }

    function renderHomeBins() {
      const groups = getGroups();
      const { attendance, absent, selfPractice, notPractice, shouldPracticeNow, totalCount } = groups;
      
      // æ™ºèƒ½åˆ†ç±»é€‰æ‹©ï¼šä»…åœ¨æ•°æ®å‡†å¤‡å¥½ä¸”ç”¨æˆ·æœªäº¤äº’æ—¶æ‰§è¡Œä¸€æ¬¡
      const totalStudents = attendance.length + absent.length + selfPractice.length + notPractice.length;
      
      dbg(`ğŸ“‹ æ™ºèƒ½é€‰æ‹©çŠ¶æ€æ£€æŸ¥:`);
      dbg(`  - smartSelectionApplied: ${smartSelectionApplied}`);
      dbg(`  - userHasInteracted: ${userHasInteracted}`);
      dbg(`  - totalStudents: ${totalStudents}`);
      dbg(`  - å½“å‰åˆ†ç±»: ${uiState.category}`);
      
      if (!smartSelectionApplied && !userHasInteracted && totalStudents > 0) {
        dbg('âœ… æ¡ä»¶æ»¡è¶³ï¼Œæ‰§è¡Œæ™ºèƒ½åˆ†ç±»é€‰æ‹©...');
        dbg(`ğŸ“Š å½“å‰æ•°æ®ç»Ÿè®¡: å‡ºå‹¤${attendance.length}äºº, ç¼ºå‹¤${absent.length}äºº, è‡ªä¸»${selfPractice.length}äºº, æœªç»ƒ${notPractice.length}äºº`);
        
        const priorityCategory = selectPriorityCategory(groups);
        const oldCategory = uiState.category;
        
        uiState.category = priorityCategory;
        updateCategoryTabs(priorityCategory);
        smartSelectionApplied = true;
        
        dbg(`ğŸ¯ æ™ºèƒ½é€‰æ‹©å®Œæˆ: ${oldCategory} â†’ ${priorityCategory}`);
      } else if (!smartSelectionApplied && userHasInteracted) {
        dbg('âŒ ç”¨æˆ·å·²äº¤äº’ï¼Œè·³è¿‡æ™ºèƒ½é€‰æ‹©');
        smartSelectionApplied = true;
      } else if (!smartSelectionApplied && totalStudents === 0) {
        dbg('â³ æ•°æ®å°šæœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿæ™ºèƒ½é€‰æ‹©...');
      } else if (smartSelectionApplied) {
        dbg('âœ¨ æ™ºèƒ½é€‰æ‹©å·²åº”ç”¨è¿‡ï¼Œè·³è¿‡');
      }
      
      // æ ‡è®°åˆå§‹åŠ è½½å®Œæˆï¼ˆç”¨äºå…¶ä»–é€»è¾‘ï¼‰
      if (isInitialLoad) {
        isInitialLoad = false;
      }
      
      // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
      const today = new Date();
      const dateStr = `${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
      const elDate = document.getElementById('currentDate');
      if (elDate) elDate.textContent = dateStr;
      
      // æ ¹æ®å½“å‰é€‰ä¸­çš„åˆ†ç±»æ›´æ–°æ˜¾ç¤º
      const categoryData = {
        'attendance': { 
          data: attendance, 
          label: 'å‡ºå‹¤äººæ•°å å½“å‰åº”ç»ƒç´äººæ•°çš„æ¯”ä¾‹', 
          color: '#22c55e',
          denominator: shouldPracticeNow
        },
        'absent': { 
          data: absent, 
          label: 'ç¼ºå‹¤äººæ•°å å½“å‰åº”ç»ƒç´äººæ•°çš„æ¯”ä¾‹', 
          color: '#ef4444',
          denominator: shouldPracticeNow
        },
        'self-practice': { 
          data: selfPractice, 
          label: 'è‡ªä¸»ç»ƒç´äººæ•°å æ€»äººæ•°çš„æ¯”ä¾‹', 
          color: '#f59e0b',
          denominator: totalCount
        },
        'not-practice': { 
          data: notPractice, 
          label: 'æœªç»ƒç´äººæ•°å æ€»äººæ•°çš„æ¯”ä¾‹', 
          color: '#3b82f6', // è“è‰²
          denominator: totalCount
        }
      };
      
      // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ uiState.category æœ‰æ•ˆ
      if (!categoryData[uiState.category]) {
        console.warn(`âš ï¸ æ— æ•ˆçš„åˆ†ç±»: ${uiState.category}ï¼Œé‡ç½®ä¸º attendance`);
        uiState.category = 'attendance';
        updateCategoryTabs('attendance');
      }

      const currentCategory = categoryData[uiState.category];
      const currentCount = currentCategory.data.length;
      const denominatorCount = currentCategory.denominator;
      // ç¡®ä¿ percentage æ˜¯æ•°å­—ï¼Œé¿å… NaN
      let percentage = 0;
      if (denominatorCount > 0) {
        percentage = Math.round((currentCount / denominatorCount) * 100);
      }
      if (isNaN(percentage)) percentage = 0;
      
      requestAnimationFrame(() => {
        // æ›´æ–°ç™¾åˆ†æ¯”å’Œäººæ•°
        const elPercentage = document.getElementById('progressPercentage');
        if(elPercentage) {
            elPercentage.textContent = percentage;
            // ç¡®ä¿å…ƒç´ å¯è§
            elPercentage.style.display = ''; 
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°å…ƒç´ : progressPercentage');
        }
        
        const elCount = document.getElementById('progressCount');
        if(elCount) {
            elCount.textContent = currentCount;
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°å…ƒç´ : progressCount');
        }
        
        const elDesc = document.getElementById('progressDescription');
        if(elDesc) elDesc.textContent = currentCategory.label;
        
        // æ›´æ–°åœ†å½¢è¿›åº¦æ¡
        const progressPath = document.getElementById('progressPath');
        if(progressPath) {
          const circumference = 2 * Math.PI * 70; // åœ†å‘¨é•¿ï¼ŒåŠå¾„ä¸º70
          const offset = circumference - (percentage / 100) * circumference;
          
          // è®¾ç½®åœ†å½¢è¿›åº¦æ¡æ ·å¼
          progressPath.style.strokeDasharray = circumference;
          progressPath.style.strokeDashoffset = offset;
          progressPath.style.stroke = currentCategory.color;
        }

        // æŒ‰é’®çŠ¶æ€æç¤ºï¼šå½“è¯¥åˆ†ç±»æ²¡äººæ—¶ï¼Œç»™å‡ºæç¤ºæ–‡æ¡ˆï¼ˆä»å…è®¸ç‚¹å‡»ï¼Œç‚¹å‡»æ—¶å°†å¼¹å‡ºæç¤ºï¼Œä¸è·³é¡µï¼‰
        const detailsBtn = document.getElementById('viewDetailsBtn');
        if (detailsBtn) {
          if (currentCount === 0) {
            detailsBtn.title = 'å½“å‰åˆ†ç±»æš‚æ— å­¦ç”Ÿ';
            detailsBtn.setAttribute('aria-disabled', 'true');
          } else {
            detailsBtn.title = 'æŸ¥çœ‹è¯¦æƒ…';
            detailsBtn.removeAttribute('aria-disabled');
          }
        }
      });
    }
    
    function renderUserAvatars(users) {
      const container = document.getElementById('userAvatars');
      const maxShow = 4;
      const showUsers = users.slice(0, maxShow);
      const remainingCount = Math.max(0, users.length - maxShow);
      
      let html = '';
      showUsers.forEach(user => {
        const initials = utils.getStudentInitials(user.name);
        html += `<div class="user-avatar">${initials}</div>`;
      });
      
      if (remainingCount > 0) {
        html += `<div class="user-avatar more">+${remainingCount}</div>`;
      }
      
      requestAnimationFrame(() => {
        if(container) container.innerHTML = html;
      });
    }

    function renderStudentList(category) {
  // é˜²æŠ–/å»é‡ï¼šå¦‚æœæ•°æ®ç­¾åæœªå˜åŒ–åˆ™ä¸é‡ç»˜ï¼Œé¿å…è¿”å›è¯¦æƒ…é¡µæ—¶å¤šæ¬¡è§¦å‘å¯¼è‡´é—ªçƒ
  if(!window.__studentListRender){ window.__studentListRender={ lastSig:null }; }
      const groups = getGroups();
      const categoryMap = {
        'attendance': groups.attendance,
        'absent': groups.absent,
        'self-practice': groups.selfPractice,
        'not-practice': groups.notPractice
      };
      
      const categoryLabels = {
        'attendance': 'å‡ºå‹¤å­¦ç”Ÿï¼ˆè§„å®šæ—¶é—´å†…ç»ƒç´ï¼‰',
        'absent': 'ç¼ºå‹¤å­¦ç”Ÿï¼ˆè§„å®šæ—¶é—´å†…æœªç»ƒç´ï¼‰',
        'self-practice': 'è‡ªä¸»ç»ƒç´ï¼ˆè§„å®šæ—¶é—´å¤–ç»ƒç´ï¼‰',
        'not-practice': 'æœªç»ƒç´ï¼ˆç›®å‰æœªç»ƒç´ï¼‰'
      };
      
      const list = categoryMap[category] || [];
      const grid = document.getElementById('studentGrid');
      const title = document.getElementById('listTitle');
      title.textContent = categoryLabels[category];

      const items = list.map(mapStudentToCardData);

      // ç”Ÿæˆç­¾åï¼šåˆ†ç±»|äººæ•°|æ¯äºº name:minutes:status æŒ‰å§“åæ’åº
      const sig = (()=>{
        const sorted=[...items].sort((a,b)=>a.name.localeCompare(b.name));
        return category + '|' + sorted.length + '|' + sorted.map(s=>`${s.name}:${s.minutes}:${s.status}`).join(',');
      })();
      if(window.__studentListRender.lastSig === sig){
        return; // æ— å˜åŒ–ï¼Œè·³è¿‡
      }
      window.__studentListRender.lastSig = sig;

      const isMobile = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
      const html = items.map((s, index) => `
        <div class=\"stu-card\" data-name=\"${s.name}\" style=\"${isMobile ? '' : `animation-delay: ${Math.min(index * 15, 180)}ms;`}\" onclick=\"openStudentDetail('${s.name}')\">
          <div class=\"stu-line1\">
            <span class=\"status-dot ${category}\"></span>
            <span class=\"stu-name\">${s.name}</span>
          </div>
          <div class=\"stu-meta\">${s.metaText || ''}</div>
          <div class=\"stu-mins\">${utils.formatDurationFull(Math.max(0, s.minutes))}</div>
          <div class=\"stu-detail\">ä»Šæ—¥æ€»ç»ƒä¹ æ—¶é•¿</div>
        </div>
      `).join('');
      scheduleDOM(()=>{ grid.innerHTML = html; }, 2);
    }

    function updateViews() {
      console.log('updateViews è¢«è°ƒç”¨ï¼Œå½“å‰ uiState.view:', uiState.view);
      
      const home = document.getElementById('homeView');
      const list = document.getElementById('listView');
      const detail = document.getElementById('detailView');
  const ranking = document.getElementById('rankingView');
      
      console.log('è§†å›¾å…ƒç´ çŠ¶æ€:', {
        home: home ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
        list: list ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨', 
        detail: detail ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
        ranking: ranking ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'
      });
      
  if (uiState.view === 'home') {
        // æ”¶èµ·åˆ—è¡¨è§†å›¾å’Œè¯¦æƒ…è§†å›¾
        const isMobile = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
        
        if (!list.hidden) {
          list.classList.remove('expanding');
          if (isMobile) {
            scheduleDOM(()=>{ list.hidden = true; home.hidden = false; },1);
          } else {
            setTimeout(() => { scheduleDOM(()=>{ list.hidden = true; home.hidden = false; },1); }, 90);
          }
        } else { scheduleDOM(()=>{ home.hidden = false; },1); }
        if (ranking) {
          ranking.classList.remove('expanding');
          ranking.hidden = true;
        }
        if (detail) {
          detail.classList.remove('active');
          if (isMobile) {
            // ç§»åŠ¨ç«¯ï¼šç«‹å³éšè—è¯¦æƒ…é¡µ
            detail.hidden = true;
          } else {
            // æ¡Œé¢ç«¯ï¼šçŸ­åŠ¨ç”»
            setTimeout(() => {
              detail.hidden = true;
            }, 120);
          }
        }
        renderHomeBins();
        
        // ğŸ”§ è¿”å›é¦–é¡µæ—¶ï¼Œåˆ·æ–°å°æ’è¡Œæ¦œç¡®ä¿æ•°æ®æœ€æ–°
        if (window.__leaderboardSyncSystem) {
          // é™é»˜æ›´æ–°é¦–é¡µå°æ¦œå’Œå®Œæ•´æ¦œç¼“å­˜
          setTimeout(() => {
            window.__leaderboardSyncSystem.updateAllLeaderboards({ silent: true });
          }, 300); // å»¶è¿Ÿ300msï¼Œé¿å…é˜»å¡åŠ¨ç”»
        } else if (typeof updateRanking === 'function') {
          // é™çº§ï¼šä½¿ç”¨æ—§çš„æ›´æ–°æ–¹å¼
          setTimeout(() => updateRanking(), 300);
        }
      } else if (uiState.view === 'list') {
        // å±•å¼€åˆ—è¡¨è§†å›¾
        home.hidden = true;
        if (ranking) {
          ranking.classList.remove('expanding');
          ranking.hidden = true;
        }
        if (detail) {
          detail.classList.remove('active');
          detail.hidden = true;
        }
        list.hidden = false;
        // æ— è®ºä»å“ªé‡Œè¿›å…¥åˆ—è¡¨é¡µï¼Œéƒ½é‡ç½®æ»šåŠ¨ä½ç½®ä»¥é˜²æ­¢æ»šåŠ¨å¤±æ•ˆ
        list.scrollTop = 0;
  stopWeekChartAutoRefresh();
  stopCurrentDurationUpdate();
  stopLiveTimelineUpdate();
  stopListCardRefresh(); // å…ˆç¡®ä¿æ¸…ç†
        
  // åªæœ‰ä»é¦–é¡µåˆ‡æ¢åˆ°åˆ—è¡¨æ—¶æ‰æ’­æ”¾å±•å¼€åŠ¨ç”»ï¼ˆç§»åŠ¨ç«¯è·³è¿‡ä»¥æé«˜å“åº”ï¼‰
  const isMobile = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
  if (uiState.previousView === 'home' && !isMobile) {
          // è®¾ç½®å±•å¼€èµ·ç‚¹ä¸ºå¡ç‰‡ä¸­å¿ƒ
          const overviewCard = document.querySelector('.overview-card');
          if (overviewCard) {
            const rect = overviewCard.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // è®¾ç½®å˜æ¢åŸç‚¹ä¸ºå¡ç‰‡ä¸­å¿ƒ
            list.style.transformOrigin = `${centerX}px ${centerY}px`;
          }
          
          // è§¦å‘å±•å¼€åŠ¨ç”»
          requestAnimationFrame(() => {
            list.classList.add('expanding');
          });
  } else {
          // ä»è¯¦æƒ…é¡µè¿”å›ï¼Œç›´æ¥æ˜¾ç¤ºåˆ—è¡¨ä¸æ’­æ”¾åŠ¨ç”»
          list.classList.add('expanding');
        }
        
        renderStudentList(uiState.category);
    startListCardRefresh(); // æ¸²æŸ“åå¯åŠ¨å®æ—¶åˆ·æ–°
      } else if (uiState.view === 'detail') {
        // å±•å¼€è¯¦æƒ…è§†å›¾
        home.hidden = true;
        if (ranking) {
          ranking.classList.remove('expanding');
          ranking.hidden = true;
        }
        list.classList.remove('expanding');
        list.hidden = true;
        detail.hidden = false;
        detail.classList.add('active');
        // é‡ç½®æ»šåŠ¨ä½ç½®
        detail.scrollTop = 0;
        renderStudentDetail(uiState.selectedStudent);
  startWeekChartAutoRefresh();
  startCurrentDurationUpdate();
  stopListCardRefresh(); // ç¦»å¼€åˆ—è¡¨
      } else if (uiState.view === 'ranking') {
        // å±•å¼€å®Œæ•´æ’è¡Œæ¦œ
        home.hidden = true;
        list.hidden = true;
        if (detail) {
          detail.classList.remove('active');
          detail.hidden = true;
        }
        if (ranking) {
          dbg('è¿›å…¥ ranking è§†å›¾ï¼Œå¼€å§‹æ¸²æŸ“å®Œæ•´æ’è¡Œæ¦œ');
          ranking.hidden = false;
          ranking.classList.add('expanding'); // æ·»åŠ å±•å¼€æ ·å¼
          
          // ä¿®å¤æ»šåŠ¨é—®é¢˜ï¼šé‡ç½®æ»šåŠ¨ä½ç½®
          ranking.scrollTop = 0;
          
          // ğŸ”§ ä½¿ç”¨ç»Ÿä¸€çš„æ’è¡Œæ¦œåŒæ­¥ç³»ç»Ÿï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°æ•°æ®
          if (window.__leaderboardSyncSystem) {
            // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ’è¡Œæ¦œï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
            window.__leaderboardSyncSystem.updateAllLeaderboards({ force: true, silent: false })
              .then(() => {
                // å¦‚æœç®¡ç†å‘˜æ¨¡å¼å·²å¼€å¯ï¼Œæ·»åŠ æ§åˆ¶æŒ‰é’®
                if (adminMode) {
                  setTimeout(() => addAdminControls(), 100);
                }
              });
          } else {
            // é™çº§ï¼šä½¿ç”¨æ—§çš„æ›´æ–°æ–¹å¼
            renderRankingFull({ silent:false, keepScroll:false }).then(() => {
              // å¦‚æœç®¡ç†å‘˜æ¨¡å¼å·²å¼€å¯ï¼Œæ·»åŠ æ§åˆ¶æŒ‰é’®
              if (adminMode) {
                setTimeout(() => addAdminControls(), 100);
              }
            });
          }
        } else { dbg('ranking å®¹å™¨æœªæ‰¾åˆ°'); }
      }
    }

    function setupHomeInteractions() {
      // åˆ†ç±»æ ‡ç­¾åˆ‡æ¢
      const categoryTabs = document.querySelectorAll('.category-tab');
      categoryTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // æ ‡è®°ç”¨æˆ·å·²æ‰‹åŠ¨äº¤äº’ï¼Œé˜»æ­¢åç»­æ™ºèƒ½é€‰æ‹©
          userHasInteracted = true;
          smartSelectionApplied = true;
          
          // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
          categoryTabs.forEach(t => t.classList.remove('active'));
          // æ·»åŠ å½“å‰æ´»è·ƒçŠ¶æ€
          tab.classList.add('active');
          // æ›´æ–°çŠ¶æ€
          uiState.category = tab.dataset.category;
          
          dbg(`ğŸ‘† ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©åˆ†ç±»: ${tab.dataset.category}`);
          
          // é‡æ–°æ¸²æŸ“
          renderHomeBins();
        });
      });

      // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
  const viewDetailsBtn = document.getElementById('viewDetailsBtn');
  const backBtn = document.getElementById('backBtn');
  const detailBackBtn = document.getElementById('detailBackBtn');
  const rankingDetailsBtn = document.getElementById('rankingDetailsBtn');
  const rankingRulesBtn = document.getElementById('rankingRulesBtn');
  const rankingBackBtn = document.getElementById('rankingBackBtn');

      if (viewDetailsBtn) {
        viewDetailsBtn.addEventListener('click', (e) => {
          // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ requestAnimationFrame å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æŒ‰é’®ç‚¹å‡»æ€(active)èƒ½ç«‹å³æ¸²æŸ“
          // è§£å†³ç§»åŠ¨ç«¯ç‚¹å‡»é¡¿æŒ«æ„Ÿ
          const target = e.currentTarget;
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              // è¿›å…¥åˆ—è¡¨å‰åˆ¤æ–­å½“å‰åˆ†ç±»æ˜¯å¦æœ‰äºº
              const groups = getGroups();
              const map = {
                'attendance': groups.attendance,
                'absent': groups.absent,
                'self-practice': groups.selfPractice,
                'not-practice': groups.notPractice
              };
              const cur = (map[uiState.category] || []);
              if (!cur.length) {
                showToast('å½“å‰åˆ†ç±»æš‚æ— å­¦ç”Ÿ');
                return; // ä¸è·³é¡µ
              }
              uiState.previousView = uiState.view;
              uiState.view = 'list';
              uiState.clickedElement = target;
              updateViews();
            });
          });
        });
      } else { dbg('viewDetailsBtn æœªæ‰¾åˆ°ï¼Œè·³è¿‡ç»‘å®š'); }

      // æ’è¡Œæ¦œè¯¦æƒ…æŒ‰é’® -> è¿›å…¥å®Œæ•´æ’è¡Œæ¦œ
    if (rankingDetailsBtn) {
        rankingDetailsBtn.addEventListener('click', (e) => {
          // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºç‚¹å‡»åé¦ˆ
          const target = e.currentTarget;
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              uiState.previousView = uiState.view;
              uiState.rankingOrigin = uiState.view; // è¿›å…¥æ’è¡Œæ¦œå‰è®°å½•æ¥æº
              uiState.view = 'ranking';
              uiState.clickedElement = target;
              updateViews();
            });
          });
        });
      }
      // æ’è¡Œè§„åˆ™è¯¦æƒ… -> æ‰“å¼€è§„åˆ™è¯´æ˜æ¨¡æ€
      if (rankingRulesBtn) {
        rankingRulesBtn.addEventListener('click', () => {
          showLeaderboardRuleDoc();
        });
      }
    if (rankingBackBtn) {
        console.log('æˆåŠŸæ‰¾åˆ°æ’è¡Œæ¦œè¿”å›æŒ‰é’®ï¼Œæ­£åœ¨ç»‘å®šäº‹ä»¶');
        rankingBackBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºç‚¹å‡»åé¦ˆ
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              console.log('æ’è¡Œæ¦œè¿”å›æŒ‰é’®è¢«ç‚¹å‡»');
              console.log('å½“å‰ uiState:', uiState);
              
              // ä¼˜å…ˆå›åˆ°è¿›å…¥æ’è¡Œæ¦œæ—¶çš„æ¥æºï¼›å¦åˆ™é€€å›é¦–é¡µ
              const targetView = uiState.rankingOrigin || uiState.previousView || 'home';
              console.log('æ’è¡Œæ¦œç›®æ ‡è§†å›¾:', targetView);
              
              // å¦‚æœç›®æ ‡è§†å›¾å’Œå½“å‰è§†å›¾ç›¸åŒï¼Œå¼ºåˆ¶è¿”å›åˆ°é¦–é¡µ
              if (targetView === 'ranking') {
                console.warn('æ’è¡Œæ¦œç›®æ ‡è§†å›¾å’Œå½“å‰è§†å›¾ç›¸åŒï¼Œå¼ºåˆ¶è¿”å›åˆ°é¦–é¡µ');
                uiState.previousView = 'ranking';
                uiState.view = 'home';
              } else {
                uiState.previousView = 'ranking'; // è®¾ç½®ä¸Šä¸€ä¸ªè§†å›¾ä¸ºæ’è¡Œæ¦œé¡µ
                uiState.view = targetView;
              }
              
              uiState.rankingOrigin = null; // æ¸…é™¤æ¥æºï¼Œé¿å…åç»­å¾ªç¯
              console.log('æ’è¡Œæ¦œæ›´æ–°å uiState:', uiState);
              updateViews();
            });
          });
        });
        console.log('æ’è¡Œæ¦œè¿”å›æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ');
      } else {
        console.error('rankingBackBtn å…ƒç´ æœªæ‰¾åˆ°ï¼æ— æ³•ç»‘å®šè¿”å›äº‹ä»¶');
      }

      // æ’è¡Œæ¦œæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
      const dailyRankingTab = document.getElementById('dailyRankingTab');
      const weeklyRankingTab = document.getElementById('weeklyRankingTab');
      
      if (dailyRankingTab) {
        dailyRankingTab.addEventListener('click', () => {
          // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºç‚¹å‡»åé¦ˆ
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              switchRankingMode('daily');
            });
          });
        });
      }
      
      if (weeklyRankingTab) {
        weeklyRankingTab.addEventListener('click', () => {
          // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºç‚¹å‡»åé¦ˆ
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              switchRankingMode('weekly');
            });
          });
        });
      }
      
      if (backBtn) {
        backBtn.addEventListener('click', () => { 
          // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºç‚¹å‡»åé¦ˆ
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              uiState.previousView = 'list'; // è®¾ç½®ä¸Šä¸€ä¸ªè§†å›¾ä¸ºåˆ—è¡¨é¡µ
              uiState.view = 'home'; 
              updateViews(); 
            });
          });
        });
      } else { dbg('backBtn æœªæ‰¾åˆ°ï¼Œè·³è¿‡ç»‘å®š'); }

  if (detailBackBtn) {
        console.log('æˆåŠŸæ‰¾åˆ°è¯¦æƒ…é¡µè¿”å›æŒ‰é’®ï¼Œæ­£åœ¨ç»‘å®šäº‹ä»¶');
        detailBackBtn.addEventListener('click', (e) => { 
          e.preventDefault();
          e.stopPropagation();
          
          // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºç‚¹å‡»åé¦ˆ
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              console.log('è¯¦æƒ…é¡µè¿”å›æŒ‰é’®è¢«ç‚¹å‡»');
              console.log('å½“å‰ uiState:', uiState);
              
              // æ ¹æ®previousViewè¿”å›åˆ°æ­£ç¡®çš„é¡µé¢
              const targetView = uiState.previousView || 'list';
              console.log('ç›®æ ‡è§†å›¾:', targetView);
              
              // å¦‚æœç›®æ ‡è§†å›¾å’Œå½“å‰è§†å›¾ç›¸åŒï¼Œè¯´æ˜æœ‰å¾ªç¯é—®é¢˜ï¼Œä½¿ç”¨é»˜è®¤è¿”å›ç­–ç•¥
              if (targetView === 'detail') {
                console.warn('ç›®æ ‡è§†å›¾å’Œå½“å‰è§†å›¾ç›¸åŒï¼Œä½¿ç”¨é»˜è®¤è¿”å›ç­–ç•¥');
                // æ™ºèƒ½åå¤‡ç­–ç•¥ï¼šä¼˜å…ˆçº§ä¸º list > ranking > home
                let fallbackView = 'home';
                if (uiState.rankingOrigin) {
                  // å¦‚æœä¹‹å‰æ˜¯ä»æ’è¡Œæ¦œé¡µé¢çš„æµç¨‹ï¼Œè¿”å›æ’è¡Œæ¦œ
                  fallbackView = 'ranking';
                } else {
              // å¦åˆ™å°è¯•è¿”å›åˆ—è¡¨é¡µ
              fallbackView = 'list';
            }
            uiState.previousView = 'detail';
            uiState.view = fallbackView;
            console.log('ä½¿ç”¨é»˜è®¤è¿”å›ç­–ç•¥ï¼Œç›®æ ‡è§†å›¾:', fallbackView);
          } else {
            uiState.previousView = 'detail'; // è®¾ç½®ä¸Šä¸€ä¸ªè§†å›¾ä¸ºè¯¦æƒ…é¡µ
            uiState.view = targetView;
          }
          
          console.log('æ›´æ–°å uiState:', uiState);
          updateViews(); 
            });
          });
        });
        console.log('è¯¦æƒ…é¡µè¿”å›æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ');
  } else { 
        console.error('detailBackBtn å…ƒç´ æœªæ‰¾åˆ°ï¼æ— æ³•ç»‘å®šè¿”å›äº‹ä»¶');
        dbg('detailBackBtn æœªæ‰¾åˆ°ï¼Œè·³è¿‡ç»‘å®š'); 
  }

      // æœç´¢åŠŸèƒ½
      setupSearchFunction();
    }

  // åŸ iOS è¾¹ç¼˜å³æ»‘è¿”å›æ‰‹åŠ¿ setupSwipeGestures å·²å½»åº•ç§»é™¤ï¼ˆå ä½ä»¥é¿å…åç»­å¼•ç”¨ï¼‰ã€‚
  function setupSwipeGestures() { /* å·²ç§»é™¤ï¼Œä¿ç•™ç©ºå‡½æ•°é¿å…æ®‹ç•™è°ƒç”¨æŠ¥é”™ */ }

    // æœç´¢åŠŸèƒ½è®¾ç½®
    function setupSearchFunction() {
      const searchInput = document.getElementById('studentSearchInput');
      const searchResults = document.getElementById('searchResults');
      
      if (!searchInput || !searchResults) return;

      let searchTimeout = null;

      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 300);
      });

      searchInput.addEventListener('focus', () => {
        if (searchInput.value.trim()) {
          performSearch(searchInput.value.trim());
        }
      });

      // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸéšè—æœç´¢ç»“æœ
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.style.display = 'none';
        }
      });
    }

    // æ‰§è¡Œæœç´¢
    function performSearch(query) {
      const searchResults = document.getElementById('searchResults');
      
      if (!query) {
        searchResults.style.display = 'none';
        return;
      }

      // è·å–æ‰€æœ‰å­¦ç”Ÿæ•°æ® - ä»æ­£ç¡®çš„å­—æ®µè·å–
      let allStudents = [];
      if (appState.students && appState.students.size > 0) {
        allStudents = Array.from(appState.students.values());
      } else {
        // å¦‚æœæ²¡æœ‰åŠ è½½å­¦ç”Ÿæ•°æ®ï¼Œå°è¯•ä»åˆ†ç»„ä¸­è·å–
        const groups = getGroups();
        allStudents = [
          ...groups.attendance,
          ...groups.absent, 
          ...groups.selfPractice,
          ...groups.notPractice
        ];
      }
      
      // æœç´¢åŒ¹é…çš„å­¦ç”Ÿ
      const matchedStudents = allStudents.filter(student => 
        student && student.name && student.name.toLowerCase().includes(query.toLowerCase())
      );

      // ç”Ÿæˆæœç´¢ç»“æœHTML
      if (matchedStudents.length === 0) {
        searchResults.innerHTML = '<div class="search-no-results">æœªæ‰¾åˆ°åŒ¹é…çš„å­¦ç”Ÿ</div>';
      } else {
        searchResults.innerHTML = matchedStudents.slice(0, 5).map(student => 
          `<div class="search-result-item" onclick="openStudentDetailFromSearch('${student.name}')">
            ${student.name}
          </div>`
        ).join('');
      }

      searchResults.style.display = 'block';
    }

    // ä»æœç´¢ç»“æœæ‰“å¼€å­¦ç”Ÿè¯¦æƒ…
    function openStudentDetailFromSearch(studentName) {
      const searchInput = document.getElementById('studentSearchInput');
      const searchResults = document.getElementById('searchResults');
      
      // æ¸…ç©ºæœç´¢æ¡†å’Œéšè—ç»“æœ
      searchInput.value = '';
      searchResults.style.display = 'none';
      
      // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºç‚¹å‡»åé¦ˆ
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          // è®¾ç½®å‰ä¸€ä¸ªè§†å›¾ä¸ºé¦–é¡µï¼ˆå› ä¸ºæ˜¯ä»æœç´¢è¿›å…¥çš„ï¼‰
          uiState.previousView = 'home';
          uiState.view = 'detail';
          uiState.selectedStudent = studentName;
          updateViews();
        });
      });
    }

    // æ‰“å¼€å­¦ç”Ÿè¯¦æƒ…é¡µé¢
    function openStudentDetail(studentName) {
      // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºç‚¹å‡»åé¦ˆ
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          console.log('ä»é€šç”¨æ–¹å¼è¿›å…¥å­¦ç”Ÿè¯¦æƒ…:', studentName);
          console.log('å½“å‰è§†å›¾:', uiState.view);
          console.log('å½“å‰ rankingOrigin:', uiState.rankingOrigin);
          
          uiState.previousView = uiState.view;
          uiState.view = 'detail';
          uiState.selectedStudent = studentName;
          
          // å¦‚æœä¸æ˜¯ä»æ’è¡Œæ¦œè¿›å…¥çš„ï¼Œæ¸…é™¤ rankingOriginï¼Œé¿å…å½±å“è¿”å›é€»è¾‘
          if (uiState.view !== 'ranking') {
            uiState.rankingOrigin = null;
            console.log('æ¸…é™¤ rankingOriginï¼ˆéæ’è¡Œæ¦œè·¯å¾„ï¼‰');
          }
          
          console.log('æ›´æ–°åçš„ uiState:', uiState);
          updateViews();
        });
      });
    }

    function openRankingView() {
      // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºç‚¹å‡»åé¦ˆ
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          uiState.previousView = uiState.view;
          uiState.rankingOrigin = uiState.view; // è®°å½•æ¥æº
          uiState.view = 'ranking';
          updateViews();
        });
      });
    }

    // ç®¡ç†å‘˜æ¨¡å¼åŠŸèƒ½
  async function toggleAdminMode() {
      adminMode = !adminMode;
      if (adminMode) {
        showAdminNotification('ç®¡ç†å‘˜æ¨¡å¼å¯ç”¨ä¸­...', 'info');
        
        // ä»äº‘ç«¯åŒæ­¥æœ€æ–°çš„è°ƒåˆ†æ•°æ®
        const syncSuccess = await loadAdminScoresFromCloud();
        
        if (syncSuccess) {
          showAdminNotification('ç®¡ç†å‘˜æ¨¡å¼å·²å¯ç”¨ï¼Œæ•°æ®å·²åŒæ­¥', 'success');
        } else {
          showAdminNotification('ç®¡ç†å‘˜æ¨¡å¼å·²å¯ç”¨ï¼ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼‰', 'info');
        }
        
        addAdminControls();
        
        // å¦‚æœåœ¨å­¦ç”Ÿè¯¦æƒ…é¡µé¢ï¼Œåˆ·æ–°æ˜¾ç¤ºè°ƒåˆ†æŒ‰é’®
        if (uiState.view === 'detail' && uiState.selectedStudent) {
          renderStudentDetail(uiState.selectedStudent);
        }
      } else {
        showAdminNotification('ç®¡ç†å‘˜æ¨¡å¼å·²å…³é—­', 'info');
        removeAdminControls();
        
        // å¦‚æœåœ¨å­¦ç”Ÿè¯¦æƒ…é¡µé¢ï¼Œç§»é™¤è°ƒåˆ†æŒ‰é’®
        if (uiState.view === 'detail' && uiState.selectedStudent) {
          renderStudentDetail(uiState.selectedStudent);
        }
      }
    }

    // ä¼˜é›…çš„ç¡®è®¤å¯¹è¯æ¡†
    function showStyledConfirm({title, studentName, score, reason, type = 'add'}) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        const bgColor = type === 'add' ? '#059669' : type === 'deduct' ? '#dc2626' : '#6b7280';
        const icon = type === 'add' ? 'â•' : type === 'deduct' ? 'â–' : 'ğŸ”„';
        const actionText = type === 'add' ? 'åŠ åˆ†' : type === 'deduct' ? 'æ‰£åˆ†' : 'å¤åŸ';
        
        modal.innerHTML = `
          <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(4px);z-index:20000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.2s;">
            <div style="background:white;border-radius:16px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);max-width:400px;width:90%;overflow:hidden;animation:scaleIn 0.3s;">
              <div style="background:${bgColor};color:white;padding:24px;text-align:center;">
                <div style="font-size:48px;margin-bottom:8px;">${icon}</div>
                <h3 style="margin:0;font-size:20px;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.1);">${title}</h3>
              </div>
              <div style="padding:24px;">
                <div style="background:#f3f4f6;border-radius:8px;padding:16px;margin-bottom:16px;border:1px solid #e5e7eb;">
                  <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                    <span style="color:#374151;font-size:14px;font-weight:600;">å­¦ç”Ÿå§“å</span>
                    <span style="font-weight:700;font-size:16px;color:#111827;">${studentName}</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                    <span style="color:#374151;font-size:14px;font-weight:600;">è°ƒæ•´åˆ†æ•°</span>
                    <span style="font-weight:700;font-size:22px;color:${bgColor};">${score} åˆ†</span>
                  </div>
                  <div style="border-top:2px solid #d1d5db;padding-top:12px;margin-top:12px;">
                    <div style="color:#374151;font-size:13px;margin-bottom:6px;font-weight:600;">åŸå› è¯´æ˜</div>
                    <div style="color:#111827;font-size:14px;line-height:1.6;font-weight:500;">${reason}</div>
                  </div>
                </div>
                <div style="display:flex;gap:12px;">
                  <button id="confirmCancel" style="flex:1;padding:12px;border:2px solid #d1d5db;background:white;border-radius:8px;cursor:pointer;font-size:15px;font-weight:700;color:#374151;transition:all 0.2s;">
                    å–æ¶ˆ
                  </button>
                  <button id="confirmOk" style="flex:1;padding:12px;border:none;background:${bgColor};color:white;border-radius:8px;cursor:pointer;font-size:15px;font-weight:700;box-shadow:0 4px 6px -1px rgba(0,0,0,0.2);transition:all 0.2s;">
                    ç¡®è®¤${actionText}
                  </button>
                </div>
              </div>
            </div>
          </div>
          <style>
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
            #confirmOk:hover { transform: translateY(-2px); box-shadow: 0 8px 12px -2px rgba(0,0,0,0.2); }
            #confirmCancel:hover { background: #f3f4f6; border-color: #d1d5db; }
          </style>
        `;
        
        document.body.appendChild(modal);
        
        modal.querySelector('#confirmOk').onclick = () => {
          modal.remove();
          resolve(true);
        };
        
        modal.querySelector('#confirmCancel').onclick = () => {
          modal.remove();
          resolve(false);
        };
        
        // ESC é”®å–æ¶ˆ
        const escHandler = (e) => {
          if (e.key === 'Escape') {
            modal.remove();
            resolve(false);
            document.removeEventListener('keydown', escHandler);
          }
        };
        document.addEventListener('keydown', escHandler);
      });
    }

    function showAdminNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `admin-notification admin-notification--${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6366f1'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateX(100%);
        transition: all 0.3s ease;
      `;
      document.body.appendChild(notification);
      
      // åŠ¨ç”»æ˜¾ç¤º
      requestAnimationFrame(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
      });
      
      // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function addAdminControls() {
      // ç®¡ç†å‘˜æ§åˆ¶ç°åœ¨åªåœ¨å­¦ç”Ÿè¯¦æƒ…é¡µé¢æ˜¾ç¤ºï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºå…¶ä»–å¯èƒ½çš„ç®¡ç†å‘˜åŠŸèƒ½
      dbg('ç®¡ç†å‘˜æ§åˆ¶å·²å¯ç”¨');
    }

    function removeAdminControls() {
      // ç§»é™¤æ‰€æœ‰ç®¡ç†å‘˜ç›¸å…³æŒ‰é’®
      document.querySelectorAll('.admin-score-btn, .admin-detail-btn').forEach(btn => btn.remove());
    }



    // å…¨å±€å˜é‡ç”¨äºç®¡ç†å½“å‰é€‰æ‹©çš„è°ƒåˆ†
    window.currentSelectedDelta = 0;

    function openAdminScoreDialog(studentName) {
      const currentAdjustment = adminScoreAdjustments[studentName] || { score: 0, reason: '' };
      window.currentSelectedDelta = currentAdjustment.score || 0; // åˆå§‹åŒ–ä¸ºå½“å‰è°ƒåˆ†
      
      const dialog = document.createElement('div');
      dialog.className = 'admin-score-dialog';
      dialog.innerHTML = `
        <div class="admin-dialog-backdrop" onclick="closeAdminDialog()"></div>
        <div class="admin-dialog-content">
          <div class="admin-dialog-header">
            <h3>ç®¡ç†å‘˜è°ƒåˆ† - ${studentName}</h3>
            <button onclick="closeAdminDialog()" style="border:none;background:none;font-size:20px;cursor:pointer;">Ã—</button>
          </div>
          <div class="admin-dialog-body">
            <!-- å½“å‰çŠ¶æ€å¡ç‰‡ -->
            <div style="margin-bottom:20px;padding:12px;background:linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);border-radius:8px;border-left:4px solid #f59e0b;">
              <div style="font-size:12px;color:#92400e;font-weight:600;margin-bottom:4px;">ğŸ“Š å½“å‰è°ƒåˆ†çŠ¶æ€</div>
              <div id="currentAdjustStatus" style="font-size:16px;font-weight:700;color:#1f2937;">åŠ è½½ä¸­...</div>
            </div>
            
            <div class="admin-form-group">
              <!-- åŠ åˆ†åŒºåŸŸï¼šè‡ªå®šä¹‰è¾“å…¥ -->
              <div style="margin-bottom:12px;">
                <label style="color:#059669;font-weight:600;">åŠ åˆ†ï¼ˆè‡ªå®šä¹‰ï¼Œæ”¯æŒå°æ•°ç‚¹åä¸¤ä½ï¼‰ï¼š</label>
                <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
                  <span style="font-size:18px;color:#059669;">+</span>
                  <input type="number" id="addScoreInput" min="0" max="99.99" step="0.01" 
                         placeholder="0.00" style="width:80px;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;text-align:center;">
                  <button type="button" id="addScoreBtn" style="padding:6px 12px;background:#10b981;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">è®¾ä¸ºåŠ åˆ†</button>
                </div>
              </div>
              
              <!-- å‡åˆ†åŒºåŸŸï¼šå›ºå®šé€‰é¡¹ -->
              <div style="margin-bottom:12px;">
                <label style="color:#dc2626;font-weight:600;">æ‰£åˆ†ï¼ˆå¿«æ·é€‰æ‹©ï¼‰ï¼š</label>
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:4px;">
                  <button type="button" data-delta="-1" class="delta-btn minus-btn" style="padding:8px 0;border:1px solid #fca5a5;border-radius:4px;background:#fef2f2;cursor:pointer;font-size:14px;color:#dc2626;font-weight:500;">-1</button>
                  <button type="button" data-delta="-2" class="delta-btn minus-btn" style="padding:8px 0;border:1px solid #fca5a5;border-radius:4px;background:#fef2f2;cursor:pointer;font-size:14px;color:#dc2626;font-weight:500;">-2</button>
                  <button type="button" data-delta="-3" class="delta-btn minus-btn" style="padding:8px 0;border:1px solid #fca5a5;border-radius:4px;background:#fef2f2;cursor:pointer;font-size:14px;color:#dc2626;font-weight:500;">-3</button>
                  <button type="button" data-delta="-4" class="delta-btn minus-btn" style="padding:8px 0;border:1px solid #fca5a5;border-radius:4px;background:#fef2f2;cursor:pointer;font-size:14px;color:#dc2626;font-weight:500;">-4</button>
                  <button type="button" data-delta="-5" class="delta-btn minus-btn" style="padding:8px 0;border:1px solid #fca5a5;border-radius:4px;background:#fef2f2;cursor:pointer;font-size:14px;color:#dc2626;font-weight:500;">-5</button>
                  <button type="button" data-delta="-6" class="delta-btn minus-btn" style="padding:8px 0;border:1px solid #fca5a5;border-radius:4px;background:#fef2f2;cursor:pointer;font-size:14px;color:#dc2626;font-weight:500;">-6</button>
                  <button type="button" data-delta="-7" class="delta-btn minus-btn" style="padding:8px 0;border:1px solid #fca5a5;border-radius:4px;background:#fef2f2;cursor:pointer;font-size:14px;color:#dc2626;font-weight:500;">-7</button>
                  <button type="button" data-delta="-8" class="delta-btn minus-btn" style="padding:8px 0;border:1px solid #fca5a5;border-radius:4px;background:#fef2f2;cursor:pointer;font-size:14px;color:#dc2626;font-weight:500;">-8</button>
                  <button type="button" data-delta="-9" class="delta-btn minus-btn" style="padding:8px 0;border:1px solid #fca5a5;border-radius:4px;background:#fef2f2;cursor:pointer;font-size:14px;color:#dc2626;font-weight:500;">-9</button>
                  <button type="button" data-delta="-10" class="delta-btn minus-btn" style="padding:8px 0;border:1px solid #fca5a5;border-radius:4px;background:#fef2f2;cursor:pointer;font-size:14px;color:#dc2626;font-weight:500;">-10</button>
                </div>
              </div>
              
              <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding:12px;background:linear-gradient(135deg, #f0fdf4 0%, #e0f2fe 100%);border-radius:6px;border:1px solid #e5e7eb;">
                <div style="color:#374151;font-size:14px;">
                  <span style="font-weight:500;">å½“å‰è°ƒæ•´ï¼š</span>
                  <span id="deltaCurrentValue" style="font-weight:700;color:#111827;font-size:18px;margin-left:8px;">0</span>
                  <span style="font-size:12px;color:#6b7280;margin-left:4px;">åˆ†</span>
                </div>
                <button type="button" id="deltaResetBtn" style="padding:6px 14px;font-size:13px;border:1px solid #9ca3af;background:#fff;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;">
                  <span style="margin-right:4px;">ğŸ”„</span>å¤åŸ
                </button>
              </div>
            </div>
            <div class="admin-form-group">
              <label>è°ƒæ•´è¯´æ˜ï¼š</label>
              <textarea id="adminReasonInput" placeholder="è¯·è¾“å…¥è°ƒæ•´åŸå› ..." 
                        style="width: 100%; height: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; resize: vertical;">${currentAdjustment.reason}</textarea>
            </div>
            <div style="color: #6b7280; font-size: 12px; margin-top: 8px; line-height: 1.5;">
              <strong style="color:#059669;">åŠ åˆ†ï¼š</strong>å¯è‡ªå®šä¹‰è¾“å…¥ 0.01-99.99 åˆ†ï¼ˆæ”¯æŒå°æ•°ï¼‰<br>
              <strong style="color:#dc2626;">æ‰£åˆ†ï¼š</strong>å¿«æ·é€‰æ‹© -1 åˆ° -10 åˆ†<br>
              <strong>å¤åŸï¼š</strong>æ¸…é™¤å½“å‰è°ƒæ•´<br>
              <span style="color:#f59e0b;">âš ï¸ è°ƒåˆ†éœ€å¡«å†™åŸå› ï¼Œæäº¤å‰ä¼šäºŒæ¬¡ç¡®è®¤</span>
            </div>
          </div>
          <div class="admin-dialog-footer">
            <button onclick="closeAdminDialog()" style="padding: 12px 24px; border: 2px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; color: #374151; transition: all 0.2s; min-width: 100px;">å–æ¶ˆ</button>
            <button onclick="saveAdminScoreAdjustment('${studentName}')" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 700; box-shadow: 0 4px 6px -1px rgba(59,130,246,0.3); transition: all 0.2s; min-width: 100px;">ğŸ’¾ ä¿å­˜</button>
          </div>
        </div>
      `;
      
      dialog.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000;
        display: flex; align-items: center; justify-content: center;
      `;
      
      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .admin-dialog-backdrop {
          position: absolute; top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
        }
        .admin-dialog-content {
          position: relative; background: white; border-radius: 8px;
          box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
          width: 90%; max-width: 420px; max-height: 85vh; 
          display: flex; flex-direction: column;
        }
        .admin-dialog-header {
          display: flex; justify-content: space-between; align-items: center;
          padding: 16px 20px; border-bottom: 1px solid #e5e7eb;
          flex-shrink: 0;
        }
        .admin-dialog-header h3 {
          margin: 0; font-size: 18px; font-weight: 600; color: #1f2937;
        }
        .admin-dialog-body {
          padding: 20px;
          overflow-y: auto;
          flex: 1 1 auto;
        }
        .admin-form-group {
          margin-bottom: 16px;
        }
        .admin-form-group label {
          display: block; margin-bottom: 4px; font-weight: 500; color: #374151;
        }
        .admin-dialog-footer {
          padding: 16px 20px; border-top: 1px solid #e5e7eb;
          display: flex; justify-content: flex-end; gap: 12px;
          flex-shrink: 0;
          background: white;
        }
        .admin-dialog-footer button:hover {
          transform: translateY(-2px);
        }
        .admin-dialog-footer button:first-child:hover {
          background: #f3f4f6;
          border-color: #9ca3af;
        }
        .admin-dialog-footer button:last-child:hover {
          background: #2563eb;
          box-shadow: 0 8px 12px -2px rgba(59,130,246,0.4);
        }
      `;
      
      document.head.appendChild(style);
      document.body.appendChild(dialog);
      
      // ç»‘å®šUIå…ƒç´ 
      const minusBtns = dialog.querySelectorAll('.minus-btn');
      const addScoreInput = dialog.querySelector('#addScoreInput');
      const addScoreBtn = dialog.querySelector('#addScoreBtn');
      const currentEl = dialog.querySelector('#deltaCurrentValue');
      const statusEl = dialog.querySelector('#currentAdjustStatus');
      const resetBtn = dialog.querySelector('#deltaResetBtn');
      
      // æ‰“å¼€æ—¶å¦‚æœå·²æœ‰è°ƒåˆ†é¢„é€‰
      if(window.currentSelectedDelta > 0) {
        addScoreInput.value = window.currentSelectedDelta.toFixed(2);
      }
      
      function renderStatus(){
        if(currentAdjustment.score !== undefined && currentAdjustment.score !== 0){
          if(currentAdjustment.score > 0) {
            statusEl.innerHTML = `<span style="color:#059669;font-weight:700;">âœ… å·²åŠ  ${currentAdjustment.score.toFixed(2)} åˆ†</span>`;
          } else {
            statusEl.innerHTML = `<span style="color:#dc2626;font-weight:700;">âš ï¸ å·²æ‰£ ${Math.abs(currentAdjustment.score).toFixed(2)} åˆ†</span>`;
          }
        } else {
          statusEl.innerHTML = '<span style="color:#6b7280;font-weight:600;">â­• æœªè°ƒæ•´</span>';
        }
      }
      
      function updateHighlight(){
        // æ›´æ–°å‡åˆ†æŒ‰é’®é«˜äº®
        minusBtns.forEach(btn=>{
          const v = parseInt(btn.getAttribute('data-delta'));
          if(v === window.currentSelectedDelta){
            btn.classList.add('selected');
          } else {
            btn.classList.remove('selected');
          }
        });
        
        // æ›´æ–°åŠ åˆ†æŒ‰é’®çŠ¶æ€
        if(window.currentSelectedDelta > 0) {
          addScoreBtn.style.background='#059669';
          addScoreBtn.style.color='#fff';
          addScoreInput.style.borderColor='#059669';
          addScoreInput.style.boxShadow='0 0 0 3px rgba(5, 150, 105, 0.1)';
        } else {
          addScoreBtn.style.background='#10b981';
          addScoreBtn.style.color='#fff';
          addScoreInput.style.borderColor='#d1d5db';
          addScoreInput.style.boxShadow='none';
        }
        
        // æ˜¾ç¤ºå½“å‰é€‰æ‹©ï¼ˆå¢å¼ºè§†è§‰æ•ˆæœï¼‰
        if(window.currentSelectedDelta === 0) {
          currentEl.textContent = '0';
          currentEl.style.color = '#6b7280';
        } else if(window.currentSelectedDelta > 0) {
          currentEl.textContent = '+' + window.currentSelectedDelta.toFixed(2);
          currentEl.style.color = '#059669';
        } else {
          currentEl.textContent = window.currentSelectedDelta.toString();
          currentEl.style.color = '#dc2626';
        }
      }
      
      // å‡åˆ†æŒ‰é’®äº‹ä»¶
      minusBtns.forEach(btn=>btn.addEventListener('click',()=>{
        const v = parseInt(btn.getAttribute('data-delta'));
        if(window.currentSelectedDelta === v) {
          window.currentSelectedDelta = 0;
        } else {
          window.currentSelectedDelta = v;
          addScoreInput.value = ''; // æ¸…ç©ºåŠ åˆ†è¾“å…¥
        }
        updateHighlight();
      }));
      
      // åŠ åˆ†æŒ‰é’®äº‹ä»¶
      addScoreBtn.addEventListener('click',()=>{
        const val = parseFloat(addScoreInput.value) || 0;
        if(val > 0 && val <= 99.99) {
          window.currentSelectedDelta = Math.round(val * 100) / 100; // ä¿ç•™ä¸¤ä½å°æ•°
          updateHighlight();
        } else {
          alert('è¯·è¾“å…¥0.01-99.99ä¹‹é—´çš„æ•°å€¼');
          addScoreInput.focus();
        }
      });
      
      // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
      addScoreInput.addEventListener('keypress',(e)=>{
        if(e.key === 'Enter') {
          addScoreBtn.click();
        }
      });
      
      // è¾“å…¥æ¡†å¤±ç„¦æ—¶éªŒè¯
      addScoreInput.addEventListener('blur',()=>{
        const val = parseFloat(addScoreInput.value) || 0;
        if(val > 0) {
          addScoreInput.value = val.toFixed(2);
        }
      });
      
      // å¤åŸæŒ‰é’®äº‹ä»¶
      resetBtn.addEventListener('click',()=>{ 
        window.currentSelectedDelta = 0; 
        addScoreInput.value = '';
        updateHighlight(); 
      });
      
      renderStatus();
      updateHighlight();
    }

    function closeAdminDialog() {
      const dialog = document.querySelector('.admin-score-dialog');
      if (dialog) dialog.remove();
    }

    async function saveAdminScoreAdjustment(studentName) {
      console.log('saveAdminScoreAdjustment called for:', studentName);
      console.log('currentSelectedDelta:', window.currentSelectedDelta);
      
      const reasonInput = document.getElementById('adminReasonInput');
      const reason = reasonInput ? reasonInput.value.trim() : '';
      
      // ä½¿ç”¨å…¨å±€å˜é‡è·å–å½“å‰é€‰æ‹©çš„åˆ†æ•°  
      const score = window.currentSelectedDelta || 0;
      console.log('score:', score, 'reason:', reason);
      let adjustmentData = null;
      
      console.log('å¼€å§‹éªŒè¯åˆ†æ•°...');
      if(score !== 0){
        console.log('åˆ†æ•°ä¸ä¸º0ï¼Œè¿›è¡ŒèŒƒå›´éªŒè¯');
        // éªŒè¯åˆ†æ•°èŒƒå›´ï¼šåŠ åˆ†0.01-99.99ï¼Œå‡åˆ†åªèƒ½æ˜¯-1,-2,-3
        if(score > 0) {
          console.log('æ­£åˆ†éªŒè¯');
          if(score < 0.01 || score > 99.99) {
            console.log('æ­£åˆ†è¶…å‡ºèŒƒå›´');
            showAdminNotification('åŠ åˆ†èŒƒå›´ï¼š0.01-99.99', 'error');
            return;
          }
        } else {
          console.log('è´Ÿåˆ†éªŒè¯');
          if(![-1, -2, -3, -4, -5, -6, -7, -8, -9, -10].includes(score)) {
            console.log('è´Ÿåˆ†ä¸åœ¨å…è®¸èŒƒå›´å†…');
            showAdminNotification('æ‰£åˆ†åªèƒ½é€‰æ‹© -1 åˆ° -10', 'error');
            return;
          }
        }
        
        console.log('æ£€æŸ¥åŸå› ...');
        if(!reason){
          console.log('åŸå› ä¸ºç©º');
          showAdminNotification('è¯·å¡«å†™åŸå› ', 'error');
          return;
        }
        
        const scoreDisplay = score > 0 ? '+' + score.toFixed(2) : score.toString();
        const confirmed = await showStyledConfirm({
          title: 'ç¡®è®¤è°ƒåˆ†',
          studentName: studentName,
          score: scoreDisplay,
          reason: reason,
          type: score > 0 ? 'add' : 'deduct'
        });
        if(!confirmed) return;
        
        adjustmentData = {
          score: Math.round(score * 100) / 100, // ç¡®ä¿ä¿ç•™ä¸¤ä½å°æ•°
          reason: reason,
          timestamp: Date.now(),
          date: new Date().toISOString().split('T')[0],
          operator: 'admin'
        };
      } else {
        // å¤åŸæµç¨‹
        const confirmed = await showStyledConfirm({
          title: 'ç¡®è®¤å¤åŸ',
          studentName: studentName,
          score: '0',
          reason: 'æ¸…é™¤å·²å­˜åœ¨çš„è°ƒåˆ†',
          type: 'reset'
        });
        if(!confirmed) return;
      }
      
      try {
        const saveBtn = document.querySelector('.admin-dialog-footer button:last-child');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'ä¿å­˜ä¸­...'; }

        // 1. äº‘ç«¯åŒæ­¥
        const cloudRes = await syncAdminScoreToCloud(studentName, adjustmentData);

        // 2. å¦‚æœäº‘ç«¯æˆåŠŸï¼Œæ‰æ›´æ–°å†…å­˜ç¼“å­˜
        if (cloudRes.ok) {
          if (adjustmentData) adminScoreAdjustments[studentName] = adjustmentData; else delete adminScoreAdjustments[studentName];
          closeAdminDialog(); // åªæœ‰æˆåŠŸæ—¶æ‰å…³é—­å¯¹è¯æ¡†
        }

        // 3. å°è¯•å†™å…¥ leaderboard_dailyï¼ˆä¸å½±å“æœ€ç»ˆæ˜¯å¦é‡å¤å¼¹çª—ï¼‰
        let lbErr = null;
        try {
          if (cloudRes.ok) { // ä»…åœ¨äº‘ç«¯çœŸæ­£æˆåŠŸæ—¶å†å†™æ’è¡Œæ¦œ
            await updateLeaderboardDailyScore(studentName, adjustmentData);
          }
        } catch(e){ lbErr = e; console.error('updateLeaderboardDailyScore error:', e); }

        // 4. åˆ·æ–°è§†å›¾ï¼ˆå¤±è´¥ä¹Ÿä¸æŠ›å‡ºï¼‰
        try {
          if (cloudRes.ok) { // åªæœ‰æˆåŠŸçŠ¶æ€ä¸‹æ‰åˆ·æ–°é¿å…è¯¯å¯¼
            clearAllCaches();
            // é¢å¤–ï¼šæ¸…é™¤é¦–é¡µç”¨çš„ 442 åˆ†ç¼“å­˜ï¼Œç¡®ä¿åŠ å‡åˆ†ç«‹å³å¯è§
            if (window.__scoreCache) { try { window.__scoreCache.clear(); dbg('å·²æ¸…ç©º __scoreCache'); } catch(_) {} }
            // ğŸ”§ ä½¿ç”¨ç»Ÿä¸€çš„æ’è¡Œæ¦œåŒæ­¥ç³»ç»Ÿ
            if (window.__leaderboardSyncSystem) {
              window.__leaderboardSyncSystem.updateAllLeaderboards({ force: true, silent: true });
            } else {
              // é™çº§ï¼šä½¿ç”¨æ—§çš„æ›´æ–°æ–¹å¼
              updateRanking(); // é¦–é¡µå°æ¦œ
              renderRankingFull({ silent: true }); // å®Œæ•´æ¦œ
            }
            renderStudentDetail(studentName); // è¯¦æƒ…
          }
        } catch (e) { console.warn('åˆ·æ–°è§†å›¾å¤±è´¥ï¼ˆå¿½ç•¥ï¼‰:', e); }

        // 5. å•ä¸€é€šçŸ¥å‡ºå£
        if (cloudRes.ok && !lbErr) {
          showAdminNotification(`${studentName} ${adjustmentData? 'è°ƒåˆ†å·²ä¿å­˜' : 'è°ƒåˆ†å·²å¤åŸ'}`, 'success');
        } else if (cloudRes.ok && lbErr) {
          showAdminNotification(`${studentName} ${adjustmentData? 'è°ƒåˆ†å·²ä¿å­˜' : 'è°ƒåˆ†å·²å¤åŸ'}ï¼ˆæ’è¡Œæ¦œç¨ååˆ·æ–°ï¼‰`, 'warning');
        } else if (cloudRes.fatal) {
          showAdminNotification(`${studentName} è°ƒåˆ†ä¿å­˜å¤±è´¥`, 'error');
        } else { // éè‡´å‘½ï¼šschema ç¼ºå¤±ç­‰
          showAdminNotification(`${studentName} è°ƒåˆ†æœªç”Ÿæ•ˆï¼ˆéœ€æ£€æŸ¥äº‘ç«¯è¡¨ç»“æ„ï¼‰`, 'warning');
        }
        
        // ç¡®ä¿å¯¹è¯æ¡†åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½å…³é—­
        if (!cloudRes.ok) {
          closeAdminDialog();
        }

      } catch (err) {
        console.error('ä¿å­˜è°ƒåˆ†è¿‡ç¨‹å¼‚å¸¸(å¤–å›´):', err);
        showAdminNotification('ä¿å­˜å¤±è´¥', 'error');
        closeAdminDialog(); // é”™è¯¯æ—¶ä¹Ÿå…³é—­å¯¹è¯æ¡†
        const saveBtn = document.querySelector('.admin-dialog-footer button:last-child');
        if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'ä¿å­˜'; }
      }
    }

    // ========= äº‘ç«¯è°ƒåˆ†åŒæ­¥ï¼ˆç»“æ„åŒ–ç»“æœï¼Œé¿å…è¯¯æŠ¥ï¼‰ =========
  async function syncAdminScoreToCloud(studentName, adjustmentData) {
      if (!supabaseClient) {
        return { ok:false, fatal:true, reason:'supabase_not_initialized' };
      }
      const normalizedName = utils.normalizeStudentName(studentName);
      try {
        if (adjustmentData) {
          // æ‰‹åŠ¨ upsertï¼šå…ˆ updateï¼Œå¦‚æœæœªå‘½ä¸­å† insertï¼Œé¿å… 42P10 çº¦æŸé”™è¯¯
          let { data: updData, error: updErr } = await supabaseClient
            .from('admin_score_adjustments')
            .update({
              score_adjustment: adjustmentData.score,
              reason: adjustmentData.reason,
              timestamp: new Date(adjustmentData.timestamp).toISOString(),
              date: adjustmentData.date,
              operator: adjustmentData.operator,
              updated_at: new Date().toISOString()
            })
            .eq('student_name', normalizedName)
            .select();

          if (updErr) {
            if (/relation .* does not exist/i.test(updErr.message) || /column .* does not exist/i.test(updErr.message)) {
              console.warn('[admin-adjust] è¡¨æˆ–åˆ—ç¼ºå¤±ï¼ˆéè‡´å‘½ï¼‰:', updErr.message);
              return { ok:false, fatal:false, reason:'schema_missing' };
            }
            console.error('[admin-adjust] update é”™è¯¯:', updErr);
            return { ok:false, fatal:true, reason:updErr.message };
          }

          if (!updData || updData.length === 0) {
            const { error: insErr } = await supabaseClient
              .from('admin_score_adjustments')
              .insert({
                student_name: normalizedName,
                score_adjustment: adjustmentData.score,
                reason: adjustmentData.reason,
                timestamp: new Date(adjustmentData.timestamp).toISOString(),
                date: adjustmentData.date,
                operator: adjustmentData.operator,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
              });
            if (insErr) {
              if (/relation .* does not exist/i.test(insErr.message) || /column .* does not exist/i.test(insErr.message)) {
                console.warn('[admin-adjust] è¡¨æˆ–åˆ—ç¼ºå¤±ï¼ˆéè‡´å‘½ï¼‰:', insErr.message);
                return { ok:false, fatal:false, reason:'schema_missing' };
              }
              console.error('[admin-adjust] insert é”™è¯¯:', insErr);
              return { ok:false, fatal:true, reason:insErr.message };
            }
          }
        } else {
          const { error } = await supabaseClient
            .from('admin_score_adjustments')
            .delete()
            .eq('student_name', normalizedName);
          if (error) {
            if (/relation .* does not exist/i.test(error.message)) {
              console.warn('[admin-adjust] åˆ é™¤æ—¶è¡¨ç¼ºå¤±ï¼ˆå¿½ç•¥ï¼‰');
              return { ok:false, fatal:false, reason:'schema_missing' };
            }
            return { ok:false, fatal:true, reason:error.message };
          }
        }
        return { ok:true };
      } catch (e) {
    console.error('[admin-adjust] åŒæ­¥å¼‚å¸¸:', e);
        return { ok:false, fatal:true, reason:e.message };
      }
    }

    // ä»äº‘ç«¯åŠ è½½ç®¡ç†å‘˜è°ƒåˆ†æ•°æ®
    async function loadAdminScoresFromCloud() {
      try {
        if (!supabaseClient) {
          dbg('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
          return false;
        }
        
        // é¦–å…ˆå°è¯•åˆ›å»ºè¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        await ensureAdminScoreTable();
        
        const { data, error } = await supabaseClient
          .from('admin_score_adjustments')
          .select('*');
        
        if (error) {
          // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»ºåé‡è¯•
          if (error.code === '42P01') { // relation does not exist
            dbg('ç®¡ç†å‘˜è°ƒåˆ†è¡¨ä¸å­˜åœ¨ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
            return false;
          }
          throw error;
        }
        
        // æ›´æ–°æœ¬åœ°ç¼“å­˜
        const cloudAdjustments = {};
        if (data) {
          data.forEach(record => {
            const studentName = record.student_name;
            cloudAdjustments[studentName] = {
              score: record.score_adjustment,
              reason: record.reason,
              timestamp: new Date(record.timestamp).getTime(),
              date: record.date,
              operator: record.operator
            };
          });
        }
        
        // åˆå¹¶äº‘ç«¯æ•°æ®åˆ°æœ¬åœ°ï¼Œäº‘ç«¯æ•°æ®ä¼˜å…ˆ
        Object.assign(adminScoreAdjustments, cloudAdjustments);
        localStorage.setItem('adminScoreAdjustments', JSON.stringify(adminScoreAdjustments));
        
        dbg('ç®¡ç†å‘˜è°ƒåˆ†æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥');
        return true;
      } catch (error) {
        console.error('ä»äº‘ç«¯åŠ è½½ç®¡ç†å‘˜è°ƒåˆ†å¤±è´¥:', error);
        return false;
      }
    }

    // æ›´æ–° leaderboard_daily è¡¨ä¸­çš„å­¦ç”Ÿåˆ†æ•°
  async function updateLeaderboardDailyScore(studentName, adjustmentData) {
      if (!supabaseClient) {
        dbg('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè·³è¿‡ leaderboard_daily æ›´æ–°');
        return;
      }
      
      try {
        const normalizedName = utils.normalizeStudentName(studentName);
        const activeDate = getActiveLeaderboardDate();
        const activeIso = utils.toIsoDate(activeDate);
        
        // ğŸ›¡ï¸ å‘¨æœ«ä¿æŠ¤ï¼šç¦æ­¢åœ¨å‘¨å…­/å‘¨æ—¥ä¿®æ”¹ä»»ä½•æ’è¡Œæ¦œæ•°æ®
        const now = new Date();
        const currentDayOfWeek = now.getDay(); // 0=å‘¨æ—¥, 6=å‘¨å…­
        
        if (currentDayOfWeek === 0 || currentDayOfWeek === 6) {
          const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
          console.error('[å‘¨æœ«ä¿æŠ¤] å‘¨æœ«ç¦æ­¢ä¿®æ”¹æ’è¡Œæ¦œæ•°æ®', {
            currentTime: now.toISOString(),
            currentDay: dayNames[currentDayOfWeek],
            targetDate: activeIso,
            studentName: normalizedName,
            reason: 'å‘¨æœ«ä¸æ”¯æŒæ’è¡Œæ¦œæ“ä½œ'
          });
          try {
            showToast(`âŒ å‘¨æœ«ï¼ˆ${dayNames[currentDayOfWeek]}ï¼‰ä¸æ”¯æŒä¿®æ”¹æ’è¡Œæ¦œæ•°æ®`);
          } catch {}
          return;
        }
        
        // ğŸ›¡ï¸ ä¸¥æ ¼å†å²æ•°æ®ä¿æŠ¤ï¼šä½¿ç”¨çœŸå®å½“å‰æ—¥æœŸè€Œéæ´»è·ƒæ—¥æœŸ
        const realToday = new Date();
        const realTodayIso = utils.toIsoDate(realToday);
        const nowActiveDate = getActiveLeaderboardDate();
        const todayIso = utils.toIsoDate(nowActiveDate);
        
        // åŒé‡ä¿æŠ¤ï¼šæ—¢æ£€æŸ¥æ´»è·ƒæ—¥æœŸï¼Œä¹Ÿæ£€æŸ¥çœŸå®æ—¥æœŸ
        if (activeIso !== realTodayIso) {
          console.error('[ä¸¥æ ¼æ•°æ®ä¿æŠ¤] æ‹’ç»ä¿®æ”¹å†å²æ•°æ®', {
            requestedDate: activeIso,
            currentActiveDate: todayIso,
            realToday: realTodayIso,
            studentName: normalizedName,
            timestamp: now.toISOString(),
            reason: 'åªå…è®¸ä¿®æ”¹å½“å‰çœŸå®æ—¥æœŸçš„æ•°æ®'
          });
          try {
            showToast(`âŒ å†å²æ•°æ®ä¿æŠ¤ï¼šåªèƒ½ä¿®æ”¹ä»Šæ—¥(${realTodayIso})æ•°æ®ï¼Œæ‹’ç»ä¿®æ”¹ ${activeIso}`);
          } catch {}
          return;
        }
        
        if (activeIso !== todayIso) {
          console.warn('[æ´»è·ƒæ—¥æœŸæ£€æŸ¥] æ´»è·ƒæ—¥æœŸä¸çœŸå®æ—¥æœŸä¸ä¸€è‡´', {
            activeDate: activeIso,
            realDate: realTodayIso,
            note: 'å¯èƒ½å¤„äºæ—¥æœŸåˆ‡æ¢çª—å£æœŸ'
          });
        }
        
        // è·å–å½“å‰å­¦ç”Ÿåœ¨ leaderboard_daily ä¸­çš„è®°å½•
        const { data: existingRecord, error: fetchError } = await supabaseClient
          .from('leaderboard_daily')
          .select('*')
          .eq('student_key', normalizedName)
          .eq('date', activeIso)
          .single();
        
        if (fetchError && fetchError.code !== 'PGRST116') { // PGRST116 = no rows returned
          throw fetchError;
        }
        
        if (!existingRecord) {
          // ğŸ”’ å†™åº“ä¿æŠ¤ï¼šéªŒè¯æ—¥æœŸåˆæ³•æ€§
          if (!window.__dataProtectionSystem.canWriteLeaderboardDaily(activeIso, 'insert')) {
            console.error('[å†™åº“ä¿æŠ¤] æ‹’ç»æ’å…¥å†å²æ•°æ®åˆ° leaderboard_daily');
            return;
          }
          
          // è‹¥è¿˜æ²¡æœ‰è®°å½•ï¼Œä½†æˆ‘ä»¬éœ€è¦å†™å…¥è°ƒåˆ†ï¼šå…ˆå°è¯•åˆ›å»ºç©ºåŸºç¡€è¡Œï¼ˆéœ€ä¾èµ– RULE_VERSION å¸¸é‡ï¼‰
          const baseInsert = {
            student_key: normalizedName,
            date: activeIso,
            d1: 0,
            d2: 0,
            d3: 0,
            total: 0,
            rank: null,
            rule_version: (typeof RULE_VERSION!=='undefined'? RULE_VERSION : 1),
            admin_adjustment: 0,
            created_at: new Date().toISOString()
          };
          const { error: insertErr } = await supabaseClient
            .from('leaderboard_daily')
            .insert(baseInsert);
          if (insertErr) {
            dbg('æ’å…¥ç©º leaderboard_daily è¡Œå¤±è´¥ï¼Œè·³è¿‡è°ƒåˆ†å†™å…¥', insertErr);
            return;
          }
          dbg(`å·²ä¸º ${studentName} åˆ›å»º leaderboard_daily åˆå§‹è®°å½•`);
        }
        
        // é‡æ–°è®¡ç®—åŒ…å«ç®¡ç†å‘˜è°ƒæ•´çš„æ€»åˆ†
        // é‡æ–°è·å–ï¼ˆè‹¥åˆšæ’å…¥åˆ™éœ€å† select ä¸€æ¬¡ï¼‰
        let record = existingRecord;
        if (!record) {
          const { data: rec2 } = await supabaseClient
            .from('leaderboard_daily')
            .select('d1,d2,d3,admin_adjustment')
            .eq('student_key', normalizedName)
            .eq('date', activeIso)
            .single();
          record = rec2 || { d1:0,d2:0,d3:0,admin_adjustment:0 };
        }
        const baseTotal = (record.d1 || 0) + (record.d2 || 0) + (record.d3 || 0);
        const adminAdjustment = adjustmentData ? adjustmentData.score : 0;
        const newTotal = +(Math.max(0, Math.min(100, baseTotal + adminAdjustment))).toFixed(2);
        
        // ğŸ”’ å†™åº“ä¿æŠ¤ï¼šéªŒè¯æ—¥æœŸåˆæ³•æ€§
        if (!window.__dataProtectionSystem.canWriteLeaderboardDaily(activeIso, 'update-adjustment')) {
          console.error('[å†™åº“ä¿æŠ¤] æ‹’ç»æ›´æ–°å†å²æ•°æ®åˆ° leaderboard_daily');
          return;
        }
        
        // å°è¯•æ›´æ–°è®°å½•ï¼ˆåŒ…å« admin_adjustment å­—æ®µï¼‰
        let updateData = {
          total: newTotal,
          updated_at: new Date().toISOString()
        };
        
        // å°è¯•æ·»åŠ  admin_adjustment å­—æ®µï¼Œå¦‚æœå­—æ®µä¸å­˜åœ¨ä¼šè¢«å¿½ç•¥
        try {
          updateData.admin_adjustment = adminAdjustment;
        } catch (e) {
          // å­—æ®µå¯èƒ½ä¸å­˜åœ¨ï¼Œç»§ç»­æ›´æ–°å…¶ä»–å­—æ®µ
        }
        
        const { error: updateError } = await supabaseClient
          .from('leaderboard_daily')
          .update(updateData)
          .eq('student_key', normalizedName)
          .eq('date', activeIso);
        
        if (updateError) {
          // å¦‚æœåŒ…å« admin_adjustment å­—æ®µå¤±è´¥ï¼Œå°è¯•åªæ›´æ–° total
          if (updateError.message && updateError.message.includes('admin_adjustment')) {
            // ğŸ”’ å†™åº“ä¿æŠ¤ï¼šäºŒæ¬¡éªŒè¯ï¼ˆé‡è¯•å‰ï¼‰
            if (!window.__dataProtectionSystem.canWriteLeaderboardDaily(activeIso, 'update-retry')) {
              console.error('[å†™åº“ä¿æŠ¤] æ‹’ç»é‡è¯•æ›´æ–°å†å²æ•°æ®');
              return;
            }
            
            dbg('admin_adjustment å­—æ®µä¸å­˜åœ¨ï¼Œä»…æ›´æ–° total åˆ†æ•°');
            const { error: retryError } = await supabaseClient
              .from('leaderboard_daily')
              .update({
                total: newTotal,
                updated_at: new Date().toISOString()
              })
              .eq('student_key', normalizedName)
              .eq('date', activeIso);
            
            if (retryError) throw retryError;
          } else {
            throw updateError;
          }
        }
        
        // é‡æ–°è®¡ç®—å½“æ—¥æ’å
        await recalculateDailyRanking(activeIso);
        
        dbg(`å·²æ›´æ–° ${studentName} åœ¨ leaderboard_daily ä¸­çš„åˆ†æ•°: ${baseTotal} -> ${newTotal} (è°ƒæ•´: ${adminAdjustment})`);
        
      } catch (error) {
        console.error('æ›´æ–° leaderboard_daily å¤±è´¥:', error);
        // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºè¿™ä¸åº”è¯¥é˜»æ­¢ç®¡ç†å‘˜è°ƒåˆ†åŠŸèƒ½
      }
    }

    // é‡æ–°è®¡ç®—æŒ‡å®šæ—¥æœŸçš„æ’å
    async function recalculateDailyRanking(dateIso) {
      if (!supabaseClient) return;
      
      // ğŸ›¡ï¸ å‘¨æœ«ä¿æŠ¤ï¼šç¦æ­¢åœ¨å‘¨å…­/å‘¨æ—¥ä¿®æ”¹ä»»ä½•æ’è¡Œæ¦œæ•°æ®
      const now = new Date();
      const currentDayOfWeek = now.getDay();
      
      if (currentDayOfWeek === 0 || currentDayOfWeek === 6) {
        const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        console.error('[å‘¨æœ«ä¿æŠ¤] å‘¨æœ«ç¦æ­¢é‡æ–°è®¡ç®—æ’å', {
          currentTime: now.toISOString(),
          currentDay: dayNames[currentDayOfWeek],
          targetDate: dateIso,
          reason: 'å‘¨æœ«ä¸æ”¯æŒæ’è¡Œæ¦œæ“ä½œ'
        });
        return;
      }
      
      // ğŸ›¡ï¸ ä¸¥æ ¼å†å²æ•°æ®ä¿æŠ¤ï¼šç¦æ­¢é‡ç®—éå½“å‰çœŸå®æ—¥æœŸçš„æ•°æ®
      const realToday = new Date();
      const realTodayIso = utils.toIsoDate(realToday);
      
      if (dateIso !== realTodayIso) {
        console.error('[ä¸¥æ ¼å†å²æ•°æ®ä¿æŠ¤] ç¦æ­¢é‡ç®—å†å²æ—¥æœŸæ’å', {
          targetDate: dateIso,
          realToday: realTodayIso,
          timestamp: realToday.toISOString(),
          reason: 'å†å²æ’è¡Œæ¦œæ•°æ®ä¸å¯ä¿®æ”¹ï¼Œé˜²æ­¢æ•°æ®æ±¡æŸ“'
        });
        try {
          showToast(`âŒ å†å²æ•°æ®ä¿æŠ¤ï¼šç¦æ­¢ä¿®æ”¹ ${dateIso} çš„æ’è¡Œæ¦œæ•°æ®`);
        } catch {}
        return;
      }
      
      // ğŸ›¡ï¸ è®°å½•åˆæ³•çš„å½“æ—¥æ’åé‡ç®—æ“ä½œ
      const todayIso = utils.toIsoDate(getActiveLeaderboardDate());
      console.log('[recalculateDailyRanking] å½“æ—¥æ’åé‡ç®—', {
        targetDate: dateIso,
        currentActiveDate: todayIso,
        isToday: dateIso === realTodayIso,
        timestamp: now.toISOString()
      });

      // åœ¨é‡æ–°è®¡ç®—æ’åå‰ï¼Œå…ˆå°è¯•è¡¥é½ç¼ºå¤±çš„ rule_versionï¼ˆä¸€æ¬¡æ€§ä¿®å¤å†å²è„æ•°æ®ï¼‰
      try {
        // ğŸ”’ å†™åº“ä¿æŠ¤ï¼šéªŒè¯æ—¥æœŸåˆæ³•æ€§
        if (window.__dataProtectionSystem.canWriteLeaderboardDaily(dateIso, 'fix-rule-version')) {
          const { error: fixErr } = await supabaseClient
            .from('leaderboard_daily')
            .update({ rule_version: RULE_VERSION })
            .is('rule_version', null)
            .eq('date', dateIso);
          if (fixErr) dbg('è¡¥é½ç¼ºå¤± rule_version å¤±è´¥(å¯å¿½ç•¥):', fixErr.message || fixErr);
        } else {
          console.warn('[å†™åº“ä¿æŠ¤] è·³è¿‡å†å²æ•°æ®çš„ rule_version è¡¥é½');
        }
      } catch (e) { /* ignore */ }
      
      try {
        // è·å–è¯¥æ—¥æœŸæ‰€æœ‰æœ‰åˆ†æ•°çš„è®°å½•ï¼ˆéœ€è¦ window å­—æ®µé¿å… upsert æ—¶ NOT NULL çº¦æŸè¿åï¼‰
        const { data: records, error: fetchError } = await supabaseClient
          .from('leaderboard_daily')
          .select('student_key, total, window')
          .eq('date', dateIso)
          .gt('total', 0)
          .order('total', { ascending: false });
        
        if (fetchError) throw fetchError;
        if (!records || records.length === 0) return;
        
        // è®¡ç®—å½“å‰æ—¥æœŸçš„ windowï¼ˆå¤‡ç”¨ï¼Œä»¥é˜²è®°å½•ä¸­ç¼ºå¤±ï¼‰
        const targetDate = new Date(dateIso + 'T00:00:00');
        const weekday0to6 = targetDate.getDay();
        const fallbackWindow = __leaderboardWindowJSON(weekday0to6);
        
        // è®¡ç®—æ’åï¼ˆå¤„ç†å¹¶åˆ—æƒ…å†µï¼‰
        let rank = 1;
        const updates = [];
        for (let i = 0; i < records.length; i++) {
          if (i > 0 && records[i].total < records[i - 1].total) {
            rank = i + 1;
          }
          updates.push({
            student_key: records[i].student_key,
            date: dateIso,
            rank: rank,
            // ç¡®ä¿ä¸ä¼šå› ä¸ºç¼ºå¤±å­—æ®µè§¦å‘ NOT NULL çº¦æŸé”™è¯¯
            rule_version: RULE_VERSION,
            window: records[i].window || fallbackWindow
          });
        }
        
        // ğŸ”’ å†™åº“ä¿æŠ¤ï¼šæ‰¹é‡æ›´æ–°å‰éªŒè¯æ—¥æœŸåˆæ³•æ€§
        if (!window.__dataProtectionSystem.canWriteLeaderboardDaily(dateIso, 'ranking-update')) {
          console.error('[å†™åº“ä¿æŠ¤] æ‹’ç»æ›´æ–°å†å²æ’åæ•°æ®åˆ° leaderboard_daily');
          return;
        }
        
        // æ‰¹é‡æ›´æ–°æ’å
        const { error: updateError } = await supabaseClient
          .from('leaderboard_daily')
          .upsert(updates, { onConflict: 'date,student_key' });
        
        if (updateError) throw updateError;
        
        // æ¸…é™¤æ’è¡Œæ¦œç›¸å…³ç¼“å­˜
        try {
          if (typeof __rankTopCache !== 'undefined') __rankTopCache.clear();
          if (window.__scoreCache) window.__scoreCache.clear();
          dbg('[recalculateDailyRanking] å·²æ¸…é™¤æ’è¡Œæ¦œç¼“å­˜');
        } catch(e) {}
        
        dbg(`å·²é‡æ–°è®¡ç®— ${dateIso} çš„æ’åï¼Œæ¶‰åŠ ${updates.length} åå­¦ç”Ÿ`);
        
      } catch (error) {
        console.error('é‡æ–°è®¡ç®—æ’åå¤±è´¥:', error);
      }
    }

    // ç¡®ä¿ç®¡ç†å‘˜è°ƒåˆ†è¡¨å­˜åœ¨ï¼Œå¹¶åŒæ­¥ç°æœ‰çš„è°ƒåˆ†æ•°æ®åˆ° leaderboard_daily
    async function ensureAdminScoreTable() {
      try {
        // æ³¨æ„ï¼šè¿™éœ€è¦æ•°æ®åº“ç®¡ç†å‘˜æƒé™ï¼Œå®é™…ä½¿ç”¨æ—¶åº”è¯¥é¢„å…ˆåœ¨ Supabase æ§åˆ¶å°åˆ›å»ºè¡¨
        // ç®¡ç†å‘˜è°ƒåˆ†è¡¨ç»“æ„
        dbg('ç®¡ç†å‘˜è°ƒåˆ†è¡¨ç»“æ„ï¼ˆéœ€è¦åœ¨ Supabase æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»ºï¼‰:');
        dbg(`
          CREATE TABLE IF NOT EXISTS admin_score_adjustments (
            id SERIAL PRIMARY KEY,
            student_name TEXT NOT NULL,
            score_adjustment DECIMAL(5,2) NOT NULL,
            reason TEXT NOT NULL,
            timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
            date DATE NOT NULL,
            operator TEXT NOT NULL DEFAULT 'admin',
            created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
            updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
          );
          -- å¯é€‰ï¼šæ·»åŠ å”¯ä¸€çº¦æŸä»¥æ”¯æŒæ•°æ®åº“çº§åˆ«å¹‚ç­‰ï¼ˆå½“å‰å‰ç«¯å·²æ‰‹åŠ¨ upsertï¼‰
          -- ALTER TABLE admin_score_adjustments ADD CONSTRAINT admin_score_adjustments_student_name_key UNIQUE(student_name);
          
          -- ä¸º leaderboard_daily è¡¨æ·»åŠ ç®¡ç†å‘˜è°ƒåˆ†å­—æ®µï¼ˆå¯é€‰ï¼‰
          ALTER TABLE leaderboard_daily ADD COLUMN IF NOT EXISTS admin_adjustment DECIMAL(5,2) DEFAULT 0;
        `);
        
        // åŒæ­¥ç°æœ‰çš„ç®¡ç†å‘˜è°ƒåˆ†åˆ° leaderboard_daily
        await syncExistingAdminScoresToLeaderboard();
        
      } catch (error) {
        console.error('ç¡®ä¿ç®¡ç†å‘˜è°ƒåˆ†è¡¨å­˜åœ¨å¤±è´¥:', error);
      }
    }

    // åŒæ­¥ç°æœ‰çš„ç®¡ç†å‘˜è°ƒåˆ†æ•°æ®åˆ° leaderboard_daily
    async function syncExistingAdminScoresToLeaderboard() {
      if (!supabaseClient) return;
      
      try {
        const activeDate = getActiveLeaderboardDate();
        const activeIso = utils.toIsoDate(activeDate);
        
        // éå†æœ¬åœ°çš„ç®¡ç†å‘˜è°ƒåˆ†æ•°æ®
        for (const [studentName, adjustment] of Object.entries(adminScoreAdjustments)) {
          if (adjustment && adjustment.score !== 0) {
            await updateLeaderboardDailyScore(studentName, adjustment);
          }
        }
        
        dbg('å·²åŒæ­¥ç°æœ‰ç®¡ç†å‘˜è°ƒåˆ†æ•°æ®åˆ° leaderboard_daily');
      } catch (error) {
        console.error('åŒæ­¥ç°æœ‰ç®¡ç†å‘˜è°ƒåˆ†å¤±è´¥:', error);
      }
    }

    function clearAllCaches() {
      // æ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­˜
      rankingDataCache = null;
      lastRankingUpdateTime = 0;
  try { if (typeof RANK_CACHE_KEY !== 'undefined') localStorage.removeItem(RANK_CACHE_KEY); } catch(_) {}
      localStorage.removeItem('home_ranking_sync');
      if (window.rankingModeHtmlCache) {
        window.rankingModeHtmlCache.daily = null;
        window.rankingModeHtmlCache.weekly = null;
      }
      dbg('ç®¡ç†å‘˜è°ƒåˆ†åæ¸…é™¤æ‰€æœ‰ç¼“å­˜');
    }

    function getAdminScoreAdjustment(studentName) {
      const adjustment = adminScoreAdjustments[studentName];
      if (!adjustment) return 0;
      // ä»…å½“å¤©æœ‰æ•ˆï¼šæ ¡éªŒæ—¥æœŸä¸å½“å‰æ´»è·ƒæ—¥æœŸä¸€è‡´
      try {
        const activeIso = utils.toIsoDate(getActiveLeaderboardDate());
        return (adjustment.date === activeIso) ? (adjustment.score || 0) : 0;
      } catch (_) {
        // é™çº§ï¼šå¦‚æ— æ³•è·å–æ´»è·ƒæ—¥æœŸï¼Œåˆ™ä¸åº”ç”¨å†å²è°ƒåˆ†
        return 0;
      }
    }

    function getAdminScoreAdjustmentDetails(studentName) {
      const adjustment = adminScoreAdjustments[studentName] || null;
      if (!adjustment) return null;
      try {
        const activeIso = utils.toIsoDate(getActiveLeaderboardDate());
        return (adjustment.date === activeIso) ? adjustment : null;
      } catch (_) {
        return null;
      }
    }

  async function renderRankingFull(options) {
      options = options || {};
      const { keepScroll=true, silent=false, minimalAutoRefresh=true } = options;
      dbg('renderRankingFull() è°ƒç”¨, æ¨¡å¼:', rankingMode, 'opts:', options);
      const container = document.getElementById('rankingFullList');
      if (!container) { dbg('rankingFullList å®¹å™¨æœªæ‰¾åˆ°'); return; }

      // è®°å½•æ»šåŠ¨ä½ç½®ï¼ˆçˆ¶å®¹å™¨åŠçª—å£ï¼‰
      let winScrollY = window.scrollY;
      let containerScrollTop = container.scrollTop;

      // è‹¥å·²æœ‰å†…å®¹ä¸”ä¸æ˜¯æ˜¾å¼æ¨¡å¼åˆ‡æ¢åˆ·æ–°ï¼Œåˆ™é¿å…æ•´ä¸ª innerHTML é‡ç½®éª¨æ¶
      const hasExisting = container.innerHTML.trim().length > 0 && !container.querySelector('.ranking-item--skeleton');
      if (!hasExisting && !silent) {
        const skeletonHTML = `
          <div class="ranking-hero">
            <div class="ranking-hero-sub">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...</div>
          </div>
          <div class="ranking-section">
            <div class="ranking-rows">
              ${Array.from({length: 8}).map((_, i) => `
                <div class="ranking-row" style="opacity: 0.5; pointer-events: none;">
                  <div class="rank-num">${i + 1}</div>
                  <div class="row-user">
                    <div class="row-name" style="background: #e2e8f0; color: transparent; border-radius: 4px;">åŠ è½½ä¸­...</div>
                  </div>
                  <div class="row-points" style="background: #e2e8f0; color: transparent; border-radius: 4px; width: 60px; height: 20px;"></div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        scheduleDOM(()=>{ container.innerHTML = skeletonHTML; });
        await new Promise(r=>requestAnimationFrame(r));
      }
      
      // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
      updateRankingTabs();
      
      // æ—¥æ¦œæ¨¡å¼ï¼šå‘¨æœ«ä¸å±•ç¤ºå…·ä½“å†…å®¹
      if (rankingMode === 'daily') {
        const __today = getActiveLeaderboardDate();
        if (!isWorkday(__today)) {
          const wkHTML = `
            <div class="ranking-hero">
              <div class="ranking-hero-sub">å‘¨æœ«ï¼ˆå‘¨å…­/å‘¨æ—¥ï¼‰ä¸å±•ç¤ºæ—¥æ¦œï¼›å·¥ä½œæ—¥æ’è¡Œæ¦œçª—å£ï¼šå‘¨ä¸€/äºŒ/å››/äº” 08:00â€“19:00ï¼Œå‘¨ä¸‰ 08:00â€“19:30ï¼›ç»´åº¦ä¸‰å†å²è¯„åˆ†å‚è€ƒä¸åŒ…å«å‘¨å…­å‘¨æ—¥ï¼Œä¸”æ’é™¤å½“æ—¥æ— ç»ƒç´çš„å·¥ä½œæ—¥ï¼›å½“æ—¥æ— ç»ƒç´åˆ™ä¸è®¡åˆ†ã€‚è¯·åœ¨å·¥ä½œæ—¥æŸ¥çœ‹ã€‚</div>
            </div>`;
          scheduleDOM(()=>{ container.innerHTML = wkHTML; });
          return;
        }
      }
      let items = [];
  // å‘¨æ¦œè¯¦æƒ…æ˜ å°„ï¼ˆname -> { scores: number[5], datesIso: string[5], datesLabel: string[5] }ï¼‰
  let weeklyDetailMap = null;
  let weeklyDatesIso = null;
  let weeklyDatesLabel = null;
      
      if (rankingMode === 'weekly') {
        // å‘¨æ¦œæ¨¡å¼ï¼šä»æ•°æ®åº“è·å–æœ€è¿‘5å¤©å¹³å‡åˆ†
        const weeklyData = await fetchWeeklyLeaderboardData();
        if (weeklyData.length === 0) {
          const emptyWeekly = `
            <div class="ranking-hero">
              <div class="ranking-hero-sub">æš‚æ— å‘¨æ¦œæ•°æ®ï¼Œéœ€è¦è‡³å°‘5ä¸ªå·¥ä½œæ—¥çš„ç»ƒç´è®°å½•</div>
            </div>`;
          scheduleDOM(()=>{ container.innerHTML = emptyWeekly; });
          return;
        }
        // è®¡ç®—ä¸å‘¨æ¦œä¸€è‡´çš„5ä¸ªå·¥ä½œæ—¥ï¼ˆç”¨äºå¼¹çª—å±•ç¤ºæ—¥æœŸï¼‰
        const refDate = getActiveLeaderboardDate();
        const endWorkday = nearestWorkdayOnOrBefore(refDate);
        const workdayDates = getLastNWorkdayDates(endWorkday, 5);
        weeklyDatesIso = workdayDates.map(d => utils.toIsoDate(d));
        weeklyDatesLabel = workdayDates.map(d => `${d.getMonth() + 1}/${d.getDate()}`);
        weeklyDetailMap = {};
        weeklyData.forEach(d => {
          weeklyDetailMap[d.studentName] = {
            scores: Array.isArray(d.scores) ? d.scores : [],
            datesIso: weeklyDatesIso,
            datesLabel: weeklyDatesLabel
          };
        });
        // æš´éœ²åˆ°å…¨å±€ï¼Œä¾›æŒ‰é’®ç‚¹å‡»æ—¶æŸ¥è¯¢
        window.__weeklyDetailMap = weeklyDetailMap;
        window.__weeklyDatesIso = weeklyDatesIso;
        window.__weeklyDatesLabel = weeklyDatesLabel;
        // è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
        items = weeklyData.map(data => ({
          name: data.studentName,
          rankingScore: data.averageScore,
          dayCount: data.dayCount,
          isWeekly: true,
          weeklyScores: Array.isArray(data.scores) ? data.scores : []
        }));
      } else {
        // æ—¥æ¦œæ¨¡å¼ï¼šå®æ—¶è®¡ç®—å½“æ—¥è¯„åˆ†
        let all = [];
        try {
          all = Array.from(appState.students?.values?.() || []);
        } catch { all = []; }

        dbg('è·å–å­¦ç”Ÿæ•°æ®:', { allCount: all.length });
        dbg('appState.students çŠ¶æ€:', appState.students);
        dbg('appState.studentsMeta çŠ¶æ€:', appState.studentsMeta);

        // ğŸ”§ æ£€æŸ¥æ•°æ®æ˜¯å¦å‡†å¤‡å¥½
        const isDataReady = appState.students && appState.students.size > 0 && 
                            appState.studentsMeta && appState.studentsMeta.size > 0;
        
        // è‹¥åˆ†ææ•°æ®ä¸ºç©º
        if (!all.length) {
          const metaEntries = Array.from(appState.studentsMeta?.entries?.() || []);
          dbg('studentsMeta æ¡ç›®æ•°:', metaEntries.length);
          
          // æ•°æ®è¿˜åœ¨åŠ è½½ä¸­
          if (!metaEntries.length) {
            if (!isDataReady) {
              // ä¿æŒéª¨æ¶å±ï¼Œä¸æ˜¾ç¤º"æ— æ•°æ®"
              dbg('å®Œæ•´æ’è¡Œæ¦œï¼šæ•°æ®åŠ è½½ä¸­ï¼Œä¿æŒéª¨æ¶å±');
              if (!hasExisting && !silent) {
                const skeletonHTML = `
                  <div class="ranking-hero">
                    <div class="ranking-hero-sub">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...</div>
                  </div>
                  <div class="ranking-section">
                    <div class="ranking-rows">
                      ${Array.from({length: 8}).map((_, i) => `
                        <div class="ranking-row" style="opacity: 0.5; pointer-events: none;">
                          <div class="rank-num">${i + 1}</div>
                          <div class="row-user">
                            <div class="row-name" style="background: #e2e8f0; color: transparent; border-radius: 4px;">åŠ è½½ä¸­...</div>
                          </div>
                          <div class="row-points" style="background: #e2e8f0; color: transparent; border-radius: 4px; width: 60px; height: 20px;"></div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                `;
                scheduleDOM(()=>{ container.innerHTML = skeletonHTML; });
              } else if (hasExisting) {
                // å¦‚æœå·²æœ‰éª¨æ¶å±ï¼Œä¸é‡æ–°æ¸²æŸ“ï¼Œé¿å…é¡µé¢è·³åŠ¨
                dbg('å®Œæ•´æ’è¡Œæ¦œï¼šæ•°æ®åŠ è½½ä¸­ï¼Œä¿æŒç°æœ‰éª¨æ¶å±ä¸å˜');
              }
              // å»¶è¿Ÿé‡è¯•ï¼ˆä¿æŒ silent: true é¿å…é‡å¤æ¸²æŸ“éª¨æ¶å±ï¼‰
              setTimeout(() => renderRankingFull({ silent: true, keepScroll: true }), 1000);
              return;
            } else {
              // æ•°æ®å·²åŠ è½½ä½†ç¡®å®æ²¡æœ‰å­¦ç”Ÿ
              dbg('å®Œæ•´æ’è¡Œæ¦œï¼šæ•°æ®å·²åŠ è½½ï¼Œä½†æ²¡æœ‰å­¦ç”Ÿ');
              container.innerHTML = `
                <div class="ranking-hero">
                  <div class="ranking-hero-sub">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>
                </div>`;
              return;
            }
          }
          all = metaEntries.map(([name, meta]) => ({ name, todayMinutes: { in: 0, out: 0 }, currentStatus: 'offline' }));
          dbg('ä½¿ç”¨ studentsMeta æ„é€ å ä½é¡¹:', all.length);
        }

        // å¼‚æ­¥é¢„çƒ­ç¼“å­˜ï¼Œä¸é˜»å¡UIï¼ˆåå°è¿›è¡Œï¼‰
        const prefetchPromise = (async () => {
          try {
            const activeDate = getActiveLeaderboardDate();
            const endWorkday = nearestWorkdayOnOrBefore(activeDate);
            const curDates = getLastNWorkdayDates(endWorkday, 7);
            const prevWindowEnd = previousWorkday(curDates[0]);
            const prevDates = getLastNWorkdayDates(prevWindowEnd, 7);
            await __prefetchD12ForWindows(all.map(s => utils.normalizeStudentName(s.name)), [...curDates, ...prevDates]);
            await __getPrevDayRankMapCached(previousWorkday(activeDate));
            await __getPrevTopByDateCached(activeDate);
            dbg('ç¼“å­˜é¢„çƒ­å®Œæˆ');
          } catch(e) {
            dbg('ç¼“å­˜é¢„çƒ­å¤±è´¥:', e);
          }
        })();

        // ===== æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜ + åˆ†å—å¼‚æ­¥è®¡ç®— + è¿›åº¦éª¨æ¶ =====
        const activeDate = getActiveLeaderboardDate();
        const activeIso = utils.toIsoDate(activeDate);

        const RANK_CACHE_SIG = (() => {
          const studentCount = (appState.studentsMeta && appState.studentsMeta.size) || 0;
          return `v2|${RULE_VERSION}|${studentCount}`; // ç‰ˆæœ¬|è§„åˆ™|å­¦ç”Ÿæ•°
        })();
        function loadRankCache(dateIso){
          try{ 
            const raw = localStorage.getItem(RANK_CACHE_KEY); 
            if (!raw) return null; 
            const obj = JSON.parse(raw); 
            if (obj && obj.date === dateIso && typeof obj.html === 'string' && obj.sig === RANK_CACHE_SIG) { 
              // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰
              const now = Date.now();
              if (now - obj.ts < 300000) { // 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
                return obj; 
              }
            } 
          } catch(_) {}
          return null;
        }
        function saveRankCache(dateIso, html, meta){
          try{ 
            const timestamp = Date.now();
            const dataHash = generateDataHash([...logs, ...students]);
            const payload = { 
              date: dateIso, 
              html, 
              ts: timestamp,
              dataHash,
              sig: RANK_CACHE_SIG,
              ...meta 
            };
            localStorage.setItem(RANK_CACHE_KEY, JSON.stringify(payload)); 
            // åŒæ­¥åˆ°é¦–é¡µç¼“å­˜ï¼ˆç¡®ä¿ä¸€è‡´æ€§ + ç­¾åï¼‰
            localStorage.setItem('home_ranking_sync', JSON.stringify({
              date: dateIso,
              ts: timestamp,
              dataHash,
              sig: RANK_CACHE_SIG
            }));
            dbg('æ’è¡Œæ¦œç¼“å­˜å·²ä¿å­˜å¹¶åŒæ­¥åˆ°é¦–é¡µ', { dateIso, timestamp, dataHash, sig: RANK_CACHE_SIG });
          } catch(_) {/* å¿½ç•¥ */}
        }
        function clearRankCache() {
          try {
            localStorage.removeItem(RANK_CACHE_KEY);
            // åŒæ—¶æ¸…é™¤å…¨å±€ç¼“å­˜
            rankingDataCache = null;
            lastRankingUpdateTime = 0;
            dbg('æ’è¡Œæ¦œç¼“å­˜å·²æ¸…é™¤');
          } catch(_) {}
        }
        function renderProgress(done, total) {
          const percent = total ? Math.min(100, Math.floor(done / total * 100)) : 0;
          const sub = container.querySelector('.ranking-hero-sub');
          if (sub) {
            // åªæ›´æ–°è¿›åº¦æ–‡æœ¬ï¼Œä¿æŒç°æœ‰éª¨æ¶ç»“æ„
            sub.innerHTML = `æ­£åœ¨è®¡ç®—æ’è¡Œæ¦œ <span style="color: #6366f1; font-weight: 600;">${percent}%</span> (${done}/${total})`;
          }
        }
        function renderIncrementalRows(processed){
          if(!container.__lbProgress) return; // æ²¡æœ‰éª¨æ¶ä¸æ›´æ–°
          const rowsWrap = container.querySelector('.ranking-rows');
          if(!rowsWrap) return;
          const list = processed.slice();
          const CHUNK = 20;
          let idx = 0;
          rowsWrap.innerHTML='';
          const appendChunk = () => {
            const slice = list.slice(idx, idx+CHUNK);
            if(!slice.length) return;
            const html = slice.map(s=>`<div class='ranking-row' data-student='${s.name}'>`+
              `<div class='rank-num'>${s.__rankTmp}</div>`+
              `<div class='row-user'><div class='row-name'>${s.name}</div></div>`+
              `<div class='row-points'>${Number.isFinite(s.rankingScore)?s.rankingScore.toFixed(1):'-'}åˆ† <button class="score-detail-btn" onclick="event.stopPropagation(); showScoreDetail('${s.name}')" title="æŸ¥çœ‹è¯„åˆ†è¯¦æƒ…">?</button></div>`+
            `</div>`).join('');
            scheduleDOM(()=>{ rowsWrap.insertAdjacentHTML('beforeend', html); });
            idx += CHUNK;
            if(idx < list.length) requestAnimationFrame(appendChunk);
          };
          appendChunk();
        }

        // æ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§
        function isCacheConsistent() {
          try {
            const homeSync = localStorage.getItem('home_ranking_sync');
            const rankCache = localStorage.getItem(RANK_CACHE_KEY);
            if (!homeSync || !rankCache) return false;
            
            const homeSyncData = JSON.parse(homeSync);
            const rankCacheData = JSON.parse(rankCache);
            
            // æ£€æŸ¥æ—¥æœŸå’Œæ—¶é—´æˆ³æ˜¯å¦æ¥è¿‘ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
            return homeSyncData.date === rankCacheData.date && 
                   Math.abs(homeSyncData.ts - rankCacheData.ts) < 300000;
          } catch(_) {
            return false;
          }
        }
        
        // å…ˆå°è¯•å±•ç¤ºç¼“å­˜ï¼ˆç¡®ä¿ä¸€è‡´æ€§ï¼‰
        const cached = loadRankCache(activeIso);
        if (cached && cached.html && cached.html.length > 100 && isCacheConsistent()) {
          dbg('ä½¿ç”¨æ’è¡Œæ¦œç¼“å­˜å±•ç¤ºï¼ˆå·²éªŒè¯ä¸€è‡´æ€§ï¼‰', cached);
          try { 
            container.innerHTML = cached.html;
            // æ˜¾ç¤ºç¼“å­˜æç¤º
            const heroSub = container.querySelector('.ranking-hero-sub');
            if (heroSub && !heroSub.textContent.includes('ç¼“å­˜')) {
              heroSub.innerHTML += ' <span style="color: #10b981; font-size: 12px;">(å·²åŒæ­¥)</span>';
            }
            return; // ä½¿ç”¨ç¼“å­˜ï¼Œç›´æ¥è¿”å›
          } catch(_) { 
            dbg('ç¼“å­˜åŠ è½½å¤±è´¥ï¼Œç»§ç»­è®¡ç®—');
          }
        } else if (cached) {
          dbg('ç¼“å­˜å­˜åœ¨ä½†ä¸é¦–é¡µä¸ä¸€è‡´ï¼Œæ¸…é™¤ç¼“å­˜é‡æ–°è®¡ç®—');
          clearRankCache();
        }

        // åˆ†å—è®¡ç®—ï¼ˆé¿å…é•¿æ—¶é—´é˜»å¡ & ç©ºç™½ï¼‰
        const allStudents = all.slice();
        const concurrency = 10; // æ¯æ‰¹å¹¶å‘é‡
        let processed = [];
        let index = 0;

        async function processBatch() {
          const start = performance.now();
          if(window.__perfFlags && window.__perfFlags.instrumentRanking){ performance.mark && performance.mark('ranking_batch_start'); }
          const batch = allStudents.slice(index, index + concurrency);
          
          // ç«‹å³æ›´æ–°è¿›åº¦ï¼Œæä¾›ç”¨æˆ·åé¦ˆ
          if (!cached) {
            renderProgress(index, allStudents.length);
          }
          
          const results = await Promise.all(batch.map(async (student) => {
            try { 
              const s = await computeScore442(student); 
              return { student, s }; 
            } catch(e) { 
              dbg('è®¡ç®—å­¦ç”Ÿåˆ†æ•°å‡ºé”™:', student.name, e); 
              return { student, s: { total: 0, d1: 0, d2: 0, d3: 0 } }; 
            }
          }));
          
          results.forEach(r => { 
            processed.push({ ...r.student, rankingScore: r.s.total, __442: r.s }); 
          });
          
          index += concurrency;
          
          if (index < allStudents.length) {
            // æ›´æ–°è¿›åº¦å¹¶å®æ—¶æ˜¾ç¤ºå½“å‰ç»“æœ
            if (!cached) {
              renderProgress(index, allStudents.length);
              const topPreview = processed.slice().sort((a, b) => {
                // 1. æ€»åˆ†é™åº
                if (Math.abs(b.rankingScore - a.rankingScore) > 1e-6) {
                  return b.rankingScore - a.rankingScore;
                }
                // 2. ç»´åº¦1é™åºï¼ˆd1 æ˜¯æ•°å­—ï¼Œä¸æ˜¯å¯¹è±¡ï¼‰
                const aD1 = a.__442?.d1 || 0;
                const bD1 = b.__442?.d1 || 0;
                if (Math.abs(bD1 - aD1) > 1e-6) {
                  return bD1 - aD1;
                }
                // 3. ç»´åº¦2é™åºï¼ˆd2 æ˜¯æ•°å­—ï¼Œä¸æ˜¯å¯¹è±¡ï¼‰
                const aD2 = a.__442?.d2 || 0;
                const bD2 = b.__442?.d2 || 0;
                if (Math.abs(bD2 - aD2) > 1e-6) {
                  return bD2 - aD2;
                }
                // 4. ç»´åº¦3é™åºï¼ˆd3 æ˜¯æ•°å­—ï¼Œä¸æ˜¯å¯¹è±¡ï¼‰
                const aD3 = a.__442?.d3 || 0;
                const bD3 = b.__442?.d3 || 0;
                if (Math.abs(bD3 - aD3) > 1e-6) {
                  return bD3 - aD3;
                }
                // 5. å§“åå‡åº
                return a.name.localeCompare(b.name);
              }).slice(0, 12);
              topPreview.forEach((s, i) => s.__rankTmp = i + 1);
              renderIncrementalRows(topPreview);
            }
            
            const elapsed = performance.now() - start;
            // å‡å°‘å»¶è¿Ÿï¼Œæå‡å“åº”é€Ÿåº¦
            const delay = elapsed > 100 ? 10 : 0;
            if(window.__perfFlags && window.__perfFlags.instrumentRanking){
              const dur = (performance.now()-start).toFixed(1);
              dbg(`[perf] ranking batch processed ${batch.length} -> total ${index}/${allStudents.length} in ${dur}ms`);
            }
            setTimeout(processBatch, delay);
          } else {
            // å…¨éƒ¨å®Œæˆ
            // æ’åºï¼šæ€»åˆ† â†’ ç»´åº¦1 â†’ ç»´åº¦2 â†’ ç»´åº¦3 â†’ å§“å
            processed.sort((a, b) => {
              // 1. æ€»åˆ†é™åº
              if (Math.abs(b.rankingScore - a.rankingScore) > 1e-6) {
                return b.rankingScore - a.rankingScore;
              }
              // 2. ç»´åº¦1é™åºï¼ˆd1 æ˜¯æ•°å­—ï¼Œä¸æ˜¯å¯¹è±¡ï¼‰
              const aD1 = a.__442?.d1 || 0;
              const bD1 = b.__442?.d1 || 0;
              if (Math.abs(bD1 - aD1) > 1e-6) {
                return bD1 - aD1;
              }
              // 3. ç»´åº¦2é™åºï¼ˆd2 æ˜¯æ•°å­—ï¼Œä¸æ˜¯å¯¹è±¡ï¼‰
              const aD2 = a.__442?.d2 || 0;
              const bD2 = b.__442?.d2 || 0;
              if (Math.abs(bD2 - aD2) > 1e-6) {
                return bD2 - aD2;
              }
              // 4. ç»´åº¦3é™åºï¼ˆd3 æ˜¯æ•°å­—ï¼Œä¸æ˜¯å¯¹è±¡ï¼‰
              const aD3 = a.__442?.d3 || 0;
              const bD3 = b.__442?.d3 || 0;
              if (Math.abs(bD3 - aD3) > 1e-6) {
                return bD3 - aD3;
              }
              // 5. å§“åå‡åº
              return a.name.localeCompare(b.name);
            });
            processed.forEach((s, i) => s.__rankTmp = i + 1);
            items = processed;
            container.__lbProgress = false;
            finalizeRankingRender();
          }
        }

        // å°†åç»­æ¸²æŸ“å°è£…ï¼Œä¾›åˆ†å—ç»“æŸåè°ƒç”¨
        async function finalizeRankingRender(){
          const __finalStart = performance.now();
          try {
            if(!Array.isArray(items) || !items.length){
              container.innerHTML = `<div class="ranking-hero"><div class="ranking-hero-sub">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div></div>`; return;
            }
            // ç»Ÿä¸€å…œåº•ï¼šç©ºæˆ–éæ³•åˆ†æ•°è®¾ä¸º 0
            items.forEach(it=>{ if(!Number.isFinite(it.rankingScore)) it.rankingScore = 0; });

            // === ç™½åå•è¿‡æ»¤ + å»é‡ï¼ˆé˜²å·²åˆ é™¤ / é‡å¤ / å¹½çµå­¦ç”Ÿï¼‰===
            try {
              const allowed = new Set(appState.studentsMeta?.keys?.() ? Array.from(appState.studentsMeta.keys()) : []);
              if (allowed.size) {
                const before = items.length;
                const seen = new Set();
                items = items.filter(it => allowed.has(it.name) && !seen.has(it.name) && seen.add(it.name));
                if (before !== items.length) {
                  try { localStorage.removeItem(RANK_CACHE_KEY); localStorage.removeItem('__scoreCache'); } catch(_) {}
                  dbg('[ranking] è¿‡æ»¤å·²åˆ /é‡å¤å­¦ç”Ÿ:', before - items.length);
                }
              }
            } catch(e){ dbg('ç™½åå•è¿‡æ»¤å¤±è´¥(å¿½ç•¥ç»§ç»­):', e); }

            // æ’åºï¼ˆç¡®ä¿æœ€ç»ˆé¡ºåºï¼‰
            // æ’åºï¼šæ€»åˆ† â†’ ç»´åº¦1 â†’ ç»´åº¦2 â†’ ç»´åº¦3 â†’ å§“å
            items.sort((a, b) => {
              // 1. æ€»åˆ†é™åº
              if (Math.abs(b.rankingScore - a.rankingScore) > 1e-6) {
                return b.rankingScore - a.rankingScore;
              }
              // 2. ç»´åº¦1é™åº
              const aD1 = a.__442?.d1?.score || 0;
              const bD1 = b.__442?.d1?.score || 0;
              if (Math.abs(bD1 - aD1) > 1e-6) {
                return bD1 - aD1;
              }
              // 3. ç»´åº¦2é™åº
              const aD2 = a.__442?.d2?.score || 0;
              const bD2 = b.__442?.d2?.score || 0;
              if (Math.abs(bD2 - aD2) > 1e-6) {
                return bD2 - aD2;
              }
              // 4. ç»´åº¦3é™åº
              const aD3 = a.__442?.d3?.score || 0;
              const bD3 = b.__442?.d3?.score || 0;
              if (Math.abs(bD3 - aD3) > 1e-6) {
                return bD3 - aD3;
              }
              // 5. å§“åå‡åº
              return a.name.localeCompare(b.name);
            });
            const top3 = items.slice(0,3);
            const rest = items.slice(3);

            const titleInfo = (typeof getRankingTitleInfo==='function') ? getRankingTitleInfo() : { title:'æ’è¡Œæ¦œ', subtitle:'' };
            const weeklyHintHTML = (typeof rankingMode!=='undefined' && rankingMode === 'weekly' && typeof getActiveLeaderboardDate==='function' && typeof isWorkday==='function' && isWorkday(getActiveLeaderboardDate()))
              ? '<div class="ranking-hero-sub">å«ä»Šæ—¥å®æ—¶åˆ†ï¼ˆå¦‚åœ¨å·¥ä½œæ—¥ï¼‰</div>' : '';

            const buildScoreText = s => (s.isWeekly ? (Number.isFinite(s.rankingScore)?s.rankingScore.toFixed(1):'-') : (Number.isFinite(s.rankingScore)?s.rankingScore.toFixed(1):'-')) + 'åˆ†';
            const buildDetailBtn = s => s.isWeekly
                ? `<button class="score-detail-btn" onclick="event.stopPropagation(); (window.showWeeklyScores?showWeeklyScores('${s.name}'):alert('å‘¨æ¦œè¯¦æƒ…æœªåŠ è½½'))" title="æŸ¥çœ‹5æ—¥åˆ†æ•°">?</button>`
                : `<button class="score-detail-btn" onclick="event.stopPropagation(); showScoreDetail('${s.name}')" title="æŸ¥çœ‹è¯„åˆ†è¯¦æƒ…">?</button>`;

            const createTop3Card = (s, rank) => {
              const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : 'rank-3';
              const positionClass = rank === 1 ? ' first-place' : rank === 2 ? ' second-place' : ' third-place';
              return `<div class="top3-card${positionClass}" data-student="${s.name}" onclick="openStudentDetailFromRankingFull('${s.name}')">`+
                `<div class="rank-badge ${rankClass}">${rank}</div>`+
                `<div class="top3-name">${s.name}</div>`+
                `<div class="top3-points">${buildScoreText(s)} ${buildDetailBtn(s)}</div>`+
              `</div>`;
            };

            let top3HTMLBlock = '';
            if(top3.length){
              // é¡ºåºï¼š2,1,3 ä¿æŒè§†è§‰ä¸­å¿ƒçªå‡ºç¬¬ä¸€å
              if(top3[1]) top3HTMLBlock += createTop3Card(top3[1],2);
              if(top3[0]) top3HTMLBlock += createTop3Card(top3[0],1);
              if(top3[2]) top3HTMLBlock += createTop3Card(top3[2],3);
            }

            const top3HTML = `<div class="ranking-hero">`+
              `<div class="ranking-title"><h2>${titleInfo.title}</h2><p class="ranking-subtitle">${titleInfo.subtitle||''}</p>${weeklyHintHTML}</div>`+
              `<div class="top3-wrap">${top3HTMLBlock}</div>`+
            `</div>`;

            const rowsHTML = `<div class="ranking-section"><div class="ranking-rows">`+
              rest.map((s,idx)=>{
                const rank = idx + 4;
                return `<div class='ranking-row' data-student='${s.name}' onclick="openStudentDetailFromRankingFull('${s.name}')">`+
                  `<div class='rank-num'>${rank}</div>`+
                  `<div class='row-user'><div class='row-name'>${s.name}</div></div>`+
                  `<div class='row-points'>${buildScoreText(s)} ${buildDetailBtn(s)}</div>`+
                `</div>`;
              }).join('')+
            `</div></div>`;

            const newHTML = top3HTML + rowsHTML;
            // å†…å®¹ç›¸åŒåˆ™è·³è¿‡ DOM æ›´æ–°é¿å…é—ªçƒï¼ˆå“ˆå¸Œæˆ–ç›´æ¥å­—ç¬¦ä¸²æ¯”è¾ƒï¼‰
            if (minimalAutoRefresh && container.__lastRankingHtml === newHTML) {
              dbg('æ’è¡Œæ¦œå†…å®¹æœªå˜åŒ–ï¼Œè·³è¿‡é‡ç»˜');
              return;
            }
            scheduleDOM(()=>{ container.innerHTML = newHTML; }, 2);
            if(window.__perfFlags && window.__perfFlags.instrumentRanking){ dbg(`[perf] finalizeRankingRender DOM ${(performance.now()-__finalStart).toFixed(1)}ms for ${items.length} students`); }
            // === æ’è¡Œæ¦œäº‹ä»¶å§”æ‰˜ï¼ˆé˜²æ­¢åç»­ DOM å±€éƒ¨åˆ·æ–°é”™ä½ï¼‰===
            (function bindRankingDelegation(){
              if (container.__delegated) return; // åªç»‘å®šä¸€æ¬¡
              container.addEventListener('click', e => {
                const card = e.target.closest('.ranking-row, .top3-card');
                if(!card) return;
                const studentName = card.getAttribute('data-student');
                if(!studentName) return;
                if(!appState.studentsMeta?.has?.(studentName)) { console.warn('[ranking] stale click ignored:', studentName); return; }
                openStudentDetailFromRankingFull(studentName);
              });
              container.__delegated = true;
            })();
            container.__lastRankingHtml = newHTML;
            container.__lbProgress = false;
            try { 
              if(typeof saveRankCache==='function' && typeof activeIso!=='undefined'){ 
                saveRankCache(activeIso, top3HTML + rowsHTML, { 
                  count: items.length,
                  topStudents: items.slice(0, 3).map(s => ({
                    name: s.name,
                    rankingScore: s.rankingScore,
                    __442: s.__442
                  }))
                }); 
              } 
            } catch(_){}
            dbg('æœ€ç»ˆæ’è¡Œæ¦œæ¸²æŸ“å®Œæˆ',{ count: items.length });
            // æ¢å¤æ»šåŠ¨
            if (keepScroll) {
              try { window.scrollTo({ top: winScrollY, behavior: 'instant' }); } catch(_){}
              try { container.scrollTop = containerScrollTop; } catch(_){}
            }
          } catch(e){ dbg('finalizeRankingRender error', e); scheduleDOM(()=>{ container.innerHTML = `<div class='ranking-hero'><div class='ranking-hero-sub'>æ¸²æŸ“å‡ºé”™ï¼š${e.message}</div></div>`; },1); }
        }

        // å¯åŠ¨åˆ†å—è®¡ç®—ï¼ˆç­‰å¾…é¢„çƒ­å®Œæˆæˆ–è¶…æ—¶åå¼€å§‹ï¼‰
        Promise.race([
          prefetchPromise,
          new Promise(resolve => setTimeout(resolve, 500)) // æœ€å¤šç­‰å¾…500ms
        ]).finally(() => {
          processBatch();
        });
        // ç­‰å¾…å¼‚æ­¥å®Œæˆåï¼Œåç»­ä»£ç ä¼šåœ¨ finalizeRankingRender ä¸­ç»§ç»­ã€‚
        // æ³¨æ„ï¼šä¸‹é¢ä¾èµ– items çš„ä»£ç ä¼šåœ¨å¼‚æ­¥å®Œæˆæ—¶å†æ¬¡è¿è¡Œï¼ˆé€šè¿‡ finalizeRankingRenderï¼‰ï¼Œå› æ­¤æ­¤å¤„å…ˆæå‰ returnï¼Œé¿å…ç»§ç»­æ‰§è¡Œæ—§åŒæ­¥è·¯å¾„ã€‚
        return; // ç»ˆæ­¢å½“å‰åŒæ­¥åˆ†æ”¯ï¼Œç­‰å¾…å¼‚æ­¥æ¸²æŸ“å®Œæˆ
      }

      dbg('å¤„ç†åçš„ items:', { itemsCount: items.length });

      if (items.length === 0) {
        dbg('items ä¸ºç©ºï¼Œæ˜¾ç¤ºæ— æ•°æ®æç¤º');
        container.innerHTML = `
          <div class="ranking-hero">
            <div class="ranking-hero-sub">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>
          </div>`;
        return;
      }

      // ç”Ÿæˆ Top3
      const top3 = items.slice(0, 3);
      const rest = items.slice(3);

      // åŠ¨æ€ç”Ÿæˆæ ‡é¢˜
      const titleInfo = getRankingTitleInfo();
      const weeklyHintHTML = (rankingMode === 'weekly' && isWorkday(getActiveLeaderboardDate()))
        ? '<div class="ranking-hero-sub">å«ä»Šæ—¥å®æ—¶åˆ†ï¼ˆå¦‚åœ¨å·¥ä½œæ—¥ï¼‰</div>'
        : '';
      
  const top3HTML = `
        <div class="ranking-hero">
          <div class="ranking-title">
            <h2>${titleInfo.title}</h2>
            <p class="ranking-subtitle">${titleInfo.subtitle}</p>
            ${weeklyHintHTML}
          </div>
          <div class="top3-wrap">
            ${top3.length > 0 ? (() => {
              const createCard = (s, rank) => {
                let initials;
                try {
                  initials = utils.getStudentInitials(s.name);
                } catch (e) {
                  dbg('getStudentInitials å‡ºé”™:', s.name, e);
                  initials = s.name.charAt(0) || '?';
                }
                const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : 'rank-3';
                const positionClass = rank === 1 ? ' first-place' : rank === 2 ? ' second-place' : ' third-place';
                const scoreText = s.isWeekly 
                  ? `${Number.isFinite(s.rankingScore)?s.rankingScore.toFixed(1):'-'}åˆ†`
                  : `${Number.isFinite(s.rankingScore)?s.rankingScore.toFixed(1):'-'}åˆ†`;
                const detailBtn = s.isWeekly
                  ? `<button class="score-detail-btn" onclick="event.stopPropagation(); showWeeklyScores('${s.name}')" title="æŸ¥çœ‹5æ—¥åˆ†æ•°">?</button>`
                  : `<button class="score-detail-btn" onclick="event.stopPropagation(); showScoreDetail('${s.name}')" title="æŸ¥çœ‹è¯„åˆ†è¯¦æƒ…">?</button>`;
                return `
                  <div class="top3-card${positionClass}" onclick="openStudentDetailFromRankingFull('${s.name}')">
                    <div class="rank-badge ${rankClass}">${rank}</div>
                    <div class="top3-name">${s.name}</div>
                    <div class="top3-points">
                      ${scoreText}
                      ${detailBtn}
                    </div>
                  </div>
                `;
              };
              
              // æŒ‰ç…§å¸ƒå±€é¡ºåºï¼šç¬¬äºŒåã€ç¬¬ä¸€åã€ç¬¬ä¸‰å
              let html = '';
              if (top3[1]) html += createCard(top3[1], 2); // ç¬¬äºŒååœ¨å·¦ä¾§
              if (top3[0]) html += createCard(top3[0], 1); // ç¬¬ä¸€ååœ¨ä¸­é—´
              if (top3[2]) html += createCard(top3[2], 3); // ç¬¬ä¸‰ååœ¨å³ä¾§
              return html;
            })() : ''}
          </div>
        </div>`;

      const rowsHTML = `
        <div class="ranking-section">
          <div class="ranking-rows">
            ${rest.map((s, idx) => {
              const rank = idx + 4;
              let initials;
              try {
                initials = utils.getStudentInitials(s.name);
              } catch (e) {
                dbg('getStudentInitials å‡ºé”™ (rest):', s.name, e);
                initials = s.name.charAt(0) || '?';
              }
              const scoreText = s.isWeekly 
                ? `${Number.isFinite(s.rankingScore)?s.rankingScore.toFixed(1):'-'}åˆ†`
                : `${Number.isFinite(s.rankingScore)?s.rankingScore.toFixed(1):'-'}åˆ†`;
              const detailBtn = s.isWeekly
                ? `<button class="score-detail-btn" onclick="event.stopPropagation(); showWeeklyScores('${s.name}')" title="æŸ¥çœ‹5æ—¥åˆ†æ•°">?</button>`
                : `<button class="score-detail-btn" onclick="event.stopPropagation(); showScoreDetail('${s.name}')" title="æŸ¥çœ‹è¯„åˆ†è¯¦æƒ…">?</button>`;
              return `
                <div class="ranking-row" onclick="openStudentDetailFromRankingFull('${s.name}')">
                  <div class="rank-num">${rank}</div>
                  <div class="row-user">
                    <div class="row-name">${s.name}</div>
                  </div>
                  <div class="row-points">
                    ${scoreText}
                    ${detailBtn}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>`;

      container.innerHTML = top3HTML + rowsHTML;
      try {
        // è‹¥åˆ†å—æ¨¡å¼å®Œæˆåä¼šå†èµ°è¿™é‡Œï¼Œä¿å­˜ç¼“å­˜
        if(typeof saveRankCache === 'function' && typeof activeIso !== 'undefined'){
          saveRankCache(activeIso, top3HTML + rowsHTML, { count: items.length });
        }
      } catch(_){}
      
      // æ·»åŠ å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
      window.loadMoreRankings = () => {
        // è¿™é‡Œå¯ä»¥å®ç°æ‡’åŠ è½½é€»è¾‘
        console.log('åŠ è½½æ›´å¤šæ’å...');
      };
      
      dbg('HTML å·²è®¾ç½®åˆ°å®¹å™¨ï¼Œæœ€ç»ˆ HTML é•¿åº¦:', (top3HTML + rowsHTML).length);

      // å°†æ–¹æ³•æŒ‚è½½åˆ°å…¨å±€ï¼Œä¾›æŒ‰é’®ä½¿ç”¨
      window.showWeeklyScores = function(studentName) {
        try {
          const map = window.__weeklyDetailMap || {};
          const entry = map[studentName];
          const datesIso = (entry && entry.datesIso) || window.__weeklyDatesIso || [];
          const datesLabel = (entry && entry.datesLabel) || window.__weeklyDatesLabel || [];
          const scores = (entry && entry.scores) || [];
          // æ„å»ºåˆ—è¡¨å†…å®¹
          const todayIso = utils.toIsoDate(getActiveLeaderboardDate());
          const rows = datesIso.map((iso, i) => {
            const lab = datesLabel[i] || iso;
            const sc = (scores[i] != null ? Number(scores[i]).toFixed(1) : '0.0');
            const todayMark = (iso === todayIso) ? ' <span style="color: var(--brand-600); font-weight: 600;">(ä»Šæ—¥)</span>' : '';
            return `<div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed var(--border-weak);">
              <div style="color: var(--text-2);">${lab}${todayMark}</div>
              <div style="font-weight:600;">${sc} åˆ†</div>
            </div>`;
          }).join('');
          const avg = scores.length ? (scores.reduce((a,b)=>a+Number(b||0),0)/scores.length) : 0;
          const header = `<div style="margin-bottom:10px; color: var(--text-3);">æœ€è¿‘5ä¸ªå·¥ä½œæ—¥ï¼ˆ0åˆ†å¡«å……${isWorkday(getActiveLeaderboardDate()) ? 'ï¼Œå«ä»Šæ—¥å®æ—¶åˆ†' : ''}ï¼‰</div>`;
          const content = `${header}${rows}<div style="margin-top:10px; text-align:right; color: var(--text-2);">5æ—¥å¹³å‡ï¼š<b>${avg.toFixed(1)} åˆ†</b></div>`;
          createScoreDetailModal(content, `${studentName} çš„5æ—¥åˆ†æ•°`);
        } catch (e) {
          console.warn('showWeeklyScores error:', e);
        }
      };
      dbg('å®¹å™¨æ ·å¼:', getComputedStyle(container).display, getComputedStyle(container).visibility);
      dbg('å®¹å™¨çˆ¶çº§ ranking çŠ¶æ€:', document.getElementById('rankingView'), document.getElementById('rankingView')?.hidden);

      // è‡ªåŠ¨åŒæ­¥å½“æ—¥æ’è¡Œæ¦œåˆ°æ•°æ®åº“ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ç•Œé¢ï¼‰
      if (items.length > 0 && !items[0].isWeekly) {
        syncTodayLeaderboard().catch(e => console.warn('å®Œæ•´æ’è¡Œæ¦œè‡ªåŠ¨åŒæ­¥å¤±è´¥:', e));
      }
    }

    // æ›´æ–°æ’è¡Œæ¦œæ ‡ç­¾é¡µçŠ¶æ€
    function updateRankingTabs() {
      const dailyTab = document.getElementById('dailyRankingTab');
      const weeklyTab = document.getElementById('weeklyRankingTab');
      
      if (dailyTab && weeklyTab) {
        dailyTab.classList.toggle('active', rankingMode === 'daily');
        weeklyTab.classList.toggle('active', rankingMode === 'weekly');
      }
    }

    // åˆ‡æ¢æ’è¡Œæ¦œæ¨¡å¼
    async function switchRankingMode(mode) {
      if (rankingMode === mode) return;
      const container = document.getElementById('rankingFullList');
      // è®°å½•å½“å‰å†…å®¹åˆ°ç¼“å­˜ï¼ˆè‹¥æœ‰å†…å®¹ä¸”ééª¨æ¶ï¼‰
      if (container && container.children.length > 0 && !container.querySelector('.ranking-item--skeleton')) {
        rankingModeHtmlCache[rankingMode] = { html: container.innerHTML, ts: Date.now() };
      }
      rankingMode = mode;
      dbg('åˆ‡æ¢æ’è¡Œæ¦œæ¨¡å¼è‡³:', mode);

      // å¦‚æœç›®æ ‡æ¨¡å¼å·²ç»æœ‰ç¼“å­˜ï¼Œç›´æ¥æ— é—ªçƒåˆ‡æ¢å¹¶å¼‚æ­¥åå°åˆ·æ–°
      const cached = rankingModeHtmlCache[mode];
      if (cached && cached.html) {
        container.innerHTML = cached.html;
        container.classList.add(RANKING_FADE_CLASS);
        setTimeout(()=>container.classList.remove(RANKING_FADE_CLASS), 320);
        // åå°åˆ·æ–°ï¼ˆä¸æ˜¾ç¤ºéª¨æ¶ï¼‰
        renderRankingFull({ silent: true, skipSkeleton: true, modeForce: mode }).catch(()=>{});
        return;
      }
      // æ²¡ç¼“å­˜ï¼šæ¸…ç©ºæ—§å†…å®¹ï¼Œæ˜¾ç¤ºéª¨æ¶å±å¹¶åŠ è½½
      if (container) {
        container.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹ï¼Œç¡®ä¿éª¨æ¶å±èƒ½å¤Ÿæ˜¾ç¤º
      }
      await renderRankingFull({ modeForce: mode, silent: false });
      if (container) {
        container.classList.add(RANKING_FADE_CLASS);
        setTimeout(()=>container.classList.remove(RANKING_FADE_CLASS), 320);
      }
    }

  // è·å–æ’è¡Œæ¦œæ ‡é¢˜ä¿¡æ¯
    function getRankingTitleInfo() {
      if (rankingMode === 'weekly') {
    // ä½¿ç”¨æ´»è·ƒæ’è¡Œæ¦œæ—¥æœŸå£å¾„
    const refDate = getActiveLeaderboardDate();
    const endWorkday = nearestWorkdayOnOrBefore(refDate);
    const workdayDates = getLastNWorkdayDates(endWorkday, 5);
    const startDate = workdayDates[0];
    const endDate = workdayDates[workdayDates.length - 1];
        
        const formatDate = (date) => {
          return `${date.getMonth() + 1}/${date.getDate()}`;
        };
        
        return {
          title: 'å‘¨æ¦œæ’è¡Œ',
          subtitle: `${formatDate(startDate)} - ${formatDate(endDate)}`
        };
      } else {
        const activeDate = getActiveLeaderboardDate();
        const formatDate = (date) => {
          return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        };
        
        return {
          title: 'æ—¥æ¦œæ’è¡Œ',
          subtitle: formatDate(activeDate)
        };
      }
    }

    function openStudentDetailFromRankingFull(studentName) {
      // é˜²å¾¡ï¼šè‹¥å­¦ç”Ÿå·²è¢«åˆ é™¤æˆ–ç™½åå•æ— æ­¤äººï¼Œå¿½ç•¥ç‚¹å‡»
      if (!appState.studentsMeta?.has?.(studentName)) {
        console.warn('openStudentDetailFromRankingFull: stale/invalid student', studentName);
        return;
      }
      
      console.log('ä»å®Œæ•´æ’è¡Œæ¦œè¿›å…¥å­¦ç”Ÿè¯¦æƒ…:', studentName);
      console.log('å½“å‰ uiState.rankingOrigin:', uiState.rankingOrigin);
      
      uiState.previousView = 'ranking'; // è¯¦æƒ…è¿”å›ä¼˜å…ˆå›åˆ°æ’è¡Œæ¦œ
      uiState.view = 'detail';
      uiState.selectedStudent = studentName;
      // ä¿æŒ rankingOrigin ä¸å˜ï¼Œä»¥å¤‡å¼‚å¸¸æƒ…å†µä½¿ç”¨
      
      console.log('æ›´æ–°åçš„ uiState:', uiState);
      updateViews();
    }

    // æ˜¾ç¤ºå­¦ç”Ÿè¯„åˆ†è¯¦æƒ…
  async function showScoreDetail(studentName) {
      const activeDate = getActiveLeaderboardDate();
  const slotsMin = getLeaderboardSlotsMinutes(studentName, activeDate);
  const intervalsMs = getLeaderboardPracticeIntervalsMs(studentName, activeDate);
      const dayStartMs = toDayStart(activeDate);
      const weekday0to6 = activeDate.getDay();
      
      // è‹¥å½“æ—¥æ— ä»»ä½•ç»ƒç´åŒºé—´ï¼šä¸è®¡åˆ†ï¼ˆå„ç»´åº¦ç½®0ã€æ€»åˆ†æ˜¾ç¤ºä¸ºâ€œ-â€ï¼‰ï¼Œé¿å…å‡ºç°æ®‹ç•™çš„å†å²åŠ åˆ†
      const noPracticeToday = !intervalsMs || intervalsMs.length === 0;
  let d1, d2, d3res, totalScore, totalScoreDisplay;
      if (noPracticeToday) {
        d1 = { score: 0, breakdown: { noPractice: true } };
        d2 = { score: 0, breakdown: { noPractice: true } };
        d3res = { score: 0, breakdown: { noPractice: true } };
        totalScore = 0;
        totalScoreDisplay = '-';
      } else {
        // è®¡ç®—ä¸‰ä¸ªç»´åº¦çš„è¯¦ç»†åˆ†æ•°ï¼ˆD3 æ”¹ä¸ºäº‘ç«¯å†å²æ•°æ®å£å¾„ï¼‰
        d1 = computeDim1Score(slotsMin, intervalsMs, dayStartMs);
        d2 = computeDim2Score(slotsMin, intervalsMs, dayStartMs, weekday0to6);
        d3res = await computeDim3ScoreCloud(
          utils.normalizeStudentName(studentName),
          activeDate,
          d1.score + d2.score
        );
        let totalRaw = d1.score + d2.score + d3res.score;
        if (d1.breakdown && d1.breakdown.gotFullBonus) {
          totalRaw += (d1.breakdown.fullBonusAward || 0);
        }
        
        // ç®¡ç†å‘˜è°ƒåˆ†
        const adminAdjustment = getAdminScoreAdjustment(studentName);
        if (adminAdjustment !== 0) {
          totalRaw += adminAdjustment;
        }
        
        totalScore = totalRaw;
        totalScoreDisplay = totalRaw.toFixed(1);
      }
      
      // åˆ›å»ºè¿›åº¦æ¡
      function createProgressBar(score, maxScore, className) {
        const percentage = Math.min((score / maxScore) * 100, 100);
        return `
          <div class="score-bar">
            <div class="score-fill ${className}" style="width: ${percentage}%"></div>
          </div>
        `;
      }
      
      // çŠ¶æ€è¯„ä¼°
      const getD1Status = () => {
        if (d1.score >= 35) return { text: 'å‡ºå‹¤ä¼˜ç§€', color: '#2e7d32' };
        if (d1.score >= 25) return { text: 'åŸºæœ¬è¾¾æ ‡', color: '#ef6c00' };
        return { text: 'éœ€è¦æ”¹è¿›', color: '#d32f2f' };
      };
      
      const getD2Status = () => {
        if (d2.score >= 35) return { text: 'è´¨é‡ä¼˜ç§€', color: '#2e7d32' };
        if (d2.score >= 25) return { text: 'è´¨é‡è‰¯å¥½', color: '#ef6c00' };
        return { text: 'éœ€ä¼˜åŒ–', color: '#d32f2f' };
      };
      
      const getD3Status = () => {
        if (d3res.score >= 15) return { text: 'æˆé•¿ä¼˜ç§€', color: '#2e7d32' };
        if (d3res.score >= 10) return { text: 'ç¨³æ­¥æˆé•¿', color: '#ef6c00' };
        return { text: 'å¾…æ¿€æ´»', color: '#888' };
      };
      
      const d1Status = getD1Status();
      const d2Status = getD2Status();
      const d3Status = getD3Status();

      // å°å·¥å…·ï¼šåˆ†é’Ÿè½¬ 08:30 æ ¼å¼
      const mmToHHMM = (m) => `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
      const fmt = (n, d=1) => (Number.isFinite(n) ? (+n).toFixed(d) : '-');

      // D1 æ˜ç»†åˆ—è¡¨
      const d1List = (d1.breakdown?.slots || [])
        .slice()  // å¤åˆ¶æ•°ç»„é¿å…ä¿®æ”¹åŸæ•°æ®
        .sort((a, b) => a.start - b.start)  // æŒ‰å¼€å§‹æ—¶é—´å‡åºæ’åˆ—
        .map(s => {
        const time = `${mmToHHMM(s.start)}-${mmToHHMM(s.end)}`;
        const parts = [];
        const isOngoing = s.status === 'è¿›è¡Œä¸­';
        const isAbsent = s.status === 'ç¼ºå‹¤ä¸­';
        const isNotStarted = s.status === 'æœªå¼€å§‹';
        
        if (isOngoing) {
          // è¿›è¡Œä¸­ï¼šå±•ç¤ºå®æ—¶è¿›åº¦ä¸è¿Ÿåˆ°ï¼Œä¸å±•ç¤ºæœªå®Œæˆ/ç¼ºå¸­æ‰£åˆ†ï¼ˆæ‰£åˆ†åªåœ¨æ®µç»“æŸåç¡®å®šï¼‰
          const evalDur = s.durMin || 0; // è¯„ä¼°çª—å£é•¿åº¦ï¼ˆfirstStart->å½“å‰ï¼‰
            const practiced = Math.min(evalDur, s.overlapMin || 0);
          const coveragePct = fmt(s.coverage,1);
          let line = `${time} Â· è¿›è¡Œä¸­ï¼ˆè¦†ç›–${coveragePct}% / å·²ç»ƒ${fmt(practiced,1)}åˆ†`;
          if (s.lateMin > 0) line += ` / è¿Ÿåˆ°${s.lateMin}åˆ†`;
          line += 'ï¼‰';
          parts.push(line);
        } else if (isAbsent) {
          // ç¼ºå‹¤ä¸­ï¼šæ—¶é—´æ®µå·²å¼€å§‹ä½†æœªç™»è®°
          parts.push(`${time} Â· <span style="color: var(--warning);">ç¼ºå‹¤ä¸­ï¼ˆæœªç™»è®°ç»ƒç´ï¼‰</span>`);
        } else if (isNotStarted) {
          // æœªå¼€å§‹ï¼šæ—¶é—´æ®µå°šæœªå¼€å§‹
          parts.push(`${time} Â· æœªå¼€å§‹`);
        } else {
          // å·²ç»“æŸçš„æ—¶é—´æ®µï¼šæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
          parts.push(`${time} Â· ${s.status}ï¼ˆè¦†ç›–${fmt(s.coverage,1)}%ï¼‰`);
          if (s.missMin > 0 && s.incompletePenalty > 0) parts.push(`æœªå®Œæˆ${fmt(s.missMin,1)}åˆ†é’Ÿ â†’ æ‰£${fmt(s.incompletePenalty,2)}åˆ†`);
          if (s.absentPenalty > 0) parts.push(`ç¼ºå¸­ â†’ æ‰£${fmt(s.absentPenalty,2)}åˆ†`);
          if (s.lateMin > 0 || s.latePenalty > 0) parts.push(`è¿Ÿåˆ°${s.lateMin}åˆ† â†’ æ‰£${fmt(s.latePenalty,2)}åˆ†`);
        }
        return `<li>${parts.join('ï¼›')}</li>`;
      }).join('');

      const d1Summary = (() => {
        const b = d1.breakdown || {};
        const items = [];
        if (b.incompletePenalty > 0) items.push(`æœªå®Œæˆæ‰£åˆ†ï¼š${fmt(b.incompletePenalty,2)}`);
        if (b.absent > 0) items.push(`ç¼ºå¸­${b.absent}æ®µï¼Œå…±æ‰£ï¼š${fmt(b.absentPenalty,2)}`);
        if (b.latePenalty > 0) items.push(`è¿Ÿåˆ°åˆè®¡æ‰£åˆ†ï¼š${fmt(b.latePenalty,2)}`);
  if (b.gotFullBonus) items.push(`æ»¡å‹¤åŠ æˆå°†åœ¨æ€»åˆ†ç”Ÿæ•ˆï¼š+${fmt(b.fullBonusAward||0,1)}`);
        if (items.length === 0) items.push('æ— æ‰£åˆ†é¡¹');
        return items.join(' / ');
      })();

      // D2 æ˜ç»†åˆ—è¡¨
      const d2List = (d2.breakdown?.intervals || []).map(iv => {
        const time = `${mmToHHMM(iv.startMin)}-${mmToHHMM(iv.endMin)}ï¼ˆ${iv.lengthMin}åˆ†ï¼‰`;
        const parts = [time];
        if (iv.longPenalty > 0) parts.push(`è¶…é•¿${Math.max(0, iv.longOverMin)}åˆ† â†’ æ‰£${fmt(iv.longPenalty,2)}`);
        if (iv.shortPenalty > 0) parts.push(`çŸ­æ—¶å·®${iv.shortDeficitMin}åˆ† â†’ æ‰£${fmt(iv.shortPenalty,2)}`);
        if (iv.appliedTail && iv.tailPenalty > 0) parts.push(`æ‹–å°¾${iv.tailMin}åˆ† â†’ æ‰£${fmt(iv.tailPenalty,2)}`);
        if (!iv.appliedTail && iv.lowPenalty > 0) parts.push(`ä½æ•ˆæ—¶æ®µè¶…é™${iv.lowOverlapMin}åˆ† â†’ æ‰£${fmt(iv.lowPenalty,2)}`);
        const details = parts.length > 1 ? parts.slice(1).join('ï¼›') : 'æ— æ‰£åˆ†é¡¹';
        return `<li>${parts[0]}ï¼š${details}</li>`;
      }).join('');

      const d2Summary = (() => {
        const b = d2.breakdown || {};
        const items = [];
        if (b.longPenalty > 0) items.push(`è¶…é•¿ï¼š${fmt(b.longPenalty,2)}`);
        if (b.shortPenalty > 0) items.push(`çŸ­æ—¶ï¼š${fmt(b.shortPenalty,2)}`);
        if (b.tailPenalty > 0) items.push(`æ‹–å°¾ï¼š${fmt(b.tailPenalty,2)}`);
        if (b.windowPenalty > 0) items.push(`ä½æ•ˆï¼š${fmt(b.windowPenalty,2)}`);
        if (items.length === 0) items.push('æ— æ‰£åˆ†é¡¹');
        return items.join(' / ');
      })();

      // D3 æ˜ç»†
      const d3b = d3res.breakdown || {};
  // NOTE: ä¹‹å‰ rankPoints/progressPoints ç”¨ fmt(...,0) å¯¼è‡´ 1.5 â†’ 2 è¿›ä½ï¼Œ
  // ä¸æ€»åˆ†ï¼ˆä¿ç•™å†…éƒ¨ 0.5 ç²’åº¦ï¼‰ä¸ä¸€è‡´ï¼Œå‡ºç°åˆè®¡å¤š 0.5 çš„é”™è§‰ï¼›æ”¹ä¸ºä¸€ä½å°æ•°ä¿æŒå¯åŠ æ€§ã€‚
  const d3List = `
    <li class="d3-item">
      <div class="d3-main">
        <span class="d3-title">æ˜¨æ—¥æ’åï¼š</span>
        <span class="d3-result">${d3b.yesterdayRank ? `ç¬¬${d3b.yesterdayRank}å` : 'æ— '} â†’ +${fmt(d3b.rankPoints,1)}åˆ†</span>
      </div>
      <div class="d3-details">
        <div class="d3-explanation">
          <span class="detail-label">è®¡åˆ†è§„åˆ™ï¼š</span>
          <span class="detail-content-inline">æ ¹æ®æ˜¨æ—¥æ’è¡Œæ¦œä½ç½®è·å¾—åŸºç¡€åˆ†ï¼Œæ’åè¶Šé å‰ï¼ŒåŸºç¡€åˆ†è¶Šé«˜</span>
        </div>
      </div>
    </li>
    
    <li class="d3-item">
      <div class="d3-main">
        <span class="d3-title">å‘¨è¿›æ­¥ï¼š</span>
        <span class="d3-result">${(()=>{const pd=d3b.progressDetail; if(!pd) return 'â€” â†’ +0.0åˆ†'; const r=pd.rawRatioAvg; const cls=(r==null)?'delta-zero':(r>0?'delta-pos':(r<0?'delta-neg':'delta-zero')); const capped=(pd.appliedRatio!=null && Math.abs((pd.appliedRatio - pd.ratio)||0)>=0.1); return `æœ‰æ•ˆå‡ ${fmt(pd.avgPrev,2)} â†’ ${fmt(pd.avgCur,2)}ï¼ˆ<span class=\"delta ${cls}\">${r??'-'}%</span>${capped?`ï¼Œè®¡åˆ†${fmt(pd.appliedRatio,1)}%`:''}${pd.gatedByActiveDays?`ï¼›æ•°æ®ä¸è¶³ï¼ˆè¿‘${pd.curActiveDays||0}/${pd.prevActiveDays||0} æœ‰æ•ˆå¤©ï¼Œéœ€â‰¥${pd.minActiveDaysRequired||0}ï¼‰`:''}`; })()}) â†’ +${fmt(d3b.progressPoints,1)}åˆ†</span>
      </div>
      <div class="d3-details">
        <div class="d3-explanation">
          <span class="detail-label">è®¡åˆ†è§„åˆ™ï¼š</span>
          <span class="detail-content-inline">æ¯”è¾ƒè¿‘5å¤©ä¸å‰5å¤©çš„æœ‰æ•ˆå¹³å‡åˆ†ï¼ˆä»…åŸºäº D1+D2ï¼Œä¸å« D3ï¼‰ï¼Œè¿›æ­¥â‰¥2%è·å¾—è¿›æ­¥åˆ†ï¼Œæœ€é«˜8åˆ†æŒ‰è¿›æ­¥å¹…åº¦é€’å¢</span>
        </div>
        ${Array.isArray(d3b.progressDetail?.curDays) && Array.isArray(d3b.progressDetail?.prevDays)
          ? (()=>{ const pd=d3b.progressDetail; const W=pd.curDays.length||5; const maxVal=Math.max(10,...pd.curDays,...pd.prevDays); const scale=v=> (maxVal? ( (1 - v/maxVal)*34 ).toFixed(2):34); const step=140/Math.max(1,W-1); const buildPath=(arr)=> arr.map((v,i)=> `${i===0?'M':'L'}${(i*step).toFixed(2)},${scale(v)}`).join(' '); const curP=buildPath(pd.curDays); const prevP=buildPath(pd.prevDays); return `
        <div class="d3-chart">
          <div class="chart-title">è¶‹åŠ¿å¯¹æ¯”å›¾</div>
          <svg class=\"sparkline\" viewBox=\"0 0 140 34\" preserveAspectRatio=\"none\">
            <path class=\"spark-prev\" d=\"${prevP}\" />
            <path class=\"spark-cur\" d=\"${curP}\" />
          </svg>
          <div class="chart-data">
            <div>è¿‘5å¤©ï¼š${pd.curDays.map(v=>fmt(v,1)).join(', ')} | åˆ ${fmt(pd.cur7Total,1)} (æœ‰æ•ˆå‡ ${fmt(pd.avgCur,2)})</div>
            <div>å‰5å¤©ï¼š${pd.prevDays.map(v=>fmt(v,1)).join(', ')} | åˆ ${fmt(pd.prev7Total,1)} (æœ‰æ•ˆå‡ ${fmt(pd.avgPrev,2)})</div>
          </div>
        </div>`; })()
          : ''}
      </div>
    </li>
    
    <li class="d3-item">
      <div class="d3-main">
        <span class="d3-title">ç¨³å®šæ€§ï¼š</span>
        <span class="d3-result">æ ‡å‡†å·® ${fmt(d3b.consistencyStd,2)} â†’ +${fmt(d3b.consistencyPoints,1)}åˆ†</span>
        ${(d3b.consistencyActiveDays !== undefined && d3b.consistencyMinRecords !== undefined && d3b.consistencyActiveDays < d3b.consistencyMinRecords) ? 
          `<span class="d3-warning">ï¼ˆæœ‰æ•ˆè®°å½•${d3b.consistencyActiveDays}ä¸ªï¼Œéœ€â‰¥${d3b.consistencyMinRecords}ä¸ªï¼‰</span>` : ''}
      </div>
      <div class="d3-details">
        <div class="d3-explanation">
          <span class="detail-label">è®¡ç®—å…¬å¼ï¼š</span>
          <span class="detail-content-inline">æ ‡å‡†å·® = âˆš(Î£(xi - Î¼)Â² / n)ï¼Œå¾—åˆ† = 8 Ã— max(0, 1 - æ ‡å‡†å·®/15)<br/>è¯´æ˜ï¼šç¨³å®šæ€§åŸºäº D1+D2ï¼ˆä¸å« D3ï¼‰é€æ—¥å¾—åˆ†çš„æ³¢åŠ¨</span>
        </div>
        ${(d3b.consistencyActiveDays > 0) ? `
        <div class="d3-calculation">
          <span class="detail-label">å½“å‰è®¡ç®—ï¼š</span>
          <div class="calc-details">
            <div>â€¢ æœ‰æ•ˆç»ƒç´å¤©æ•°ï¼š${d3b.consistencyActiveDays}å¤©</div>
            <div>â€¢ æ ‡å‡†å·®ï¼š${fmt(d3b.consistencyStd,2)}</div>
            <div>â€¢ å¾—åˆ†è®¡ç®—ï¼š8 Ã— max(0, 1 - ${fmt(d3b.consistencyStd,2)}/15) = ${fmt(d3b.consistencyPoints,1)}åˆ†</div>
          </div>
        </div>` : ''}
      </div>
    </li>
    
    ${(d3b.antiBonusPoints || d3b.freshnessMultiplier) ? `
    <li class="d3-item">
      <div class="d3-main">
        <span class="d3-title">å…¬å¹³æœºåˆ¶ï¼š</span>
        <span class="d3-result">
          ${d3b.antiBonusPoints ? `å…¬å¹³æ€§å¥–åŠ± +${fmt(d3b.antiBonusPoints,1)}åˆ†` : ''}
          ${d3b.antiBonusPoints && d3b.freshnessMultiplier ? ' Â· ' : ''}
          ${d3b.freshnessMultiplier ? `åéœ¸æ¦œä¹˜æ•° Ã—${fmt(d3b.freshnessMultiplier,2)}${d3b.antiNote?`ï¼ˆ${d3b.antiNote}ï¼‰`:''}` : ''}
        </span>
      </div>
      <div class="d3-details">
        <div class="d3-explanation">
          <span class="detail-label">è®¡åˆ†è§„åˆ™ï¼š</span>
          <span class="detail-content-inline">é¼“åŠ±æ’è¡Œæ¦œå¤šæ ·æ€§ï¼Œé˜²æ­¢é•¿æœŸéœ¸æ¦œï¼›å…¬å¹³æ€§å¥–åŠ±æä¾›é¢å¤–å¾—åˆ†ï¼Œåéœ¸æ¦œä¹˜æ•°ä¼šåœ¨è¿ç»­éœ¸æ¦œæ—¶é™ä½å¾—åˆ†</span>
        </div>
      </div>
    </li>` : ''}
  `;

      const totalBonusLine = (d1.breakdown && d1.breakdown.gotFullBonus)
        ? `<div class="score-sub bonus-line" style="color:#22c55e;border-left:2px solid #22c55e;padding-left:8px;margin-top:6px;font-weight:500;">
             <span style="display:inline-block;min-width:72px;">æ»¡å‹¤åŠ æˆï¼š</span><span>+${fmt(d1.breakdown.fullBonusAward||0,1)}åˆ†</span>
           </div>`
        : '';
      
      // ç®¡ç†å‘˜è°ƒæ•´ä¿¡æ¯
      const adminAdjustment = getAdminScoreAdjustment(studentName);
      const adminAdjustmentDetails = getAdminScoreAdjustmentDetails(studentName);
      const adminAdjustmentLine = adminAdjustment !== 0 
        ? `<div class="score-sub admin-line" style="color:#cbd5e1;border-left:2px solid #cbd5e1;padding-left:8px;margin-top:6px;font-weight:500;">
             <span style="display:inline-block;min-width:72px;">ç®¡ç†å‘˜è°ƒæ•´ï¼š</span><span>${adminAdjustment > 0 ? '+' : ''}${adminAdjustment.toFixed(2)}åˆ†</span>
             ${adminAdjustmentDetails && adminAdjustmentDetails.reason ? `<br><span style="font-size:11px;opacity:.7;">è¯´æ˜ï¼š${adminAdjustmentDetails.reason}</span>` : ''}
           </div>`
        : '';
      
      const content = `
        <div class="lb-section">
          <div class="lb-card lb-card--gradient" style="background:linear-gradient(135deg,#667eea,#764ba2);border:none;">
            <div class="lb-kv"><strong>${studentName}</strong><span>442 ç»¼åˆè¯„åˆ†è¯¦æƒ…</span></div>
            <div style="margin-top:8px;font-size:30px;font-weight:800;">${totalScoreDisplay}</div>
            <div style="opacity:.9;font-size:11px;">æ€»åˆ† / 100</div>
            ${totalBonusLine}
            ${adminAdjustmentLine}
          </div>
          <div style="margin-top:6px;color:#64748b;font-size:12px;">æç¤ºï¼šå½“æ—¥æ— ç»ƒç´åˆ™ä¸è®¡åˆ†ã€‚</div>
        </div>

        <div class="lb-section">
          <div class="lb-card lb-card--d1">
            <div class="lb-kv"><h4 style="margin:0;">ğŸ“… ç»´åº¦ä¸€ï¼šå‡ºå‹¤å®Œæˆåº¦ (40åˆ†)</h4><strong>${d1.score.toFixed(1)}åˆ†</strong></div>
            ${createProgressBar(d1.score, 40, 'd1')}
            <div class="lb-kv" style="margin-top:4px;"><span>${d1Status.text}</span><span style="color:#64748b;">æ¦‚è§ˆï¼š${d1Summary}</span></div>
            <details class="lb-details" style="margin-top:6px;">
              <summary>å±•å¼€æ˜ç»† <span style="margin-left:6px;font-size:11px;color:#334155;background:#e2e8f0;border-radius:10px;padding:2px 6px;white-space:nowrap;">å®æ—¶ç»Ÿè®¡ï¼Œæœªå¼€å§‹æ—¶æ®µä¸è®¡åˆ†</span></summary>
              <ul class="lb-list">${d1List || '<li>æ— æ—¶æ®µè®°å½•</li>'}</ul>
            </details>
          </div>
        </div>

        <div class="lb-section">
          <div class="lb-card lb-card--d2">
            <div class="lb-kv"><h4 style="margin:0;">âš¡ ç»´åº¦äºŒï¼šç»ƒç´è´¨é‡ (40åˆ†)</h4><strong>${d2.score.toFixed(1)}åˆ†</strong></div>
            ${createProgressBar(d2.score, 40, 'd2')}
            <div class="lb-kv" style="margin-top:4px;"><span>${d2Status.text}</span><span style="color:#64748b;">æ¦‚è§ˆï¼š${d2Summary}</span></div>
            <details class="lb-details" style="margin-top:6px;">
              <summary>å±•å¼€æ˜ç»†</summary>
              <ul class="lb-list">${d2List || '<li>æ— ç»ƒä¹ åŒºé—´</li>'}</ul>
              <div style="margin-top:8px;padding:8px;background:#f1f5f9;border-radius:6px;font-size:12px;color:#64748b;">
                ğŸ’¡ <strong>ä½æ•ˆæ—¶æ®µè¯´æ˜ï¼š</strong>ä¸­åˆï¼ˆ11:50-13:00ï¼‰ç»ƒç´è¶…è¿‡60åˆ†é’Ÿæ‰£åˆ†ï¼Œæ™šä¸Šï¼ˆå‘¨1/2/4/5: 18:00-19:00ï¼›å‘¨3: 18:30-19:30ï¼‰ç»ƒç´è¶…è¿‡50åˆ†é’Ÿæ‰£åˆ†ï¼Œé»˜è®¤10åˆ†é’Ÿåƒé¥­æ—¶é—´ã€‚
              </div>
            </details>
          </div>
        </div>

        <div class="lb-section">
          <div class="lb-card lb-card--d3">
            <div class="lb-kv"><h4 style="margin:0;">ğŸ† ç»´åº¦ä¸‰ï¼šå†å²è¡¨ç° (20åˆ†)</h4><strong>${d3res.score.toFixed(1)}åˆ†</strong></div>
            ${createProgressBar(d3res.score, 20, 'd3')}
            <div class="lb-kv" style="margin-top:4px;"><span>${d3Status.text}</span></div>
            <details class="lb-details" style="margin-top:6px;">
              <summary>å±•å¼€æ˜ç»†</summary>
              <ul class="lb-list">${d3List}</ul>
            </details>
          </div>
        </div>

        <div class="lb-section">
          <div class="lb-card">
            <h4>ğŸ’¡ è®¡ç®—å…¬å¼</h4>
            <p>æ€»åˆ† = D1Ã—40% + D2Ã—40% + D3Ã—20%${(d1.breakdown && d1.breakdown.gotFullBonus)?' + æ»¡å‹¤åŠ æˆ':''}${adminAdjustment !== 0 ? ' + ç®¡ç†å‘˜è°ƒæ•´' : ''} = ${d1.score.toFixed(1)} + ${d2.score.toFixed(1)} + ${d3res.score.toFixed(1)}${(d1.breakdown && d1.breakdown.gotFullBonus)?` + ${(d1.breakdown.fullBonusAward||0)}`:''}${adminAdjustment !== 0 ? ` ${adminAdjustment > 0 ? '+' : ''}${adminAdjustment.toFixed(2)}` : ''} = <strong>${totalScore.toFixed(1)}</strong></p>
          </div>
        </div>
      `;
      
      createScoreDetailModal(content, studentName);
    }
    
    // åˆ›å»ºè¯„åˆ†è¯¦æƒ…æ¨¡æ€æ¡†
    function createScoreDetailModal(content, title) {
      // ç§»é™¤ç°æœ‰æ¨¡æ€æ¡†
      const existing = document.querySelector('.score-detail-modal, .lb-modal');
      if (existing) {
        existing.remove();
      }
      
      const modal = document.createElement('div');
      modal.className = 'lb-modal';
      modal.innerHTML = `
        <div class="lb-dialog">
          <div class="lb-dialog__header">
            <div class="lb-dialog__title">${title || 'è¯¦æƒ…'}</div>
            <button class="lb-dialog__close" onclick="closeScoreDetailModal()" aria-label="å…³é—­">&times;</button>
          </div>
          <div class="lb-dialog__body">
            ${content}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // æ˜¾ç¤ºåŠ¨ç”»
      requestAnimationFrame(() => {
        modal.classList.add('show');
      });
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeScoreDetailModal();
        }
      });
      
      // ESCé”®å…³é—­
      const handleEsc = (e) => {
        if (e.key === 'Escape') {
          closeScoreDetailModal();
          document.removeEventListener('keydown', handleEsc);
        }
      };
      document.addEventListener('keydown', handleEsc);
    }
    
    // å…³é—­è¯„åˆ†è¯¦æƒ…æ¨¡æ€æ¡†
    function closeScoreDetailModal() {
  const modal = document.querySelector('.lb-modal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.remove();
        }, 200);
      }
    }

    // ===== æ’è¡Œè§„åˆ™è¯¦æƒ…ï¼ˆå¤åˆ»æ—§ç³»ç»Ÿæ ·å¼ä¸æ–‡æ¡ˆï¼‰ =====
    function showLeaderboardRuleDoc() {
      ensureLBExtraStyles();
      const content = `
        <div class="lb-section">
          <div class="lb-card lb-card--gradient" style="background:linear-gradient(135deg,#0ea5e9,#6366f1);border:none;">
            <h4 style="margin:0 0 4px;font-size:18px;">442 æµ‹è¯„ä½“ç³»</h4>
            <p style="opacity:.95;">ç»ƒç´è´¨é‡ç»¼åˆè¯„ä»·æ¨¡å‹ Â· ç»“æ„åŒ– Â· å¯è§£é‡Š Â· å¯æŒç»­æ¿€åŠ± Â· æƒé‡ 40:40:20</p>
          </div>
        </div>

        <div class="lb-section">
          <div class="lb-card" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;">
            <h3 style="margin:0 0 12px;font-size:20px;">ğŸ“Š æ’è¡Œæ¦œè¯„åˆ†è§„åˆ™è¯´æ˜</h3>
            <p style="margin:0;opacity:0.95;line-height:1.6;font-size:14px;">
              ç³»ç»Ÿæ ¹æ®ä¸‰ä¸ªç»´åº¦å¯¹æ¯ä½åŒå­¦çš„ç»ƒç´è¡¨ç°è¿›è¡Œç»¼åˆè¯„åˆ†ï¼Œæ»¡åˆ†100åˆ†ã€‚å¾—åˆ†è¶Šé«˜ï¼Œæ’åè¶Šé å‰ã€‚
            </p>
          </div>
        </div>

        <div class="lb-section">
          <div class="lb-section__title">ä¸€ã€è¯„åˆ†æ„æˆï¼ˆæ€»åˆ†100åˆ†ï¼‰<span>ä¸‰ä¸ªç»´åº¦ï¼Œå…¬å¹³å…¬æ­£</span></div>
          <div class="lb-card lb-rule-box-blue" style="padding:16px;">
            <div class="lb-rule-text" style="font-size:15px;font-weight:600;margin-bottom:8px;">ğŸ“ è®¡ç®—å…¬å¼</div>
            <div style="font-size:14px;color:#475569;line-height:1.8;">
              <strong>æ€»åˆ† = ç»´åº¦1ï¼ˆå‡ºå‹¤å®Œæˆï¼‰Ã— 40% + ç»´åº¦2ï¼ˆè´¨é‡æ•ˆç‡ï¼‰Ã— 40% + ç»´åº¦3ï¼ˆæˆé•¿åŠ æˆï¼‰Ã— 20%</strong>
              <div style="margin-top:8px;font-size:13px;opacity:0.85;">
                ï¿½ å‡ºå‹¤å’Œè´¨é‡å„å 40%ï¼Œä½“ç°"åˆ°äº†+ç»ƒå¥½"åŒç­‰é‡è¦ï¼›æˆé•¿å 20%ï¼Œé¼“åŠ±æŒç»­è¿›æ­¥
              </div>
            </div>
          </div>
        </div>

        <div class="lb-section">
          <div class="lb-section__title">äºŒã€ç»´åº¦1ï¼šå‡ºå‹¤å®Œæˆï¼ˆ40åˆ†ï¼‰<span>ä½ æ˜¯å¦æŒ‰æ—¶åˆ°ç´æˆ¿ï¼Ÿ</span></div>
          <div class="lb-card">
            <h4 style="color:#2563eb;margin-bottom:12px;">ğŸ“… è¿™ä¸ªç»´åº¦çœ‹ä»€ä¹ˆï¼Ÿ</h4>
            <p style="line-height:1.8;color:#475569;margin-bottom:16px;">
              ä¸»è¦çœ‹ä½ åœ¨è§„å®šçš„ç»ƒç´æ—¶æ®µå†…ï¼Œæ˜¯å¦å‡†æ—¶åˆ°è¾¾ã€ç»ƒä¹ æ—¶é—´æ˜¯å¦å……è¶³ã€‚ç®€å•è¯´ï¼š<strong>è¯¥ç»ƒçš„æ—¶å€™æœ‰æ²¡æœ‰åˆ°ï¼Ÿåˆ°äº†ç»ƒå¤Ÿäº†å—ï¼Ÿ</strong>
            </p>
            
            <h4 style="color:#2563eb;margin-bottom:12px;">âœ… æ€ä¹ˆå¾—åˆ†ï¼Ÿ</h4>
            <ul class="lb-list" style="line-height:1.8;">
              <li><strong>å‡†æ—¶åˆ°è¾¾ï¼š</strong>æ—¶æ®µå¼€å§‹å10åˆ†é’Ÿå†…åˆ°éƒ½ç®—å‡†æ—¶ï¼ˆ10åˆ†é’Ÿå®½é™æœŸï¼‰ï¼Œä¸æ‰£åˆ†</li>
              <li><strong>å……è¶³ç»ƒä¹ ï¼š</strong>åœ¨æ—¶æ®µå†…ç»ƒç´çš„æ—¶é—´è¶Šé•¿ï¼Œåˆ†æ•°è¶Šé«˜ï¼ˆæŒ‰è¦†ç›–ç‡è®¡ç®—ï¼‰</li>
              <li><strong>æ»¡å‹¤å¥–åŠ±ï¼š</strong>å½“å¤©æ‰€æœ‰æ—¶æ®µéƒ½å®Œæˆä¸”ä¸è¿Ÿåˆ°ä¸ç¼ºå¸­ï¼Œå¯è·å¾—é¢å¤–åŠ åˆ†
                <ul style="margin-top:6px;padding-left:20px;font-size:13px;opacity:0.9;">
                  <li>1ä¸ªæ—¶æ®µå…¨å‹¤ï¼š+0.5åˆ†</li>
                  <li>2ä¸ªæ—¶æ®µå…¨å‹¤ï¼š+1åˆ†</li>
                  <li>3ä¸ªåŠä»¥ä¸Šæ—¶æ®µå…¨å‹¤ï¼š+1.5åˆ†ï¼ˆå°é¡¶ï¼‰</li>
                </ul>
              </li>
            </ul>
            
            <h4 style="color:#dc2626;margin-bottom:12px;">âŒ ä»€ä¹ˆæƒ…å†µä¼šæ‰£åˆ†ï¼Ÿ</h4>
            <ul class="lb-list" style="line-height:1.8;">
              <li><strong>è¿Ÿåˆ°ï¼š</strong>è¶…è¿‡å¼€å§‹æ—¶é—´10åˆ†é’Ÿæ‰åˆ°ï¼Œæ¯å¤šè¿Ÿåˆ°1åˆ†é’Ÿæ‰£0.4åˆ†</li>
              <li><strong>æ—©é€€/æ—¶é—´ä¸å¤Ÿï¼š</strong>æ—¶æ®µå†…ç»ƒä¹ æ—¶é—´ä¸è¶³ï¼ŒæŒ‰æ¯”ä¾‹æ‰£åˆ†</li>
              <li><strong>ç¼ºå¸­ï¼š</strong>æ—¶æ®µå†…å®Œå…¨æ²¡æœ‰ç»ƒç´è®°å½•ï¼Œè¯¥æ—¶æ®µå¾—0åˆ†</li>
            </ul>
            
            <div style="background:#fef3c7;border-left:3px solid #f59e0b;padding:12px;margin-top:16px;border-radius:4px;">
              <strong style="color:#b45309;">ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</strong>
              <div style="color:#92400e;font-size:13px;margin-top:6px;line-height:1.6;">
                å¦‚æœä½ çš„æ—¶é—´æ®µä¿¡æ¯æœ‰è¯¯ï¼Œè¯·åŠæ—¶ä¸å‰å°è€å¸ˆè”ç³»ä¿®æ”¹ã€‚å¦‚æœå½“å¤©æœ‰ä¸´æ—¶è°ƒæ•´ï¼Œåœ¨æ™šä¸Š21:30ä¹‹å‰éƒ½å¯ä»¥ä¸å‰å°è€å¸ˆæ²Ÿé€šåšä¸´æ—¶ä¿®æ”¹ï¼Œå¦åˆ™ä¼šå½±å“æ’è¡Œæ¦œåˆ†æ•°ï¼
              </div>
            </div>
          </div>
        </div>

        <div class="lb-section">
          <div class="lb-section__title">ä¸‰ã€ç»´åº¦2ï¼šè´¨é‡æ•ˆç‡ï¼ˆ40åˆ†ï¼‰<span>ä½ ç»ƒå¾—æ€ä¹ˆæ ·ï¼Ÿ</span></div>
          <div class="lb-card">
            <h4 style="color:#7c3aed;margin-bottom:12px;">âš¡ è¿™ä¸ªç»´åº¦çœ‹ä»€ä¹ˆï¼Ÿ</h4>
            <p style="line-height:1.8;color:#475569;margin-bottom:16px;">
              ä¸ä»…è¦ç»ƒï¼Œè¿˜è¦ç»ƒå¾—å¥½ï¼è¿™ä¸ªç»´åº¦å…³æ³¨ä½ çš„ç»ƒç´è´¨é‡å’Œæ•ˆç‡ã€‚ç®€å•è¯´ï¼š<strong>ç»ƒç´æ—¶é•¿åˆç†å—ï¼Ÿæ•ˆç‡é«˜å—ï¼Ÿ</strong>
            </p>
            
            <h4 style="color:#7c3aed;margin-bottom:12px;">âœ… æœ€ä½³ç»ƒç´æ—¶é•¿</h4>
            <ul class="lb-list" style="line-height:1.8;">
              <li><strong>å•æ¬¡ç»ƒç´30-120åˆ†é’Ÿæœ€ä½³ï¼š</strong>è¿™ä¸ªæ—¶é•¿èƒ½ä¿æŒä¸“æ³¨ï¼Œæ•ˆç‡æœ€é«˜</li>
              <li>ä½äº30åˆ†é’Ÿæˆ–è¶…è¿‡120åˆ†é’Ÿéƒ½ä¼šæœ‰æ‰£åˆ†ï¼ˆç¬¦åˆç§‘å­¦è®­ç»ƒè§„å¾‹ï¼‰</li>
            </ul>
            
            <h4 style="color:#dc2626;margin-bottom:12px;">âŒ ä»€ä¹ˆæƒ…å†µä¼šæ‰£åˆ†ï¼Ÿ</h4>
            <ul class="lb-list" style="line-height:1.8;">
              <li><strong>æ—¶é—´å¤ªçŸ­ï¼š</strong>å•æ¬¡ç»ƒç´å°‘äº30åˆ†é’Ÿï¼Œæ•ˆç‡ä½ï¼Œä¼šæ‰£åˆ†ï¼ˆçŸ­æ—¶è±å…æ—¶æ®µé™¤å¤–ï¼Œè¯¦è§ä¸‹æ–¹ï¼‰</li>
              <li><strong>æ—¶é—´è¿‡é•¿ï¼š</strong>å•æ¬¡ç»ƒç´è¶…è¿‡120åˆ†é’Ÿï¼ˆ2å°æ—¶ï¼‰ï¼Œå®¹æ˜“ç–²åŠ³ï¼Œè´¨é‡ä¸‹é™ï¼Œä¼šæ‰£åˆ†</li>
              <li><strong>ä½æ•ˆæ—¶æ®µç»ƒç´ï¼š</strong>åœ¨ä¸­åˆã€æ™šä¸Šç­‰ä½æ•ˆæ—¶æ®µç»ƒç´æ—¶é—´è¿‡é•¿ï¼ˆè¯¦è§ä¸‹æ–¹è¯´æ˜ï¼‰ï¼Œä¼šæœ‰é¢å¤–æ‰£åˆ†</li>
              <li><strong>è¶…æ—¶æ‹–å°¾ï¼š</strong>è¶…è¿‡æ—¶æ®µç»“æŸæ—¶é—´25åˆ†é’Ÿåæ‰é€€å‡ºç´æˆ¿ï¼Œä¼šæ‰£åˆ†</li>
            </ul>
            
            <h4 style="color:#059669;margin-bottom:12px;">ğŸ›¡ï¸ äººæ€§åŒ–è±å…</h4>
            <ul class="lb-list" style="line-height:1.8;">
              <li><strong>æ‹–å°¾å®½é™ï¼š</strong>æ—¶æ®µç»“æŸå25åˆ†é’Ÿå†…é€€å‡ºä¸æ‰£åˆ†ï¼ˆæ–¹ä¾¿æ”¶æ‹¾ã€å¿˜è®°çœ‹æ—¶é—´ï¼‰</li>
              <li><strong>çŸ­æ—¶è±å…æ—¶æ®µï¼š</strong>å‘¨ä¸€/äºŒ/å››/äº” 12:30-13:00ã€18:30-19:00ï¼›å‘¨ä¸‰ 12:30-14:00ã€19:00-19:30ã€‚åœ¨è¿™äº›æ—¶æ®µç»ƒç´ä¸ä¼šæœ‰"æ—¶é—´å¤ªçŸ­"çš„æ‰£åˆ†ï¼Œå…è®¸å­¦ç”Ÿåœ¨ä¸‹åˆç¬¬ä¸€èŠ‚è¯¾ä¹‹å‰ã€æ™šä¸ŠéŸ³ä¹ä¼š/è¯¾ç¨‹/æ´»åŠ¨å‰ç´§æ€¥ç»ƒä¹ </li>
            </ul>
          </div>
        </div>

        <div class="lb-section">
          <div class="lb-section__title">å››ã€ç»´åº¦3ï¼šæˆé•¿åŠ æˆï¼ˆ20åˆ†ï¼‰<span>ä½ åœ¨è¿›æ­¥å—ï¼Ÿ</span></div>
          <div class="lb-card">
            <h4 style="color:#dc2626;margin-bottom:12px;">ğŸ† è¿™ä¸ªç»´åº¦çœ‹ä»€ä¹ˆï¼Ÿ</h4>
            <p style="line-height:1.8;color:#475569;margin-bottom:16px;">
              ä¸ä»…è¦ç»ƒå¥½å½“å¤©ï¼Œæ›´è¦æŒç»­è¿›æ­¥ï¼è¿™ä¸ªç»´åº¦é¼“åŠ±ä½ ç¨³å®šæå‡ã€çªç ´è‡ªæˆ‘ã€‚ç®€å•è¯´ï¼š<strong>ä½ æ¯”ä¹‹å‰æ›´åŠªåŠ›äº†å—ï¼Ÿè¡¨ç°æ›´ç¨³å®šäº†å—ï¼Ÿ</strong>
            </p>
            
            <h4 style="color:#dc2626;margin-bottom:12px;">âœ… åŠ åˆ†é¡¹ç›®</h4>
            <ul class="lb-list" style="line-height:1.8;">
              <li><strong>æ˜¨æ—¥æ’åï¼š</strong>æ ¹æ®ä½ æ˜¨å¤©çš„æ’åç»™åŸºç¡€åˆ†
                <ul style="margin-top:6px;padding-left:20px;font-size:13px;opacity:0.9;">
                  <li>ç¬¬1å = 3åˆ†ï¼Œç¬¬10å = 1åˆ†ï¼Œä¸­é—´çº¿æ€§è®¡ç®—</li>
                  <li>ğŸ’¡ æ˜¨å¤©è¡¨ç°å¥½ï¼Œä»Šå¤©æœ‰åŸºç¡€åˆ†åŠ æŒ</li>
                </ul>
              </li>
              <li><strong>å‘¨è¿›æ­¥ï¼š</strong>æœ€è¿‘5å¤©ç»ƒç´è¡¨ç°æ¯”ä¹‹å‰5å¤©å¥½ï¼ˆåŸºäº D1+D2ï¼Œä¸å« D3ï¼‰ï¼Œæœ€é«˜+8åˆ†
                <ul style="margin-top:6px;padding-left:20px;font-size:13px;opacity:0.9;">
                  <li>æ¯”å¦‚ï¼šä¹‹å‰5å¤©å¹³å‡50åˆ†ï¼Œæœ€è¿‘5å¤©å¹³å‡60åˆ†ï¼Œæå‡20% â†’ åŠ åˆ†</li>
                  <li>æå‡è¶Šå¤§ï¼ŒåŠ åˆ†è¶Šå¤šï¼ˆæå‡50%å°é¡¶ï¼‰</li>
                </ul>
              </li>
              <li><strong>ç¨³å®šæ€§ï¼š</strong>æ¯å¤©è¡¨ç°è¶Šç¨³å®šï¼ˆåˆ†æ•°æ³¢åŠ¨å°ï¼ŒåŸºäº D1+D2 ä¸å« D3ï¼‰ï¼Œæœ€é«˜+8åˆ†
                <ul style="margin-top:6px;padding-left:20px;font-size:13px;opacity:0.9;">
                  <li>ğŸ’¡ é¼“åŠ±æŒä¹‹ä»¥æ’ï¼Œé¿å…"ä¸‰å¤©æ‰“é±¼ä¸¤å¤©æ™’ç½‘"</li>
                  <li>ä¸å‘¨è¿›æ­¥åŒç­‰é‡è¦ï¼Œç¨³å®šæ€§å’Œè¿›æ­¥æ€§å„å ä¸€åŠ</li>
                </ul>
              </li>
              <li><strong>åéœ¸æ¦œæœºåˆ¶ï¼š</strong>é˜²æ­¢æ¦œé¦–å›ºåŒ–ï¼Œç»™å…¶ä»–åŒå­¦æœºä¼š
                <ul style="margin-top:6px;padding-left:20px;font-size:13px;opacity:0.9;">
                  <li>è¿ç»­ç™»é¡¶3å¤©ä»¥ä¸Šä¼šé€æ¸è¡°å‡åˆ†æ•°</li>
                  <li>è·ç¦»ä¸Šæ¬¡ç™»é¡¶â‰¥2å¤©çš„åŒå­¦ä¼šè·å¾—+1å…¬å¹³æ€§å¥–åŠ±</li>
                </ul>
              </li>
            </ul>
          </div>
        </div>

        <div class="lb-section">
          <div class="lb-section__title">äº”ã€ç‰¹æ®Šè¯´æ˜<span>é‡è¦ç»†èŠ‚</span></div>
          <div class="lb-grid lb-grid--2">
            <div class="lb-card">
              <h4>â° ä½æ•ˆæ—¶æ®µï¼ˆå·¥ä½œæ—¥ï¼‰</h4>
              <div style="font-size:13px;line-height:1.8;color:#475569;">
                <p style="margin-bottom:10px;"><strong>ä»¥ä¸‹æ—¶æ®µå±äºä½æ•ˆæ—¶æ®µï¼Œç»ƒç´ä¼šæœ‰é¢å¤–æ‰£åˆ†ï¼š</strong></p>
                <ul class="lb-list">
                  <li>å‘¨ä¸€/äºŒ/ä¸‰/å››/äº” ä¸­åˆï¼š11:50-13:00ï¼ˆé‡å è¶…è¿‡60åˆ†é’Ÿå¼€å§‹æ‰£åˆ†ï¼‰</li>
                  <li>å‘¨ä¸€/äºŒ/å››/äº” æ™šä¸Šï¼š18:00-19:00ï¼ˆé‡å è¶…è¿‡50åˆ†é’Ÿå¼€å§‹æ‰£åˆ†ï¼‰</li>
                  <li>å‘¨ä¸‰æ™šä¸Šï¼š18:30-19:30ï¼ˆé‡å è¶…è¿‡50åˆ†é’Ÿå¼€å§‹æ‰£åˆ†ï¼‰</li>
                </ul>
                <p style="margin-top:10px;opacity:0.85;">ğŸ’¡ åŸå› ï¼šè¿™äº›æ˜¯åˆé¤/æ™šé¥­æ—¶æ®µï¼Œè‡³å°‘æœ‰10åˆ†é’Ÿæ—¶é—´æ˜¯åœ¨åƒé¥­</p>
              </div>
            </div>
            <div class="lb-card">
              <h4>ï¿½ å‘¨æœ«è¯´æ˜</h4>
              <div style="font-size:13px;line-height:1.8;color:#475569;">
                <ul class="lb-list">
                  <li>å‘¨å…­ã€å‘¨æ—¥ä¸å±•ç¤ºæ—¥æ’è¡Œæ¦œ</li>
                  <li>å‘¨æœ«æ— ä½æ•ˆæ—¶æ®µæ‰£åˆ†</li>
                  <li>å‘¨æœ«çš„ç»ƒç´è®°å½•ä¸è®¡å…¥å†å²è¯„åˆ†</li>
                  <li>å½“æ—¥å®Œå…¨æ²¡æœ‰ç»ƒç´åˆ™ä¸è®¡åˆ†</li>
                </ul>
              </div>
            </div>
            <div class="lb-card">
              <h4>ğŸ¯ æ’åºè§„åˆ™</h4>
              <div style="font-size:13px;line-height:1.8;color:#475569;">
                <p>å½“æ€»åˆ†ç›¸åŒæ—¶ï¼Œä¾æ¬¡æ¯”è¾ƒï¼š</p>
                <ol class="lb-list" style="padding-left:20px;">
                  <li>ç»´åº¦1åˆ†æ•°ï¼ˆå‡ºå‹¤å®Œæˆï¼‰</li>
                  <li>ç»´åº¦2åˆ†æ•°ï¼ˆè´¨é‡æ•ˆç‡ï¼‰</li>
                  <li>ç»´åº¦3åˆ†æ•°ï¼ˆæˆé•¿åŠ æˆï¼‰</li>
                  <li>å§“åå­—æ¯é¡ºåº</li>
                </ol>
              </div>
            </div>
            <div class="lb-card">
              <h4>ğŸ’¡ æåˆ†å»ºè®®</h4>
              <div style="font-size:13px;line-height:1.8;color:#475569;">
                <ul class="lb-list">
                  <li><strong>å‡†æ—¶åˆ°è¾¾ï¼š</strong>æå‰5-10åˆ†é’Ÿè¿›ç´æˆ¿</li>
                  <li><strong>æ§åˆ¶æ—¶é•¿ï¼š</strong>æ¯æ¬¡ç»ƒç´30-120åˆ†é’Ÿã€æ»¡120åˆ†é’Ÿåˆ°å‰å°ç»­ç´æˆ¿ä¼‘æ¯ä¸€ä¼š</li>
                  <li><strong>é¿å¼€ä½æ•ˆæ—¶æ®µï¼š</strong>ä¸­åˆ11:50-13:00ã€æ™šä¸Š18:00-19:30ç»ƒç´æ—¶é—´ä¸è¦è¿‡é•¿ï¼ˆè¶…è¿‡å®½é™æ—¶é—´ä¼šæ‰£åˆ†ï¼‰</li>
                  <li><strong>å–„ç”¨è±å…æ—¶æ®µï¼š</strong>è¯¾å‰ã€æ´»åŠ¨å‰å¯åˆ©ç”¨çŸ­æ—¶è±å…æ—¶æ®µå¿«é€Ÿç»ƒä¹ ï¼ˆå‘¨ä¸€/äºŒ/å››/äº” 12:30-13:00ã€18:30-19:00ï¼›å‘¨ä¸‰ 12:30-14:00ã€19:00-19:30ï¼‰</li>
                  <li><strong>ä¿æŒç¨³å®šï¼š</strong>æ¯å¤©éƒ½ç»ƒï¼Œåˆ«ä¸‰å¤©æ‰“é±¼</li>
                  <li><strong>æŒç»­è¿›æ­¥ï¼š</strong>ä»Šå¤©æ¯”æ˜¨å¤©æ›´åŠªåŠ›</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      `;
      createScoreDetailModal(content, 'æ’è¡Œè§„åˆ™è¯¦æƒ…');
    }

    function ensureLBExtraStyles(){
      if(document.getElementById('lb-detail-extra-styles')) return;
      const style=document.createElement('style');
      style.id='lb-detail-extra-styles';
      style.textContent=`/* è¯„åˆ†è¯¦æƒ… & 442 è¯´æ˜æ‰©å±•æ ·å¼ */
      .lb442-doc .metric-card{background:#ffffff;border:1px solid var(--border-color,#e2e8f0);border-radius:12px;padding:14px 16px;box-shadow:0 2px 6px rgba(0,0,0,.06);transition:.25s;}
      .lb442-doc .metric-card:hover{box-shadow:0 6px 18px -4px rgba(0,0,0,.18);} 
      .lb442-doc .metric-card h4{margin:0 0 6px;font-size:15px;font-weight:600;display:flex;align-items:center;gap:6px;}
      .lb442-doc .metric-card ul{margin:6px 0 0;padding-left:18px;font-size:12px;line-height:1.6;}
      .lb442-doc .formula-box{background:#ffffff;color:#1e293b;border:1px solid #e2e8f0;padding:10px 12px;border-radius:10px;font-size:13px;font-weight:600;}
      .lb442-doc .lb442-section{position:relative;}
      .lb442-doc .lb442-head{margin:0 0 18px;padding:0;border:none;}
      .lb442-doc .lb-head-card{background:linear-gradient(135deg,#0d47a1,#1976d2 55%,#42a5f5);border:1px solid rgba(255,255,255,.25);border-radius:18px;padding:26px 24px 22px;position:relative;overflow:hidden;color:#fff;box-shadow:0 10px 28px -8px rgba(13,71,161,.55),0 4px 16px -4px rgba(0,0,0,.35);} 
      .lb442-doc .lb-head-card:before{content:"";position:absolute;width:420px;height:420px;top:-160px;right:-120px;background:radial-gradient(circle at center,rgba(255,255,255,.35),transparent 60%);filter:blur(8px);opacity:.55;}
      .lb442-doc .lb-head-card h2{margin:0;font-size:30px;font-weight:800;letter-spacing:.5px;line-height:1.15;background:linear-gradient(90deg,#fff,#e3f2fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;}
      .lb442-doc .lb-head-card .lb442-sub{margin:10px 0 14px;font-size:13px;line-height:1.55;max-width:600px;color:rgba(255,255,255,.9);} 
      .lb442-doc .lb-head-card .lb442-tagline{display:inline-flex;align-items:center;gap:6px;font-size:11px;font-weight:600;letter-spacing:1px;padding:6px 14px;border-radius:30px;background:rgba(255,255,255,.15);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.35);} 
      .lb442-doc .scard{background:linear-gradient(145deg,#e8f4fd,#f0f9ff);border:1px solid rgba(25,118,210,.25);border-radius:16px;padding:18px 18px 16px;margin:0 0 16px;position:relative;overflow:hidden;box-shadow:0 4px 14px -4px rgba(25,118,210,.25),0 2px 6px rgba(0,0,0,.06);}
      .lb442-doc .core-concept{background:linear-gradient(135deg,#f8fafc,#f1f5f9);border:1px solid rgba(71,85,105,.15);border-radius:16px;padding:16px;margin:0 0 16px;box-shadow:0 3px 12px -2px rgba(71,85,105,.15);} 
      .lb442-doc .core-concept h3{margin:0 0 14px;font-size:16px;font-weight:600;color:#1e293b;display:flex;align-items:center;gap:8px;}
      .lb442-doc .core-concept h3 span{font-size:13px;color:#1976d2;font-weight:500;background:rgba(25,118,210,.15);padding:4px 10px;border-radius:12px;letter-spacing:.3px;}
      .lb442-doc .concept-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;}
      .lb442-doc .concept-card{display:flex;align-items:flex-start;gap:8px;background:rgba(255,255,255,.8);border:1px solid rgba(71,85,105,.12);border-radius:10px;padding:10px 12px;}
      .lb442-doc .cc-icon{font-size:18px;line-height:1;margin-top:1px;}
      .lb442-doc .cc-content h4{margin:0 0 4px;font-size:13px;font-weight:600;color:#1e293b;line-height:1.2;}
      .lb442-doc .cc-content p{margin:0;font-size:11px;line-height:1.4;color:#64748b;}
      .lb442-doc .scard h3{margin:0 0 10px;font-size:18px;font-weight:700;display:flex;align-items:center;gap:10px;line-height:1.25;position:relative;padding-left:10px;}
      .lb442-doc .scard h3:before{content:"";position:absolute;left:0;top:4px;bottom:4px;width:4px;border-radius:4px;background:linear-gradient(180deg,#1976d2,#42a5f5);} 
      .lb442-doc .scard h3 span{font-size:11px;font-weight:600;color:#1976d2;background:rgba(25,118,210,.18);padding:2px 8px;border-radius:20px;letter-spacing:.5px;}
      .lb442-doc .examples{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-top:10px;}
      .lb442-doc .examples .ex{background:linear-gradient(150deg,#fef3c7,#fef9e7);border:1px solid rgba(245,158,11,.3);padding:12px 12px 10px;border-radius:12px;font-size:12px;line-height:1.55;}
      .lb442-doc .examples .ex .tag{display:inline-flex;align-items:center;font-size:10px;font-weight:600;padding:3px 8px;border-radius:20px;letter-spacing:.5px;margin-bottom:6px;}
      .lb442-doc .examples .ex .tag.ok{background:rgba(16,185,129,.2);color:#047857;}
      .lb442-doc .examples .ex .tag.warn{background:rgba(245,158,11,.25);color:#b45309;}
      .lb442-doc .examples .ex .tag.info{background:rgba(59,130,246,.25);color:#1d4ed8;}
      `;
      document.head.appendChild(style);
    }

    // æ¸²æŸ“å­¦ç”Ÿè¯¦æƒ…é¡µé¢
  async function renderStudentDetail(studentName) {
      const student = appState.students.get(studentName);
      if (!student) return;

      // ç«‹å³å¤„ç† 442 åˆ†æ•°å¾½ç« çš„å¯è§æ€§ï¼Œé¿å…å‘¨æœ«é—ªçƒ
      const badgeEl = document.getElementById('todayScoreBadge');
      const activeDate = getActiveLeaderboardDate();
      if (!isWorkday(activeDate)) {
        if (badgeEl) badgeEl.style.display = 'none';
      } else {
        if (badgeEl) badgeEl.style.display = 'inline-flex';
      }

      const meta = appState.studentsMeta.get(studentName) || {};
      
      // æ›´æ–°åŸºæœ¬ä¿¡æ¯
      document.getElementById('detailTitle').textContent = `${studentName} è¯¦æƒ…`;
      const studentNameEl = document.getElementById('studentName');
      studentNameEl.textContent = studentName;
      
      // ç®¡ç†å‘˜æ¨¡å¼ï¼šåœ¨å§“åæ—è¾¹æ·»åŠ è°ƒåˆ†æŒ‰é’®å’Œæ˜¾ç¤ºå½“å‰è°ƒæ•´
      const existingAdminBtn = studentNameEl.parentElement.querySelector('.admin-detail-btn');
      const existingAdminInfo = studentNameEl.parentElement.querySelector('.admin-adjustment-info');
      if (existingAdminBtn) existingAdminBtn.remove();
      if (existingAdminInfo) existingAdminInfo.remove();
      
      if (adminMode) {
        const adminBtn = document.createElement('button');
        adminBtn.className = 'admin-detail-btn';
        adminBtn.innerHTML = 'âš™ï¸ è°ƒåˆ†';
        adminBtn.title = 'ç®¡ç†å‘˜ï¼šè°ƒæ•´åˆ†æ•°';
        adminBtn.style.cssText = `
          margin-left: 12px; padding: 4px 8px; border: none; border-radius: 6px;
          background: linear-gradient(135deg, #ef4444, #dc2626); color: white; font-size: 12px;
          cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        `;
        adminBtn.onmouseover = () => {
          adminBtn.style.transform = 'scale(1.05)';
          adminBtn.style.boxShadow = '0 4px 8px rgba(239, 68, 68, 0.4)';
        };
        adminBtn.onmouseout = () => {
          adminBtn.style.transform = 'scale(1)';
          adminBtn.style.boxShadow = '0 2px 4px rgba(239, 68, 68, 0.3)';
        };
        adminBtn.onclick = () => openAdminScoreDialog(studentName);
        
        studentNameEl.parentElement.appendChild(adminBtn);
        
        // æ˜¾ç¤ºå½“å‰è°ƒåˆ†çŠ¶æ€
        const currentAdjustment = getAdminScoreAdjustment(studentName);
        if (currentAdjustment !== 0) {
          const adminInfo = document.createElement('div');
          adminInfo.className = 'admin-adjustment-info';
          adminInfo.style.cssText = `
            margin-left: 12px; padding: 2px 6px; border-radius: 4px; font-size: 11px;
            background: ${currentAdjustment > 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'};
            color: ${currentAdjustment > 0 ? '#059669' : '#dc2626'};
            border: 1px solid ${currentAdjustment > 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
          `;
          adminInfo.textContent = `${currentAdjustment > 0 ? '+' : ''}${currentAdjustment.toFixed(1)}åˆ†`;
          adminInfo.title = 'å½“å‰ç®¡ç†å‘˜è°ƒæ•´åˆ†æ•°';
          
          studentNameEl.parentElement.appendChild(adminInfo);
        }
      }
      
      document.getElementById('studentGrade').textContent = meta.grade || 'æœªçŸ¥å¹´çº§';
      document.getElementById('studentMajor').textContent = meta.major || 'æœªçŸ¥ä¸“ä¸š';

      // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šåˆ†æ‰¹å»¶è¿ŸåŠ è½½è€—æ—¶ç»„ä»¶ï¼Œé¿å…é˜»å¡è½¬åœºåŠ¨ç”»å’Œä¸»çº¿ç¨‹
      
      // 1. ä¼˜å…ˆæ›´æ–°å½“å‰çŠ¶æ€ï¼ˆè½»é‡ï¼‰
      requestAnimationFrame(() => {
        updateCurrentStatus(student);
      });
      
      // 2. ç¨åæ›´æ–°ä»Šæ—¥æ—¶é—´è½´ï¼ˆä¸­ç­‰ï¼‰
      setTimeout(() => {
        updateTodayTimeline(studentName);
      }, 50);
      
      // 3. å»¶è¿Ÿæ›´æ–°å†å²ä¸ƒå¤©æ€»ç»“ï¼ˆè¾ƒé‡ï¼‰
      setTimeout(() => {
        updateWeekHistory(studentName);
      }, 150);

      // 4. æœ€åæ›´æ–°è¶‹åŠ¿å›¾å’Œè¯„åˆ†è®¡ç®—ï¼ˆæœ€é‡ï¼‰
      setTimeout(async () => {
        render442TrendChart('#trendChart', studentName);

        // è®¡ç®—å¹¶æ˜¾ç¤ºä»Šæ—¥ 442 åˆ†ï¼ˆä»…å·¥ä½œæ—¥ï¼›å‘¨æœ«éšè—ï¼‰
        const badgeEl = document.getElementById('todayScoreBadge');
        const valEl = document.getElementById('todayScoreValue');
        const btn = document.getElementById('todayScoreDetailBtn');
        const activeDate = getActiveLeaderboardDate();
        if (!isWorkday(activeDate)) {
          if (badgeEl) badgeEl.style.display = 'none';
          if (valEl) valEl.textContent = '--';
          if (btn) btn.onclick = null;
        } else {
          try {
            const score = await computeScore442(student);
            if (valEl) valEl.textContent = Number.isFinite(score?.total) ? Math.round(score.total) : '--';
            if (badgeEl) badgeEl.style.display = 'inline-flex';
            if (btn) btn.onclick = () => { try { showScoreDetail(studentName); } catch {} };
          } catch(e) {
            if (valEl) valEl.textContent = '--';
            if (badgeEl) badgeEl.style.display = 'none';
          }
        }
      }, 300);

      // ç»‘å®šâ€œæŸ¥çœ‹å‘¨æ—¶æ®µâ€æŒ‰é’®ï¼ˆä¸å—å‘¨æœ«å½±å“ï¼‰
      const weekBtn = document.getElementById('viewWeekSlotsBtn');
      if (weekBtn) weekBtn.onclick = () => showWeekSlots(studentName);
      
      // ç»‘å®šåˆ·æ–°æ—¶é—´è½´æŒ‰é’®
  // åˆ é™¤æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®ï¼ˆè‡ªåŠ¨å®æ—¶æ›´æ–°å³å¯ï¼‰
    }

    // å±•ç¤ºå­¦ç”Ÿæ¯å‘¨1-5çš„ç»ƒç´æ—¶é—´æ®µï¼ˆæ¨¡æ€æ¡†ï¼‰
    function showWeekSlots(studentName) {
  const norm = utils.normalizeStudentName(studentName);
  dbg(`[å‘¨æ—¶æ®µå¼¹çª—] åŸå§‹å§“å='${studentName}' æ ‡å‡†åŒ–='${norm}'`);
  const timeMap = utils.getStudentTimeSlots(studentName) || {};
      // å°† weekday(1..7) æ˜ å°„åˆ°åç§°ï¼Œä»…æ˜¾ç¤ºå·¥ä½œæ—¥ 1-5
      const days = [
        { w: 1, label: 'å‘¨ä¸€' },
        { w: 2, label: 'å‘¨äºŒ' },
        { w: 3, label: 'å‘¨ä¸‰' },
        { w: 4, label: 'å‘¨å››' },
        { w: 5, label: 'å‘¨äº”' }
      ];

      const toMin = (slot) => {
        if (typeof slot?.start === 'number' && typeof slot?.end === 'number') return slot;
        const s = utils.parseTimeSlot(slot?.start_time || slot?.start);
        const e = utils.parseTimeSlot(slot?.end_time || slot?.end);
        return { start: s, end: e };
      };
      const mm = (m) => Number.isFinite(m) ? `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}` : '--:--';
      const fmtSlot = (slot) => `${mm(slot.start)} - ${mm(slot.end)}ï¼ˆ${utils.formatDuration(slot.end - slot.start)}ï¼‰`;

      const sections = days.map(d => {
        const raw = Array.isArray(timeMap[d.w]) ? timeMap[d.w] : [];
        const slots = raw.map(toMin).filter(s => Number.isFinite(s.start) && Number.isFinite(s.end) && s.end > s.start)
                          .sort((a,b) => a.start - b.start);
        dbg(`[å‘¨æ—¶æ®µå¼¹çª—] ${studentName} ${d.label}: åŸå§‹${raw.length}ï¼Œæœ‰æ•ˆ${slots.length}`);
        const list = slots.length
          ? slots.map(s => `<li>${fmtSlot(s)}</li>`).join('')
          : '<li class="text-muted">æœªé…ç½®</li>';
        return `
          <div class="lb-section">
            <div class="lb-section__title">${d.label} <span>${slots.length ? `${slots.length} æ®µ` : 'æ— '}</span></div>
            <div class="lb-card">
              <ul class="lb-list">${list}</ul>
            </div>
          </div>`;
      }).join('');

  const totalSlots = days.reduce((sum,d)=> sum + ((timeMap[d.w]?.length)||0), 0);
  const hasAny = totalSlots > 0;
      const headerCard = `
        <div class="lb-section">
          <div class="lb-card lb-card--gradient" style="background:linear-gradient(135deg,#22c55e,#16a34a);border:none;">
            <div class="lb-kv"><strong>${studentName}</strong><span>å·¥ä½œæ—¥ç»ƒç´æ—¶é—´æ®µ</span></div>
            <div style="margin-top:6px;font-size:12px;opacity:.9;">${hasAny ? `ä»¥ä¸‹ä¸ºå‘¨ä¸€åˆ°å‘¨äº”çš„é…ç½®æ—¶æ®µï¼ˆå…± ${totalSlots} æ®µï¼‰` : 'æœªé…ç½®ä¸ªæ€§åŒ–æ—¶æ®µï¼Œç³»ç»Ÿå°†ä½¿ç”¨é»˜è®¤ç»Ÿè®¡çª—å£'}</div>
          </div>
        </div>
        <div class="lb-section">
          <div class="lb-card" style="background:#fef3c7;border-left:3px solid #f59e0b;">
            <div style="color:#92400e;font-size:13px;line-height:1.6;">
              <strong style="color:#b45309;">âš ï¸ é‡è¦æç¤º</strong><br>
              å¦‚æœæ—¶é—´æ®µä¿¡æ¯æœ‰è¯¯è¯·åŠæ—¶ä¸å‰å°è€å¸ˆè”ç³»ä¿®æ”¹ï¼å¦‚æœå½“å¤©æœ‰ä¸´æ—¶è°ƒæ•´ï¼Œè¯·äºå½“æ™š21:30å‰ä¸å‰å°è€å¸ˆæ²Ÿé€šåšä¸´æ—¶ä¿®æ”¹ï¼Œå¦åˆ™å°†ä¸¥é‡å½±å“ä½ çš„æ’è¡Œæ¦œåˆ†æ•°è®¡ç®—ï¼
            </div>
          </div>
        </div>`;

      createScoreDetailModal(headerCard + sections, 'æ¯å‘¨ç»ƒç´æ—¶æ®µ');
    }

    // æ˜¾ç¤ºä»Šæ—¥æ€»è®¡æ—¶é—´çš„è¯¦ç»†è¯´æ˜
    function showTodayTotalExplanation(studentName) {
      try {
        const today = new Date();
        const dayData = calculateDayData(studentName, today);
        const totalMinutes = dayData.in + dayData.out;
        
        // è·å–ä»Šå¤©çš„åŸå§‹ç»ƒç´ä¼šè¯
        const baseLogs = Array.isArray(appState.practiceLogsNormalized) ? appState.practiceLogsNormalized : (appState.practiceLogs || []);
        const todayKey = utils.getDateKey(today);
        const todayLogs = baseLogs.filter(log => {
          if (!log.timestamp || !log.action) return false;
          const logStudentName = log.student_name || log.student || log.studentName;
          return logStudentName === studentName && utils.getDateKey(new Date(log.timestamp)) === todayKey;
        });
        
        if (todayLogs.length === 0) {
          const content = `
            <div class="lb-section">
              <div class="lb-card lb-card--gradient" style="background:linear-gradient(135deg,#0ea5e9,#6366f1);border:none;">
                <div class="lb-kv"><strong>${studentName}</strong><span>ä»Šæ—¥ç»ƒç´æ—¶é—´è®¡ç®—è¯´æ˜</span></div>
                <div style="margin-top:8px;font-size:14px;opacity:.9;">ä»Šæ—¥æš‚æ— ç»ƒç´è®°å½•</div>
              </div>
            </div>
          `;
          createScoreDetailModal(content, 'ä»Šæ—¥æ—¶é—´è®¡ç®—è¯´æ˜');
          return;
        }
        
        // æ„å»ºåŸå§‹ä¼šè¯
        const sessions = buildPracticeSessions(deduplicateLogs(todayLogs), studentName);
        
        // è·å–æœ‰æ•ˆçª—å£ä¿¡æ¯
        const dayWindow = getEffectiveDayWindow(today) || { start: 0, end: (21*60+30) };
        const weekday = utils.getWeekday(today);
        const isWeekend = weekday === 6 || weekday === 7;
        
        // è®¡ç®—å„ç§æ—¶é—´æ®µ
        let rawTotalMinutes = 0;
        let windowClippedMinutes = 0;
        let breakDeductedMinutes = totalMinutes; // æœ€ç»ˆç»Ÿè®¡çš„æ—¶é—´å°±æ˜¯æ‰£é™¤ä¼‘æ¯æ—¶é—´åçš„
        
  const sessionDetails = []; // ï¼ˆå·²å¼ƒç”¨ä»…ç”¨äºä¿ç•™ç»Ÿè®¡å˜é‡ï¼Œæ˜ç»†ä¸å†å±•ç¤ºï¼‰
        const dayStart = new Date(today); 
        dayStart.setHours(0,0,0,0); 
        const dayStartMs = dayStart.getTime();
        const windowStartMs = dayStartMs + dayWindow.start*60*1000;
        const windowEndMs = dayStartMs + dayWindow.end*60*1000;
        
        for (const session of sessions) {
          const rawStartMs = new Date(session.start).getTime();
          const rawEndMs = session.end ? new Date(session.end).getTime() : Date.now();
          const rawDuration = Math.max(0, Math.round((rawEndMs - rawStartMs) / 60000));
          rawTotalMinutes += rawDuration;
          
          // çª—å£è£å‰ª
          const clampStart = Math.max(rawStartMs, windowStartMs);
          const clampEnd = Math.min(rawEndMs, windowEndMs);
          const windowDuration = clampEnd > clampStart ? Math.round((clampEnd - clampStart) / 60000) : 0;
          windowClippedMinutes += windowDuration;
          
          const startTime = new Date(rawStartMs).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
          const endTime = session.end ? new Date(rawEndMs).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'}) : 'è¿›è¡Œä¸­';
          
          sessionDetails.push({
            timeRange: `${startTime} - ${endTime}`,
            rawDuration: rawDuration,
            windowDuration: windowDuration,
            room: session.room || 'æœªçŸ¥',
            isOngoing: !session.end
          });
        }
        
        // è®¡ç®—è¢«æ‰£é™¤çš„æ—¶é—´
        const windowDeducted = rawTotalMinutes - windowClippedMinutes;
        const breakDeducted = windowClippedMinutes - breakDeductedMinutes;
        
        // æ„å»ºè¯¦ç»†è¯´æ˜
        const windowInfo = isWeekend ? 'å‘¨æœ«æ— ç»Ÿè®¡çª—å£é™åˆ¶' : 
          `ç»Ÿè®¡çª—å£ï¼š${Math.floor(dayWindow.start/60).toString().padStart(2,'0')}:${(dayWindow.start%60).toString().padStart(2,'0')} - ${Math.floor(dayWindow.end/60).toString().padStart(2,'0')}:${(dayWindow.end%60).toString().padStart(2,'0')}`;
        
        const breakInfo = isWeekend ? 'å‘¨æœ«æ— ä¼‘æ¯æ—¶é—´æ‰£é™¤' :
          (weekday === 3 ? 'ä¼‘æ¯æ—¶é—´ï¼š12:10-13:20, 18:40-19:10' : 'ä¼‘æ¯æ—¶é—´ï¼š12:10-12:40, 18:10-18:40');
        
  // å·²ç§»é™¤ä¼šè¯æ˜ç»†åˆ—è¡¨å±•ç¤ºï¼ˆæ—¶é—´è½´å·²æä¾›ï¼‰ï¼Œä¿ç•™è®¡ç®—é€»è¾‘ä»¥ä¿è¯åç»­æ‰©å±•å¯ç”¨ã€‚
        
        const content = `
          <div class="lb-section">
            <div class="lb-card lb-card--gradient" style="background:linear-gradient(135deg,#0ea5e9,#6366f1);border:none;">
              <div class="lb-kv"><strong>${studentName}</strong><span>ä»Šæ—¥ç»ƒç´æ—¶é—´è®¡ç®—è¯´æ˜</span></div>
              <div style="margin-top:8px;font-size:30px;font-weight:800;">${utils.formatDuration(totalMinutes)}</div>
              <div style="opacity:.9;font-size:12px;">æœ€ç»ˆç»Ÿè®¡æ—¶é—´</div>
            </div>
          </div>

          <div class="lb-section">
            <div class="lb-card">
              <h4>ğŸ“Š è®¡ç®—è¿‡ç¨‹</h4>
              <div class="calc-box">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                  <span>åŸå§‹æ—¶é•¿ï¼š</span>
                  <strong>${utils.formatDuration(rawTotalMinutes)}</strong>
                </div>
                ${windowDeducted > 0 ? `
                  <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:#ef4444;">
                    <span>å‡å»çª—å£å¤–ï¼š</span>
                    <strong>-${utils.formatDuration(windowDeducted)}</strong>
                  </div>
                ` : ''}
                ${breakDeducted > 0 ? `
                  <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:#ef4444;">
                    <span>å‡å»ä¼‘æ¯æ—¶é—´ï¼š</span>
                    <strong>-${utils.formatDuration(breakDeducted)}</strong>
                  </div>
                ` : ''}
                <hr class="calc-sep">
                <div style="display:flex; justify-content:space-between; font-weight:600; font-size:16px; color:#059669;">
                  <span>æœ€ç»ˆç»Ÿè®¡ï¼š</span>
                  <strong>${utils.formatDuration(totalMinutes)}</strong>
                </div>
              </div>
            </div>
          </div>

          ${!isWeekend ? `
          <div class="lb-section">
            <div class="lb-card">
              ${(() => {
                const isWed = weekday === 3;
                const breaks = isWed ? BREAK_SCHEDULE.wed : BREAK_SCHEDULE.monTueThuFri;
                
                // è¯†åˆ«ç±»å‹ï¼šé€šè¿‡è·¨åº¦æ—¶é•¿/æ—¶é—´ä½ç½®ç®€å•æ˜ å°„
                function classify(b){
                  const dur = b.end - b.start; // åˆ†é’Ÿ
                  const s = b.start;
                  if (dur >= 60 && s >= (12*60) && s < (13*60+30)) return isWed ? 'åˆé¤+åˆé—´éŸ³ä¹ä¼š' : 'åˆé¤';
                  if (dur >= 30 && s >= (18*60) && s < (19*60+30)) return 'æ™šé¤';
                  if (dur >= 15) return 'å¤§è¯¾é—´';
                  return 'å°è¯¾é—´';
                }
                
                // å°†ä¼šè¯è½¬ä¸ºåˆ†é’ŸåŒºé—´ï¼ˆè£å‰ªåˆ°ç»Ÿè®¡çª—å£ï¼‰
                const dayStart = new Date(today); dayStart.setHours(0,0,0,0);
                const toMin = ms => Math.floor((ms - dayStart.getTime())/60000);
                const sessionIntervals = sessions.map(s=>{
                  const st = toMin(new Date(s.start).getTime());
                  const et = toMin((s.end? new Date(s.end).getTime(): Date.now()));
                  return {start: Math.max(st, dayWindow.start), end: Math.min(et, dayWindow.end)};
                }).filter(iv=> iv.end>iv.start);
                
                // è®¡ç®—ä¸æ¯ä¸ª break çš„é‡å 
                const overlapped = breaks.map(b=>{
                  const ov = sessionIntervals.reduce((sum,iv)=>{
                    const os = Math.max(iv.start, b.start);
                    const oe = Math.min(iv.end, b.end);
                    return sum + (oe>os? (oe-os):0);
                  },0);
                  return { ...b, overlap: ov };
                }).filter(b=> b.overlap>0);
                
                const totalBreakTime = overlapped.reduce((s,b)=> s + b.overlap,0);
                
                if(!overlapped.length){
                  return `<h4>å®é™…å‰”é™¤æ—¶é—´ 0åˆ†é’Ÿ</h4>
                    <div class="break-summary">
                      <div class="break-total">ä»Šæ—¥å®é™…æœªä¸ç»ƒç´é‡å çš„ä¼‘æ¯æ®µï¼Œæ— éœ€æ‰£é™¤</div>
                      <div class="break-hint">è¯´æ˜ï¼šåªæœ‰ä¸ç»ƒç´ä¼šè¯æ—¶é—´é‡å çš„ä¼‘æ¯åˆ†é’Ÿæ‰ä¼šè¢«å‰”é™¤ã€‚</div>
                    </div>`;
                }
                
                const rows = overlapped.map(b=>{
                  const start = `${String(Math.floor(b.start/60)).padStart(2,'0')}:${String(b.start%60).padStart(2,'0')}`;
                  const end = `${String(Math.floor(b.end/60)).padStart(2,'0')}:${String(b.end%60).padStart(2,'0')}`;
                  const type = classify(b);
                  return `<li class=\"break-row\"><span class=\"br-time\">${start} - ${end}</span><span class=\"br-type ${type.includes('åˆé¤')?'br-meal': type==='æ™šé¤'?'br-dinner': type==='å¤§è¯¾é—´'?'br-large':'br-small'}\">${type}</span><span class=\"br-dur\">${b.overlap}åˆ†</span></li>`;
                }).join('');
                
                return `<h4>å®é™…å‰”é™¤æ—¶é—´ ${utils.formatDuration(totalBreakTime)}</h4>
                  <div class="break-summary">
                    <ul class="break-list">${rows}</ul>
                    <div class="break-hint">è¯´æ˜ï¼šä»…åˆ—å‡ºä¸ç»ƒç´é‡å çš„ä¼‘æ¯æ®µã€‚${isWed ? 'ï¼ˆå‘¨ä¸‰åˆé¤åˆå¹¶åˆé—´éŸ³ä¹ä¼šï¼‰' : ''}</div>
                  </div>`;
              })()}
            </div>
          </div>
          ` : ''}

          <!-- ä¼šè¯æ˜ç»†åŒºå—å·²ç§»é™¤ï¼šæ—¶é—´è½´å·²è¦†ç›–è¯¥ä¿¡æ¯ -->

          <div class="lb-section">
            <div class="lb-card">
              <h4>ğŸ“ ç»Ÿè®¡è§„åˆ™</h4>
              <div style="font-size:13px; line-height:1.8; color:#666;">
                <p>â€¢ ç»Ÿè®¡æ—¶é—´ï¼š07:30-21:30</p>
                <p>â€¢ è‡ªåŠ¨æ‰£é™¤æ‰€æœ‰ä¼‘æ¯æ—¶é—´</p>
                <p>â€¢ å¤šæ¬¡è¿›å‡ºæˆ¿é—´ç´¯è®¡è®¡ç®—</p>
              </div>
            </div>
          </div>
        `;
        
        createScoreDetailModal(content, 'ä»Šæ—¥æ—¶é—´è®¡ç®—è¯´æ˜');
        
      } catch (e) {
        console.error('æ˜¾ç¤ºä»Šæ—¥æ€»è®¡è¯´æ˜å¤±è´¥:', e);
        const content = `
          <div class="lb-section">
            <div class="lb-card">
              <h4>âŒ è®¡ç®—è¯´æ˜åŠ è½½å¤±è´¥</h4>
              <p>æ— æ³•è·å–è¯¦ç»†çš„æ—¶é—´è®¡ç®—ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯æ•°æ®å¼‚å¸¸ã€‚</p>
            </div>
          </div>
        `;
        createScoreDetailModal(content, 'è®¡ç®—è¯´æ˜');
      }
    }

    // æ›´æ–°å½“å‰çŠ¶æ€ä¿¡æ¯
    function updateCurrentStatus(student) {
      const currentStartTime = document.getElementById('currentStartTime');
      const currentDuration = document.getElementById('currentDuration');
      const todayTotal = document.getElementById('todayTotal');
      const currentRoom = document.getElementById('currentRoom');

      // å½“å‰ç»ƒç´å¼€å§‹æ—¶é—´
      if (student.currentStatus !== 'offline' && student.currentStartTime) {
        currentStartTime.textContent = utils.formatTime(student.currentStartTime);
      } else {
        currentStartTime.textContent = '--';
      }

      // å½“å‰æ—¶é•¿ï¼ˆè¿™æ¬¡ç»ƒç´çš„æ—¶é•¿ï¼‰
      if (student.currentStatus !== 'offline' && student.currentStartTime) {
        const now = new Date();
        const currentSessionMinutes = Math.round((now - student.currentStartTime) / (1000 * 60));
        currentDuration.textContent = utils.formatDuration(Math.max(0, currentSessionMinutes));
      } else {
        currentDuration.textContent = '--';
      }

      // å½“å‰ç´æˆ¿
      currentRoom.textContent = student.currentRoom || '--';

      // ä»Šæ—¥æ€»è®¡ - ä½¿ç”¨ä¸ä¸ƒå¤©æ€»ç»“ç›¸åŒçš„è®¡ç®—é€»è¾‘
      const todayData = calculateDayData(student.name, new Date());
      const totalMinutes = todayData.in + todayData.out;
      todayTotal.textContent = utils.formatDuration(totalMinutes);
      
      // ç»‘å®šä»Šæ—¥æ€»è®¡è¯´æ˜æŒ‰é’®
      const todayTotalHelpBtn = document.getElementById('todayTotalHelpBtn');
      if (todayTotalHelpBtn) {
        todayTotalHelpBtn.onclick = () => showTodayTotalExplanation(student.name);
      }
    }

    // å»é‡æ—¥å¿—ï¼šä¸“é—¨é’ˆå¯¹ assign/clear æ“ä½œå»é‡
    function deduplicateLogs(logs) {
      const result = [];
      const seen = new Set(); // è®°å½•å·²å¤„ç†çš„æ—¶é—´æˆ³+åŠ¨ä½œç»„åˆ
      
      // æŒ‰æ—¶é—´æ’åº
      const sortedLogs = [...logs].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
      
      for(const log of sortedLogs) {
        // åªå¤„ç†æœ‰ action å’Œ timestamp çš„æ—¥å¿—
        if(!log.action || !log.timestamp) continue;
        
        const action = log.action.toLowerCase();
        // åªå¤„ç† assign/clear æˆ– enter/exit æ“ä½œ
        if(!['assign', 'clear', 'enter', 'exit'].includes(action)) continue;
        
        const timestamp = log.timestamp;
        const key = `${timestamp}-${action}`;
        
        if(!seen.has(key)) {
          seen.add(key);
          result.push(log);
          dbg(`ä¿ç•™æ—¥å¿—: ${timestamp} - ${action}`);
        } else {
          dbg(`è·³è¿‡é‡å¤æ—¥å¿—: ${timestamp} - ${action}`);
        }
      }
      
      return result;
    }

    // æ›´æ–°ä»Šæ—¥æ—¶é—´è½´ - ä¼˜å…ˆä½¿ç”¨å¢é‡æ›´æ–°æœºåˆ¶
    function updateTodayTimeline(studentName) {
      // ğŸš€ ä¼˜å…ˆä½¿ç”¨å¢é‡æ›´æ–°ï¼Œæ€§èƒ½æ›´å¥½ï¼Œç”¨æˆ·ä½“éªŒæ›´æµç•…
      if (timelineCache.has(studentName)) {
        updateTimelineIncremental(studentName);
        return;
      }
      
      // å…œåº•ï¼šä½¿ç”¨å®Œæ•´é‡å»ºï¼ˆé¦–æ¬¡åŠ è½½æˆ–æ¸…ç†ç¼“å­˜åï¼‰
      updateTodayTimelineFull(studentName);
    }
    
    // å®Œæ•´é‡å»ºæ—¶é—´è½´ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ä½œä¸ºå…œåº•ï¼‰
    function updateTodayTimelineFull(studentName) {
      const container = document.getElementById('todayTimeline');
  const __perfStart = performance.now();
      const baseLogs = Array.isArray(appState.practiceLogsNormalized) ? appState.practiceLogsNormalized : (appState.practiceLogs||[]);
      const studentLogs = baseLogs.filter(log => {
        const logStudentName = log.student_name || log.student || log.studentName;
        return logStudentName === studentName;
      });

      const today = new Date();
      const todayKey = utils.getDateKey(today);
      
      // ç­›é€‰ä»Šæ—¥æ—¥å¿—å¹¶å»é‡ï¼ˆåªä½¿ç”¨ timestampï¼‰
      const rawTodayLogs = studentLogs.filter(log => {
        return log.timestamp && utils.getDateKey(new Date(log.timestamp)) === todayKey;
      });
      
      const todayLogs = deduplicateLogs(rawTodayLogs);

      if (todayLogs.length === 0) {
        scheduleDOM(()=>{ container.innerHTML = '<div class="timeline-empty">ä»Šæ—¥æš‚æ— ç»ƒç´è®°å½•</div>'; });
        if(window.DEBUG || (window.__perfFlags && window.__perfFlags.instrumentRanking)) {
          const dur = (performance.now()-__perfStart).toFixed(1);
          dbg(`[perf] updateTodayTimeline(empty) ${dur}ms`);
        }
        return;
      }

      // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºæ—¥å¿—å¤„ç†æƒ…å†µ
      dbg(`=== å­¦ç”Ÿ ${studentName} æ—¶é—´è½´æ„å»º ===`);
      dbg(`ä»Šæ—¥æ—¥æœŸ: ${todayKey} (${today.toLocaleString('zh-CN')})`);
      dbg(`åŸå§‹æ—¥å¿—: ${rawTodayLogs.length} æ¡`);
      rawTodayLogs.forEach(log => {
        const logTime = new Date(log.timestamp);
        const timeStr = logTime.toLocaleTimeString('zh-CN', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
        dbg(`  - ${timeStr} (${log.timestamp}) | ${log.action} | ${log.room_name || log.room || 'N/A'}`);
      });
      
      dbg(`å»é‡åæ—¥å¿—: ${todayLogs.length} æ¡`);
      if(rawTodayLogs.length !== todayLogs.length) {
        dbg('âœ“ å‘ç°å¹¶ç§»é™¤äº†é‡å¤æ—¥å¿—');
      }

      // æ„å»ºç»ƒç´ä¼šè¯
  const sessions = buildPracticeSessions(todayLogs, studentName);
      
      dbg(`æœ€ç»ˆä¼šè¯: ${sessions.length} ä¸ª`);
      sessions.forEach((session, index) => {
        const start = new Date(session.start).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
        const end = session.end ? new Date(session.end).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'}) : 'è¿›è¡Œä¸­';
        const duration = session.end ? Math.round((new Date(session.end) - new Date(session.start)) / 60000) : '?';
        dbg(`  ä¼šè¯ ${index + 1}: ${start} - ${end} (${duration}åˆ†é’Ÿ, æˆ¿é—´: ${session.room || 'æœªçŸ¥'})`);
      });
      dbg(`=== æ—¶é—´è½´æ„å»ºå®Œæˆ ===`);
      
      // æ·»åŠ é¢å¤–çš„é‡å¤æ£€æŸ¥
      if(sessions.length > 0) {
        const duplicateCheck = new Set();
        let hasDuplicates = false;
        sessions.forEach(session => {
          const sessionKey = `${session.start}-${session.end}`;
          if(duplicateCheck.has(sessionKey)) {
            hasDuplicates = true;
            dbg(`âš ï¸  æ£€æµ‹åˆ°é‡å¤ä¼šè¯: ${sessionKey}`);
          }
          duplicateCheck.add(sessionKey);
        });
        if(!hasDuplicates) {
          dbg(`âœ“ ä¼šè¯å»é‡æ£€æŸ¥é€šè¿‡ï¼Œæ— é‡å¤è®°å½•`);
        }
      }
      
      // å¦‚æœæ²¡æœ‰æœ‰æ•ˆä¼šè¯ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
      if(!sessions || sessions.length === 0) {
        scheduleDOM(()=>{ container.innerHTML = '<div class="timeline-empty">ä»Šæ—¥æš‚æ— ç»ƒç´è®°å½•</div>'; });
        if(window.DEBUG || (window.__perfFlags && window.__perfFlags.instrumentRanking)) {
          const dur = (performance.now()-__perfStart).toFixed(1);
          dbg(`[perf] updateTodayTimeline(noSessions) ${dur}ms`);
        }
        return;
      }
      
      let html = '';
      const renderedSessions = new Set(); // ç”¨äºé˜²æ­¢é‡å¤æ¸²æŸ“ç›¸åŒçš„ä¼šè¯
      let validSessionCount = 0;
      const CHUNK_THRESHOLD = 80; // è¶…è¿‡æ­¤é˜ˆå€¼é‡‡ç”¨åˆ†å—æ¸²æŸ“
      const CHUNK_SIZE = 25;
      const items = [];
      
      sessions.forEach((session, index) => {
        // ç”Ÿæˆä¼šè¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆåŸºäºæ—¶é—´ï¼Œå¿½ç•¥æˆ¿é—´é¿å…æˆ¿é—´å˜åŒ–å¯¼è‡´çš„é‡å¤ï¼‰
        const sessionId = `${session.start}-${session.end || 'ongoing'}`;
        if(renderedSessions.has(sessionId)) {
          dbg(`è·³è¿‡é‡å¤ä¼šè¯ ${index + 1}: ${sessionId}`);
          return; // è·³è¿‡é‡å¤çš„ä¼šè¯
        }
        renderedSessions.add(sessionId);
        
        // âœ… è°ƒè¯•ï¼šè®°å½•æ‰€æœ‰ä¼šè¯çš„æ—¶é—´ä¿¡æ¯
        const sessionStartDate = new Date(session.start);
        const startMinutes = sessionStartDate.getHours() * 60 + sessionStartDate.getMinutes();
        dbg(`ğŸ” å¤„ç†ä¼šè¯ ${index + 1}: ${sessionStartDate.toLocaleTimeString('zh-CN')} (${startMinutes}åˆ†é’Ÿ), æˆ¿é—´: ${session.room}`);
        if (startMinutes < 450) { // 450 = 7:30
          dbg(`âš ï¸ æ³¨æ„ï¼šè¿™æ˜¯0ç‚¹å07:30å‰çš„ä¼šè¯ï¼Œåº”è¯¥æ˜¾ç¤º`);
        }
        
        // âœ… ä¿®å¤ï¼šå­¦ç”Ÿè¯¦æƒ…æ—¶é—´è½´æ˜¾ç¤ºå…¨å¤©24å°æ—¶è®°å½•ï¼Œä½†è¶…è¿‡21:30çš„éƒ¨åˆ†è‡ªåŠ¨æˆªæ–­
        // ç»Ÿè®¡çª—å£(07:30-21:30)ä»…ç”¨äºæ ‡è®°æ˜¯å¦åœ¨è§„å®šæ—¶æ®µå†…ï¼Œä½†æ˜¾ç¤ºæ—¶éœ€è¦æˆªæ–­è¶…è¿‡21:30çš„æ—¶é—´
        const dayWindow = getEffectiveDayWindow(sessionStartDate) || { start: 0, end: (21*60+30) }; // å…œåº•
        const nowMs = Date.now();
        const rawStartMs = new Date(session.start).getTime();
        
        // å¯¹äºæ­£åœ¨è¿›è¡Œçš„ä¼šè¯ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºç»“æŸæ—¶é—´
        const isOngoing = !session.end;
        const rawEndMs = session.end ? new Date(session.end).getTime() : nowMs;
        
        // âœ… æ˜¾ç¤ºæ—¶æˆªæ–­ï¼šå¦‚æœç»“æŸæ—¶é—´è¶…è¿‡21:30ï¼Œè‡ªåŠ¨æˆªæ–­åˆ°21:30
        const sessionDate = new Date(session.start);
        const dayStart = new Date(sessionDate);
        dayStart.setHours(0, 0, 0, 0);
        const dayEnd21_30 = dayStart.getTime() + (21 * 60 + 30) * 60 * 1000; // 21:30
        
        const effStartMs = rawStartMs;
        // å¦‚æœç»“æŸæ—¶é—´è¶…è¿‡21:30ï¼Œæˆªæ–­åˆ°21:30æ˜¾ç¤º
        const effEndMs = Math.min(rawEndMs, dayEnd21_30);
        
        // åŸºæœ¬æœ‰æ•ˆæ€§æ£€æŸ¥ï¼šç¡®ä¿ä¼šè¯æ—¶é•¿ä¸ºæ­£
        if(effEndMs <= effStartMs && !isOngoing){ return; } // è¿‡æ»¤æ— æ•ˆä¼šè¯
        
        // æ£€æŸ¥æ˜¯å¦è¢«æˆªæ–­ï¼ˆåŸå§‹ç»“æŸæ—¶é—´è¶…è¿‡21:30ï¼‰
        const wasTruncated = rawEndMs > dayEnd21_30;
        // å¦‚æœè¢«æˆªæ–­ï¼Œæ˜¾ç¤ºæˆªæ–­åçš„æ—¶é—´è€Œä¸æ˜¯"è¿›è¡Œä¸­"
        const displayOngoing = isOngoing && !wasTruncated;
        
        const startTime = new Date(effStartMs).toLocaleTimeString('zh-CN', { hour:'2-digit', minute:'2-digit' });
        const endTime = displayOngoing ? 'è¿›è¡Œä¸­' : new Date(effEndMs).toLocaleTimeString('zh-CN', { hour:'2-digit', minute:'2-digit' });
        const duration = Math.max(0, Math.round((effEndMs - effStartMs)/60000));
        
        // å¯¹äºæ­£åœ¨è¿›è¡Œçš„ä¼šè¯ï¼Œå³ä½¿æ—¶é•¿å¾ˆçŸ­ä¹Ÿè¦æ˜¾ç¤º
        if(!displayOngoing && duration < 1) return;
        
        const isInSchedule = isSessionInSchedule(session, studentName);
        const scheduleClass = isInSchedule ? 'in-schedule' : 'out-schedule';
        const ongoingClass = displayOngoing ? 'ongoing' : '';
        
        const markup = `
          <div class=\"timeline-item ${scheduleClass}\" 
               data-session-id=\"${sessionId}\" 
               data-session-index=\"${validSessionCount + 1}\"
               data-start-time=\"${session.start}\"
               data-is-ongoing=\"${displayOngoing}\"
               ${wasTruncated ? 'data-truncated=\"true\"' : ''}>
            <div class=\"timeline-time\">
              ${startTime} - ${endTime}${wasTruncated && isOngoing ? ' (æˆªæ–­)' : ''}
            </div>
            <div class=\"timeline-duration ${displayOngoing ? 'live-duration' : ''}\" 
                 data-start-timestamp=\"${effStartMs}\">
              ${utils.formatDuration(duration)}${displayOngoing ? 'â±ï¸' : ''}${wasTruncated && isOngoing ? ' ğŸ“' : ''}
            </div>
            ${session.room ? `<div class=\\"timeline-room\\">${session.room}</div>` : ''}
          </div>`;
        items.push(markup);
        html += markup;
        
        validSessionCount++;
        dbg(`æ¸²æŸ“ä¼šè¯ ${validSessionCount}: ${startTime} - ${endTime} (${duration}åˆ†é’Ÿ)${isOngoing ? ' [æ­£åœ¨è¿›è¡Œ]' : ''}`);
      });

      const finalizeBind = () => {
        const ongoingCount = sessions.filter(s => !s.end).length;
        const earlyMorningSessions = sessions.filter(s => {
          const startTime = new Date(s.start);
          const minutes = startTime.getHours() * 60 + startTime.getMinutes();
          return minutes < 450; // 07:30ä¹‹å‰
        });
        
        dbg(`æ—¶é—´è½´æ¸²æŸ“å®Œæˆ: æ˜¾ç¤º ${validSessionCount} ä¸ªä¼šè¯${ongoingCount > 0 ? `ï¼Œå…¶ä¸­ ${ongoingCount} ä¸ªè¿›è¡Œä¸­` : ''}`);
        if (earlyMorningSessions.length > 0) {
          dbg(`ğŸŒ… æ£€æµ‹åˆ° ${earlyMorningSessions.length} ä¸ªæ—©é—´ä¼šè¯(00:00-07:30)ï¼Œå·²æ­£å¸¸æ˜¾ç¤º`);
          console.log(`ğŸŒ… æ£€æµ‹åˆ°å­¦ç”Ÿ ${studentName} æœ‰ ${earlyMorningSessions.length} ä¸ªæ—©é—´ç»ƒç´è®°å½•ï¼Œå·²åœ¨æ—¶é—´è½´ä¸­æ˜¾ç¤º`);
        }
        
        startLiveTimelineUpdate(container);
        const timelineItems = container.querySelectorAll('.timeline-item');
        timelineItems.forEach(item => {
          item.addEventListener('click', (e) => {
            e.stopPropagation();
            item.classList.toggle('selected');
          });
        });
      };

  if(validSessionCount === 0) {
        scheduleDOM(()=>{ container.innerHTML = '<div class="timeline-empty">ä»Šæ—¥æš‚æ— æœ‰æ•ˆç»ƒç´è®°å½•</div>'; });
        return;
      }

      if(validSessionCount > CHUNK_THRESHOLD) {
  container.innerHTML = '';
        let idx = 0;
        const appendChunk = () => {
          const slice = items.slice(idx, idx + CHUNK_SIZE).join('');
            if(slice) {
              scheduleDOM(()=>{ container.insertAdjacentHTML('beforeend', slice); });
              idx += CHUNK_SIZE;
              if(idx < items.length) {
                requestAnimationFrame(appendChunk);
              } else {
    requestAnimationFrame(()=> { finalizeBind(); if(window.DEBUG || (window.__perfFlags && window.__perfFlags.instrumentRanking)) { dbg(`[perf] updateTodayTimeline(chunked ${validSessionCount}) ${(performance.now()-__perfStart).toFixed(1)}ms`); } });
              }
            }
        };
        requestAnimationFrame(appendChunk);
      } else {
  scheduleDOM(()=>{ container.innerHTML = html; finalizeBind(); if(window.DEBUG || (window.__perfFlags && window.__perfFlags.instrumentRanking)) { dbg(`[perf] updateTodayTimeline(${validSessionCount}) ${(performance.now()-__perfStart).toFixed(1)}ms`); } });
      }
    }

    // âœ… æ—¶é—´è½´å®æ—¶æ›´æ–°é…ç½®éªŒè¯ï¼šæ­£åœ¨è¿›è¡Œçš„ç»ƒç´ä¼šè¯åŠ¨æ€æ—¶é•¿æ˜¾ç¤º
    let timelineUpdateInterval = null;
    
    function startLiveTimelineUpdate(container) {
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if(timelineUpdateInterval) {
        clearInterval(timelineUpdateInterval);
      }
      
      // âœ… æ¯10ç§’æ›´æ–°æ­£åœ¨è¿›è¡Œçš„ç»ƒç´æ—¶é•¿ï¼Œæé«˜æ—¶é—´è½´å®æ—¶æ€§ï¼ˆä»15ç§’ä¼˜åŒ–åˆ°10ç§’ï¼‰
      timelineUpdateInterval = setInterval(() => {
        const ongoingItems = container.querySelectorAll('.timeline-item.ongoing');
        if(ongoingItems.length === 0) {
          // æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„ä¼šè¯ï¼Œæ™ºèƒ½åœæ­¢æ›´æ–°èŠ‚çœèµ„æº
          clearInterval(timelineUpdateInterval);
          timelineUpdateInterval = null;
          dbg('æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„ä¼šè¯ï¼Œåœæ­¢å®æ—¶æ›´æ–°');
          return;
        }
        
        const now = Date.now();
        let updateCount = 0;
        ongoingItems.forEach(item => {
          const startTimestamp = parseInt(item.dataset.startTimestamp);
          if(Number.isFinite(startTimestamp)) {
            const durationMs = now - startTimestamp;
            const durationMinutes = Math.max(0, Math.round(durationMs / 60000));
            
            const durationEl = item.querySelector('.live-duration');
            if(durationEl) {
              const currentText = durationEl.textContent.replace('â±ï¸', '').trim();
              const newText = utils.formatDuration(durationMinutes);
              
              // âœ… æ™ºèƒ½DOMæ›´æ–°ï¼šåªæœ‰æ—¶é•¿çœŸæ­£æ”¹å˜æ—¶æ‰æ›´æ–°ï¼Œé¿å…ä¸å¿…è¦çš„é‡ç»˜
              if(currentText !== newText) {
                durationEl.textContent = `${newText}â±ï¸`;
                updateCount++;
              }
            }
          }
        });
        
        if(updateCount > 0) {
          dbg(`âœ… æ—¶é—´è½´å®æ—¶æ›´æ–°ï¼šæ›´æ–°äº† ${updateCount} ä¸ªæ­£åœ¨è¿›è¡Œçš„ä¼šè¯æ—¶é•¿`);
        }
      }, 10000); // âœ… æ¯10ç§’æ›´æ–°ä¸€æ¬¡ï¼Œæé«˜å®æ—¶æ€§ï¼ˆä»15ç§’ä¼˜åŒ–ï¼‰
      
      dbg('âœ… å¯åŠ¨æ—¶é—´è½´å®æ—¶æ›´æ–°');
    }
    
    function stopLiveTimelineUpdate() {
      if(timelineUpdateInterval) {
        clearInterval(timelineUpdateInterval);
        timelineUpdateInterval = null;
        dbg('åœæ­¢æ—¶é—´è½´å®æ—¶æ›´æ–°');
      }
    }

    // ========== ğŸš€ å¢é‡æ›´æ–°æœºåˆ¶ ==========
    
    // ğŸš€ å¤šè¡¨å¢é‡æ›´æ–°ç¼“å­˜ç³»ç»Ÿ
    const timelineCache = new Map(); // studentName -> { sessions: [], lastUpdate: timestamp, container: element }
    const studentSlotsCache = new Map(); // studentName -> { slots: {}, lastUpdate: timestamp }
    const roomsCache = new Map(); // roomName -> { info: {}, lastUpdate: timestamp, students: [] }
    const studentsCache = new Map(); // studentName -> { info: {}, lastUpdate: timestamp }
    
    /**
     * å¢é‡æ›´æ–°æ—¶é—´è½´ - åªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†ï¼Œå¤§å¹…æå‡æ€§èƒ½
     * @param {string} studentName å­¦ç”Ÿå§“å
     * @param {Object} newLog æ–°çš„æ—¥å¿—è®°å½•ï¼ˆå¯é€‰ï¼Œç”¨äºé¢„æµ‹æ€§æ›´æ–°ï¼‰
     */
    function updateTimelineIncremental(studentName, newLog = null) {
      const container = document.getElementById('todayTimeline');
      if (!container) return;
      // å¦‚æœåˆ‡æ¢äº†å­¦ç”Ÿï¼Œä½†æ²¿ç”¨äº†åŒä¸€ä¸ªå®¹å™¨ï¼Œéœ€è¦é‡ç½®ï¼ˆå¦åˆ™å¯èƒ½å‡ºç°ç¼“å­˜ä¸å®é™…DOMè„±èŠ‚ï¼Œå¯¼è‡´æ–°å¢ä¼šè¯è¢« arraysEqual çŸ­è·¯ï¼‰
      const boundStudent = container.getAttribute('data-student');
      if (boundStudent !== studentName) {
        dbg(`ğŸ” åˆ‡æ¢å­¦ç”Ÿæ—¶é—´è½´è§†å›¾: ${boundStudent || 'none'} -> ${studentName}`);
        container.setAttribute('data-student', studentName);
        container.innerHTML = '';
      }
      
      const baseLogs = Array.isArray(appState.practiceLogsNormalized) ? appState.practiceLogsNormalized : (appState.practiceLogs||[]);
      const studentLogs = baseLogs.filter(log => {
        const logStudentName = log.student_name || log.student || log.studentName;
        return logStudentName === studentName;
      });

      const today = new Date();
      const todayKey = utils.getDateKey(today);
      const todayLogs = studentLogs.filter(log => {
        return log.timestamp && utils.getDateKey(new Date(log.timestamp)) === todayKey;
      });
      
      // æ£€æŸ¥ç¼“å­˜
      const cached = timelineCache.get(studentName);
      const newSessions = buildPracticeSessions(deduplicateLogs(todayLogs), studentName);
      
      // å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œåªæ›´æ–°æ­£åœ¨è¿›è¡Œçš„ä¼šè¯æ—¶é•¿ã€‚
      // è¡¥å……æ¡ä»¶ï¼šDOM ä¸­çš„ item æ•°é‡å¿…é¡»ä¸ä¼šè¯æ•°é‡ä¸€è‡´ï¼Œä¸”å½“å‰å®¹å™¨å·²ç»‘å®šè¯¥å­¦ç”Ÿï¼›å¦åˆ™éœ€è¦ç»§ç»­èµ° diff ä»¥è¡¥å»ºç¼ºå¤±èŠ‚ç‚¹ã€‚
      const existingItems = container.querySelectorAll('.timeline-item');
      if (cached && arraysEqual(cached.sessions, newSessions) && existingItems.length === newSessions.length) {
        // æ­£å¸¸ä»…æ›´æ–°æ—¶é—´
        updateOngoingSessionsOnly(container);
        return;
      }
      // å›é€€è¡¥å»ºï¼šè‹¥æ•°æ®ç›¸ç­‰ä½†æ•°é‡ä¸ç­‰ï¼Œæˆ–å­˜åœ¨è¿›è¡Œä¸­ä¼šè¯æœªå‘ˆç°
      if (cached && arraysEqual(cached.sessions, newSessions)) {
        const hasOngoing = newSessions.some(s=>!s.end);
        const hasOngoingDom = !!container.querySelector('.timeline-item[data-is-ongoing="true"]');
        if (hasOngoing && !hasOngoingDom) {
          dbg('âš ï¸ æ£€æµ‹åˆ°è¿›è¡Œä¸­ä¼šè¯æ•°æ®å­˜åœ¨ä½†DOMç¼ºå¤±ï¼Œæ‰§è¡Œè¡¥å»º');
          const ongoingSession = newSessions.find(s=>!s.end);
          if (ongoingSession) {
            const el = createSessionElement(ongoingSession, studentName);
            insertSessionInOrder(container, el, ongoingSession);
            return; // è¡¥å»ºåç»“æŸæœ¬è½®
          }
        }
      }
      
      // è®¡ç®—å˜åŒ–ï¼šæ–°å¢ã€æ›´æ–°ã€åˆ é™¤çš„ä¼šè¯
      const changes = calculateSessionChanges(cached?.sessions || [], newSessions);
      
      if (changes.hasChanges) {
        applyIncrementalChanges(container, changes, studentName);
        
        // æ›´æ–°ç¼“å­˜
        timelineCache.set(studentName, {
          sessions: newSessions,
          lastUpdate: Date.now(),
          container: container
        });
      }
    }
    
    /**
     * è®¡ç®—ä¼šè¯å˜åŒ–
     */
    function calculateSessionChanges(oldSessions, newSessions) {
      const changes = {
        added: [],
        updated: [],
        removed: [],
        hasChanges: false
      };
      
      // ä½¿ç”¨ä¼šè¯å¼€å§‹æ—¶é—´ä½œä¸ºå”¯ä¸€æ ‡è¯†
      const oldMap = new Map(oldSessions.map(s => [s.start, s]));
      const newMap = new Map(newSessions.map(s => [s.start, s]));
      
      // æŸ¥æ‰¾æ–°å¢å’Œæ›´æ–°çš„ä¼šè¯
      for (const [startTime, session] of newMap) {
        const oldSession = oldMap.get(startTime);
        if (!oldSession) {
          changes.added.push(session);
          changes.hasChanges = true;
        } else if (!sessionsEqual(oldSession, session)) {
          changes.updated.push({ old: oldSession, new: session });
          changes.hasChanges = true;
        }
      }
      
      // æŸ¥æ‰¾åˆ é™¤çš„ä¼šè¯
      for (const [startTime, session] of oldMap) {
        if (!newMap.has(startTime)) {
          changes.removed.push(session);
          changes.hasChanges = true;
        }
      }
      
      return changes;
    }
    
    /**
     * åº”ç”¨å¢é‡å˜åŒ–åˆ°DOM
     */
    function applyIncrementalChanges(container, changes, studentName) {
      dbg(`ğŸ”„ å¢é‡æ›´æ–°æ—¶é—´è½´: +${changes.added.length} ~${changes.updated.length} -${changes.removed.length}`);
      
      // åˆ é™¤å·²ç§»é™¤çš„ä¼šè¯
      changes.removed.forEach(session => {
        const item = container.querySelector(`[data-session-start="${session.start}"]`);
        if (item) {
          item.style.animation = 'timelineFadeOut 0.3s ease-out';
          setTimeout(() => item.remove(), 300);
        }
      });
      
      // æ›´æ–°å·²å­˜åœ¨çš„ä¼šè¯
      changes.updated.forEach(({ old, new: session }) => {
        let item = container.querySelector(`[data-session-start="${session.start}"]`);
        // å¦‚æœ DOM ä¸­ç¼ºå¤±ï¼ˆå¯èƒ½å› ä¸ºå…ˆå‰åˆ‡æ¢å­¦ç”Ÿå¯¼è‡´æ¸…ç©ºï¼‰ï¼Œè¡¥å»ºä¸ºæ–°å¢
        if (!item) {
          dbg(`âš ï¸ ç¼ºå¤±çš„å·²å­˜åœ¨ä¼šè¯èŠ‚ç‚¹ï¼Œè¡¥å»º: ${session.start}`);
          const sessionElement = createSessionElement(session, studentName);
          insertSessionInOrder(container, sessionElement, session);
          return;
        }
        updateSessionItem(item, session, studentName);
      });
      
      // æ·»åŠ æ–°ä¼šè¯ï¼ˆæ’å…¥åˆ°æ­£ç¡®ä½ç½®ï¼‰
      changes.added.forEach(session => {
        const sessionElement = createSessionElement(session, studentName);
        insertSessionInOrder(container, sessionElement, session);
      });

      // é˜²æŠ¤ï¼šè‹¥æœ‰æ•°æ®å´ç©º DOMï¼Œè§¦å‘ä¸€æ¬¡å®Œæ•´é‡å»º
      queueMicrotask(()=>{
        const totalSessions = (timelineCache.get(studentName)?.sessions || []).length;
        const domCount = container.querySelectorAll('.timeline-item').length;
        if(totalSessions>0 && domCount===0){
          console.warn('âš ï¸ æ—¶é—´è½´ DOM ä¸¢å¤±ï¼Œæ‰§è¡Œå›é€€é‡å»º', { totalSessions });
          updateTodayTimelineFull(studentName);
        }
      });
    }
    
    /**
     * åˆ›å»ºä¼šè¯å…ƒç´ 
     */
    function createSessionElement(session, studentName) {
      const isOngoing = !session.end;
      const startTime = new Date(session.start).toLocaleTimeString('zh-CN', { hour:'2-digit', minute:'2-digit' });
      const endTime = isOngoing ? 'è¿›è¡Œä¸­' : new Date(session.end).toLocaleTimeString('zh-CN', { hour:'2-digit', minute:'2-digit' });
  const duration = isOngoing ? 0 : Math.round((new Date(session.end) - new Date(session.start)) / 60000);
      
      dbg(`ğŸ  åˆ›å»ºæ—¶é—´è½´å…ƒç´  - æˆ¿é—´ä¿¡æ¯: session.room="${session.room || 'æ— '}", session.roomName="${session.roomName || 'æ— '}"`);
      
      
      const isInSchedule = isSessionInSchedule(session, studentName);
      const scheduleClass = isInSchedule ? 'in-schedule' : 'out-schedule';
      const ongoingClass = isOngoing ? 'ongoing' : '';
      
      const div = document.createElement('div');
      div.className = `timeline-item ${scheduleClass} ${ongoingClass} timeline-item-new`;
      div.setAttribute('data-session-start', session.start);
      div.setAttribute('data-is-ongoing', isOngoing);
      
      div.innerHTML = `
        <div class="timeline-time">${startTime} - ${endTime}</div>
        <div class="timeline-duration ${isOngoing ? 'live-duration' : ''}" 
             data-start-timestamp="${new Date(session.start).getTime()}">
          ${isOngoing ? '0åˆ†é’Ÿâ±ï¸' : utils.formatDuration(duration)}
        </div>
        ${session.room ? `<div class="timeline-room">${session.room}</div>` : ''}
      `;
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      div.addEventListener('click', (e) => {
        e.stopPropagation();
        div.classList.toggle('selected');
      });
      
      return div;
    }
    
    /**
     * æŒ‰æ—¶é—´é¡ºåºæ’å…¥ä¼šè¯å…ƒç´ 
     */
    function insertSessionInOrder(container, element, session) {
      const sessionStart = new Date(session.start).getTime();
      const existingItems = Array.from(container.querySelectorAll('.timeline-item'));
      
      let insertIndex = existingItems.length;
      for (let i = 0; i < existingItems.length; i++) {
        const itemStart = new Date(existingItems[i].getAttribute('data-session-start')).getTime();
        if (sessionStart < itemStart) {
          insertIndex = i;
          break;
        }
      }
      
      if (insertIndex < existingItems.length) {
        container.insertBefore(element, existingItems[insertIndex]);
      } else {
        container.appendChild(element);
      }
      
      // æ·¡å…¥åŠ¨ç”»
      element.style.animation = 'timelineFadeIn 0.5s ease-out';
    }
    
    /**
     * åªæ›´æ–°æ­£åœ¨è¿›è¡Œçš„ä¼šè¯æ—¶é•¿
     */
    function updateOngoingSessionsOnly(container) {
      const ongoingItems = container.querySelectorAll('.timeline-item[data-is-ongoing="true"]');
      const now = Date.now();
      
      ongoingItems.forEach(item => {
        const startTimestamp = parseInt(item.getAttribute('data-session-start'));
        if (Number.isFinite(new Date(startTimestamp).getTime())) {
          const durationMs = now - new Date(startTimestamp).getTime();
          const durationMinutes = Math.max(0, Math.round(durationMs / 60000));
          
          const durationEl = item.querySelector('.live-duration');
          if (durationEl) {
            const newText = utils.formatDuration(durationMinutes);
            durationEl.textContent = `${newText}â±ï¸`;
          }
        }
      });
    }
    
    // è¾…åŠ©å‡½æ•°
    function arraysEqual(a, b) {
      if (!a || !b || a.length !== b.length) return false;
      return a.every((item, index) => sessionsEqual(item, b[index]));
    }
    
    function sessionsEqual(a, b) {
      return a.start === b.start && a.end === b.end && a.room === b.room;
    }
    
    function updateSessionItem(item, session, studentName) {
      const isOngoing = !session.end;
      const startTime = new Date(session.start).toLocaleTimeString('zh-CN', { hour:'2-digit', minute:'2-digit' });
      const endTime = isOngoing ? 'è¿›è¡Œä¸­' : new Date(session.end).toLocaleTimeString('zh-CN', { hour:'2-digit', minute:'2-digit' });
      const duration = isOngoing ? 0 : Math.round((new Date(session.end) - new Date(session.start)) / 60000);
      
      const timeEl = item.querySelector('.timeline-time');
      const durationEl = item.querySelector('.timeline-duration');
      
      if (timeEl) timeEl.textContent = `${startTime} - ${endTime}`;
      if (durationEl) {
        durationEl.textContent = `${utils.formatDuration(duration)}${isOngoing ? 'â±ï¸' : ''}`;
        durationEl.className = `timeline-duration ${isOngoing ? 'live-duration' : ''}`;
      }
      
      item.setAttribute('data-is-ongoing', isOngoing);
      item.className = item.className.replace(/\b(ongoing|in-schedule|out-schedule)\b/g, '');
      
      const isInSchedule = isSessionInSchedule(session, studentName);
      const scheduleClass = isInSchedule ? 'in-schedule' : 'out-schedule';
      const ongoingClass = isOngoing ? 'ongoing' : '';
      item.className += ` ${scheduleClass} ${ongoingClass}`;
    }

    // ========== ğŸŒ WebSocketç›´è¿ä¼˜åŒ– ==========
    
    // æ—¶é—´è½´ä¸“ç”¨WebSocketè¿æ¥
    let timelineWebSocket = null;
    let wsReconnectAttempts = 0;
    const WS_MAX_RECONNECT_ATTEMPTS = 3;
    const WS_RECONNECT_DELAY_BASE = 1000;
    
    /**
     * å»ºç«‹æ—¶é—´è½´ä¸“ç”¨WebSocketè¿æ¥
     */
    function setupTimelineWebSocket() {
      if (!isConnected || timelineWebSocket?.readyState === WebSocket.OPEN) return;
      
      try {
        // æ„å»ºWebSocket URLï¼ˆåŸºäºSupabase URLï¼‰
        const wsUrl = SUPABASE_URL.replace('https://', 'wss://') + '/realtime/v1/websocket';
        const wsParams = new URLSearchParams({
          apikey: SUPABASE_KEY,
          vsn: '1.0.0'
        });
        
        timelineWebSocket = new WebSocket(`${wsUrl}?${wsParams}`);
        
        timelineWebSocket.onopen = () => {
          dbg('ğŸŒ æ—¶é—´è½´WebSocketè¿æ¥å·²å»ºç«‹');
          wsReconnectAttempts = 0;
          
          // ğŸŒ è®¢é˜…å¤šè¡¨å®æ—¶å˜æ›´
          const tables = ['practice_logs', 'student_time_slots', 'rooms', 'student_database'];
          
          tables.forEach(tableName => {
            const subscribeMsg = {
              topic: `realtime:public:${tableName}`,
              event: 'phx_join',
              payload: {},
              ref: `${tableName}_${Date.now()}`
            };
            
            timelineWebSocket.send(JSON.stringify(subscribeMsg));
            dbg(`ğŸŒ å·²è®¢é˜…è¡¨: ${tableName}`);
          });
          
          // å®šæœŸå‘é€å¿ƒè·³
          setInterval(() => {
            if (timelineWebSocket?.readyState === WebSocket.OPEN) {
              timelineWebSocket.send(JSON.stringify({
                topic: 'phoenix',
                event: 'heartbeat',
                payload: {},
                ref: 'heartbeat_' + Date.now()
              }));
            }
          }, 30000);
        };
        
        timelineWebSocket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleMultiTableWebSocketMessage(data);
          } catch (error) {
            dbg('WebSocketæ¶ˆæ¯è§£æå¤±è´¥:', error);
          }
        };
        
        timelineWebSocket.onclose = () => {
          dbg('ğŸŒ æ—¶é—´è½´WebSocketè¿æ¥å·²å…³é—­');
          attemptWebSocketReconnect();
        };
        
        timelineWebSocket.onerror = (error) => {
          dbg('ğŸŒ æ—¶é—´è½´WebSocketé”™è¯¯:', error);
          attemptWebSocketReconnect();
        };
        
      } catch (error) {
        dbg('WebSocketåˆ›å»ºå¤±è´¥:', error);
        attemptWebSocketReconnect();
      }
    }
    
    /**
     * å¤„ç†å¤šè¡¨WebSocketæ¶ˆæ¯
     */
    function handleMultiTableWebSocketMessage(data) {
      if (data.event === 'postgres_changes' && data.payload) {
        const { eventType, new: newRecord, old: oldRecord, table } = data.payload;
        
        dbg('ğŸš€ WebSocketå¤šè¡¨å®æ—¶æ›´æ–°:', { table, eventType });
        
        // æ ¹æ®è¡¨ç±»å‹åˆ†å‘å¤„ç†
        switch (table) {
          case 'practice_logs':
            handlePracticeLogsWebSocket(eventType, newRecord, oldRecord);
            break;
            
          case 'student_time_slots':
            handleStudentSlotsWebSocket(eventType, newRecord, oldRecord);
            break;
            
          case 'rooms':
            handleRoomsWebSocket(eventType, newRecord, oldRecord);
            break;
            
          case 'student_database':
            handleStudentDatabaseWebSocket(eventType, newRecord, oldRecord);
            break;
            
          default:
            dbg('æœªçŸ¥è¡¨å˜æ›´:', table);
        }
      }
    }
    
    /**
     * å¤„ç†ç»ƒç´è®°å½•WebSocketæ¶ˆæ¯
     */
    function handlePracticeLogsWebSocket(eventType, newRecord, oldRecord) {
      const studentName = newRecord?.student_name || oldRecord?.student_name;
      const action = newRecord?.action || oldRecord?.action;
      
      dbg('ï¿½ ç»ƒç´è®°å½•å®æ—¶æ›´æ–°:', { eventType, studentName, action });
      
      // å¦‚æœæ˜¯å½“å‰æŸ¥çœ‹çš„å­¦ç”Ÿï¼Œç«‹å³æ›´æ–°æ—¶é—´è½´
      if (uiState.view === 'detail' && uiState.currentStudent === studentName) {
        setTimeout(() => {
          updateTimelineIncremental(studentName);
          showTimelineNotification(action, studentName);
        }, 100);
      }
      
      // æ›´æ–°å…¶ä»–ç›¸å…³UIç»„ä»¶
      if (action === 'assign' || action === 'clear' || action === 'enter' || action === 'exit') {
        updateStudentStatusOptimistic(studentName, action);
      }
    }
    
    /**
     * å¤„ç†å­¦ç”Ÿæ—¶é—´æ®µWebSocketæ¶ˆæ¯
     */
    function handleStudentSlotsWebSocket(eventType, newRecord, oldRecord) {
      const studentName = newRecord?.student_name || oldRecord?.student_name;
      
      dbg('ğŸ“… å­¦ç”Ÿæ—¶é—´æ®µå®æ—¶æ›´æ–°:', { eventType, studentName });
      
      // ç«‹å³æ›´æ–°å­¦ç”Ÿæ—¶é—´æ®µ
      setTimeout(() => {
        updateStudentSlotsIncremental(studentName, newRecord);
        showToast(`${studentName} çš„ç»ƒç´æ—¶é—´æ®µå·²${eventType === 'DELETE' ? 'åˆ é™¤' : 'æ›´æ–°'}`);
      }, 100);
    }
    
    /**
     * å¤„ç†æˆ¿é—´çŠ¶æ€WebSocketæ¶ˆæ¯
     */
    function handleRoomsWebSocket(eventType, newRecord, oldRecord) {
      const roomName = newRecord?.name || oldRecord?.name;
      
      dbg('ğŸ  æˆ¿é—´çŠ¶æ€å®æ—¶æ›´æ–°:', { eventType, roomName });
      
      // ç«‹å³æ›´æ–°æˆ¿é—´çŠ¶æ€
      setTimeout(() => {
        updateRoomStatusIncremental(roomName, newRecord);
      }, 100);
    }
    
    /**
     * å¤„ç†å­¦ç”Ÿä¿¡æ¯WebSocketæ¶ˆæ¯
     */
    function handleStudentDatabaseWebSocket(eventType, newRecord, oldRecord) {
      const studentName = newRecord?.name || oldRecord?.name;
      
      dbg('ğŸ‘¥ å­¦ç”Ÿä¿¡æ¯å®æ—¶æ›´æ–°:', { eventType, studentName });
      
      // ç«‹å³æ›´æ–°å­¦ç”Ÿä¿¡æ¯
      setTimeout(() => {
        updateStudentInfoIncremental(studentName, newRecord);
      }, 100);
    }
    
    /**
     * WebSocketé‡è¿æœºåˆ¶
     */
    function attemptWebSocketReconnect() {
      if (wsReconnectAttempts >= WS_MAX_RECONNECT_ATTEMPTS) {
        dbg('WebSocketé‡è¿æ¬¡æ•°è¶…é™ï¼Œåœæ­¢é‡è¿');
        return;
      }
      
      wsReconnectAttempts++;
      const delay = WS_RECONNECT_DELAY_BASE * Math.pow(2, wsReconnectAttempts - 1);
      
      dbg(`WebSocketé‡è¿ç¬¬${wsReconnectAttempts}æ¬¡ï¼Œ${delay}msåé‡è¯•`);
      
      setTimeout(() => {
        if (isPageVisible && navigator.onLine) {
          setupTimelineWebSocket();
        }
      }, delay);
    }
    
    /**
     * æ˜¾ç¤ºæ—¶é—´è½´å®æ—¶æ›´æ–°é€šçŸ¥
     */
    function showTimelineNotification(action, studentName) {
      const actionText = {
        'assign': 'å¼€å§‹ç»ƒç´',
        'clear': 'ç»“æŸç»ƒç´',
        'enter': 'è¿›å…¥ç´æˆ¿',
        'exit': 'ç¦»å¼€ç´æˆ¿'
      };
      
      const text = actionText[action] || 'çŠ¶æ€å˜æ›´';
      showToast(`${studentName} ${text}`);
    }

    // ========== ğŸ”® æœ¬åœ°çŠ¶æ€é¢„æµ‹æœºåˆ¶ ==========
    
    // é¢„æµ‹çŠ¶æ€ç¼“å­˜
    const optimisticUpdates = new Map(); // key -> { type, data, timestamp, confirmed }
    
    /**
     * ä¹è§‚æ›´æ–°å­¦ç”ŸçŠ¶æ€
     * @param {string} studentName å­¦ç”Ÿå§“å
     * @param {string} action æ“ä½œç±»å‹ (assign/clear/enter/exit)
     * @param {string} roomName æˆ¿é—´åç§°ï¼ˆå¯é€‰ï¼‰
     */
    function updateStudentStatusOptimistic(studentName, action, roomName = null) {
      const updateId = `${studentName}_${action}_${Date.now()}`;
      const predictedLog = {
        student_name: studentName,
        action: action,
        room_name: roomName,
        timestamp: new Date().toISOString(),
        optimistic: true
      };
      
      // è®°å½•ä¹è§‚æ›´æ–°
      optimisticUpdates.set(updateId, {
        type: 'practice_log',
        data: predictedLog,
        timestamp: Date.now(),
        confirmed: false
      });
      
      dbg(`ğŸ”® ä¹è§‚æ›´æ–°: ${studentName} ${action}${roomName ? ` (${roomName})` : ''}`);
      
      // ç«‹å³æ›´æ–°æ—¶é—´è½´ï¼ˆå¦‚æœæ˜¯å½“å‰å­¦ç”Ÿï¼‰
      if (uiState.view === 'detail' && uiState.currentStudent === studentName) {
        // ä¸´æ—¶æ·»åŠ åˆ°æ—¥å¿—æ•°æ®ä¸­
        const tempLogs = [...(appState.practiceLogs || []), predictedLog];
        const tempNormalized = [...(appState.practiceLogsNormalized || []), predictedLog];
        
        // å¤‡ä»½åŸå§‹æ•°æ®
        const originalLogs = appState.practiceLogs;
        const originalNormalized = appState.practiceLogsNormalized;
        
        // ä¸´æ—¶è®¾ç½®é¢„æµ‹æ•°æ®
        appState.practiceLogs = tempLogs;
        appState.practiceLogsNormalized = tempNormalized;
        
        // æ›´æ–°æ—¶é—´è½´
        updateTimelineIncremental(studentName, predictedLog);
        
        // æ·»åŠ é¢„æµ‹çŠ¶æ€æ ·å¼
        setTimeout(() => {
          addOptimisticStyles(updateId);
        }, 100);
        
        // æ¢å¤åŸå§‹æ•°æ®ï¼ˆç­‰å¾…æœåŠ¡å™¨ç¡®è®¤ï¼‰
        setTimeout(() => {
          appState.practiceLogs = originalLogs;
          appState.practiceLogsNormalized = originalNormalized;
        }, 1000);
      }
      
      // æ›´æ–°é¦–é¡µçŠ¶æ€ï¼ˆæˆ¿é—´å ç”¨æƒ…å†µç­‰ï¼‰
      updateHomeStatusOptimistic(studentName, action, roomName);
      
      // è®¾ç½®ç¡®è®¤è¶…æ—¶
      setTimeout(() => {
        confirmOptimisticUpdate(updateId);
      }, 5000); // 5ç§’åè®¤ä¸ºå·²ç¡®è®¤
    }
    
    /**
     * æ·»åŠ ä¹è§‚æ›´æ–°çš„è§†è§‰æ ·å¼
     */
    function addOptimisticStyles(updateId) {
      const container = document.getElementById('todayTimeline');
      if (!container) return;
      
      const latestItem = container.querySelector('.timeline-item:last-child');
      if (latestItem && !latestItem.hasAttribute('data-optimistic')) {
        latestItem.setAttribute('data-optimistic', updateId);
        latestItem.style.borderLeft = '3px solid #f59e0b';
        latestItem.style.background = 'rgba(245, 158, 11, 0.1)';
        
        // æ·»åŠ "é¢„æµ‹ä¸­"æ ‡è¯†
        const timeEl = latestItem.querySelector('.timeline-time');
        if (timeEl && !timeEl.textContent.includes('â³')) {
          timeEl.textContent += ' â³';
        }
      }
    }
    
    /**
     * ç¡®è®¤ä¹è§‚æ›´æ–°
     */
    function confirmOptimisticUpdate(updateId) {
      const update = optimisticUpdates.get(updateId);
      if (!update) return;
      
      update.confirmed = true;
      dbg(`âœ… ä¹è§‚æ›´æ–°å·²ç¡®è®¤: ${updateId}`);
      
      // ç§»é™¤é¢„æµ‹æ ·å¼
      const container = document.getElementById('todayTimeline');
      if (container) {
        const item = container.querySelector(`[data-optimistic="${updateId}"]`);
        if (item) {
          item.removeAttribute('data-optimistic');
          item.style.borderLeft = '';
          item.style.background = '';
          
          // ç§»é™¤é¢„æµ‹æ ‡è¯†
          const timeEl = item.querySelector('.timeline-time');
          if (timeEl) {
            timeEl.textContent = timeEl.textContent.replace(' â³', '');
          }
          
          // æ·»åŠ ç¡®è®¤åŠ¨ç”»
          item.style.animation = 'confirmUpdate 0.6s ease-out';
        }
      }
      
      // æ¸…ç†è¿‡æœŸçš„ä¹è§‚æ›´æ–°
      setTimeout(() => {
        optimisticUpdates.delete(updateId);
      }, 30000);
    }
    
    /**
     * å›æ»šå¤±è´¥çš„ä¹è§‚æ›´æ–°
     */
    function rollbackOptimisticUpdate(updateId, reason = 'æ“ä½œå¤±è´¥') {
      const update = optimisticUpdates.get(updateId);
      if (!update) return;
      
      dbg(`âŒ ä¹è§‚æ›´æ–°å›æ»š: ${updateId} - ${reason}`);
      
      // ç§»é™¤é¢„æµ‹çš„æ—¶é—´è½´é¡¹
      const container = document.getElementById('todayTimeline');
      if (container) {
        const item = container.querySelector(`[data-optimistic="${updateId}"]`);
        if (item) {
          item.style.animation = 'rollbackUpdate 0.4s ease-out';
          setTimeout(() => {
            item.remove();
          }, 400);
        }
      }
      
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      showToast(`æ“ä½œå¤±è´¥: ${reason}`, 'error');
      
      optimisticUpdates.delete(updateId);
    }
    
    /**
     * ä¹è§‚æ›´æ–°é¦–é¡µçŠ¶æ€
     */
    function updateHomeStatusOptimistic(studentName, action, roomName) {
      if (uiState.view !== 'home') return;
      
      // æ›´æ–°ç»ƒç´ä¸­äººæ•°æ˜¾ç¤º
      const practicingCountEl = document.querySelector('.stat-value[data-stat="practicing"]');
      if (practicingCountEl) {
        const currentCount = parseInt(practicingCountEl.textContent) || 0;
        let newCount = currentCount;
        
        if (action === 'assign' || action === 'enter') {
          newCount = Math.max(0, currentCount + 1);
        } else if (action === 'clear' || action === 'exit') {
          newCount = Math.max(0, currentCount - 1);
        }
        
        if (newCount !== currentCount) {
          practicingCountEl.textContent = newCount;
          practicingCountEl.style.animation = 'statUpdate 0.5s ease-out';
        }
      }
      
      // æ›´æ–°æˆ¿é—´çŠ¶æ€ï¼ˆå¦‚æœæœ‰æˆ¿é—´ä¿¡æ¯ï¼‰
      if (roomName) {
        const roomCards = document.querySelectorAll('.student-card');
        roomCards.forEach(card => {
          if (card.textContent.includes(roomName)) {
            const statusEl = card.querySelector('.student-status');
            if (statusEl) {
              const isAssign = action === 'assign' || action === 'enter';
              statusEl.textContent = isAssign ? 'ç»ƒç´ä¸­' : 'ç©ºé—²';
              statusEl.className = `student-status ${isAssign ? 'practicing-in' : 'offline'}`;
            }
          }
        });
      }
    }
    
    /**
     * é¢„æµ‹æ€§æœç´¢å’Œè¿‡æ»¤
     */
    function optimisticFilter(query, currentResults) {
      // å®¢æˆ·ç«¯é¢„æµ‹æœç´¢ç»“æœï¼Œå‡å°‘ç­‰å¾…æ—¶é—´
      if (!query.trim()) return currentResults;
      
      const predicted = currentResults.filter(item => {
        const name = item.name || item.student_name || '';
        const major = item.major || '';
        const room = item.room || item.room_name || '';
        
        return name.toLowerCase().includes(query.toLowerCase()) ||
               major.toLowerCase().includes(query.toLowerCase()) ||
               room.toLowerCase().includes(query.toLowerCase());
      });
      
      dbg(`ğŸ”® é¢„æµ‹æœç´¢: "${query}" -> ${predicted.length} ç»“æœ`);
      return predicted;
    }
    
    // ========== ğŸ”® å¤šè¡¨ä¹è§‚é¢„æµ‹æ‰©å±• ==========
    
    /**
     * ä¹è§‚æ›´æ–°å­¦ç”Ÿæ—¶é—´æ®µ
     * @param {string} studentName å­¦ç”Ÿå§“å
     * @param {number} weekday æ˜ŸæœŸå‡  (1-7)
     * @param {Object} timeSlot æ—¶é—´æ®µå¯¹è±¡ {start_time, end_time}
     * @param {string} operation æ“ä½œç±»å‹ (add/update/delete)
     */
    function updateStudentSlotsOptimistic(studentName, weekday, timeSlot, operation) {
      const updateId = `slots_${studentName}_${weekday}_${Date.now()}`;
      
      const predictedSlot = {
        student_name: studentName,
        weekday: weekday,
        start_time: timeSlot.start_time,
        end_time: timeSlot.end_time,
        operation: operation,
        optimistic: true
      };
      
      // è®°å½•ä¹è§‚æ›´æ–°
      optimisticUpdates.set(updateId, {
        type: 'student_time_slots',
        data: predictedSlot,
        timestamp: Date.now(),
        confirmed: false
      });
      
      dbg(`ğŸ”® ä¹è§‚æ›´æ–°æ—¶é—´æ®µ: ${studentName} æ˜ŸæœŸ${weekday} ${operation}`);
      
      // ç«‹å³æ›´æ–°UI
      applySlotOptimisticUpdate(studentName, weekday, timeSlot, operation, updateId);
      
      // è®¾ç½®ç¡®è®¤è¶…æ—¶
      setTimeout(() => {
        confirmOptimisticUpdate(updateId);
      }, 5000);
      
      return updateId;
    }
    
    /**
     * ä¹è§‚æ›´æ–°æˆ¿é—´çŠ¶æ€
     * @param {string} roomName æˆ¿é—´åç§°
     * @param {string} studentName å­¦ç”Ÿå§“åï¼ˆå¯é€‰ï¼‰
     * @param {string} operation æ“ä½œç±»å‹ (occupy/release)
     */
    function updateRoomStatusOptimistic(roomName, studentName = null, operation) {
      const updateId = `room_${roomName}_${Date.now()}`;
      
      const predictedRoom = {
        name: roomName,
        occupant_student_name: operation === 'occupy' ? studentName : null,
        heartbeat_at: new Date().toISOString(),
        operation: operation,
        optimistic: true
      };
      
      // è®°å½•ä¹è§‚æ›´æ–°
      optimisticUpdates.set(updateId, {
        type: 'rooms',
        data: predictedRoom,
        timestamp: Date.now(),
        confirmed: false
      });
      
      dbg(`ğŸ”® ä¹è§‚æ›´æ–°æˆ¿é—´: ${roomName} ${operation}${studentName ? ` by ${studentName}` : ''}`);
      
      // ç«‹å³æ›´æ–°UI
      applyRoomOptimisticUpdate(roomName, studentName, operation, updateId);
      
      // è®¾ç½®ç¡®è®¤è¶…æ—¶
      setTimeout(() => {
        confirmOptimisticUpdate(updateId);
      }, 5000);
      
      return updateId;
    }
    
    /**
     * ä¹è§‚æ›´æ–°å­¦ç”ŸåŸºç¡€ä¿¡æ¯
     * @param {string} studentName å­¦ç”Ÿå§“å
     * @param {Object} changes å˜æ›´å†…å®¹ {major?, grade?, archived?}
     */
    function updateStudentInfoOptimistic(studentName, changes) {
      const updateId = `student_${studentName}_${Date.now()}`;
      
      const predictedStudent = {
        name: studentName,
        ...changes,
        updated_at: new Date().toISOString(),
        optimistic: true
      };
      
      // è®°å½•ä¹è§‚æ›´æ–°
      optimisticUpdates.set(updateId, {
        type: 'student_database',
        data: predictedStudent,
        timestamp: Date.now(),
        confirmed: false
      });
      
      dbg(`ğŸ”® ä¹è§‚æ›´æ–°å­¦ç”Ÿä¿¡æ¯: ${studentName}`, changes);
      
      // ç«‹å³æ›´æ–°UI
      applyStudentInfoOptimisticUpdate(studentName, changes, updateId);
      
      // è®¾ç½®ç¡®è®¤è¶…æ—¶
      setTimeout(() => {
        confirmOptimisticUpdate(updateId);
      }, 5000);
      
      return updateId;
    }
    
    // ========== UIåº”ç”¨å‡½æ•° ==========
    
    /**
     * åº”ç”¨æ—¶é—´æ®µä¹è§‚æ›´æ–°åˆ°UI
     */
    function applySlotOptimisticUpdate(studentName, weekday, timeSlot, operation, updateId) {
      // æ›´æ–°æ—¶é—´æ®µå¼¹çª—ï¼ˆå¦‚æœæ­£åœ¨æ˜¾ç¤ºï¼‰
      const modal = document.querySelector('.modal-overlay');
      if (modal && !modal.hidden) {
        const weekdayEl = modal.querySelector(`[data-weekday="${weekday}"]`);
        if (weekdayEl) {
          weekdayEl.style.background = 'rgba(245, 158, 11, 0.1)';
          weekdayEl.setAttribute('data-optimistic', updateId);
          
          // æ·»åŠ é¢„æµ‹æ ‡è¯†
          const indicator = document.createElement('span');
          indicator.className = 'optimistic-indicator';
          indicator.textContent = 'â³';
          indicator.style.color = '#f59e0b';
          weekdayEl.appendChild(indicator);
        }
      }
      
      // å¦‚æœå½“å‰åœ¨å­¦ç”Ÿè¯¦æƒ…é¡µï¼Œæ›´æ–°æ—¶é—´æ®µæ˜¾ç¤º
      if (uiState.view === 'detail' && uiState.currentStudent === studentName) {
        updateStudentDetailSlotsOptimistic(studentName, weekday, operation, updateId);
      }
    }
    
    /**
     * åº”ç”¨æˆ¿é—´ä¹è§‚æ›´æ–°åˆ°UI
     */
    function applyRoomOptimisticUpdate(roomName, studentName, operation, updateId) {
      // æ›´æ–°é¦–é¡µæˆ¿é—´å¡ç‰‡
      const homeCards = document.querySelectorAll('.student-card');
      homeCards.forEach(card => {
        if (card.textContent.includes(roomName)) {
          card.style.background = 'rgba(245, 158, 11, 0.1)';
          card.setAttribute('data-optimistic', updateId);
          
          const statusEl = card.querySelector('.student-status');
          if (statusEl) {
            const isOccupied = operation === 'occupy';
            statusEl.textContent = isOccupied ? 'ç»ƒç´ä¸­ â³' : 'ç©ºé—² â³';
            statusEl.className = `student-status ${isOccupied ? 'practicing-in' : 'offline'}`;
          }
        }
      });
      
      // æ›´æ–°ç»Ÿè®¡æ•°å­—
      if (operation === 'occupy' || operation === 'release') {
        updatePracticingCountOptimistic(operation === 'occupy' ? 1 : -1);
      }
    }
    
    /**
     * åº”ç”¨å­¦ç”Ÿä¿¡æ¯ä¹è§‚æ›´æ–°åˆ°UI
     */
    function applyStudentInfoOptimisticUpdate(studentName, changes, updateId) {
      // æ›´æ–°é¦–é¡µå­¦ç”Ÿå¡ç‰‡
      const homeCards = document.querySelectorAll('.student-card');
      homeCards.forEach(card => {
        const nameEl = card.querySelector('.student-name');
        if (nameEl && nameEl.textContent.includes(studentName)) {
          card.style.background = 'rgba(245, 158, 11, 0.1)';
          card.setAttribute('data-optimistic', updateId);
          
          // æ›´æ–°ä¸“ä¸šå’Œå¹´çº§æ˜¾ç¤º
          if (changes.major) {
            const majorEl = card.querySelector('.student-major');
            if (majorEl) majorEl.textContent = changes.major + ' â³';
          }
          
          if (changes.grade) {
            const gradeEl = card.querySelector('.student-grade');
            if (gradeEl) gradeEl.textContent = changes.grade + ' â³';
          }
          
          // å½’æ¡£çŠ¶æ€
          if (changes.archived !== undefined) {
            card.style.opacity = changes.archived ? '0.5' : '1';
            if (changes.archived) {
              const archivedBadge = document.createElement('div');
              archivedBadge.className = 'archived-badge';
              archivedBadge.textContent = 'å·²å½’æ¡£ â³';
              card.appendChild(archivedBadge);
            }
          }
        }
      });
      
      // å¦‚æœå½“å‰åœ¨å­¦ç”Ÿè¯¦æƒ…é¡µï¼Œæ›´æ–°è¯¦æƒ…ä¿¡æ¯
      if (uiState.view === 'detail' && uiState.currentStudent === studentName) {
        updateStudentDetailInfoOptimistic(studentName, changes, updateId);
      }
    }
    
    /**
     * ä¹è§‚æ›´æ–°ç»ƒç´ä¸­äººæ•°ç»Ÿè®¡
     */
    function updatePracticingCountOptimistic(delta) {
      const countEl = document.querySelector('.stat-value[data-stat="practicing"]');
      if (countEl) {
        const currentCount = parseInt(countEl.textContent) || 0;
        const newCount = Math.max(0, currentCount + delta);
        countEl.textContent = newCount;
        countEl.style.animation = 'statUpdate 0.5s ease-out';
        countEl.style.color = '#f59e0b'; // é¢„æµ‹çŠ¶æ€é¢œè‰²
      }
    }

    // ========== ğŸ“… å­¦ç”Ÿæ—¶é—´æ®µå¢é‡æ›´æ–° ==========
    
    /**
     * å¢é‡æ›´æ–°å­¦ç”Ÿæ—¶é—´æ®µæ•°æ®
     * @param {string} studentName å­¦ç”Ÿå§“å
     * @param {Object} newSlotData æ–°çš„æ—¶é—´æ®µæ•°æ®
     */
    function updateStudentSlotsIncremental(studentName, newSlotData = null) {
      const cached = studentSlotsCache.get(studentName);
      const currentSlots = utils.getStudentTimeSlots(studentName) || {};
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
      if (cached && slotsEqual(cached.slots, currentSlots)) {
        return; // æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°
      }
      
      // è®¡ç®—æ—¶é—´æ®µå˜åŒ–
      const changes = calculateSlotsChanges(cached?.slots || {}, currentSlots);
      
      if (changes.hasChanges) {
        dbg(`ğŸ“… å­¦ç”Ÿæ—¶é—´æ®µå¢é‡æ›´æ–°: ${studentName}`, changes);
        
        // æ›´æ–°UIä¸­çš„æ—¶é—´æ®µæ˜¾ç¤º
        updateSlotsUI(studentName, changes);
        
        // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¯¥å­¦ç”Ÿè¯¦æƒ…ï¼Œå®æ—¶æ›´æ–°æ—¶é—´æ®µå¡ç‰‡
        if (uiState.view === 'detail' && uiState.currentStudent === studentName) {
          updateStudentDetailSlots(studentName, currentSlots);
        }
        
        // æ›´æ–°æ’è¡Œæ¦œè®¡ç®—ï¼ˆæ—¶é—´æ®µå˜åŒ–å½±å“è¯„åˆ†ï¼‰
        if (changes.affectsScoring) {
          invalidateStudentScoreCache(studentName);
        }
        
        // æ›´æ–°ç¼“å­˜
        studentSlotsCache.set(studentName, {
          slots: currentSlots,
          lastUpdate: Date.now()
        });

        // è§¦å‘ä¾èµ–è¿™äº›æ—¶æ®µçš„å½“å‰çŠ¶æ€/ç»Ÿè®¡é‡ç®—ï¼ˆé˜²æŠ–ï¼‰
        scheduleTimeSlotRecalc();

        // è‹¥å½“å‰æ‰“å¼€çš„å­¦ç”Ÿè¯¦æƒ… == æ­¤å­¦ç”Ÿ ä¸” å‘¨æ—¶æ®µå¼¹çª—å­˜åœ¨ï¼Œåˆ™åˆ·æ–°å…¶å†…å®¹
        try {
          if(uiState.view==='detail' && uiState.selectedStudent===studentName){
            const modal=document.querySelector('.lb-modal');
            if(modal && /æ¯å‘¨ç»ƒç´æ—¶æ®µ/.test(modal.textContent||'')){
              if(typeof closeScoreDetailModal==='function') closeScoreDetailModal();
              showWeekSlots(studentName);
            }
          }
        }catch(e){ console.warn('refresh week slots modal failed', e); }
      }
    }

    // ==== é˜²æŠ–é‡ç®—ï¼šæ—¶æ®µå˜åŒ–é›†ä¸­ 300ms å†…åªé‡ç®—ä¸€æ¬¡ ====
    let _slotRecalcTimer=null;
    function scheduleTimeSlotRecalc(){
      if(_slotRecalcTimer) clearTimeout(_slotRecalcTimer);
      _slotRecalcTimer=setTimeout(()=>{
        _slotRecalcTimer=null;
        try {
          if(typeof analyzeStudentData==='function') analyzeStudentData(appState.rooms||[]);
        }catch(e){ console.warn('time slot recalc error', e); }
      },300);
    }
    
    /**
     * è®¡ç®—æ—¶é—´æ®µå˜åŒ–
     */
    function calculateSlotsChanges(oldSlots, newSlots) {
      const changes = {
        added: {},
        updated: {},
        removed: {},
        hasChanges: false,
        affectsScoring: false
      };
      
      // æ£€æŸ¥æ¯ä¸ªæ˜ŸæœŸçš„å˜åŒ–
      for (let weekday = 1; weekday <= 7; weekday++) {
        const oldDaySlots = oldSlots[weekday] || [];
        const newDaySlots = newSlots[weekday] || [];
        
        if (!arraysEqual(oldDaySlots, newDaySlots)) {
          changes.hasChanges = true;
          changes.affectsScoring = true;
          
          if (oldDaySlots.length === 0 && newDaySlots.length > 0) {
            changes.added[weekday] = newDaySlots;
          } else if (oldDaySlots.length > 0 && newDaySlots.length === 0) {
            changes.removed[weekday] = oldDaySlots;
          } else {
            changes.updated[weekday] = { old: oldDaySlots, new: newDaySlots };
          }
        }
      }
      
      return changes;
    }
    
    /**
     * æ›´æ–°æ—¶é—´æ®µUIæ˜¾ç¤º
     */
    function updateSlotsUI(studentName, changes) {
      // æ›´æ–°é¦–é¡µå­¦ç”Ÿå¡ç‰‡ä¸­çš„æ—¶é—´æ®µä¿¡æ¯
      updateHomeStudentSlots(studentName, changes);
      
      // æ›´æ–°åˆ—è¡¨è§†å›¾ä¸­çš„æ—¶é—´æ®µæ˜¾ç¤º
      updateListStudentSlots(studentName, changes);
      
      // æ˜¾ç¤ºæ—¶é—´æ®µå˜æ›´é€šçŸ¥
      if (Object.keys(changes.added).length > 0) {
        showToast(`${studentName} æ–°å¢äº†ç»ƒç´æ—¶é—´æ®µ`);
      } else if (Object.keys(changes.removed).length > 0) {
        showToast(`${studentName} åˆ é™¤äº†ç»ƒç´æ—¶é—´æ®µ`);
      } else if (Object.keys(changes.updated).length > 0) {
        showToast(`${studentName} ä¿®æ”¹äº†ç»ƒç´æ—¶é—´æ®µ`);
      }
    }
    
    // ========== ğŸ  æˆ¿é—´çŠ¶æ€å¢é‡æ›´æ–° ==========
    
    /**
     * å¢é‡æ›´æ–°æˆ¿é—´çŠ¶æ€
     * @param {string} roomName æˆ¿é—´åç§°
     * @param {Object} newRoomData æ–°çš„æˆ¿é—´æ•°æ®
     */
    function updateRoomStatusIncremental(roomName, newRoomData = null) {
      const cached = roomsCache.get(roomName);
      const currentRoom = appState.rooms?.find(r => r.name === roomName) || {};
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
      if (cached && roomEqual(cached.info, currentRoom)) {
        return; // æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°
      }
      
      // è®¡ç®—æˆ¿é—´çŠ¶æ€å˜åŒ–
      const changes = calculateRoomChanges(cached?.info || {}, currentRoom);
      
      if (changes.hasChanges) {
        dbg(`ğŸ  æˆ¿é—´çŠ¶æ€å¢é‡æ›´æ–°: ${roomName}`, changes);
        
        // æ›´æ–°UIä¸­çš„æˆ¿é—´æ˜¾ç¤º
        updateRoomUI(roomName, changes, currentRoom);
        
        // æ›´æ–°ç¼“å­˜
        roomsCache.set(roomName, {
          info: currentRoom,
          lastUpdate: Date.now(),
          students: changes.occupantStudents || []
        });
      }
    }
    
    /**
     * è®¡ç®—æˆ¿é—´çŠ¶æ€å˜åŒ–
     */
    function calculateRoomChanges(oldRoom, newRoom) {
      const changes = {
        occupancyChanged: false,
        studentChanged: false,
        heartbeatChanged: false,
        hasChanges: false,
        occupantStudents: []
      };
      
      // æ£€æŸ¥å ç”¨çŠ¶æ€å˜åŒ–
      const oldOccupant = oldRoom.occupant_student_name;
      const newOccupant = newRoom.occupant_student_name;
      
      if (oldOccupant !== newOccupant) {
        changes.occupancyChanged = true;
        changes.studentChanged = true;
        changes.hasChanges = true;
        
        // æ”¯æŒå¤šäººç™»è®°ï¼šå°†é€—å·åˆ†éš”çš„å­¦ç”Ÿåå­—æ‹†åˆ†ä¸ºæ•°ç»„
        if (newOccupant) {
          const students = newOccupant.split(',').map(s => s.trim()).filter(s => s);
          changes.occupantStudents.push(...students);
        }
      }
      
      // æ£€æŸ¥å¿ƒè·³æ—¶é—´å˜åŒ–
      const oldHeartbeat = oldRoom.heartbeat_at;
      const newHeartbeat = newRoom.heartbeat_at;
      
      if (oldHeartbeat !== newHeartbeat) {
        changes.heartbeatChanged = true;
        changes.hasChanges = true;
      }
      
      return changes;
    }
    
    /**
     * æ›´æ–°æˆ¿é—´UIæ˜¾ç¤º
     */
    function updateRoomUI(roomName, changes, roomData) {
      // æ›´æ–°é¦–é¡µæˆ¿é—´çŠ¶æ€æ˜¾ç¤º
      updateHomeRoomStatus(roomName, changes, roomData);
      
      // æ›´æ–°å­¦ç”Ÿè¯¦æƒ…ä¸­çš„å½“å‰æˆ¿é—´ä¿¡æ¯ - æ”¯æŒå¤šäººç™»è®°
      if (changes.studentChanged && changes.occupantStudents.length > 0) {
        // ä¸ºæ¯ä¸ªå­¦ç”Ÿæ›´æ–°è¯¦æƒ…é¡µï¼ˆå¦‚æœæ­£åœ¨æŸ¥çœ‹è¯¥å­¦ç”Ÿï¼‰
        changes.occupantStudents.forEach(studentName => {
          if (uiState.view === 'detail' && uiState.currentStudent === studentName) {
            updateStudentDetailCurrentRoom(studentName, roomName);
          }
        });
      }
      
      // æ˜¾ç¤ºæˆ¿é—´çŠ¶æ€å˜æ›´é€šçŸ¥ - æ”¯æŒå¤šäººç™»è®°
      if (changes.occupancyChanged) {
        if (changes.occupantStudents.length > 0) {
          // å¤šäººç™»è®°æ˜¾ç¤º
          if (changes.occupantStudents.length === 1) {
            showToast(`${changes.occupantStudents[0]} è¿›å…¥ ${roomName}`);
          } else {
            showToast(`${changes.occupantStudents.length}äºº (${changes.occupantStudents.join('ã€')}) è¿›å…¥ ${roomName}`);
          }
        } else {
          showToast(`${roomName} å·²ç©ºé—²`);
        }
      }
    }
    
    // ========== ğŸ‘¥ å­¦ç”Ÿä¿¡æ¯å¢é‡æ›´æ–° ==========
    
    /**
     * å¢é‡æ›´æ–°å­¦ç”ŸåŸºç¡€ä¿¡æ¯
     * @param {string} studentName å­¦ç”Ÿå§“å
     * @param {Object} newStudentData æ–°çš„å­¦ç”Ÿæ•°æ®
     */
    function updateStudentInfoIncremental(studentName, newStudentData = null) {
      const cached = studentsCache.get(studentName);
      // appState.students æ˜¯ Map<name, studentData>
      let currentStudent = {};
      try {
        if(appState.students instanceof Map){
          currentStudent = appState.students.get(studentName) || {};
        } else if(Array.isArray(appState.students)) { // å…¼å®¹æ—©æœŸç»“æ„
          currentStudent = appState.students.find(s=>s.name===studentName) || {};
        }
      } catch(e){ console.warn('access student map failed', e); }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
      if (cached && studentEqual(cached.info, currentStudent)) {
        return; // æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°
      }
      
      // è®¡ç®—å­¦ç”Ÿä¿¡æ¯å˜åŒ–
      const changes = calculateStudentChanges(cached?.info || {}, currentStudent);
      
      if (changes.hasChanges) {
        dbg(`ğŸ‘¥ å­¦ç”Ÿä¿¡æ¯å¢é‡æ›´æ–°: ${studentName}`, changes);
        
        // æ›´æ–°UIä¸­çš„å­¦ç”Ÿä¿¡æ¯æ˜¾ç¤º
        updateStudentInfoUI(studentName, changes, currentStudent);
        
        // æ›´æ–°ç¼“å­˜
        studentsCache.set(studentName, {
          info: currentStudent,
          lastUpdate: Date.now()
        });
      }
    }

    // ==== æ•°æ®å®Œæ•´æ€§è¾…åŠ© ====
    if(!window.listIncompleteStudents){
      window.listIncompleteStudents = function(){
        const res=[]; if(!(appState.students instanceof Map)) return res;
        appState.students.forEach((s,name)=>{ if(!s || !s.grade || !s.major) res.push({name,major:s?.major,grade:s?.grade}); });
        return res;
      }
    }
    
    /**
     * è®¡ç®—å­¦ç”Ÿä¿¡æ¯å˜åŒ–
     */
    function calculateStudentChanges(oldStudent, newStudent) {
      const changes = {
        majorChanged: false,
        gradeChanged: false,
        archivedChanged: false,
        hasChanges: false
      };
      
      if (oldStudent.major !== newStudent.major) {
        changes.majorChanged = true;
        changes.hasChanges = true;
      }
      
      if (oldStudent.grade !== newStudent.grade) {
        changes.gradeChanged = true;
        changes.hasChanges = true;
      }
      
      if (oldStudent.archived !== newStudent.archived) {
        changes.archivedChanged = true;
        changes.hasChanges = true;
      }
      
      return changes;
    }
    
    /**
     * æ›´æ–°å­¦ç”Ÿä¿¡æ¯UIæ˜¾ç¤º
     */
    function updateStudentInfoUI(studentName, changes, studentData) {
      // æ›´æ–°é¦–é¡µå­¦ç”Ÿå¡ç‰‡
      updateHomeStudentInfo(studentName, changes, studentData);
      
      // æ›´æ–°åˆ—è¡¨è§†å›¾å­¦ç”Ÿä¿¡æ¯
      updateListStudentInfo(studentName, changes, studentData);
      
      // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¯¥å­¦ç”Ÿè¯¦æƒ…ï¼Œæ›´æ–°è¯¦æƒ…é¡µ
      if (uiState.view === 'detail' && uiState.currentStudent === studentName) {
        updateStudentDetailInfo(studentName, studentData);
      }
      
      // æ˜¾ç¤ºä¿¡æ¯å˜æ›´é€šçŸ¥
      if (changes.majorChanged || changes.gradeChanged) {
        showToast(`${studentName} çš„åŸºç¡€ä¿¡æ¯å·²æ›´æ–°`);
      }
      
      if (changes.archivedChanged) {
        if (studentData.archived) {
          showToast(`${studentName} å·²å½’æ¡£`, 'warning');
        } else {
          showToast(`${studentName} å·²å–æ¶ˆå½’æ¡£`);
        }
      }
    }
    
    // ========== è¾…åŠ©æ¯”è¾ƒå‡½æ•° ==========
    
    function slotsEqual(slots1, slots2) {
      if (!slots1 || !slots2) return slots1 === slots2;
      
      for (let weekday = 1; weekday <= 7; weekday++) {
        if (!arraysEqual(slots1[weekday] || [], slots2[weekday] || [])) {
          return false;
        }
      }
      return true;
    }
    
    function roomEqual(room1, room2) {
      // æ”¯æŒå¤šäººç™»è®°ï¼šæ¯”è¾ƒå ç”¨å­¦ç”Ÿåç§°ï¼ˆå¯èƒ½æ˜¯é€—å·åˆ†éš”çš„å¤šäººï¼‰
      const occupant1 = room1.occupant_student_name || '';
      const occupant2 = room2.occupant_student_name || '';
      
      // å¦‚æœéƒ½ä¸ºç©ºï¼Œåˆ™ç›¸ç­‰
      if (!occupant1 && !occupant2) return true;
      if (!occupant1 || !occupant2) return false;
      
      // å¯¹äºå¤šäººç™»è®°ï¼Œéœ€è¦æ¯”è¾ƒå­¦ç”Ÿåˆ—è¡¨æ˜¯å¦ç›¸åŒï¼ˆä¸è€ƒè™‘é¡ºåºï¼‰
      const students1 = occupant1.split(',').map(s => s.trim()).sort();
      const students2 = occupant2.split(',').map(s => s.trim()).sort();
      
      return students1.length === students2.length &&
             students1.every((s, i) => s === students2[i]) &&
             room1.heartbeat_at === room2.heartbeat_at &&
             room1.version === room2.version;
    }
    
    function studentEqual(student1, student2) {
      return student1.major === student2.major &&
             student1.grade === student2.grade &&
             student1.archived === student2.archived;
    }
    
    /**
     * ä½¿å­¦ç”Ÿè¯„åˆ†ç¼“å­˜å¤±æ•ˆ
     */
    function invalidateStudentScoreCache(studentName) {
      // æ¸…é™¤ç›¸å…³çš„æ’è¡Œæ¦œç¼“å­˜
      try {
        if (typeof RANK_CACHE_KEY !== 'undefined') {
          localStorage.removeItem(RANK_CACHE_KEY);
        }
      } catch (e) {
        // å¿½ç•¥localStorageé”™è¯¯
      }
      
      dbg(`ğŸ—‘ï¸ å·²æ¸…é™¤å­¦ç”Ÿ ${studentName} çš„è¯„åˆ†ç¼“å­˜`);
    }
    
    // ========== ğŸ¨ UIæ›´æ–°è¾…åŠ©å‡½æ•° ==========
    
    /**
     * æ›´æ–°é¦–é¡µå­¦ç”Ÿæ—¶é—´æ®µæ˜¾ç¤º
     */
    function updateHomeStudentSlots(studentName, changes) {
      // è¿™é‡Œå¯ä»¥æ›´æ–°é¦–é¡µå­¦ç”Ÿå¡ç‰‡ä¸­çš„æ—¶é—´æ®µæç¤º
      const cards = document.querySelectorAll('.student-card');
      cards.forEach(card => {
        const nameEl = card.querySelector('.student-name');
        if (nameEl && nameEl.textContent.includes(studentName)) {
          // å¯ä»¥æ·»åŠ ä¸€ä¸ªå°çš„æ—¶é—´æ®µå˜æ›´æç¤º
          const indicator = card.querySelector('.slots-indicator') || document.createElement('div');
          indicator.className = 'slots-indicator';
          indicator.textContent = 'ğŸ“…';
          indicator.title = 'æ—¶é—´æ®µå·²æ›´æ–°';
          indicator.style.animation = 'pulse 1s ease-out';
          
          if (!card.querySelector('.slots-indicator')) {
            card.appendChild(indicator);
          }
          
          // 3ç§’åç§»é™¤æç¤º
          setTimeout(() => {
            indicator.remove();
          }, 3000);
        }
      });
    }
    
    /**
     * æ›´æ–°åˆ—è¡¨è§†å›¾å­¦ç”Ÿæ—¶é—´æ®µæ˜¾ç¤º
     */
    function updateListStudentSlots(studentName, changes) {
      // æ›´æ–°åˆ—è¡¨è§†å›¾ä¸­çš„å­¦ç”Ÿä¿¡æ¯
      dbg(`ğŸ“… åˆ—è¡¨è§†å›¾æ—¶é—´æ®µæ›´æ–°: ${studentName}`);
    }
    
    /**
     * æ›´æ–°é¦–é¡µæˆ¿é—´çŠ¶æ€
     */
    function updateHomeRoomStatus(roomName, changes, roomData) {
      if (uiState.view !== 'home') return;
      
      // æ‰¾åˆ°å¯¹åº”çš„æˆ¿é—´å¡ç‰‡å¹¶æ›´æ–°
      const cards = document.querySelectorAll('.student-card');
      cards.forEach(card => {
        if (card.textContent.includes(roomName)) {
          const statusEl = card.querySelector('.student-status');
          if (statusEl && changes.occupancyChanged) {
            const isOccupied = roomData.occupant_student_name !== null;
            statusEl.textContent = isOccupied ? 'ç»ƒç´ä¸­' : 'ç©ºé—²';
            statusEl.className = `student-status ${isOccupied ? 'practicing-in' : 'offline'}`;
            
            // æ·»åŠ å˜æ›´åŠ¨ç”»
            card.style.animation = 'cardUpdate 0.5s ease-out';
          }
        }
      });
    }
    
    /**
     * æ›´æ–°å­¦ç”Ÿè¯¦æƒ…å½“å‰æˆ¿é—´ä¿¡æ¯
     */
    function updateStudentDetailCurrentRoom(studentName, roomName) {
      const currentRoomEl = document.querySelector('.current-room');
      if (currentRoomEl) {
        currentRoomEl.textContent = roomName;
        currentRoomEl.style.animation = 'textUpdate 0.3s ease-out';
      }
    }
    
    /**
     * æ›´æ–°é¦–é¡µå­¦ç”ŸåŸºç¡€ä¿¡æ¯
     */
    function updateHomeStudentInfo(studentName, changes, studentData) {
      const cards = document.querySelectorAll('.student-card');
      cards.forEach(card => {
        const nameEl = card.querySelector('.student-name');
        if (nameEl && nameEl.textContent.includes(studentName)) {
          // æ›´æ–°ä¸“ä¸š
          if (changes.majorChanged) {
            const majorEl = card.querySelector('.student-major');
            if (majorEl) {
              majorEl.textContent = studentData.major;
              majorEl.style.animation = 'textUpdate 0.3s ease-out';
            }
          }
          
          // æ›´æ–°å¹´çº§
          if (changes.gradeChanged) {
            const gradeEl = card.querySelector('.student-grade');
            if (gradeEl) {
              gradeEl.textContent = studentData.grade;
              gradeEl.style.animation = 'textUpdate 0.3s ease-out';
            }
          }
          
          // å¤„ç†å½’æ¡£çŠ¶æ€
          if (changes.archivedChanged) {
            if (studentData.archived) {
              card.style.opacity = '0.5';
              card.classList.add('archived');
            } else {
              card.style.opacity = '1';
              card.classList.remove('archived');
            }
          }
        }
      });
    }
    
    /**
     * æ›´æ–°åˆ—è¡¨è§†å›¾å­¦ç”Ÿä¿¡æ¯
     */
    function updateListStudentInfo(studentName, changes, studentData) {
      dbg(`ğŸ‘¥ åˆ—è¡¨è§†å›¾å­¦ç”Ÿä¿¡æ¯æ›´æ–°: ${studentName}`, changes);
    }
    
    /**
     * æ›´æ–°å­¦ç”Ÿè¯¦æƒ…é¡µåŸºç¡€ä¿¡æ¯
     */
    function updateStudentDetailInfo(studentName, studentData) {
      if (uiState.view !== 'detail' || uiState.currentStudent !== studentName) return;
      
      // æ›´æ–°è¯¦æƒ…é¡µçš„å­¦ç”Ÿä¿¡æ¯æ˜¾ç¤º
      const detailContainer = document.getElementById('detailView');
      if (detailContainer) {
        const majorEl = detailContainer.querySelector('.student-major');
        const gradeEl = detailContainer.querySelector('.student-grade');
        
        if (majorEl) {
          majorEl.textContent = studentData.major;
          majorEl.style.animation = 'textUpdate 0.3s ease-out';
        }
        
        if (gradeEl) {
          gradeEl.textContent = studentData.grade;
          gradeEl.style.animation = 'textUpdate 0.3s ease-out';
        }
      }
    }

    // æ„å»ºç»ƒç´ä¼šè¯ - å¼ºåˆ¶åªä½¿ç”¨ assign/clear é…å¯¹æ¨¡å¼
  function buildPracticeSessions(logs, studentName) {
      if(!Array.isArray(logs) || !logs.length) return [];
      
      // åªä½¿ç”¨ assign/clear é…å¯¹æ¨¡å¼ï¼Œå¿½ç•¥ session_start/session_end
      const sessions=[]; 
      let current=null; 
      
      // æŒ‰æ—¶é—´æ’åºï¼Œåªå¤„ç†æœ‰ action å’Œ timestamp çš„æ—¥å¿—
      const actionLogs = logs.filter(log => log.action && log.timestamp)
                            .sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));
      
      dbg(`å­¦ç”Ÿ ${studentName} æœ‰æ•ˆæ“ä½œæ—¥å¿—: ${actionLogs.length} æ¡`);
      
      for(const log of actionLogs){
        const act = (log.action || '').toLowerCase();
        const isEnter = act === 'enter' || act === 'assign';
        const isExit = act === 'exit' || act === 'clear';
        
        dbg(`å¤„ç†æ—¥å¿—: ${log.timestamp} - ${act} - æˆ¿é—´: ${log.room_name || log.room || 'N/A'}`);
        
        if(isEnter){
          // è‹¥å·²æœ‰å½“å‰ä¼šè¯ä¸”æœªç»“æŸï¼Œè¿ç»­ assign è§†ä¸ºâ€œåˆ‡æ¢æˆ¿é—´â€æˆ–é‡å¤ç™»è®°ï¼šç»“æŸæ—§çš„ï¼Œå¼€å¯æ–°çš„
          if(current){
            // è¿‡æ»¤å¼‚å¸¸ï¼šè‹¥æ–° assign ä¸å½“å‰ start æ—¶é—´å·® <5 ç§’ä¸”æˆ¿é—´ç›¸åŒï¼Œè®¤ä¸ºæ˜¯é‡å¤ç‚¹å‡»ï¼Œå¿½ç•¥
            const diff = Math.abs(new Date(log.timestamp) - new Date(current.start));
            const newRoom = log.room_name || log.room || log.roomName || '';
            if(diff < 5000 && (!newRoom || newRoom === current.room)){
              dbg(`å¿½ç•¥é‡å¤ assign (${diff}ms å†…, æˆ¿é—´ç›¸åŒ)`);
              continue;
            }
            current.end = log.timestamp;
            sessions.push(current);
            dbg(`è‡ªåŠ¨ç»“æŸæœªå®Œæˆä¼šè¯: ${current.start} - ${current.end}`);
          }
          current = { start: log.timestamp, end: null, room: log.room_name || log.room || log.roomName || '' };
          dbg(`å¼€å§‹æ–°ä¼šè¯: ${log.timestamp}`);
          continue;
        }
        if(isExit){
          if(current){
            current.end = log.timestamp;
            sessions.push(current);
            dbg(`ç»“æŸä¼šè¯: ${current.start} - ${current.end}`);
            current=null; continue;
          } else {
            // è¿ç»­ clearï¼šå¿½ç•¥
            dbg(`å¿½ç•¥å­¤ç«‹ clear/exit (æ— è¿›è¡Œä¸­ä¼šè¯)`);
            continue;
          }
        }
      }
      
      // å¦‚æœè¿˜æœ‰æœªç»“æŸçš„ä¼šè¯ï¼Œä¿ç•™å®ƒï¼ˆæ­£åœ¨è¿›è¡Œä¸­ï¼‰
      if(current) {
        dbg(`ä¿ç•™è¿›è¡Œä¸­çš„ä¼šè¯: ${current.start}`);
        sessions.push(current);
      }
      
      dbg(`å­¦ç”Ÿ ${studentName} æœ€ç»ˆä¼šè¯æ•°é‡: ${sessions.length}`);
      sessions.forEach((s, i) => {
        dbg(`  ä¼šè¯ ${i+1}: ${s.start} -> ${s.end || 'è¿›è¡Œä¸­'} | æˆ¿é—´: ${s.room || 'æ— '}`);
      });
      const dedup = deduplicateSessions(sessions).map(s=>({
        ...s,
        startTime: s.start,
        endTime: s.end,
        roomName: s.room
      }));
      dbg(`å»é‡åä¼šè¯æ•°é‡: ${dedup.length}`);
      dedup.forEach((s, i) => {
        dbg(`  å»é‡ä¼šè¯ ${i+1}: ${s.start} -> ${s.end || 'è¿›è¡Œä¸­'} | æˆ¿é—´: ${s.room || 'æ— '} | roomName: ${s.roomName || 'æ— '}`);
      });
      return dedup;
    }
    
  // ä¼šè¯å»é‡å‡½æ•°ï¼šä¸“é—¨é’ˆå¯¹ assign/clear æ¨¡å¼çš„å»é‡
  function deduplicateSessions(sessions) {
      if(!sessions || sessions.length <= 1) return sessions;
      
      // æŒ‰å¼€å§‹æ—¶é—´æ’åº
      const sorted = [...sessions].sort((a,b) => new Date(a.start) - new Date(b.start));
      const merged = [];
      
      for(const session of sorted) {
        if(!merged.length) {
          merged.push({...session}); // åˆ›å»ºå‰¯æœ¬é¿å…å¼•ç”¨é—®é¢˜
          continue;
        }
        
        const lastSession = merged[merged.length - 1];
        const lastEnd = lastSession.end ? new Date(lastSession.end) : null;
        const currentStart = new Date(session.start);
        
        // åˆå¹¶æ¡ä»¶ï¼šçœŸæ­£æ—¶é—´é‡å  (session.start < lastEnd) è€Œä¸æ˜¯ä»…ä»…â€œå¾ˆæ¥è¿‘â€
        if(lastEnd && currentStart < lastEnd){
          dbg(`åˆå¹¶é‡å ä¼šè¯: ${lastSession.start} ~ ${lastSession.end}  ä¸  ${session.start} ~ ${session.end}`);
          // è‹¥æ–°ä¼šè¯æœ‰ç»“æŸæ—¶é—´ä¸”æ¯”å·²æœ‰ç»“æŸæ—¶é—´æ™šï¼Œå»¶é•¿
          if(session.end && new Date(session.end) > new Date(lastSession.end)){
            lastSession.end = session.end;
          }
          // è‹¥æ—§ä¼šè¯æ— æˆ¿é—´è€Œæ–°ä¼šè¯æœ‰ï¼Œè¡¥å……æˆ¿é—´
          if(session.room && !lastSession.room){
            lastSession.room = session.room;
          }
        } else {
          merged.push({...session});
        }
      }
      
      dbg(`ä¼šè¯å»é‡: ${sessions.length} -> ${merged.length}`);
      return merged;
    }

    // æ£€æŸ¥ä¼šè¯æ˜¯å¦åœ¨è§„å®šæ—¶é—´æ®µå†…
    function isSessionInSchedule(session, studentName) {
      const timeSlots = appState.timeSlots.get(studentName);
      if (!timeSlots) return false;

      const sessionDate = new Date(session.start);
      const weekday = utils.getWeekday(sessionDate);
      const daySlots = timeSlots[weekday];
      
      if (!daySlots || daySlots.length === 0) return false;

      const sessionStartMinutes = utils.minutesFromDayStart(sessionDate);
      const sessionEndMinutes = session.end 
        ? utils.minutesFromDayStart(new Date(session.end))
        : sessionStartMinutes + 1; // å¦‚æœä¼šè¯è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå‡è®¾è‡³å°‘1åˆ†é’Ÿ

      // è½¬æ¢æ—¶é—´æ®µä¸ºåˆ†é’Ÿæ ¼å¼
      const windows = daySlots.map(slot => {
        let start, end;
        if (typeof slot.start === 'number' && typeof slot.end === 'number') {
          start = slot.start; end = slot.end;
        } else {
          start = utils.parseTimeSlot(slot.start_time || slot.start);
          end = utils.parseTimeSlot(slot.end_time || slot.end);
        }
        return { start, end };
      }).filter(w => Number.isFinite(w.start) && Number.isFinite(w.end));

      // ä½¿ç”¨ä¸splitByTimeWindowsç›¸åŒçš„é€»è¾‘æ¥åˆ¤æ–­ä¼šè¯æ˜¯å¦åœ¨æ—¶é—´æ®µå†…
      const sessionInterval = { start: sessionStartMinutes, end: sessionEndMinutes };
      const { inTime, outTime } = splitByTimeWindows([sessionInterval], windows);
      
      // å¦‚æœä¼šè¯ä¸­åœ¨æ—¶é—´æ®µå†…çš„æ—¶é—´å å¤§éƒ¨åˆ†(>50%)ï¼Œåˆ™è®¤ä¸ºæ˜¯æ®µå†…ç»ƒç´
      const totalTime = sessionEndMinutes - sessionStartMinutes;
      return totalTime > 0 && (inTime / totalTime) > 0.5;
    }

    // æ›´æ–°å†å²ä¸ƒå¤©æ€»ç»“
    async function updateWeekHistory(studentName) {
      console.log('updateWeekHistory called for:', studentName);
      // è®¡ç®—ä¸ƒå¤©æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨åç«¯å¤‡ä»½ï¼‰
      const weekData = await calculateWeekData(studentName);
      console.log('weekData:', weekData);

      // æ¸²æŸ“æ¡å½¢å›¾
      renderWeekChart(weekData.dailyData);
    }

    // è®¡ç®—ä¸ƒå¤©æ•°æ®
    async function calculateWeekData(studentName) {
      const dailyData = [];
      const today = new Date();
      let totalIn = 0;
      let totalOut = 0;

      // é¢„æ‹‰å–åç«¯ 7 å¤©æ±‡æ€»ï¼ˆå·²æŒ‰ 08:00-21:30 å’Œä¼‘æ¯æ—¶é—´è®¡ç®—ï¼‰
      const days = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        days.push(d);
      }
      let backendMap = new Map();
      try {
        backendMap = await fetchDailyPracticeSummaries(studentName, days[0], days[days.length - 1]);
      } catch (e) { console.warn('fetchDailyPracticeSummaries failed, fallback to local:', e); }

      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const iso = utils.toIsoDate(date);

        let total = backendMap.get(iso);
        let inMin = 0, outMin = 0;
        if (typeof total !== 'number') {
          // å›é€€ï¼šæœ¬åœ°æŒ‰ 21:30 æœ‰æ•ˆçª—å£ + ä¼‘æ¯æ—¶é—´è®¡ç®—
          const dayData = calculateDayData(studentName, date);
          inMin = dayData.in; outMin = dayData.out; total = inMin + outMin;
        } else {
          // åç«¯å·²æä¾›æ€»åˆ†é’Ÿï¼ˆä¸åŒºåˆ† in/outï¼‰ï¼ŒæŒ‰ out å­˜å‚¨ä»¥å…¼å®¹ç°æœ‰æ¸²æŸ“
          inMin = 0; outMin = total;
        }

        dailyData.push({
          date,
          label: i === 0 ? 'ä»Šå¤©' : date.getMonth() + 1 + '/' + date.getDate(),
          inMinutes: inMin,
          outMinutes: outMin,
          total
        });

        totalIn += inMin;
        totalOut += outMin;
      }

      return { dailyData, totalIn, totalOut };
    }

    // è®¡ç®—å•æ—¥æ•°æ®
  function calculateDayData(studentName, date) {
  // ç»Ÿä¸€ï¼šä½¿ç”¨ assign/clear é…å¯¹æ¨¡å¼æ„å»ºä¼šè¯
  const dateKey = getStatsDayKey(date);
  const baseLogs = Array.isArray(appState.practiceLogsNormalized) ? appState.practiceLogsNormalized : (appState.practiceLogs||[]);
  if(!baseLogs.length) return { in:0, out:0 };
  const dayLogs = baseLogs.filter(l=>{
    // æŒ‰ timestamp æ‰€åœ¨è‡ªç„¶æ—¥è¿‡æ»¤ï¼Œåªå¤„ç†æœ‰ action çš„æ—¥å¿—
    if(!l.timestamp || !l.action) return false; 
    const tsDate=new Date(l.timestamp); 
    return getStatsDayKey(tsDate)===dateKey && (l.student_name===studentName);
  });
  if(!dayLogs.length) return { in:0, out:0 };

  // ä½¿ç”¨ assign/clear é…å¯¹æ„å»ºä¼šè¯ï¼Œç„¶åæŒ‰å½“å¤©çª—å£è£å‰ª
  let sessions = buildPracticeSessions(dayLogs, studentName);
  if(!sessions.length) return { in:0, out:0 };

  const dayWindow = getEffectiveDayWindow(date) || { start:0, end: (21*60+30) };
  const dayStart = new Date(date); dayStart.setHours(0,0,0,0); const dayStartMs=dayStart.getTime();
  const windowStartMs = dayStartMs + dayWindow.start*60*1000;
  const windowEndMs = dayStartMs + dayWindow.end*60*1000;

  // è½¬ä¸ºåˆ†é’ŸåŒºé—´å¹¶è£å‰ª
  const intervals = sessions.map(s=>{
    const rawStartMs = new Date(s.start).getTime();
    const rawEndMs = s.end ? new Date(s.end).getTime() : Date.now();
    // åªä¿ç•™ä¸å½“å¤©çª—å£æœ‰äº¤é›†çš„éƒ¨åˆ†
    const clampStart = Math.max(rawStartMs, windowStartMs);
    const clampEnd = Math.min(rawEndMs, windowEndMs);
    if(clampEnd <= clampStart) return null;
    return { start: utils.minutesFromDayStart(new Date(clampStart)), end: utils.minutesFromDayStart(new Date(clampEnd)) };
  }).filter(Boolean);
  if(!intervals.length) return { in:0, out:0 };

  const weekday = utils.getWeekday(date); // 1..7
  let total;
  if(weekday===6 || weekday===7){
    total = intervals.reduce((sum,iv)=> sum + (iv.end-iv.start),0);
  } else {
    const breaks = weekday===3 ? BREAK_SCHEDULE.wed : BREAK_SCHEDULE.monTueThuFri;
    const afterBreaks = subtractBreaks(intervals, breaks);
    total = afterBreaks.reduce((sum,iv)=> sum + (iv.end-iv.start),0);
  }
  return { in:0, out: total };
    }

    // æ¸²æŸ“å‘¨ç»ƒç´æ¡å½¢å›¾
  function renderWeekChart(dailyData) {
      console.log('renderWeekChart called with:', dailyData);
      const container = document.getElementById('weekChart');
      console.log('weekChart container:', container);
      if (!container) {
        console.error('weekChart container not found!');
        return;
      }
      
      const maxTotal = Math.max(...dailyData.map(d => (d.total ?? (d.inMinutes + d.outMinutes))), 1);
      console.log('maxTotal:', maxTotal);

      let html = '';
      dailyData.forEach((day, idx) => {
        const total = day.total ?? (day.inMinutes + day.outMinutes);
        const heightPercent = (total / maxTotal) * 100;
        const totalHours = total > 0 ? utils.formatDurationShort(total) : '';
        const dateKey = utils.getDateKey(day.date);
        const isToday = idx === dailyData.length - 1; // æœ€åä¸€æ ¹æŸ±ä¸ºâ€œä»Šå¤©â€
        html += `
          <div class="chart-bar" 
               data-date="${dateKey}" 
               data-total="${total}" 
               data-istoday="${isToday}">
            <div class="bar-container">
              <div class="bar-fill" style="height: ${heightPercent}%"></div>
              <div class="bar-value">${totalHours}</div>
              <div class="bar-tooltip" role="tooltip">${day.label} Â· æ€»è®¡ ${total} åˆ†é’Ÿ</div>
            </div>
            <div class="bar-label">${day.label}</div>
          </div>
        `;
      });

  scheduleDOM(()=>{ container.innerHTML = html; });

      // äº¤äº’ï¼šæ‚¬åœæ˜¾ç¤º tooltipï¼Œç‚¹å‡»å¯è§¦å‘æŸ¥çœ‹è¯¦ç»†æ—¥æ•°æ®ï¼ˆå½“å‰è¿›å…¥å½“å¤©è¯¦æƒ…çš„æœ€å°äº¤äº’ç¤ºä¾‹ï¼šä»…é—ªçƒæ•ˆæœæˆ–å¤ç®—åˆ·æ–°ï¼‰
      // äº‹ä»¶ç»‘å®šæ¨è¿Ÿåˆ°ä¸‹ä¸€å¸§ï¼Œé¿å…ä¸æ‰¹é‡ DOM å†™ç«äº‰
      requestAnimationFrame(()=>{
        const bars = container.querySelectorAll('.chart-bar');
        bars.forEach(bar => {
          bar.addEventListener('mouseenter', () => bar.classList.add('show-tooltip'));
          bar.addEventListener('mouseleave', () => bar.classList.remove('show-tooltip'));
          bar.addEventListener('click', () => {
            bar.classList.toggle('show-tooltip');
            const isToday = bar.dataset.istoday === 'true';
            if (isToday && uiState.view === 'detail' && uiState.selectedStudent) {
              updateWeekHistory(uiState.selectedStudent);
            }
          });
        });
      });
    }

    // å®æ—¶åˆ·æ–°ï¼šè¯¦æƒ…é¡µæ‰“å¼€æ—¶ï¼Œæ¯åˆ†é’Ÿåˆ·æ–°â€œä»Šå¤©â€æŸ±çŠ¶å›¾ä»¥è·Ÿéšè¿›è¡Œä¸­çš„ä¼šè¯
    let weekChartTimer = null;
    function startWeekChartAutoRefresh() {
      if (weekChartTimer) return;
      weekChartTimer = setInterval(() => {
        if (uiState.view === 'detail' && uiState.selectedStudent) {
          updateWeekHistory(uiState.selectedStudent);
          // ä¿æŒæ—¶é—´è½´ä¸æŸ±çŠ¶å›¾ä¸€è‡´ï¼ˆå«21:30æˆªæ–­ï¼‰
          updateTodayTimeline(uiState.selectedStudent);
        }
      }, 60 * 1000); // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
    }
    function stopWeekChartAutoRefresh() {
      if (weekChartTimer) {
        clearInterval(weekChartTimer);
        weekChartTimer = null;
      }
    }

    // âœ… å­¦ç”Ÿè¯¦æƒ…å½“å‰æ—¶é•¿å®æ—¶æ›´æ–°é…ç½®éªŒè¯
    let currentDurationTimer = null;
    function startCurrentDurationUpdate() {
      if (currentDurationTimer) return;
      // âœ… æ¯30ç§’æ›´æ–°å­¦ç”Ÿè¯¦æƒ…é¡µé¢çš„å½“å‰ç»ƒç´æ—¶é•¿æ˜¾ç¤º
      currentDurationTimer = setInterval(() => {
        if (uiState.view === 'detail' && uiState.selectedStudent) {
          const student = appState.students.get(uiState.selectedStudent);
          if (student && student.currentStatus !== 'offline' && student.currentStartTime) {
            const now = new Date();
            const sameDay = student.currentStartTime.getFullYear()===now.getFullYear() && student.currentStartTime.getMonth()===now.getMonth() && student.currentStartTime.getDate()===now.getDate();
            const currentDurationEl = document.getElementById('currentDuration');
            if(sameDay){
              // âœ… å®æ—¶è®¡ç®—å¹¶æ˜¾ç¤ºå½“å‰ç»ƒç´ä¼šè¯æ—¶é•¿
              const currentSessionMinutes = Math.round((now - student.currentStartTime) / (1000 * 60));
              currentDurationEl.textContent = utils.formatDuration(Math.max(0, currentSessionMinutes));
            }
            // æ³¨æ„ï¼šçŠ¶æ€ç®¡ç†ç”± analyzeStudentData è´Ÿè´£ï¼Œè¿™é‡Œåªæ›´æ–°æ—¶é•¿æ˜¾ç¤º
          } else if(student && student.currentStatus === 'offline') {
            const currentDurationEl = document.getElementById('currentDuration');
            if(currentDurationEl) currentDurationEl.textContent='--';
          }
        }
      }, 30 * 1000); // âœ… æ¯30ç§’æ›´æ–°ä¸€æ¬¡ï¼Œå¹³è¡¡ç²¾åº¦ä¸æ€§èƒ½
    }
    function stopCurrentDurationUpdate() {
      if (currentDurationTimer) {
        clearInterval(currentDurationTimer);
        currentDurationTimer = null;
      }
    }

    // ==== 442æ’è¡Œæ¦œåŠŸèƒ½ ====
    // å‚è€ƒ index-4 çš„ 442 è¯„åˆ†è§„åˆ™ï¼Œç²¾ç®€å®ç°ç»´åº¦1/2ï¼ˆå„40åˆ†ï¼‰ï¼Œç»´åº¦3æš‚ç½® 0ï¼ˆåç»­å¯æ¥å†å²æ•°æ®ï¼‰
  const LB442_PARAMS = {
      dim1: { // æ®µå†…å®Œæˆ + è¿Ÿåˆ°/ç¼ºå¸­ æ‰£åˆ† => 0~40
  coverageCompleteThreshold: 0.6, // å…¼å®¹ä¿ç•™ï¼ˆä¸å†ç”¨äºå¾—åˆ†é˜ˆå€¼ï¼Œæ”¹ä¸ºæŒ‰æ—¶é—´è¦†ç›–æ¯”ä¾‹è®¡åˆ†ï¼‰
        absentThreshold: 0.1, // ä»…ç”¨äºè¯´æ˜ï¼Œç²¾ç®€ç‰ˆç¼ºå¸­åˆ¤å®šä¸ºå®Œå…¨ 0 è¦†ç›–
        graceMinutes: 10,
  minSlotsForFullBonus: 1, // æ»¡å‹¤å¥–åŠ±è§¦å‘çš„æœ€å°‘æ—¶æ®µæ•°ï¼ˆâ‰¥1 æ®µï¼Œå…¬å¹³åŒ–ï¼‰
        P_incomplete: 40,
        pLate: 0.4,
        lateCap: 20,
        pAbsent: 15,
        fullBonus: 3
  },
      dim2: { // è´¨é‡æ•ˆç‡æ‰£åˆ† => 0~40
        longStartMin: 125, // è¶…è¿‡125åˆ†é’Ÿå¼€å§‹æ‰£åˆ†ï¼ˆ120åˆ†é’Ÿ+5åˆ†é’Ÿç¼“å†²æœŸï¼‰
        longCapExtraMin: 120,
        pLong: 0.25,
        pWindow: 0.3,
        windowCapPerSession: 18,
        shortThreshold: 30,
        pShort: 0.5,
        tail: { p: 0.4, grace: 25, capMinutes: 30 }
      },
      dim3: { // æˆé•¿åŠ æˆä¸åéœ¸æ¦œï¼ˆ20åˆ†æƒé‡æ§½ä½ï¼‰
        // å‘¨è¿›æ­¥ä¸ç¨³å®šæ€§é…ç½®
        progress: {
          maxRatio: 0.5,       // ç›¸å¯¹æå‡ä¸Šé™ï¼ˆ50%â†’æ»¡8åˆ†ï¼‰
          denomFloor: 80,      // å°åˆ†æ¯é˜²æŠ¤
          minPrevTotal: 40,    // å‰çª—å£æ¯ä¸ªæœ‰æ•ˆè®°å½•çš„æœ€ä½åˆ†æ•°è¦æ±‚
          minActiveDaysPerWindow: 2, // æ•°æ®å……è¶³é—¨æ§›ï¼šè¿‘/å‰å„5ä¸ªå·¥ä½œæ—¥å†…ï¼Œæœ‰æ•ˆå¤©æ•°â‰¥2
          windowSize: 5        // å·¥ä½œæ—¥çª—å£ï¼ˆåŸ7æ”¹5ï¼‰
        },
        consistency: {
          minRecords: 2        // è®¡ç®—æ ‡å‡†å·®åŠ åˆ†çš„æœ€å°æœ‰æ•ˆè®°å½•æ•°
        },
        freshness: {
          // ä»Šæ—¥æ´»è·ƒåº¦ï¼ˆé€‚ç”¨æ’è¡Œæ¦œçª—å£ï¼‰ï¼š
          // 1) åœ¨å½“æ—¥æ’è¡Œæ¦œçª—å£ï¼ˆå·¥ä½œæ—¥ï¼šå‘¨ä¸‰ 08:00-19:30ï¼›å‘¨ä¸€/äºŒ/å››/äº” 08:00-19:00ï¼‰å†…ç´¯è®¡ç»ƒç´æ—¶é•¿
          //    > minTodayDurationHours å°æ—¶ï¼ˆå‘¨æœ«æ— çª—å£ï¼Œè®¡ 0ï¼‰
          // 2) ä¸”ä»Šæ—¥ D1+D2 â‰¥ minTodayD12
          minTodayDurationHours: 3,
          minTodayD12: 78
        },
        antiDomination: {
          decayAfterDays: 3,     // è¿ç»­ç™»é¡¶>=3ä¸ªå·¥ä½œæ—¥å¼€å§‹è¡°å‡
          maxConsecutiveDays: 5, // >=5ä¸ªå·¥ä½œæ—¥ç™»é¡¶ï¼Œé¢å¤–å¼ºè¡°å‡
          decayRate: 0.85,       // æ¯è¶…å‡ºä¸€å¤©ä¹˜ä»¥è¯¥ç³»æ•°
          breakPeriod: 2         // è·ç¦»ä¸Šæ¬¡ç™»é¡¶>=2ä¸ªå·¥ä½œæ—¥ï¼Œç»™ä¸€ç‚¹æ–°é²œå¥–åŠ±
        },
        freshBreakBonus: 1       // æ–°é²œå¥–åŠ±åŸºç¡€åˆ†ï¼ˆéä¹˜å­ï¼‰
      }
    };

    function toDayStart(date) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
      return d.getTime();
    }

    function mergeIntervalsMs(arr) {
      if (!arr || !arr.length) return [];
      const sorted = arr.slice().sort((a, b) => a.start - b.start);
      const res = [];
      let cur = { ...sorted[0] };
      for (let i = 1; i < sorted.length; i++) {
        const x = sorted[i];
        if (x.start <= cur.end) {
          cur.end = Math.max(cur.end, x.end);
        } else {
          res.push(cur);
          cur = { ...x };
        }
      }
      res.push(cur);
      return res;
    }

    // çŸ­æ—¶æ‰£åˆ†å…é™¤çª—å£ï¼ˆæŒ‰æ˜ŸæœŸï¼‰ï¼š
    // å…è®¸å­¦ç”Ÿåœ¨ä¸‹åˆç¬¬ä¸€èŠ‚è¯¾å‰å’Œæ™šä¸ŠéŸ³ä¹ä¼š/æ´»åŠ¨å‰ç´§æ€¥ç»ƒä¹ ï¼Œä¸ä¼šå› æ—¶é—´å¤ªçŸ­è€Œæ‰£åˆ†
    // ä¸€/äºŒ/å››/äº” => 12:30-13:00, 18:30-19:00
    // ä¸‰ => 12:30-14:00, 19:00-19:30
    function getShortPenaltyExemptWindowsByWeekday(weekday0to6) {
      if ([1, 2, 4, 5].includes(weekday0to6)) {
        // Mon/Tue/Thu/Fri: 12:30â€“13:00ï¼ˆä¸‹åˆç¬¬ä¸€èŠ‚è¯¾å‰ï¼‰, 18:30â€“19:00ï¼ˆéŸ³ä¹ä¼š/è¯¾ç¨‹/æ´»åŠ¨å‰ï¼‰
        return [
          { startMin: 12*60 + 30, endMin: 13*60 + 0 },
          { startMin: 18*60 + 30, endMin: 19*60 + 0 }
        ];
      }
      if (weekday0to6 === 3) {
        // Wed: 12:30â€“14:00ï¼ˆä¸‹åˆç¬¬ä¸€èŠ‚è¯¾å‰/åˆé—´éŸ³ä¹ä¼šä¹‹å‰ï¼‰, 19:00â€“19:30ï¼ˆéŸ³ä¹ä¼š/è¯¾ç¨‹/æ´»åŠ¨å‰ï¼‰
        return [
          { startMin: 12*60 + 30, endMin: 14*60 + 0 },
          { startMin: 19*60 + 0, endMin: 19*60 + 30 }
        ];
      }
      return [];
    }

    // ä½æ•ˆçª—å£ï¼ˆæŒ‰æ˜ŸæœŸï¼‰ï¼š
    // ä¸€/äºŒ/ä¸‰/å››/äº” ä¸­åˆ => 11:50-13:00ï¼ˆè¶…è¿‡60åˆ†é’Ÿæ‰æ‰£åˆ†ï¼‰
    // ä¸€/äºŒ/å››/äº” æ™šä¸Š => 18:00-19:00ï¼ˆè¶…è¿‡50åˆ†é’Ÿæ‰æ‰£åˆ†ï¼‰
    // ä¸‰ æ™šä¸Š => 18:30-19:30ï¼ˆè¶…è¿‡50åˆ†é’Ÿæ‰æ‰£åˆ†ï¼‰
    function getDailyLowEffWindowsByWeekday(weekday0to6) {
      if ([1, 2, 4, 5].includes(weekday0to6)) {
        // Mon/Tue/Thu/Fri: 11:50â€“13:00 (grace 60min), 18:00â€“19:00 (grace 50min)
        return [
          { startMin: 11*60 + 50, endMin: 13*60 + 0, graceMin: 60 },
          { startMin: 18*60 + 0, endMin: 19*60 + 0, graceMin: 50 }
        ];
      }
      if (weekday0to6 === 3) {
        // Wed: 11:50â€“13:00 (grace 60min), 18:30â€“19:30 (grace 50min)
        return [
          { startMin: 11*60 + 50, endMin: 13*60 + 0, graceMin: 60 },
          { startMin: 18*60 + 30, endMin: 19*60 + 30, graceMin: 50 }
        ];
      }
      return [];
    }

    // ç»´åº¦1ï¼šæ®µå†…å®Œæˆ + è¿Ÿåˆ°/ç¼ºå¸­ï¼ˆslots ä»¥åˆ†é’Ÿè¡¨ç¤ºï¼ŒintervalsMs ä¸ºå½“å¤©æ¯«ç§’åŒºé—´ï¼‰
    function computeDim1Score(slotsMin, intervalsMs, dayStartMs) {
      const p = LB442_PARAMS.dim1;
      if (!slotsMin || !slotsMin.length) {
        return { score: 0, breakdown: { slots: [], completed: 0, totalSlots: 0, absent: 0, latePenalty: 0, incompletePenalty: 0, absentPenalty: 0, fullBonus: 0, raw: 0 } };
      }
      
      // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰åœ¨è§„å®šæ—¶é—´æ®µå†…çš„ç»ƒç´è®°å½•
      // å¦‚æœæ²¡æœ‰ä»»ä½•ç»ƒç´è®°å½•ä¸è§„å®šæ—¶é—´æ®µé‡å ï¼Œç›´æ¥è¿”å›0åˆ†
      if (!intervalsMs || !intervalsMs.length) {
        return { score: 0, breakdown: { slots: [], completed: 0, totalSlots: 0, absent: 0, latePenalty: 0, incompletePenalty: 0, absentPenalty: 0, fullBonus: 0, raw: 0, noRecords: true } };
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ç»ƒç´è®°å½•ä¸è§„å®šæ—¶é—´æ®µé‡å 
      let hasOverlap = false;
      for (const slot of slotsMin) {
        const slotStartMs = dayStartMs + slot.start * 60 * 1000;
        const slotEndMs = dayStartMs + slot.end * 60 * 1000;
        for (const iv of intervalsMs) {
          // æ£€æŸ¥æ˜¯å¦æœ‰é‡å ï¼šåŒºé—´1ç»“æŸæ—¶é—´ > åŒºé—´2å¼€å§‹æ—¶é—´ ä¸” åŒºé—´1å¼€å§‹æ—¶é—´ < åŒºé—´2ç»“æŸæ—¶é—´
          if (iv.end > slotStartMs && iv.start < slotEndMs) {
            hasOverlap = true;
            break;
          }
        }
        if (hasOverlap) break;
      }
      
      // å¦‚æœæ²¡æœ‰ä»»ä½•é‡å ï¼Œè¿”å›åˆ†æ•°ä¸çŠ¶æ€ï¼š
      // éœ€æ±‚ä¿®æ­£ï¼šå½“æ—¥â€œå°šæ— ä»»ä½•è§„å®šæ—¶æ®µå¼€å§‹â€æ—¶ï¼Œç»´åº¦ä¸€åº”æ˜¾ç¤º 0 åˆ†ï¼ˆä¸å†é»˜è®¤40åˆ†ï¼‰ã€‚
      // å½“å†å²æ—¥æˆ–å½“æ—¥å·²æœ‰æ—¶æ®µå¼€å§‹ä½†æ— è®°å½•æ—¶ï¼ŒæŒ‰å·²ç»“æŸæ®µçš„ç¼ºå¸­æ‰£åˆ†è§„åˆ™è®¡ç®—ã€‚
      if (!hasOverlap) {
        // è·å–å½“å‰æ—¶é—´å‚è€ƒç‚¹
        const targetDayEnd = dayStartMs + 24 * 60 * 60 * 1000;
        let referenceTime;
        if (targetDayEnd < Date.now()) {
          const weekday = new Date(dayStartMs).getDay();
          const leaderboardEndMin = ([1,2,4,5].includes(weekday)) 
            ? (19*60+0) : (weekday===3 ? (19*60+30) : (24*60));
          referenceTime = dayStartMs + leaderboardEndMin * 60 * 1000;
        } else {
          referenceTime = Date.now();
        }
        const nowMin = Math.floor((referenceTime - dayStartMs) / 60000);
        
        // æ„å»ºæ—¶é—´æ®µçŠ¶æ€åˆ—è¡¨
        const slotsDetail = [];
        let absent = 0;
        let includedSlots = 0;
        let earliestStartMin = Infinity;
        
        for (const slot of slotsMin) {
          const slotStartMin = slot.start;
          const slotEndMin = slot.end;
          if (slotStartMin < earliestStartMin) earliestStartMin = slotStartMin;
          
          let status;
          if (nowMin <= slotStartMin) {
            status = 'æœªå¼€å§‹';
          } else if (nowMin < slotEndMin) {
            status = 'ç¼ºå‹¤ä¸­';
          } else {
            status = 'ç¼ºå¸­';
            absent++;
            includedSlots++;
          }
          
          slotsDetail.push({
            start: slot.start,
            end: slot.end,
            durMin: 0,
            overlapMin: 0,
            coverage: 0,
            status,
            lateMin: 0,
            latePenalty: 0,
            missMin: 0,
            incompletePenalty: 0,
            absentPenalty: status === 'ç¼ºå¸­' ? p.pAbsent : 0
          });
        }
        
        // è‹¥å½“æ—¥å°šæ— ä»»ä½•è§„å®šæ—¶æ®µå¼€å§‹ï¼Œåˆ™ç»´åº¦ä¸€è®° 0 åˆ†ï¼ˆå±•ç¤ºçŠ¶æ€ä½†ä¸è®¡åˆ†ï¼‰
        if (!Number.isFinite(earliestStartMin) || nowMin <= earliestStartMin) {
          return {
            score: 0,
            breakdown: {
              slots: slotsDetail,
              completed: 0,
              totalSlots: 0,
              absent: 0,
              latePenalty: 0,
              incompletePenalty: 0,
              absentPenalty: 0,
              fullBonus: 0,
              raw: 0,
              noRecords: true,
              allNotStarted: true
            }
          };
        }

        // è‹¥å·²æœ‰æ—¶æ®µå¼€å§‹ï¼ˆnowMin > earliestStartMinï¼‰ï¼Œä½†å°šæ— ä»»ä½•å·²ç»“æŸæ—¶æ®µï¼ˆincludedSlots===0ï¼‰ï¼Œ
        // ä¸”ä»æœªäº§ç”Ÿä¸è§„å®šæ—¶æ®µçš„é‡å ç»ƒç´è®°å½•ï¼Œåˆ™ç»´åº¦ä¸€æš‚ä¸è®¡åˆ†ï¼ˆä¿æŒ 0 åˆ†ï¼‰ï¼Œä»…å±•ç¤ºâ€œç¼ºå‹¤ä¸­/æœªå¼€å§‹â€ç­‰çŠ¶æ€ã€‚
        // è¿™æ ·å¯é¿å…åœ¨â€œç¬¬ä¸€æ®µæ­£åœ¨è¿›è¡Œã€å°šæœªç™»è®°ç»ƒç´â€æ—¶å‡ºç° 40 åˆ†çš„è¯¯å¯¼ã€‚
        if (nowMin > earliestStartMin && includedSlots === 0) {
          return {
            score: 0,
            breakdown: {
              slots: slotsDetail,
              completed: 0,
              totalSlots: 0,
              absent: 0,
              latePenalty: 0,
              incompletePenalty: 0,
              absentPenalty: 0,
              fullBonus: 0,
              raw: 0,
              noRecords: true,
              startedButNoOverlap: true
            }
          };
        }

        // è‡³æ­¤ï¼šå·²æœ‰è‡³å°‘ä¸€ä¸ªæ—¶æ®µåº”å½“å¼€å§‹ï¼Œä½†æ— ç»ƒç´è®°å½• â†’ æŒ‰ç¼ºå¸­æ‰£åˆ†å£å¾„è®¡ç®—åˆ†æ•°
        const absentPenalty = absent * p.pAbsent;
        const raw = Math.max(0, 100 - absentPenalty);
        const score = +((raw / 100) * 40).toFixed(2);
        
        return { 
          score, 
          breakdown: { 
            slots: slotsDetail, 
            completed: 0, 
            totalSlots: includedSlots, 
            absent, 
            latePenalty: 0, 
            incompletePenalty: 0, 
            absentPenalty: +absentPenalty.toFixed(2), 
            fullBonus: 0, 
            raw: +raw.toFixed(2),
            noRecords: true,
            allNotStarted: false
          } 
        };
      }
      
      // é¢„åˆå¹¶ç»ƒä¹ åŒºé—´
      const merged = mergeIntervalsMs(intervalsMs);
  let completed = 0, absent = 0, latePenalty = 0;
  let totalDurMin = 0, totalOverlapMin = 0;
  // ç»Ÿè®¡ï¼šæˆªè‡³å½“å‰æ—¶åˆ»ï¼Œå·²å¼€å§‹çš„è§„å®šæ—¶æ®µæ•°é‡ï¼Œä»¥åŠè¿™äº›å·²å¼€å§‹æ—¶æ®µä¸­æ˜¯å¦å­˜åœ¨ä»»ä½•é‡å ç»ƒç´
  let startedSlotsCount = 0;
  let hasOverlapWithStarted = false;
      const slotsDetail = [];

      // ä»¥â€œå½“å‰æ—¶é—´â€å†³å®šè®¡åˆ†çª—å£ï¼š
      // - å·²ç»“æŸæ—¶æ®µï¼ˆslot.end <= nowMinï¼‰ï¼šå…¨é¢è®¡å…¥ï¼Œå¯èƒ½è®°ä¸ºç¼ºå¸­
      // - è¿›è¡Œä¸­æ—¶æ®µï¼ˆslot.start < nowMin < slot.endï¼‰ï¼šä»…è®¡å…¥å·²åˆ°å½“å‰æ—¶åˆ»çš„éƒ¨åˆ†ï¼Œä¸è®°ç¼ºå¸­
      // - æœªå¼€å§‹æ—¶æ®µï¼ˆnowMin <= slot.startï¼‰ï¼šä¸è®¡å…¥ä»»ä½•æ‰£åˆ†/è¦†ç›–
      // ğŸ”§ å†å²é‡ç®—ä¿®æ­£ï¼šä½¿ç”¨æ’è¡Œæ¦œçª—å£ç»“æŸæ—¶é—´ä½œä¸ºå‚è€ƒï¼Œå®Œç¾è¿˜åŸæ’è¡Œæ¦œæˆªæ­¢æ—¶åˆ»çš„çŠ¶æ€
      const targetDayEnd = dayStartMs + 24 * 60 * 60 * 1000;
      let referenceTime;
      if (targetDayEnd < Date.now()) {
        // å†å²æ—¥æœŸï¼šä½¿ç”¨æ’è¡Œæ¦œçª—å£ç»“æŸæ—¶é—´ï¼ˆè¿™æ˜¯æ’è¡Œæ¦œè®¡åˆ†çš„çœŸæ­£æˆªæ­¢æ—¶åˆ»ï¼‰
        const weekday = new Date(dayStartMs).getDay();
        const leaderboardEndMin = ([1,2,4,5].includes(weekday)) 
          ? (19*60+0)    // å‘¨ä¸€äºŒå››äº”ï¼š19:00ï¼ˆä¸ä½æ•ˆæ—¶æ®µç»“æŸæ—¶é—´ä¸€è‡´ï¼‰
          : (weekday===3 ? (19*60+30) : (24*60));  // å‘¨ä¸‰ï¼š19:30ï¼ˆä¸ä½æ•ˆæ—¶æ®µç»“æŸæ—¶é—´ä¸€è‡´ï¼‰ï¼Œå…¶ä»–ï¼šå…¨å¤©
        referenceTime = dayStartMs + leaderboardEndMin * 60 * 1000;
      } else {
        // å½“å¤©æˆ–æœªæ¥ï¼šä½¿ç”¨å½“å‰æ—¶é—´
        referenceTime = Date.now();
      }
      const nowMin = Math.floor((referenceTime - dayStartMs) / 60000);
      let includedSlots = 0;
      let allSlotsEnded = true;

      for (const slot of slotsMin) {
        const slotStartMs = dayStartMs + slot.start * 60 * 1000;
        const slotEndMs = dayStartMs + slot.end * 60 * 1000;
        const slotStartMin = slot.start;
        const slotEndMin = slot.end;

        // å†³å®šæ˜¯å¦è®¡å…¥ä»¥åŠè®¡å…¥åˆ°å“ªä¸€åˆ»
        if (nowMin <= slotStartMin) {
          // æœªå¼€å§‹ï¼šè·³è¿‡ï¼Œä¸çº³å…¥æœ¬æ¬¡è®¡åˆ†ï¼Œä½†ä»éœ€è¦åœ¨å±•ç¤ºä¸­æ˜¾ç¤º
          allSlotsEnded = false;
          slotsDetail.push({
            start: slot.start,
            end: slot.end,
            durMin: 0,
            overlapMin: 0,
            coverage: 0,
            status: 'æœªå¼€å§‹',
            lateMin: 0,
            latePenalty: 0,
            missMin: 0,
            incompletePenalty: 0,
            absentPenalty: 0
          });
          continue;
        }

  const effectiveEndMs = (nowMin >= slotEndMin) ? slotEndMs : (dayStartMs + nowMin * 60000);
        if (nowMin < slotEndMin) allSlotsEnded = false; // ä»æœ‰è¿›è¡Œä¸­
  if (nowMin > slotStartMin) startedSlotsCount++;

        // ä»…å°†â€œèµ·ç»ƒåâ€çš„æ—¶é—´çª—è®¡å…¥æœªå®Œæˆè®¡ç®—
        // 1) æ‰¾åˆ°é¦–ä¸ªè¿›å…¥æ—¶åˆ» firstStartMsï¼ˆè‹¥æœªè¿›å…¥åˆ™ä¸º nullï¼‰
        let firstStartMs = null;
        let overlapAfterStartMin = 0; // ä»…ç»Ÿè®¡ firstStart ä¹‹åçš„è¦†ç›–åˆ†é’Ÿ
        for (const iv of merged) {
          if (iv.end <= slotStartMs) continue;
          if (iv.start >= effectiveEndMs) break;
          const st = Math.max(iv.start, slotStartMs);
          const ed = Math.min(iv.end, effectiveEndMs);
          if (ed > st) {
            if (firstStartMs === null) firstStartMs = st;
            const adjSt = Math.max(st, firstStartMs);
            if (ed > adjSt) overlapAfterStartMin += (ed - adjSt) / 60000;
          }
        }

        // 2) è¯„ä¼°çª—ï¼šä» firstStart åˆ° effectiveEndï¼ˆæœªå¼€å§‹åˆ™è¯„ä¼°çª—ä¸º 0ï¼‰
        const evalDurMin = firstStartMs ? ((effectiveEndMs - firstStartMs) / 60000) : 0;
        if (nowMin > slotStartMin && overlapAfterStartMin > 0) {
          hasOverlapWithStarted = true;
        }
        
        // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤º"ç¼ºå‹¤ä¸­"çŠ¶æ€ï¼šæ—¶é—´æ®µå·²å¼€å§‹ä½†æœªç™»è®°
        const hasStarted = nowMin > slotStartMin;
        const hasNotRegistered = !firstStartMs;
        const isOngoing = nowMin < slotEndMin;
        
        if (evalDurMin <= 0 && !(nowMin >= slotEndMin)) {
          // å·²å¼€å§‹ä½†æœªç™»è®°ä¸”æœªç»“æŸï¼šæ˜¾ç¤ºä¸º"ç¼ºå‹¤ä¸­"
          if (hasStarted && hasNotRegistered && isOngoing) {
            slotsDetail.push({
              start: slot.start,
              end: slot.end,
              durMin: 0,
              overlapMin: 0,
              coverage: 0,
              status: 'ç¼ºå‹¤ä¸­',
              lateMin: 0,
              latePenalty: 0,
              missMin: 0,
              incompletePenalty: 0,
              absentPenalty: 0
            });
          }
          // æœªå¼€å§‹æˆ–å°šæœªæœ‰æ•ˆè¿›å…¥ä¸”æœªç»“æŸï¼šè·³è¿‡æœ¬æ®µï¼ˆä¸è®¡è¿Ÿåˆ°/æœªå®Œæˆ/ç¼ºå¸­ï¼‰
          continue;
        }

        includedSlots++;
        totalDurMin += Math.max(0, evalDurMin);

  // coverageEval: èµ·ç»ƒåè¯„ä¼°çª—è¦†ç›–ç‡ï¼›ongoing æ—¶æˆ‘ä»¬å±•ç¤ºæ•´ä½“è¿›åº¦ = å·²ç»ƒ / æ®µæ€»æ—¶é•¿
  const coverageEval = evalDurMin > 0 ? (overlapAfterStartMin / evalDurMin) : 0;
  let status = 'æœªå®Œæˆ'; // ç»“æŸå‰é»˜è®¤è§†ä¸ºæœªå®Œæˆï¼Œåé¢åŒºåˆ†è¿›è¡Œä¸­

        // è¿Ÿåˆ°æ‰£åˆ†ï¼šé¦–å…¥æ—¶é—´ç›¸å¯¹æ®µå¼€å§‹çš„å»¶è¿Ÿï¼ˆå‡å»å®½é™ï¼‰
        let lateMin = 0, thisLatePenalty = 0;
        if (firstStartMs) {
          lateMin = Math.max(0, Math.floor((firstStartMs - slotStartMs) / 60000 - p.graceMinutes));
          if (lateMin > 0) {
            thisLatePenalty = lateMin * p.pLate;
            latePenalty += thisLatePenalty;
          }
        }

        const ended = nowMin >= slotEndMin;
        if (ended) {
          if (!firstStartMs) {
            // å·²ç»“æŸä¸”ä»æœªè¿›å…¥ â†’ ç¼ºå¸­
            absent++;
            status = 'ç¼ºå¸­';
          } else if (evalDurMin > 0 && overlapAfterStartMin >= evalDurMin - 1e-6) {
            // èµ·ç»ƒåè¦†ç›–æ»¡è‡³æ®µå°¾ â†’ å®Œæˆ
            completed++;
            status = 'å®Œæˆ';
          } else {
            status = 'æœªå®Œæˆ';
          }
        } else {
          // è¿›è¡Œä¸­ï¼šä¸è®°ç¼ºå¸­ï¼ŒçŠ¶æ€æ ‡è®°ä¸ºâ€œè¿›è¡Œä¸­â€ä»¥ä¾¿å‰ç«¯å±•ç¤ºè¦†ç›–è¿›åº¦
          status = 'è¿›è¡Œä¸­';
        }

        let displayCoveragePct;
        if (status === 'è¿›è¡Œä¸­') {
          const totalSlotDur = slotEndMin - slotStartMin; // æ€»åˆ†é’Ÿ
          const practicedOverall = overlapAfterStartMin; // å·²ç»ƒåˆ†é’Ÿï¼ˆä» firstStart èµ·ï¼‰
          const overallPct = totalSlotDur > 0 ? (practicedOverall / totalSlotDur) : 0;
          displayCoveragePct = +(overallPct * 100).toFixed(1);
        } else {
          displayCoveragePct = +((coverageEval) * 100).toFixed(1);
        }
        slotsDetail.push({
          start: slot.start,
          end: slot.end,
          durMin: +Math.max(0, evalDurMin).toFixed(1), // è¿›è¡Œä¸­ï¼šå½“å‰è¯„ä¼°çª—é•¿åº¦
          overlapMin: +overlapAfterStartMin.toFixed(1),
          coverage: displayCoveragePct,
          status,
          lateMin,
          latePenalty: +thisLatePenalty.toFixed(2)
        });
      }

      latePenalty = Math.min(latePenalty, p.lateCap);

      // äºŒæ¬¡å…œåº•ï¼šå¦‚æœâ€œå·²æœ‰æ—¶æ®µå¼€å§‹â€ä½†â€œå°šæ— ä»»ä½•ä¸å·²å¼€å§‹æ—¶æ®µçš„é‡å ç»ƒç´â€ï¼Œåˆ™ç»´åº¦ä¸€ä»åº”ä¸º 0 åˆ†ï¼Œä»…å±•ç¤ºçŠ¶æ€
      // é˜²æ­¢å‰ç½® hasOverlap è¯¯åˆ¤å¯¼è‡´åœ¨è¿›è¡Œä¸­é¦–æ®µæœªç™»è®°æ—¶å‡ºç° 40 åˆ†
      if (startedSlotsCount > 0 && !hasOverlapWithStarted) {
        return {
          score: 0,
          breakdown: {
            slots: slotsDetail,
            completed,
            totalSlots: 0,
            absent,
            latePenalty: 0,
            incompletePenalty: 0,
            absentPenalty: 0,
            fullBonus: 0,
            raw: 0,
            noRecords: true,
            startedButNoOverlap: true
          }
        };
      }

  // è‹¥å½“å‰å°šæ— ä»»ä½•å·²å¼€å§‹çš„æ—¶æ®µï¼Œåˆ™æœ¬æ¬¡ä¸äº§ç”Ÿæœªå®Œæˆ/ç¼ºå¸­/è¿Ÿåˆ°æ‰£åˆ†
  // è¿™é‡Œ totalDurMinã€overlapMin å‡ä»¥â€œèµ·ç»ƒåè¯„ä¼°çª—â€ä¸ºå£å¾„
  let coverageRate = 0, incompletePenalty = 0, absentPenalty = 0;
  const totalOverlapAfterStartMin = slotsDetail.reduce((sum, s) => sum + (Number.isFinite(s.overlapMin) ? s.overlapMin : 0), 0);
  coverageRate = totalDurMin > 0 ? (totalOverlapAfterStartMin / totalDurMin) : 0;
  // è¦†ç›–ç‡æ¥è¿‘ 100% æ—¶å®¹å·®å¤„ç†ï¼Œé¿å…æµ®ç‚¹è¯¯å·®å¯¼è‡´ 0.01 çš„æœªå®Œæˆæ‰£åˆ†
  // è¦†ç›–ç‡æ¥è¿‘ 100% æ—¶å®¹å·®å¤„ç†ï¼ˆé¿å…æ—¥å¿—ç§’çº§ç¼éš™å¯¼è‡´ 0.01~0.05 åˆ†å¾®æ‰£ï¼‰
  // æå‡å®¹å·®ï¼š0.0005 -> 0.002 (0.2%)ï¼Œå…¸å‹ 40 åˆ†æ»¡åˆ†ä¸‹æœ€å¤§å¯å¿½ç•¥ç¼ºå£çº¦ 0.08 åˆ†åŸå§‹å€¼ * 40% = 0.032 å®é™…å¾—åˆ†å½±å“ï¼ˆä»æ¯”è¿Ÿåˆ°/ç¼ºå¸­é‡çº§å°å¾ˆå¤šï¼‰
  const EPS_COVERAGE = 2e-3; // 0.2%
  let microGapSuppressed = false;
  if (coverageRate > 1 - EPS_COVERAGE) { coverageRate = 1; microGapSuppressed = true; }
      if (totalDurMin > 0) {
        incompletePenalty = (1 - coverageRate) * p.P_incomplete;
        absentPenalty = absent * p.pAbsent;
      } else {
        incompletePenalty = 0;
        absentPenalty = 0;
        latePenalty = 0;
      }

      let raw = 100 - incompletePenalty - latePenalty - absentPenalty;

      // è‹¥â€œçº³å…¥è®¡åˆ†çš„æ—¶æ®µâ€å…¨éƒ¨ç¼ºå¸­ï¼ˆæç«¯æƒ…å†µï¼‰ï¼Œåˆ™ raw å½’é›¶
      if (includedSlots > 0 && absent === includedSlots) {
        raw = 0;
      }

      // ä¸ºæ¯ä¸ªæ—¶æ®µåˆ†é…æœªå®Œæˆæ‰£åˆ†ä»½é¢ï¼ˆæŒ‰ç¼ºå¤±åˆ†é’Ÿæ•°å æ¯”ï¼‰ï¼Œå¹¶æ ‡æ³¨ç¼ºå¸­æ‰£åˆ†
      const totalMissingMin = slotsDetail.reduce((sum, s) => sum + Math.max(0, (s.durMin || 0) - (s.overlapMin || 0)), 0);
      for (const s of slotsDetail) {
        const miss = Math.max(0, (s.durMin || 0) - (s.overlapMin || 0));
        const incShare = totalMissingMin > 0 ? miss / totalMissingMin * incompletePenalty : 0;
        const ended = nowMin >= s.end;
        const isAbsent = ended && (s.overlapMin || 0) === 0;
        s.missMin = +miss.toFixed(1);
        s.incompletePenalty = +incShare.toFixed(2);
        s.absentPenalty = isAbsent ? +p.pAbsent.toFixed(2) : 0;
      }

      // æ»¡å‹¤æ ‡è®°ï¼šä»…åœ¨â€œå½“æ—¥æ‰€æœ‰æ—¶æ®µå‡å·²ç»“æŸä¸”æ— è¿Ÿåˆ°/ç¼ºå¸­ä¸”è¦†ç›–ç‡100%â€æ—¶è§¦å‘ï¼ˆä¸ç›´æ¥åŠ åˆ° D1 åˆ†ï¼Œè½¬ç§»åˆ°æ€»åˆ†å±‚é¢ï¼‰
      const slotCountIncluded = includedSlots;
      const gotFullBonus = (allSlotsEnded && slotCountIncluded >= 1 && coverageRate === 1 && latePenalty === 0 && absent === 0);
      
      // ğŸ¯ ç®€åŒ–æ»¡å‹¤åŠ åˆ†æ–¹æ¡ˆï¼šé€’å¢æ¨¡å¼ï¼Œé¿å…è¿‡åº¦å¥–åŠ±å¤šæ—¶æ®µ
      // è®¾è®¡åŸåˆ™ï¼šé¼“åŠ±å®Œæˆç»ƒç´ï¼Œä½†ä¸è¿‡åˆ†åå‘å¤šæ—¶æ®µå­¦ç”Ÿ
      // æ–°æ–¹æ¡ˆï¼š1æ®µ+0.5ï¼Œ2æ®µ+1ï¼Œâ‰¥3æ®µ+1.5ï¼ˆå°é¡¶ï¼‰ï¼Œä½“ç°å…¬å¹³åˆç†
      let fullBonusAward = 0;
      if (gotFullBonus && slotCountIncluded > 0) {
        // æŒ‰æ—¶æ®µæ•°é‡ç»™äºˆæ»¡å‹¤å¥–åŠ±
        if (slotCountIncluded === 1) {
          fullBonusAward = 0.5;      // 1æ®µï¼š0.5åˆ†
        } else if (slotCountIncluded === 2) {
          fullBonusAward = 1;        // 2æ®µï¼š1åˆ†
        } else {
          fullBonusAward = 1.5;      // â‰¥3æ®µï¼š1.5åˆ†ï¼ˆå°é¡¶ï¼‰
        }
      }

      raw = Math.max(0, Math.min(raw, 100));
      const score = +(((raw) / 100) * 40).toFixed(2);
  return { score, breakdown: {
        slots: slotsDetail,
        completed,
        totalSlots: slotCountIncluded,
        absent,
        latePenalty: +latePenalty.toFixed(2),
        incompletePenalty: +incompletePenalty.toFixed(2),
        absentPenalty: +absentPenalty.toFixed(2),
  fullBonus: fullBonusAward, // å±•ç¤ºä¸æ€»åˆ†å±‚é¢ä½¿ç”¨çš„åŠ¨æ€åŠ æˆ
  gotFullBonus,
  fullBonusAward,
        raw: +raw.toFixed(2),
  coverageRate: +coverageRate.toFixed(4),
  microGapSuppressed
      } };
    }

    // ç»´åº¦2ï¼šè´¨é‡æ•ˆç‡ï¼ˆé•¿æ—¶/ä½æ•ˆçª—å£/çŸ­æ—¶/æ‹–å°¾ï¼‰
    function computeDim2Score(slotsMin, intervalsMs, dayStartMs, weekday0to6) {
      const p = LB442_PARAMS.dim2;
      if (!intervalsMs || !intervalsMs.length) {
        return { score: 0, breakdown: { intervals: [], longPenalty: 0, windowPenalty: 0, shortPenalty: 0, tailPenalty: 0, totalPenalty: 0, raw: 100 } };
      }
      const merged = mergeIntervalsMs(intervalsMs);
      const lowWins = getDailyLowEffWindowsByWeekday(weekday0to6);
      const shortExemptWins = getShortPenaltyExemptWindowsByWeekday(weekday0to6);
  // æ’è¡Œæ¦œçª—å£ç»“æŸåˆ†é’Ÿï¼ˆç”¨äºæˆªæ­¢æˆªæ–­çŸ­å‹¤ä¸æ‰£åˆ†ï¼‰
  const winEndMin = ([1,2,4,5].includes(weekday0to6)) ? (19*60+0) : (weekday0to6===3 ? (19*60+30) : null);
      // é¢„å¤„ç†æ—¶æ®µï¼Œå¢åŠ  nextStart ä»¥æ”¯æŒâ€œè¿›å…¥ä¸‹ä¸€ä¸ªæ—¶æ®µåä¸ç®—æ‹–å°¾â€è§„åˆ™
      const slotsSorted = (slotsMin || []).slice().sort((a,b)=>a.start-b.start).map(s=>({start:s.start,end:s.end}));
      for (let i=0;i<slotsSorted.length;i++) {
        slotsSorted[i].nextStart = (i+1 < slotsSorted.length) ? slotsSorted[i+1].start : Infinity;
      }
      
      let longPenalty = 0, windowPenalty = 0, shortPenalty = 0, tailPenalty = 0;
      const intervalDetail = [];
      
      for (const iv of merged) {
        const startMin = Math.floor((iv.start - dayStartMs) / 60000);
        const endMin = Math.floor((iv.end - dayStartMs) / 60000);
        if (endMin <= startMin) continue;
        const L = endMin - startMin;
        
        // 1. è¶…é•¿æ‰£åˆ†ï¼ˆæ€»æ˜¯åº”ç”¨ï¼‰
        let thisLongPenalty = 0;
        if (L > p.longStartMin) {
          const over = Math.min(L - p.longStartMin, p.longCapExtraMin);
          thisLongPenalty = over * p.pLong;
          longPenalty += thisLongPenalty;
        }
        
        // 2. çŸ­æ—¶æ‰£åˆ†ï¼ˆ1-30åˆ†é’Ÿæ‰æ‰£åˆ†ï¼Œé¿å…è¯¯è§¦è®°å½•è¢«è¿‡åº¦æ‰£åˆ†ï¼‰
        let thisShortPenalty = 0;
        if (L < p.shortThreshold && L > 1) {
          // æˆªæ­¢æˆªæ–­ä¿æŠ¤ï¼šè‹¥è¯¥åŒºé—´æ°å¥½åœ¨æ’è¡Œæ¦œæˆªæ­¢æ—¶é—´ç»“æŸï¼Œåˆ™è§†ä¸ºè¢«çª—å£æˆªæ–­ï¼Œä¸ç®—çŸ­æ—¶æ‰£åˆ†
          const atCutoff = (winEndMin != null && endMin === winEndMin);
          // å…æ‰£åˆ†çª—å£ä¿æŠ¤ï¼šå¦‚æœç»ƒç´åŒºé—´ä¸å…æ‰£åˆ†çª—å£æœ‰é‡å ï¼Œåˆ™ä¸è®¡ç®—çŸ­æ—¶æ‰£åˆ†
          let inExemptWindow = false;
          for (const exemptWin of shortExemptWins) {
            if (startMin < exemptWin.endMin && endMin > exemptWin.startMin) {
              inExemptWindow = true;
              break;
            }
          }
          if (!atCutoff && !inExemptWindow) {
            thisShortPenalty = (p.shortThreshold - L) * p.pShort;
            shortPenalty += thisShortPenalty;
          }
        }
        
        // 3. ä½æ•ˆçª—å£ vs æ‹–å°¾æ‰£åˆ†ï¼šåªåº”ç”¨å…¶ä¸­ä¹‹ä¸€ï¼ˆä¼˜å…ˆæ‹–å°¾ï¼‰
        let appliedTailPenalty = false;
        let thisTailPenalty = 0, thisWindowPenalty = 0, overlapLow = 0, tailMin = 0;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ‹–å°¾æ‰£åˆ†ï¼ˆè§„åˆ™ï¼šè¶…è¿‡æŸæ—¶æ®µç»“æŸ + grace ä¸”è¯¥å»¶ä¼¸éƒ¨åˆ†æœªè¿›å…¥ä¸‹ä¸€æ—¶æ®µå¼€å§‹ä¹‹å‰ï¼‰
        for (const sl of slotsSorted) {
          const se = sl.end;
          // å¿…é¡»è·¨è¿‡è¯¥æ®µç»“æŸ + grace
          if (!(startMin < se && endMin > se + p.tail.grace)) continue;
          // ğŸ”§ ä¿®æ­£æ‹–å°¾åˆ¤å®šé€»è¾‘ï¼šåªæœ‰"ç´§å¯†è¿ç»­"çš„æ—¶æ®µæ‰å…é™¤æ‹–å°¾æ‰£åˆ†
          // åˆ¤æ–­æ ‡å‡†ï¼šæ—¶æ®µç»“æŸ+grace åˆ°ä¸‹ä¸€ä¸ªæ—¶æ®µå¼€å§‹ä¹‹é—´çš„é—´éš™å¤§å°
          // åœºæ™¯ï¼š8:00-8:50, 10:00-10:50ï¼ˆä¸­é—´é—´éš”70åˆ†é’Ÿï¼‰
          // - 8:00-10:30ç»ƒç´ï¼š8:50åçš„å»¶ä¼¸è™½ç„¶è¿›å…¥äº†10:00æ—¶æ®µï¼Œä½†9:15-10:00ä¹‹é—´åº”ç®—æ‹–å°¾
          // - 8:00-9:30ç»ƒç´ï¼š8:50åçš„å»¶ä¼¸ä¹Ÿåº”è¯¥ç®—æ‹–å°¾
          const gapToNextSlot = (sl.nextStart !== Infinity) ? (sl.nextStart - (se + p.tail.grace)) : Infinity;
          const MAX_GAP_FOR_CONTINUOUS = 15; // æœ€å¤§å…è®¸é—´éš™15åˆ†é’Ÿè§†ä¸ºè¿ç»­æ—¶æ®µ
          
          if (gapToNextSlot > MAX_GAP_FOR_CONTINUOUS) {
            // é—´éš™è¿‡å¤§ï¼ˆå¦‚70åˆ†é’Ÿï¼‰ï¼šæ—¶æ®µä¸è¿ç»­ï¼Œåº”è®¡ç®—æ‹–å°¾æ‰£åˆ†
            // åªè®¡ç®—graceæœŸåçš„æ‹–å°¾éƒ¨åˆ†ï¼Œä¸Šé™ä¸ºtail.capMinutes
            const tailStart = se + p.tail.grace;
            const tailEnd = Math.min(endMin, tailStart + p.tail.capMinutes);
            const rawTail = tailEnd - tailStart;
            if (rawTail > 0) {
              const tail = Math.min(rawTail, p.tail.capMinutes);
              tailMin = tail;
              thisTailPenalty = tail * p.tail.p;
              tailPenalty += thisTailPenalty;
              appliedTailPenalty = true;
              break;
            }
          } else {
            // é—´éš™å°ï¼ˆâ‰¤15åˆ†é’Ÿï¼‰ï¼šæ—¶æ®µè¾ƒè¿ç»­ï¼Œæ£€æŸ¥æ˜¯å¦çœŸæ­£è¡”æ¥åˆ°ä¸‹ä¸€æ®µ
            if (sl.nextStart !== Infinity && endMin > sl.nextStart) {
              // å»¶ä¼¸åˆ°ä¸‹ä¸€ä¸ªè§„å®šæ—¶æ®µå¼€å§‹ä¹‹åï¼Œä¸”æ—¶æ®µç´§å¯†è¿ç»­ï¼Œä¸ç®—æ‹–å°¾
              continue;
            }
            // æ²¡æœ‰å»¶ä¼¸åˆ°ä¸‹ä¸€æ®µï¼šæ­£å¸¸è®¡ç®—æ‹–å°¾
            if (sl.nextStart <= se + p.tail.grace) continue;
            const tailRegionEnd = Math.min(endMin, sl.nextStart);
            const rawTail = tailRegionEnd - (se + p.tail.grace);
            if (rawTail > 0) {
              const tail = Math.min(rawTail, p.tail.capMinutes);
              tailMin = tail;
              thisTailPenalty = tail * p.tail.p;
              tailPenalty += thisTailPenalty;
              appliedTailPenalty = true;
              break;
            }
          }

        }
        
        // å¦‚æœæ²¡æœ‰æ‹–å°¾æ‰£åˆ†ï¼Œæ‰æ£€æŸ¥ä½æ•ˆçª—å£æ‰£åˆ†
        if (!appliedTailPenalty) {
          overlapLow = 0;
          for (const w of lowWins) {
            if (endMin <= w.startMin || startMin >= w.endMin) continue;
            const overlap = Math.min(endMin, w.endMin) - Math.max(startMin, w.startMin);
            // åº”ç”¨å®½é™æ—¶é—´ï¼šåªæœ‰è¶…è¿‡ graceMin çš„éƒ¨åˆ†æ‰è®¡å…¥æ‰£åˆ†
            const grace = w.graceMin || 0;
            if (overlap > grace) {
              overlapLow += (overlap - grace);
            }
          }
          if (overlapLow > 0) {
            thisWindowPenalty = Math.min(overlapLow * p.pWindow, p.windowCapPerSession);
            windowPenalty += thisWindowPenalty;
          }
        }

        intervalDetail.push({
          startMin, endMin, lengthMin: L,
          longOverMin: Math.max(0, L - p.longStartMin), longPenalty: +thisLongPenalty.toFixed(2),
          shortDeficitMin: L < p.shortThreshold ? (p.shortThreshold - L) : 0, shortPenalty: +thisShortPenalty.toFixed(2),
          lowOverlapMin: overlapLow, lowPenalty: +thisWindowPenalty.toFixed(2),
          tailMin, tailPenalty: +thisTailPenalty.toFixed(2),
          appliedTail: appliedTailPenalty,
          intervalPenalty: +(thisLongPenalty + thisShortPenalty + (appliedTailPenalty ? thisTailPenalty : thisWindowPenalty)).toFixed(2)
        });
      }
      
      const totalPenalty = longPenalty + windowPenalty + shortPenalty + tailPenalty;
      let raw = 100 - totalPenalty;
      raw = Math.max(0, Math.min(raw, 100));
      const score = +((raw / 100) * 40).toFixed(2);
      return { score, breakdown: {
        intervals: intervalDetail,
        longPenalty: +longPenalty.toFixed(2),
        windowPenalty: +windowPenalty.toFixed(2),
        shortPenalty: +shortPenalty.toFixed(2),
        tailPenalty: +tailPenalty.toFixed(2),
        totalPenalty: +totalPenalty.toFixed(2),
        raw: +raw.toFixed(2)
      } };
    }

    function getTodaySlotsMinutes(studentName, today) {
      const weekday1to7 = utils.getWeekday(today); // 1..7ï¼Œå‘¨ä¸€=1ï¼Œå‘¨æ—¥=7
      const ts = appState.timeSlots.get(studentName);
      const list = (ts && ts[weekday1to7]) ? ts[weekday1to7] : [];
      // ç°æœ‰ç»“æ„ï¼š[{start_time, end_time}]ï¼ˆå­—ç¬¦ä¸² HH:MMï¼‰æˆ– {start, end}ï¼ˆåˆ†é’Ÿï¼‰
      return (list || []).map(s => {
        const startRaw = (s.start !== undefined) ? s.start : (s.start_time || s.start);
        const endRaw = (s.end !== undefined) ? s.end : (s.end_time || s.end);
        const start = (typeof startRaw === 'number') ? startRaw : utils.parseTimeSlot(startRaw);
        const end = (typeof endRaw === 'number') ? endRaw : utils.parseTimeSlot(endRaw);
        return { start, end };
      }).filter(x => Number.isFinite(x.start) && Number.isFinite(x.end) && x.end > x.start);
    }

    function getTodayPracticeIntervalsMs(studentName, today) {
      const dateKey = utils.getDateKey(today);
      const logs = (appState.practiceLogs || []).filter(log => {
        const nm = log.student_name || log.student || log.studentName;
        if (nm !== studentName) return false;
        const dKey = utils.getDateKey(new Date(log.timestamp));
        return dKey === dateKey;
      }).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      const intervals = [];
      let curStart = null;
      logs.forEach(log => {
        const action = String(log.action || '').toLowerCase();
        const isEnter = action === 'enter' || action === 'assign';
        const isExit = action === 'exit' || action === 'clear';
        if (isEnter) {
          if (curStart == null) curStart = new Date(log.timestamp).getTime();
        } else if (isExit) {
          if (curStart != null) {
            const end = new Date(log.timestamp).getTime();
            if (end > curStart) intervals.push({ start: curStart, end });
            curStart = null;
          }
        }
      });
      if (curStart != null) {
        const now = Date.now();
        if (now > curStart) intervals.push({ start: curStart, end: now });
      }
      return intervals;
    }

    // === æ’è¡Œæ¦œä¸“ç”¨çª—å£ä¸è£å‰ª ===
    // å‘¨1/2/4/5: 08:00-18:40  (å…±11å°æ—¶)
    // å‘¨3      : 08:00-19:30  (å…±11å°æ—¶30åˆ†)
    // å…¶ä½™(å‘¨å…­æ—¥)ä¸å‚ä¸æ’è¡Œæ¦œ
    function getLeaderboardWindow(date){
      const wd = date.getDay(); // 0=Sun 1=Mon ... 6=Sat
      if (wd === 3) { // å‘¨ä¸‰
        return { startMin: 8*60, endMin: 19*60 + 10 };
      }
      if ([1,2,4,5].includes(wd)) {
        return { startMin: 8*60, endMin: 18*60 + 40 };
      }
      return null; // å‘¨æœ«æˆ–å‘¨æ—¥/å‘¨å…­ä¸å‚ä¸
    }

    function clipIntervalMsToWindow(iv, dayStartMs, win){
      const ws = dayStartMs + win.startMin*60000;
      const we = dayStartMs + win.endMin*60000;
      const s = Math.max(iv.start, ws);
      const e = Math.min(iv.end, we);
      if (e - s > 0) return { start: s, end: e };
      return null;
    }

    // è£å‰ª slots åˆ†æ®µåˆ°æ’è¡Œæ¦œçª—å£ï¼ˆåªä¿ç•™é‡å éƒ¨åˆ†ï¼‰
    function getLeaderboardSlotsMinutes(studentName, date){
      const win = getLeaderboardWindow(date);
      if (!win) return [];
      const orig = getTodaySlotsMinutes(studentName, date) || [];
      return orig.map(s => {
        const st = Math.max(s.start, win.startMin);
        const ed = Math.min(s.end, win.endMin);
        return { start: st, end: ed };
      }).filter(s => s.end > s.start);
    }

    // è£å‰ªç»ƒä¹ åŒºé—´åˆ°æ’è¡Œæ¦œçª—å£
    function getLeaderboardPracticeIntervalsMs(studentName, date){
      const win = getLeaderboardWindow(date);
      if(!win) return [];
      const base = getTodayPracticeIntervalsMs(studentName, date) || [];
      const dayStartMs = toDayStart(date);
      const out = [];
      for (const iv of base){
        const clipped = clipIntervalMsToWindow(iv, dayStartMs, win);
        if (clipped) out.push(clipped);
      }
      return out;
    }

    function getActiveLeaderboardDate() {
      const now = new Date();
      // ğŸ”§ ä¼˜åŒ–ï¼šç¼©çŸ­æ—¥æœŸåˆ‡æ¢çª—å£ï¼Œå‡å°‘æ··æ·†ï¼ˆ06:00 -> 07:30 æ”¹ä¸º 07:00 -> 07:30ï¼‰
      const minutesSinceMidnight = now.getHours() * 60 + now.getMinutes();
      const cutoffMinutes = 7*60; // 07:00 ä½œä¸ºåˆ‡æ¢ç‚¹ï¼Œå‡å°‘æ··æ·†çª—å£
      
      const result = minutesSinceMidnight < cutoffMinutes 
        ? new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1)
        : new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      // ğŸ“Š å¢å¼ºæ—¥å¿—ç›‘æ§ï¼šåœ¨åˆ‡æ¢çª—å£æœŸæä¾›æ›´è¯¦ç»†ä¿¡æ¯
      if (minutesSinceMidnight >= (cutoffMinutes - 30) && minutesSinceMidnight < (cutoffMinutes + 30)) {
        const realToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const realTodayIso = utils.toIsoDate(realToday);
        const activeIso = utils.toIsoDate(result);
        
        console.warn('[æ—¥æœŸåˆ‡æ¢ç›‘æ§] å¤„äºæ•æ„Ÿæ—¶é—´çª—å£', {
          currentTime: now.toTimeString().substring(0, 8),
          minutesSinceMidnight,
          activeDate: activeIso,
          realDate: realTodayIso,
          isInCutoffWindow: true,
          cutoffAt: `${Math.floor(cutoffMinutes/60).toString().padStart(2,'0')}:${(cutoffMinutes%60).toString().padStart(2,'0')}`,
          dayOfWeek: ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][result.getDay()],
          warning: activeIso !== realTodayIso ? 'æ´»è·ƒæ—¥æœŸä¸çœŸå®æ—¥æœŸä¸ä¸€è‡´ï¼' : 'æ—¥æœŸä¸€è‡´'
        });
      }
      
      return result;
    }

    async function ensureDailyLeaderboard(date){
      const key = formatDateKey(date);
      if(appState.dailyLeaderboards.has(key)) return appState.dailyLeaderboards.get(key);
      // å°è¯•ä»åç«¯è¯»å–å¤‡ä»½
  const backend = await fetchDailyLeaderboardMap(date);
      if (backend) { appState.dailyLeaderboards.set(key, backend); return backend; }
      // å›é€€ï¼šæœ¬åœ°ç°ç®—
      const map = new Map();
      const arr = Array.from(appState.students.values()).map(stu => {
        const dayStartMs = toDayStart(date);
        const slotsMin = getLeaderboardSlotsMinutes(stu.name, date);
        const intervalsMs = getLeaderboardPracticeIntervalsMs(stu.name, date);
        const d1 = computeDim1Score(slotsMin, intervalsMs, dayStartMs);
        const d2 = computeDim2Score(slotsMin, intervalsMs, dayStartMs, date.getDay());
        return { name: stu.name, score: d1.score + d2.score };
      }).sort((a, b) => b.score - a.score);
      arr.forEach((x, idx) => map.set(x.name, idx + 1));
      appState.dailyLeaderboards.set(key, map);
      return map;
    }

    async function buildPrevDayRankingMap(date) {
      return await ensureDailyLeaderboard(date);
    }

    // ==== åéœ¸æ¦œè¾…åŠ©ï¼šç®€æ˜“å†å²ç¼“å­˜ï¼ˆä»…å·¥ä½œæ—¥å‘åè¿½æº¯æœ€å¤š14å¤©ï¼‰ ====
    const __rankTopCache = new Map(); // key: dateKey => [top1Name]

    function formatDateKey(d){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function isWorkday(d){
      const wd = d.getDay();
      return wd>=1 && wd<=5;
    }

    // å·¥ä½œæ—¥è¾…åŠ©
    function nearestWorkdayOnOrBefore(date){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      while(!isWorkday(d)) d.setDate(d.getDate()-1);
      return d;
    }
    function previousWorkday(date){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate()-1);
      return nearestWorkdayOnOrBefore(d);
    }
    function getLastNWorkdayDates(endDate, n){
      const arr=[]; let d = nearestWorkdayOnOrBefore(endDate);
      while(arr.length < n){ if(isWorkday(d)) arr.push(new Date(d.getFullYear(), d.getMonth(), d.getDate())); d.setDate(d.getDate()-1); }
      return arr.reverse();
    }

    // ä»æ•°æ®åº“æŸ¥è¯¢æŸæ—¥çš„ç¬¬ä¸€åï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼Œç”¨äºå…¬å¹³æ€§å¥–åŠ±åˆ¤æ–­ï¼‰
    async function getTopNameForDateFromDB(date){
      if (!supabaseClient) return null;
      
      try {
        const dateISO = utils.toIsoDate(date);
        
        // ä»æ•°æ®åº“æŸ¥è¯¢è¯¥æ—¥æ‰€æœ‰å­¦ç”Ÿçš„ D1+D2 åˆ†æ•°
        const { data, error } = await supabaseClient
          .from('leaderboard_daily')
          .select('student_key, d1, d2')
          .eq('date', dateISO)
          .not('no_practice', 'eq', true);
        
        if (error || !data || data.length === 0) {
          // æ•°æ®åº“æ— æ•°æ®ï¼Œé™çº§ä¸ºå®æ—¶è®¡ç®—
          return getTopNameForDate(date);
        }
        
        // è®¡ç®— D1+D2 æ€»åˆ†ï¼Œæ‰¾å‡ºæœ€é«˜åˆ†
        const scores = data.map(row => ({
          name: utils.denormalizeStudentName(row.student_key),
          score: (Number(row.d1) || 0) + (Number(row.d2) || 0)
        })).sort((a, b) => b.score - a.score);
        
        if (scores.length === 0) return [];
        
        // è¿”å›æ‰€æœ‰å¹¶åˆ—ç¬¬ä¸€çš„å­¦ç”Ÿ
        const topScore = scores[0].score;
        const topNames = scores.filter(s => s.score === topScore).map(s => s.name);
        return topNames;
        
      } catch(e) {
        console.error('[getTopNameForDateFromDB] æŸ¥è¯¢å¤±è´¥:', e);
        // é™çº§ä¸ºå®æ—¶è®¡ç®—
        return getTopNameForDate(date);
      }
    }

    function getTopNameForDate(date){
      const key = formatDateKey(date);
      if(__rankTopCache.has(key)) return __rankTopCache.get(key);
      // è®¡ç®—è¯¥æ—¥æ‰€æœ‰å­¦ç”Ÿçš„ D1+D2 åˆ†ï¼Œè¿”å›æ‰€æœ‰å¹¶åˆ—ç¬¬ä¸€çš„å­¦ç”Ÿæ•°ç»„
      const arr = Array.from(appState.students.values()).map(stu => {
        const dayStartMs = toDayStart(date);
        const slotsMin = getLeaderboardSlotsMinutes(stu.name, date);
        const intervalsMs = getLeaderboardPracticeIntervalsMs(stu.name, date);
        const d1 = computeDim1Score(slotsMin, intervalsMs, dayStartMs);
        const d2 = computeDim2Score(slotsMin, intervalsMs, dayStartMs, date.getDay());
        return { name: stu.name, score: d1.score + d2.score };
      }).sort((a,b)=>b.score-a.score);
      // è¿”å›æ‰€æœ‰å¹¶åˆ—ç¬¬ä¸€çš„å­¦ç”Ÿæ•°ç»„
      const topScore = arr[0]?.score;
      const topNames = topScore != null ? arr.filter(s => s.score === topScore).map(s => s.name) : [];
      __rankTopCache.set(key, topNames);
      return topNames;
    }

    async function getConsecutiveTopWorkdaysUpTo(date, studentName){
      // ä»ç»™å®šæ—¥æœŸå‘å‰æŒ‰å·¥ä½œæ—¥ç»Ÿè®¡è¿ç»­ç‹¬å ç¬¬ä¸€çš„å¤©æ•°ï¼ˆå¹¶åˆ—ç¬¬ä¸€ä¸è®¡å…¥ï¼‰
      // ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“æ•°æ®ï¼Œç¡®ä¿ä¸442è¶‹åŠ¿å›¾ä¸€è‡´
      let cnt = 0;
      let d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      for(let i=0;i<14;i++){
        if(!isWorkday(d)) { d.setDate(d.getDate()-1); continue; }
        const topNames = await getTopNameForDateFromDB(d); // ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢
        // åªæœ‰ç‹¬å ç¬¬ä¸€ï¼ˆæ•°ç»„é•¿åº¦ä¸º1ä¸”æ˜¯è¯¥å­¦ç”Ÿï¼‰æ‰è®¡å…¥è¿ç»­å¤©æ•°
        if(Array.isArray(topNames) && topNames.length === 1 && topNames[0] === studentName){
          cnt++;
        } else {
          // å¹¶åˆ—ç¬¬ä¸€æˆ–ä¸æ˜¯ç¬¬ä¸€ï¼Œä¸­æ–­è¿ç»­è®¡æ•°
          break;
        }
        d.setDate(d.getDate()-1);
      }
      return cnt;
    }

    async function getWorkdaysSinceLastTop(date, studentName){
      // ä»å‰ä¸€å·¥ä½œæ—¥èµ·å‘å‰æ‰¾ä¸Šæ¬¡ç™»é¡¶çš„å·¥ä½œæ—¥è·ç¦»ï¼ˆåŒ…æ‹¬å¹¶åˆ—ç¬¬ä¸€ï¼‰
      // ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“æ•°æ®ï¼Œç¡®ä¿ä¸442è¶‹åŠ¿å›¾ä¸€è‡´
      let days = 0;
      let d = new Date(date.getFullYear(), date.getMonth(), date.getDate()-1);
      for(let i=0;i<30;i++){
        if(!isWorkday(d)) { d.setDate(d.getDate()-1); continue; }
        const topNames = await getTopNameForDateFromDB(d); // ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢
        // åªè¦åœ¨å¹¶åˆ—ç¬¬ä¸€åå•ä¸­å°±ç®—ç™»é¡¶è¿‡
        if(Array.isArray(topNames) && topNames.includes(studentName)) return days; // æ‰¾åˆ°
        days++;
        d.setDate(d.getDate()-1);
      }
      return days; // æ²¡æ‰¾åˆ°åˆ™è®¤ä¸ºå¾ˆä¹…æœªç™»é¡¶
    }
    function getDailyD12Score(studentName, date) {
      // è®¡ç®—æŒ‡å®šæ—¥æœŸçš„ D1+D2 æ€»åˆ†
      try {
        const dayStartMs = toDayStart(date);
        const weekday0to6 = date.getDay();
  const slotsMin = getLeaderboardSlotsMinutes(studentName, date);
  const intervalsMs = getLeaderboardPracticeIntervalsMs(studentName, date);
        const d1 = computeDim1Score(slotsMin, intervalsMs, dayStartMs);
        const d2 = computeDim2Score(slotsMin, intervalsMs, dayStartMs, weekday0to6);
        return d1.score + d2.score;
      } catch { return 0; }
    }

    function getLastNDaysD12Scores(studentName, endDate, n) {
      const out = [];
      for (let i = n - 1; i >= 0; i--) {
        const d = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate() - i);
        out.push(getDailyD12Score(studentName, d));
      }
      return out;
    }

        // é€åæ¬¡ç»†åŒ–æ’ååŠ åˆ†ï¼š
        // 1å=3åˆ†, 10å=1åˆ†, 2-9åçº¿æ€§æ’å€¼: score = 3 - (rank-1)*( (3-1)/(10-1) ) = 3 - (rank-1)*(2/9)
        // rank <=0 æˆ– éæ•°å­—è¿”å› 0ï¼›rank>10 â†’ 0ã€‚
        // å¯æ ¹æ®éœ€è¦æ”¹ä¸ºéçº¿æ€§ï¼ˆä¾‹å¦‚å¹‚æ¬¡æˆ–å¯¹æ•°ï¼‰ï¼Œå…ˆä¿æŒçº¿æ€§ç¡®ä¿æ€»åŒºé—´ä¸åŸä¸Šé™ä¸€è‡´ã€‚
        function computeRankPoints(rank){
          if(!Number.isFinite(rank) || rank<=0) return 0;
          if(rank===1) return 3;
          if(rank>=10) return rank===10 ? 1 : 0;
          const val = 3 - (rank-1)*(2/9); // rank in [1,10]
          // ä¿ç•™åˆ° 2 ä½ï¼Œé¿å…æµ®ç‚¹å™ªå£°
          return +val.toFixed(2);
        }

        // è¿ç»­åŒ–ç¨³å®šæ€§åˆ†ï¼šstd=0 -> 3 åˆ†ï¼›std>=15 -> 0 åˆ†ï¼›ä¸­é—´çº¿æ€§è¡°å‡ã€‚
        // åŸç¦»æ•£é˜ˆå€¼: <=3(3åˆ†),<=5(2),<=10(1),<=15(0.5),>15(0)
        // æ–°å…¬å¼æ›´å¹³æ»‘ï¼šscore = 3 * max(0, 1 - std/15)
        // ä¿ç•™ä¸¤ä½å†è¾“å‡ºï¼ˆå±•ç¤ºå±‚ä»å¯ä¸€ä½ï¼‰ã€‚
        function computeConsistencyPoints(std){
          if(!Number.isFinite(std) || std<0) return 0;
          const val = 8 * Math.max(0, 1 - std/15);
          return +val.toFixed(2);
        }

  async function computeDim3Score(studentName, activeDate, todayD12, prevDayRankMap) {
      // sFreshï¼šä»…â€œä»Šæ—¥æ´»è·ƒåº¦â€åˆ†ï¼›antiBonusï¼šåéœ¸æ¦œçš„å…¬å¹³æ€§å¥–åŠ±ï¼Œç‹¬ç«‹äºä»Šæ—¥æ´»è·ƒåº¦
      let sRank = 0, sProgress = 0, sConsistency = 0, sFresh = 0, antiBonus = 0;
      // å‘¨æœ«ä¸è®¡ç®—ç»´åº¦ä¸‰ï¼ˆå®Œå…¨ç¦ç”¨ï¼‰ï¼Œè¿”å›æ ‡è®°ï¼Œåç»­æ€»åˆ†è®¡ç®—ä¼šè¢«å‘¨æœ«æ—©é€€é€»è¾‘æ‹¦æˆª
      if (!isWorkday(activeDate)) {
        return { score: 0, breakdown: { weekend: true, disabled: true } };
      }
  // æ˜¨æ—¥æ’è¡Œï¼šæ”¹ä¸ºé€åæ¬¡ç»†åŒ–ï¼ˆ1å=3åˆ†ï¼Œ10å=1åˆ†ï¼Œä¸­é—´çº¿æ€§æ’å€¼ï¼›>10å=0ï¼‰
  const pr = prevDayRankMap?.get(studentName);
  sRank = computeRankPoints(pr);
      
  // å‘¨è¿›æ­¥ï¼šè¿‘7ä¸ªå·¥ä½œæ—¥ vs å‰7ä¸ªå·¥ä½œæ—¥ï¼ˆæ’é™¤å‘¨å…­å‘¨æ—¥ï¼‰ï¼Œæœ€å¤š8åˆ†ï¼Œä¸Šé™50%æå‡
  const endWorkday = nearestWorkdayOnOrBefore(activeDate);
  const WN = p3.progress.windowSize || 5;
  const curDates = getLastNWorkdayDates(endWorkday, WN);
  const cur7 = curDates.map(d => getDailyD12Score(studentName, d));
  const prevWindowEnd = previousWorkday(curDates[0]);
  const prevDates = getLastNWorkdayDates(prevWindowEnd, WN);
  const prev7 = prevDates.map(d => getDailyD12Score(studentName, d));
  // å†å²å‚è€ƒä»…ç»Ÿè®¡â€œæœ‰ç»ƒç´çš„å·¥ä½œæ—¥â€ï¼ˆ>0åˆ†çš„å¤©ï¼‰ï¼Œæ— ç»ƒç´å¤©ä¸çº³å…¥å‚è€ƒ
  const sum = a => a.reduce((x, y) => x + y, 0);
  const curActiveArr = cur7.filter(v => v > 0);
  const prevActiveArr = prev7.filter(v => v > 0);
  const sCur = sum(curActiveArr), sPrev = sum(prevActiveArr);
      // å°åˆ†æ¯/åŸºçº¿ä¿æŠ¤ï¼šå‰å‘¨æä½æ—¶ä¸è®¡æˆ–ä»¥ä¸‹é™åˆ†æ¯è®¡ç®—æå‡å æ¯”
      let appliedProgressRatio = 0;
      const p3 = LB442_PARAMS.dim3;
      // æ•°æ®å……è¶³é—¨æ§›ï¼šä¸¤ä¸ªçª—å£å„è‡ªæœ‰æ•ˆå¤©æ•°ï¼ˆ>0åˆ†ï¼‰è¦è¾¾åˆ°é˜ˆå€¼
  const curActiveDays = curActiveArr.length;
  const prevActiveDays = prevActiveArr.length;
      const passActiveDaysGate = (curActiveDays >= p3.progress.minActiveDaysPerWindow) && (prevActiveDays >= p3.progress.minActiveDaysPerWindow);
      // æ£€æŸ¥å‰çª—å£æ¯ä¸ªæœ‰æ•ˆè®°å½•éƒ½ä¸ä½äºæœ€ä½åˆ†æ•°è¦æ±‚
      const prevRecordsQualified = prevActiveArr.every(score => score >= p3.progress.minPrevTotal);
      if (passActiveDaysGate && prevRecordsQualified && sCur > sPrev) {
        // ä½¿ç”¨æœ‰æ•ˆè®°å½•çš„å¹³å‡å€¼ï¼Œè€Œä¸æ˜¯çª—å£å¹³å‡å€¼
        const avgCur = sCur / curActiveDays;  // å½“å‰æœ‰æ•ˆè®°å½•çš„å¹³å‡å€¼
        const avgPrev = sPrev / prevActiveDays;  // å‰æœŸæœ‰æ•ˆè®°å½•çš„å¹³å‡å€¼
        const denomAvg = Math.max(avgPrev, p3.progress.denomFloor / Math.max(1, prevActiveDays));
        const rawRatio = (avgCur - avgPrev) / denomAvg; // 0 ~ ~
        appliedProgressRatio = Math.min(p3.progress.maxRatio, Math.max(0, rawRatio));
        const ratioPct = appliedProgressRatio / p3.progress.maxRatio;
        sProgress = Math.min(8, +(ratioPct * 8).toFixed(2));
      }
      
  // ç¨³å®šæ€§ï¼šä»…åŸºäºâ€œæœ‰æ•ˆå·¥ä½œæ—¥â€ï¼ˆ>0åˆ†ï¼‰è®¡ç®—æ ‡å‡†å·®
      const activeDays = curActiveArr.length;
      let std = 0;
      if (activeDays > 0) {
        const mean = sCur / activeDays;
        const variance = curActiveArr.reduce((acc, v) => acc + Math.pow(v - mean, 2), 0) / activeDays;
        std = Math.sqrt(variance);
      } else {
        std = 0;
      }
      // æœ€ä½æ´»è·ƒé—¨æ§›ï¼šè¿‘7ä¸ªâ€œæœ‰æ•ˆå·¥ä½œæ—¥â€â‰¥3 æˆ– æœ‰æ•ˆæ€»åˆ†â‰¥40ï¼Œå¦åˆ™ä¸æˆäºˆç¨³å®šæ€§åˆ†
      // éœ€è¦æœ€å°è®°å½•æ•°é‡æ‰èƒ½è®¡ç®—æ ‡å‡†å·®åŠ åˆ†
      const minRecordsForStability = p3.consistency?.minRecords || 3;
      if (activeDays >= minRecordsForStability) {
        sConsistency = computeConsistencyPoints(std);
      } else {
        sConsistency = 0;
      }
      
  // åˆ é™¤â€œä»Šæ—¥æ´»è·ƒåº¦â€åŠ åˆ†ï¼ˆå†å²è§„åˆ™è°ƒæ•´ï¼ŒD3 ä¸å†åŒ…å«å½“æ—¥æ´»è·ƒåº¦ï¼‰

      // åéœ¸æ¦œæœºåˆ¶ï¼ˆåŸºäºå·¥ä½œæ—¥ Top1 è¿ç»­å¤©æ•°ä¸è·ä¸Šæ¬¡ç™»é¡¶å¤©æ•°ï¼‰
      // åéœ¸æ¦œï¼ˆä¹˜å­ä¸å…¬å¹³æ€§å¥–åŠ±ï¼‰
      // ä¹˜å­ä»…ä½œç”¨åŸºç¡€åˆ†ï¼ˆä¸å«å…¬å¹³æ€§å¥–åŠ±ï¼‰ï¼›å…¬å¹³æ€§å¥–åŠ±ä¸å—ä¹˜å­å½±å“
      // æ³¨ï¼šå¤§å¤šæ•°æœªè¿‘æœŸç™»é¡¶è€…ä¼šè·å¾— +freshBreakBonus çš„å¸¸é©»é¼“åŠ±ï¼Œç”¨äºæŠ‘åˆ¶å•äººé•¿æœŸå„æ–­å¸¦æ¥çš„ç›¸å¯¹åŠ£åŠ¿
      const p3_anti = LB442_PARAMS.dim3;
      let freshnessMultiplier = 1;
      let antiNote = null;
      try {
  const prevWorkday = previousWorkday(activeDate);
        const consec = await getConsecutiveTopWorkdaysUpTo(prevWorkday, studentName);
        const daysSince = await getWorkdaysSinceLastTop(activeDate, studentName);
        if (consec >= p3_anti.antiDomination.decayAfterDays) {
          const excess = consec - p3_anti.antiDomination.decayAfterDays;
          freshnessMultiplier = Math.pow(p3_anti.antiDomination.decayRate, Math.max(0, excess));
          if (consec >= p3_anti.antiDomination.maxConsecutiveDays) {
            freshnessMultiplier *= 0.5; // é¢å¤–å¼ºè¡°å‡
          }
          antiNote = `è¿ç»­ç™»é¡¶${consec}ä¸ªå·¥ä½œæ—¥ï¼Œåº”ç”¨è¡°å‡Ã—${freshnessMultiplier.toFixed(2)}`;
        } else if (daysSince >= p3_anti.antiDomination.breakPeriod) {
          // ç»™æœªè¿‘æœŸç™»é¡¶è€…è½»å¾®å…¬å¹³æ€§å¥–åŠ±ï¼ˆä¸è®¡å…¥ä»Šæ—¥æ´»è·ƒåº¦ï¼‰
          antiBonus += p3_anti.freshBreakBonus;
          antiNote = `è·ä¸Šæ¬¡ç™»é¡¶${daysSince}ä¸ªå·¥ä½œæ—¥ï¼Œè·å¾—å…¬å¹³æ€§å¥–åŠ±+${p3_anti.freshBreakBonus}`;
        }
      } catch (e) { /* å¿½ç•¥åéœ¸æ¦œå¼‚å¸¸ */ }

  let totalBase = sRank + sProgress + sConsistency;
      let total = totalBase * freshnessMultiplier + antiBonus;
      total = Math.max(0, Math.min(20, total));
      return {
        score: total,
        breakdown: {
          yesterdayRank: pr ?? null,
          rankPoints: sRank,
          progressPoints: sProgress,
          // ratioDisplay ç”¨åŸå§‹åˆ†æ¯ sPrev ä¾¿äºç†è§£ï¼›ratioApplied ç”¨é˜²æŠ¤åçš„åˆ†æ¯ç”¨äºè®¡åˆ†
          progressDetail: {
            cur7Total: sCur,
            prev7Total: sPrev,
            curDays: cur7, // è¿‘çª—å£é€æ—¥åˆ†
            prevDays: prev7, // å‰çª—å£é€æ—¥åˆ†
            avgCur: +( (sCur / (p3.progress.windowSize||5)) .toFixed(2) ),
            avgPrev: +( (sPrev / (p3.progress.windowSize||5)) .toFixed(2) ),
            rawRatioAvg: (sPrev>0 ? +(((sCur/(p3.progress.windowSize||5)) - (sPrev/(p3.progress.windowSize||5))) / (sPrev/(p3.progress.windowSize||5)) * 100).toFixed(1) : null),
            ratio: (sPrev > 0 ? +(((sCur/ (p3.progress.windowSize||5)) - (sPrev/(p3.progress.windowSize||5))) / Math.max(sPrev/(p3.progress.windowSize||5), p3.progress.denomFloor/(p3.progress.windowSize||5)) * 100).toFixed(1) : null),
            appliedRatio: +(appliedProgressRatio * 100).toFixed(1), // åŸºäºçª—å£å¹³å‡
            curActiveDays,
            prevActiveDays,
            minActiveDaysRequired: p3.progress.minActiveDaysPerWindow,
            gatedByActiveDays: !(curActiveDays >= p3.progress.minActiveDaysPerWindow && prevActiveDays >= p3.progress.minActiveDaysPerWindow)
          },
          consistencyPoints: sConsistency,
          consistencyStd: +std.toFixed(2),
          // freshPoints: å·²ç§»é™¤
          antiBonusPoints: antiBonus,
          freshnessMultiplier: +freshnessMultiplier.toFixed(2),
          antiNote: antiNote
        }
      };
    }

    // ===== äº‘ç«¯ D3 è®¡ç®—ï¼šè½»é‡ç¼“å­˜ä¸æ‰¹é‡è¾…åŠ© =====
    const __cloudD3 = {
      perDateIntervals: new Map(), // isoDate -> Map(student_key -> intervals)
      prevTopByActiveIso: new Map(), // activeIso -> Map(dateIso -> top student_key)
      prevDayRankMap: new Map(), // prevIso -> Map(student_key -> rank)
      corsBlocked: false,
      d12CacheByDate: new Map() // isoDate -> Map(student_key -> d1+d2)
    };

    async function __prefetchD12ForWindows(studentKeys, dates){
      const isoDates = Array.from(new Set(dates.map(d=>utils.toIsoDate(d))));
      const needDates = isoDates.filter(iso=>!__cloudD3.d12CacheByDate.has(iso));
      if(!needDates.length) return;
      // åˆ†æ—¥æœŸæ‰¹é‡è·å–æ‰€æœ‰å­¦ç”Ÿçš„ d1/d2
      try{
        for(const iso of needDates){
          const { data, error } = await supabaseClient
            .from('leaderboard_daily')
            .select('student_key,d1,d2')
            .eq('date', iso);
          const m = new Map();
          if(!error && Array.isArray(data)){
            for(const r of data){
              const key = utils.normalizeStudentName(r.student_key);
              m.set(key, (Number(r.d1)||0) + (Number(r.d2)||0));
            }
          }
          __cloudD3.d12CacheByDate.set(iso, m);
        }
      }catch{}
    }

    async function __getPerStudentIntervalsForDateCached(date){
      const iso = utils.toIsoDate(date);
      if(__cloudD3.perDateIntervals.has(iso)) return __cloudD3.perDateIntervals.get(iso);
      try{
        const map = await __fetchPracticeIntervalsByStudentForDate(supabaseClient, date);
        __cloudD3.perDateIntervals.set(iso, map);
        return map;
      }catch(e){
        __cloudD3.corsBlocked = true; // é‡åˆ° CORS/åŠ è½½å¤±è´¥åï¼Œæœ¬ä¼šè¯å†…ä¸å†åå¤å°è¯•
        return new Map();
      }
    }

    async function __getPrevDayRankMapCached(prevDate){
      const iso = utils.toIsoDate(prevDate);
      if(__cloudD3.prevDayRankMap.has(iso)) return __cloudD3.prevDayRankMap.get(iso);
      const m = new Map();
      try{
        const { data, error } = await supabaseClient
          .from('leaderboard_daily')
          .select('student_key,rank')
          .eq('date', iso);
        if(!error && Array.isArray(data)){
          for(const r of data){ if(typeof r.rank === 'number') m.set(utils.normalizeStudentName(r.student_key), r.rank); }
        }
      }catch{}
      __cloudD3.prevDayRankMap.set(iso, m);
      return m;
    }

    async function __getPrevTopByDateCached(activeDate){
      const activeIso = utils.toIsoDate(activeDate);
      if(__cloudD3.prevTopByActiveIso.has(activeIso)) return __cloudD3.prevTopByActiveIso.get(activeIso);
      // æ”¶é›†è¿‘ 30 ä¸ªå·¥ä½œæ—¥ï¼ˆä»å‰ä¸€å·¥ä½œæ—¥å¼€å§‹ï¼‰
      const datesScan = [];
      let d = previousWorkday(activeDate);
      for(let i=0;i<60 && datesScan.length<30;i++){
        if(isWorkday(d)) datesScan.push(utils.toIsoDate(d));
        d = previousWorkday(d);
      }
      const topByDate = new Map(); // Map<date, string[]> æ”¯æŒå¹¶åˆ—ç¬¬ä¸€
      try{
        if(datesScan.length){
          const { data, error } = await supabaseClient
            .from('leaderboard_daily')
            .select('date,student_key')
            .in('date', datesScan)
            .eq('rank', 1);
          if(!error && Array.isArray(data)){
            // æ”¶é›†æ¯ä¸ªæ—¥æœŸçš„æ‰€æœ‰å¹¶åˆ—ç¬¬ä¸€çš„å­¦ç”Ÿ
            for(const r of data){
              const normalized = utils.normalizeStudentName(r.student_key);
              if(!topByDate.has(r.date)) topByDate.set(r.date, []);
              topByDate.get(r.date).push(normalized);
            }
          }
        }
      }catch{}
      __cloudD3.prevTopByActiveIso.set(activeIso, topByDate);
      return topByDate;
    }

    // ===== åŸºäºäº‘ç«¯å†å²æ•°æ®çš„ D3 è®¡ç®—ï¼ˆç»Ÿä¸€å…¥å£ï¼‰ =====
    async function computeDim3ScoreCloud(studentName, activeDate, todayD12) {
      const p3 = LB442_PARAMS.dim3;
      const key = utils.normalizeStudentName(studentName);
      // å‘¨æœ«ä¸è®¡ç®—ç»´åº¦ä¸‰
      if (!isWorkday(activeDate)) {
        return { score: 0, breakdown: { weekend: true, disabled: true } };
      }

      // 1) æ˜¨æ—¥æ’åï¼ˆæ¥è‡ª leaderboard_dailyï¼‰
      const prevDay = previousWorkday(activeDate);
      let yesterdayRank = null;
      const prevMapAll = await __getPrevDayRankMapCached(prevDay);
      if(prevMapAll && prevMapAll.size){ yesterdayRank = prevMapAll.get(key) ?? null; }
      let sRank = 0;
  sRank = computeRankPoints(yesterdayRank);

      // 2) å‘¨è¿›æ­¥ä¸ç¨³å®šæ€§ï¼šè¿‘7ä¸ªå·¥ä½œæ—¥ vs å‰7ä¸ªå·¥ä½œæ—¥ï¼ŒåŸºäº leaderboard_daily çš„ d1+d2
      const endWorkday = nearestWorkdayOnOrBefore(activeDate);
  const WN = p3.progress.windowSize || 5;
  const curDates = getLastNWorkdayDates(endWorkday, WN);
      const prevWindowEnd = previousWorkday(curDates[0]);
  const prevDates = getLastNWorkdayDates(prevWindowEnd, WN);
      const allDates = [...curDates, ...prevDates];
      // å…ˆå°è¯•ä»ç¼“å­˜å–ï¼Œä¸è¶³å†è¡¥é½
      await __prefetchD12ForWindows([key], allDates);
      const getD12 = (d) => {
        const iso = utils.toIsoDate(d);
        const map = __cloudD3.d12CacheByDate.get(iso);
        return map ? (map.get(key) || 0) : 0;
      };
      const cur7 = curDates.map(getD12);
      const prev7 = prevDates.map(getD12);
      const sum = a => a.reduce((x, y) => x + y, 0);
      const curActiveArr = cur7.filter(v => v > 0);
      const prevActiveArr = prev7.filter(v => v > 0);
      const sCur = sum(curActiveArr), sPrev = sum(prevActiveArr);
      const curActiveDays = curActiveArr.length;
      const prevActiveDays = prevActiveArr.length;
      let sProgress = 0, appliedProgressRatio = 0;
      const passActiveDaysGate = (curActiveDays >= p3.progress.minActiveDaysPerWindow) && (prevActiveDays >= p3.progress.minActiveDaysPerWindow);
      // æ£€æŸ¥å‰çª—å£æ¯ä¸ªæœ‰æ•ˆè®°å½•éƒ½ä¸ä½äºæœ€ä½åˆ†æ•°è¦æ±‚
      const prevRecordsQualified = prevActiveArr.every(score => score >= p3.progress.minPrevTotal);
      if (passActiveDaysGate && prevRecordsQualified && sCur > sPrev) {
        // ä½¿ç”¨æœ‰æ•ˆè®°å½•çš„å¹³å‡å€¼ï¼Œè€Œä¸æ˜¯çª—å£å¹³å‡å€¼
        const avgCur = sCur / curActiveDays;  // å½“å‰æœ‰æ•ˆè®°å½•çš„å¹³å‡å€¼
        const avgPrev = sPrev / prevActiveDays;  // å‰æœŸæœ‰æ•ˆè®°å½•çš„å¹³å‡å€¼
        const denomAvg = Math.max(avgPrev, p3.progress.denomFloor / Math.max(1, prevActiveDays));
        appliedProgressRatio = Math.min(p3.progress.maxRatio, Math.max(0, (avgCur - avgPrev) / denomAvg));
        const ratioPct = appliedProgressRatio / p3.progress.maxRatio;
        sProgress = Math.min(6, +(ratioPct * 6).toFixed(2));
      }
      // ç¨³å®šæ€§
      let sConsistency = 0; let std = 0;
      // éœ€è¦æœ€å°è®°å½•æ•°é‡æ‰èƒ½è®¡ç®—æ ‡å‡†å·®åŠ åˆ†
      const minRecordsForStability = p3.consistency?.minRecords || 3;
      
      if (curActiveArr.length >= minRecordsForStability) {
        const mean = sCur / curActiveArr.length;
        const variance = curActiveArr.reduce((acc, v) => acc + Math.pow(v - mean, 2), 0) / curActiveArr.length;
        std = Math.sqrt(variance);
        sConsistency = computeConsistencyPoints(std);
      }
      // å¦‚æœæœ‰æ•ˆè®°å½•ä¸è¶³ï¼Œæ ‡å‡†å·®åŠ åˆ†ä¸º0

  // 3) ä»Šæ—¥æ´»è·ƒåº¦åŠ åˆ†å·²ç§»é™¤ï¼ˆç»´åº¦ä¸‰ä¸å†åŒ…å«ï¼‰

      // 4) åéœ¸æ¦œï¼ˆç”¨ leaderboard_daily çš„ rank=1 è®°å½•åˆ¤æ–­ç™»é¡¶æƒ…å†µï¼‰
      let antiBonus = 0; let freshnessMultiplier = 1; let antiNote = null;
      try {
        const topByDate = await __getPrevTopByDateCached(activeDate);
        // è¿ç»­ç‹¬å ç¬¬ä¸€çš„å¤©æ•°ï¼ˆä»å‰ä¸€å·¥ä½œæ—¥å¼€å§‹å‘å‰ï¼Œå¹¶åˆ—ç¬¬ä¸€ä¸è®¡å…¥ï¼‰
        let consec = 0;
        let d = previousWorkday(activeDate);
        for (let i = 0; i < 14; i++) {
          const iso = utils.toIsoDate(d);
          const topNames = topByDate.get(iso) || [];
          // åªæœ‰ç‹¬å ç¬¬ä¸€ï¼ˆæ•°ç»„é•¿åº¦ä¸º1ä¸”æ˜¯è¯¥å­¦ç”Ÿï¼‰æ‰è®¡å…¥è¿ç»­å¤©æ•°
          if (Array.isArray(topNames) && topNames.length === 1 && topNames[0] === key) {
            consec++;
            d = previousWorkday(d);
          } else {
            break; // å¹¶åˆ—ç¬¬ä¸€æˆ–ä¸æ˜¯ç¬¬ä¸€ï¼Œä¸­æ–­è¿ç»­è®¡æ•°
          }
        }
        // è·ä¸Šæ¬¡ç™»é¡¶çš„å·¥ä½œæ—¥æ•°ï¼ˆåŒ…æ‹¬å¹¶åˆ—ç¬¬ä¸€ï¼‰
        let daysSince = 0;
        let dd = previousWorkday(activeDate);
        for (let i = 0; i < 30; i++) {
          const iso = utils.toIsoDate(dd);
          const topNames = topByDate.get(iso) || [];
          // åªè¦åœ¨å¹¶åˆ—ç¬¬ä¸€åå•ä¸­å°±ç®—ç™»é¡¶è¿‡
          if (Array.isArray(topNames) && topNames.includes(key)) break;
          daysSince++;
          dd = previousWorkday(dd);
        }
        const anti = p3.antiDomination;
        if (consec >= anti.decayAfterDays) {
          const excess = consec - anti.decayAfterDays;
          freshnessMultiplier = Math.pow(anti.decayRate, Math.max(0, excess));
          if (consec >= anti.maxConsecutiveDays) {
            freshnessMultiplier *= 0.5;
          }
          antiNote = `è¿ç»­ç™»é¡¶${consec}ä¸ªå·¥ä½œæ—¥ï¼Œåº”ç”¨è¡°å‡Ã—${freshnessMultiplier.toFixed(2)}`;
        } else if (daysSince >= anti.breakPeriod) {
          antiBonus += p3.freshBreakBonus;
          antiNote = `è·ä¸Šæ¬¡ç™»é¡¶${daysSince}ä¸ªå·¥ä½œæ—¥ï¼Œè·å¾—å…¬å¹³æ€§å¥–åŠ±+${p3.freshBreakBonus}`;
        }
      } catch {}

  const totalBase = sRank + sProgress + sConsistency;
      let total = totalBase * freshnessMultiplier + antiBonus;
      total = Math.max(0, Math.min(20, total));
      return {
        score: total,
        breakdown: {
          yesterdayRank,
          rankPoints: sRank,
          progressPoints: sProgress,
          progressDetail: {
            cur7Total: sCur,
            prev7Total: sPrev,
            curDays: cur7,
            prevDays: prev7,
            avgCur: curActiveDays > 0 ? +( (sCur / curActiveDays) .toFixed(2) ) : 0,
            avgPrev: prevActiveDays > 0 ? +( (sPrev / prevActiveDays) .toFixed(2) ) : 0,
            rawRatioAvg: (sPrev>0 && prevActiveDays>0 && curActiveDays>0 ? +(((sCur/curActiveDays) - (sPrev/prevActiveDays)) / (sPrev/prevActiveDays) * 100).toFixed(1) : null),
            ratio: (sPrev > 0 && prevActiveDays>0 && curActiveDays>0 ? +(((sCur/curActiveDays) - (sPrev/prevActiveDays)) / Math.max(sPrev/prevActiveDays, p3.progress.denomFloor/Math.max(1,prevActiveDays)) * 100).toFixed(1) : null),
            appliedRatio: +(appliedProgressRatio * 100).toFixed(1),
            curActiveDays,
            prevActiveDays,
            minActiveDaysRequired: p3.progress.minActiveDaysPerWindow,
            gatedByActiveDays: !(curActiveDays >= p3.progress.minActiveDaysPerWindow && prevActiveDays >= p3.progress.minActiveDaysPerWindow)
          },
          consistencyPoints: sConsistency,
          consistencyStd: +std.toFixed(2),
          consistencyActiveDays: curActiveArr.length,
          consistencyMinRecords: p3.consistency?.minRecords || 3,
          // freshPoints: å·²ç§»é™¤
          antiBonusPoints: antiBonus,
          freshnessMultiplier: +freshnessMultiplier.toFixed(2),
          antiNote
        }
      };
    }

  async function computeScore442(student) {
      const activeDate = getActiveLeaderboardDate();
      const dayStartMs = toDayStart(activeDate);
      const weekday0to6 = activeDate.getDay();
      // å‘¨æœ«ä¸è®¡ç®— 442 åˆ†ï¼Œè¿”å›ç©ºç»“æœç”¨äºå‰ç«¯éšè—
      if (!isWorkday(activeDate)) {
        return { total: null, d1: null, d2: null, d3: null, weekend: true };
      }
  const slotsMin = getLeaderboardSlotsMinutes(student.name, activeDate);
  const intervalsMs = getLeaderboardPracticeIntervalsMs(student.name, activeDate);
      // å½“å¤©æ— ä»»ä½•ç»ƒç´è®°å½•ï¼šæ’è¡Œæ¦œä¸æ˜¾ç¤ºåˆ†æ•°
      if (!intervalsMs || intervalsMs.length === 0) {
        return { total: null, d1: null, d2: null, d3: null, noPractice: true };
      }
      const d1 = computeDim1Score(slotsMin, intervalsMs, dayStartMs);
      const d2 = computeDim2Score(slotsMin, intervalsMs, dayStartMs, weekday0to6);
  const d3 = await computeDim3ScoreCloud(utils.normalizeStudentName(student.name), activeDate, d1.score + d2.score);
  let total = d1.score + d2.score + d3.score;
  // æ–¹æ¡ˆDï¼šæ»¡å‹¤åŠ åˆ†ç§»åŠ¨åˆ°æ€»åˆ†å±‚é¢ï¼ˆåŠ¨æ€ï¼š1æ®µâ†’+0.5ï¼Œ2æ®µâ†’+1ï¼Œâ‰¥3æ®µâ†’+1.5ï¼‰
  if (d1.breakdown && d1.breakdown.gotFullBonus) {
    total += (d1.breakdown.fullBonusAward || 0);
  }
  
  // ç®¡ç†å‘˜è°ƒåˆ†
  const adminAdjustment = getAdminScoreAdjustment(student.name);
  if (adminAdjustment !== 0) {
    total += adminAdjustment;
  }
  
  total = +(Math.max(0, Math.min(100, total))).toFixed(2);
  const bonus = (d1.breakdown && d1.breakdown.gotFullBonus) ? (d1.breakdown.fullBonusAward || 0) : 0;
  
  return { 
    total, 
    d1: d1.score, 
    d2: d2.score, 
    d3: d3.score, 
    bonus: bonus,
    adminAdjustment: adminAdjustment
  };
    }

  async function updateRanking() {
      const rankingList = document.getElementById('rankingList');
      if (!rankingList) return;
      // ä¿éšœï¼šè‹¥æœ‰æŸäº›å­¦ç”Ÿä»æ®‹ç•™åœ¨ç¼“å­˜ä½†ä¸åœ¨ student_databaseï¼Œæå‰è¿‡æ»¤
      if(appState && appState.students instanceof Map && appState.studentsMeta instanceof Map){
        for(const k of Array.from(appState.students.keys())){
          if(!appState.studentsMeta.has(utils.normalizeStudentName(k))){
            appState.students.delete(k);
            if(window.__scoreCache) window.__scoreCache.delete(k);
          }
        }
      }
      
      // ç¼“å­˜æ£€æŸ¥ï¼šç¡®ä¿ä¸æ—¥æ’è¡Œæ¦œä¸€è‡´æ€§
      const now = Date.now();
      const currentActiveDate = getActiveLeaderboardDate();
      const currentActiveIso = utils.toIsoDate(currentActiveDate);
      
      // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ç¼“å­˜æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
      const localCache = (() => {
        try {
          const raw = localStorage.getItem('rank_cache_v2');
          if (!raw) return null;
          const obj = JSON.parse(raw);
          if (obj && obj.date === currentActiveIso && now - obj.ts < 300000) {
            return obj;
          }
        } catch(_) {}
        return null;
      })();
      
      // å¦‚æœæœ¬åœ°ç¼“å­˜æœ‰æ•ˆï¼Œä¼˜å…ˆä½¿ç”¨ï¼›å¦åˆ™æ£€æŸ¥å†…å­˜ç¼“å­˜
      if (localCache && localCache.topStudents && Array.isArray(localCache.topStudents)) {
        dbg('é¦–é¡µæ’è¡Œæ¦œä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œç¡®ä¿ä¸æ—¥æ’è¡Œæ¦œä¸€è‡´', { count: localCache.topStudents.length });
        
        // ä½¿ç”¨ç¼“å­˜æ•°æ®æ¸²æŸ“ï¼ˆéªŒè¯ç®¡ç†å‘˜è°ƒåˆ†æ˜¯å¦å˜åŒ–ï¼‰
        const stale = localCache.topStudents.some(stu => {
          const curAdj = getAdminScoreAdjustment(stu.name) || 0;
          const cachedAdj = (stu.__442 && typeof stu.__442.adminAdjustment==='number') ? stu.__442.adminAdjustment : 0;
          return curAdj !== cachedAdj;
        });
        
        if (!stale) {
          // ç›´æ¥æ¸²æŸ“ç¼“å­˜æ•°æ®
          const topStudents = localCache.topStudents.slice(0, 3);
          rankingList.innerHTML = topStudents.map((student, index) => {
            const position = index + 1;
            const meta = appState.studentsMeta.get(student.name) || {};
            const score = student.rankingScore;
            const clickable = (typeof score === 'number' && !isNaN(score));
            return `
              <div class="ranking-item${!clickable?' ranking-item-disabled':''}" ${clickable?`onclick="openStudentDetailFromRanking('${student.name}')"`:''}>
                <div class="ranking-position rank-${position}">${position}</div>
                <div class="ranking-student-info">
                  <div class="ranking-student-name">${student.name}</div>
                  <div class="ranking-student-meta">${meta.major || 'æœªçŸ¥ä¸“ä¸š'} Â· ${meta.grade || 'æœªçŸ¥å¹´çº§'}</div>
                </div>
                <div class="ranking-score">
                  <div class="ranking-score-value">${score != null ? score.toFixed(1) : '-'}</div>
                  <div class="ranking-score-label">æ€»åˆ†</div>
                </div>
              </div>
            `;
          }).join('');
          
          rankingList.__filled = true;
          dbg('é¦–é¡µå°æ¦œä½¿ç”¨ localStorage ç¼“å­˜æ¸²æŸ“å®Œæˆ');
          return;
        } else {
          dbg('ç®¡ç†å‘˜è°ƒåˆ†å˜åŒ–å¯¼è‡´ localStorage ç¼“å­˜å¤±æ•ˆï¼Œé‡æ–°è®¡ç®—');
        }
      } else if (rankingDataCache && (now - lastRankingUpdateTime) < RANKING_CACHE_DURATION) {
        // å¦‚æœç¼“å­˜å­˜åœ¨ä½†æŸä¸ªå­¦ç”Ÿçš„ç®¡ç†å‘˜è°ƒåˆ†å·²å˜åŒ–ï¼ˆå†…å­˜å¯¹è±¡è¢«ä¿®æ”¹ï¼‰ï¼Œéœ€è¦é‡æ–°è®¡ç®—ã€‚
        // ç®€å•ç­–ç•¥ï¼šæ¯”è¾ƒ topStudents ä¸­çš„è°ƒåˆ†æ˜¯å¦ä¸å½“å‰ getAdminScoreAdjustment è¿”å›ä¸€è‡´ã€‚
        const stale = rankingDataCache.topStudents && rankingDataCache.topStudents.some(stu => {
          const curAdj = getAdminScoreAdjustment(stu.name) || 0;
          const cachedAdj = (stu.__442 && typeof stu.__442.adminAdjustment==='number') ? stu.__442.adminAdjustment : 0;
          return curAdj !== cachedAdj; // å‘ç°ä»»ä¸€å·®å¼‚åˆ™è§†ä¸ºè¿‡æœŸ
        });
        if (!stale) {
          dbg('ä½¿ç”¨å†…å­˜ç¼“å­˜çš„æ’è¡Œæ¦œæ•°æ®');
          return;
        } else {
          dbg('ç®¡ç†å‘˜è°ƒåˆ†å˜åŒ–å¯¼è‡´é¦–é¡µå°æ¦œç¼“å­˜å¤±æ•ˆï¼Œé‡æ–°è®¡ç®—');
        }
      }
      
      const t0 = performance.now();
      // éª¨æ¶å±ï¼ˆé¦–æ¬¡æˆ–æœªå¡«å……æ—¶ï¼‰
      if (!rankingList.__filled) {
        const skeletonRows = Array.from({length:3}).map((_,i)=>`<div class=\"ranking-item ranking-item--skeleton\">\n  <div class=\"ranking-position\">${i+1}</div>\n  <div class=\"ranking-student-info\">\n    <div class=\"ranking-student-name sk-bar\" style=\"width:${40+Math.random()*40}%\"></div>\n    <div class=\"ranking-student-meta sk-bar\" style=\"width:${30+Math.random()*30}%\"></div>\n  </div>\n  <div class=\"ranking-score\">\n    <div class=\"ranking-score-value sk-bar\" style=\"width:50px;height:16px\"></div>\n    <div class=\"ranking-score-label sk-bar\" style=\"width:36px;height:10px\"></div>\n  </div>\n</div>`).join('');
        rankingList.innerHTML = skeletonRows;
      }

  // å‘¨æœ«ä¸å±•ç¤ºæ’è¡Œæ¦œï¼Œæ˜¾ç¤ºè¯´æ˜ï¼ˆä½¿ç”¨å½“å‰é€‰ä¸­çš„æ’è¡Œæ¦œæ—¥æœŸï¼‰
  const __today = getActiveLeaderboardDate();
  if (!isWorkday(__today)) {
        rankingList.innerHTML = `
          <div class="ranking-hero" style="margin:0 0 8px;">
            <div class="ranking-hero-sub">å‘¨æœ«ï¼ˆå‘¨å…­/å‘¨æ—¥ï¼‰ä¸å±•ç¤ºæ’è¡Œæ¦œï¼›å·¥ä½œæ—¥æ’è¡Œæ¦œçª—å£ï¼šå‘¨ä¸€/äºŒ/å››/äº” 08:00â€“19:00ï¼Œå‘¨ä¸‰ 08:00â€“19:30ï¼›ç»´åº¦ä¸‰å†å²è¯„åˆ†å‚è€ƒä¸åŒ…å«å‘¨å…­å‘¨æ—¥ï¼Œä¸”æ’é™¤å½“æ—¥æ— ç»ƒç´çš„å·¥ä½œæ—¥ï¼›å½“æ—¥æ— ç»ƒç´åˆ™ä¸è®¡åˆ†ã€‚</div>
          </div>
        `;
        return;
      }

      // ğŸ”§ æ£€æŸ¥æ•°æ®æ˜¯å¦å‡†å¤‡å¥½ï¼ˆé¿å…åœ¨åŠ è½½æ—¶æ˜¾ç¤º"æ— æ•°æ®"ï¼‰
      const isDataReady = appState.students && appState.students.size > 0 && 
                          appState.studentsMeta && appState.studentsMeta.size > 0;
      
      if (!isDataReady) {
        // æ•°æ®è¿˜åœ¨åŠ è½½ä¸­ï¼Œä¿æŒéª¨æ¶å±ä¸å˜
        if (!rankingList.__filled) {
          dbg('é¦–é¡µæ’è¡Œæ¦œï¼šæ•°æ®åŠ è½½ä¸­ï¼Œæ˜¾ç¤ºéª¨æ¶å±');
          const skeletonRows = Array.from({length:3}).map((_,i)=>`<div class=\"ranking-item ranking-item--skeleton\">\n  <div class=\"ranking-position\">${i+1}</div>\n  <div class=\"ranking-student-info\">\n    <div class=\"ranking-student-name sk-bar\" style=\"width:${40+Math.random()*40}%\"></div>\n    <div class=\"ranking-student-meta sk-bar\" style=\"width:${30+Math.random()*30}%\"></div>\n  </div>\n  <div class=\"ranking-score\">\n    <div class=\"ranking-score-value sk-bar\" style=\"width:50px;height:16px\"></div>\n    <div class=\"ranking-score-label sk-bar\" style=\"width:36px;height:10px\"></div>\n  </div>\n</div>`).join('');
          rankingList.innerHTML = skeletonRows;
        } else {
          // å¦‚æœéª¨æ¶å±å·²ç»æ˜¾ç¤ºè¿‡ï¼Œä¸é‡æ–°æ¸²æŸ“ï¼Œé¿å…é¡µé¢è·³åŠ¨
          dbg('é¦–é¡µæ’è¡Œæ¦œï¼šæ•°æ®åŠ è½½ä¸­ï¼Œä¿æŒç°æœ‰éª¨æ¶å±ä¸å˜');
        }
        // å»¶è¿Ÿé‡è¯•ï¼ˆæ•°æ®å¯èƒ½æ­£åœ¨åŠ è½½ä¸­ï¼‰
        setTimeout(() => updateRanking(), 1000);
        return;
      }
      
      // è·å–æ‰€æœ‰å­¦ç”Ÿæ•°æ®å¹¶è®¡ç®—æ’è¡Œæ¦œåˆ†æ•°ï¼ˆç­¾åç¼“å­˜ï¼‰
      if (!window.__scoreCache) window.__scoreCache = new Map();
      const cache = window.__scoreCache;
      const activeDate = getActiveLeaderboardDate();
      const students = [];
      for (const student of Array.from(appState.students.values())) {
        const intervalsMs = getLeaderboardPracticeIntervalsMs(student.name, activeDate);
        const lastLogTs = intervalsMs && intervalsMs.length ? intervalsMs[intervalsMs.length-1].end : 0;
        const slots = getLeaderboardSlotsMinutes(student.name, activeDate) || [];
        const slotSig = slots.map(s=>s.start+'-'+s.end).join('|');
        let practicedMin = 0; if (intervalsMs) { for (const iv of intervalsMs) practicedMin += (iv.end-iv.start)/60000; }
  // å°†ç®¡ç†å‘˜è°ƒåˆ†çº³å…¥ç­¾åï¼ˆè‹¥è°ƒæ•´å˜æ›´å³å¼ºåˆ¶é‡æ–°è®¡ç®—ï¼‰
  const adminAdj = getAdminScoreAdjustment(student.name) || 0;
  const sig = `${lastLogTs}|${slotSig}|${Math.floor(practicedMin)}|adj:${adminAdj}`;
        let s;
        const c = cache.get(student.name);
        if (c && c.sig === sig) { s = c.s; }
        else {
          s = await computeScore442(student);
          cache.set(student.name, {sig, s});
        }
        students.push({...student, rankingScore: s.total, __442: s});
      }

      // è¿‡æ»¤æ— æœ‰æ•ˆåˆ†æ•°(null/undefined/NaN) çš„å­¦ç”Ÿï¼Œé¿å…ç©ºæ•°æ®ä¹±è·³
      const scoredStudents = students.filter(s=> typeof s.rankingScore === 'number' && !isNaN(s.rankingScore));
      // è‹¥å…¨éƒ¨æ— åˆ†ï¼ˆæ•°æ®å·²åŠ è½½ä½†ç¡®å®æ²¡æœ‰æœ‰æ•ˆåˆ†æ•°ï¼‰ï¼Œæ˜¾ç¤ºå ä½
      if(!scoredStudents.length){
        dbg('é¦–é¡µæ’è¡Œæ¦œï¼šæ•°æ®å·²åŠ è½½ï¼Œä½†æ²¡æœ‰æœ‰æ•ˆåˆ†æ•°');
        rankingList.innerHTML = `
          <div style="text-align: center; padding: 32px; color: #656d76;">
            <div style="margin-bottom: 8px; font-size:32px;">ğŸ“Š</div>
            <div>ä»Šæ—¥æš‚æ— å¯è®¡ç®—çš„æ’è¡Œæ¦œæ•°æ®</div>
            <div style="margin-top:6px;font-size:12px;opacity:.8;">(æ²¡æœ‰æœ‰æ•ˆç»ƒç´è®°å½•æˆ–å…¨éƒ¨è¢«æ’é™¤)</div>
          </div>`;
        rankingDataCache = { students, topStudents: [], timestamp: now };
        lastRankingUpdateTime = now;
        rankingList.__filled = true;
        return;
      }
      // ğŸ”§ ç»Ÿä¸€æ’åºè§„åˆ™ï¼šæ€»åˆ† â†’ ç»´åº¦1 â†’ ç»´åº¦2 â†’ ç»´åº¦3 â†’ å§“åï¼ˆä¸æ—¥æ’è¡Œæ¦œå®Œå…¨ä¸€è‡´ï¼‰
      scoredStudents.sort((a, b) => {
        // 1. æ€»åˆ†é™åº
        if (Math.abs(b.rankingScore - a.rankingScore) > 1e-6) {
          return b.rankingScore - a.rankingScore;
        }
        // 2. ç»´åº¦1é™åº
        const aD1 = a.__442?.d1 || 0;
        const bD1 = b.__442?.d1 || 0;
        if (Math.abs(bD1 - aD1) > 1e-6) {
          return bD1 - aD1;
        }
        // 3. ç»´åº¦2é™åº
        const aD2 = a.__442?.d2 || 0;
        const bD2 = b.__442?.d2 || 0;
        if (Math.abs(bD2 - aD2) > 1e-6) {
          return bD2 - aD2;
        }
        // 4. ç»´åº¦3é™åº
        const aD3 = a.__442?.d3 || 0;
        const bD3 = b.__442?.d3 || 0;
        if (Math.abs(bD3 - aD3) > 1e-6) {
          return bD3 - aD3;
        }
        // 5. å§“åå‡åºï¼ˆç¡®ä¿å®Œå…¨ç›¸åŒåˆ†æ•°æ—¶é¡ºåºç¨³å®šï¼‰
        return a.name.localeCompare(b.name);
      });
      // åªæ˜¾ç¤ºå‰3å
      const topStudents = scoredStudents.slice(0, 3);

      // ç”Ÿæˆæ’è¡Œæ¦œHTML
      requestAnimationFrame(() => {
        rankingList.innerHTML = topStudents.map((student, index) => {
          const position = index + 1;
          const meta = appState.studentsMeta.get(student.name) || {};
          const score = student.rankingScore;
          const clickable = (typeof score === 'number' && !isNaN(score));
          return `
            <div class="ranking-item${!clickable?' ranking-item-disabled':''}" ${clickable?`onclick="openStudentDetailFromRanking('${student.name}')"`:''}>
              <div class="ranking-position rank-${position}">${position}</div>
              <div class="ranking-student-info">
                <div class="ranking-student-name">${student.name}</div>
                <div class="ranking-student-meta">${meta.major || 'æœªçŸ¥ä¸“ä¸š'} Â· ${meta.grade || 'æœªçŸ¥å¹´çº§'}</div>
              </div>
              <div class="ranking-score">
                <div class="ranking-score-value">${score != null ? score.toFixed(1) : '-'}</div>
                <div class="ranking-score-label">æ€»åˆ†</div>
              </div>
            </div>
          `;
        }).join('');
        rankingList.__filled = true;
      });

      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå ä½å†…å®¹
      if (topStudents.length === 0) {
        rankingList.innerHTML = `
          <div style="text-align: center; padding: 32px; color: #656d76;">
            <div style="margin-bottom: 8px;">ğŸ“Š</div>
            <div>æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>
          </div>
        `;
      }

      // è‡ªåŠ¨åŒæ­¥å½“æ—¥æ’è¡Œæ¦œåˆ°æ•°æ®åº“ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ç•Œé¢ï¼‰
      if (students.length > 0) {
        syncTodayLeaderboard().catch(e => console.warn('è‡ªåŠ¨åŒæ­¥æ’è¡Œæ¦œå¤±è´¥:', e));
      }
      
      // æ›´æ–°ç¼“å­˜å¹¶åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨
      rankingDataCache = { students, topStudents, timestamp: now };
      lastRankingUpdateTime = now;
      
      // ğŸ”§ ä¿å­˜åˆ° localStorageï¼Œç¡®ä¿ä¸æ—¥æ’è¡Œæ¦œä¸€è‡´
      try {
        const activeIso = utils.toIsoDate(currentActiveDate);
        const dataHash = generateDataHash([...appState.students.values()]);
        const RANK_CACHE_SIG = (() => {
          const studentCount = (appState.studentsMeta && appState.studentsMeta.size) || 0;
          return `v2|${RULE_VERSION}|${studentCount}`;
        })();
        
        localStorage.setItem('rank_cache_v2', JSON.stringify({
          date: activeIso,
          ts: now,
          dataHash,
          sig: RANK_CACHE_SIG,
          topStudents: topStudents.map(s => ({
            name: s.name,
            rankingScore: s.rankingScore,
            __442: s.__442
          }))
        }));
        dbg('é¦–é¡µå°æ¦œå·²ä¿å­˜åˆ° localStorageï¼Œç¡®ä¿ä¸æ—¥æ’è¡Œæ¦œåŒæ­¥');
      } catch(e) {
        dbg('ä¿å­˜é¦–é¡µå°æ¦œç¼“å­˜å¤±è´¥:', e);
      }
      
      rankingList.__filled = true;
      const t1 = performance.now();
      dbg('updateRanking ms=', +(t1-t0).toFixed(1));
    }

    // ä»æ’è¡Œæ¦œæ‰“å¼€å­¦ç”Ÿè¯¦æƒ…
    function openStudentDetailFromRanking(studentName) {
      console.log('ä»é¦–é¡µå°æ’è¡Œæ¦œè¿›å…¥å­¦ç”Ÿè¯¦æƒ…:', studentName);
      
      // ä»é¦–é¡µå°æ¦œè¿›å…¥è¯¦æƒ…ï¼šæ ‡è®°è¿”å›åˆ°é¦–é¡µ
      uiState.previousView = 'home';
      uiState.view = 'detail';
      uiState.selectedStudent = studentName;
      
      console.log('æ›´æ–°åçš„ uiState:', uiState);
      updateViews();
    }

    function getFilteredStudents() {
      let students = Array.from(appState.students.values());
      
      // æŒ‰æœç´¢æŸ¥è¯¢è¿‡æ»¤
      if (appState.searchQuery) {
        const query = appState.searchQuery.toLowerCase();
        students = students.filter(student => {
          const meta = appState.studentsMeta.get(student.name) || {};
          return student.name.toLowerCase().includes(query) ||
                 (meta.major && meta.major.toLowerCase().includes(query)) ||
                 (meta.grade && meta.grade.toLowerCase().includes(query));
        });
      }
      
      // æŒ‰ç­›é€‰æ¡ä»¶è¿‡æ»¤
      switch (appState.currentFilter) {
        case 'practicing':
          students = students.filter(s => s.currentStatus !== 'offline');
          break;
        case 'active-today':
          students = students.filter(s => s.isPresent);
          break;
        case 'violin':
          students = students.filter(s => {
            const meta = appState.studentsMeta.get(s.name) || {};
            return meta.major && meta.major.includes('å°æç´');
          });
          break;
        case 'piano':
          students = students.filter(s => {
            const meta = appState.studentsMeta.get(s.name) || {};
            return meta.major && meta.major.includes('é’¢ç´');
          });
          break;
        case 'other':
          students = students.filter(s => {
            const meta = appState.studentsMeta.get(s.name) || {};
            return meta.major && !meta.major.includes('å°æç´') && !meta.major.includes('é’¢ç´');
          });
          break;
      }
      
      // æ’åºï¼šæ­£åœ¨ç»ƒç´çš„ä¼˜å…ˆï¼Œç„¶åæŒ‰ä»Šæ—¥æ€»æ—¶é•¿é™åº
      students.sort((a, b) => {
        if (a.currentStatus !== 'offline' && b.currentStatus === 'offline') return -1;
        if (a.currentStatus === 'offline' && b.currentStatus !== 'offline') return 1;
        return (b.todayMinutes.in + b.todayMinutes.out) - (a.todayMinutes.in + a.todayMinutes.out);
      });
      
      return students;
    }

    function createStudentCard(student) {
      const meta = appState.studentsMeta.get(student.name) || {};
      const initials = utils.getStudentInitials(student.name);
      
      const statusInfo = getStatusInfo(student);
      const badges = generateBadges(student);
      
      return `
        <div class="student-card" data-student-name="${student.name}">
          <div class="student-header">
            <div class="student-info">
              <div class="student-avatar">${initials}</div>
              <div class="student-details">
                <h3>${student.name}</h3>
                <div class="student-meta">${meta.major || 'æœªçŸ¥ä¸“ä¸š'} Â· ${meta.grade || 'æœªçŸ¥å¹´çº§'}</div>
              </div>
            </div>
            <div class="student-status ${statusInfo.class}">
              <span class="material-icons">${statusInfo.icon}</span>
              ${statusInfo.text}
            </div>
          </div>
          
          <div class="student-body">
            <div class="progress-section">
              <div class="progress-header">
                <span class="progress-label">ä»Šæ—¥å®Œæˆåº¦</span>
                <span class="progress-value">${student.achievementRate}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${Math.min(100, student.achievementRate)}%"></div>
              </div>
            </div>
            
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-item-value">${utils.formatDuration(student.todayMinutes.in)}</div>
                <div class="stat-item-label">ä»Šæ—¥æ®µå†…æ—¶é•¿</div>
              </div>
              <div class="stat-item">
                <div class="stat-item-value">${utils.formatDuration(student.todayMinutes.out)}</div>
                <div class="stat-item-label">ä»Šæ—¥æ®µå¤–æ—¶é•¿</div>
              </div>
              <div class="stat-item">
                <div class="stat-item-value">${student.weekStreak}</div>
                <div class="stat-item-label">è¿ç»­å¤©æ•°</div>
              </div>
              <div class="stat-item">
                <div class="stat-item-value">${student.totalSessions}</div>
                <div class="stat-item-label">æœ¬å‘¨ç»ƒä¹ æ¬¡æ•°</div>
              </div>
            </div>
            
            <div class="achievement-badges">
              ${badges.join('')}
            </div>
          </div>
        </div>
      `;
    }

    function getStatusInfo(student) {
      switch (student.currentStatus) {
        case 'practicing-in':
          return {
            class: 'practicing-in',
            icon: 'music_note',
            text: 'æ­£åœ¨ç»ƒç´ï¼ˆæ®µå†…ï¼‰'
          };
        case 'practicing-out':
          return {
            class: 'practicing-out',
            icon: 'music_note',
            text: 'æ­£åœ¨ç»ƒç´ï¼ˆæ®µå¤–ï¼‰'
          };
        default:
          return {
            class: 'offline',
            icon: 'pause_circle',
            text: 'æœªåœ¨ç»ƒç´'
          };
      }
    }

    function generateBadges(student) {
      const badges = [];
      
      if (student.weekStreak >= 7) {
        badges.push('<span class="badge streak">æœ¬å‘¨å…¨å‹¤</span>');
      } else if (student.weekStreak >= 3) {
        badges.push('<span class="badge streak">è¿ç»­ç»ƒä¹ </span>');
      }
      
      if (student.achievementRate >= 100) {
        badges.push('<span class="badge target">ç›®æ ‡è¾¾æˆ</span>');
      } else if (student.achievementRate >= 80) {
        badges.push('<span class="badge target">æ¥è¿‘ç›®æ ‡</span>');
      }
      
      const weekTotal = student.weekMinutes.in + student.weekMinutes.out;
      const todayTotal = student.todayMinutes.in + student.todayMinutes.out;
      if (weekTotal > 0 && todayTotal > weekTotal / 7 * 1.5) {
        badges.push('<span class="badge improvement">ä»Šæ—¥è¶…å¸¸</span>');
      }
      
      return badges;
    }

    function openStudentModal(studentName) {
      const student = appState.students.get(studentName);
      if (!student) return;
      
      const meta = appState.studentsMeta.get(studentName) || {};
      
      document.getElementById('modalTitle').textContent = `${studentName} çš„ç»ƒç´æ•°æ®`;
      
      const modalContent = `
        <div style="margin-bottom: 24px;">
          <h3 style="margin-bottom: 12px; color: var(--on-surface-variant);">åŸºæœ¬ä¿¡æ¯</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
            <div><strong>ä¸“ä¸šï¼š</strong>${meta.major || 'æœªçŸ¥'}</div>
            <div><strong>å¹´çº§ï¼š</strong>${meta.grade || 'æœªçŸ¥'}</div>
            <div><strong>å­¦ç±å·ï¼š</strong><span style="opacity:.6">ï¼ˆå­—æ®µå·²ä¸‹çº¿ï¼‰</span></div>
          </div>
        </div>
        
        <div style="margin-bottom: 24px;">
          <h3 style="margin-bottom: 12px; color: var(--on-surface-variant);">å½“å‰çŠ¶æ€</h3>
          <div style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
            ${generateCurrentStatusHTML(student)}
          </div>
        </div>
        
        <div style="margin-bottom: 24px;">
          <h3 style="margin-bottom: 12px; color: var(--on-surface-variant);">ä»Šæ—¥ç»ƒä¹ ç»Ÿè®¡</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">
                ${utils.formatDuration(student.todayMinutes.in)}
              </div>
              <div style="color: var(--on-surface-variant);">æ®µå†…ç»ƒä¹ æ—¶é•¿</div>
            </div>
            <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <div style="font-size: 24px; font-weight: 700; color: var(--warning); margin-bottom: 8px;">
                ${utils.formatDuration(student.todayMinutes.out)}
              </div>
              <div style="color: var(--on-surface-variant);">æ®µå¤–ç»ƒä¹ æ—¶é•¿</div>
            </div>
          </div>
        </div>
        
        <div style="margin-bottom: 24px;">
          <h3 style="margin-bottom: 12px; color: var(--on-surface-variant);">æœ¬å‘¨æ•°æ®</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <div style="font-size: 20px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">
                ${utils.formatDuration(student.weekMinutes.in)}
              </div>
              <div style="color: var(--on-surface-variant);">æœ¬å‘¨æ®µå†…æ€»æ—¶é•¿</div>
            </div>
            <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <div style="font-size: 20px; font-weight: 700; color: var(--warning); margin-bottom: 8px;">
                ${utils.formatDuration(student.weekMinutes.out)}
              </div>
              <div style="color: var(--on-surface-variant);">æœ¬å‘¨æ®µå¤–æ€»æ—¶é•¿</div>
            </div>
          </div>
        </div>
        
        <div>
          <h3 style="margin-bottom: 12px; color: var(--on-surface-variant);">æˆå°±å¾½ç« </h3>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            ${generateBadges(student).join('')}
          </div>
        </div>
      `;
      
      document.getElementById('modalContent').innerHTML = modalContent;
      document.getElementById('modalOverlay').style.display = 'flex';
    }

    function generateCurrentStatusHTML(student) {
      if (student.currentStatus === 'offline') {
        return '<div style="color: var(--on-surface-variant);">å½“å‰æœªåœ¨ç»ƒç´</div>';
      }
      
      const statusText = student.currentStatus === 'practicing-in' ? 'æ—¶é—´æ®µå†…ç»ƒç´' : 'æ—¶é—´æ®µå¤–ç»ƒç´';
      const roomText = student.currentRoom ? ` Â· ${student.currentRoom}` : '';
      const timeText = student.currentStartTime ? ` Â· å¼€å§‹äº ${utils.formatTime(student.currentStartTime)}` : '';
      
      return `
        <div style="display: flex; align-items: center; gap: 12px;">
          <span class="material-icons" style="color: var(--${student.currentStatus === 'practicing-in' ? 'success' : 'warning'});">music_note</span>
          <div>
            <div style="font-weight: 500;">${statusText}</div>
            <div style="color: var(--on-surface-variant); font-size: 14px;">${roomText}${timeText}</div>
          </div>
        </div>
      `;
    }

    function closeModal() {
      document.getElementById('modalOverlay').style.display = 'none';
    }

    // ==== äº‹ä»¶ç›‘å¬å™¨ ====
    function setupEventListeners() {
      // æœç´¢åŠŸèƒ½
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', (e) => {
        appState.searchQuery = e.target.value.trim();
        renderStudentCards();
      });
      
      // ç­›é€‰åŠŸèƒ½
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelector('.filter-chip.active')?.classList.remove('active');
          chip.classList.add('active');
          appState.currentFilter = chip.dataset.filter;
          renderStudentCards();
        });
      });
      
      // æ¨¡æ€æ¡†å…³é—­
      document.getElementById('modalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          closeModal();
        }
      });

      // ç›‘å¬æ’è¡Œæ¦œæ»šåŠ¨ï¼Œé˜²æ­¢åœ¨æ»šåŠ¨æ—¶æ›´æ–°
      const rankingView = document.getElementById('rankingView');
      if (rankingView) {
        rankingView.addEventListener('scroll', () => {
          window.__lastRankingScrollTime = Date.now();
        }, { passive: true });
      }
    }

    // ==== å®æ—¶æ›´æ–°ä¼˜åŒ– ====
    
    // é¡µé¢å¯è§æ€§ç®¡ç† - æå‰å®šä¹‰ï¼Œé¿å…æœªåˆå§‹åŒ–é”™è¯¯
    let isPageVisible = !document.hidden;
    let lastVisibilityChange = Date.now();
    
    // è¿æ¥çŠ¶æ€ç®¡ç†
    let realtimeReconnectAttempts = 0;
    let realtimeReconnectTimer = null;
    const MAX_RECONNECT_ATTEMPTS = 5;
    
    // WebSocketå¿ƒè·³æ£€æµ‹ç³»ç»Ÿ
    class RealtimeHealthMonitor {
      constructor() {
        this.heartbeatInterval = null;
        this.heartbeatFrequency = 30000; // é»˜è®¤30ç§’å¿ƒè·³
        this.lastHeartbeat = Date.now();
        this.connectionQuality = 'good'; // good | fair | poor
        this.pingHistory = []; // è®°å½•pingå»¶è¿Ÿå†å²
        this.maxPingHistory = 10;
        this.isMonitoring = false;
        this.heartbeatTimeout = null;
        this.failedHeartbeats = 0;
        this.maxFailedHeartbeats = 3;
      }
      
      startMonitoring() {
        if (this.isMonitoring) return;
        this.isMonitoring = true;
        this.scheduleHeartbeat();
        dbg('å¿ƒè·³ç›‘æ§å·²å¯åŠ¨');
      }
      
      stopMonitoring() {
        this.isMonitoring = false;
        if (this.heartbeatInterval) {
          clearInterval(this.heartbeatInterval);
          this.heartbeatInterval = null;
        }
        if (this.heartbeatTimeout) {
          clearTimeout(this.heartbeatTimeout);
          this.heartbeatTimeout = null;
        }
        dbg('å¿ƒè·³ç›‘æ§å·²åœæ­¢');
      }
      
      scheduleHeartbeat() {
        if (!this.isMonitoring) return;
        
        this.heartbeatInterval = setInterval(() => {
          this.performHeartbeat();
        }, this.heartbeatFrequency);
      }
      
      async performHeartbeat() {
        if (!realtimeChannel || !isPageVisible) return;
        
        const startTime = Date.now();
        
        try {
          // ä½¿ç”¨ç®€å•çš„presenceäº‹ä»¶ä½œä¸ºå¿ƒè·³
          const heartbeatPromise = new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
              reject(new Error('å¿ƒè·³è¶…æ—¶'));
            }, 10000); // 10ç§’è¶…æ—¶
            
            // å‘é€å¿ƒè·³å¹¶ç›‘å¬å“åº”
            realtimeChannel.track({ 
              heartbeat: true, 
              timestamp: startTime,
              client_id: 'practice-tracker-' + Math.random().toString(36).substr(2, 9)
            });
            
            // ç›‘å¬ä¸€æ¬¡æ€§çš„presenceäº‹ä»¶å“åº”
            const unsubscribe = realtimeChannel.on('presence', { event: 'sync' }, () => {
              clearTimeout(timeout);
              unsubscribe();
              resolve();
            });
          });
          
          await heartbeatPromise;
          
          const pingTime = Date.now() - startTime;
          this.recordPing(pingTime);
          this.lastHeartbeat = Date.now();
          this.failedHeartbeats = 0;
          
          dbg(`å¿ƒè·³æˆåŠŸ: ${pingTime}ms, è¿æ¥è´¨é‡: ${this.connectionQuality}`);
          
        } catch (error) {
          this.failedHeartbeats++;
          dbg(`å¿ƒè·³å¤±è´¥ (${this.failedHeartbeats}/${this.maxFailedHeartbeats}): ${error.message}`);
          
          if (this.failedHeartbeats >= this.maxFailedHeartbeats) {
            dbg('è¿ç»­å¿ƒè·³å¤±è´¥ï¼Œè§¦å‘é‡è¿');
            this.onConnectionUnhealthy();
          }
        }
      }
      
      recordPing(pingTime) {
        this.pingHistory.push(pingTime);
        if (this.pingHistory.length > this.maxPingHistory) {
          this.pingHistory.shift();
        }
        
        // è®¡ç®—è¿æ¥è´¨é‡
        const avgPing = this.pingHistory.reduce((a, b) => a + b, 0) / this.pingHistory.length;
        
        if (avgPing < 200) {
          this.connectionQuality = 'good';
          this.heartbeatFrequency = 30000; // 30ç§’
        } else if (avgPing < 1000) {
          this.connectionQuality = 'fair';
          this.heartbeatFrequency = 20000; // 20ç§’
        } else {
          this.connectionQuality = 'poor';
          this.heartbeatFrequency = 15000; // 15ç§’ï¼Œæ›´é¢‘ç¹æ£€æµ‹
        }
      }
      
      onConnectionUnhealthy() {
        dbg('æ£€æµ‹åˆ°è¿æ¥ä¸å¥åº·ï¼Œå°è¯•é‡è¿');
        this.stopMonitoring();
        setConnectionStatus('syncing', 'è¿æ¥å¼‚å¸¸ï¼Œé‡è¿ä¸­...');
        // å»¶è¿Ÿè°ƒç”¨ä»¥ç¡®ä¿å‡½æ•°å·²å®šä¹‰
        setTimeout(() => {
          if (typeof attemptRealtimeReconnect === 'function') {
            attemptRealtimeReconnect();
          }
        }, 100);
      }
      
      getStatus() {
        const timeSinceLastHeartbeat = Date.now() - this.lastHeartbeat;
        return {
          quality: this.connectionQuality,
          lastHeartbeat: this.lastHeartbeat,
          timeSinceLastHeartbeat,
          avgPing: this.pingHistory.length > 0 ? 
            Math.round(this.pingHistory.reduce((a, b) => a + b, 0) / this.pingHistory.length) : 0,
          isHealthy: this.failedHeartbeats < this.maxFailedHeartbeats && timeSinceLastHeartbeat < 60000
        };
      }
    }
    
    // åˆ›å»ºå¿ƒè·³ç›‘æ§å®ä¾‹
    const healthMonitor = new RealtimeHealthMonitor();
    
    // âœ… æ™ºèƒ½èŠ‚æµé…ç½®éªŒè¯ï¼šå¹³è¡¡å®æ—¶æ€§ä¸æ€§èƒ½çš„å·®å¼‚åŒ–åŒæ­¥ç­–ç•¥
    const realtimeThrottlers = {
      rooms: throttle(() => {
        dbg('åŒæ­¥: æˆ¿é—´çŠ¶æ€å˜æ›´');
        fetchDataWithDiff('rooms');
      }, 2000), // âœ… 2ç§’èŠ‚æµ - æˆ¿é—´çŠ¶æ€é«˜ä¼˜å…ˆçº§ï¼Œå½±å“é¦–é¡µæ¦‚è§ˆå’Œå­¦ç”ŸçŠ¶æ€æ˜¾ç¤º
      
      logs: throttle(() => {
        dbg('åŒæ­¥: ç»ƒç´è®°å½•å˜æ›´');
        fetchDataWithDiff('practice_logs');
      }, 2000), // âœ… 2ç§’èŠ‚æµ - ç»ƒç´è®°å½•é«˜ä¼˜å…ˆçº§ï¼Œå½±å“æ—¶é—´è½´å®æ—¶æ€§ï¼ˆä»8ç§’ä¼˜åŒ–åˆ°2ç§’ï¼‰
      
      metadata: throttle(() => {
        dbg('åŒæ­¥: å­¦ç”Ÿä¿¡æ¯/æ—¶æ®µå˜æ›´');
        fetchDataWithDiff(['student_database', 'student_time_slots']);
      }, 10000), // âœ… 10ç§’èŠ‚æµ - å…ƒæ•°æ®ä½é¢‘å˜æ›´ï¼Œå½±å“å­¦ç”Ÿä¿¡æ¯å’Œæ—¶æ®µé…ç½®
    };
    
    // æ€§èƒ½ç›‘æ§
    let updateCounter = 0;
    let lastUpdateLog = 0;
    
    // é¡µé¢å¯è§æ€§ç›‘å¬
    document.addEventListener('visibilitychange', () => {
      isPageVisible = !document.hidden;
      lastVisibilityChange = Date.now();
      
      // åŠ¨æ€è°ƒæ•´ç¼“å­˜æ—¶é—´
      RANKING_CACHE_DURATION = isPageVisible ? 30000 : 120000;
      
      if (isPageVisible) {
        dbg('é¡µé¢é‡æ–°å¯è§ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€');
        // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œé€‚åº¦å»¶è¿Ÿåæ£€æŸ¥è¿æ¥
        setTimeout(() => {
          if (realtimeChannel && !isConnected) {
            dbg('é¡µé¢å¯è§ä½†è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿');
            attemptRealtimeReconnect();
          }
        }, 1000);
      } else {
        dbg('é¡µé¢éšè—ï¼Œé™ä½æ›´æ–°é¢‘ç‡');
      }
    });
    
    // æ™ºèƒ½é‡è¿æœºåˆ¶
    function attemptRealtimeReconnect() {
      if (realtimeReconnectTimer) return; // é¿å…é‡å¤é‡è¿
      
      realtimeReconnectAttempts++;
      if (realtimeReconnectAttempts > MAX_RECONNECT_ATTEMPTS) {
        dbg('é‡è¿æ¬¡æ•°è¶…é™ï¼Œåœæ­¢è‡ªåŠ¨é‡è¿');
        setConnectionStatus('offline', 'è¿æ¥å¤±è´¥');
        return;
      }
      
      const delay = Math.min(30000, 2000 * Math.pow(2, realtimeReconnectAttempts - 1));
      dbg(`ç¬¬${realtimeReconnectAttempts}æ¬¡é‡è¿å°è¯•ï¼Œ${delay/1000}ç§’åå¼€å§‹...`);
      
      realtimeReconnectTimer = setTimeout(() => {
        realtimeReconnectTimer = null;
        setupRealtime();
      }, delay);
    }
    
    function setupRealtime() {
      if (!isConnected) return;
      
      // ğŸ›¡ï¸ å‘¨æœ«æ¨¡å¼ï¼šå®æ—¶è®¢é˜…ä¿æŒå¼€å¯ï¼ˆç”¨äºæ˜¾ç¤ºæ›´æ–°ï¼‰ï¼Œä½†æ‰€æœ‰å†™å…¥å‡½æ•°å·²æ·»åŠ å‘¨æœ«ä¿æŠ¤
      const now = new Date();
      const currentDayOfWeek = now.getDay();
      
      if (currentDayOfWeek === 0 || currentDayOfWeek === 6) {
        const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        console.log('[å‘¨æœ«æ¨¡å¼] å®æ—¶è®¢é˜…ä¿æŒè¿è¡Œï¼Œä½†æ’è¡Œæ¦œå†™å…¥å·²ç¦ç”¨', {
          currentTime: now.toISOString(),
          currentDay: dayNames[currentDayOfWeek],
          note: 'ç»ƒç´æ—¶é•¿ã€æˆ¿é—´çŠ¶æ€ç­‰æ˜¾ç¤ºåŠŸèƒ½æ­£å¸¸ï¼Œæ’è¡Œæ¦œæ•°æ®ä¸ä¼šè¢«ä¿®æ”¹'
        });
      }
      
      // æ¸…ç†ç°æœ‰è¿æ¥
      if (realtimeChannel) {
        realtimeChannel.unsubscribe();
        realtimeChannel = null;
      }
      
      // âœ… å®Œæ•´è¡¨ç»“æ„è®¢é˜…é…ç½®éªŒè¯ï¼ˆåŸºäºæ•°æ®åº“ç»“æ„åˆ†æï¼‰
      // ğŸ“Š rooms: [name*, piano_type, location, remark, heartbeat_at, version, updated_at, occupant_student_name, register_time]
      //     -> æˆ¿é—´çŠ¶æ€å˜æ›´å½±å“ï¼šé¦–é¡µæ¦‚è§ˆã€å­¦ç”Ÿè¯¦æƒ…å½“å‰æˆ¿é—´ã€æ´»è·ƒç»Ÿè®¡
      // ğŸ“ practice_logs: [id*, created_at, action*, room_name*, student_name*, timestamp*, location, piano_type, student_major, student_grade, session_start, session_end, practice_duration]
      //     -> ç»ƒç´è®°å½•å˜æ›´å½±å“ï¼šæ—¶é—´è½´ã€æ’è¡Œæ¦œè®¡ç®—ã€æ€»è®¡ç»Ÿè®¡ã€å­¦ç”ŸçŠ¶æ€
      // ğŸ‘¥ student_database: [id*, name*, major*, grade*, archived, remark, created_at, updated_at]
      //     -> å­¦ç”Ÿä¿¡æ¯å˜æ›´å½±å“ï¼šå­¦ç”Ÿè¯¦æƒ…ã€åˆ†ç±»ç»Ÿè®¡ã€æ’è¡Œæ¦œæ˜¾ç¤º
      // â° student_time_slots: [id*, weekday*, start_time*, end_time*, duration_minutes, created_at, student_name*, updated_at]
      //     -> æ—¶é—´æ®µå˜æ›´å½±å“ï¼šè¯„åˆ†è®¡ç®—ã€æ—¶é—´æ®µæ˜¾ç¤ºã€å‡ºå‹¤åˆ¤å®š
      realtimeChannel = supabaseClient.channel('practice-tracker-optimized')
        .on('postgres_changes', { 
          event: '*', 
          schema: 'public', 
          table: 'rooms' 
        }, (payload) => {
          updateCounter++;
          const now = Date.now();
          if (now - lastUpdateLog > 15000) { // æ¯15ç§’è®°å½•ä¸€æ¬¡é¢‘ç‡
            dbg(`ğŸ”„ å®æ—¶æ›´æ–°é¢‘ç‡: ${updateCounter} æ¬¡/15s`);
            updateCounter = 0;
            lastUpdateLog = now;
          }
          
          // ğŸ“Š roomsè¡¨æ•°æ®å˜æ›´æ£€æµ‹
          dbg('ğŸ“Š roomsè¡¨å˜æ›´æ£€æµ‹:', {
            event: payload.eventType,
            table: payload.table,
            new: payload.new,
            old: payload.old
          });
          
          // é¡µé¢éšè—æ—¶é™ä½åŒæ­¥é¢‘ç‡
          if (!isPageVisible && (now - lastVisibilityChange) < 30000) {
            dbg('é¡µé¢éšè—ä¸­ï¼Œè·³è¿‡æˆ¿é—´æ›´æ–°');
            return;
          }
          
          realtimeThrottlers.rooms();
        })
        .on('postgres_changes', { 
          event: '*', 
          schema: 'public', 
          table: 'practice_logs' 
        }, (payload) => {
          // ğŸ“ practice_logsè¡¨æ•°æ®å˜æ›´æ£€æµ‹ - æœ€å…³é”®çš„å®æ—¶æ•°æ®
          const studentName = payload.new?.student_name || payload.old?.student_name;
          const eventType = payload.eventType;
          const action = payload.new?.action || payload.old?.action;
          
          dbg('ğŸ“ practice_logsè¡¨å˜æ›´æ£€æµ‹:', {
            event: eventType,
            student: studentName,
            action: action,
            room: payload.new?.room_name || payload.old?.room_name,
            timestamp: payload.new?.timestamp || payload.old?.timestamp
          });
          
          // âœ… é›†æˆæ·±åº¦ä¼˜åŒ–ï¼šä½¿ç”¨å¢é‡æ›´æ–°+WebSocket+ä¹è§‚é¢„æµ‹ï¼ˆå¸¦å†å²æ•°æ®ä¿æŠ¤ï¼‰
          if (uiState.view === 'detail' && uiState.currentStudent === studentName) {
            // ğŸ›¡ï¸ æ£€æŸ¥æ—¶é—´çª—å£ï¼Œé¿å…åœ¨æ•æ„Ÿæ—¶é—´å¤„ç†å¯èƒ½å½±å“å†å²æ•°æ®çš„æ›´æ–°
            const updateTime = new Date();
            const minutesSinceMidnight = updateTime.getHours() * 60 + updateTime.getMinutes();
            const isInSensitiveWindow = minutesSinceMidnight < 30 || (minutesSinceMidnight >= 420 && minutesSinceMidnight < 450);
            
            if (!isInSensitiveWindow) {
              dbg(`ğŸ¯ æ£€æµ‹åˆ°å½“å‰å­¦ç”Ÿ ${studentName} çš„ç»ƒç´è®°å½•å˜æ›´ï¼Œä½¿ç”¨å¢é‡æ›´æ–°`);
              
              // ä¼˜å…ˆä½¿ç”¨å¢é‡æ›´æ–°æœºåˆ¶
              setTimeout(() => {
                updateTimelineIncremental(studentName);
              }, 200); // å‡å°‘åˆ°200msï¼Œå› ä¸ºå¢é‡æ›´æ–°æ›´é«˜æ•ˆ
            } else {
              dbg(`â° æ•æ„Ÿæ—¶é—´çª—å£(${updateTime.toTimeString().substring(0, 8)})ï¼Œå»¶è¿Ÿå¤„ç†å­¦ç”Ÿ ${studentName} çš„æ›´æ–°`);
              setTimeout(() => {
                updateTimelineIncremental(studentName);
              }, 30000); // æ•æ„Ÿæ—¶é—´çª—å£å»¶è¿Ÿ30ç§’å¤„ç†
            }
            
            // å¦‚æœæ˜¯å…³é”®æ“ä½œï¼Œä¹Ÿè§¦å‘æ•°æ®åŒæ­¥ä»¥ç¡®ä¿ä¸€è‡´æ€§
            if (action === 'assign' || action === 'clear' || action === 'enter' || action === 'exit') {
              setTimeout(() => {
                realtimeThrottlers.logs();
              }, 1000);
            }
          } else {
            // éå½“å‰å­¦ç”Ÿæˆ–é¡µé¢éšè—æ—¶çš„å¤„ç†
            if (!isPageVisible) {
              dbg('é¡µé¢éšè—ä¸­ï¼Œä½¿ç”¨å»¶è¿ŸåŒæ­¥');
              setTimeout(() => {
                realtimeThrottlers.logs();
              }, 5000);
              return;
            }
            
            // ä½¿ç”¨æ ‡å‡†èŠ‚æµåŒæ­¥
            realtimeThrottlers.logs();
          }
        })
        .on('postgres_changes', { 
          event: '*', 
          schema: 'public', 
          table: 'student_database' 
        }, (payload) => {
          // ğŸ‘¥ student_databaseè¡¨æ•°æ®å˜æ›´æ£€æµ‹ - ä½¿ç”¨å¢é‡æ›´æ–°
          const studentName = payload.new?.name || payload.old?.name;
          
          dbg('ğŸ‘¥ student_databaseè¡¨å˜æ›´æ£€æµ‹:', {
            event: payload.eventType,
            name: studentName,
            major: payload.new?.major || payload.old?.major,
            grade: payload.new?.grade || payload.old?.grade,
            archived: payload.new?.archived || payload.old?.archived
          });
          
          // ç«‹å³ä½¿ç”¨å¢é‡æ›´æ–°
          setTimeout(() => {
            updateStudentInfoIncremental(studentName, payload.new);
          }, 200);
          
          // å…œåº•ï¼šæ ‡å‡†æ•°æ®åŒæ­¥
          realtimeThrottlers.metadata();
        })
        .on('postgres_changes', { 
          event: '*', 
          schema: 'public', 
          table: 'student_time_slots' 
        }, (payload) => {
          // â° student_time_slotsè¡¨æ•°æ®å˜æ›´æ£€æµ‹ - ä½¿ç”¨å¢é‡æ›´æ–°
          const studentName = payload.new?.student_name || payload.old?.student_name;
          
          dbg('â° student_time_slotsè¡¨å˜æ›´æ£€æµ‹:', {
            event: payload.eventType,
            student: studentName,
            weekday: payload.new?.weekday || payload.old?.weekday,
            start_time: payload.new?.start_time || payload.old?.start_time,
            end_time: payload.new?.end_time || payload.old?.end_time
          });
          
          // ç«‹å³ä½¿ç”¨å¢é‡æ›´æ–°
          setTimeout(() => {
            updateStudentSlotsIncremental(studentName, payload.new);
          }, 200);
          
          // å…œåº•ï¼šæ ‡å‡†æ•°æ®åŒæ­¥
          realtimeThrottlers.metadata();
        })
        .on('postgres_changes', { 
          event: '*', 
          schema: 'public', 
          table: 'rooms' 
        }, (payload) => {
          // ğŸ  roomsè¡¨æ•°æ®å˜æ›´æ£€æµ‹ - ä½¿ç”¨å¢é‡æ›´æ–°
          const roomName = payload.new?.name || payload.old?.name;
          
          dbg('ğŸ  roomsè¡¨å˜æ›´æ£€æµ‹:', {
            event: payload.eventType,
            room: roomName,
            occupant: payload.new?.occupant_student_name || payload.old?.occupant_student_name
          });
          
          // ç«‹å³ä½¿ç”¨å¢é‡æ›´æ–°
          setTimeout(() => {
            updateRoomStatusIncremental(roomName, payload.new);
          }, 200);
          
          // é¡µé¢éšè—æ—¶é™ä½æˆ¿é—´çŠ¶æ€åŒæ­¥é¢‘ç‡
          if (!isPageVisible && (Date.now() - lastVisibilityChange) < 30000) {
            dbg('é¡µé¢éšè—ä¸­ï¼Œå»¶è¿Ÿæˆ¿é—´æ›´æ–°');
            setTimeout(() => {
              realtimeThrottlers.rooms();
            }, 3000);
            return;
          }
          
          realtimeThrottlers.rooms();
        })
        .subscribe(status => {
          dbg(`Realtimeè¿æ¥çŠ¶æ€: ${status}`);
          
          if (status === 'SUBSCRIBED') {
            setConnectionStatus('online', 'å®æ—¶è¿æ¥');
            realtimeReconnectAttempts = 0; // é‡ç½®é‡è¿è®¡æ•°
            
            if (realtimeReconnectTimer) {
              clearTimeout(realtimeReconnectTimer);
              realtimeReconnectTimer = null;
            }
            
            // è¿æ¥æˆåŠŸåå¯åŠ¨å¿ƒè·³ç›‘æ§
            healthMonitor.startMonitoring();
            
            // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤ºï¼ŒåŒ…å«è¿æ¥è´¨é‡ä¿¡æ¯
            setTimeout(() => {
              const healthStatus = healthMonitor.getStatus();
              const qualityText = healthStatus.quality === 'good' ? 'ä¼˜ç§€' : 
                                healthStatus.quality === 'fair' ? 'è‰¯å¥½' : 'è¾ƒå·®';
              setConnectionStatus('online', `å®æ—¶è¿æ¥ (${qualityText})`);
            }, 2000); // ç­‰å¾…2ç§’åæ˜¾ç¤ºè¿æ¥è´¨é‡
            
          } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT' || status === 'CLOSED') {
            setConnectionStatus('syncing', 'è¿æ¥ä¸­...');
            
            // åœæ­¢å¿ƒè·³ç›‘æ§
            healthMonitor.stopMonitoring();
            
            // æ™ºèƒ½é‡è¿ï¼šæ£€æŸ¥é¡µé¢çŠ¶æ€å’Œç½‘ç»œçŠ¶å†µ
            if (isPageVisible && navigator.onLine) {
              setTimeout(() => attemptRealtimeReconnect(), 1000);
            } else {
              dbg('é¡µé¢éšè—æˆ–ç½‘ç»œç¦»çº¿ï¼Œæš‚åœé‡è¿');
            }
          }
        });
    }
    
    // ï¿½ è°ƒè¯•å·¥å…·ï¼šæ£€æŸ¥æŒ‡å®šæ—¥æœŸçš„åŸå§‹æ•°æ®
    window.debugPracticeLogsForDate = async function(targetDate) {
      console.log('â•'.repeat(60));
      console.log(`ğŸ” è°ƒè¯• ${targetDate} çš„ç»ƒç´æ—¥å¿—`);
      console.log('â•'.repeat(60));
      
      if (!supabaseClient) {
        console.error('âŒ Supabase æœªåˆå§‹åŒ–');
        return;
      }
      
      try {
        // æŸ¥è¯¢å‰å3å¤©çš„æ•°æ®
        const targetDateObj = new Date(targetDate + 'T00:00:00');
        const startDate = new Date(targetDateObj);
        startDate.setDate(startDate.getDate() - 3);
        const endDate = new Date(targetDateObj);
        endDate.setDate(endDate.getDate() + 3);
        
        console.log('ğŸ“… æŸ¥è¯¢èŒƒå›´:', startDate.toISOString(), 'åˆ°', endDate.toISOString());
        
        const { data, error } = await supabaseClient
          .from('practice_logs')
          .select('timestamp, student_name, action, room_name')
          .gte('timestamp', startDate.toISOString())
          .lte('timestamp', endDate.toISOString())
          .order('timestamp', { ascending: true });
        
        if (error) {
          console.error('âŒ æŸ¥è¯¢å¤±è´¥:', error);
          return;
        }
        
        console.log(`ğŸ“Š æ€»å…±æ‰¾åˆ° ${data.length} æ¡æ—¥å¿—`);
        
        // æŒ‰æ—¥æœŸåˆ†ç»„ç»Ÿè®¡
        const byDate = new Map();
        data.forEach(log => {
          const date = new Date(log.timestamp).toISOString().split('T')[0];
          if (!byDate.has(date)) {
            byDate.set(date, []);
          }
          byDate.get(date).push(log);
        });
        
        console.log('ğŸ“… æŒ‰æ—¥æœŸåˆ†ç»„ç»Ÿè®¡:');
        Array.from(byDate.keys()).sort().forEach(date => {
          const count = byDate.get(date).length;
          const marker = date === targetDate ? 'ğŸ‘‰' : '  ';
          console.log(`${marker} ${date}: ${count} æ¡æ—¥å¿—`);
        });
        
        // æ˜¾ç¤ºç›®æ ‡æ—¥æœŸçš„è¯¦ç»†æ•°æ®
        if (byDate.has(targetDate)) {
          console.log(`\nğŸ“ ${targetDate} çš„æ—¥å¿—æ ·æœ¬ (å‰20æ¡):`);
          console.table(byDate.get(targetDate).slice(0, 20).map(l => ({
            æ—¶é—´: new Date(l.timestamp).toLocaleString('zh-CN'),
            å­¦ç”Ÿ: l.student_name,
            æ“ä½œ: l.action,
            ç´æˆ¿: l.room_name
          })));
          
          return { success: true, count: byDate.get(targetDate).length, data: byDate.get(targetDate) };
        } else {
          console.warn(`âš ï¸ æœªæ‰¾åˆ° ${targetDate} çš„æ—¥å¿—`);
          return { success: false, count: 0 };
        }
        
      } catch (error) {
        console.error('âŒ è°ƒè¯•è¿‡ç¨‹å‡ºé”™:', error);
        return { success: false, error: error.message };
      }
    };
    
    // ï¿½ğŸ”§ ç®¡ç†å‘˜å·¥å…·ï¼šé‡ç®—æŒ‡å®šæ—¥æœŸçš„æ’è¡Œæ¦œæ•°æ®
    window.repairLeaderboardForDate = async function(targetDate) {
      console.log('â•'.repeat(60));
      console.log(`ğŸ”§ å¼€å§‹ä¿®å¤ ${targetDate} çš„æ’è¡Œæ¦œæ•°æ®`);
      console.log('â•'.repeat(60));
      
      if (!supabaseClient) {
        console.error('âŒ Supabase æœªåˆå§‹åŒ–');
        return;
      }
      
      try {
        // ğŸ”§ é¢„å…ˆå£°æ˜ç›®æ ‡æ—¥æœŸç›¸å…³å˜é‡ï¼ˆæ˜ç¡®ä½¿ç”¨æœ¬åœ°æ—¶åŒº UTC+8ï¼‰
        const targetDateStart = new Date(targetDate + 'T00:00:00+08:00');  // æœ¬åœ°00:00
        const weekday = targetDateStart.getDay();
        const dayStartMs = targetDateStart.getTime();  // æ¯«ç§’æ—¶é—´æˆ³ï¼ˆæ—¶åŒºæ— å…³ï¼‰
        
        console.log('ğŸ• ç›®æ ‡æ—¥æœŸæ—¶åŒºä¿¡æ¯:', {
          ç›®æ ‡æ—¥æœŸ: targetDate,
          æœ¬åœ°æ—¶é—´: targetDateStart.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }),
          UTCæ—¶é—´: targetDateStart.toISOString(),
          æ—¶é—´æˆ³: dayStartMs,
          æ˜ŸæœŸ: ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][weekday]
        });
        
        // 1. è·å–ç›®æ ‡æ—¥æœŸçš„æ‰€æœ‰å­¦ç”Ÿ
        const students = await supabaseClient
          .from('student_database')
          .select('name')
          .eq('archived', false);
        
        if (!students.data || students.data.length === 0) {
          console.error('âŒ æœªæ‰¾åˆ°å­¦ç”Ÿæ•°æ®');
          return;
        }
        
        const studentList = students.data.map(s => s.name);
        console.log(`ğŸ“Š æ‰¾åˆ° ${studentList.length} åå­¦ç”Ÿ`);
        
        // 2. è·å–ç›®æ ‡æ—¥æœŸçš„ç»ƒç´æ—¥å¿—ï¼ˆä½¿ç”¨æ›´å®½æ¾çš„æŸ¥è¯¢èŒƒå›´ï¼‰
        // é—®é¢˜ï¼štimestamp å­—æ®µå¯èƒ½æ˜¯ UTC æ—¶åŒºï¼Œéœ€è¦æŸ¥è¯¢å‰åä¸€å¤©é¿å…é—æ¼
        const targetDateObj = targetDateStart;
        const prevDay = new Date(targetDateObj);
        prevDay.setDate(prevDay.getDate() - 1);
        const nextDay = new Date(targetDateObj);
        nextDay.setDate(nextDay.getDate() + 1);
        
        console.log('ğŸ“… æŸ¥è¯¢æ—¶é—´èŒƒå›´:', {
          targetDate,
          queryStart: prevDay.toISOString(),
          queryEnd: nextDay.toISOString()
        });
        
        // å…ˆæŸ¥è¯¢æ›´å¤§èŒƒå›´ï¼Œå†è¿‡æ»¤
        const logs = await supabaseClient
          .from('practice_logs')
          .select('*')
          .gte('timestamp', prevDay.toISOString())
          .lte('timestamp', nextDay.toISOString())
          .order('timestamp', { ascending: true });
        
        if (!logs.data) {
          console.error('âŒ è·å–ç»ƒç´æ—¥å¿—å¤±è´¥', logs.error);
          return;
        }
        
        console.log(`ğŸ“ åŸå§‹æŸ¥è¯¢åˆ° ${logs.data.length} æ¡æ—¥å¿—ï¼ˆå‰åä¸€å¤©èŒƒå›´ï¼‰`);
        
        // ğŸ”§ è¿‡æ»¤å‡ºç›®æ ‡æ—¥æœŸçš„æ—¥å¿—ï¼ˆè€ƒè™‘æ—¶åŒºå·®å¼‚ï¼šæ•°æ®åº“UTC vs æœ¬åœ°UTC+8ï¼‰
        // æœ¬åœ°10æœˆ14æ—¥ 00:00-23:59 å¯¹åº” UTC 10æœˆ13æ—¥ 16:00 - 10æœˆ14æ—¥ 15:59
        const targetLocalStart = new Date(targetDate + 'T00:00:00+08:00');  // æœ¬åœ°00:00
        const targetLocalEnd = new Date(targetDate + 'T23:59:59+08:00');    // æœ¬åœ°23:59
        
        console.log('ğŸ• æ—¶åŒºè½¬æ¢:', {
          æœ¬åœ°å¼€å§‹: targetLocalStart.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }),
          æœ¬åœ°ç»“æŸ: targetLocalEnd.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }),
          UTCå¼€å§‹: targetLocalStart.toISOString(),
          UTCç»“æŸ: targetLocalEnd.toISOString()
        });
        
        const filteredLogs = logs.data.filter(log => {
          const logTime = new Date(log.timestamp);
          return logTime >= targetLocalStart && logTime <= targetLocalEnd;
        });
        
        console.log(`ğŸ“ è¿‡æ»¤åæ‰¾åˆ° ${filteredLogs.length} æ¡ ${targetDate} çš„ç»ƒç´æ—¥å¿—`);
        
        if (filteredLogs.length === 0) {
          console.warn('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•ç»ƒç´æ—¥å¿—ï¼Œå°è¯•æ˜¾ç¤ºåŸå§‹æ•°æ®æ ·æœ¬:');
          if (logs.data.length > 0) {
            console.table(logs.data.slice(0, 5).map(l => ({
              timestamp: l.timestamp,
              æ—¥æœŸ: new Date(l.timestamp).toISOString().split('T')[0],
              student: l.student_name,
              action: l.action,
              room: l.room_name
            })));
          }
        }
        
        // 3. æŒ‰å­¦ç”Ÿåˆ†ç»„æ—¥å¿—ï¼ˆä½¿ç”¨è¿‡æ»¤åçš„æ—¥å¿—ï¼‰
        const logsByStudent = new Map();
        filteredLogs.forEach(log => {
          const name = utils.normalizeStudentName(log.student_name);
          if (!logsByStudent.has(name)) {
            logsByStudent.set(name, []);
          }
          logsByStudent.get(name).push(log);
        });
        
        // 4. è·å–å‰ä¸€å·¥ä½œæ—¥æ’åï¼ˆç”¨äºD3è®¡ç®—ï¼‰
        const prevWorkday = getPreviousWorkday(new Date(targetDate));
        const prevDateISO = utils.toIsoDate(prevWorkday);
        
        const prevRanking = await supabaseClient
          .from('leaderboard_daily')
          .select('student_key, rank, total')
          .eq('date', prevDateISO)
          .order('rank', { ascending: true });
        
        const prevRankMap = new Map();
        if (prevRanking.data) {
          prevRanking.data.forEach(r => {
            prevRankMap.set(utils.normalizeStudentName(r.student_key), {
              rank: r.rank,
              total: r.total
            });
          });
          console.log(`ğŸ“ˆ å‰ä¸€å·¥ä½œæ—¥(${prevDateISO})æ’åæ•°æ®: ${prevRankMap.size} äºº`);
        }
        
        // 5. è®¡ç®—æ¯ä¸ªå­¦ç”Ÿçš„åˆ†æ•°
        const results = [];
        let calculated = 0;
        let noPractice = 0;
        let errors = 0;
        
        console.log('ğŸ”„ å¼€å§‹è®¡ç®—å­¦ç”Ÿåˆ†æ•°...');
        
        for (let i = 0; i < studentList.length; i++) {
          const studentName = studentList[i];
          
          try {
            const normalizedName = utils.normalizeStudentName(studentName);
            const studentLogs = logsByStudent.get(normalizedName) || [];
            
            // æ¯å¤„ç†10ä¸ªå­¦ç”Ÿæ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
            if ((i + 1) % 10 === 0) {
              console.log(`ğŸ“Š è¿›åº¦: ${i + 1}/${studentList.length} (${Math.round((i + 1) / studentList.length * 100)}%)`);
            }
            
            if (studentLogs.length === 0) {
              // æ— ç»ƒç´è®°å½•
              results.push({
                date: targetDate,
                student_key: normalizedName,
                d1: 0,
                d2: 0,
                d3: 0,
                total: 0,
                rank: null,
                rule_version: RULE_VERSION,
                window: __leaderboardWindowJSON(weekday),
                no_practice: true,
                updated_at: new Date().toISOString()
              });
              noPractice++;
              continue;
            }
            
          // æ„å»ºç»ƒç´åŒºé—´ï¼ˆåŸå§‹åŒºé—´ï¼Œæœªè£å‰ªï¼‰
          const intervalsRaw = buildPracticeIntervals(studentLogs, targetDateStart);
          
          // è·å–æ’è¡Œæ¦œçª—å£ï¼ˆä¸å½“å‰æ’è¡Œæ¦œé€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
          const leaderboardWindow = getLeaderboardWindow(targetDateStart);
          if (!leaderboardWindow) {
            // å‘¨æœ«ä¸å‚ä¸æ’è¡Œæ¦œï¼Œè·³è¿‡
            continue;
          }
          
          // è£å‰ªç»ƒç´åŒºé—´åˆ°æ’è¡Œæ¦œçª—å£
          const intervals = intervalsRaw.map(iv => {
            const ws = dayStartMs + leaderboardWindow.startMin * 60000;
            const we = dayStartMs + leaderboardWindow.endMin * 60000;
            const s = Math.max(iv.start, ws);
            const e = Math.min(iv.end, we);
            if (e > s) return { start: s, end: e };
            return null;
          }).filter(iv => iv !== null);
          
          // è·å–å­¦ç”Ÿæ—¶é—´æ®µé…ç½®
          const slotsResult = await supabaseClient
            .from('student_time_slots')
            .select('*')
            .eq('student_name', normalizedName)
            .eq('weekday', weekday);
          
          // è½¬æ¢å¹¶è£å‰ª slots åˆ°æ’è¡Œæ¦œçª—å£
          let slotsMin = [];
          if (slotsResult.data && slotsResult.data.length > 0) {
            slotsMin = slotsResult.data.map(slot => {
              const startParts = (slot.start_time || '').split(':');
              const endParts = (slot.end_time || '').split(':');
              const start = parseInt(startParts[0]) * 60 + parseInt(startParts[1] || 0);
              const end = parseInt(endParts[0]) * 60 + parseInt(endParts[1] || 0);
              // è£å‰ªåˆ°æ’è¡Œæ¦œçª—å£
              const st = Math.max(start, leaderboardWindow.startMin);
              const ed = Math.min(end, leaderboardWindow.endMin);
              if (ed > st) return { start: st, end: ed };
              return null;
            }).filter(s => s !== null);
          } else if (intervals.length > 0) {
            // ğŸ”§ å…œåº•æ–¹æ¡ˆï¼šå¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰æ—¶æ®µé…ç½®ï¼Œä½†æœ‰ç»ƒç´è®°å½•
            // å°è¯•ä»å†…å­˜ä¸­çš„ appState.timeSlots è¯»å–
            console.warn(`âš ï¸ ${normalizedName} æ•°æ®åº“ä¸­æ— æ—¶æ®µé…ç½®ï¼Œå°è¯•ä»å†…å­˜è¯»å–`);
            const memorySlots = getLeaderboardSlotsMinutes(studentName, targetDateStart);
            if (memorySlots && memorySlots.length > 0) {
              slotsMin = memorySlots;
              console.log(`âœ… ä»å†…å­˜æ‰¾åˆ° ${slotsMin.length} ä¸ªæ—¶æ®µ`);
            } else {
              console.warn(`âŒ ${normalizedName} å†…å­˜ä¸­ä¹Ÿæ— æ—¶æ®µé…ç½®ï¼ŒD1å°†ä¸º0åˆ†`);
            }
          }
          
          // è®¡ç®—D1ã€D2åˆ†æ•°ï¼ˆä½¿ç”¨ä¸å½“å‰æ’è¡Œæ¦œå®Œå…¨ç›¸åŒçš„å‡½æ•°å’Œè£å‰ªåçš„æ•°æ®ï¼‰
          const d1Result = computeDim1Score(slotsMin, intervals, dayStartMs);
          const d2Result = computeDim2Score(slotsMin, intervals, dayStartMs, weekday);
          const d1 = d1Result.score || 0;
          const d2 = d2Result.score || 0;
          
          // ğŸ”§ å…³é”®ä¿®å¤ï¼šåœ¨è®¡ç®—D3å‰ï¼Œå…ˆå°†å½“å¤©çš„D1+D2æ³¨å…¥åˆ°ç¼“å­˜
          // å› ä¸ºD3è®¡ç®—ä¼šè¯»å–"è¿‘Nä¸ªå·¥ä½œæ—¥"çš„æ•°æ®ï¼Œè¿™åŒ…æ‹¬å½“å¤©æœ¬èº«
          // å¦‚æœä¸æ³¨å…¥ï¼Œä¼šä»æ•°æ®åº“è¯»å–åˆ°0æˆ–æ—§å€¼ï¼Œå¯¼è‡´D3è®¡ç®—é”™è¯¯
          if (typeof __cloudD3 !== 'undefined' && __cloudD3.d12CacheByDate) {
            let todayMap = __cloudD3.d12CacheByDate.get(targetDate);
            if (!todayMap) {
              todayMap = new Map();
              __cloudD3.d12CacheByDate.set(targetDate, todayMap);
            }
            todayMap.set(normalizedName, d1 + d2);
          }
          
          // è®¡ç®—D3åˆ†æ•°ï¼ˆä½¿ç”¨ä¸å½“å‰æ’è¡Œæ¦œå®Œå…¨ç›¸åŒçš„äº‘ç«¯å‡½æ•°ï¼‰
          const d3Result = await computeDim3ScoreCloud(normalizedName, targetDateStart, d1 + d2);
          const d3 = d3Result.score || 0;
          
          // ğŸ”§ è®¡ç®—æ€»åˆ†ï¼šåŒ…å«æ‰€æœ‰é¢å¤–åŠ åˆ†å…ƒç´ 
          let total = d1 + d2 + d3;
          
          // 1. æ»¡å‹¤åŠ åˆ†ï¼ˆä»D1çš„breakdownè·å–ï¼‰
          if (d1Result.breakdown && d1Result.breakdown.gotFullBonus) {
            total += (d1Result.breakdown.fullBonusAward || 0);
          }
          
          // 2. ç®¡ç†å‘˜è°ƒåˆ†
          const adminAdjustment = getAdminScoreAdjustment(studentName);
          if (adminAdjustment !== 0) {
            total += adminAdjustment;
          }
          
          // é™åˆ¶åœ¨0-100èŒƒå›´å†…
          total = +(Math.max(0, Math.min(100, total))).toFixed(2);
          
          results.push({
            date: targetDate,
            student_key: normalizedName,
            d1: +d1.toFixed(2),
            d2: +d2.toFixed(2),
            d3: +d3.toFixed(2),
            total: total,
            rank: null, // åç»­è®¡ç®—
            rule_version: RULE_VERSION,
            window: __leaderboardWindowJSON(weekday),
            no_practice: false,
            updated_at: new Date().toISOString()
          });
          calculated++;
          
          } catch (err) {
            console.error(`âŒ å¤„ç†å­¦ç”Ÿ ${studentName} æ—¶å‡ºé”™:`, err);
            errors++;
            // å‡ºé”™æ—¶ä¹Ÿè®°å½•0åˆ†ï¼Œé¿å…æ•°æ®ç¼ºå¤±
            results.push({
              date: targetDate,
              student_key: utils.normalizeStudentName(studentName),
              d1: 0,
              d2: 0,
              d3: 0,
              total: 0,
              rank: null,
              rule_version: RULE_VERSION,
              window: __leaderboardWindowJSON(weekday),
              no_practice: true,
              updated_at: new Date().toISOString()
            });
          }
        }
        
        console.log(`âœ… è®¡ç®—å®Œæˆ: ${calculated} äººæœ‰ç»ƒç´, ${noPractice} äººæ— ç»ƒç´, ${errors} äººå‡ºé”™`);
        
        // 6. è®¡ç®—æ’å
        const withScore = results.filter(r => r.total > 0).sort((a, b) => b.total - a.total);
        let rank = 1;
        for (let i = 0; i < withScore.length; i++) {
          if (i > 0 && withScore[i].total < withScore[i - 1].total) {
            rank = i + 1;
          }
          withScore[i].rank = rank;
        }
        
        // å°†æ’åå†™å›ç»“æœ
        const keyToRank = new Map(withScore.map(r => [r.student_key, r.rank]));
        results.forEach(r => {
          r.rank = keyToRank.get(r.student_key) || null;
        });
        
        console.log(`ğŸ“Š æ’åè®¡ç®—å®Œæˆ: ${withScore.length} äººå‚ä¸æ’å`);
        
        // 7. å†™å…¥æ•°æ®åº“ï¼ˆéœ€è¦å…ˆè§£é™¤ä¿æŠ¤ï¼‰
        console.log('âš ï¸ å‡†å¤‡å†™å…¥æ•°æ®åº“...');
        console.log('è¯·åœ¨æ§åˆ¶å°æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è§£é™¤ä¿æŠ¤:');
        console.log('window.__dataProtectionSystem.enableAdminBypass("REPAIR_HISTORICAL_DATA_2024")');
        console.log('');
        console.log('ç„¶åæ‰§è¡Œ:');
        console.log(`window._pendingRepairData = ${JSON.stringify({ date: targetDate, count: results.length })}`);
        console.log('window._repairResults = [ç»“æœæ•°ç»„]'); 
        
        // ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾›æ‰‹åŠ¨æäº¤
        window._repairResults = results;
        window._repairTargetDate = targetDate;
        
        console.log('');
        console.log('ğŸ’¾ æ•°æ®å·²å‡†å¤‡å®Œæ¯•ï¼Œä¿å­˜åœ¨ window._repairResults');
        console.log('æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æäº¤åˆ°æ•°æ®åº“:');
        console.log('await window.submitRepairData()');
        console.log('â•'.repeat(60));
        
        return { success: true, count: results.length, data: results };
        
      } catch (error) {
        console.error('âŒ ä¿®å¤è¿‡ç¨‹å‡ºé”™:', error);
        return { success: false, error: error.message };
      }
    };
    
    // è¾…åŠ©å‡½æ•°ï¼šæ„å»ºç»ƒç´åŒºé—´
    function buildPracticeIntervals(logs, dayStart) {
      const intervals = [];
      const assigns = logs.filter(l => l.action === 'assign').sort((a, b) => 
        new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime()
      );
      const clears = logs.filter(l => l.action === 'clear').sort((a, b) => 
        new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime()
      );
      
      for (const assign of assigns) {
        const assignTime = new Date(assign.timestamp).getTime();
        // æ‰¾åˆ°æœ€è¿‘çš„clear
        const matchingClear = clears.find(c => {
          const clearTime = new Date(c.timestamp).getTime();
          return clearTime > assignTime && 
                 c.student_name === assign.student_name &&
                 c.room_name === assign.room_name;
        });
        
        if (matchingClear) {
          const clearTime = new Date(matchingClear.timestamp).getTime();
          // è¿”å›å¯¹è±¡æ ¼å¼ {start, end}ï¼Œè€Œä¸æ˜¯æ•°ç»„ [start, end]
          intervals.push({ start: assignTime, end: clearTime });
        }
      }
      
      return intervals;
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å–å‰ä¸€å·¥ä½œæ—¥
    function getPreviousWorkday(date) {
      const prev = new Date(date);
      prev.setDate(prev.getDate() - 1);
      while (prev.getDay() === 0 || prev.getDay() === 6) {
        prev.setDate(prev.getDate() - 1);
      }
      return prev;
    }
    
    // æäº¤ä¿®å¤æ•°æ®åˆ°æ•°æ®åº“
    window.submitRepairData = async function() {
      if (!window._repairResults) {
        console.error('âŒ æ²¡æœ‰å¾…æäº¤çš„ä¿®å¤æ•°æ®');
        return;
      }
      
      if (!window.__dataProtectionSystem._adminBypassProtection) {
        console.error('âŒ è¯·å…ˆè§£é™¤ä¿æŠ¤: window.__dataProtectionSystem.enableAdminBypass("REPAIR_HISTORICAL_DATA_2024")');
        return;
      }
      
      const results = window._repairResults;
      const targetDate = window._repairTargetDate;
      
      console.log(`ğŸ“¤ å¼€å§‹æäº¤ ${results.length} æ¡æ•°æ®åˆ° leaderboard_daily...`);
      
      try {
        const BATCH = 50;
        let submitted = 0;
        
        for (let i = 0; i < results.length; i += BATCH) {
          const batch = results.slice(i, i + BATCH);
          const { error } = await supabaseClient
            .from('leaderboard_daily')
            .upsert(batch, { onConflict: 'date,student_key' });
          
          if (error) {
            console.error(`âŒ æ‰¹æ¬¡ ${Math.floor(i / BATCH) + 1} æäº¤å¤±è´¥:`, error);
            throw error;
          }
          
          submitted += batch.length;
          console.log(`âœ… å·²æäº¤ ${submitted}/${results.length} æ¡`);
        }
        
        console.log('â•'.repeat(60));
        console.log(`âœ… ${targetDate} æ’è¡Œæ¦œæ•°æ®ä¿®å¤å®Œæˆï¼`);
        console.log(`ğŸ“Š æ€»è®¡: ${submitted} æ¡è®°å½•`);
        console.log('');
        console.log('âš ï¸ è¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤é‡æ–°å¯ç”¨ä¿æŠ¤:');
        console.log('window.__dataProtectionSystem.disableAdminBypass()');
        console.log('â•'.repeat(60));
        
        // æ¸…ç†
        delete window._repairResults;
        delete window._repairTargetDate;
        
        return { success: true, submitted };
        
      } catch (error) {
        console.error('âŒ æäº¤å¤±è´¥:', error);
        return { success: false, error: error.message };
      }
    };
    
    // ==== åº”ç”¨åˆå§‹åŒ– ====
    let isAppInitialized = false; // é˜²é‡å¤åˆå§‹åŒ–æ ‡å¿—
    
    async function initializeApp() {
      if (isAppInitialized) {
        dbg('åº”ç”¨å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
        return;
      }
      isAppInitialized = true;
      
      dbg('=== åº”ç”¨åˆå§‹åŒ–å¼€å§‹ ===');
      const startTime = performance.now();
      
      // ç«‹å³æ˜¾ç¤ºåŸºç¡€ç•Œé¢
      updateViews();
      setupHomeInteractions();
      
  // ï¼ˆå·²åˆ é™¤ï¼‰åˆå§‹åŒ–iOSæ»‘åŠ¨è¿”å›æ‰‹åŠ¿è°ƒç”¨
      
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        setConnectionStatus('connecting', 'æ­£åœ¨è¿æ¥...');
        
        // ä¸å†ä¾èµ–é¡¶éƒ¨äº¤äº’
        dbg('åˆå§‹åŒ– Supabase...');
        const connected = await initializeSupabase();
        dbg('Supabase è¿æ¥ç»“æœ:', connected);
        
        if (connected) {
          setConnectionStatus('syncing', 'åŠ è½½æ•°æ®...');
          dbg('å¼€å§‹è·å–æ•°æ®...');
          await fetchAllData();
          dbg('åŠ è½½ç®¡ç†å‘˜è°ƒåˆ†æ•°æ®...');
          try {
            await loadAdminScoresFromCloud();
          } catch (error) {
            dbg('ç®¡ç†å‘˜è°ƒåˆ†æ•°æ®åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ•°æ®:', error);
          }
          dbg('è®¾ç½®å®æ—¶ç›‘å¬...');
          setupRealtime();
          dbg('ğŸŒ å¯åŠ¨æ—¶é—´è½´WebSocket...');
          setupTimelineWebSocket();
          dbg('å¯åŠ¨å®šæ—¶åŒæ­¥...');
          startDailySyncScheduler();
          setConnectionStatus('online', 'å·²è¿æ¥');
        } else {
          setConnectionStatus('offline', 'è¿æ¥å¤±è´¥');
        }
        
        const endTime = performance.now();
        dbg(`åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
      } catch (error) {
        console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
        setConnectionStatus('offline', 'åˆå§‹åŒ–å¤±è´¥');
      }
    }

    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', initializeApp);

    // å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
    window.closeModal = closeModal;
    window.openStudentDetail = openStudentDetail;
  window.openRankingView = openRankingView;
  window.openStudentDetailFromRankingFull = openStudentDetailFromRankingFull;
  
  // ğŸš€ æ·±åº¦ä¼˜åŒ–å…¨å±€æ¥å£ - å¤šè¡¨æ”¯æŒ
  window.updateStudentStatusOptimistic = updateStudentStatusOptimistic;
  window.updateTimelineIncremental = updateTimelineIncremental;
  window.optimisticFilter = optimisticFilter;
  
  // ğŸŒ å¤šè¡¨å¢é‡æ›´æ–°æ¥å£
  window.updateStudentSlotsIncremental = updateStudentSlotsIncremental;
  window.updateRoomStatusIncremental = updateRoomStatusIncremental;
  window.updateStudentInfoIncremental = updateStudentInfoIncremental;
  
  // ï¿½ å¤šè¡¨ä¹è§‚é¢„æµ‹æ¥å£
  window.updateStudentSlotsOptimistic = updateStudentSlotsOptimistic;
  window.updateRoomStatusOptimistic = updateRoomStatusOptimistic;
  window.updateStudentInfoOptimistic = updateStudentInfoOptimistic;
  
  // ï¿½ğŸ“Š ä¼˜åŒ–æ•ˆæœç›‘æ§ - æ‰©å±•ç»Ÿè®¡
  window.getOptimizationStats = () => ({
    caches: {
      timeline: timelineCache.size,
      studentSlots: studentSlotsCache.size,
      rooms: roomsCache.size,
      students: studentsCache.size
    },
    optimisticUpdates: optimisticUpdates.size,
    websocketStatus: timelineWebSocket?.readyState,
    lastUpdateLatency: window.__lastUpdateLatency || 0,
    totalCacheHits: window.__cacheHits || 0
  });
  
  // ğŸ§¹ ç¼“å­˜ç®¡ç†æ¥å£
  window.clearOptimizationCaches = () => {
    timelineCache.clear();
    studentSlotsCache.clear();
    roomsCache.clear();
    studentsCache.clear();
    optimisticUpdates.clear();
    if (typeof __rankTopCache !== 'undefined') __rankTopCache.clear();
    console.log('ğŸ§¹ æ‰€æœ‰ä¼˜åŒ–ç¼“å­˜å·²æ¸…ç†');
  };

    // ========== å½“æ—¥æ’è¡Œæ¦œè‡ªåŠ¨åŒæ­¥åŠŸèƒ½ ==========
    
    // å®‰å…¨æ£€æŸ¥ï¼šéªŒè¯æ—¥æœŸæ˜¯å¦å…è®¸åŒæ­¥
    function isSafeDateForSync(dateString) {
      const today = new Date();
      const todayISO = utils.toIsoDate(today);
      
      // åªå…è®¸åŒæ­¥ä»Šå¤©æˆ–æ˜¨å¤©çš„æ•°æ®ï¼ˆè€ƒè™‘æ—¶åŒºå’Œå»¶è¿Ÿæƒ…å†µï¼‰
      const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
      const yesterdayISO = utils.toIsoDate(yesterday);
      
      return dateString === todayISO || dateString === yesterdayISO;
    }

    async function syncTodayLeaderboard(targetDate = null) {
      try {
        if (!supabaseClient) {
          console.warn('Supabase æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŒæ­¥æ’è¡Œæ¦œ');
          return false;
        }

        const activeDate = targetDate || getActiveLeaderboardDate();
        if (!isWorkday(activeDate)) {
          console.log('å‘¨æœ«ä¸åŒæ­¥æ’è¡Œæ¦œ');
          return true;
        }

        const iso = utils.toIsoDate(activeDate);
        
        // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿åªåŒæ­¥å…è®¸çš„æ—¥æœŸ
        if (!isSafeDateForSync(iso)) {
          console.warn(`ğŸš« å®‰å…¨é™åˆ¶ï¼šåªèƒ½åŒæ­¥ä»Šå¤©æˆ–æ˜¨å¤©çš„æ•°æ®ï¼Œæ‹’ç»åŒæ­¥æ—¥æœŸ ${iso}`);
          return false;
        }
        
        console.log(`å¼€å§‹åŒæ­¥æ—¥æœŸ ${iso} çš„æ’è¡Œæ¦œæ•°æ®...`);
        const dayStartMs = toDayStart(activeDate);
        const weekday0to6 = activeDate.getDay();
        
        // è·å–æ‰€æœ‰æœ‰æ—¶é—´è¡¨çš„å­¦ç”Ÿ
        const allStudents = Array.from(appState.students.values());
        if (!allStudents.length) {
          console.warn('æ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼Œè·³è¿‡åŒæ­¥');
          return false;
        }

        const rows = [];
        const validScores = [];

        // ä¸ºæ¯ä¸ªå­¦ç”Ÿè®¡ç®—åˆ†æ•°
        for (const student of allStudents) {
          try {
            const key = utils.normalizeStudentName(student.name);
            const slotsMin = getLeaderboardSlotsMinutes(student.name, activeDate);
            const intervalsMs = getLeaderboardPracticeIntervalsMs(student.name, activeDate);

            if (!intervalsMs || intervalsMs.length === 0) {
              // å½“å¤©æ— ç»ƒç´ï¼šå†™å…¥ no_practice æ ‡è®°
              rows.push({
                date: iso,
                student_key: key,
                d1: 0,
                d2: 0,
                d3: 0,
                total: 0,
                rule_version: RULE_VERSION,
                window: __leaderboardWindowJSON(weekday0to6),
                no_practice: true,
                updated_at: new Date().toISOString()
              });
              continue;
            }

            // è®¡ç®—å„ç»´åº¦åˆ†æ•°
            const d1 = computeDim1Score(slotsMin, intervalsMs, dayStartMs);
            const d2 = computeDim2Score(slotsMin, intervalsMs, dayStartMs, weekday0to6);
            const d3 = await computeDim3ScoreCloud(key, activeDate, d1.score + d2.score);
            let totalScoreRaw = d1.score + d2.score + d3.score;
            if (d1.breakdown && d1.breakdown.gotFullBonus) {
              totalScoreRaw += (d1.breakdown.fullBonusAward || 0); // åŠ¨æ€æ»¡å‹¤åŠ åˆ†
            }
            const totalScore = +(Math.max(0, Math.min(100, totalScoreRaw))).toFixed(2);

            const row = {
              date: iso,
              student_key: key,
              d1: d1.score || 0,
              d2: d2.score || 0,
              d3: d3.score || 0,
              total: totalScore,
              rule_version: RULE_VERSION,
              window: __leaderboardWindowJSON(weekday0to6),
              no_practice: false,
              updated_at: new Date().toISOString()
            };

            rows.push(row);
            if (totalScore > 0) validScores.push(row);
          } catch (e) {
            console.error(`è®¡ç®—å­¦ç”Ÿ ${student.name} åˆ†æ•°å¤±è´¥:`, e);
          }
        }

        // è®¡ç®—æ’åï¼ˆä»… total > 0 çš„å‚ä¸æ’åï¼‰
        validScores.sort((a, b) => b.total - a.total);
        let rank = 1;
        for (let i = 0; i < validScores.length; i++) {
          if (i > 0 && validScores[i].total < validScores[i - 1].total) {
            rank = i + 1;
          }
          validScores[i].rank = rank;
        }

        // å°†æ’åå†™å›æ‰€æœ‰è¡Œ
        const keyToRank = new Map(validScores.map(r => [r.student_key, r.rank]));
        rows.forEach(r => {
          if (keyToRank.has(r.student_key)) {
            r.rank = keyToRank.get(r.student_key);
          }
        });

        // æ‰¹é‡åŒæ­¥åˆ°æ•°æ®åº“ï¼ˆå¸¦å®‰å…¨æ£€æŸ¥ï¼‰
        const BATCH = 200;
        let successCount = 0;
        
        // äºŒæ¬¡å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ‰€æœ‰è®°å½•éƒ½æ˜¯æŒ‡å®šæ—¥æœŸ
        const filteredRows = rows.filter(row => {
          if (row.date !== iso) {
            console.error(`å®‰å…¨è­¦å‘Šï¼šå‘ç°å¼‚å¸¸æ—¥æœŸè®°å½• ${row.date}ï¼Œé¢„æœŸ ${iso}ï¼Œå·²è¿‡æ»¤`);
            return false;
          }
          return true;
        });
        
        if (filteredRows.length !== rows.length) {
          console.warn(`è¿‡æ»¤äº† ${rows.length - filteredRows.length} æ¡å¼‚å¸¸æ—¥æœŸè®°å½•`);
        }
        
        for (let i = 0; i < filteredRows.length; i += BATCH) {
          const slice = filteredRows.slice(i, i + BATCH);
          
          // ä½¿ç”¨æ›´å®‰å…¨çš„ upsertï¼šæ˜ç¡®æŒ‡å®šå†²çªè§£å†³å’Œçº¦æŸæ¡ä»¶
          const { error } = await supabaseClient
            .from('leaderboard_daily')
            .upsert(slice, { 
              onConflict: 'date,student_key',
              ignoreDuplicates: false // ç¡®ä¿æ›´æ–°ç°æœ‰è®°å½•è€Œä¸æ˜¯å¿½ç•¥
            });
          
          if (error) {
            console.error(`åŒæ­¥æ’è¡Œæ¦œå¤±è´¥ (æ‰¹æ¬¡ ${Math.floor(i/BATCH) + 1}):`, error);
          } else {
            successCount += slice.length;
          }
        }

        const syncSummary = {
          date: iso,
          totalRecords: filteredRows.length,
          successCount,
          failedCount: filteredRows.length - successCount,
          validRankings: validScores.length,
          timestamp: new Date().toISOString()
        };
        
        console.log(`âœ… ${iso} æ’è¡Œæ¦œåŒæ­¥å®Œæˆ:`, syncSummary);
        console.log(`ğŸ“Š æ•°æ®è¯¦æƒ…: ${successCount}/${filteredRows.length} æ¡è®°å½•æˆåŠŸ, ${validScores.length} äººæœ‰æ•ˆæ’å`);
        
        // è®°å½•åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
        try {
          // å®‰å…¨å†™å…¥ï¼šQuotaExceededError æ—¶è‡ªåŠ¨è£å‰ªå¹¶é™çº§
          function safeSetSyncLog(summary){
            let logArr = [];
            try { logArr = JSON.parse(localStorage.getItem('leaderboard_sync_log')||'[]'); } catch { logArr = []; }
            logArr.push(summary);
            // åªç•™æœ€è¿‘ 14 æ¡ï¼ˆæ—¶é—´è·¨åº¦ä»é™å®š 7 å¤©ï¼‰
            const cutoff = Date.now() - 7*24*60*60*1000;
            logArr = logArr.filter(x => { const t=Date.parse(x.timestamp||''); return !isNaN(t) && t>cutoff; });
            if (logArr.length>14) logArr = logArr.slice(logArr.length-14);
            const data = JSON.stringify(logArr);
            try {
              localStorage.setItem('leaderboard_sync_log', data);
            } catch(err){
              if (err && err.name === 'QuotaExceededError') {
                // å°è¯•å†å‹ç¼©ï¼šä¸¢å¼ƒæœ€æ—§ 50% å†å†™ä¸€æ¬¡
                logArr = logArr.slice(Math.floor(logArr.length/2));
                try { localStorage.setItem('leaderboard_sync_log', JSON.stringify(logArr)); }
                catch(inner){ console.warn('åŒæ­¥æ—¥å¿—è®°å½•å¤±è´¥(äºŒæ¬¡):', inner); }
              } else {
                console.warn('åŒæ­¥æ—¥å¿—è®°å½•å¤±è´¥(å†™å…¥):', err);
              }
            }
          }
          safeSetSyncLog(syncSummary);
        } catch (e) {
          console.warn('åŒæ­¥æ—¥å¿—è®°å½•å¤±è´¥:', e);
        }
        
        return true;
      } catch (e) {
        console.error('åŒæ­¥å½“æ—¥æ’è¡Œæ¦œå¤±è´¥:', e);
        return false;
      }
    }

    // æ‰‹åŠ¨åŒæ­¥ä»Šæ—¥æ’è¡Œæ¦œ
    async function manualSyncTodayLeaderboard() {
      try {
        if (!ENABLE_MANUAL_SYNC) {
          console.warn('æ‰‹åŠ¨åŒæ­¥å·²è¢«ç¦ç”¨ï¼ˆENABLE_MANUAL_SYNC=falseï¼‰');
          try { showToast('æ‰‹åŠ¨åŒæ­¥å·²ç¦ç”¨'); } catch {}
          return;
        }
        const activeDate = getActiveLeaderboardDate();
        const iso = utils.toIsoDate(activeDate);
        
        // ç¡®è®¤åŒæ­¥çš„æ˜¯ä»Šå¤©çš„æ•°æ®
        const confirmed = confirm(`ç¡®è®¤åŒæ­¥ ${iso} çš„æ’è¡Œæ¦œæ•°æ®åˆ°äº‘ç«¯ï¼Ÿ\n\næ³¨æ„ï¼šè¿™åªä¼šå½±å“æŒ‡å®šæ—¥æœŸçš„æ•°æ®ï¼Œä¸ä¼šä¿®æ”¹å†å²è®°å½•ã€‚`);
        if (!confirmed) {
          showToast('åŒæ­¥å·²å–æ¶ˆ');
          return;
        }
        
        showToast('å¼€å§‹åŒæ­¥ä»Šæ—¥æ’è¡Œæ¦œ...');
        const success = await syncTodayLeaderboard();
        if (success) {
          showToast(`${iso} æ’è¡Œæ¦œåŒæ­¥æˆåŠŸï¼`);
        } else {
          showToast('ä»Šæ—¥æ’è¡Œæ¦œåŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
        }
      } catch (e) {
        showToast('åŒæ­¥å¤±è´¥: ' + (e?.message || e));
        console.error('æ‰‹åŠ¨åŒæ­¥å¤±è´¥:', e);
      }
    }

    // å®šæ—¶åŒæ­¥æœºåˆ¶ä¼˜åŒ–
    let dailySyncTimer = null;
    let syncRetryCount = 0;
    const MAX_SYNC_RETRIES = 3;

    function startDailySyncScheduler() {
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (dailySyncTimer) {
        clearTimeout(dailySyncTimer);
        dailySyncTimer = null;
      }

      function scheduleNextSync() {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        // ä¼˜åŒ–ï¼šåªåœ¨å·¥ä½œæ—¥è¿›è¡Œè‡ªåŠ¨åŒæ­¥ï¼Œä¸”æ£€æŸ¥é¡µé¢æ´»è·ƒåº¦
        const isWorkday = now.getDay() >= 1 && now.getDay() <= 5;
        
        // è®¾ç½®æ¯å¤©æ™šä¸Š 22:00 è‡ªåŠ¨åŒæ­¥
        const syncTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 22, 0, 0);
        
        // å¦‚æœå½“å‰æ—¶é—´å·²ç»è¿‡äº†ä»Šå¤©çš„åŒæ­¥æ—¶é—´ï¼Œåˆ™å®‰æ’æ˜å¤©çš„åŒæ­¥
        if (now >= syncTime) {
          syncTime.setDate(syncTime.getDate() + 1);
        }
        
        // å¦‚æœæ˜¯å‘¨æœ«ï¼Œè·³åˆ°ä¸‹å‘¨ä¸€
        while (syncTime.getDay() === 0 || syncTime.getDay() === 6) {
          syncTime.setDate(syncTime.getDate() + 1);
        }

        const msUntilSync = syncTime.getTime() - now.getTime();
        console.log(`ä¸‹æ¬¡è‡ªåŠ¨åŒæ­¥: ${syncTime.toLocaleString()}, è·ç¦» ${Math.round(msUntilSync / 1000 / 60)} åˆ†é’Ÿ${!isWorkday ? ' (è·³è¿‡å‘¨æœ«)' : ''}`);

        dailySyncTimer = setTimeout(async () => {
          // æ£€æŸ¥é¡µé¢æ˜¯å¦æ´»è·ƒå’Œç½‘ç»œçŠ¶æ€
          if (!navigator.onLine) {
            console.log('ç½‘ç»œç¦»çº¿ï¼Œå»¶è¿ŸåŒæ­¥');
            setTimeout(() => scheduleNextSync(), 300000); // 5åˆ†é’Ÿåé‡è¯•
            return;
          }
          
          // é¡µé¢é•¿æ—¶é—´éšè—æ—¶è·³è¿‡åŒæ­¥
          if (!isPageVisible && (Date.now() - lastVisibilityChange) > 3600000) { // 1å°æ—¶
            console.log('é¡µé¢é•¿æ—¶é—´éšè—ï¼Œè·³è¿‡åŒæ­¥');
            scheduleNextSync();
            return;
          }
          
          try {
            const syncDate = new Date();
            const iso = utils.toIsoDate(syncDate);
            console.log(`å¼€å§‹å®šæ—¶åŒæ­¥ ${iso} æ’è¡Œæ¦œ...`);
            
            const success = await syncTodayLeaderboard();
            console.log(`å®šæ—¶åŒæ­¥ ${iso} ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
            
            if (success) {
              console.log(`âœ… ${iso} æ’è¡Œæ¦œå·²æˆåŠŸå¤‡ä»½åˆ°äº‘ç«¯`);
              syncRetryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
            } else {
              throw new Error('åŒæ­¥è¿”å›å¤±è´¥çŠ¶æ€');
            }
          } catch (e) {
            console.error('å®šæ—¶åŒæ­¥å‡ºé”™:', e);
            syncRetryCount++;
            
            // å¤±è´¥é‡è¯•æœºåˆ¶
            if (syncRetryCount <= MAX_SYNC_RETRIES) {
              const retryDelay = 300000 * syncRetryCount; // 5åˆ†é’Ÿ * é‡è¯•æ¬¡æ•°
              console.log(`åŒæ­¥å¤±è´¥ï¼Œ${retryDelay/60000}åˆ†é’Ÿåé‡è¯• (${syncRetryCount}/${MAX_SYNC_RETRIES})`);
              setTimeout(() => scheduleNextSync(), retryDelay);
              return;
            } else {
              console.error('åŒæ­¥é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œæ”¾å¼ƒæœ¬æ¬¡åŒæ­¥');
              syncRetryCount = 0;
            }
          }
          
          // å®‰æ’ä¸‹ä¸€æ¬¡åŒæ­¥
          scheduleNextSync();
        }, msUntilSync);
      }

      scheduleNextSync();
    }

    // åœæ­¢å®šæ—¶åŒæ­¥
    function stopDailySyncScheduler() {
      if (dailySyncTimer) {
        clearTimeout(dailySyncTimer);
        dailySyncTimer = null;
        console.log('å®šæ—¶åŒæ­¥å·²åœæ­¢');
      }
    }

    // æŸ¥çœ‹åŒæ­¥å†å²ï¼ˆè°ƒè¯•ç”¨ï¼‰
    function getSyncHistory() {
      try {
        const syncLog = JSON.parse(localStorage.getItem('leaderboard_sync_log') || '[]');
        console.table(syncLog);
        return syncLog;
      } catch (e) {
        console.error('è·å–åŒæ­¥å†å²å¤±è´¥:', e);
        return [];
      }
    }

    // æ¸…é™¤åŒæ­¥å†å²
    function clearSyncHistory() {
      try {
        localStorage.removeItem('leaderboard_sync_log');
        console.log('åŒæ­¥å†å²å·²æ¸…é™¤');
        return true;
      } catch (e) {
        console.error('æ¸…é™¤åŒæ­¥å†å²å¤±è´¥:', e);
        return false;
      }
    }

  // ========== Admin æŒ‰é’®ç§»é™¤ ==========
  // æŒ‰éœ€æ±‚ç§»é™¤â€œé‡ç®—å†å²442â€å’Œâ€œåŒæ­¥ä»Šæ—¥â€ä¸¤ä¸ªæµ®åŠ¨æŒ‰é’®ï¼Œä¸å†æ³¨å…¥ä»»ä½•ç®¡ç†ç«¯æŒ‰é’®ã€‚
  // ä¿ç•™ recalcAllLeaderboardHistory442 ä¸ syncTodayLeaderboard ä¾›åå°/å¼€å‘è€…æ‰‹åŠ¨è°ƒç”¨ã€‚

    async function recalcAllLeaderboardHistory442(){
      const startedAt = Date.now();
      
      // ğŸ›¡ï¸ å‘¨æœ«ä¿æŠ¤ï¼šç¦æ­¢åœ¨å‘¨å…­/å‘¨æ—¥é‡ç®—å†å²æ•°æ®
      const now = new Date();
      const currentDayOfWeek = now.getDay();
      
      if (currentDayOfWeek === 0 || currentDayOfWeek === 6) {
        const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        console.error('[å‘¨æœ«ä¿æŠ¤] å‘¨æœ«ç¦æ­¢é‡ç®—å†å²æ’è¡Œæ¦œæ•°æ®', {
          currentTime: now.toISOString(),
          currentDay: dayNames[currentDayOfWeek],
          reason: 'å‘¨æœ«ä¸æ”¯æŒæ’è¡Œæ¦œæ“ä½œ'
        });
        try {
          showToast(`âŒ å‘¨æœ«ï¼ˆ${dayNames[currentDayOfWeek]}ï¼‰ä¸æ”¯æŒé‡ç®—å†å²æ•°æ®`);
        } catch {}
        return;
      }
      
      try{ showToast('å¼€å§‹é‡ç®—å†å² 4-4-2â€¦'); }catch{}
      if(!supabaseClient){
        throw new Error('Supabase æœªåˆå§‹åŒ–ï¼Œæ— æ³•å†™å› leaderboard_daily');
      }

      // 1) å–â€œå·²æœ‰æ•°æ®å†å²â€çš„æ—¥æœŸé›†åˆï¼šæ¥è‡ª leaderboard_daily
      let dates = await __fetchAllLeaderboardDates(supabaseClient);
      // å›é€€ï¼šè‹¥ leaderboard_daily ä¸ºç©ºï¼Œåˆ™ä» practice_logs æå–å†å²æ—¥æœŸé›†åˆ
      if(!dates.length){
        dates = await __fetchAllDatesFromPracticeLogs(supabaseClient);
        if(!dates.length){ throw new Error('practice_logs ä¸­ä¹Ÿæ²¡æœ‰å¯é‡ç®—çš„æ—¥æœŸ'); }
      }

      // 2) å­¦ç”Ÿé”®é›†åˆï¼šæ¥è‡ª leaderboard_daily ç°æœ‰é”®æˆ–æœ¬åœ° timeSlots
      let studentKeys = await __fetchAllLeaderboardStudentKeys(supabaseClient);
      if(!studentKeys.length){
        try{ studentKeys = Array.from(appState.timeSlots.keys()); }catch{}
      }
      // å›é€€ï¼šä»ä¸ºç©ºåˆ™ä» practice_logs æå–å­¦ç”Ÿé›†åˆ
      if(!studentKeys.length){
        studentKeys = await __fetchAllStudentKeysFromPracticeLogs(supabaseClient);
      }
      if(!studentKeys.length){ throw new Error('æœªæ‰¾åˆ°ä»»ä½• student_key'); }

      // é¢„å–æ¯ä¸ªæ—¥æœŸçš„â€œæ˜¨æ—¥æ’è¡Œæ˜ å°„â€ï¼ˆä¾› D3 ä½¿ç”¨ï¼‰
      const rankCache = new Map(); // isoDate -> Map(student_key -> rank)
      for(const d of dates){
        const prev = previousWorkday(new Date(d));
        const map = await __fetchRankMapForDate(supabaseClient, utils.toIsoDate(prev));
        if(map) rankCache.set(utils.toIsoDate(prev), map);
      }

      // d12 ç¼“å­˜ï¼šisoDate -> Map(student_key -> d1+d2)
      const d12Cache = new Map();

      // ä¸»å¾ªç¯ï¼šé€æ—¥é‡ç®—
      const BATCH = 200;
      let total = 0, failed = 0;
      for(let i=0;i<dates.length;i++){
        const iso = dates[i];
        const date = new Date(iso+'T00:00:00');
        if(!isWorkday(date)) { // å‘¨æœ«ç›´æ¥è·³è¿‡ï¼ˆæ— æ’è¡Œæ¦œçª—å£ï¼‰
          continue;
        }
        const dayStartMs = toDayStart(date);
        const weekday0to6 = date.getDay();
        const prevKey = utils.toIsoDate(previousWorkday(date));
        let prevMap = rankCache.get(prevKey) || await __fetchRankMapForDate(supabaseClient, prevKey) || null;
        if(!prevMap || prevMap.size === 0){
          // ç”¨ d12 ç¼“å­˜æ„é€ å‰ä¸€å·¥ä½œæ—¥çš„åæ¬¡æ˜ å°„ï¼ˆå½“ leaderboard_daily å°šæœªæœ‰å†å²æ—¶ï¼‰
          prevMap = __buildRankMapFromD12(prevKey, d12Cache, studentKeys);
        }

        // ä¸ºå½“æ—¥ä¸€æ¬¡æ€§æ‹‰å–å…¨ä½“ç»ƒç´æ—¥å¿—å¹¶æ„å»ºæ¯äººåŒºé—´ï¼ˆé¿å…é€äººæŸ¥è¯¢ï¼‰
        const intervalsByStudent = await __fetchPracticeIntervalsByStudentForDate(supabaseClient, date);

        // å‡†å¤‡å½“æ—¥ d12 ç¼“å­˜å®¹å™¨
        if(!d12Cache.has(iso)) d12Cache.set(iso, new Map());
        const d12TodayMap = d12Cache.get(iso);

        const rows = [];
        const studentKeysNorm = studentKeys.map(k=>utils.normalizeStudentName(k));
        for(let idx=0; idx<studentKeys.length; idx++){
          const key = studentKeys[idx];
          try{
            const name = utils.normalizeStudentName(key);
            const slotsMin = getLeaderboardSlotsMinutes(name, date);
            // å†å²é‡ç®—ï¼šä¼˜å…ˆä½¿ç”¨æ•°æ®åº“æ—¥å¿—æ„å»ºçš„åŒºé—´
            const intervalsMs = intervalsByStudent.get(name) || [];
            if(!intervalsMs.length){
              // å½“å¤©æ— ç»ƒç´ï¼šå†™å…¥ no_practice æ ‡è®°ä¸ 0 åˆ†
              rows.push({ date: iso, student_key: key, d1: 0, d2: 0, d3: 0, total: 0, rule_version: RULE_VERSION, window: __leaderboardWindowJSON(weekday0to6), no_practice: true, updated_at: new Date().toISOString() });
              continue;
            }
            const d1res = computeDim1Score(slotsMin, intervalsMs, dayStartMs);
            const d1 = d1res.score || 0;
            const d2 = computeDim2Score(slotsMin, intervalsMs, dayStartMs, weekday0to6).score || 0;
            // æ›´æ–° d12 ç¼“å­˜ï¼ˆä¾› D3 å†å²çª—å£ã€åéœ¸æ¦œè®¡ç®—ä½¿ç”¨ï¼‰
            d12TodayMap.set(name, (d1 + d2));
            // å†å² D3ï¼šåŸºäº d12 ç¼“å­˜è®¡ç®—ï¼ˆä¸ä¾èµ– appState.practiceLogsï¼‰
            const d3 = __computeDim3Historical(name, date, d1 + d2, prevMap || new Map(), d12Cache, studentKeysNorm).score || 0;
            let totalScoreRaw = d1 + d2 + d3;
            if (d1res.breakdown && d1res.breakdown.gotFullBonus) {
              totalScoreRaw += (d1res.breakdown.fullBonusAward || 0);
            }
            const totalScore = +(Math.max(0, Math.min(100, totalScoreRaw))).toFixed(2);
            rows.push({
              date: iso, student_key: key,
              d1, d2, d3, total: totalScore,
              rule_version: RULE_VERSION,
              window: __leaderboardWindowJSON(weekday0to6),
              no_practice: false,
              updated_at: new Date().toISOString()
            });
          }catch(e){ failed++; }
        }

        // è®¡ç®—å½“æ—¥æ’åï¼ˆä»… total > 0 çš„è¡Œå‚ä¸æ’åï¼›å¹¶åˆ—åŒåæ¬¡ï¼‰
        const withScore = rows.filter(r => (r.total ?? 0) > 0).sort((a,b)=> (b.total - a.total));
        let rank = 1;
        for(let j=0;j<withScore.length;j++){
          if(j>0 && withScore[j].total < withScore[j-1].total) rank = j+1;
          withScore[j].rank = rank;
        }
        // å°†è®¡ç®—å‡ºçš„ rank å†™å› rows ä¸­å¯¹åº”é¡¹
        const keyToRank = new Map(withScore.map(r=>[`${r.student_key}`, r.rank]));
        rows.forEach(r => { 
          if(keyToRank.has(`${r.student_key}`)) {
            r.rank = keyToRank.get(`${r.student_key}`);
          } else {
            // æ— ç»ƒç´æˆ–0åˆ†å­¦ç”Ÿï¼šæ˜ç¡®æ ‡è®° rank ä¸º nullï¼ˆä¸å‚ä¸æ’åï¼‰
            r.rank = null;
          }
        });

        // ğŸ”’ å†™åº“ä¿æŠ¤ï¼šæ‰¹é‡ upsert å‰éªŒè¯æ—¥æœŸåˆæ³•æ€§
        if (!window.__dataProtectionSystem.canWriteLeaderboardDaily(iso, 'historical-sync')) {
          console.error('[å†™åº“ä¿æŠ¤] æ‹’ç»å†å²åŒæ­¥æ“ä½œå†™å…¥ leaderboard_daily', { targetDate: iso });
          continue; // è·³è¿‡æ­¤æ—¥æœŸçš„å†™å…¥
        }
        
        // æ‰¹é‡ upsert åˆ° leaderboard_daily
        for(let p=0;p<rows.length;p+=BATCH){
          const slice = rows.slice(p, p+BATCH);
          const { error } = await supabaseClient.from('leaderboard_daily').upsert(slice, { onConflict: 'date,student_key' });
          if(error){ failed += slice.length; console.error('upsert error', iso, error); }
          else total += slice.length;
        }
        try{ showToast(`${iso} å®Œæˆï¼šæœ‰ç»ƒç´ ${withScore.length} äºº Â· æœ¬æ—¥å†™å…¥ ${rows.length} æ¡ Â· ç´¯è®¡ ${total} Â· é”™è¯¯ ${failed}`); }catch{}
      }
      const secs = ((Date.now()-startedAt)/1000).toFixed(1);
      try{ showToast(`å®Œæˆï¼š${total} æ¡ï¼Œé”™è¯¯ ${failed}ï¼Œè€—æ—¶ ${secs}s`); }catch{}
    }

    // ===== è·å–å­¦ç”Ÿ442è¯„åˆ†å†å²æ•°æ® =====
    async function fetchStudent442History(studentKey, days = 14) {
      if (!supabaseClient) {
        console.warn('Supabase æœªåˆå§‹åŒ–ï¼Œæ— æ³•è·å–å†å²æ•°æ®');
        return [];
      }
      
      try {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - days);
        
        const startISO = utils.toIsoDate(startDate);
        const endISO = utils.toIsoDate(endDate);
        
        const { data, error } = await supabaseClient
          .from('leaderboard_daily')
          .select('date, d1, d2, d3, total, rank, no_practice')
          .eq('student_key', studentKey)
          .gte('date', startISO)
          .lte('date', endISO)
          .order('date', { ascending: true });
          
        if (error) {
          console.error('è·å–å­¦ç”Ÿå†å²æ•°æ®å¤±è´¥:', error);
          return [];
        }
        
        return data || [];
      } catch (e) {
        console.error('fetchStudent442History å¼‚å¸¸:', e);
        return [];
      }
    }

    // ===== æ¸²æŸ“442è¯„åˆ†è¶‹åŠ¿å›¾ =====
  async function render442TrendChart(containerSelector, studentName) {
      const container = document.querySelector(containerSelector);
      if (!container) {
        console.warn('è¶‹åŠ¿å›¾å®¹å™¨æœªæ‰¾åˆ°:', containerSelector);
        return;
      }

      try {
        // è·å–å†å²æ•°æ®
        const studentKey = utils.normalizeStudentName(studentName);
        const historyData = await fetchStudent442History(studentKey, 14);
        
        // è·å–å½“å¤©å®æ—¶æ•°æ®ï¼ˆä½¿ç”¨æ’è¡Œæ¦œçª—å£æœŸé€»è¾‘ï¼‰
        const today = getActiveLeaderboardDate();
        const todayISO = utils.toIsoDate(today);
        let todayScore = null;
        
        if (isWorkday(today)) {
          const student = appState.students.get(studentName);
          if (student) {
            const scoreResult = await computeScore442(student);
            if (scoreResult && scoreResult.total !== null) {
              todayScore = {
                date: todayISO,
                total: scoreResult.total,
                d1: scoreResult.d1,
                d2: scoreResult.d2,
                d3: scoreResult.d3,
                isToday: true
              };
            }
          }
        }

        // åˆå¹¶å†å²æ•°æ®å’Œå½“å¤©æ•°æ®
        const allData = [...historyData];
        if (todayScore && !historyData.some(d => d.date === todayISO)) {
          allData.push(todayScore);
        }

        // è¿‡æ»¤æ‰å‘¨æœ«å’Œæ— ç»ƒç´çš„æ•°æ®ï¼Œå¹¶è§„èŒƒæ•°å€¼ç±»å‹
        const validData = allData.filter(d => {
          const date = new Date(d.date);
          return isWorkday(date) && !d.no_practice && d.total > 0;
        }).map(d => ({
          date: d.date,
          total: Number(d.total),
          rank: d.rank,
          isToday: !!d.isToday
        }));

        if (validData.length === 0) {
          container.innerHTML = '<div class="trend-empty">æš‚æ— æœ‰æ•ˆçš„è¯„åˆ†æ•°æ®</div>';
          return;
        }

        // ç»˜åˆ¶å›¾è¡¨
        renderTrendSVG(container, validData);
        
      } catch (e) {
        console.error('æ¸²æŸ“442è¶‹åŠ¿å›¾å¤±è´¥:', e);
        container.innerHTML = '<div class="trend-empty">æ•°æ®åŠ è½½å¤±è´¥</div>';
      }
    }

    // ===== SVGè¶‹åŠ¿å›¾ç»˜åˆ¶ =====
    function renderTrendSVG(container, data) {
      const containerWidth = container.clientWidth || container.getBoundingClientRect().width || 600;
      const height = 200;
      const margin = { top: 20, right: 20, bottom: 40, left: 40 };
      // åŠ¨æ€å®½åº¦ï¼šè®©ç‚¹ä¸ç‚¹ä¹‹é—´æ›´å¤§é—´è·
      const MIN_GAP = 54; // æ¯ä¸ªç‚¹çš„æœ€å°æ°´å¹³é—´è·ï¼ˆåƒç´ ï¼‰
      const desiredWidth = data.length > 1 
        ? Math.max(containerWidth, margin.left + margin.right + (data.length - 1) * MIN_GAP)
        : containerWidth;
      const width = desiredWidth;
      const chartWidth = width - margin.left - margin.right;
      const chartHeight = height - margin.top - margin.bottom;
      const parseISODate = (s) => new Date(`${s}T00:00:00`);

      // åˆ›å»ºSVG
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', 'trend-chart');
      svg.setAttribute('width', width);
      svg.setAttribute('height', height);
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

      // æ•°æ®å¤„ç† - ä¿®å¤å•ç‚¹æ•°æ®çš„èŒƒå›´è®¡ç®—
  const scores = data.map(d => d.total).filter(Number.isFinite);
  const maxScore = Math.max(...scores, 100);
  let minScore = Math.max(Math.min(...scores) - 5, 0);
  let scoreRange = maxScore - minScore;
  
  // å¤„ç†å•ç‚¹æ•°æ®æˆ–æ‰€æœ‰æ•°æ®ç›¸åŒçš„æƒ…å†µ
  if (scoreRange === 0 || data.length === 1) {
    const centerScore = scores[0] || 50;
    minScore = Math.max(centerScore - 10, 0);
    scoreRange = Math.min(centerScore + 10, 100) - minScore;
    if (scoreRange === 0) scoreRange = 20; // æœ€å°èŒƒå›´
  }

      // åæ ‡è®¡ç®—å‡½æ•° - ä¿®å¤å•ç‚¹æ•°æ®çš„è¾¹ç•Œé—®é¢˜
      const getX = (index) => {
        if (data.length === 1) {
          // å•ä¸ªæ•°æ®ç‚¹æ—¶ï¼Œå±…ä¸­æ˜¾ç¤º
          return margin.left + chartWidth / 2;
        }
        return margin.left + (index / (data.length - 1)) * chartWidth;
      };
      const getY = (score) => {
        if (scoreRange === 0) {
          // å•ä¸ªæ•°æ®ç‚¹ä¸”æ— å˜åŒ–æ—¶ï¼Œå±…ä¸­æ˜¾ç¤º
          return margin.top + chartHeight / 2;
        }
        return margin.top + (1 - (score - minScore) / scoreRange) * chartHeight;
      };

      // ç»˜åˆ¶ç½‘æ ¼çº¿
      const gridGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      for (let i = 0; i <= 4; i++) {
        const y = margin.top + (i / 4) * chartHeight;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('class', 'trend-grid-line');
        line.setAttribute('x1', margin.left);
        line.setAttribute('y1', y);
        line.setAttribute('x2', margin.left + chartWidth);
        line.setAttribute('y2', y);
        gridGroup.appendChild(line);

        // Yè½´æ ‡ç­¾
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('class', 'trend-value-label');
        label.setAttribute('x', margin.left - 5);
        label.setAttribute('y', y);
        label.setAttribute('text-anchor', 'end');
        label.setAttribute('dominant-baseline', 'middle');
        const labelValue = minScore + (4-i) * scoreRange / 4;
        label.textContent = Math.round(labelValue).toString();
        gridGroup.appendChild(label);
      }
      svg.appendChild(gridGroup);

      // ç»˜åˆ¶åæ ‡è½´
      const axisGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      xAxis.setAttribute('class', 'trend-axis');
      xAxis.setAttribute('x1', margin.left);
      xAxis.setAttribute('y1', margin.top + chartHeight);
      xAxis.setAttribute('x2', margin.left + chartWidth);
      xAxis.setAttribute('y2', margin.top + chartHeight);
      axisGroup.appendChild(xAxis);

      const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      yAxis.setAttribute('class', 'trend-axis');
      yAxis.setAttribute('x1', margin.left);
      yAxis.setAttribute('y1', margin.top);
      yAxis.setAttribute('x2', margin.left);
      yAxis.setAttribute('y2', margin.top + chartHeight);
      axisGroup.appendChild(yAxis);
      svg.appendChild(axisGroup);

      // ç»˜åˆ¶è¶‹åŠ¿çº¿
      if (data.length > 1) {
        const pathData = data.map((d, i) => {
          const x = getX(i);
          const y = getY(d.total);
          return i === 0 ? `M ${x} ${y}` : `L ${x} ${y}`;
        }).join(' ');

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('class', 'trend-line');
        path.setAttribute('d', pathData);
        svg.appendChild(path);
      }

      // ç»˜åˆ¶æ•°æ®ç‚¹å’Œæ ‡ç­¾
      const pointsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      data.forEach((d, i) => {
        const x = getX(i);
        const y = getY(d.total);
        
        // æ•°æ®ç‚¹
        const point = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        point.setAttribute('class', `trend-point ${d.isToday ? 'today' : ''}`);
        point.setAttribute('cx', x);
        point.setAttribute('cy', y);
        point.setAttribute('r', d.isToday ? '5' : '4'); // ä»Šæ—¥æ•°æ®ç‚¹ç¨å¤§ä¸€äº›
        point.setAttribute('data-date', d.date);
        point.setAttribute('data-score', d.total.toFixed(1));
        
        // é¼ æ ‡äº‹ä»¶
        point.addEventListener('mouseenter', (e) => {
          showTrendTooltip(e, d);
          // æ”¾å¤§åœ†ç‚¹
          e.target.setAttribute('r', d.isToday ? '7' : '6');
        });
        point.addEventListener('mouseleave', (e) => {
          hideTrendTooltip(e);
          // æ¢å¤åœ†ç‚¹å¤§å°
          e.target.setAttribute('r', d.isToday ? '5' : '4');
        });
        
        pointsGroup.appendChild(point);
        
        // è°ƒè¯•ï¼šç¡®ä¿åœ†ç‚¹å·²åˆ›å»º
        dbg(`è¶‹åŠ¿å›¾æ•°æ®ç‚¹ ${i + 1}: ä½ç½®(${x.toFixed(1)}, ${y.toFixed(1)}), åŠå¾„=${point.getAttribute('r')}, åˆ†æ•°=${d.total}`);

        // è¿·ä½ æ ‡ç­¾ï¼šä¸Šä¸‹ä¸¤è¡Œï¼ˆåˆ†æ•° / åæ¬¡ï¼‰å¹¶è¿›è¡Œé¿çº¿ä¸è¾¹ç¼˜é˜²è£å‰ª
        const mini = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        mini.setAttribute('class', `trend-point-mini ${d.isToday ? 'today' : ''}`);
        // æ ¹æ®å±€éƒ¨æ–œç‡å†³å®šæ ‡ç­¾æ”¾åœ¨ç‚¹çš„ä¸Šæ–¹è¿˜æ˜¯ä¸‹æ–¹ï¼Œé¿å…è¢«è¶‹åŠ¿çº¿é®æŒ¡
        const prevY = (i > 0) ? getY(data[i-1].total) : null;
        const nextY = (i < data.length-1) ? getY(data[i+1].total) : null;
        // è®¡ç®—å±€éƒ¨å¹³å‡æ–œç‡ï¼ˆæ­£å€¼å‘ä¸‹èµ°ï¼‰
        const slope = (() => {
          const parts = [];
          if (prevY !== null) parts.push(y - prevY);
          if (nextY !== null) parts.push(nextY - y);
          if (!parts.length) return 0;
          return parts.reduce((a,b)=>a+b,0)/parts.length;
        })();
        // å½“çº¿å¾€ä¸‹èµ°ï¼ˆslope>0ï¼‰æ—¶å°†æ ‡ç­¾æ”¾åœ¨ç‚¹çš„ä¸Šæ–¹ï¼›å¾€ä¸Šèµ°åˆ™æ”¾åœ¨ä¸‹æ–¹
  const baseDy = slope > 0 ? -12 : 16; // ä¸‹æ–¹éœ€è¦æ›´å¤§é—´è·ç»™å‰¯æ ‡é¢˜
  
  // å¤„ç†å•ç‚¹æ•°æ®çš„ç‰¹æ®Šæƒ…å†µ
  let xClamped, textAnchor;
  if (data.length === 1) {
    // å•ä¸ªæ•°æ®ç‚¹æ—¶ï¼Œæ ‡ç­¾å±…ä¸­å¯¹é½
    xClamped = x;
    textAnchor = 'middle';
  } else {
    // å¤šç‚¹æ•°æ®æ—¶ï¼Œé¦–å°¾ç‚¹åšæ°´å¹³åç§»ï¼Œé¿å…ç¢°åˆ°å·¦å³è¾¹ç•Œ
    const edgePad = 10;
    xClamped = Math.max(margin.left + edgePad, Math.min(margin.left + chartWidth - edgePad, x));
    // å¯¹é¦–å°¾ç‚¹è®¾ç½®ä¸åŒå¯¹é½ï¼Œè¿›ä¸€æ­¥é¿å…è£å‰ª
    if (i === 0) textAnchor = 'start';
    else if (i === data.length - 1) textAnchor = 'end';
    else textAnchor = 'middle';
  }
  
  mini.setAttribute('text-anchor', textAnchor);
  
  const yRaw = y + baseDy;
  const yTop = margin.top + 10; // é¡¶éƒ¨ç•™ç™½
  const yBottom = margin.top + chartHeight - 14; // åº•éƒ¨ç•™ç™½ç»™ X è½´
  const yClamped = Math.max(yTop, Math.min(yBottom, yRaw));
  mini.setAttribute('x', xClamped);
  mini.setAttribute('y', yClamped);
        
        const t1 = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
        t1.setAttribute('x', xClamped);
        t1.setAttribute('dy', 0);
        t1.textContent = `${d.total.toFixed(0)}åˆ†`;
        mini.appendChild(t1);
        
        if (d.rank && Number(d.rank) > 0) {
          const t2 = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
          t2.setAttribute('class', 'sub');
          t2.setAttribute('x', xClamped);
          t2.setAttribute('dy', 11);
          t2.textContent = `No.${Number(d.rank)}`;
          mini.appendChild(t2);
        }
        pointsGroup.appendChild(mini);

        // Xè½´æ—¥æœŸæ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºéƒ¨åˆ†ï¼Œé¿å…æ‹¥æŒ¤ï¼‰
        if (data.length === 1 || i % Math.max(1, Math.floor(data.length / 6)) === 0 || i === data.length - 1) {
          const dateLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          dateLabel.setAttribute('class', 'trend-label');
          
          // å¤„ç†å•ç‚¹æ•°æ®çš„æ—¥æœŸæ ‡ç­¾ä½ç½®
          let xLabel;
          if (data.length === 1) {
            xLabel = x; // å•ç‚¹æ—¶å±…ä¸­æ˜¾ç¤º
            dateLabel.setAttribute('text-anchor', 'middle');
          } else {
            // å¤šç‚¹æ•°æ®æ—¶ï¼Œæ—¥æœŸæ ‡ç­¾åŒæ ·åšè¾¹ç¼˜é˜²è£å‰ª
            xLabel = Math.max(margin.left + 10, Math.min(margin.left + chartWidth - 10, x));
            if (i === 0) dateLabel.setAttribute('text-anchor', 'start');
            else if (i === data.length - 1) dateLabel.setAttribute('text-anchor', 'end');
            else dateLabel.setAttribute('text-anchor', 'middle');
          }
          
          dateLabel.setAttribute('x', xLabel);
          dateLabel.setAttribute('y', margin.top + chartHeight + 15);
          const dt = parseISODate(d.date);
          // ä½¿ç”¨åˆæ³•çš„æœ¬åœ°åŒ–æ ¼å¼é€‰é¡¹ï¼Œé¿å… RangeError
          const dateStr = dt.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
          dateLabel.textContent = dateStr.replace(/\//g, '/');
          pointsGroup.appendChild(dateLabel);
        }
      });
      svg.appendChild(pointsGroup);

      // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ SVG
      container.innerHTML = '';
      container.appendChild(svg);

      // åˆ›å»ºtooltip
      const tooltip = document.createElement('div');
      tooltip.className = 'trend-tooltip';
      container.appendChild(tooltip);
      container._tooltip = tooltip;
      
      // è°ƒè¯•ï¼šå›¾è¡¨æ¸²æŸ“å®Œæˆ
      dbg(`442è¶‹åŠ¿å›¾æ¸²æŸ“å®Œæˆ: ${data.length} ä¸ªæ•°æ®ç‚¹ï¼ŒSVGå°ºå¯¸ ${width}x${height}`);
      dbg('æ‰€æœ‰æ•°æ®ç‚¹:', data.map((d, i) => `${i+1}. ${d.date}: ${d.total}åˆ†${d.isToday ? ' (ä»Šæ—¥)' : ''}`));
    }

    // ===== è¶‹åŠ¿å›¾äº¤äº’ =====
    function showTrendTooltip(event, data) {
      const container = event.target.closest('.trend-container');
      if (!container || !container._tooltip) return;

      const tooltip = container._tooltip;
      const date = new Date(`${data.date}T00:00:00`).toLocaleDateString('zh-CN', { 
        month: 'long', 
        day: 'numeric',
        weekday: 'short'
      });
      
      tooltip.innerHTML = `
        <div><strong>${date}${data.isToday ? ' (ä»Šæ—¥)' : ''}</strong></div>
        <div>æ€»åˆ†: ${data.total.toFixed(1)}åˆ†</div>
        ${data.rank ? `<div>æ’å: ç¬¬${data.rank}å</div>` : ''}
      `;
      
      const rect = event.target.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();
      
      tooltip.style.left = `${rect.left - containerRect.left - tooltip.offsetWidth / 2}px`;
      tooltip.style.top = `${rect.top - containerRect.top - tooltip.offsetHeight - 8}px`;
      tooltip.classList.add('show');
    }

    function hideTrendTooltip(event) {
      const container = event.target.closest('.trend-container');
      if (!container || !container._tooltip) return;
      
      container._tooltip.classList.remove('show');
    }

    // ===== è¾…åŠ©ï¼šè¯»å–å†å²èŒƒå›´ä¸ rank =====
    async function __fetchAllLeaderboardDates(sb){
      const out = new Set();
      const page = 2000;
      for(let from=0; from<100000; from+=page){
        const to = from + page - 1;
        const { data, error } = await sb.from('leaderboard_daily').select('date').order('date', { ascending: true }).range(from, to);
        if(error) { console.warn('fetch dates error', error); break; }
        if(!data?.length) break;
        for(const r of data){ out.add(r.date); }
        if(data.length < page) break;
      }
      return Array.from(out).sort();
    }

    async function __fetchAllLeaderboardStudentKeys(sb){
      const out = new Set();
      const page = 2000;
      for(let from=0; from<100000; from+=page){
        const to = from + page - 1;
        const { data, error } = await sb.from('leaderboard_daily').select('student_key').order('student_key', { ascending: true }).range(from, to);
        if(error) { console.warn('fetch student keys error', error); break; }
        if(!data?.length) break;
        for(const r of data){ out.add(r.student_key); }
        if(data.length < page) break;
      }
      return Array.from(out).sort();
    }

    async function __fetchRankMapForDate(sb, isoDate){
      try{
        const { data, error } = await sb.from('leaderboard_daily').select('student_key, rank').eq('date', isoDate);
        if(error) return null;
        const m = new Map();
        for(const r of (data||[])){
          if(typeof r.rank === 'number') m.set(r.student_key, r.rank);
        }
        return m;
      }catch{ return null; }
    }

    // ===== è¾…åŠ©ï¼šå†å²é‡ç®—ä¸“ç”¨ï¼ˆä» DB æ‹‰å–æ—¥å¿—å¹¶æ„å»ºåŒºé—´ + å†å² D3ï¼‰ =====
    async function __fetchAllDatesFromPracticeLogs(sb){
      // æ‰«æ practice_logsï¼Œæå–æ—¥æœŸé›†åˆï¼ˆåˆ†é¡µä»¥é¿å…ä¸Šé™ï¼‰
      const out = new Set();
      const page = 2000;
      for(let from=0; from<100000; from+=page){
        const to = from + page - 1;
        const { data, error } = await sb
          .from('practice_logs')
          .select('timestamp')
          .order('timestamp', { ascending: true })
          .range(from, to);
        if(error){ console.warn('fetch practice_logs dates error', error); break; }
        if(!data?.length) break;
        for(const r of data){
          const d = new Date(r.timestamp);
          const iso = utils.toIsoDate(d);
          out.add(iso);
        }
        if(data.length < page) break;
      }
      // åªä¿ç•™å·¥ä½œæ—¥ï¼Œå¹¶æ’åº
      const arr = Array.from(out).sort();
      return arr.filter(iso => isWorkday(new Date(iso+'T00:00:00')));
    }

    async function __fetchAllStudentKeysFromPracticeLogs(sb){
      const out = new Set();
      const page = 2000;
      for(let from=0; from<100000; from+=page){
        const to = from + page - 1;
        const { data, error } = await sb
          .from('practice_logs')
          .select('student_name, student, studentName')
          .order('timestamp', { ascending: true })
          .range(from, to);
        if(error){ console.warn('fetch practice_logs students error', error); break; }
        if(!data?.length) break;
        for(const r of data){
          const nmRaw = r.student_name || r.student || r.studentName || '';
          const nm = utils.normalizeStudentName(nmRaw);
          if(nm) out.add(nm);
        }
        if(data.length < page) break;
      }
      return Array.from(out).sort();
    }

    function __buildRankMapFromD12(isoDate, d12Cache, studentKeys){
      const m = new Map();
      const d12Map = d12Cache.get(isoDate);
      if(!d12Map) return m;
      // æ ¹æ® d12 å€¼é™åºæ’åºå¹¶èµ‹æ’åï¼ˆåŒåˆ†å¹¶åˆ—å¤„ç†ï¼šç›¸åŒåˆ†å¯èµ‹ç›¸åŒ rankï¼Œä¹Ÿå¯ç¨³å®šæ’åºï¼›è¿™é‡Œé‡‡ç”¨ç¨³å®šæ’åï¼‰
      const list = [];
      for(const name of studentKeys){
        const v = d12Map.get(name);
        if(v != null) list.push({ name, v });
      }
      list.sort((a,b)=> b.v - a.v);
      let rank = 1;
      for(let i=0;i<list.length;i++){
        if(i>0 && list[i].v < list[i-1].v) rank = i+1;
        m.set(list[i].name, rank);
      }
      return m;
    }
    async function __fetchPracticeIntervalsByStudentForDate(sb, date){
      const start = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const end = new Date(date.getFullYear(), date.getMonth(), date.getDate()+1);
      const { data, error } = await sb
        .from('practice_logs')
        .select('student_name, student, action, timestamp, session_start, session_end, start_time, end_time, actual_start_time, end_reason, room_name')
        .gte('timestamp', start.toISOString())
        .lt('timestamp', end.toISOString())
        .order('timestamp', { ascending: true });
      if(error){ console.warn('fetch logs error', error); return new Map(); }
      const byName = new Map(); // normName -> array of logs
      for(const row of (data||[])){
        const nmRaw = row.student_name || row.student || row.studentName || '';
        const nm = utils.normalizeStudentName(nmRaw);
        if(!nm) continue;
        if(!byName.has(nm)) byName.set(nm, []);
        byName.get(nm).push(row);
      }
      const win = getLeaderboardWindow(date);
      if(!win) return new Map();
      const dayStartMs = toDayStart(date);
      const res = new Map(); // normName -> [ {start,end} in ms clipped to window ]
      for(const [nm, logs] of byName.entries()){
        const intervals = __buildIntervalsFromLogs(logs);
        // è£å‰ªåˆ°æ’è¡Œæ¦œçª—å£
        const clipped = [];
        for(const iv of intervals){
          const c = clipIntervalMsToWindow(iv, dayStartMs, win);
          if(c) clipped.push(c);
        }
        // åˆå¹¶é‡å åŒºé—´ï¼Œå‡å°‘é‡å¤
        const merged = mergeIntervalsMs(clipped);
        res.set(nm, merged);
      }
      return res;
    }

    function __buildIntervalsFromLogs(logs){
      const arr = (logs||[]).slice().sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));
      const out = [];
      const used = new Set(); // ä½¿ç”¨è¿‡çš„æ—¥å¿—ï¼ˆåŸºäºå¼•ç”¨ç´¢å¼•ï¼‰

      // Pass Aï¼šä¼˜å…ˆä½¿ç”¨ session_start + (timestamp æˆ– session_end) ç›´æ¥æ„é€ ï¼Œé¿å…åªæœ‰ clear æ—¶ä¸¢å¤±
      for(let i=0;i<arr.length;i++){
        const row = arr[i];
        const sessStartStr = row.session_start || row.actual_start_time || row.start_time;
        const sessEndStr = row.session_end || row.end_time; // å¯é€‰
        const tsStr = row.timestamp;
        const hasStart = !!sessStartStr;
        const hasEnd = !!(sessEndStr || tsStr);
        const action = String(row.action||'').toLowerCase();
        const isExitLike = action === 'clear' || action === 'exit';
        // clear/exit ä¸”å…·å¤‡ session_start ä¸ ç»ˆç‚¹ï¼ˆtimestamp æˆ– session_endï¼‰ï¼Œå¯ç›´æ¥æ„é€ 
        if(hasStart && hasEnd && (isExitLike || action === 'renew')){
          const s = new Date(sessStartStr).getTime();
          const e = new Date(sessEndStr || tsStr).getTime();
          if(Number.isFinite(s) && Number.isFinite(e) && e > s){
            out.push({ start: s, end: e });
            used.add(i);
          }
        }
      }

      // Pass Bï¼šå¯¹å‰©ä½™æ—¥å¿—ç”¨ assign/enter ä¸ clear/exit é…å¯¹ï¼ˆå…œåº•ï¼‰
      let curStart = null;
      for(let i=0;i<arr.length;i++){
        if(used.has(i)) continue;
        const log = arr[i];
        const action = String(log.action||'').toLowerCase();
        const isEnter = action === 'enter' || action === 'assign';
        const isExit = action === 'exit' || action === 'clear';
        if(isEnter){ if(curStart == null) curStart = new Date(log.timestamp).getTime(); }
        else if(isExit){
          if(curStart != null){
            const end = new Date(log.timestamp).getTime();
            if(end > curStart) out.push({ start: curStart, end });
            curStart = null;
          }
        }
      }

      // åˆå¹¶ç›¸é‚»æˆ–é‡å ï¼Œå…ˆæ’åº
      out.sort((a,b)=> a.start - b.start);
      const merged = [];
      for(const iv of out){
        if(!merged.length || iv.start > merged[merged.length-1].end){ merged.push({ ...iv }); }
        else { merged[merged.length-1].end = Math.max(merged[merged.length-1].end, iv.end); }
      }
      return merged;
    }

    function __computeDim3Historical(studentName, activeDate, todayD12, prevDayRankMap, d12Cache, studentKeys){
      if (!isWorkday(activeDate)) {
        return { score: 0, breakdown: { weekend: true, disabled: true } };
      }
  // 1) æ˜¨æ—¥æ’è¡ŒåŠ åˆ†ï¼ˆå·²ç»†åŒ–ä¸ºé€åæ¬¡çº¿æ€§æ’å€¼ï¼š1å=3åˆ†â†’10å=1åˆ†ï¼Œå…¶ä½™=0ï¼‰
      let sRank = 0, sProgress = 0, sConsistency = 0, sFresh = 0, antiBonus = 0;
      const pr = prevDayRankMap?.get?.(studentName);
  sRank = computeRankPoints(pr);

      // 2) è¿›æ­¥ä¸ç¨³å®šï¼šåŸºäº d12 ç¼“å­˜ï¼ˆè¿‘7å·¥ä½œæ—¥ vs å‰7å·¥ä½œæ—¥ï¼Œä»…ç»Ÿè®¡ >0 çš„æœ‰æ•ˆæ—¥ï¼‰
      const endWorkday = nearestWorkdayOnOrBefore(activeDate);
  const WN = p3.progress.windowSize || 5;
  const curDates = getLastNWorkdayDates(endWorkday, WN);
      const prevWindowEnd = previousWorkday(curDates[0]);
  const prevDates = getLastNWorkdayDates(prevWindowEnd, WN);
      const getD12 = (d) => {
        const k = utils.toIsoDate(d);
        const m = d12Cache.get(k);
        const v = m?.get?.(studentName) ?? 0;
        return Number.isFinite(v) ? v : 0;
      };
      const cur7 = curDates.map(getD12);
      const prev7 = prevDates.map(getD12);
      const curActiveArr = cur7.filter(v => v > 0);
      const prevActiveArr = prev7.filter(v => v > 0);
      const sum = a => a.reduce((x,y)=>x+y,0);
      const sCur = sum(curActiveArr), sPrev = sum(prevActiveArr);
      const p3 = LB442_PARAMS.dim3;
      const curActiveDays = curActiveArr.length;
      const prevActiveDays = prevActiveArr.length;
      const passActiveDaysGate = (curActiveDays >= p3.progress.minActiveDaysPerWindow) && (prevActiveDays >= p3.progress.minActiveDaysPerWindow);
      // æ£€æŸ¥å‰çª—å£æ¯ä¸ªæœ‰æ•ˆè®°å½•éƒ½ä¸ä½äºæœ€ä½åˆ†æ•°è¦æ±‚
      const prevRecordsQualified = prevActiveArr.every(score => score >= p3.progress.minPrevTotal);
      if (passActiveDaysGate && prevRecordsQualified && sCur > sPrev) {
        // ä½¿ç”¨æœ‰æ•ˆè®°å½•çš„å¹³å‡å€¼ï¼Œè€Œä¸æ˜¯çª—å£å¹³å‡å€¼
        const avgCur = sCur / curActiveDays;  // å½“å‰æœ‰æ•ˆè®°å½•çš„å¹³å‡å€¼
        const avgPrev = sPrev / prevActiveDays;  // å‰æœŸæœ‰æ•ˆè®°å½•çš„å¹³å‡å€¼
        const denomAvg = Math.max(avgPrev, p3.progress.denomFloor / Math.max(1, prevActiveDays));
        const appliedProgressRatio = Math.min(p3.progress.maxRatio, Math.max(0, (avgCur - avgPrev) / denomAvg));
        const ratioPct = appliedProgressRatio / p3.progress.maxRatio;
        sProgress = Math.min(6, +(ratioPct * 6).toFixed(2));
      }
      // ç¨³å®šæ€§ï¼šä»…åŸºäºæœ‰æ•ˆå·¥ä½œæ—¥çš„æ ‡å‡†å·®
      // éœ€è¦æœ€å°è®°å½•æ•°é‡æ‰èƒ½è®¡ç®—æ ‡å‡†å·®åŠ åˆ†
      const minRecordsForStability = p3.consistency?.minRecords || 3;
      if (curActiveDays >= minRecordsForStability) {
        const mean = sCur / curActiveDays;
        const variance = curActiveArr.reduce((acc, v) => acc + Math.pow(v - mean, 2), 0) / curActiveDays;
        const std = Math.sqrt(variance);
        sConsistency = computeConsistencyPoints(std);
      }

      // 3) ä»Šæ—¥æ´»è·ƒåº¦ä»…å¯¹â€œä»Šå¤©â€ç”Ÿæ•ˆï¼Œå†å²å›ç®—æ—¶è®° 0ï¼ˆcomputeDim3Score åŸé€»è¾‘äº¦å¦‚æ­¤ï¼‰
      // sFresh = 0;

      // 4) åéœ¸æ¦œæœºåˆ¶ï¼šåŸºäº d12Cache æ¨å¯¼â€œæŸæ—¥ç™»é¡¶è€…â€ï¼ˆä»¥ D1+D2 æ’åï¼‰
      const prevWork = previousWorkday(activeDate);
      const consec = __getConsecutiveTopWorkdaysUpToFromD12(prevWork, studentName, d12Cache, studentKeys);
      const daysSince = __getWorkdaysSinceLastTopFromD12(activeDate, studentName, d12Cache, studentKeys);
      let freshnessMultiplier = 1;
      if (consec >= p3.antiDomination.decayAfterDays) {
        const excess = consec - p3.antiDomination.decayAfterDays;
        freshnessMultiplier = Math.pow(p3.antiDomination.decayRate, Math.max(0, excess));
        if (consec >= p3.antiDomination.maxConsecutiveDays) {
          freshnessMultiplier *= 0.5;
        }
      } else if (daysSince != null && daysSince >= p3.antiDomination.breakPeriod) {
        antiBonus = p3.antiDomination.freshBreakBonus;
      }

      // æ±‡æ€»ï¼šåŸºç¡€ä¸º rank + progress + consistencyï¼Œå†ä¹˜ freshnessMultiplierï¼Œå¹¶åŠ  antiBonus
      const base = sRank + sProgress + sConsistency;
      let score = Math.round(base * freshnessMultiplier + antiBonus);
      score = Math.max(0, Math.min(score, 20));
      return { score, breakdown: { sRank, sProgress, sConsistency, sFresh, antiBonus, freshnessMultiplier } };
    }

    function __getTopNameForDateFromD12(date, d12Cache, studentKeys){
      const iso = utils.toIsoDate(date);
      const m = d12Cache.get(iso);
      if(!m) return [];
      // æ‰¾åˆ°æœ€é«˜åˆ†å’Œæ‰€æœ‰å¹¶åˆ—ç¬¬ä¸€çš„å­¦ç”Ÿ
      let best = -Infinity;
      for(const name of studentKeys){
        const v = m.get(name);
        if(v == null) continue;
        if(v > best){ best = v; }
      }
      const topNames = [];
      for(const name of studentKeys){
        const v = m.get(name);
        if(v === best){ topNames.push(name); }
      }
      return topNames;
    }

    function __getConsecutiveTopWorkdaysUpToFromD12(date, studentName, d12Cache, studentKeys){
      let cnt = 0;
      let d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      for(let i=0;i<14;i++){
        if(!isWorkday(d)) { d.setDate(d.getDate()-1); continue; }
        const topNames = __getTopNameForDateFromD12(d, d12Cache, studentKeys); // è¿”å›æ•°ç»„
        // åªæœ‰ç‹¬å ç¬¬ä¸€ï¼ˆæ•°ç»„é•¿åº¦ä¸º1ä¸”æ˜¯è¯¥å­¦ç”Ÿï¼‰æ‰è®¡å…¥è¿ç»­å¤©æ•°
        if(Array.isArray(topNames) && topNames.length === 1 && topNames[0] === studentName){
          cnt++;
        } else {
          break;
        }
        d.setDate(d.getDate()-1);
      }
      return cnt;
    }

    function __getWorkdaysSinceLastTopFromD12(date, studentName, d12Cache, studentKeys){
      let days = 0;
      let d = new Date(date.getFullYear(), date.getMonth(), date.getDate()-1);
      for(let i=0;i<30;i++){
        if(!isWorkday(d)) { d.setDate(d.getDate()-1); continue; }
        const topNames = __getTopNameForDateFromD12(d, d12Cache, studentKeys); // è¿”å›æ•°ç»„
        // åªè¦åœ¨å¹¶åˆ—ç¬¬ä¸€åå•ä¸­å°±ç®—ç™»é¡¶è¿‡
        if(Array.isArray(topNames) && topNames.includes(studentName)) return days;
        days++;
        d.setDate(d.getDate()-1);
      }
      return null; // æœªæ‰¾åˆ°
    }

    function __leaderboardWindowJSON(weekday){
      if([1,2,4,5].includes(weekday)) return { start: '08:00', end: '19:00' };
      if(weekday===3) return { start: '08:00', end: '19:30' };
      return null;
    }
    
    // æ·»åŠ è¿æ¥è´¨é‡è°ƒè¯•é¢æ¿
    function createConnectionDebugPanel() {
      const panel = document.createElement('div');
      panel.id = 'connectionDebugPanel';
      panel.style.cssText = `
        position: fixed;
        top: 60px;
        right: 10px;
        width: 280px;
        background: rgba(255,255,255,0.95);
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        font-size: 12px;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-family: 'SF Pro Text', system-ui, sans-serif;
      `;
      
      panel.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 8px; color: #333;">è¿æ¥è´¨é‡ç›‘æ§</div>
        <div id="debugConnectionStatus">çŠ¶æ€: æ£€æµ‹ä¸­...</div>
        <div id="debugHeartbeat">å¿ƒè·³: --</div>
        <div id="debugPing">å»¶è¿Ÿ: --</div>
        <div id="debugDataVersions">æ•°æ®ç‰ˆæœ¬: --</div>
        <div style="margin-top: 8px; font-size: 11px; color: #666;">
          <button onclick="healthMonitor.performHeartbeat()" style="padding:2px 6px;font-size:11px;">æ‰‹åŠ¨å¿ƒè·³</button>
          <button onclick="fetchDataWithDiff(['rooms'])" style="padding:2px 6px;font-size:11px;margin-left:4px;">æµ‹è¯•åŒæ­¥</button>
        </div>
      `;
      
      document.body.appendChild(panel);
      
      // å®šæœŸæ›´æ–°è°ƒè¯•ä¿¡æ¯
      setInterval(() => {
        if (panel.style.display === 'none') return;
        
        const status = healthMonitor.getStatus();
        const statusElement = document.getElementById('debugConnectionStatus');
        const heartbeatElement = document.getElementById('debugHeartbeat');
        const pingElement = document.getElementById('debugPing');
        const versionsElement = document.getElementById('debugDataVersions');
        
        if (statusElement) {
          const healthIcon = status.isHealthy ? 'ğŸŸ¢' : 'ğŸ”´';
          const qualityColor = status.quality === 'good' ? '#22c55e' : 
                              status.quality === 'fair' ? '#f59e0b' : '#ef4444';
          statusElement.innerHTML = `çŠ¶æ€: ${healthIcon} <span style="color:${qualityColor}">${status.quality}</span>`;
        }
        
        if (heartbeatElement) {
          const timeSince = Math.round(status.timeSinceLastHeartbeat / 1000);
          heartbeatElement.textContent = `å¿ƒè·³: ${timeSince}så‰`;
        }
        
        if (pingElement) {
          pingElement.textContent = `å»¶è¿Ÿ: ${status.avgPing}ms (å¹³å‡)`;
        }
        
        if (versionsElement) {
          const versions = Object.entries(dataVersions)
            .map(([table, info]) => `${table}: ${info.count}æ¡`)
            .join(', ');
          versionsElement.textContent = `æ•°æ®: ${versions}`;
        }
      }, 2000);
    }
    
    // æ·»åŠ é”®ç›˜å¿«æ·é”®æ˜¾ç¤ºè°ƒè¯•é¢æ¿
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        const panel = document.getElementById('connectionDebugPanel');
        if (!panel) {
          createConnectionDebugPanel();
        } else {
          panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        e.preventDefault();
      }
    });
    
    // âœ… æ™ºèƒ½é˜²æŠ–æ›´æ–°å‡½æ•°é…ç½®éªŒè¯ï¼šå¹³è¡¡å®æ—¶æ€§ä¸æ€§èƒ½çš„å…³é”®æœºåˆ¶
    // âœ… æ’è¡Œæ¦œæ›´æ–°ï¼š2-10ç§’é˜²æŠ–ï¼Œç¡®ä¿åˆ†æ•°å˜åŒ–æ—¶åŠæ—¶é‡è®¡ç®—ï¼Œé¿å…é¢‘ç¹æ— æ•ˆæ›´æ–°
    debouncedUpdateRanking = createSmartDebounce(updateRanking, 2000, 10000);
    // âœ… é¦–é¡µæ¦‚è§ˆæ›´æ–°ï¼š0.5-5ç§’é˜²æŠ–ï¼Œç¡®ä¿å­¦ç”ŸçŠ¶æ€å˜åŒ–æ—¶å¿«é€Ÿååº”ç•Œé¢
    debouncedRenderHomeBins = createSmartDebounce(renderHomeBins, 500, 5000);
    
    // ï¿½ï¸ å…¨å±€æ•°æ®ä¿æŠ¤å’Œç¼“å­˜ç®¡ç†ç³»ç»Ÿ
    window.__dataProtectionSystem = {
      // ğŸ”’ æ ¸å¿ƒä¿æŠ¤ï¼šéªŒè¯æ˜¯å¦å¯ä»¥å†™å…¥ leaderboard_dailyï¼ˆæœ¬åœ°æ—¶åŒºåŸºå‡†ï¼Œä¸ä¸šåŠ¡é€»è¾‘ä¸€è‡´ï¼‰
      canWriteLeaderboardDaily(targetDateISO, operation = 'update') {
        try {
          // 0. ğŸ”“ ç®¡ç†å‘˜ç»•è¿‡æ£€æŸ¥ï¼ˆç”¨äºå†å²æ•°æ®ä¿®å¤ï¼‰
          if (this._adminBypassProtection) {
            console.warn('[å†™åº“ä¿æŠ¤] âš ï¸ ç®¡ç†å‘˜æ¨¡å¼ï¼šå…è®¸å†å²æ•°æ®å†™å…¥', {
              operation,
              targetDate: targetDateISO,
              bypass: true
            });
            return true;
          }
          
          // 1. è·å–å½“å‰æœ¬åœ°æ—¥æœŸï¼ˆä¸getActiveLeaderboardDateä¿æŒä¸€è‡´ï¼‰
          const nowLocal = new Date();
          const currentDayOfWeek = nowLocal.getDay(); // 0=å‘¨æ—¥, 6=å‘¨å…­
          
          // ğŸ›¡ï¸ å‘¨æœ«ç»å¯¹ä¿æŠ¤ï¼šå‘¨å…­/å‘¨æ—¥å®Œå…¨ç¦æ­¢å†™å…¥
          if (currentDayOfWeek === 0 || currentDayOfWeek === 6) {
            const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            console.error('[å†™åº“ä¿æŠ¤] ğŸš« å‘¨æœ«ç¦æ­¢ä»»ä½•æ’è¡Œæ¦œæ•°æ®å†™å…¥', {
              operation,
              targetDate: targetDateISO,
              currentTime: nowLocal.toISOString(),
              currentDay: dayNames[currentDayOfWeek],
              reason: 'å‘¨æœ«ä¸å…è®¸ä¿®æ”¹æ’è¡Œæ¦œæ•°æ®ï¼ˆåŒ…æ‹¬å‘¨äº”æ•°æ®ï¼‰'
            });
            return false;
          }
          
          const todayLocal = new Date(
            nowLocal.getFullYear(),
            nowLocal.getMonth(),
            nowLocal.getDate()
          );
          const todayISO = utils.toIsoDate(todayLocal);
          
          // 2. è·å–æ´»è·ƒæ’è¡Œæ¦œæ—¥æœŸï¼ˆè€ƒè™‘07:00åˆ‡æ¢çª—å£ï¼‰
          const activeDate = getActiveLeaderboardDate();
          const activeISO = utils.toIsoDate(activeDate);
          
          // 3. è§£æç›®æ ‡æ—¥æœŸ
          const targetISO = typeof targetDateISO === 'string' ? targetDateISO.split('T')[0] : targetDateISO;
          
          // 4. ğŸ”’ ä¸¥æ ¼ä¿æŠ¤ï¼šåªå…è®¸å†™å…¥æ´»è·ƒæ—¥æœŸçš„æ•°æ®ï¼ˆä»Šå¤©æˆ–æ˜¨å¤©07:00å‰ï¼‰
          if (targetISO !== activeISO && targetISO !== todayISO) {
            console.error('[å†™åº“ä¿æŠ¤] ğŸš« æ‹’ç»å†™å…¥éæ´»è·ƒæ—¥æœŸæ•°æ®', {
              operation,
              targetDate: targetISO,
              activeDate: activeISO,
              todayLocal: todayISO,
              nowLocal: nowLocal.toISOString(),
              reason: 'å†å²æ•°æ®å†»ç»“ï¼Œä»…å…è®¸å†™å…¥æ´»è·ƒæ—¥æœŸæˆ–å½“æ—¥æ•°æ®'
            });
            
            // å¼¹çª—è­¦å‘Šï¼ˆä»…åœ¨å¼€å‘æ¨¡å¼ï¼‰
            if (typeof DEBUG !== 'undefined' && DEBUG) {
              alert(`âš ï¸ å†™åº“ä¿æŠ¤ï¼šæ‹’ç»å†™å…¥å†å²æ•°æ®\nç›®æ ‡æ—¥æœŸ: ${targetISO}\næ´»è·ƒæ—¥æœŸ: ${activeISO}\nå½“å‰æ—¥æœŸ: ${todayISO}`);
            }
            
            return false;
          }
          
          // 5. â° æ—¥æœŸåˆ‡æ¢çª—å£è­¦å‘Šï¼ˆæœ¬åœ° 06:30-07:30ï¼‰
          const minutesSinceMidnightLocal = nowLocal.getHours() * 60 + nowLocal.getMinutes();
          if (minutesSinceMidnightLocal >= 390 && minutesSinceMidnightLocal < 450) {
            console.warn('[å†™åº“ä¿æŠ¤] âš ï¸ æœ¬åœ°æ—¥æœŸåˆ‡æ¢çª—å£æœŸ', {
              operation,
              targetDate: targetISO,
              activeDate: activeISO,
              nowLocal: nowLocal.toISOString(),
              minutesSinceMidnightLocal,
              warning: 'å¤„äº07:00åˆ‡æ¢çª—å£ï¼Œè¯·ç‰¹åˆ«æ³¨æ„æ•°æ®å½’å±æ—¥æœŸ'
            });
          }
          
          // 6. âœ… è®°å½•åˆæ³•å†™æ“ä½œ
          console.log('[å†™åº“ä¿æŠ¤] âœ… å…è®¸å†™å…¥æ´»è·ƒæ—¥æœŸæ•°æ®', {
            operation,
            targetDate: targetISO,
            activeDate: activeISO,
            todayLocal: todayISO,
            timestampLocal: nowLocal.toISOString(),
            dayOfWeek: ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][nowLocal.getDay()]
          });
          
          return true;
        } catch (error) {
          console.error('[å†™åº“ä¿æŠ¤] éªŒè¯å¤±è´¥:', error);
          return false; // å‡ºé”™æ—¶ä¿å®ˆæ‹’ç»
        }
      },
      
      // æ¸…é™¤æ‰€æœ‰å¯èƒ½æ±¡æŸ“å†å²æ•°æ®çš„ç¼“å­˜
      clearHistoricalDataCache() {
        try {
          localStorage.removeItem('rank_cache_v2');
          localStorage.removeItem(RANK_CACHE_KEY);
          localStorage.removeItem('home_ranking_sync');
          if (window.__scoreCache) window.__scoreCache.clear();
          if (typeof __rankTopCache !== 'undefined') __rankTopCache.clear();
          if (typeof __cloudD3 !== 'undefined') {
            __cloudD3.prevDayRankMap.clear();
            __cloudD3.prevTopByActiveIso.clear();
            __cloudD3.d12CacheByDate.clear();
          }
          rankingDataCache = null;
          lastRankingUpdateTime = 0;
          
          console.log('[æ•°æ®ä¿æŠ¤] å·²æ¸…é™¤æ‰€æœ‰å†å²æ•°æ®ç¼“å­˜ï¼Œé˜²æ­¢æ±¡æŸ“');
          return true;
        } catch(e) {
          console.error('[æ•°æ®ä¿æŠ¤] æ¸…é™¤ç¼“å­˜æ—¶å‡ºé”™:', e);
          return false;
        }
      },
      
      // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨æ•æ„Ÿæ—¶é—´çª—å£
      isInSensitiveTimeWindow() {
        const now = new Date();
        const minutesSinceMidnight = now.getHours() * 60 + now.getMinutes();
        return minutesSinceMidnight < 30 || (minutesSinceMidnight >= 420 && minutesSinceMidnight < 450);
      },
      
      // å®‰å…¨çš„æ’è¡Œæ¦œæ“ä½œæ£€æŸ¥
      canSafelyUpdateLeaderboard(targetDate = null) {
        if (this.isInSensitiveTimeWindow()) {
          console.warn('[æ•°æ®ä¿æŠ¤] æ•æ„Ÿæ—¶é—´çª—å£ï¼Œå»ºè®®å»¶è¿Ÿæ’è¡Œæ¦œæ“ä½œ');
          return false;
        }
        
        if (targetDate) {
          const realToday = utils.toIsoDate(new Date());
          if (targetDate !== realToday) {
            console.warn('[æ•°æ®ä¿æŠ¤] å°è¯•ä¿®æ”¹éå½“æ—¥æ•°æ®ï¼Œå·²é˜»æ­¢');
            return false;
          }
        }
        
        return true;
      },
      
      // ğŸ“‹ è·å–ä¿æŠ¤ç³»ç»Ÿå®¡è®¡æŠ¥å‘Š
      getProtectionAudit() {
        const nowUTC = new Date();
        const todayUTC = utils.toIsoDate(new Date(Date.UTC(
          nowUTC.getUTCFullYear(),
          nowUTC.getUTCMonth(),
          nowUTC.getUTCDate()
        )));
        
        return {
          timestamp: nowUTC.toISOString(),
          todayUTC: todayUTC,
          protectionStatus: 'å·²å¯ç”¨',
          protectedOperations: [
            'âœ… updateLeaderboardDailyScore: ç®¡ç†å‘˜è°ƒåˆ†å‰éªŒè¯ï¼ˆ3ä¸ªå†™å…¥ç‚¹ï¼‰',
            'âœ… recalculateDailyRanking: æ’åè®¡ç®—å‰éªŒè¯ï¼ˆ2ä¸ªå†™å…¥ç‚¹ï¼‰',
            'âœ… __leaderboardSyncSystem: å†å²æ‰¹é‡åŒæ­¥å‰éªŒè¯ï¼ˆ1ä¸ªå†™å…¥ç‚¹ï¼‰'
          ],
          totalProtectedWritePoints: 6,
          utcTimezone: true,
          sensitiveTimeWindow: this.isInSensitiveTimeWindow() ? 'å½“å‰åœ¨æ•æ„Ÿæ—¶é—´çª—å£' : 'å®‰å…¨æ—¶é—´',
          cacheCleanup: 'å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…é™¤',
          writeValidation: 'åŸºäºUTCæ—¶åŒºçš„ä¸¥æ ¼æ—¥æœŸæ ¡éªŒ',
          historicalDataPolicy: 'ç¦æ­¢å†™å…¥ä»»ä½•å†å²æ—¥æœŸæ•°æ®',
          recommendations: [
            'æ‰€æœ‰å†™å…¥ä»…é™å½“æ—¥UTCæ—¥æœŸ',
            'æ•æ„Ÿæ—¶é—´çª—å£(00:00-00:30, 07:00-07:30)è‡ªåŠ¨å»¶è¿Ÿ',
            'å¼€å‘æ¨¡å¼ä¸‹æ‹’ç»å†å²å†™å…¥æ—¶å¼¹çª—æç¤º',
            'æ‰€æœ‰å†™æ“ä½œå‡æœ‰è¯¦ç»†æ§åˆ¶å°æ—¥å¿—'
          ]
        };
      },
      
      // ğŸ” æ§åˆ¶å°æ‰“å°å®¡è®¡æŠ¥å‘Š
      printAudit() {
        const audit = this.getProtectionAudit();
        console.log('â•'.repeat(60));
        console.log('ğŸ“‹ Leaderboard_Daily å†™åº“ä¿æŠ¤ç³»ç»Ÿå®¡è®¡æŠ¥å‘Š');
        console.log('â•'.repeat(60));
        console.log(`â° æ—¶é—´æˆ³: ${audit.timestamp}`);
        console.log(`ğŸ“… UTCæ—¥æœŸ: ${audit.todayUTC}`);
        console.log(`ğŸ›¡ï¸ ä¿æŠ¤çŠ¶æ€: ${audit.protectionStatus}`);
        console.log(`âš ï¸ æ—¶é—´çª—å£: ${audit.sensitiveTimeWindow}`);
        console.log('');
        console.log('ğŸ”’ å·²ä¿æŠ¤çš„å†™å…¥æ“ä½œ:');
        audit.protectedOperations.forEach(op => console.log(`  ${op}`));
        console.log(`  æ€»è®¡: ${audit.totalProtectedWritePoints} ä¸ªå†™å…¥ç‚¹`);
        console.log('');
        console.log('ğŸ’¡ ä¿æŠ¤ç­–ç•¥:');
        audit.recommendations.forEach(rec => console.log(`  â€¢ ${rec}`));
        console.log('â•'.repeat(60));
        return audit;
      },
      
      // ğŸ”“ ç®¡ç†å‘˜ä¸“ç”¨ï¼šä¸´æ—¶è§£é™¤ä¿æŠ¤ï¼ˆç”¨äºå†å²æ•°æ®ä¿®å¤ï¼‰
      _adminBypassProtection: false,
      
      enableAdminBypass(confirmCode) {
        // å®‰å…¨ç¡®è®¤ç ï¼šé˜²æ­¢æ„å¤–è°ƒç”¨
        if (confirmCode === 'REPAIR_HISTORICAL_DATA_2024') {
          this._adminBypassProtection = true;
          console.warn('âš ï¸âš ï¸âš ï¸ ç®¡ç†å‘˜æ¨¡å¼ï¼šå†å²æ•°æ®ä¿æŠ¤å·²ä¸´æ—¶è§£é™¤ âš ï¸âš ï¸âš ï¸');
          console.warn('è¯·å°½å¿«å®Œæˆä¿®å¤æ“ä½œåè°ƒç”¨ disableAdminBypass()');
          return true;
        }
        console.error('âŒ ç¡®è®¤ç é”™è¯¯ï¼Œæ— æ³•è§£é™¤ä¿æŠ¤');
        return false;
      },
      
      disableAdminBypass() {
        this._adminBypassProtection = false;
        console.log('âœ… å†å²æ•°æ®ä¿æŠ¤å·²é‡æ–°å¯ç”¨');
      }
    };
    
    // ï¿½ğŸ”§ æ–°å¢ï¼šç»Ÿä¸€çš„æ’è¡Œæ¦œåŒæ­¥ç³»ç»Ÿ
    window.__leaderboardSyncSystem = {
      lastUpdateTime: 0,
      updateInProgress: false,
      pendingUpdate: false,
      
      // ç»Ÿä¸€æ›´æ–°æ‰€æœ‰æ’è¡Œæ¦œè§†å›¾
      async updateAllLeaderboards(options = {}) {
        const { force = false, silent = true } = options;
        const now = Date.now();
        
        // ğŸ›¡ï¸ å†å²æ•°æ®ä¿æŠ¤ï¼šæ£€æŸ¥æ˜¯å¦åœ¨æ•æ„Ÿæ—¶é—´çª—å£
        const realNow = new Date();
        const minutesSinceMidnight = realNow.getHours() * 60 + realNow.getMinutes();
        const isInSensitiveWindow = minutesSinceMidnight < 30 || (minutesSinceMidnight >= 420 && minutesSinceMidnight < 450); // 00:00-00:30 æˆ– 07:00-07:30
        
        if (isInSensitiveWindow && !force) {
          console.warn('[LeaderboardSync] æ•æ„Ÿæ—¶é—´çª—å£ï¼Œè·³è¿‡è‡ªåŠ¨æ›´æ–°é˜²æ­¢å†å²æ•°æ®æ±¡æŸ“', {
            currentTime: realNow.toTimeString().substring(0, 8),
            minutesSinceMidnight,
            reason: 'é˜²æ­¢è·¨æ—¥æœŸæ•°æ®æ··æ·†'
          });
          return;
        }
        
        // é˜²æ­¢å¹¶å‘æ›´æ–°
        if (this.updateInProgress && !force) {
          this.pendingUpdate = true;
          dbg('[LeaderboardSync] æ›´æ–°è¿›è¡Œä¸­ï¼Œæ ‡è®°å¾…å¤„ç†');
          return;
        }
        
        // é¿å…é¢‘ç¹æ›´æ–°ï¼ˆ5ç§’å†…æœ€å¤šä¸€æ¬¡ï¼Œé™¤éå¼ºåˆ¶ï¼‰
        // å¦‚æœæœ‰å¾…å¤„ç†çš„æ›´æ–° (needsUpdate)ï¼Œä¹Ÿå…è®¸æ‰§è¡Œ
        if (!force && !this.needsUpdate && (now - this.lastUpdateTime) < 5000) {
          dbg('[LeaderboardSync] è·³è¿‡é¢‘ç¹æ›´æ–°');
          return;
        }
        
        // å¦‚æœæ˜¯å› ä¸º needsUpdate è€Œæ‰§è¡Œï¼Œé‡ç½®æ ‡å¿—
        if (this.needsUpdate) {
            this.needsUpdate = false;
            dbg('[LeaderboardSync] å¤„ç†ç§¯å‹çš„æ›´æ–°è¯·æ±‚');
        }
        
        // å¦‚æœç”¨æˆ·æœ€è¿‘ï¼ˆ2ç§’å†…ï¼‰æ»šåŠ¨è¿‡æ’è¡Œæ¦œï¼Œæ¨è¿Ÿæ›´æ–°
        // è¿™èƒ½æœ‰æ•ˆé˜²æ­¢åœ¨æµè§ˆæ—¶å› æ•°æ®æ›´æ–°å¯¼è‡´çš„å¡é¡¿æˆ–è·³åŠ¨
        if (window.__lastRankingScrollTime && (now - window.__lastRankingScrollTime) < 2000) {
             dbg('[LeaderboardSync] ç”¨æˆ·æ­£åœ¨æ»šåŠ¨ï¼Œæ¨è¿Ÿæ›´æ–°');
             this.needsUpdate = true;
             return;
        }
        
        this.updateInProgress = true;
        this.lastUpdateTime = now;
        
        try {
          dbg('[LeaderboardSync] å¼€å§‹åŒæ­¥æ›´æ–°æ‰€æœ‰æ’è¡Œæ¦œ...');
          
          // 1. ä¼˜åŒ–ï¼šä¸å†å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ï¼Œåˆ©ç”¨å¢é‡æ›´æ–°æœºåˆ¶
          // åªåœ¨ç¡®å®éœ€è¦æ—¶ï¼ˆå¦‚è§„åˆ™å˜æ›´ï¼‰æ‰æ¸…é™¤
          /* 
          try {
            localStorage.removeItem(RANK_CACHE_KEY);
            localStorage.removeItem('rank_cache_v2');
            if (window.__scoreCache) window.__scoreCache.clear();
            if (typeof __rankTopCache !== 'undefined') __rankTopCache.clear();
            rankingDataCache = null;
            lastRankingUpdateTime = 0;
            dbg('[LeaderboardSync] ç¼“å­˜å·²æ¸…é™¤');
          } catch(e) {
            dbg('[LeaderboardSync] ç¼“å­˜æ¸…é™¤å¤±è´¥:', e);
          }
          */
          
          // 2. æ›´æ–°é¦–é¡µå°æ’è¡Œæ¦œ
          if (typeof updateRanking === 'function') {
            await updateRanking();
            dbg('[LeaderboardSync] é¦–é¡µå°æ¦œå·²æ›´æ–°');
          }
          
          // 3. æ™ºèƒ½æ›´æ–°å®Œæ•´æ’è¡Œæ¦œ
          if (uiState && uiState.view === 'ranking') {
            // åªæœ‰å½“æ’è¡Œæ¦œé¡µé¢å¯è§æ—¶ï¼Œæ‰æ‰§è¡Œæ˜‚è´µçš„å®Œæ•´æ¸²æŸ“
            if (typeof renderRankingFull === 'function') {
              await renderRankingFull({ silent, keepScroll: true });
              dbg('[LeaderboardSync] å®Œæ•´æ’è¡Œæ¦œå·²æ›´æ–°ï¼ˆå½“å‰å¯è§ï¼‰');
            }
          } else {
            // æ’è¡Œæ¦œé¡µé¢ä¸å¯è§æ—¶ï¼Œæ ‡è®°ä¸ºéœ€è¦æ›´æ–°ï¼Œä½†ä¸æ‰§è¡Œæ¸²æŸ“ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
            this.needsUpdate = true;
            dbg('[LeaderboardSync] å®Œæ•´æ’è¡Œæ¦œæ ‡è®°ä¸ºå¾…æ›´æ–°ï¼ˆåå°è·³è¿‡æ¸²æŸ“ï¼‰');
          }
          
          dbg('[LeaderboardSync] âœ… æ‰€æœ‰æ’è¡Œæ¦œåŒæ­¥å®Œæˆ');
          
        } catch (error) {
          console.error('[LeaderboardSync] æ›´æ–°å¤±è´¥:', error);
        } finally {
          this.updateInProgress = false;
          
          // å¦‚æœæœ‰å¾…å¤„ç†çš„æ›´æ–°è¯·æ±‚ï¼Œå»¶è¿Ÿæ‰§è¡Œ
          if (this.pendingUpdate) {
            this.pendingUpdate = false;
            setTimeout(() => this.updateAllLeaderboards({ silent: true }), 2000);
          }
        }
      },
      
      // å¯åŠ¨æ’è¡Œæ¦œé¡µé¢å¯è§æ—¶çš„è‡ªåŠ¨åˆ·æ–°
      startAutoRefresh() {
        if (this.autoRefreshTimer) {
          clearInterval(this.autoRefreshTimer);
        }
        
        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        this.autoRefreshTimer = setInterval(() => {
          // åªåœ¨æ’è¡Œæ¦œé¡µé¢å¯è§æ—¶è‡ªåŠ¨åˆ·æ–°
          if (uiState && uiState.view === 'ranking') {
            dbg('[LeaderboardSync] è‡ªåŠ¨åˆ·æ–°æ’è¡Œæ¦œï¼ˆé¡µé¢å¯è§ï¼‰');
            this.updateAllLeaderboards({ silent: true });
          }
        }, 30000); // 30ç§’
        
        dbg('[LeaderboardSync] è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨');
      },
      
      // åœæ­¢è‡ªåŠ¨åˆ·æ–°
      stopAutoRefresh() {
        if (this.autoRefreshTimer) {
          clearInterval(this.autoRefreshTimer);
          this.autoRefreshTimer = null;
          dbg('[LeaderboardSync] è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
        }
      }
    };
    
    // å¯åŠ¨æ’è¡Œæ¦œè‡ªåŠ¨åˆ·æ–°ç³»ç»Ÿ
    window.__leaderboardSyncSystem.startAutoRefresh();
    
    // ğŸ›¡ï¸ é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ•°æ®ä¿æŠ¤æ¸…ç†
    setTimeout(() => {
      if (window.__dataProtectionSystem) {
        const cleared = window.__dataProtectionSystem.clearHistoricalDataCache();
        if (cleared) {
          console.log('[ç³»ç»Ÿå¯åŠ¨] å·²æ‰§è¡Œå†å²æ•°æ®ä¿æŠ¤æ¸…ç†ï¼Œé˜²æ­¢ç¼“å­˜æ±¡æŸ“');
          
          // åœ¨æ•æ„Ÿæ—¶é—´æ˜¾ç¤ºé¢å¤–è­¦å‘Š
          if (window.__dataProtectionSystem.isInSensitiveTimeWindow()) {
            console.warn('[ç³»ç»Ÿå¯åŠ¨] å½“å‰å¤„äºæ•æ„Ÿæ—¶é—´çª—å£ï¼Œè¯·è°¨æ…æ“ä½œæ’è¡Œæ¦œæ•°æ®');
            try {
              showToast('âš ï¸ å½“å‰å¤„äºæ•æ„Ÿæ—¶é—´çª—å£ï¼Œå†å²æ•°æ®å—ä¿æŠ¤', 'warning');
            } catch {}
          }
        }
      }
    }, 2000); // å»¶è¿Ÿ2ç§’ç¡®ä¿ç³»ç»Ÿå®Œå…¨åŠ è½½
    
    // âœ… å¯¼å‡ºæ•°æ®å®Œæ•´æ€§æ£€æŸ¥å‡½æ•°åˆ°å…¨å±€ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§
    window.checkDataIntegrity = performDataIntegrityCheck;
    window.getDataSummary = function() {
      return {
        practiceLogs: {
          total: appState.practiceLogs?.length || 0,
          normalized: appState.practiceLogsNormalized?.length || 0
        },
        students: {
          total: appState.studentsMeta.size,
          withTimeSlots: appState.timeSlots.size
        },
        rooms: {
          total: window.roomsData?.length || 0,
          occupied: window.roomsData?.filter(r => r.occupant_student_name)?.length || 0
        },
        lastSync: {
          practice_logs: dataVersions.practice_logs?.lastSync || 0,
          student_database: dataVersions.student_database?.lastSync || 0,
          student_time_slots: dataVersions.student_time_slots?.lastSync || 0,
          rooms: dataVersions.rooms?.lastSync || 0
        }
      };
    };
    
    // åº”ç”¨å°†é€šè¿‡DOMContentLoadedäº‹ä»¶å¯åŠ¨ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
  </script>
</body>
</html>

  <!-- è½»é‡æç¤ºå®¹å™¨ -->
  <div id="lbToast" class="lb-toast" role="status" aria-live="polite" aria-atomic="true" hidden></div>
