<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>é’å²›æ¢…çº½å› éŸ³ä¹å­¦æ ¡ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root {
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --success-color: #27ae60;
    --background-color: #f8f9fa;
    --text-color: #2c3e50;
    --border-color: #dee2e6;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --radius: 12px;
    --mobile-padding: 15px;
    --mobile-font-size: 16px;
    --touch-target-size: 44px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    overflow-x: hidden;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom);
}

/* è¯­è¨€åˆ‡æ¢æŒ‰é’® */
.language-switcher {
    position: fixed;
    bottom: max(20px, env(safe-area-inset-bottom) + 10px);
    left: 20px;
    z-index: 1001;
    display: flex;
    background: white;
    border-radius: 20px;
    box-shadow: var(--shadow);
    overflow: hidden;
}

.lang-btn {
    padding: 8px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 40px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lang-btn.active {
    background: var(--primary-color);
    color: white;
}

.lang-btn:hover:not(.active) {
    background: rgba(52, 152, 219, 0.1);
}

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 768px) {
    .language-switcher {
        bottom: max(10px, env(safe-area-inset-bottom) + 5px);
        left: 10px;
        border-radius: 16px;
    }
    
    .lang-btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 35px;
        height: 28px;
    }
}

/* å¤´éƒ¨æ ·å¼ */
.header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: max(30px, env(safe-area-inset-top) + 20px) 20px 30px 20px;
    margin-bottom: 30px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
}

.header h1 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    margin-bottom: 10px;
    font-weight: 300;
    line-height: 1.2;
}

.header .subtitle {
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    opacity: 0.9;
    line-height: 1.3;
}

/* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
.connection-status {
    position: fixed;
    top: max(20px, env(safe-area-inset-top) + 10px);
    right: 20px;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    z-index: 1000;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.connection-status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--danger-color);
}

.connection-status.online::before {
    background: var(--success-color);
}

.connection-status.syncing::before {
    background: var(--warning-color);
    animation: pulse 1.5s infinite;
}

.connection-status.online {
    background: white;
    color: var(--success-color);
    border: 1px solid var(--success-color);
}

.connection-status.offline {
    background: white;
    color: var(--danger-color);
    border: 1px solid var(--danger-color);
}

.connection-status.syncing {
    background: white;
    color: var(--warning-color);
    border: 1px solid var(--warning-color);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* ä¸»å¯¼èˆª */
.nav-tabs {
    display: flex;
    background: white;
    border-radius: var(--radius);
    padding: 5px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.nav-tabs::-webkit-scrollbar {
    display: none;
}

.nav-tab {
    flex: 1;
    padding: 12px 16px;
    text-align: center;
    background: transparent;
    border: none;
    border-radius: calc(var(--radius) - 5px);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: clamp(14px, 3vw, 16px);
    font-weight: 500;
    white-space: nowrap;
    min-width: 120px;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
}

.nav-tab:hover {
    background: rgba(52, 152, 219, 0.1);
}

.nav-tab.active {
    background: var(--primary-color);
    color: white;
}

/* å¡ç‰‡å®¹å™¨ */
.card {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
}

.card.success {
    border-left-color: var(--success-color);
}

.card.warning {
    border-left-color: var(--warning-color);
}

.card.danger {
    border-left-color: var(--danger-color);
}

/* ç»Ÿè®¡é¢æ¿ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 10px;
}

.stat-label {
    font-size: 1.1rem;
    color: #666;
    margin-bottom: 5px;
}

.stat-description {
    font-size: 0.9rem;
    color: #999;
}

.stat-card.present .stat-number { color: var(--success-color); }
.stat-card.absent .stat-number { color: var(--danger-color); }
.stat-card.excused .stat-number { color: var(--warning-color); }
.stat-card.total .stat-number { color: var(--primary-color); }
.stat-card.unscheduled .stat-number { color: #9b59b6; }
.stat-card.weekend .stat-number { color: #95a5a6; }

/* ğŸ”¥ ç»Ÿä¸€çš„å­¦ç”Ÿç½‘æ ¼å¸ƒå±€ */
.student-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-top: 20px;
    width: 100%;
}

/* ğŸ”¥ å“åº”å¼ç½‘æ ¼ä¼˜åŒ– */
@media (min-width: 600px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
    }
}

@media (min-width: 900px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }
}

@media (min-width: 1200px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
    }
}

@media (min-width: 1600px) {
    .student-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: 15px;
    }
}



/* ğŸ”¥ ç»Ÿä¸€çš„å¡ç‰‡åŸºç¡€æ ·å¼ - å­¦ç”Ÿå¡ç‰‡å’Œå®æ—¶ç»ƒç´å¡ç‰‡å…±ç”¨ */
.student-card,
.practice-status-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    border-left: 4px solid #ddd;
    cursor: pointer;
    min-width: 0;
    width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    height: auto;
    min-height: 280px;
}

/* ğŸ”¥ æ–°å¢ï¼šç¡®ä¿å¡ç‰‡åœ¨å¤§å±å¹•ä¸‹æœ‰åˆé€‚çš„æœ€å°å®½åº¦ */
@media (min-width: 1200px) {
    .student-card,
    .practice-status-card {
        min-width: 260px;
    }
}

@media (min-width: 1400px) {
    .student-card,
    .practice-status-card {
        min-width: 280px;
    }
}

@media (min-width: 1600px) {
    .student-card,
    .practice-status-card {
        min-width: 320px;
    }
}


/* ğŸ”¥ ç»Ÿä¸€çš„å¡ç‰‡æ‚¬åœæ•ˆæœ */
.student-card:hover,
.practice-status-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

/* ğŸ”¥ ç»Ÿä¸€çš„çŠ¶æ€æ ·å¼ */
.student-card.present { border-left-color: var(--success-color); }
.student-card.absent { border-left-color: var(--danger-color); }
.student-card.excused { border-left-color: var(--warning-color); }
.student-card.low-efficiency { border-left-color: #f39c12; }
.student-card.practicing-unscheduled,
.practice-status-card { 
    border-left-color: #9b59b6; 
    background: linear-gradient(135deg, #f8f4ff, #ffffff);
}
.student-card.weekend { 
    border-left-color: #95a5a6; 
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
}

/* ğŸ”¥ ç»Ÿä¸€çš„å¤´éƒ¨æ ·å¼ */
.student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

/* ğŸ”¥ ç»Ÿä¸€çš„å­¦ç”Ÿå§“åæ ·å¼ */
.student-name {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
}

/* ğŸ”¥ ç»Ÿä¸€çš„çŠ¶æ€/æ—¶é•¿æ ‡ç­¾æ ·å¼ */
.student-status,
.practice-duration {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
}

/* å­¦ç”ŸçŠ¶æ€é¢œè‰² */
.student-status.present { background: #d4edda; color: #155724; }
.student-status.absent { background: #f8d7da; color: #721c24; }
.student-status.excused { background: #fff3cd; color: #856404; }
.student-status.low-efficiency { background: #ffeaa7; color: #b06000; }
.student-status.practicing-unscheduled { background: #e8d5f2; color: #6a1b9a; }
.student-status.weekend { background: #ecf0f1; color: #2c3e50; }

/* ç»ƒç´æ—¶é•¿æ ‡ç­¾é¢œè‰² */
.practice-duration {
    background: #e8d5f2;
    color: #6a1b9a;
}

/* ğŸ”¥ ç»Ÿä¸€çš„è¯¦æƒ…ç½‘æ ¼æ ·å¼ */
.student-details,
.practice-details {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-bottom: 15px;
    flex: 1;
}

/* ğŸ”¥ ä¼˜åŒ–ï¼šæ ¹æ®å±å¹•å°ºå¯¸è°ƒæ•´è¯¦æƒ…ç½‘æ ¼ */
@media (min-width: 480px) {
    .student-details,
    .practice-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
}

@media (min-width: 768px) {
    .student-details,
    .practice-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
}

@media (min-width: 1024px) {
    .student-details,
    .practice-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šå¤§å±å¹•ä¸‹ä¿æŒ2åˆ—ï¼Œé¿å…è¿‡åº¦å‹ç¼© */
@media (min-width: 1200px) {
    .student-details,
    .practice-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
    }
}

@media (min-width: 1600px) {
    .student-details,
    .practice-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
}




/* ğŸ”¥ ç»Ÿä¸€çš„è¯¦æƒ…é¡¹æ ·å¼ */
.detail-item {
    display: flex;
    flex-direction: column;
}

.detail-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 3px;
}

.detail-value {
    font-weight: 600;
    color: var(--text-color);
}

/* ğŸ”¥ å®æ—¶ç»ƒç´å¡ç‰‡ç‰¹æœ‰çš„æŒ‡ç¤ºå™¨ */
.practice-status-card .practice-indicator {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    background: #27ae60;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

/* ğŸ”¥ è€ƒå‹¤å†å²æ ·å¼ï¼ˆåªåœ¨å­¦ç”Ÿè¯¦æƒ…å¡ç‰‡ä¸­æ˜¾ç¤ºï¼‰ */
.attendance-history {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.history-title {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 10px;
}

.history-timeline {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.history-day {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.history-day.present { background: var(--success-color); color: white; }
.history-day.absent { background: var(--danger-color); color: white; }
.history-day.excused { background: var(--warning-color); color: white; }
.history-day.no-data { background: #f8f9fa; color: #999; }

.history-day:hover {
    transform: scale(1.1);
}

/* ğŸ”¥ ç©ºçŠ¶æ€æ ·å¼ */
.practice-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.practice-empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.practice-empty-state-title {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--text-color);
}

.practice-empty-state-description {
    font-size: 0.9rem;
    line-height: 1.4;
}

/* ğŸ”¥ å“åº”å¼è®¾è®¡ - ç»Ÿä¸€å¤„ç† */
/* è¶…å¤§å±å¹•ï¼šä¿æŒ4åˆ— */
@media (min-width: 1400px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }
}

/* å¤§å±å¹•ï¼šä¿æŒ4åˆ— */
@media (min-width: 1200px) and (max-width: 1399px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
    }
}

/* ä¸­ç­‰å±å¹•ï¼š3åˆ— */
@media (min-width: 900px) and (max-width: 1199px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }
}

/* å¹³æ¿ï¼š2åˆ— */
@media (min-width: 600px) and (max-width: 899px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .student-card,
    .practice-status-card {
        padding: 18px;
    }
}

/* æ‰‹æœºï¼š1åˆ— */
@media (max-width: 480px) {
    .container {
        padding: 10px;
    }
    
    .student-card,
    .practice-status-card {
        padding: 10px;
    }
    
    .header h1 {
        font-size: 1.5rem;
    }
    
    .header .subtitle {
        font-size: 0.9rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
    
    .student-name {
        font-size: 1.1rem;
    }
    
    .detail-label {
        font-size: 0.8rem;
    }
    
    .detail-value {
        font-size: 0.9rem;
    }
    .student-details,
    .practice-details {
        grid-template-columns: 1fr;
        gap: 6px;
    }
}


/* ç­›é€‰å™¨ */
.filters {
    background: white;
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 25px;
    box-shadow: var(--shadow);
}

.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
}

.filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
}

.filter-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 5px;
}

.filter-select, .filter-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.filter-select:focus, .filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* æ“ä½œæŒ‰é’® */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: var(--mobile-font-size);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: var(--touch-target-size);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

.btn:hover {
    transform: translateY(-2px);
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-warning {
    background: var(--warning-color);
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

/* æ¨¡æ€æ¡† */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    animation: fadeIn 0.3s ease;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: var(--radius);
    padding: 25px;
    max-width: min(600px, 95vw);
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideIn 0.3s ease;
    margin: env(safe-area-inset-top) auto env(safe-area-inset-bottom) auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    color: var(--danger-color);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* è¡¨æ ¼æ ·å¼ */
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
}

.data-table th,
.data-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    min-width: 80px;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: var(--text-color);
}

.data-table tr:hover {
    background: #f8f9fa;
}

/* åŠ è½½åŠ¨ç”» */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ç©ºçŠ¶æ€ */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: var(--text-color);
}

.empty-state-description {
    font-size: 1rem;
    line-height: 1.6;
}

/* æ—¥æœŸé€‰æ‹©å™¨æ ·å¼ */
.date-picker {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.date-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
}

/* å¯¼å‡ºæŒ‰é’®æ ·å¼ */
.export-options {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* è§¦æ‘¸ä¼˜åŒ– */
.student-card, .practice-status-card, .stat-card, .btn, .nav-tab {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
    tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.student-card:active, .practice-status-card:active, .stat-card:active {
    transform: scale(0.98);
}

.btn:active {
    transform: scale(0.95);
}

/* iOSå®‰å…¨åŒºåŸŸé€‚é… */
@supports (padding: max(0px)) {
    .container {
        padding-left: max(20px, env(safe-area-inset-left));
        padding-right: max(20px, env(safe-area-inset-right));
    }
    
    @media (max-width: 768px) {
        .container {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }
    }
}

/* é˜²æ­¢ç¼©æ”¾ */
input[type="text"], input[type="date"], select, textarea {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

/* æ»šåŠ¨æ¡ä¼˜åŒ– */
.modal-content, .sync-logs {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

.modal-content::-webkit-scrollbar, .sync-logs::-webkit-scrollbar {
    width: 4px;
}

.modal-content::-webkit-scrollbar-track, .sync-logs::-webkit-scrollbar-track {
    background: transparent;
}

.modal-content::-webkit-scrollbar-thumb, .sync-logs::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 2px;
}


/* è¶…å°å±å¹•ä¼˜åŒ– */
@media (max-width: 480px) {
    .container {
        padding: 10px;
    }
    
    .student-card,
    .practice-status-card {
        padding: 10px;
    }
    
    .header h1 {
        font-size: 1.5rem;
    }
    
    .header .subtitle {
        font-size: 0.9rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
    
    .student-name {
        font-size: 1.1rem;
    }
    
    .detail-label {
        font-size: 0.8rem;
    }
    
    .detail-value {
        font-size: 0.9rem;
    }
}

/* iOS Safari ç‰¹æ®Šä¼˜åŒ– */
@supports (-webkit-touch-callout: none) {
    .nav-tabs {
        -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
        -webkit-overflow-scrolling: touch;
    }
    
    input, select, textarea {
        -webkit-appearance: none;
        border-radius: 8px;
    }
    
    .btn {
        -webkit-appearance: none;
    }
}

/* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
@media (max-width: 768px) and (orientation: landscape) {
    .header {
        padding: max(15px, env(safe-area-inset-top) + 10px) 20px 15px 20px;
    }
    
    .header h1 {
        font-size: 1.8rem;
        margin-bottom: 5px;
    }
    
    .header .subtitle {
        font-size: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .modal-content {
        max-height: 80vh;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šç‰¹æ®Šå†…å®¹çš„å¤„ç† */
.detail-item[style*="grid-column: 1 / -1"] .detail-value {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-top: 2px;
}

/* ğŸ”¥ æ–°å¢ï¼šè¯·å‡ä¿¡æ¯æ ·å¼ä¼˜åŒ– */
.detail-item .detail-value[style*="color: #f39c12"] {
    background: rgba(243, 156, 18, 0.1);
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    line-height: 1.3;
}

/* ğŸ”¥ æ–°å¢ï¼šæ•°æ®è¡¨æ ¼å®¹å™¨ */
.data-table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* ğŸ”¥ æ–°å¢ï¼šå­¦ç”Ÿè¯¦æƒ…å†…å®¹æ ·å¼ */
.student-detail-content .card {
    margin-bottom: 20px;
}

.student-detail-content .card:last-child {
    margin-bottom: 0;
}

/* ğŸ”¥ æ–°å¢ï¼šåŒæ­¥æ—¥å¿—æ ·å¼ */
.sync-logs {
    max-height: 400px;
    overflow-y: auto;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 14px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* ğŸ”¥ æ–°å¢ï¼šç»ƒç´çŠ¶æ€ç‰¹æ®Šæ ·å¼ */
.practice-status-card .student-header {
    position: relative;
}

.practice-status-card .practice-indicator {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.7;
        transform: scale(1.1);
    }
}

/* ğŸ”¥ æ–°å¢ï¼šçŠ¶æ€æ ‡ç­¾çš„ç»Ÿä¸€æ ·å¼ */
.student-status,
.practice-duration {
    display: inline-block;
    white-space: nowrap;
    text-align: center;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    transition: all 0.15s ease-in-out;
}

/* ğŸ”¥ æ–°å¢ï¼šè€ƒå‹¤å†å²æ—¶é—´è½´å¢å¼º */
.history-timeline {
    padding: 10px 0;
    justify-content: flex-start;
}

.history-day {
    position: relative;
    border: 2px solid transparent;
    transition: all 0.2s ease;
}

.history-day:hover {
    transform: scale(1.15);
    z-index: 1;
}

.history-day.present {
    background: var(--success-color);
    border-color: var(--success-color);
}

.history-day.absent {
    background: var(--danger-color);
    border-color: var(--danger-color);
}

.history-day.excused {
    background: var(--warning-color);
    border-color: var(--warning-color);
}

.history-day.no-data {
    background: #f8f9fa;
    border-color: #dee2e6;
    color: #6c757d;
}

.history-day.low-efficiency {
    background: #f39c12;
    border-color: #f39c12;
    color: white;
}

.history-day.practicing-unscheduled {
    background: #9b59b6;
    border-color: #9b59b6;
    color: white;
}

.history-day.weekend {
    background: #95a5a6;
    border-color: #95a5a6;
    color: white;
}

/* ğŸ”¥ æ–°å¢ï¼šå·¥å…·æç¤ºæ ·å¼ */
[title] {
    position: relative;
}

/* ğŸ”¥ æ–°å¢ï¼šè¡¨æ ¼å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .data-table-container {
        margin: 0 -20px;
        padding: 0 20px;
    }
    
    .data-table {
        min-width: 600px;
    }
    
    .data-table th,
    .data-table td {
        padding: 10px 8px;
        font-size: 13px;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šç­›é€‰å™¨å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .filters {
        padding: 15px;
        margin: 0 -5px 20px -5px;
    }
    
    .filter-row {
        gap: 12px;
    }
    
    .filter-group {
        min-width: auto;
        width: 100%;
    }
    
    .filter-select,
    .filter-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }
    
    .filter-select:focus,
    .filter-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}

/* ğŸ”¥ æ–°å¢ï¼šæ—¥æœŸé€‰æ‹©å™¨å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .date-picker {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 15px;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-bottom: 20px;
    }
    
    .date-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
    }
    
    .date-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}

/* ğŸ”¥ æ–°å¢ï¼šæ¨¡æ€æ¡†å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .modal {
        padding: 0;
        align-items: flex-end;
    }
    
    .modal-content {
        width: 100%;
        max-width: 100%;
        max-height: 90vh;
        border-radius: 20px 20px 0 0;
        margin: 0;
        animation: slideUpIn 0.3s ease;
    }
    
    @keyframes slideUpIn {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-header {
        padding-bottom: 20px;
        border-bottom: 2px solid #eee;
    }
    
    .modal-title {
        font-size: 1.3rem;
    }
    
    .modal-close {
        width: 40px;
        height: 40px;
        font-size: 1.8rem;
        border-radius: 50%;
        background: #f8f9fa;
    }
    
    .modal-close:hover {
        background: #e9ecef;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šç©ºçŠ¶æ€å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .empty-state {
        padding: 40px 15px;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .empty-state-title {
        font-size: 1.2rem;
        margin-bottom: 8px;
    }
    
    .empty-state-description {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .practice-empty-state {
        padding: 30px 15px;
    }
    
    .practice-empty-state-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
    }
    
    .practice-empty-state-title {
        font-size: 1.1rem;
        margin-bottom: 6px;
    }
    
    .practice-empty-state-description {
        font-size: 0.85rem;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šåŠ è½½åŠ¨ç”»å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .loading {
        padding: 30px 20px;
    }
    
    .spinner {
        width: 35px;
        height: 35px;
        border-width: 3px;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šç»Ÿè®¡å¡ç‰‡åŠ¨ç”»å¢å¼º */
.stat-card {
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.stat-card:hover::before {
    left: 100%;
}

/* ğŸ”¥ æ–°å¢ï¼šæŒ‰é’®ç»„å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .action-buttons {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 15px;
        margin: 20px -15px -15px -15px;
        border-top: 1px solid #eee;
        z-index: 10;
    }
    
    .export-options {
        flex-direction: column;
        gap: 8px;
        margin-top: 15px;
    }
    
    .export-options .btn {
        width: 100%;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šæ·±è‰²æ¨¡å¼æ”¯æŒï¼ˆå¯é€‰ï¼‰ */
@media (prefers-color-scheme: dark) {
    :root {
        --background-color: #1a1a1a;
        --text-color: #ffffff;
        --border-color: #333333;
    }
    
    /* å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šæ·±è‰²æ¨¡å¼æ ·å¼ */
}

/* ğŸ”¥ æ–°å¢ï¼šæ‰“å°æ ·å¼ä¼˜åŒ– */
@media print {
    .language-switcher,
    .connection-status,
    .nav-tabs,
    .action-buttons,
    .btn,
    .modal {
        display: none !important;
    }
    
    .container {
        max-width: none;
        padding: 0;
    }
    
    .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .student-card,
    .practice-status-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šé«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
@media (prefers-contrast: high) {
    .student-card,
    .practice-status-card,
    .stat-card {
        border: 2px solid var(--text-color);
    }
    
    .btn {
        border: 2px solid currentColor;
    }
    
    .history-day {
        border-width: 3px;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šå‡å°‘åŠ¨ç”»æ¨¡å¼æ”¯æŒ */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .practice-indicator {
        animation: none;
    }
    
    .spinner {
        animation: none;
        border-top-color: var(--primary-color);
    }
}
/* ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®çš„å“åº”å¼ç½‘æ ¼ */
@media (min-width: 768px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1024px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (min-width: 1400px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

/* ğŸ”¥ æ–°å¢ï¼šç¡®ä¿å¡ç‰‡æœ‰è¶³å¤Ÿçš„æœ€å°å®½åº¦ */
@media (min-width: 1400px) {
    .student-card,
    .practice-status-card {
        min-width: 280px;
    }
}

@media (min-width: 1600px) {
    .student-card,
    .practice-status-card {
        min-width: 320px;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šç§»åŠ¨ç«¯ç´§å‡‘å¡ç‰‡æ ·å¼ */
@media (max-width: 768px) {
    .student-card,
    .practice-status-card {
        min-height: 200px;
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .student-header {
        margin-bottom: 10px;
    }
    
    .student-name {
        font-size: 1.1rem;
        line-height: 1.2;
    }
    
    .student-status,
    .practice-duration {
        padding: 3px 8px;
        font-size: 0.75rem;
        border-radius: 12px;
    }
    
    .student-details,
    .practice-details {
        grid-template-columns: 1fr;
        gap: 8px;
        margin-bottom: 10px;
    }
    
    .detail-item {
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .detail-item:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-size: 0.75rem;
        margin-bottom: 2px;
        color: #888;
    }
    
    .detail-value {
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .attendance-history {
        margin-top: 10px;
        padding-top: 10px;
    }
    
    .history-timeline {
        gap: 6px;
        justify-content: center;
    }
    
    .history-day {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
    }
    
    .practice-indicator {
        width: 8px;
        height: 8px;
        top: 10px;
        right: 10px;
    }
}

/* ğŸ”¥ æ–°å¢ï¼šå®æ—¶ç»ƒç´ç­›é€‰å™¨æ ·å¼ */
.practice-filters {
    background: white;
    padding: 15px;
    border-radius: var(--radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow);
}

.practice-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
}

.practice-filter-group {
    display: flex;
    flex-direction: column;
    min-width: 120px;
    flex: 1;
}

.practice-filter-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 4px;
    font-weight: 500;
}

.practice-filter-select,
.practice-filter-input {
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease;
    background: white;
}

.practice-filter-select:focus,
.practice-filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

/* ç§»åŠ¨ç«¯ç­›é€‰å™¨ä¼˜åŒ– */
@media (max-width: 768px) {
    .practice-filters {
        padding: 12px;
        margin: 0 -5px 15px -5px;
    }
    
    .practice-filter-row {
        flex-direction: column;
        gap: 10px;
    }
    
    .practice-filter-group {
        min-width: auto;
        width: 100%;
    }
    
    .practice-filter-select,
    .practice-filter-input {
        width: 100%;
        padding: 10px 12px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }
    
    .practice-filter-select:focus,
    .practice-filter-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}

/* ğŸ”¥ æ–°å¢ï¼šå¿«é€Ÿç­›é€‰æ ‡ç­¾æ ·å¼ */
.quick-filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.quick-filter-tag {
    padding: 4px 10px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 15px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
}

.quick-filter-tag:hover {
    background: #e9ecef;
}

.quick-filter-tag.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

@media (max-width: 768px) {
    .quick-filter-tags {
        justify-content: center;
        margin-top: 8px;
    }
    
    .quick-filter-tag {
        padding: 6px 12px;
        font-size: 0.75rem;
    }
}

</style>
</head>

<body>
<div class="container">
    <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
    <div class="language-switcher">
        <button class="lang-btn active" onclick="switchLanguage('zh')" data-lang="zh">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="switchLanguage('en')" data-lang="en">EN</button>
    </div>

    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="connectionStatus" class="connection-status offline">
        <span data-i18n="status.offline">ğŸ”´ ç¦»çº¿æ¨¡å¼</span>
    </div>

    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1><span data-i18n="header.title">ğŸ¼ é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡</span></h1>
        <div class="subtitle" data-i18n="header.subtitle">å®æ—¶ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ</div>
    </div>

    <!-- å¯¼èˆªæ ‡ç­¾ -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')">
            <span data-i18n="nav.dashboard">ğŸ“Š è€ƒå‹¤æ¦‚è§ˆ</span>
        </button>
        <button class="nav-tab" onclick="switchTab('students')">
            <span data-i18n="nav.students">ğŸ‘¥ å­¦ç”Ÿè¯¦æƒ…</span>
        </button>
        <button class="nav-tab" onclick="switchTab('reports')">
            <span data-i18n="nav.reports">ğŸ“ˆ å†å²æŠ¥å‘Š</span>
        </button>
        <button class="nav-tab" onclick="switchTab('sync')">
            <span data-i18n="nav.sync">ğŸ”„ æ•°æ®åŒæ­¥</span>
        </button>
    </div>

    <!-- è€ƒå‹¤æ¦‚è§ˆæ ‡ç­¾é¡µ -->
    <div id="dashboardTab" class="tab-content">
        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label" data-i18n="stats.total">æ€»å­¦ç”Ÿæ•°</div>
                <div class="stat-description" data-i18n="stats.total.desc">å·²ç™»è®°å­¦ç”Ÿ</div>
            </div>
            <div class="stat-card present">
                <div class="stat-number" id="presentCount">0</div>
                <div class="stat-label" data-i18n="stats.present">æ­£å¸¸å‡ºå‹¤</div>
                <div class="stat-description" data-i18n="stats.present.desc">ä»Šæ—¥å‡ºå‹¤ç‡</div>
            </div>
            <div class="stat-card absent">
                <div class="stat-number" id="absentCount">0</div>
                <div class="stat-label" data-i18n="stats.absent">ç¼ºå‹¤å­¦ç”Ÿ</div>
                <div class="stat-description" data-i18n="stats.absent.desc">éœ€è¦å…³æ³¨</div>
            </div>
            <div class="stat-card excused">
                <div class="stat-number" id="excusedCount">0</div>
                <div class="stat-label" data-i18n="stats.excused">è¯·å‡å­¦ç”Ÿ</div>
                <div class="stat-description" data-i18n="stats.excused.desc">å·²æ‰¹å‡†è¯·å‡</div>
            </div>
        </div>

        <!-- è¯·å‡ä¿¡æ¯é¢æ¿ -->
        <div class="card" id="excuseInfoPanel" style="display: none;">
            <h3 data-i18n="excuse.title">ğŸ“ ä»Šæ—¥è¯·å‡ä¿¡æ¯</h3>
            <div id="excuseInfoContainer">
                <!-- è¯·å‡ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- å®æ—¶ç»ƒç´çŠ¶æ€ -->
        <div class="card">
            <h3 data-i18n="practice.title">ğŸ¹ å®æ—¶ç»ƒç´çŠ¶æ€</h3>
            <div class="date-picker">
                <span style="color: #666; font-size: 14px;">
                    <span data-i18n="practice.current_time">å½“å‰æ—¶é—´ï¼š</span>
                    <span id="currentTime"></span>
                </span>
                <button class="btn btn-primary" onclick="refreshPracticeStatus()">
                    <span>ğŸ”„</span> <span data-i18n="btn.refresh_status">åˆ·æ–°çŠ¶æ€</span>
                </button>
            </div>

            <!-- ğŸ”¥ æ–°å¢ï¼šå®æ—¶ç»ƒç´ç­›é€‰å™¨ -->
            <div class="practice-filters">
                <div class="practice-filter-row">
                    <div class="practice-filter-group">
                        <label class="practice-filter-label" data-i18n="filter.major">ä¸“ä¸šç­›é€‰</label>
                        <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
                            <option value="" data-i18n="filter.all_majors">æ‰€æœ‰ä¸“ä¸š</option>
                        </select>
                    </div>
                    <div class="practice-filter-group">
                        <label class="practice-filter-label" data-i18n="filter.grade">å¹´çº§ç­›é€‰</label>
                        <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
                            <option value="" data-i18n="filter.all_grades">æ‰€æœ‰å¹´çº§</option>
                        </select>
                    </div>
                    <div class="practice-filter-group">
                        <label class="practice-filter-label" data-i18n="filter.search">æœç´¢å­¦ç”Ÿ</label>
                        <input type="text" id="practiceStudentSearch" class="practice-filter-input" 
                               data-i18n-placeholder="filter.search_placeholder" placeholder="è¾“å…¥å­¦ç”Ÿå§“å..." 
                               oninput="filterPracticeStatus()">
                    </div>
                </div>
                
                <!-- ğŸ”¥ æ–°å¢ï¼šå¿«é€Ÿç­›é€‰æ ‡ç­¾ -->
                <div class="quick-filter-tags" id="practiceQuickFilters">
                    <!-- å¿«é€Ÿç­›é€‰æ ‡ç­¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div id="practiceStatusContainer">
                <div id="practiceStudentList" class="student-grid">
                    <!-- æ­£åœ¨ç»ƒç´çš„å­¦ç”Ÿå¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥è€ƒå‹¤å¿«ç…§ -->
        <div class="card">
            <h3 data-i18n="attendance.title">ğŸ“… ä»Šæ—¥è€ƒå‹¤å¿«ç…§</h3>
            <div class="date-picker">
                <label for="dateSelect" data-i18n="attendance.select_date">é€‰æ‹©æ—¥æœŸï¼š</label>
                <input type="date" id="dateSelect" class="date-input" onchange="loadAttendanceData()">
                <button class="btn btn-primary" onclick="refreshData()">
                    <span>ğŸ”„</span> <span data-i18n="btn.refresh_data">åˆ·æ–°æ•°æ®</span>
                </button>
            </div>
            <div id="todaySnapshot" class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- å­¦ç”Ÿè¯¦æƒ…æ ‡ç­¾é¡µ -->
    <div id="studentsTab" class="tab-content" style="display: none;">
        <!-- ç­›é€‰å™¨ -->
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.major">ä¸“ä¸šç­›é€‰</label>
                    <select id="majorFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_majors">æ‰€æœ‰ä¸“ä¸š</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.grade">å¹´çº§ç­›é€‰</label>
                    <select id="gradeFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_grades">æ‰€æœ‰å¹´çº§</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.status">è€ƒå‹¤çŠ¶æ€</label>
                    <select id="statusFilter" class="filter-select" onchange="filterStudents()">
                        <option value="" data-i18n="filter.all_status">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="present" data-i18n="status.present">æ­£å¸¸å‡ºå‹¤</option>
                        <option value="absent" data-i18n="status.absent">ç¼ºå‹¤</option>
                        <option value="excused" data-i18n="status.excused">è¯·å‡</option>
                        <option value="low-efficiency" data-i18n="status.low_efficiency">ä½æ•ˆå‡ºå‹¤</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" data-i18n="filter.search">æœç´¢å­¦ç”Ÿ</label>
                    <input type="text" id="studentSearch" class="filter-input" data-i18n-placeholder="filter.search_placeholder" placeholder="è¾“å…¥å­¦ç”Ÿå§“å..." oninput="filterStudents()">
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="refreshData()">
                <span>ğŸ”„</span> <span data-i18n="btn.refresh_data">åˆ·æ–°æ•°æ®</span>
            </button>
        </div>

        <!-- å­¦ç”Ÿåˆ—è¡¨ -->
        <div id="studentList" class="student-grid">
            <!-- å­¦ç”Ÿå¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- å†å²æŠ¥å‘Šæ ‡ç­¾é¡µ -->
    <div id="reportsTab" class="tab-content" style="display: none;">
        <div class="card">
            <h3 data-i18n="report.title">ğŸ“ˆ è€ƒå‹¤å†å²åˆ†æ</h3>
            
            <!-- æ—¥æœŸèŒƒå›´é€‰æ‹© -->
            <div class="date-picker">
                <label for="startDate" data-i18n="report.start_date">å¼€å§‹æ—¥æœŸï¼š</label>
                <input type="date" id="startDate" class="date-input">
                <label for="endDate" data-i18n="report.end_date">ç»“æŸæ—¥æœŸï¼š</label>
                <input type="date" id="endDate" class="date-input">
                <button class="btn btn-primary" onclick="generateReport()">
                    <span>ğŸ“Š</span> <span data-i18n="btn.generate_report">ç”ŸæˆæŠ¥å‘Š</span>
                </button>
            </div>

            <!-- æŠ¥å‘Šå†…å®¹ -->
            <div id="reportContent">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“Š</div>
                    <div class="empty-state-title" data-i18n="report.empty.title">é€‰æ‹©æ—¥æœŸèŒƒå›´ç”ŸæˆæŠ¥å‘Š</div>
                    <div class="empty-state-description" data-i18n="report.empty.desc">é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼Œç„¶åç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"æŒ‰é’®æŸ¥çœ‹è¯¦ç»†çš„è€ƒå‹¤åˆ†æ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®åŒæ­¥æ ‡ç­¾é¡µ -->
    <div id="syncTab" class="tab-content" style="display: none;">
        <div class="card">
            <h3 data-i18n="sync.title">ğŸ”„ æ•°æ®åŒæ­¥ç®¡ç†</h3>
            
            <!-- åŒæ­¥çŠ¶æ€ -->
            <div class="card success" id="syncStatus">
                <h4 data-i18n="sync.status">åŒæ­¥çŠ¶æ€</h4>
                <p id="syncStatusText" data-i18n="sync.checking">æ­£åœ¨æ£€æŸ¥è¿æ¥çŠ¶æ€...</p>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="forceSyncData()">
                        <span>ğŸ”„</span> <span data-i18n="btn.force_sync">å¼ºåˆ¶åŒæ­¥</span>
                    </button>
                    <button class="btn btn-warning" onclick="clearLocalCache()">
                        <span>ğŸ—‘ï¸</span> <span data-i18n="btn.clear_cache">æ¸…é™¤ç¼“å­˜</span>
                    </button>
                </div>
            </div>

            <!-- åŒæ­¥æ—¥å¿— -->
            <div class="card">
                <h4 data-i18n="sync.logs">ğŸ“‹ åŒæ­¥æ—¥å¿—</h4>
                <div id="syncLogs" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 14px;">
                    <!-- åŒæ­¥æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å­¦ç”Ÿè¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="studentDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="studentDetailTitle" data-i18n="student.detail.title">å­¦ç”Ÿè¯¦æƒ…</h3>
            <button class="modal-close" onclick="closeModal('studentDetailModal')">&times;</button>
        </div>
        <div id="studentDetailContent">
            <!-- å­¦ç”Ÿè¯¦ç»†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>
</div>

<script>
// ğŸŒ å›½é™…åŒ–é…ç½®
const i18n = {
    zh: {
        // å¤´éƒ¨
        'header.title': 'ğŸ¼ é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡',
        'header.subtitle': 'å®æ—¶ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ',
        
        // å¯¼èˆª
        'nav.dashboard': 'ğŸ“Š è€ƒå‹¤æ¦‚è§ˆ',
        'nav.students': 'ğŸ‘¥ å­¦ç”Ÿè¯¦æƒ…',
        'nav.reports': 'ğŸ“ˆ å†å²æŠ¥å‘Š',
        'nav.sync': 'ğŸ”„ æ•°æ®åŒæ­¥',
        
        // çŠ¶æ€
        'status.online': 'å·²è¿æ¥',
        'status.offline': 'ç¦»çº¿æ¨¡å¼',
        'status.syncing': 'åŒæ­¥ä¸­',
        'status.present': 'æ­£å¸¸å‡ºå‹¤',
        'status.absent': 'ç¼ºå‹¤',
        'status.excused': 'è¯·å‡',
        'status.low_efficiency': 'ä½æ•ˆå‡ºå‹¤',
        'status.practicing_unscheduled': 'æ—¶é—´æ®µå¤–ç»ƒç´',
        'status.weekend': 'å‘¨æœ«',
        'status.no_data': 'æ— æ•°æ®',
        
        // ç»Ÿè®¡
        'stats.total': 'æ€»å­¦ç”Ÿæ•°',
        'stats.total.desc': 'å·²ç™»è®°å­¦ç”Ÿ',
        'stats.present': 'æ­£å¸¸å‡ºå‹¤',
        'stats.present.desc': 'ä»Šæ—¥å‡ºå‹¤ç‡',
        'stats.absent': 'ç¼ºå‹¤å­¦ç”Ÿ',
        'stats.absent.desc': 'éœ€è¦å…³æ³¨',
        'stats.excused': 'è¯·å‡å­¦ç”Ÿ',
        'stats.excused.desc': 'å·²æ‰¹å‡†è¯·å‡',
        'stats.practicing': 'æ­£åœ¨ç»ƒç´',
        'stats.not_practicing': 'æœªåœ¨ç»ƒç´',
        
        // æŒ‰é’®
        'btn.refresh_status': 'åˆ·æ–°çŠ¶æ€',
        'btn.refresh_data': 'åˆ·æ–°æ•°æ®',
        'btn.generate_report': 'ç”ŸæˆæŠ¥å‘Š',
        'btn.force_sync': 'å¼ºåˆ¶åŒæ­¥',
        'btn.clear_cache': 'æ¸…é™¤ç¼“å­˜',
        'btn.close': 'å…³é—­',
        
        // ç­›é€‰å™¨
        'filter.major': 'ä¸“ä¸šç­›é€‰',
        'filter.grade': 'å¹´çº§ç­›é€‰',
        'filter.status': 'è€ƒå‹¤çŠ¶æ€',
        'filter.search': 'æœç´¢å­¦ç”Ÿ',
        'filter.all_majors': 'æ‰€æœ‰ä¸“ä¸š',
        'filter.all_grades': 'æ‰€æœ‰å¹´çº§',
        'filter.all_status': 'æ‰€æœ‰çŠ¶æ€',
        'filter.search_placeholder': 'è¾“å…¥å­¦ç”Ÿå§“å...',
        
        // ç»ƒç´çŠ¶æ€
        'practice.title': 'ğŸ¹ å®æ—¶ç»ƒç´çŠ¶æ€',
        'practice.current_time': 'å½“å‰æ—¶é—´ï¼š',
        'practice.empty.title': 'å½“å‰æ²¡æœ‰å­¦ç”Ÿåœ¨ç»ƒç´',
        'practice.empty.desc.weekday': 'å·¥ä½œæ—¥æ—¶é—´ï¼Œç­‰å¾…å­¦ç”Ÿå¼€å§‹ç»ƒç´',
        'practice.empty.desc.weekend': 'å‘¨æœ«æ—¶é—´ï¼Œå­¦ç”Ÿå¯è‡ªä¸»å®‰æ’ç»ƒç´',
        'practice.duration': 'ç»ƒç´æ—¶é•¿',
        'practice.room': 'æ‰€åœ¨ç´æˆ¿',
        'practice.start_time': 'å¼€å§‹æ—¶é—´',
        'practice.type.weekend': 'å‘¨æœ«è‡ªä¸»ç»ƒç´',
        'practice.type.unscheduled': 'æ—¶é—´æ®µå¤–ç»ƒç´',
        
        // è€ƒå‹¤
        'attendance.title': 'ğŸ“… ä»Šæ—¥è€ƒå‹¤å¿«ç…§',
        'attendance.select_date': 'é€‰æ‹©æ—¥æœŸï¼š',
        'attendance.history': 'æœ€è¿‘7å¤©è€ƒå‹¤',
        'attendance.rate': 'å‡ºå‹¤ç‡',
        
        // å­¦ç”Ÿä¿¡æ¯
        'student.name': 'å§“å',
        'student.major': 'ä¸“ä¸š',
        'student.grade': 'å¹´çº§',
        'student.time_slot': 'æ—¶é—´æ®µ',
        'student.practice_duration': 'ç»ƒç´æ—¶é•¿',
        'student.room': 'æ‰€åœ¨ç´æˆ¿',
        'student.not_in_room': 'ä¸åœ¨ç´æˆ¿',
        'student.detail.title': 'å­¦ç”Ÿè¯¦æƒ…',
        'student.basic_info': 'åŸºæœ¬ä¿¡æ¯',
        'student.today_attendance': 'ä»Šæ—¥è€ƒå‹¤',
        'student.attendance_stats': 'è€ƒå‹¤ç»Ÿè®¡',
        'student.history_records': 'å†å²è®°å½•',
        'student.no_schedule': 'æ— ',
        'student.self_practice': 'è‡ªä¸»ç»ƒç´',
        'student.unknown_major': 'æœªçŸ¥ä¸“ä¸š',
        'student.not_set': 'æœªè®¾ç½®',
        
        // è¯·å‡
        'excuse.title': 'ğŸ“ ä»Šæ—¥è¯·å‡ä¿¡æ¯',
        'excuse.reason': 'è¯·å‡åŸå› ',
        'excuse.time': 'è¯·å‡æ—¶é—´',
        'excuse.approver': 'æ‰¹å‡†äºº',
        'excuse.submit_time': 'æäº¤æ—¶é—´',
        'excuse.status.approved': 'å·²æ‰¹å‡†',
        'excuse.status.pending': 'å¾…å®¡æ ¸',
        'excuse.status.rejected': 'å·²æ‹’ç»',
        'excuse.not_filled': 'æœªå¡«å†™',
        
        // æŠ¥å‘Š
        'report.title': 'ğŸ“ˆ è€ƒå‹¤å†å²åˆ†æ',
        'report.start_date': 'å¼€å§‹æ—¥æœŸï¼š',
        'report.end_date': 'ç»“æŸæ—¥æœŸï¼š',
        'report.empty.title': 'é€‰æ‹©æ—¥æœŸèŒƒå›´ç”ŸæˆæŠ¥å‘Š',
        'report.empty.desc': 'é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼Œç„¶åç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"æŒ‰é’®æŸ¥çœ‹è¯¦ç»†çš„è€ƒå‹¤åˆ†æ',
        'report.analysis_title': 'ğŸ“Š è€ƒå‹¤åˆ†ææŠ¥å‘Š',
        'report.period': 'ç»Ÿè®¡å‘¨æœŸï¼š',
        'report.participants': 'å‚ä¸å­¦ç”Ÿï¼š',
        'report.daily_trend': 'ğŸ“ˆ æ¯æ—¥è€ƒå‹¤è¶‹åŠ¿',
        'report.student_stats': 'ğŸ‘¥ å­¦ç”Ÿè€ƒå‹¤ç»Ÿè®¡',
        'report.date': 'æ—¥æœŸ',
        'report.total': 'æ€»äººæ•°',
        'report.days': 'å¤©',
        'report.people': 'äºº',
        'report.regenerate': 'é‡æ–°ç”Ÿæˆ',
        
        // åŒæ­¥
        'sync.title': 'ğŸ”„ æ•°æ®åŒæ­¥ç®¡ç†',
        'sync.status': 'åŒæ­¥çŠ¶æ€',
        'sync.checking': 'æ­£åœ¨æ£€æŸ¥è¿æ¥çŠ¶æ€...',
        'sync.connected': 'âœ… å·²è¿æ¥åˆ°Firebaseæ•°æ®åº“',
        'sync.disconnected': 'âŒ æœªè¿æ¥åˆ°æ•°æ®åº“',
        'sync.realtime': 'æ•°æ®æ­£åœ¨å®æ—¶åŒæ­¥ä¸­...',
        'sync.offline_mode': 'å½“å‰å¤„äºç¦»çº¿æ¨¡å¼ï¼Œéƒ¨åˆ†åŠŸèƒ½å—é™',
        'sync.last_sync': 'æœ€ååŒæ­¥æ—¶é—´: ',
        'sync.check_network': 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
        'sync.logs': 'ğŸ“‹ åŒæ­¥æ—¥å¿—',
        'sync.offline': 'ç¦»çº¿æ¨¡å¼',
        'sync.realtime_sync': 'å®æ—¶åŒæ­¥',
        
        // æ¶ˆæ¯
        'msg.no_data': 'æš‚æ— æ•°æ®',
        'msg.loading': 'åŠ è½½ä¸­...',
        'msg.network_required': 'éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…',
        'msg.sync_required': 'éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½åŒæ­¥æ•°æ®',
        'msg.clear_cache_confirm': 'ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç¦»çº¿æ•°æ®ã€‚',
        'msg.cache_cleared': 'æœ¬åœ°ç¼“å­˜å·²æ¸…é™¤',
        'msg.date_range_error': 'å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ',
        'msg.select_dates': 'è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ',
        'msg.student_not_found': 'æœªæ‰¾åˆ°å­¦ç”Ÿä¿¡æ¯',
        
        // æ—¶é—´
        'time.minutes': 'åˆ†é’Ÿ',
        'time.hours': 'å°æ—¶',
        'time.seconds': 'ç§’',
        'time.no_practice': '0åˆ†é’Ÿ',
        
        // ç©ºçŠ¶æ€
        'empty.no_students': 'æš‚æ— å­¦ç”Ÿæ•°æ®',
        'empty.ensure_sync': 'è¯·ç¡®ä¿å­¦ç”Ÿæ•°æ®å·²æ­£ç¡®åŒæ­¥',
        'empty.no_attendance': 'è¿˜æ²¡æœ‰è€ƒå‹¤è®°å½•',
        'empty.offline_no_data': 'ç¦»çº¿æ¨¡å¼ä¸‹æ²¡æœ‰æ‰¾åˆ°è¯¥æ—¥æœŸçš„è€ƒå‹¤æ•°æ®',
        'empty.load_failed': 'åŠ è½½å¤±è´¥',
        'empty.network_error': 'æ— æ³•åŠ è½½è€ƒå‹¤æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',

        // ç­›é€‰
        'filter.clear': 'æ¸…é™¤',
        'filter.no_results': 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿ',
        'filter.try_different': 'è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶',
        'practice.scheduled': 'è§„å®šæ—¶æ®µ',
        'practice.unscheduled': 'æ—¶æ®µå¤–',
        'practice.total': 'æ€»æ—¶é•¿',
        'report.last_30_days': 'æœ€è¿‘30å¤©',
        'report.to': 'è‡³',
    },
    
    en: {
        // Header
        'header.title': 'ğŸ¼ Qingdao Yehudi Menuhin School',
        'header.subtitle': 'Real-time Practice Tracking System',
        
        // Navigation
        'nav.dashboard': 'ğŸ“Š Dashboard',
        'nav.students': 'ğŸ‘¥ Students',
        'nav.reports': 'ğŸ“ˆ Reports',
        'nav.sync': 'ğŸ”„ Sync',
        
        // Status
        'status.online': 'Online',
        'status.offline': 'Offline',
        'status.syncing': 'Syncing',

        'status.present': 'Present',
        'status.absent': 'Absent',
        'status.excused': 'Excused',
        'status.low_efficiency': 'Low Efficiency',
        'status.practicing_unscheduled': 'Unscheduled Practice',
        'status.weekend': 'Weekend',
        'status.no_data': 'No Data',
        
        // Statistics
        'stats.total': 'Total Students',
        'stats.total.desc': 'Registered Students',
        'stats.present': 'Present',
        'stats.present.desc': 'Today\'s Attendance',
        'stats.absent': 'Absent',
        'stats.absent.desc': 'Need Attention',
        'stats.excused': 'Excused',
        'stats.excused.desc': 'Approved Leave',
        'stats.practicing': 'Practicing',
        'stats.not_practicing': 'Not Practicing',
        
        // Buttons
        'btn.refresh_status': 'Refresh Status',
        'btn.refresh_data': 'Refresh Data',
        'btn.generate_report': 'Generate Report',
        'btn.force_sync': 'Force Sync',
        'btn.clear_cache': 'Clear Cache',
        'btn.close': 'Close',
        
        // Filters
        'filter.major': 'Major Filter',
        'filter.grade': 'Grade Filter',
        'filter.status': 'Status Filter',
        'filter.search': 'Search Student',
        'filter.all_majors': 'All Majors',
        'filter.all_grades': 'All Grades',
        'filter.all_status': 'All Status',
        'filter.search_placeholder': 'Enter student name...',
        
        // Practice Status
        'practice.title': 'ğŸ¹ Real-time Practice Status',
        'practice.current_time': 'Current Time: ',
        'practice.empty.title': 'No students practicing currently',
        'practice.empty.desc.weekday': 'Weekday time, waiting for students to start practicing',
        'practice.empty.desc.weekend': 'Weekend time, students can arrange practice freely',
        'practice.duration': 'Practice Duration',
        'practice.room': 'Practice Room',
        'practice.start_time': 'Start Time',
        'practice.type.weekend': 'Weekend Self Practice',
        'practice.type.unscheduled': 'Unscheduled Practice',
        
        // Attendance
        'attendance.title': 'ğŸ“… Today\'s Attendance Snapshot',
        'attendance.select_date': 'Select Date: ',
        'attendance.history': 'Last 7 Days Attendance',
        'attendance.rate': 'Attendance Rate',
        
        // Student Information
        'student.name': 'Name',
        'student.major': 'Major',
        'student.grade': 'Grade',
        'student.time_slot': 'Time Slot',
        'student.practice_duration': 'Practice Duration',
        'student.room': 'Practice Room',
        'student.not_in_room': 'Not in Room',
        'student.detail.title': 'Student Details',
        'student.basic_info': 'Basic Information',
        'student.today_attendance': 'Today\'s Attendance',
        'student.attendance_stats': 'Attendance Statistics',
        'student.history_records': 'History Records',
        'student.no_schedule': 'None',
        'student.self_practice': 'Self Practice',
        'student.unknown_major': 'Unknown Major',
        'student.not_set': 'Not Set',
        
        // Leave/Excuse
        'excuse.title': 'ğŸ“ Today\'s Leave Information',
        'excuse.reason': 'Leave Reason',
        'excuse.time': 'Leave Time',
        'excuse.approver': 'Approver',
        'excuse.submit_time': 'Submit Time',
        'excuse.status.approved': 'Approved',
        'excuse.status.pending': 'Pending',
        'excuse.status.rejected': 'Rejected',
        'excuse.not_filled': 'Not Filled',
        
        // Reports
        'report.title': 'ğŸ“ˆ Attendance History Analysis',
        'report.start_date': 'Start Date: ',
        'report.end_date': 'End Date: ',
        'report.empty.title': 'Select date range to generate report',
        'report.empty.desc': 'Select start and end dates, then click "Generate Report" to view detailed attendance analysis',
        'report.analysis_title': 'ğŸ“Š Attendance Analysis Report',
        'report.period': 'Period: ',
        'report.participants': 'Participants: ',
        'report.daily_trend': 'ğŸ“ˆ Daily Attendance Trend',
        'report.student_stats': 'ğŸ‘¥ Student Attendance Statistics',
        'report.date': 'Date',
        'report.total': 'Total',
        'report.days': ' days',
        'report.people': ' people',
        'report.regenerate': 'Regenerate',
        
        // Sync
        'sync.title': 'ğŸ”„ Data Sync Management',
        'sync.status': 'Sync Status',
        'sync.checking': 'Checking connection status...',
        'sync.connected': 'âœ… Connected to Firebase database',
        'sync.disconnected': 'âŒ Not connected to database',
        'sync.realtime': 'Data is syncing in real-time...',
        'sync.offline_mode': 'Currently in offline mode, some features are limited',
        'sync.last_sync': 'Last sync time: ',
        'sync.check_network': 'Please check network connection',
        'sync.logs': 'ğŸ“‹ Sync Logs',
        'sync.offline': 'Offline Mode',
        'sync.realtime_sync': 'Real-time Sync',
        
        // Messages
        'msg.no_data': 'No Data',
        'msg.loading': 'Loading...',
        'msg.network_required': 'Network connection required to view student details',
        'msg.sync_required': 'Network connection required to sync data',
        'msg.clear_cache_confirm': 'Are you sure you want to clear local cache? This will delete all offline data.',
        'msg.cache_cleared': 'Local cache cleared',
        'msg.date_range_error': 'Start date cannot be later than end date',
        'msg.select_dates': 'Please select start and end dates',
        'msg.student_not_found': 'Student information not found',
        
        // Time
        'time.minutes': ' minutes',
        'time.hours': ' hours',
        'time.seconds': ' seconds',
        'time.no_practice': '0 minutes',
        
        // Empty States
        'empty.no_students': 'No student data',
        'empty.ensure_sync': 'Please ensure student data is properly synced',
        'empty.no_attendance': 'No attendance records yet',
        'empty.offline_no_data': 'No attendance data found for this date in offline mode',
        'empty.load_failed': 'Load Failed',
        'empty.network_error': 'Unable to load attendance data, please check network connection',
        //shaixuan
        'filter.clear': 'Clear',
        'filter.no_results': 'No matching students',
        'filter.try_different': 'Please try different filter criteria',
        'practice.scheduled': 'Scheduled',
        'practice.unscheduled': 'Unscheduled', 
        'practice.total': 'Total',
        'report.last_30_days': 'Last 30 Days',
        'report.to': 'to'
    }
};

// å½“å‰è¯­è¨€
let currentLanguage = 'zh';

// è¯­è¨€åˆ‡æ¢å‡½æ•°
function switchLanguage(lang) {
    if (lang === currentLanguage) return;
    
    currentLanguage = lang;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-lang') === lang) {
            btn.classList.add('active');
        }
    });
    
    // æ›´æ–°é¡µé¢æ–‡æœ¬
    updatePageLanguage();
    
    // ä¿å­˜è¯­è¨€åå¥½
    localStorage.setItem('preferred_language', lang);
    
    // é‡æ–°æ¸²æŸ“å½“å‰é¡µé¢å†…å®¹
    refreshCurrentTabContent();
    
    addSyncLog(`ğŸŒ è¯­è¨€å·²åˆ‡æ¢ä¸º ${lang === 'zh' ? 'ä¸­æ–‡' : 'English'}`);
}

// æ›´æ–°é¡µé¢è¯­è¨€
function updatePageLanguage() {
    const texts = i18n[currentLanguage];
    
    // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-i18n å±æ€§çš„å…ƒç´ 
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (texts[key]) {
            element.textContent = texts[key];
        }
    });
    
    // æ›´æ–° placeholder æ–‡æœ¬
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (texts[key]) {
            element.placeholder = texts[key];
        }
    });
    
    // æ›´æ–°é¡µé¢æ ‡é¢˜
    document.title = currentLanguage === 'zh' ? 
        'é’å²›æ¢…çº½å› éŸ³ä¹å­¦æ ¡ç»ƒç´è·Ÿè¸ªç³»ç»Ÿ' : 
        'Qingdao Menuhin Music School Practice Tracking System';
}

// è·å–ç¿»è¯‘æ–‡æœ¬
function t(key, fallback = '') {
    const texts = i18n[currentLanguage];
    return texts[key] || fallback || key;
}

// åˆ·æ–°å½“å‰æ ‡ç­¾é¡µå†…å®¹
function refreshCurrentTabContent() {
    switch(currentTab) {
        case 'dashboard':
            if (attendanceData && Object.keys(attendanceData).length > 0) {
                updateDashboard();
                displayPracticeStatus();
            }
            break;
        case 'students':
            if (Object.keys(studentData).length > 0) {
                loadStudentList();
                updateStatusFilterOptions();
            }
            break;
        case 'reports':
            // æŠ¥å‘Šé¡µé¢ä¸éœ€è¦ç‰¹æ®Šåˆ·æ–°
            break;
        case 'sync':
            updateSyncStatus();
            break;
    }
}

// Firebase é…ç½®
const firebaseConfig = {
  apiKey: "AIzaSyBfRjrAKsVUAHBl5WbBl96YONrkRe1UWUo",
  authDomain: "menuhin-studio-system.firebaseapp.com",
  databaseURL: "https://menuhin-studio-system-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "menuhin-studio-system",
  storageBucket: "menuhin-studio-system.firebasestorage.app",
  messagingSenderId: "218592951152",
  appId: "1:218592951152:web:650d080726b6c44f5a2db5",
  measurementId: "G-P49SZQTLT7"
};


// å…¨å±€å˜é‡
let database = null;
let isOnline = false;
let currentTab = 'dashboard';
let attendanceData = {
    realTimePractice: {}
};
let studentData = {};
let excuseData = {};
let syncLogs = [];
let rooms = [];

let syncTimers = new Set();
let isInitialized = false;
let debugMode = true;
// ğŸ”¥ æ–°å¢ï¼šå®æ—¶ç»ƒç´çŠ¶æ€ç›¸å…³å˜é‡ï¼ˆå˜åŒ–é©±åŠ¨ç‰ˆï¼‰
let realTimePracticeStatus = {}; // å­˜å‚¨æ¯ä¸ªå­¦ç”Ÿçš„å®æ—¶çŠ¶æ€
let lastRealTimePracticeHash = ''; // ç”¨äºæ£€æµ‹å˜åŒ–çš„å“ˆå¸Œå€¼
let practiceStatusUpdateTimeout = null; // é˜²æŠ–å®šæ—¶å™¨

// è°ƒè¯•æ—¥å¿—å‡½æ•°
function debugLog(message, data = null) {
    if (debugMode) {
        console.log(`[DEBUG] ${message}`, data || '');
        addSyncLog(`ğŸ” ${message}${data ? ': ' + JSON.stringify(data) : ''}`);
    }
}

// åˆå§‹åŒ– Firebase
function initFirebase() {
    if (isInitialized) {
        console.log('Firebaseå·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
        return;
    }
    
    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        isInitialized = true;
        
        // ç›‘å¬è¿æ¥çŠ¶æ€
        database.ref('.info/connected').on('value', (snapshot) => {
            const wasOnline = isOnline;
            isOnline = snapshot.val() === true;
            updateConnectionStatus();
            
            if (isOnline && !wasOnline) {
                addSyncLog('âœ… ' + t('sync.connected', 'å·²è¿æ¥åˆ°Firebaseæ•°æ®åº“'));
                setTimeout(() => {
                    loadInitialData();
                }, 1000);
            } else if (!isOnline && wasOnline) {
                addSyncLog('âŒ ' + t('sync.disconnected', 'ä¸Firebaseæ•°æ®åº“æ–­å¼€è¿æ¥'));
            }
        });
        
        // ç›‘å¬è€ƒå‹¤æ•°æ®å˜åŒ–
        database.ref('attendanceData').on('value', (snapshot) => {
            try {
                if (snapshot.exists()) {
                    const newData = snapshot.val();
                    if (newData && typeof newData === 'object') {
                        attendanceData = { ...attendanceData, ...newData };
                        addSyncLog('ğŸ“¥ ' + t('sync.attendance_updated', 'è€ƒå‹¤æ•°æ®å·²æ›´æ–°'));
                        updateDashboard();
                        if (currentTab === 'students') {
                            loadStudentList();
                        }
                    }
                }
            } catch (error) {
                console.error('å¤„ç†è€ƒå‹¤æ•°æ®æ›´æ–°å¤±è´¥:', error);
                addSyncLog('âŒ ' + t('sync.attendance_failed', 'è€ƒå‹¤æ•°æ®æ›´æ–°å¤±è´¥') + ': ' + error.message);
            }
        }, (error) => {
            console.error('ç›‘å¬è€ƒå‹¤æ•°æ®å¤±è´¥:', error);
            addSyncLog('âŒ ' + t('sync.listen_failed', 'ç›‘å¬è€ƒå‹¤æ•°æ®å¤±è´¥') + ': ' + error.message);
        });

        // ç›‘å¬å®æ—¶ç»ƒç´çŠ¶æ€å˜åŒ–
        let practiceUpdateTimeout;
        database.ref('realTimePracticeStatus').on('value', (snapshot) => {
            try {
                clearTimeout(practiceUpdateTimeout);
                practiceUpdateTimeout = setTimeout(() => {
                    if (snapshot.exists()) {
                        handleRemoteRealTimePracticeUpdate(snapshot.val());
                    } else {
                        handleRemoteRealTimePracticeUpdate({});
                    }
                }, 500);
            } catch (error) {
                console.error('å¤„ç†å®æ—¶ç»ƒç´çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
                addSyncLog('âŒ ' + t('sync.practice_failed', 'å®æ—¶ç»ƒç´çŠ¶æ€æ›´æ–°å¤±è´¥') + ': ' + error.message);
            }
        }, (error) => {
            console.error('ç›‘å¬å®æ—¶ç»ƒç´çŠ¶æ€å¤±è´¥:', error);
            addSyncLog('âŒ ' + t('sync.practice_listen_failed', 'ç›‘å¬å®æ—¶ç»ƒç´çŠ¶æ€å¤±è´¥') + ': ' + error.message);
        });
        
        // ç›‘å¬ç´æˆ¿çŠ¶æ€å˜åŒ–
        let roomsUpdateTimeout;
        database.ref('rooms').on('value', (snapshot) => {
            try {
                clearTimeout(roomsUpdateTimeout);
                roomsUpdateTimeout = setTimeout(() => {
                    if (snapshot.exists()) {
                        handleRoomsUpdate(snapshot.val());
                    } else {
                        handleRoomsUpdate([]);
                    }
                }, 500);
            } catch (error) {
                console.error('å¤„ç†ç´æˆ¿çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
                addSyncLog('âŒ ' + t('sync.rooms_failed', 'ç´æˆ¿çŠ¶æ€æ›´æ–°å¤±è´¥') + ': ' + error.message);
            }
        }, (error) => {
            console.error('ç›‘å¬ç´æˆ¿çŠ¶æ€å¤±è´¥:', error);
            addSyncLog('âŒ ' + t('sync.rooms_listen_failed', 'ç›‘å¬ç´æˆ¿çŠ¶æ€å¤±è´¥') + ': ' + error.message);
        });
        
        // ç›‘å¬å­¦ç”Ÿæ•°æ®å˜åŒ–ï¼ˆåŒ…å«æœ¬åœ°å­˜å‚¨ï¼‰
        database.ref('studentDatabase').on('value', (snapshot) => {
            try {
                if (snapshot.exists()) {
                    const newStudentData = snapshot.val();
                    if (newStudentData && typeof newStudentData === 'object') {
                        studentData = newStudentData;
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                        try {
                            localStorage.setItem('studentData', JSON.stringify(newStudentData));
                        } catch (e) {
                            console.warn('ä¿å­˜å­¦ç”Ÿæ•°æ®åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
                        }
                        
                        addSyncLog('ğŸ“¥ ' + t('sync.student_updated', 'å­¦ç”Ÿæ•°æ®å·²æ›´æ–°'));
                        updateFilters();
                        if (currentTab === 'students') {
                            loadStudentList();
                        }
                    }
                }
            } catch (error) {
                console.error('å¤„ç†å­¦ç”Ÿæ•°æ®æ›´æ–°å¤±è´¥:', error);
                addSyncLog('âŒ ' + t('sync.student_failed', 'å­¦ç”Ÿæ•°æ®æ›´æ–°å¤±è´¥') + ': ' + error.message);
            }
        }, (error) => {
            console.error('ç›‘å¬å­¦ç”Ÿæ•°æ®å¤±è´¥:', error);
            addSyncLog('âŒ ' + t('sync.student_listen_failed', 'ç›‘å¬å­¦ç”Ÿæ•°æ®å¤±è´¥') + ': ' + error.message);
        });

        // ç›‘å¬è¯·å‡æ•°æ®å˜åŒ–ï¼ˆåŒ…å«æœ¬åœ°å­˜å‚¨ï¼‰
        database.ref('excuseData').on('value', (snapshot) => {
            try {
                if (snapshot.exists()) {
                    const newExcuseData = snapshot.val();
                    if (newExcuseData && typeof newExcuseData === 'object') {
                        excuseData = newExcuseData;
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                        try {
                            localStorage.setItem('excuseData', JSON.stringify(newExcuseData));
                        } catch (e) {
                            console.warn('ä¿å­˜è¯·å‡æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
                        }
                        
                        addSyncLog('ğŸ“¥ ' + t('sync.excuse_updated', 'è¯·å‡æ•°æ®å·²æ›´æ–°'));
                        if (currentTab === 'dashboard') {
                            updateDashboard();
                        } else if (currentTab === 'students') {
                            loadStudentList();
                        }
                    }
                }
            } catch (error) {
                console.error('å¤„ç†è¯·å‡æ•°æ®æ›´æ–°å¤±è´¥:', error);
                addSyncLog('âŒ ' + t('sync.excuse_failed', 'è¯·å‡æ•°æ®æ›´æ–°å¤±è´¥') + ': ' + error.message);
            }
        }, (error) => {
            console.error('ç›‘å¬è¯·å‡æ•°æ®å¤±è´¥:', error);
            addSyncLog('âŒ ' + t('sync.excuse_listen_failed', 'ç›‘å¬è¯·å‡æ•°æ®å¤±è´¥') + ': ' + error.message);
        });
        
    } catch (error) {
        console.error('Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
        addSyncLog('âŒ Firebaseåˆå§‹åŒ–å¤±è´¥: ' + error.message);
        isInitialized = false;
    }
}

function handleRoomsUpdate(roomsData) {
    debugLog('æ”¶åˆ°ç´æˆ¿çŠ¶æ€æ›´æ–°', roomsData ? roomsData.length + 'é—´ç´æˆ¿' : 'ç©ºæ•°æ®');
    
    if (!roomsData || !Array.isArray(roomsData) || roomsData.length === 0) {
        debugLog('ç´æˆ¿æ•°æ®ä¸ºç©ºï¼Œå¼ºåˆ¶æ¸…ç†æ‰€æœ‰ç»ƒç´çŠ¶æ€');
        
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå½“ç´æˆ¿æ•°æ®ä¸ºç©ºæ—¶ï¼Œå¼ºåˆ¶æ¸…ç©ºæ‰€æœ‰ç»ƒç´çŠ¶æ€
        if (attendanceData.realTimePractice && Object.keys(attendanceData.realTimePractice).length > 0) {
            const clearedStudents = Object.keys(attendanceData.realTimePractice);
            attendanceData.realTimePractice = {};
            
            // ğŸ”¥ ç§»é™¤ï¼šä¸å†æ“ä½œæœ¬åœ°å­˜å‚¨
            displayPracticeStatus();
            
            addSyncLog(`ğŸ§¹ ç´æˆ¿ç³»ç»Ÿå·²æ¸…ç©ºï¼Œå¼ºåˆ¶æ¸…ç† ${clearedStudents.length} ä¸ªç»ƒç´çŠ¶æ€`);
            console.log('ğŸ§¹ å·²æ¸…ç†æ‰€æœ‰ç»ƒç´çŠ¶æ€:', clearedStudents);
        }
        
        rooms = [];
        return;
    }

    console.log('ğŸ  æ”¶åˆ°ç´æˆ¿çŠ¶æ€æ›´æ–°:', roomsData.length, 'é—´ç´æˆ¿');
    rooms = roomsData;
    
    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ„å»ºå½“å‰æ´»è·ƒçš„ç»ƒç´å­¦ç”Ÿåˆ—è¡¨
    const currentActivePractice = {};
    const now = Date.now();
    
    roomsData.forEach(room => {
        if (room.student && room.student !== 'ç©ºé—²' && room.registerTime) {
            const studentName = room.student;
            const registerTime = new Date(room.registerTime).getTime();
            
            // éªŒè¯æ—¶é—´æœ‰æ•ˆæ€§
            if (registerTime > 0 && registerTime <= now && (now - registerTime) < 12 * 60 * 60 * 1000) {
                const currentDuration = Math.floor((now - registerTime) / 1000);
                
                currentActivePractice[studentName] = {
                    room: room.name,
                    startTime: room.registerTime,
                    currentDuration: currentDuration,
                    status: 'practicing',
                    lastUpdated: now,
                    syncSource: 'rooms'
                };
            }
        }
    });
    
    if (!attendanceData.realTimePractice) {
        attendanceData.realTimePractice = {};
    }
    
    let hasChanges = false;
    const currentStudents = Object.keys(attendanceData.realTimePractice);
    const activeStudents = Object.keys(currentActivePractice);
    
    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ¸…ç†ä¸åœ¨æ´»è·ƒåˆ—è¡¨ä¸­çš„å­¦ç”Ÿ
    currentStudents.forEach(studentName => {
        const currentRecord = attendanceData.realTimePractice[studentName];
        
        // å¦‚æœå­¦ç”Ÿä¸åœ¨å½“å‰æ´»è·ƒåˆ—è¡¨ä¸­ï¼Œä¸”æ˜¯æ¥è‡ªç´æˆ¿ç³»ç»Ÿçš„æ•°æ®ï¼Œåˆ™æ¸…ç†
        if (!activeStudents.includes(studentName) && 
            (currentRecord.syncSource === 'rooms' || currentRecord.room)) {
            console.log(`ğŸ§¹ å­¦ç”Ÿå·²ç¦»å¼€ç´æˆ¿ï¼Œæ¸…ç†çŠ¶æ€: ${studentName}`);
            delete attendanceData.realTimePractice[studentName];
            hasChanges = true;
        }
    });
    
    // æ›´æ–°æˆ–æ·»åŠ æ´»è·ƒå­¦ç”Ÿçš„çŠ¶æ€
    activeStudents.forEach(studentName => {
        const newRecord = currentActivePractice[studentName];
        const currentRecord = attendanceData.realTimePractice[studentName];
        
        if (!currentRecord || 
            currentRecord.room !== newRecord.room ||
            Math.abs((currentRecord.currentDuration || 0) - newRecord.currentDuration) > 30) {
            
            attendanceData.realTimePractice[studentName] = newRecord;
            hasChanges = true;
            console.log(`ğŸ”„ æ›´æ–°ç´æˆ¿ç»ƒç´çŠ¶æ€: ${studentName} in ${newRecord.room}`);
        }
    });
    
    if (hasChanges) {
        // ğŸ”¥ ç§»é™¤ï¼šä¸å†ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        
        if (currentTab === 'dashboard') {
            displayPracticeStatus();
        }
        
        const activeCount = Object.keys(currentActivePractice).length;
        addSyncLog(`ğŸ  ç´æˆ¿çŠ¶æ€å·²åŒæ­¥ (${activeCount}åå­¦ç”Ÿåœ¨ç»ƒç´)`);
        
        if (activeCount === 0) {
            addSyncLog('âœ… æ‰€æœ‰ç´æˆ¿å·²æ¸…ç©ºï¼Œæ— å­¦ç”Ÿåœ¨ç»ƒç´');
        }
        
        // ç´æˆ¿çŠ¶æ€å˜åŒ–æ—¶è§¦å‘å®æ—¶çŠ¶æ€åŒæ­¥
        if (isOnline) {
            triggerRealTimePracticeStatusUpdate();
        }
    }
}

/* =============== å®æ—¶ç»ƒç´çŠ¶æ€åŒæ­¥ç³»ç»Ÿï¼ˆå˜åŒ–é©±åŠ¨ç‰ˆï¼‰ =============== */

/**
 * è®¡ç®—å­¦ç”Ÿçš„å®æ—¶ç»ƒç´çŠ¶æ€
 */
function calculateRealTimePracticeStatus(studentName) {
    const practiceData = attendanceData.realTimePractice || {};
    const studentPractice = practiceData[studentName];
    
    if (!studentPractice || !studentPractice.startTime) {
        return null;
    }
    
    const now = Date.now();
    const startTime = new Date(studentPractice.startTime).getTime();
    
    // éªŒè¯æ—¶é—´æœ‰æ•ˆæ€§
    if (isNaN(startTime) || startTime > now || (now - startTime) > 12 * 60 * 60 * 1000) {
        return null;
    }
    
    const currentDuration = Math.floor((now - startTime) / 1000);
    
    return {
        currentDuration,
        lastUpdated: now,
        room: studentPractice.room || 'æœªçŸ¥ç´æˆ¿',
        startTime: studentPractice.startTime,
        status: 'practicing'
    };
}

/**
 * ç”Ÿæˆå®æ—¶çŠ¶æ€çš„å“ˆå¸Œå€¼ï¼Œç”¨äºæ£€æµ‹å˜åŒ–
 */
function generateRealTimePracticeHash(statusData) {
    // åªåŒ…å«å…³é”®çŠ¶æ€ä¿¡æ¯ï¼Œæ’é™¤æ—¶é—´æˆ³
    const keyData = {};
    Object.keys(statusData).forEach(studentName => {
        const status = statusData[studentName];
        if (status) {
            keyData[studentName] = {
                room: status.room,
                status: status.status,
                // å°†æ—¶é•¿æŒ‰10ç§’å–æ•´ï¼Œå‡å°‘å¾®å°å˜åŒ–
                durationRounded: Math.floor((status.currentDuration || 0) / 10) * 10
            };
        }
    });
    return JSON.stringify(keyData);
}

/**
 * æ£€æŸ¥å¹¶æ›´æ–°å®æ—¶ç»ƒç´çŠ¶æ€ï¼ˆä»…åœ¨æœ‰å˜åŒ–æ—¶åŒæ­¥ï¼‰
 */
function checkAndUpdateRealTimePracticeStatus(forceUpdate = false) {
    const newStatus = {};
    
    // éå†æ‰€æœ‰æ­£åœ¨ç»ƒç´çš„å­¦ç”Ÿ
    if (attendanceData.realTimePractice) {
        Object.keys(attendanceData.realTimePractice).forEach(studentName => {
            const status = calculateRealTimePracticeStatus(studentName);
            if (status) {
                newStatus[studentName] = status;
            }
        });
    }
    
    // ç”Ÿæˆæ–°çš„å“ˆå¸Œå€¼
    const newHash = generateRealTimePracticeHash(newStatus);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å®è´¨æ€§å˜åŒ–
    const hasSignificantChange = newHash !== lastRealTimePracticeHash || forceUpdate;
    
    if (hasSignificantChange) {
        debugLog('æ£€æµ‹åˆ°å®æ—¶ç»ƒç´çŠ¶æ€å˜åŒ–ï¼Œå‡†å¤‡åŒæ­¥', Object.keys(newStatus));
        
        // æ›´æ–°çŠ¶æ€å’Œå“ˆå¸Œå€¼
        realTimePracticeStatus = newStatus;
        lastRealTimePracticeHash = newHash;
        
        // é˜²æŠ–åŒæ­¥ï¼šçŸ­æ—¶é—´å†…å¤šæ¬¡å˜åŒ–åªåŒæ­¥æœ€åä¸€æ¬¡
        if (practiceStatusUpdateTimeout) {
            clearTimeout(practiceStatusUpdateTimeout);
        }
        
        practiceStatusUpdateTimeout = setTimeout(() => {
            syncRealTimePracticeStatusToFirebase();
            practiceStatusUpdateTimeout = null;
        }, 1000); // 1ç§’é˜²æŠ–
        
        // ğŸ”¥ ç§»é™¤ï¼šä¸å†ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        
        return true; // æœ‰å˜åŒ–
    }
    
    return false; // æ— å˜åŒ–
}


/**
 * åŒæ­¥å®æ—¶ç»ƒç´çŠ¶æ€åˆ° Firebase
 */
function syncRealTimePracticeStatusToFirebase() {
    if (!database || !isOnline) {
        debugLog('è·³è¿‡å®æ—¶çŠ¶æ€åŒæ­¥', { database: !!database, isOnline });
        return;
    }
    
    // æ¸…ç†æ•°æ®ï¼Œç¡®ä¿å…¼å®¹ Firebase
    const cleanData = cleanDataForFirebase(realTimePracticeStatus);
    
    debugLog('åŒæ­¥å®æ—¶ç»ƒç´çŠ¶æ€åˆ°äº‘ç«¯ï¼Œå­¦ç”Ÿæ•°é‡', Object.keys(cleanData).length);
    
    database.ref('realTimePracticeStatus').set(cleanData)
        .then(() => {
            addSyncLog('âœ… å®æ—¶ç»ƒç´çŠ¶æ€åŒæ­¥æˆåŠŸ');
            debugLog('å®æ—¶ç»ƒç´çŠ¶æ€åŒæ­¥æˆåŠŸ');
        })
        .catch(error => {
            console.error('å®æ—¶ç»ƒç´çŠ¶æ€åŒæ­¥å¤±è´¥:', error);
            addSyncLog('âŒ å®æ—¶ç»ƒç´çŠ¶æ€åŒæ­¥å¤±è´¥: ' + error.message);
        });
}

/**
 * æ¸…ç†Firebaseæ•°æ®ï¼Œç¡®ä¿å…¼å®¹æ€§
 */
function cleanDataForFirebase(data) {
    if (!data || typeof data !== 'object') return {};
    
    const cleaned = {};
    Object.keys(data).forEach(key => {
        if (key && data[key] && typeof data[key] === 'object') {
            cleaned[key] = { ...data[key] };
            
            // ç¡®ä¿æ‰€æœ‰æ—¶é—´æˆ³éƒ½æ˜¯æœ‰æ•ˆçš„æ•°å­—
            if (cleaned[key].lastUpdated) {
                cleaned[key].lastUpdated = Number(cleaned[key].lastUpdated) || Date.now();
            }
            if (cleaned[key].startTime) {
                const startTime = new Date(cleaned[key].startTime).getTime();
                cleaned[key].startTime = isNaN(startTime) ? Date.now() : startTime;
            }
            if (cleaned[key].currentDuration) {
                cleaned[key].currentDuration = Number(cleaned[key].currentDuration) || 0;
            }
        }
    });
    
    return cleaned;
}

/**
 * ç«‹å³è§¦å‘å®æ—¶çŠ¶æ€æ£€æŸ¥å’ŒåŒæ­¥ï¼ˆç”¨äºå…³é”®æ“ä½œåï¼‰
 */
function triggerRealTimePracticeStatusUpdate() {
    // ç«‹å³æ£€æŸ¥å¹¶åŒæ­¥ï¼Œè·³è¿‡é˜²æŠ–
    if (practiceStatusUpdateTimeout) {
        clearTimeout(practiceStatusUpdateTimeout);
        practiceStatusUpdateTimeout = null;
    }
    
    setTimeout(() => {
        checkAndUpdateRealTimePracticeStatus(true);
    }, 100);
}

/**
 * å®šæœŸæ£€æŸ¥çŠ¶æ€å˜åŒ–ï¼ˆç”¨äºæ•è·æ—¶é—´æ¨ç§»å¯¼è‡´çš„çŠ¶æ€å˜åŒ–ï¼‰
 */
function periodicRealTimePracticeStatusCheck() {
    // åªæ£€æŸ¥ï¼Œä¸å¼ºåˆ¶æ›´æ–°
    checkAndUpdateRealTimePracticeStatus(false);
}

/**
 * æ¸…ç†å·²ç»“æŸç»ƒç´çš„å­¦ç”ŸçŠ¶æ€
 */
function cleanupEndedPracticeStatus() {
    if (!attendanceData.realTimePractice) return;
    
    const activeStudents = new Set(Object.keys(attendanceData.realTimePractice));
    let hasChanges = false;
    
    Object.keys(realTimePracticeStatus).forEach(studentName => {
        if (!activeStudents.has(studentName)) {
            delete realTimePracticeStatus[studentName];
            hasChanges = true;
        }
    });
    
    if (hasChanges) {
        debugLog('æ¸…ç†å·²ç»“æŸç»ƒç´çš„å­¦ç”ŸçŠ¶æ€');
        lastRealTimePracticeHash = generateRealTimePracticeHash(realTimePracticeStatus);
        // ğŸ”¥ ç§»é™¤ï¼šä¸å†ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        syncRealTimePracticeStatusToFirebase();
    }
}

/**
 * è·å–æŒ‡å®šå­¦ç”Ÿçš„å®æ—¶ç»ƒç´çŠ¶æ€
 */
function getStudentRealTimePracticeStatus(studentName) {
    return realTimePracticeStatus[studentName] || null;
}

/**
 * å¤„ç†è¿œç¨‹å®æ—¶ç»ƒç´çŠ¶æ€æ›´æ–°
 */
function handleRemoteRealTimePracticeUpdate(remoteStatus) {
    try {
        debugLog('æ”¶åˆ°è¿œç¨‹å®æ—¶ç»ƒç´çŠ¶æ€æ›´æ–°', remoteStatus);
        
        if (!attendanceData) {
            attendanceData = {};
        }
        if (!attendanceData.realTimePractice) {
            attendanceData.realTimePractice = {};
        }
        
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¦‚æœè¿œç¨‹æ•°æ®ä¸ºç©ºï¼Œå¼ºåˆ¶æ¸…ç©ºæœ¬åœ°çŠ¶æ€
        if (!remoteStatus || typeof remoteStatus !== 'object' || Object.keys(remoteStatus).length === 0) {
            debugLog('è¿œç¨‹ç»ƒç´æ•°æ®ä¸ºç©ºï¼Œå¼ºåˆ¶æ¸…ç©ºæœ¬åœ°çŠ¶æ€');
            
            const clearedCount = Object.keys(attendanceData.realTimePractice).length;
            attendanceData.realTimePractice = {};
            
            // ğŸ”¥ åŒæ—¶æ¸…ç†åŒæ­¥çŠ¶æ€
            realTimePracticeStatus = {};
            lastRealTimePracticeHash = '';
            
            // ğŸ”¥ ç§»é™¤ï¼šä¸å†æ“ä½œæœ¬åœ°å­˜å‚¨
            displayPracticeStatus();
            
            if (clearedCount > 0) {
                addSyncLog(`ğŸ§¹ è¿œç¨‹æ•°æ®ä¸ºç©ºï¼Œå·²å¼ºåˆ¶æ¸…ç©º ${clearedCount} ä¸ªç»ƒç´çŠ¶æ€`);
            }
            return;
        }

        const remoteStudentNames = Object.keys(remoteStatus);
        const localStudentNames = Object.keys(attendanceData.realTimePractice);
        
        debugLog('è¿œç¨‹ç»ƒç´å­¦ç”Ÿ', remoteStudentNames);
        debugLog('æœ¬åœ°ç»ƒç´å­¦ç”Ÿ', localStudentNames);
        
        let hasChanges = false;
        const now = Date.now();
        
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶æ¸…ç†ä¸åœ¨è¿œç¨‹æ•°æ®ä¸­çš„å­¦ç”Ÿ
        localStudentNames.forEach(studentName => {
            if (!remoteStudentNames.includes(studentName)) {
                debugLog(`å¼ºåˆ¶æ¸…ç†ä¸åœ¨è¿œç¨‹æ•°æ®ä¸­çš„å­¦ç”Ÿ: ${studentName}`);
                delete attendanceData.realTimePractice[studentName];
                hasChanges = true;
            }
        });

        // æ›´æ–°è¿œç¨‹æ•°æ®ä¸­çš„å­¦ç”ŸçŠ¶æ€
        remoteStudentNames.forEach(studentName => {
            const remoteRecord = remoteStatus[studentName];
            const currentStatus = attendanceData.realTimePractice[studentName];
            
            if (!remoteRecord || typeof remoteRecord !== 'object') {
                console.warn(`âš ï¸ å­¦ç”Ÿ ${studentName} çš„è¿œç¨‹æ•°æ®æ— æ•ˆ:`, remoteRecord);
                return;
            }
            
            // éªŒè¯æ—¶é—´æ•°æ®æœ‰æ•ˆæ€§
            const startTime = new Date(remoteRecord.startTime).getTime();
            if (isNaN(startTime) || startTime > now || (now - startTime) > 24 * 60 * 60 * 1000) {
                console.warn(`âš ï¸ å­¦ç”Ÿ ${studentName} çš„æ—¶é—´æ•°æ®å¼‚å¸¸ï¼Œæ¸…ç†è¯¥è®°å½•`);
                if (attendanceData.realTimePractice[studentName]) {
                    delete attendanceData.realTimePractice[studentName];
                    hasChanges = true;
                }
                return;
            }
            
            const shouldUpdate = !currentStatus || 
                currentStatus.room !== remoteRecord.room ||
                Math.abs((currentStatus.currentDuration || 0) - (remoteRecord.currentDuration || 0)) > 10 ||
                currentStatus.startTime !== remoteRecord.startTime;
            
            if (shouldUpdate) {
                attendanceData.realTimePractice[studentName] = {
                    room: remoteRecord.room,
                    startTime: remoteRecord.startTime,
                    currentDuration: remoteRecord.currentDuration || 0,
                    lastUpdated: now,
                    syncSource: 'remote'
                };
                hasChanges = true;
                debugLog(`æ›´æ–°å­¦ç”Ÿç»ƒç´çŠ¶æ€: ${studentName}`, remoteRecord);
            }
        });
        
        if (hasChanges) {
            if (currentTab === 'dashboard') {
                displayPracticeStatus();
            }
            
            // ğŸ”¥ ç§»é™¤ï¼šä¸å†ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            
            // ğŸ”¥ æ–°å¢ï¼šåŒæ­¥æ›´æ–°æœ¬åœ°åŒæ­¥çŠ¶æ€
            setTimeout(() => {
                checkAndUpdateRealTimePracticeStatus(true);
            }, 500);
            
            const activeCount = remoteStudentNames.length;
            addSyncLog(`ğŸ¹ å®æ—¶ç»ƒç´çŠ¶æ€å·²åŒæ­¥ (${activeCount}åå­¦ç”Ÿ)`);
            
            if (activeCount === 0) {
                addSyncLog('âœ… æ‰€æœ‰å­¦ç”Ÿå·²ç»“æŸç»ƒç´');
            }
        }
    } catch (error) {
        console.error('å¤„ç†å®æ—¶ç»ƒç´çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
        addSyncLog('âŒ å®æ—¶ç»ƒç´çŠ¶æ€æ›´æ–°å¤±è´¥: ' + error.message);
    }
}

// ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶åŒæ­¥éªŒè¯å‡½æ•°
function forceValidateAndSync() {
    if (!isOnline || !database) {
        console.log('ç¦»çº¿çŠ¶æ€ï¼Œè·³è¿‡å¼ºåˆ¶åŒæ­¥éªŒè¯');
        return;
    }
    
    console.log('ğŸ” å¼€å§‹å¼ºåˆ¶åŒæ­¥éªŒè¯...');
    
    const promises = [];
    
    // åŒæ—¶è·å–ç´æˆ¿å’Œç»ƒç´çŠ¶æ€æ•°æ®
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            const roomsData = snapshot.exists() ? snapshot.val() : [];
            console.log('ğŸ  å¼ºåˆ¶è·å–ç´æˆ¿æ•°æ®:', roomsData);
            handleRoomsUpdate(roomsData);
        })
        .catch((error) => {
            console.error('å¼ºåˆ¶è·å–ç´æˆ¿æ•°æ®å¤±è´¥:', error);
        });
    
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            const practiceData = snapshot.exists() ? snapshot.val() : {};
            console.log('ğŸ¹ å¼ºåˆ¶è·å–ç»ƒç´æ•°æ®:', practiceData);
            handleRemoteRealTimePracticeUpdate(practiceData);
        })
        .catch((error) => {
            console.error('å¼ºåˆ¶è·å–ç»ƒç´æ•°æ®å¤±è´¥:', error);
        });
    
    promises.push(roomsPromise, practicePromise);
    
    Promise.all(promises).then(() => {
        console.log('âœ… å¼ºåˆ¶åŒæ­¥éªŒè¯å®Œæˆ');
        addSyncLog('ğŸ” å¼ºåˆ¶åŒæ­¥éªŒè¯å®Œæˆ');
    });
}
// ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶éªŒè¯å®æ—¶ç»ƒç´æ•°æ®
function forceValidateRealTimePractice() {
    if (!isOnline || !database) return;
    
    const promises = [];
    
    // è·å–è¿œç¨‹ç»ƒç´çŠ¶æ€
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            const remoteData = snapshot.exists() ? snapshot.val() : {};
            debugLog('å¼ºåˆ¶éªŒè¯ - è¿œç¨‹ç»ƒç´æ•°æ®', remoteData);
            
            // ç«‹å³å¤„ç†è¿œç¨‹æ•°æ®
            handleRemoteRealTimePracticeUpdate(remoteData);
        })
        .catch((error) => {
            console.error('å¼ºåˆ¶éªŒè¯ç»ƒç´æ•°æ®å¤±è´¥:', error);
        });
    
    // è·å–ç´æˆ¿çŠ¶æ€
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            const roomsData = snapshot.exists() ? snapshot.val() : [];
            debugLog('å¼ºåˆ¶éªŒè¯ - ç´æˆ¿æ•°æ®', roomsData);
            
            // ç«‹å³å¤„ç†ç´æˆ¿æ•°æ®
            handleRoomsUpdate(roomsData);
        })
        .catch((error) => {
            console.error('å¼ºåˆ¶éªŒè¯ç´æˆ¿æ•°æ®å¤±è´¥:', error);
        });
    
    promises.push(practicePromise, roomsPromise);
    
    Promise.all(promises).then(() => {
        // éªŒè¯å®Œæˆåç«‹å³æ¸…ç†è¿‡æœŸæ•°æ®
        validateAndCleanExpiredData();
        debugLog('å¼ºåˆ¶éªŒè¯å®Œæˆ');
    });
}

// ğŸ”¥ æ–°å¢ï¼šæ·±åº¦éªŒè¯å’ŒåŒæ­¥
function deepValidateAndSync() {
    if (!isOnline || !database) return;
    
    debugLog('å¼€å§‹æ·±åº¦éªŒè¯å’ŒåŒæ­¥');
    
    // å…ˆæ¸…ç†æœ¬åœ°è¿‡æœŸæ•°æ®
    validateAndCleanExpiredData();
    
    // ç„¶åè·å–æœ€æ–°çš„è¿œç¨‹æ•°æ®è¿›è¡Œå¯¹æ¯”
    Promise.all([
        database.ref('realTimePracticeStatus').once('value'),
        database.ref('rooms').once('value')
    ]).then(([practiceSnapshot, roomsSnapshot]) => {
        const remotePracticeData = practiceSnapshot.exists() ? practiceSnapshot.val() : {};
        const remoteRoomsData = roomsSnapshot.exists() ? roomsSnapshot.val() : [];
        
        debugLog('æ·±åº¦éªŒè¯ - è¿œç¨‹ç»ƒç´æ•°æ®', remotePracticeData);
        debugLog('æ·±åº¦éªŒè¯ - è¿œç¨‹ç´æˆ¿æ•°æ®', remoteRoomsData);
        debugLog('æ·±åº¦éªŒè¯ - æœ¬åœ°ç»ƒç´æ•°æ®', attendanceData.realTimePractice);
        
        // æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
        const remoteStudents = Object.keys(remotePracticeData);
        const localStudents = Object.keys(attendanceData.realTimePractice || {});
        
        // å¦‚æœæœ¬åœ°æœ‰å­¦ç”Ÿä½†è¿œç¨‹æ²¡æœ‰ï¼Œå¼ºåˆ¶æ¸…ç†
        const studentsToRemove = localStudents.filter(student => !remoteStudents.includes(student));
        if (studentsToRemove.length > 0) {
            debugLog('æ·±åº¦éªŒè¯å‘ç°éœ€è¦æ¸…ç†çš„å­¦ç”Ÿ', studentsToRemove);
            studentsToRemove.forEach(studentName => {
                delete attendanceData.realTimePractice[studentName];
            });
            localStorage.setItem('realTimePracticeStatus', JSON.stringify(attendanceData.realTimePractice));
            displayPracticeStatus();
            addSyncLog(`ğŸ§¹ æ·±åº¦éªŒè¯æ¸…ç†äº† ${studentsToRemove.length} ä¸ªä¸ä¸€è‡´çš„ç»ƒç´çŠ¶æ€`);
        }
        
        // å¤„ç†æœ€æ–°çš„è¿œç¨‹æ•°æ®
        handleRemoteRealTimePracticeUpdate(remotePracticeData);
        handleRoomsUpdate(remoteRoomsData);
        
    }).catch((error) => {
        console.error('æ·±åº¦éªŒè¯å¤±è´¥:', error);
        addSyncLog('âŒ æ·±åº¦éªŒè¯å¤±è´¥: ' + error.message);
    });
}

// æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
function updateConnectionStatus() {
    const statusEl = document.getElementById('connectionStatus');
    
    if (isOnline) {
        statusEl.className = 'connection-status online';
        statusEl.innerHTML = '<span data-i18n="status.online">' + t('status.online', 'å·²è¿æ¥') + '</span>';
    } else {
        statusEl.className = 'connection-status offline';
        statusEl.innerHTML = '<span data-i18n="status.offline">' + t('status.offline', 'ç¦»çº¿æ¨¡å¼') + '</span>';
    }
}


// æ·»åŠ åŒæ­¥æ—¥å¿—
function addSyncLog(message) {
    const timestamp = new Date().toLocaleString();
    const logEntry = `[${timestamp}] ${message}`;
    syncLogs.unshift(logEntry);
    
    if (syncLogs.length > 100) {
        syncLogs = syncLogs.slice(0, 100);
    }
    
    updateSyncLogsDisplay();
}

// æ›´æ–°åŒæ­¥æ—¥å¿—æ˜¾ç¤º
function updateSyncLogsDisplay() {
    const logsEl = document.getElementById('syncLogs');
    if (logsEl) {
        logsEl.innerHTML = syncLogs.join('\n');
        logsEl.scrollTop = 0;
    }
}

function loadInitialData() {
    if (!isOnline) return;
    
    addSyncLog('ğŸ”„ ' + t('sync.loading_data', 'å¼€å§‹åŠ è½½æ•°æ®...'));
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = today;
    
    preloadRecentAttendanceData();
    forceRefreshAllData();
}

function forceRefreshAllData() {
    addSyncLog('ğŸ”„ ' + t('sync.force_refresh', 'æ­£åœ¨å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰æ•°æ®...'));
    
    const refreshPromises = [];
    
    const selectedDate = document.getElementById('dateSelect').value;
    if (selectedDate) {
        const attendancePromise = database.ref(`attendanceData/${selectedDate}`).once('value')
            .then((snapshot) => {
                const data = snapshot.val() || {};
                attendanceData[selectedDate] = data;
                displayAttendanceSnapshot(data, selectedDate);
                addSyncLog(`âœ… å·²åˆ·æ–° ${selectedDate} çš„è€ƒå‹¤æ•°æ®`);
            })
            .catch((error) => {
                addSyncLog(`âŒ åˆ·æ–°è€ƒå‹¤æ•°æ®å¤±è´¥: ${error.message}`);
            });
        refreshPromises.push(attendancePromise);
    }
    
    const studentPromise = database.ref('studentDatabase').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                studentData = snapshot.val();
                updateFilters();
                addSyncLog('âœ… ' + t('sync.student_refreshed', 'å·²åˆ·æ–°å­¦ç”Ÿæ•°æ®'));
            }
        })
        .catch((error) => {
            addSyncLog(`âŒ åˆ·æ–°å­¦ç”Ÿæ•°æ®å¤±è´¥: ${error.message}`);
        });
    refreshPromises.push(studentPromise);
    
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRemoteRealTimePracticeUpdate(snapshot.val());
                addSyncLog('âœ… ' + t('sync.practice_refreshed', 'å·²åˆ·æ–°å®æ—¶ç»ƒç´çŠ¶æ€'));
            }
        })
        .catch((error) => {
            addSyncLog(`âŒ åˆ·æ–°å®æ—¶ç»ƒç´çŠ¶æ€å¤±è´¥: ${error.message}`);
        });
    refreshPromises.push(practicePromise);
    
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRoomsUpdate(snapshot.val());
                addSyncLog('âœ… ' + t('sync.rooms_refreshed', 'å·²åˆ·æ–°ç´æˆ¿çŠ¶æ€'));
            }
        })
        .catch((error) => {
            addSyncLog(`âŒ åˆ·æ–°ç´æˆ¿çŠ¶æ€å¤±è´¥: ${error.message}`);
        });
    refreshPromises.push(roomsPromise);
    
    const excusePromise = database.ref('excuseData').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                excuseData = snapshot.val();
                addSyncLog('âœ… ' + t('sync.excuse_refreshed', 'å·²åˆ·æ–°è¯·å‡æ•°æ®'));
            }
        })
        .catch((error) => {
            addSyncLog(`âŒ åˆ·æ–°è¯·å‡æ•°æ®å¤±è´¥: ${error.message}`);
        });
    refreshPromises.push(excusePromise);
    
    Promise.all(refreshPromises).then(() => {
        addSyncLog('ğŸ‰ ' + t('sync.all_refreshed', 'æ‰€æœ‰æ•°æ®åˆ·æ–°å®Œæˆ'));
        updateDashboard();
        if (currentTab === 'students') {
            updateStudentList();
        }
        if (currentTab === 'dashboard') {
            displayPracticeStatus();
        }
    }).catch((error) => {
        addSyncLog(`âš ï¸ éƒ¨åˆ†æ•°æ®åˆ·æ–°å¤±è´¥: ${error.message}`);
    });
}

function updateStudentList() {
    if (currentTab === 'students') {
        const combinedData = combineStudentAndAttendanceData();
        displayStudentList(combinedData);
        addSyncLog('ğŸ”„ ' + t('sync.student_list_updated', 'å­¦ç”Ÿåˆ—è¡¨å·²æ›´æ–°'));
    }
}

// åŠ è½½è€ƒå‹¤æ•°æ®
function loadAttendanceData() {
    const selectedDate = document.getElementById('dateSelect').value;
    if (!selectedDate) return;
    
    showLoading('todaySnapshot');
    
    if (isOnline) {
        database.ref(`attendanceData/${selectedDate}`).once('value')
            .then((snapshot) => {
                const data = snapshot.val() || {};
                displayAttendanceSnapshot(data, selectedDate);
                addSyncLog(`ğŸ“Š å·²åŠ è½½ ${selectedDate} çš„è€ƒå‹¤æ•°æ®`);
            })
            .catch((error) => {
                console.error('åŠ è½½è€ƒå‹¤æ•°æ®å¤±è´¥:', error);
                addSyncLog('âŒ ' + t('sync.load_failed', 'åŠ è½½è€ƒå‹¤æ•°æ®å¤±è´¥') + ': ' + error.message);
                showEmptyState('todaySnapshot', t('empty.load_failed', 'åŠ è½½å¤±è´¥'), t('empty.network_error', 'æ— æ³•åŠ è½½è€ƒå‹¤æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
            });
    } else {
        const localData = localStorage.getItem(`attendance_${selectedDate}`);
        if (localData) {
            displayAttendanceSnapshot(JSON.parse(localData), selectedDate);
        } else {
            showEmptyState('todaySnapshot', t('msg.no_data', 'æš‚æ— æ•°æ®'), t('empty.offline_no_data', 'ç¦»çº¿æ¨¡å¼ä¸‹æ²¡æœ‰æ‰¾åˆ°è¯¥æ—¥æœŸçš„è€ƒå‹¤æ•°æ®'));
        }
        
        displayPracticeStatus();
    }
}

// ğŸ”¥ ä¿ç•™ï¼šæ˜¾ç¤ºè€ƒå‹¤å¿«ç…§æ—¶çš„æœ¬åœ°å­˜å‚¨åŠŸèƒ½
function displayAttendanceSnapshot(data, date) {
    const container = document.getElementById('todaySnapshot');
    
    if (!data || Object.keys(data).length === 0) {
        showEmptyState('todaySnapshot', t('msg.no_data', 'æš‚æ— æ•°æ®'), `${date} ` + t('empty.no_attendance', 'è¿˜æ²¡æœ‰è€ƒå‹¤è®°å½•'));
        return;
    }
    
    // ğŸ”¥ ä¿ç•™ï¼šä¿å­˜è€ƒå‹¤æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    try {
        localStorage.setItem(`attendance_${date}`, JSON.stringify(data));
    } catch (e) {
        console.warn('ä¿å­˜è€ƒå‹¤æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
    }
    
    // å…¶ä½™æ˜¾ç¤ºé€»è¾‘ä¿æŒä¸å˜...
    let html = '<div class="student-grid">';
    
    const groupedByMajor = {};
    Object.values(data).forEach(student => {
        const major = student.major || t('student.unknown_major', 'å…¶ä»–');
        if (!groupedByMajor[major]) {
            groupedByMajor[major] = [];
        }
        groupedByMajor[major].push(student);
    });
    
    Object.keys(groupedByMajor).sort().forEach(major => {
        html += `<div style="grid-column: 1 / -1; margin: 20px 0 10px 0;">
                    <h4 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">
                        ${major} (${groupedByMajor[major].length}${t('report.people', 'äºº')})
                    </h4>
                </div>`;
        
        groupedByMajor[major].forEach(student => {
            html += createStudentCard(student, true);
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    updateStatistics(data);
    displayPracticeStatus();
}


// åˆ›å»ºå­¦ç”Ÿå¡ç‰‡
function createStudentCard(student, isSnapshot = false) {
    const statusClass = getStatusClass(student.finalAttendanceStatus);
    const statusText = getStatusText(student.finalAttendanceStatus);
    
    return `
        <div class="student-card ${statusClass}" onclick="showStudentDetail('${student.name}')">
            <div class="student-header">
                <div class="student-name">${student.name}</div>
                <div class="student-status ${statusClass}">${statusText}</div>
            </div>
            <div class="student-details">
                <div class="detail-item">
                    <div class="detail-label">${t('student.major', 'ä¸“ä¸š')}</div>
                    <div class="detail-value">${student.major || t('student.not_set', 'æœªè®¾ç½®')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.grade', 'å¹´çº§')}</div>
                    <div class="detail-value">${student.grade || t('student.not_set', 'æœªè®¾ç½®')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.time_slot', 'æ—¶é—´æ®µ')}</div>
                    <div class="detail-value">${student.start || t('student.no_schedule', 'æ— ')} - ${student.end || t('student.no_schedule', 'æ— ')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.practice_duration', 'ç»ƒç´æ—¶é•¿')}</div>
                    <div class="detail-value">${student.practicedText || t('time.no_practice', '0åˆ†é’Ÿ')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('student.room', 'æ‰€åœ¨ç´æˆ¿')}</div>
                    <div class="detail-value">${student.room || t('student.not_in_room', 'ä¸åœ¨ç´æˆ¿')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('attendance.rate', 'å‡ºå‹¤ç‡')}</div>
                    <div class="detail-value">${calculateAttendanceRate(student)}%</div>
                </div>
                ${student.excuseInfo ? `
                <div class="detail-item" style="grid-column: 1 / -1;">
                    <div class="detail-label">${t('excuse.reason', 'è¯·å‡ä¿¡æ¯')}</div>
                    <div class="detail-value" style="color: #f39c12;">
                        ${student.excuseInfo.reason || t('status.excused', 'å·²è¯·å‡')}
                        ${student.excuseInfo.approvedBy ? `<br><small>${t('excuse.approver', 'æ‰¹å‡†äºº')}: ${student.excuseInfo.approvedBy}</small>` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
            ${!isSnapshot ? createAttendanceHistory(student) : ''}
        </div>
    `;
}
// ğŸ”¥ æ–°å¢ï¼šç­›é€‰å®æ—¶ç»ƒç´çŠ¶æ€
function filterPracticeStatus() {
    const majorFilter = document.getElementById('practiceMajorFilter').value;
    const gradeFilter = document.getElementById('practiceGradeFilter').value;
    const searchText = document.getElementById('practiceStudentSearch').value.toLowerCase();
    
    const container = document.getElementById('practiceStudentList');
    if (!container) return;
    
    const practiceData = attendanceData.realTimePractice || {};
    const practiceStudents = Object.keys(practiceData);
    
    if (practiceStudents.length === 0) {
        displayEmptyPracticeState();
        return;
    }
    
    // ç­›é€‰å­¦ç”Ÿ
    const filteredStudents = practiceStudents.filter(studentName => {
        const studentInfo = getStudentInfoFromDatabase(studentName);
        
        // ä¸“ä¸šç­›é€‰
        if (majorFilter && studentInfo.major !== majorFilter) return false;
        
        // å¹´çº§ç­›é€‰
        if (gradeFilter && studentInfo.grade !== gradeFilter) return false;
        
        // å§“åæœç´¢
        if (searchText && !studentName.toLowerCase().includes(searchText)) return false;
        
        return true;
    });
    
    if (filteredStudents.length === 0) {
        container.innerHTML = `
            <div class="practice-empty-state" style="grid-column: 1 / -1;">
                <div class="practice-empty-state-icon">ğŸ”</div>
                <div class="practice-empty-state-title">${t('filter.no_results', 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿ')}</div>
                <div class="practice-empty-state-description">${t('filter.try_different', 'è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶')}</div>
            </div>
        `;
        return;
    }
    
    displayFilteredPracticeStatus(filteredStudents);
}

// ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºç­›é€‰åçš„ç»ƒç´çŠ¶æ€
function displayFilteredPracticeStatus(filteredStudents) {
    const container = document.getElementById('practiceStudentList');
    const practiceData = attendanceData.realTimePractice || {};
    
    let html = '';
    
    const sortedStudents = filteredStudents.sort((a, b) => {
        const durationA = practiceData[a].currentDuration || 0;
        const durationB = practiceData[b].currentDuration || 0;
        return durationB - durationA;
    });
    
    sortedStudents.forEach(studentName => {
        const practiceInfo = practiceData[studentName];
        const studentInfo = getStudentInfoFromDatabase(studentName);
        
        let currentDuration = practiceInfo.currentDuration || 0;
        if (practiceInfo.startTime) {
            const now = Date.now();
            const startTime = new Date(practiceInfo.startTime).getTime();
            currentDuration = Math.floor((now - startTime) / 1000);
            
            practiceData[studentName].currentDuration = currentDuration;
        }
        
        const duration = formatPracticeDuration(currentDuration);
        const startTime = new Date(practiceInfo.startTime).toLocaleTimeString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });

        const practiceType = isWeekend() ? 
            t('practice.type.weekend', 'å‘¨æœ«è‡ªä¸»ç»ƒç´') : 
            t('practice.type.unscheduled', 'æ—¶é—´æ®µå¤–ç»ƒç´');
        
        html += `
            <div class="practice-status-card" onclick="showStudentDetail('${studentName}')">
                <div class="practice-indicator"></div>
                <div class="student-header">
                    <div class="student-name">${studentName}</div>
                    <div class="practice-duration">${duration}</div>
                </div>
                <div class="practice-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('practice.room', 'æ‰€åœ¨ç´æˆ¿')}</div>
                        <div class="detail-value">${practiceInfo.room || t('student.not_in_room', 'æœªçŸ¥ç´æˆ¿')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('practice.start_time', 'å¼€å§‹æ—¶é—´')}</div>
                        <div class="detail-value">${startTime}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.major', 'ä¸“ä¸š')}</div>
                        <div class="detail-value">${studentInfo.major}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.grade', 'å¹´çº§')}</div>
                        <div class="detail-value">${studentInfo.grade || t('student.not_set', 'æœªè®¾ç½®')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('practice.type', 'ç»ƒç´ç±»å‹')}</div>
                        <div class="detail-value">${practiceType}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºç©ºçš„ç»ƒç´çŠ¶æ€
function displayEmptyPracticeState() {
    const container = document.getElementById('practiceStudentList');
    const emptyDesc = isWeekend() ? 
        t('practice.empty.desc.weekend', 'å‘¨æœ«æ—¶é—´ï¼Œå­¦ç”Ÿå¯è‡ªä¸»å®‰æ’ç»ƒç´') : 
        t('practice.empty.desc.weekday', 'å·¥ä½œæ—¥æ—¶é—´ï¼Œç­‰å¾…å­¦ç”Ÿå¼€å§‹ç»ƒç´');
        
    container.innerHTML = `
        <div class="practice-empty-state" style="grid-column: 1 / -1;">
            <div class="practice-empty-state-icon">ğŸ¹</div>
            <div class="practice-empty-state-title">${t('practice.empty.title', 'å½“å‰æ²¡æœ‰å­¦ç”Ÿåœ¨ç»ƒç´')}</div>
            <div class="practice-empty-state-description">${emptyDesc}</div>
        </div>
    `;
}

// ğŸ”¥ æ–°å¢ï¼šæ›´æ–°ç»ƒç´ç­›é€‰å™¨é€‰é¡¹
function updatePracticeFilterOptions() {
    const practiceData = attendanceData.realTimePractice || {};
    const practiceStudents = Object.keys(practiceData);
    
    if (practiceStudents.length === 0) {
        return;
    }
    
    // æ›´æ–°ä¸“ä¸šç­›é€‰
    const majorFilter = document.getElementById('practiceMajorFilter');
    const gradeFilter = document.getElementById('practiceGradeFilter');
    
    if (!majorFilter || !gradeFilter) return;
    
    const currentMajor = majorFilter.value;
    const currentGrade = gradeFilter.value;
    
    // æ”¶é›†æ­£åœ¨ç»ƒç´å­¦ç”Ÿçš„ä¸“ä¸šå’Œå¹´çº§
    const majors = new Set();
    const grades = new Set();
    
    practiceStudents.forEach(studentName => {
        const studentInfo = getStudentInfoFromDatabase(studentName);
        if (studentInfo.major) majors.add(studentInfo.major);
        if (studentInfo.grade) grades.add(studentInfo.grade);
    });
    
    // æ›´æ–°ä¸“ä¸šé€‰é¡¹
    majorFilter.innerHTML = `<option value="">${t('filter.all_majors', 'æ‰€æœ‰ä¸“ä¸š')}</option>`;
    Array.from(majors).sort().forEach(major => {
        const option = document.createElement('option');
        option.value = major;
        option.textContent = major;
        if (major === currentMajor) option.selected = true;
        majorFilter.appendChild(option);
    });
    
    // æ›´æ–°å¹´çº§é€‰é¡¹
    gradeFilter.innerHTML = `<option value="">${t('filter.all_grades', 'æ‰€æœ‰å¹´çº§')}</option>`;
    Array.from(grades).sort().forEach(grade => {
        const option = document.createElement('option');
        option.value = grade;
        option.textContent = grade;
        if (grade === currentGrade) option.selected = true;
        gradeFilter.appendChild(option);
    });
    
    // ç”Ÿæˆå¿«é€Ÿç­›é€‰æ ‡ç­¾
    generatePracticeQuickFilters(majors, grades);
}

// ğŸ”¥ æ–°å¢ï¼šç”Ÿæˆå¿«é€Ÿç­›é€‰æ ‡ç­¾
function generatePracticeQuickFilters(majors, grades) {
    const container = document.getElementById('practiceQuickFilters');
    if (!container) return;
    
    let html = '';
    
    // ä¸“ä¸šå¿«é€Ÿç­›é€‰
    Array.from(majors).sort().forEach(major => {
        html += `<div class="quick-filter-tag" onclick="setQuickFilter('major', '${major}')">${major}</div>`;
    });
    
    // å¹´çº§å¿«é€Ÿç­›é€‰
    Array.from(grades).sort().forEach(grade => {
        html += `<div class="quick-filter-tag" onclick="setQuickFilter('grade', '${grade}')">${grade}</div>`;
    });
    
    // æ¸…é™¤ç­›é€‰
    if (majors.size > 0 || grades.size > 0) {
        html += `<div class="quick-filter-tag" onclick="clearPracticeFilters()" style="background: #f8d7da; color: #721c24; border-color: #f5c6cb;">âœ• ${t('filter.clear', 'æ¸…é™¤')}</div>`;
    }
    
    container.innerHTML = html;
}

// ğŸ”¥ æ–°å¢ï¼šè®¾ç½®å¿«é€Ÿç­›é€‰
function setQuickFilter(type, value) {
    if (type === 'major') {
        document.getElementById('practiceMajorFilter').value = value;
        document.getElementById('practiceGradeFilter').value = '';
    } else if (type === 'grade') {
        document.getElementById('practiceGradeFilter').value = value;
        document.getElementById('practiceMajorFilter').value = '';
    }
    
    document.getElementById('practiceStudentSearch').value = '';
    
    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.quick-filter-tag').forEach(tag => {
        tag.classList.remove('active');
        if (tag.textContent.trim() === value) {
            tag.classList.add('active');
        }
    });
    
    filterPracticeStatus();
}

// ğŸ”¥ æ–°å¢ï¼šæ¸…é™¤ç»ƒç´ç­›é€‰
function clearPracticeFilters() {
    document.getElementById('practiceMajorFilter').value = '';
    document.getElementById('practiceGradeFilter').value = '';
    document.getElementById('practiceStudentSearch').value = '';
    
    document.querySelectorAll('.quick-filter-tag').forEach(tag => {
        tag.classList.remove('active');
    });
    
    displayPracticeStatus();
}

// åˆ›å»ºè€ƒå‹¤å†å²æ—¶é—´è½´
function createAttendanceHistory(student) {
    const history = student.attendanceHistory || [];
    const last7Days = getLast7Days();
    
    let historyHtml = `<div class="attendance-history"><div class="history-title">${t('attendance.history', 'æœ€è¿‘7å¤©è€ƒå‹¤')}</div><div class="history-timeline">`;
    
    // å¯¹äºæ—¶é—´è½´æ˜¾ç¤ºï¼Œæˆ‘ä»¬åè½¬é¡ºåºï¼Œè®©æœ€è¿œçš„æ—¥æœŸåœ¨å·¦è¾¹ï¼Œæœ€è¿‘çš„åœ¨å³è¾¹
    const reversedDays = [...last7Days].reverse();
    
    reversedDays.forEach(date => {
        const dayData = history.find(h => h.date === date);
        const status = dayData ? dayData.status : 'no-data';
        const day = new Date(date).getDate();
        
        const dayName = new Date(date).toLocaleDateString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', { weekday: 'short' });
        const statusText = getStatusText(status);
        const tooltipText = `${date} (${dayName}) - ${statusText}`;
        
        historyHtml += `<div class="history-day ${getStatusClass(status)}" 
                            title="${tooltipText}" 
                            data-date="${date}" 
                            data-status="${status}">${day}</div>`;
    });
    
    historyHtml += '</div></div>';
    return historyHtml;
}


// è·å–æœ€è¿‘7å¤©æ—¥æœŸ
function getLast7Days() {
    const dates = [];
    for (let i = 0; i < 7; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toISOString().split('T')[0]);
    }
    return dates;
}


// è·å–çŠ¶æ€æ ·å¼ç±»
function getStatusClass(status) {
    const statusMap = {
        'present': 'present',
        'absent': 'absent', 
        'excused': 'excused',
        'low_efficiency': 'low-efficiency',
        'low-efficiency': 'low-efficiency',
        'under_review': 'low-efficiency',
        'practicing_unscheduled': 'practicing-unscheduled',
        'weekend': 'weekend',
        'no-data': 'no-data'
    };
    return statusMap[status] || 'no-data';
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(status) {
    const statusMap = {
        'present': t('status.present', 'æ­£å¸¸å‡ºå‹¤'),
        'absent': t('status.absent', 'ç¼ºå‹¤'),
        'excused': t('status.excused', 'è¯·å‡'),
        'low_efficiency': t('status.low_efficiency', 'ä½æ•ˆå‡ºå‹¤'),
        'under_review': t('status.low_efficiency', 'å¾…è§‚å¯Ÿ'),
        'no-data': t('status.no_data', 'æ— æ•°æ®'),
        'practicing_unscheduled': t('status.practicing_unscheduled', 'æ—¶é—´æ®µå¤–ç»ƒç´'),
        'weekend': t('status.weekend', 'å‘¨æœ«')
    };
    return statusMap[status] || t('status.no_data', 'æœªçŸ¥');
}

// è®¡ç®—å‡ºå‹¤ç‡
function calculateAttendanceRate(student) {
    if (!student.attendanceHistory || student.attendanceHistory.length === 0) {
        return 0;
    }
    
    const totalDays = student.attendanceHistory.length;
    const presentDays = student.attendanceHistory.filter(h => 
        h.status === 'present' || h.status === 'low_efficiency'
    ).length;
    
    return Math.round((presentDays / totalDays) * 100);
}

// æ›´æ–°ä»ªè¡¨æ¿
function updateDashboard() {
    const selectedDate = document.getElementById('dateSelect').value;
    if (selectedDate) {
        loadAttendanceData();
    }
    updateExcuseInfoDisplay();
}

// æ›´æ–°è¯·å‡ä¿¡æ¯æ˜¾ç¤º
function updateExcuseInfoDisplay() {
    const today = new Date().toISOString().split('T')[0];
    const todayExcuses = excuseData[today] || {};
    const excusePanel = document.getElementById('excuseInfoPanel');
    const excuseContainer = document.getElementById('excuseInfoContainer');
    
    const excuseList = Object.keys(todayExcuses);
    
    if (excuseList.length === 0) {
        excusePanel.style.display = 'none';
        return;
    }
    
    excusePanel.style.display = 'block';
    
    let html = '<div class="student-grid">';
    
    excuseList.forEach(studentName => {
        const excuse = todayExcuses[studentName];
        const statusClass = excuse.status === 'approved' ? 'success' : 
                           excuse.status === 'pending' ? 'warning' : 'danger';
        const statusText = excuse.status === 'approved' ? t('excuse.status.approved', 'å·²æ‰¹å‡†') :
                          excuse.status === 'pending' ? t('excuse.status.pending', 'å¾…å®¡æ ¸') : t('excuse.status.rejected', 'å·²æ‹’ç»');
        
        html += `
            <div class="student-card ${statusClass}">
                <div class="student-header">
                    <div class="student-name">${studentName}</div>
                    <div class="student-status ${statusClass}">${statusText}</div>
                </div>
                <div class="student-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.reason', 'è¯·å‡åŸå› ')}</div>
                        <div class="detail-value">${excuse.reason || t('excuse.not_filled', 'æœªå¡«å†™')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.time', 'è¯·å‡æ—¶é—´')}</div>
                        <div class="detail-value">${excuse.startDate || today} ${t('report.to', 'è‡³')} ${excuse.endDate || today}</div>
                    </div>
                    ${excuse.approvedBy ? `
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.approver', 'æ‰¹å‡†äºº')}</div>
                        <div class="detail-value">${excuse.approvedBy}</div>
                    </div>
                    ` : ''}
                    ${excuse.submittedAt ? `
                    <div class="detail-item">
                        <div class="detail-label">${t('excuse.submit_time', 'æäº¤æ—¶é—´')}</div>
                        <div class="detail-value">${new Date(excuse.submittedAt).toLocaleString()}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    excuseContainer.innerHTML = html;
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®
function updateStatistics(data) {
    const students = Object.values(data);
    const total = students.length;
    const present = students.filter(s => s.finalAttendanceStatus === 'present').length;
    const absent = students.filter(s => s.finalAttendanceStatus === 'absent').length;
    const excused = students.filter(s => s.finalAttendanceStatus === 'excused').length;
    const unscheduled = students.filter(s => s.finalAttendanceStatus === 'practicing_unscheduled').length;
    const weekend = students.filter(s => s.finalAttendanceStatus === 'weekend').length;
    
    if (isWeekend()) {
        updateWeekendStats(total, unscheduled, weekend - unscheduled);
    } else {
        updateWeekdayStats(total, present, absent, excused, unscheduled);
    }
}

function updateWeekendStats(total, practicing, resting) {
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('presentCount').textContent = practicing;
    document.getElementById('absentCount').textContent = resting;
    document.getElementById('excusedCount').textContent = 0;
    
    // æ›´æ–°æ ‡ç­¾æ–‡å­—
    document.querySelector('#presentCount').parentElement.querySelector('.stat-label').textContent = t('stats.practicing', 'æ­£åœ¨ç»ƒç´');
    document.querySelector('#absentCount').parentElement.querySelector('.stat-label').textContent = t('stats.not_practicing', 'æœªåœ¨ç»ƒç´');
    document.querySelector('#excusedCount').parentElement.querySelector('.stat-label').textContent = t('status.weekend', 'å‘¨æœ«');
}

function updateWeekdayStats(total, present, absent, excused, unscheduled) {
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('excusedCount').textContent = excused;
    
    // æ¢å¤å·¥ä½œæ—¥æ ‡ç­¾
    document.querySelector('#presentCount').parentElement.querySelector('.stat-label').textContent = t('stats.present', 'æ­£å¸¸å‡ºå‹¤');
    document.querySelector('#absentCount').parentElement.querySelector('.stat-label').textContent = t('stats.absent', 'ç¼ºå‹¤å­¦ç”Ÿ');
    document.querySelector('#excusedCount').parentElement.querySelector('.stat-label').textContent = t('stats.excused', 'è¯·å‡å­¦ç”Ÿ');
}

// åˆ·æ–°ç»ƒç´çŠ¶æ€
function refreshPracticeStatus() {
    updateCurrentTime();
    
    if (isOnline) {
        addSyncLog('ğŸ”„ ' + t('sync.refreshing_practice', 'æ­£åœ¨åˆ·æ–°å®æ—¶ç»ƒç´çŠ¶æ€...'));
        
        // ğŸ”¥ ä¿®æ”¹ï¼šå…ˆæ¸…ç†è¿‡æœŸæ•°æ®ï¼Œå†å¼ºåˆ¶éªŒè¯
        validateAndCleanExpiredData();
        triggerRealTimePracticeStatusUpdate();
        
        // ğŸ”¥ æ–°å¢ï¼šå»¶è¿Ÿå†æ¬¡éªŒè¯ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
        setTimeout(() => {
            forceValidateRealTimePractice();
        }, 2000);
    } else {
        updatePracticeDurations();
        displayPracticeStatus();
    }
    
    addSyncLog('ğŸ¹ ' + t('sync.practice_refreshed', 'å·²åˆ·æ–°å®æ—¶ç»ƒç´çŠ¶æ€'));
}


// æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const currentTimeEl = document.getElementById('currentTime');
    if (currentTimeEl) {
        currentTimeEl.textContent = timeString;
    }
}

// æ˜¾ç¤ºå®æ—¶ç»ƒç´çŠ¶æ€
function displayPracticeStatus() {
    const container = document.getElementById('practiceStudentList');
    if (!container) return;
    
    const practiceData = attendanceData.realTimePractice || {};
    const practiceStudents = Object.keys(practiceData);
    
    if (practiceStudents.length === 0) {
        displayEmptyPracticeState();
        // æ¸…ç©ºç­›é€‰å™¨
        const majorFilter = document.getElementById('practiceMajorFilter');
        const gradeFilter = document.getElementById('practiceGradeFilter');
        const quickFilters = document.getElementById('practiceQuickFilters');
        
        if (majorFilter) majorFilter.innerHTML = `<option value="">${t('filter.all_majors', 'æ‰€æœ‰ä¸“ä¸š')}</option>`;
        if (gradeFilter) gradeFilter.innerHTML = `<option value="">${t('filter.all_grades', 'æ‰€æœ‰å¹´çº§')}</option>`;
        if (quickFilters) quickFilters.innerHTML = '';
        
        return;
    }
    
    // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
    updatePracticeFilterOptions();
    
    // åº”ç”¨å½“å‰ç­›é€‰æ¡ä»¶
    filterPracticeStatus();
}


// åˆå§‹åŒ–å®æ—¶ç»ƒç´çŠ¶æ€æ˜¾ç¤º
function initPracticeStatusDisplay() {
    updateCurrentTime();
    displayPracticeStatus();
    
    // ğŸ”¥ ä¿®æ”¹ï¼šæ›´é¢‘ç¹çš„æ•°æ®åˆ·æ–°å’ŒéªŒè¯
    setInterval(() => {
        updateCurrentTime();
        if (currentTab === 'dashboard') {
            if (isOnline) {
                // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€å˜åŒ–å¹¶åŒæ­¥
                periodicRealTimePracticeStatusCheck();
                cleanupEndedPracticeStatus();
            } else {
                updatePracticeDurations();
                displayPracticeStatus();
            }
        }
    }, 10000);
    
    // ğŸ”¥ æ–°å¢ï¼šæ¯30ç§’è¿›è¡Œä¸€æ¬¡å¼ºåˆ¶éªŒè¯
    setInterval(() => {
        if (isOnline && currentTab === 'dashboard') {
            validateAndCleanExpiredData();
            triggerRealTimePracticeStatusUpdate();
        }
    }, 30000);
    
    setInterval(updateCurrentTime, 1000);
    
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && currentTab === 'dashboard') {
            debugLog('é¡µé¢å˜ä¸ºå¯è§ï¼Œå¼€å§‹å¼ºåˆ¶åŒæ­¥');
            setTimeout(() => {
                validateAndCleanExpiredData();
                
                if (isOnline) {
                    triggerRealTimePracticeStatusUpdate();
                } else {
                    displayPracticeStatus();
                }
            }, 1000);
        }
    });
}

// ä¸“é—¨åˆ·æ–°å®æ—¶ç»ƒç´æ•°æ®çš„å‡½æ•°
function refreshRealTimePracticeData() {
    if (!isOnline || !database) return;
    
    const refreshPromises = [];
    
    const practicePromise = database.ref('realTimePracticeStatus').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRemoteRealTimePracticeUpdate(snapshot.val());
            }
        })
        .catch((error) => {
            console.log('åˆ·æ–°å®æ—¶ç»ƒç´çŠ¶æ€å¤±è´¥:', error.message);
        });
    refreshPromises.push(practicePromise);
    
    const roomsPromise = database.ref('rooms').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                handleRoomsUpdate(snapshot.val());
            }
        })
        .catch((error) => {
            console.log('åˆ·æ–°ç´æˆ¿çŠ¶æ€å¤±è´¥:', error.message);
        });
    refreshPromises.push(roomsPromise);
    
    Promise.all(refreshPromises).then(() => {
        displayPracticeStatus();
        updatePracticeDurations();
    });
}

// æ›´æ–°ç»ƒç´æ—¶é•¿æ˜¾ç¤º
function updatePracticeDurations() {
    if (!attendanceData.realTimePractice) return;
    
    const now = Date.now();
    let hasUpdates = false;
    
    Object.keys(attendanceData.realTimePractice).forEach(studentName => {
        const practiceInfo = attendanceData.realTimePractice[studentName];
        if (practiceInfo.startTime) {
            const startTime = new Date(practiceInfo.startTime).getTime();
            const newDuration = Math.floor((now - startTime) / 1000);
            
            if (newDuration !== practiceInfo.currentDuration) {
                attendanceData.realTimePractice[studentName].currentDuration = newDuration;
                hasUpdates = true;
            }
        }
    });
    
    if (hasUpdates) {
        displayPracticeStatus();
        // ğŸ”¥ ç§»é™¤ï¼šä¸å†ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        
        // æœ‰æ›´æ–°æ—¶è§¦å‘åŒæ­¥æ£€æŸ¥
        if (isOnline) {
            checkAndUpdateRealTimePracticeStatus(false);
        }
    }
}



// åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«
function isWeekend() {
    const day = new Date().getDay();
    return day === 0 || day === 6;
}

// ä»å­¦ç”Ÿæ•°æ®åº“è·å–å­¦ç”Ÿä¿¡æ¯
function getStudentInfoFromDatabase(studentName) {
    for (const [major, students] of Object.entries(studentData)) {
        if (Array.isArray(students)) {
            const found = students.find(student => {
                const name = typeof student === 'string' ? student : student.name;
                return name === studentName;
            });
            if (found) {
                return {
                    major: major,
                    grade: typeof found === 'object' ? found.grade || '' : ''
                };
            }
        }
    }
    return { major: t('student.unknown_major', 'æœªçŸ¥ä¸“ä¸š'), grade: '' };
}

// æ ¼å¼åŒ–ç»ƒç´æ—¶é•¿
function formatPracticeDuration(seconds) {
    if (!seconds || seconds <= 0) return t('time.no_practice', '0åˆ†é’Ÿ');
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}${t('time.hours', 'å°æ—¶')}${minutes > 0 ? minutes + t('time.minutes', 'åˆ†é’Ÿ') : ''}`;
    } else if (minutes > 0) {
        return `${minutes}${t('time.minutes', 'åˆ†é’Ÿ')}${secs > 0 ? secs + t('time.seconds', 'ç§’') : ''}`;
    } else {
        return `${secs}${t('time.seconds', 'ç§’')}`;
    }
}

// è·å–å­¦ç”Ÿè€ƒå‹¤å†å²
function getStudentAttendanceHistory(studentName) {
    const history = [];
    const last7Days = getLast7Days();
    
    last7Days.forEach(date => {
        const dayData = attendanceData[date];
        if (dayData && dayData[studentName]) {
            history.push({
                date: date,
                status: dayData[studentName].finalAttendanceStatus || 'no-data'
            });
        } else {
            history.push({
                date: date,
                status: 'no-data'
            });
        }
    });
    
    return history;
}

// ğŸ”¥ å¢å¼ºçš„è¿‡æœŸæ•°æ®æ¸…ç†å‡½æ•°
function validateAndCleanExpiredData() {
    if (!attendanceData.realTimePractice) return;
    
    const now = Date.now();
    const maxAge = 15 * 60 * 1000; // ğŸ”¥ è¿›ä¸€æ­¥ç¼©çŸ­åˆ°15åˆ†é’Ÿ
    let cleaned = 0;
    
    Object.keys(attendanceData.realTimePractice).forEach(studentName => {
        const practiceInfo = attendanceData.realTimePractice[studentName];
        
        // æ£€æŸ¥æ˜¯å¦ç¼ºå°‘å¿…è¦å­—æ®µ
        if (!practiceInfo || !practiceInfo.lastUpdated || !practiceInfo.startTime) {
            debugLog(`æ¸…ç†ç¼ºå°‘å¿…è¦å­—æ®µçš„è®°å½•: ${studentName}`);
            delete attendanceData.realTimePractice[studentName];
            cleaned++;
            return;
        }
        
        const lastUpdated = new Date(practiceInfo.lastUpdated).getTime();
        const startTime = new Date(practiceInfo.startTime).getTime();
        const age = now - lastUpdated;
        const practiceAge = now - startTime;
        
        // ğŸ”¥ æ›´ä¸¥æ ¼çš„è¿‡æœŸæ£€æµ‹
        if (isNaN(lastUpdated) || isNaN(startTime) || 
            age > maxAge || 
            practiceAge > 8 * 60 * 60 * 1000 || // ğŸ”¥ ç»ƒç´è¶…è¿‡8å°æ—¶è§†ä¸ºå¼‚å¸¸
            startTime > now) { // å¼€å§‹æ—¶é—´åœ¨æœªæ¥
            
            debugLog(`æ¸…ç†è¿‡æœŸ/å¼‚å¸¸è®°å½•: ${studentName} (æ›´æ–°${Math.round(age/60000)}åˆ†é’Ÿå‰, ç»ƒç´${Math.round(practiceAge/60000)}åˆ†é’Ÿ)`);
            delete attendanceData.realTimePractice[studentName];
            cleaned++;
        }
    });
    
    if (cleaned > 0) {
        localStorage.setItem('realTimePracticeStatus', JSON.stringify(attendanceData.realTimePractice));
        displayPracticeStatus();
        addSyncLog(`ğŸ§¹ å·²æ¸…ç† ${cleaned} ä¸ªè¿‡æœŸ/å¼‚å¸¸çš„ç»ƒç´è®°å½•`);
    }
}


// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.getElementById(tabName + 'Tab').style.display = 'block';
    
    event.target.classList.add('active');
    
    currentTab = tabName;
    
    switch(tabName) {
        case 'dashboard':
            if (isOnline) {
                forceRefreshAllData();
            } else {
                loadAttendanceData();
                displayPracticeStatus();
            }
            break;
        case 'students':
            if (isOnline) {
                database.ref('studentDatabase').once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            studentData = snapshot.val();
                            updateFilters();
                        }
                        loadStudentList();
                        addSyncLog('âœ… ' + t('sync.student_page_refreshed', 'å­¦ç”Ÿé¡µé¢æ•°æ®å·²åˆ·æ–°'));
                    })
                    .catch((error) => {
                        loadStudentList();
                        addSyncLog(`âš ï¸ å­¦ç”Ÿæ•°æ®åˆ·æ–°å¤±è´¥: ${error.message}`);
                    });
            } else {
                loadStudentList();
            }
            break;
        case 'reports':
            initReportsTab();
            break;
        case 'sync':
            updateSyncStatus();
            break;
    }
}

// åŠ è½½å­¦ç”Ÿåˆ—è¡¨
function loadStudentList() {
    if (!isOnline) {
        showEmptyState('studentList', t('sync.offline', 'ç¦»çº¿æ¨¡å¼'), t('msg.network_required', 'éœ€è¦è¿æ¥åˆ°ç½‘ç»œæ‰èƒ½æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…'));
        return;
    }
    
    showLoading('studentList');
    
    const combinedData = combineStudentAndAttendanceData();
    
    console.log('åˆå¹¶åçš„å­¦ç”Ÿæ•°æ®æ•°é‡:', Object.keys(combinedData).length);
    console.log('å­¦ç”Ÿåˆ—è¡¨:', Object.keys(combinedData));
    
    displayStudentList(combinedData);
    updateStatusFilterOptions();
    
    addSyncLog(`ğŸ“‹ å·²åŠ è½½ ${Object.keys(combinedData).length} åå­¦ç”Ÿçš„ä¿¡æ¯`);
}

// åˆå¹¶å­¦ç”Ÿå’Œè€ƒå‹¤æ•°æ®
function combineStudentAndAttendanceData() {
    const combined = {};
    const today = new Date().toISOString().split('T')[0];
    const todayAttendance = attendanceData[today] || {};
    const todayExcuses = excuseData[today] || {};
    
    Object.keys(studentData).forEach(major => {
        if (Array.isArray(studentData[major])) {
            studentData[major].forEach(student => {
                const studentName = typeof student === 'string' ? student : student.name;
                const studentGrade = typeof student === 'object' ? student.grade : '';
                
                if (!studentName) return;
                
                const excuseInfo = todayExcuses[studentName];
                let defaultStatus = isWeekend() ? 'weekend' : 'absent';
                let defaultStatusText = isWeekend() ? t('status.weekend', 'å‘¨æœ«') : t('status.absent', 'ç¼ºå‹¤');
                
                if (excuseInfo && excuseInfo.status === 'approved') {
                    defaultStatus = 'excused';
                    defaultStatusText = t('status.excused', 'è¯·å‡');
                }
                
                combined[studentName] = {
                    name: studentName,
                    major: major,
                    grade: studentGrade,
                    finalAttendanceStatus: defaultStatus,
                    finalStatusText: defaultStatusText,
                    practicedText: t('time.no_practice', '0åˆ†é’Ÿ'),
                    room: t('student.not_in_room', 'ä¸åœ¨ç´æˆ¿'),
                    start: '',
                    end: '',
                    attendanceHistory: getStudentAttendanceHistory(studentName),
                    excuseInfo: excuseInfo || null
                };
            });
        }
    });
    
    Object.keys(todayAttendance).forEach(studentName => {
        const attendanceRecord = todayAttendance[studentName];
        
        if (combined[studentName]) {
            combined[studentName] = {
                ...combined[studentName],
                ...attendanceRecord,
                attendanceHistory: getStudentAttendanceHistory(studentName)
            };
        } else {
            const studentInfo = getStudentInfoFromDatabase(studentName);
            combined[studentName] = {
                name: studentName,
                major: studentInfo.major,
                grade: studentInfo.grade,
                ...attendanceRecord,
                attendanceHistory: getStudentAttendanceHistory(studentName),
                excuseInfo: todayExcuses[studentName] || null
            };
        }
    });
    
    if (attendanceData.realTimePractice) {
        Object.keys(attendanceData.realTimePractice).forEach(studentName => {
            const practiceStatus = attendanceData.realTimePractice[studentName];
            
            if (!combined[studentName]) {
                const studentInfo = getStudentInfoFromDatabase(studentName);
                
                combined[studentName] = {
                    name: studentName,
                    major: studentInfo.major,
                    grade: studentInfo.grade,
                    finalAttendanceStatus: 'practicing_unscheduled',
                    finalStatusText: isWeekend() ? t('practice.type.weekend', 'å‘¨æœ«è‡ªä¸»ç»ƒç´') : t('practice.type.unscheduled', 'æ—¶é—´æ®µå¤–ç»ƒç´'),
                    practicedText: formatPracticeDuration(practiceStatus.currentDuration || 0),
                    room: practiceStatus.room || t('student.not_in_room', 'ä¸åœ¨ç´æˆ¿'),
                    start: '',
                    end: '',
                    attendanceHistory: getStudentAttendanceHistory(studentName),
                    excuseInfo: todayExcuses[studentName] || null
                };
            } else {
                combined[studentName].finalAttendanceStatus = 'practicing_unscheduled';
                combined[studentName].finalStatusText = isWeekend() ? 
                    t('practice.type.weekend', 'å‘¨æœ«è‡ªä¸»ç»ƒç´') : 
                    t('practice.type.unscheduled', 'æ—¶é—´æ®µå¤–ç»ƒç´');
                combined[studentName].practicedText = formatPracticeDuration(practiceStatus.currentDuration || 0);
                combined[studentName].room = practiceStatus.room || combined[studentName].room;
            }
        });
    }
    
    return combined;
}

// æ˜¾ç¤ºå­¦ç”Ÿåˆ—è¡¨
function displayStudentList(students) {
    const container = document.getElementById('studentList');
    
    if (!students || Object.keys(students).length === 0) {
        showEmptyState('studentList', t('empty.no_students', 'æš‚æ— å­¦ç”Ÿæ•°æ®'), t('empty.ensure_sync', 'è¯·ç¡®ä¿å­¦ç”Ÿæ•°æ®å·²æ­£ç¡®åŒæ­¥'));
        return;
    }
    
    const filteredStudents = filterStudentsByCurrentFilters(students);
    
    if (filteredStudents.length === 0) {
        showEmptyState('studentList', t('filter.no_results', 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿ'), t('filter.try_different', 'è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶'));
        return;
    }
    
    let html = '<div class="student-grid">';
    
    const groupedByMajor = {};
    filteredStudents.forEach(student => {
        const major = student.major || t('student.unknown_major', 'å…¶ä»–');
        if (!groupedByMajor[major]) {
            groupedByMajor[major] = [];
        }
        groupedByMajor[major].push(student);
    });
    
    Object.keys(groupedByMajor).sort().forEach(major => {
        html += `<div style="grid-column: 1 / -1; margin: 20px 0 10px 0;">
                    <h4 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">
                        ${major} (${groupedByMajor[major].length}${t('report.people', 'äºº')})
                    </h4>
                </div>`;
        
        groupedByMajor[major].forEach(student => {
            html += createStudentCard(student, false);
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶è¿‡æ»¤å­¦ç”Ÿ
function filterStudentsByCurrentFilters(students) {
    const majorFilter = document.getElementById('majorFilter').value;
    const gradeFilter = document.getElementById('gradeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const searchText = document.getElementById('studentSearch').value.toLowerCase();
    
    return Object.values(students).filter(student => {
        if (majorFilter && student.major !== majorFilter) return false;
        if (gradeFilter && student.grade !== gradeFilter) return false;
        if (statusFilter && student.finalAttendanceStatus !== statusFilter) return false;
        if (searchText && !student.name.toLowerCase().includes(searchText)) return false;
        return true;
    });
}

// ç­›é€‰å­¦ç”Ÿ
function filterStudents() {
    if (currentTab === 'students') {
        const combinedData = combineStudentAndAttendanceData();
        displayStudentList(combinedData);
    }
}

// æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
function updateFilters() {
    updateMajorFilterOptions();
    updateGradeFilterOptions();
    updateStatusFilterOptions();
}

// æ›´æ–°ä¸“ä¸šç­›é€‰é€‰é¡¹
function updateMajorFilterOptions() {
    const majorFilter = document.getElementById('majorFilter');
    const currentValue = majorFilter.value;
    
    majorFilter.innerHTML = `<option value="">${t('filter.all_majors', 'æ‰€æœ‰ä¸“ä¸š')}</option>`;
    
    const majors = Object.keys(studentData).sort();
    majors.forEach(major => {
        const option = document.createElement('option');
        option.value = major;
        option.textContent = major;
        if (major === currentValue) {
            option.selected = true;
        }
        majorFilter.appendChild(option);
    });
}

// æ›´æ–°å¹´çº§ç­›é€‰é€‰é¡¹
function updateGradeFilterOptions() {
    const gradeFilter = document.getElementById('gradeFilter');
    const currentValue = gradeFilter.value;
    
    gradeFilter.innerHTML = `<option value="">${t('filter.all_grades', 'æ‰€æœ‰å¹´çº§')}</option>`;
    
    const grades = new Set();
    Object.values(studentData).forEach(students => {
        if (Array.isArray(students)) {
            students.forEach(student => {
                if (typeof student === 'object' && student.grade) {
                    grades.add(student.grade);
                }
            });
        }
    });
    
    Array.from(grades).sort().forEach(grade => {
        const option = document.createElement('option');
        option.value = grade;
        option.textContent = grade;
        if (grade === currentValue) {
            option.selected = true;
        }
        gradeFilter.appendChild(option);
    });
}

// æ›´æ–°çŠ¶æ€ç­›é€‰é€‰é¡¹
function updateStatusFilterOptions() {
    const statusFilter = document.getElementById('statusFilter');
    const currentValue = statusFilter.value;
    
    statusFilter.innerHTML = `
        <option value="">${t('filter.all_status', 'æ‰€æœ‰çŠ¶æ€')}</option>
        <option value="present">${t('status.present', 'æ­£å¸¸å‡ºå‹¤')}</option>
        <option value="absent">${t('status.absent', 'ç¼ºå‹¤')}</option>
        <option value="excused">${t('status.excused', 'è¯·å‡')}</option>
        <option value="low-efficiency">${t('status.low_efficiency', 'ä½æ•ˆå‡ºå‹¤')}</option>
        <option value="practicing_unscheduled">${t('status.practicing_unscheduled', 'æ—¶é—´æ®µå¤–ç»ƒç´')}</option>
        <option value="weekend">${t('status.weekend', 'å‘¨æœ«')}</option>
    `;
    
    if (currentValue) {
        statusFilter.value = currentValue;
    }
}

// æ˜¾ç¤ºå­¦ç”Ÿè¯¦æƒ…
function showStudentDetail(studentName) {
    if (!isOnline) {
        alert(t('msg.network_required', 'éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½æŸ¥çœ‹å­¦ç”Ÿè¯¦æƒ…'));
        return;
    }
    
    const modal = document.getElementById('studentDetailModal');
    const title = document.getElementById('studentDetailTitle');
    const content = document.getElementById('studentDetailContent');
    
    title.textContent = `${studentName} - ${t('student.detail.title', 'å­¦ç”Ÿè¯¦æƒ…')}`;
    
    content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    modal.classList.add('show');
    
    loadStudentDetailData(studentName).then(studentData => {
        content.innerHTML = createStudentDetailContent(studentData);
    }).catch(error => {
        content.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âŒ</div>
                <div class="empty-state-title">${t('msg.student_not_found', 'æœªæ‰¾åˆ°å­¦ç”Ÿä¿¡æ¯')}</div>
                <div class="empty-state-description">${error.message}</div>
            </div>
        `;
    });
}

// åŠ è½½å­¦ç”Ÿè¯¦ç»†æ•°æ®
function loadStudentDetailData(studentName) {
    return new Promise((resolve, reject) => {
        const combinedData = combineStudentAndAttendanceData();
        const student = combinedData[studentName];
        
        if (!student) {
            reject(new Error(t('msg.student_not_found', 'æœªæ‰¾åˆ°å­¦ç”Ÿä¿¡æ¯')));
            return;
        }
        
        // åŠ è½½æ›´å¤šå†å²æ•°æ®
        const promises = [];
        const last30Days = getLast30Days();
        
        last30Days.forEach(date => {
            if (isOnline && !attendanceData[date]) {
                const promise = database.ref(`attendanceData/${date}/${studentName}`).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            if (!attendanceData[date]) {
                                attendanceData[date] = {};
                            }
                            attendanceData[date][studentName] = snapshot.val();
                        }
                    })
                    .catch(error => {
                        console.warn(`åŠ è½½ ${date} çš„æ•°æ®å¤±è´¥:`, error);
                    });
                promises.push(promise);
            }
        });
        
        Promise.all(promises).then(() => {
            student.extendedHistory = getExtendedAttendanceHistory(studentName);
            resolve(student);
        });
    });
}

// è·å–æœ€è¿‘30å¤©æ—¥æœŸ
function getLast30Days() {
    const dates = [];
    for (let i = 0; i < 30; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toISOString().split('T')[0]);
    }
    return dates;
}

// è·å–æ‰©å±•çš„è€ƒå‹¤å†å²
function getExtendedAttendanceHistory(studentName) {
    const history = [];
    const last30Days = getLast30Days();
    
    last30Days.forEach(date => {
        const dayData = attendanceData[date];
        if (dayData && dayData[studentName]) {
            const studentRecord = dayData[studentName];
            let scheduledDuration = '0åˆ†é’Ÿ';
            let unscheduledDuration = '0åˆ†é’Ÿ';
            let totalDuration = studentRecord.practicedText || t('time.no_practice', '0åˆ†é’Ÿ');

            // å¦‚æœæœ‰è¯¦ç»†çš„ç»ƒç´è®°å½•ï¼Œå¯ä»¥åˆ†åˆ«ç»Ÿè®¡
            if (studentRecord.scheduledPracticeTime) {
                scheduledDuration = formatPracticeDuration(studentRecord.scheduledPracticeTime);
            }
            if (studentRecord.unscheduledPracticeTime) {
                unscheduledDuration = formatPracticeDuration(studentRecord.unscheduledPracticeTime);
            }

            history.push({
                date: date,
                status: studentRecord.finalAttendanceStatus || 'no-data',
                practiceDuration: totalDuration,
                scheduledDuration: scheduledDuration,    // æ–°å¢ï¼šè§„å®šæ—¶é—´æ®µç»ƒç´
                unscheduledDuration: unscheduledDuration, // æ–°å¢ï¼šæ—¶é—´æ®µå¤–ç»ƒç´
                room: studentRecord.room || t('student.not_in_room', 'ä¸åœ¨ç´æˆ¿')
            });

        } else {
            history.push({
                date: date,
                status: 'no-data',
                practiceDuration: t('time.no_practice', '0åˆ†é’Ÿ'),
                room: t('student.not_in_room', 'ä¸åœ¨ç´æˆ¿')
            });
        }
    });
    
    return history;
}

// åˆ›å»ºå­¦ç”Ÿè¯¦æƒ…å†…å®¹
function createStudentDetailContent(student) {
    const attendanceStats = calculateDetailedAttendanceStats(student.extendedHistory);
    
    return `
        <div class="student-detail-content">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="card">
                <h4>${t('student.basic_info', 'åŸºæœ¬ä¿¡æ¯')}</h4>
                <div class="student-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('student.name', 'å§“å')}</div>
                        <div class="detail-value">${student.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.major', 'ä¸“ä¸š')}</div>
                        <div class="detail-value">${student.major || t('student.not_set', 'æœªè®¾ç½®')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.grade', 'å¹´çº§')}</div>
                        <div class="detail-value">${student.grade || t('student.not_set', 'æœªè®¾ç½®')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.time_slot', 'æ—¶é—´æ®µ')}</div>
                        <div class="detail-value">${student.start && student.end ? `${student.start} - ${student.end}` : t('student.self_practice', 'è‡ªä¸»ç»ƒç´')}</div>
                    </div>
                </div>
            </div>

            <!-- ä»Šæ—¥çŠ¶æ€ -->
            <div class="card ${getStatusClass(student.finalAttendanceStatus)}">
                <h4>${t('student.today_attendance', 'ä»Šæ—¥è€ƒå‹¤')}</h4>
                <div class="student-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('attendance.status', 'è€ƒå‹¤çŠ¶æ€')}</div>
                        <div class="detail-value">${student.finalStatusText || getStatusText(student.finalAttendanceStatus)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.practice_duration', 'ç»ƒç´æ—¶é•¿')}</div>
                        <div class="detail-value">${student.practicedText || t('time.no_practice', '0åˆ†é’Ÿ')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${t('student.room', 'æ‰€åœ¨ç´æˆ¿')}</div>
                        <div class="detail-value">${student.room || t('student.not_in_room', 'ä¸åœ¨ç´æˆ¿')}</div>
                    </div>
                    ${student.excuseInfo ? `
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label">${t('excuse.reason', 'è¯·å‡ä¿¡æ¯')}</div>
                        <div class="detail-value" style="color: #f39c12;">
                            ${student.excuseInfo.reason || t('status.excused', 'å·²è¯·å‡')}
                            ${student.excuseInfo.approvedBy ? `<br><small>${t('excuse.approver', 'æ‰¹å‡†äºº')}: ${student.excuseInfo.approvedBy}</small>` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>

            <!-- è€ƒå‹¤ç»Ÿè®¡ -->
            <div class="card">
                <h4>${t('student.attendance_stats', 'è€ƒå‹¤ç»Ÿè®¡')} (${t('report.last_30_days', 'æœ€è¿‘30å¤©')})</h4>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                    <div class="stat-card present">
                        <div class="stat-number">${attendanceStats.present}</div>
                        <div class="stat-label">${t('stats.present', 'æ­£å¸¸å‡ºå‹¤')}</div>
                    </div>
                    <div class="stat-card absent">
                        <div class="stat-number">${attendanceStats.absent}</div>
                        <div class="stat-label">${t('stats.absent', 'ç¼ºå‹¤')}</div>
                    </div>
                    <div class="stat-card excused">
                        <div class="stat-number">${attendanceStats.excused}</div>
                        <div class="stat-label">${t('stats.excused', 'è¯·å‡')}</div>
                    </div>
                    <div class="stat-card total">
                        <div class="stat-number">${attendanceStats.rate}%</div>
                        <div class="stat-label">${t('attendance.rate', 'å‡ºå‹¤ç‡')}</div>
                    </div>
                </div>
            </div>

            <!-- å†å²è®°å½• -->
            <div class="card">
                <h4>${t('student.history_records', 'å†å²è®°å½•')} (${t('report.last_30_days', 'æœ€è¿‘30å¤©')})</h4>
                <div class="data-table-container" style="max-height: 300px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>${t('report.date', 'æ—¥æœŸ')}</th>
                                <th>${t('attendance.status', 'çŠ¶æ€')}</th>
                                <th>${t('practice.scheduled', 'è§„å®šæ—¶æ®µ')}</th>
                                <th>${t('practice.unscheduled', 'æ—¶æ®µå¤–')}</th>
                                <th>${t('practice.total', 'æ€»æ—¶é•¿')}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${student.extendedHistory.map(record => `
                                <tr>
                                    <td>${record.date}</td>
                                    <td><span class="student-status ${getStatusClass(record.status)}">${getStatusText(record.status)}</span></td>
                                    <td>${record.scheduledDuration || '0åˆ†é’Ÿ'}</td>
                                    <td>${record.unscheduledDuration || '0åˆ†é’Ÿ'}</td>
                                    <td><strong>${record.practiceDuration}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

// è®¡ç®—è¯¦ç»†è€ƒå‹¤ç»Ÿè®¡
function calculateDetailedAttendanceStats(history) {
    const total = history.length;
    const present = history.filter(h => h.status === 'present' || h.status === 'low_efficiency').length;
    const absent = history.filter(h => h.status === 'absent').length;
    const excused = history.filter(h => h.status === 'excused').length;
    const validDays = history.filter(h => h.status !== 'no-data').length;
    
    const rate = validDays > 0 ? Math.round((present / validDays) * 100) : 0;
    
    return { total, present, absent, excused, rate };
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
    }
});

// åˆ·æ–°æ•°æ®
function refreshData() {
    if (!isOnline) {
        alert(t('msg.sync_required', 'éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½åŒæ­¥æ•°æ®'));
        return;
    }
    
    addSyncLog('ğŸ”„ ' + t('sync.manual_refresh', 'æ‰‹åŠ¨åˆ·æ–°æ•°æ®...'));
    forceRefreshAllData();
}

// æŠ¥å‘Šç›¸å…³åŠŸèƒ½
function initReportsTab() {
    const today = new Date();
    const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('startDate').value = oneWeekAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

// ç”ŸæˆæŠ¥å‘Š
function generateReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert(t('msg.select_dates', 'è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ'));
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert(t('msg.date_range_error', 'å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ'));
        return;
    }
    
    if (!isOnline) {
        generateOfflineReport(startDate, endDate);
        return;
    }
    
    const reportContent = document.getElementById('reportContent');
    reportContent.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    loadReportData(startDate, endDate).then(data => {
        displayReport(data, startDate, endDate);
        addSyncLog(`ğŸ“Š å·²ç”Ÿæˆ ${startDate} è‡³ ${endDate} çš„è€ƒå‹¤æŠ¥å‘Š`);
    }).catch(error => {
        reportContent.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âŒ</div>
                <div class="empty-state-title">${t('report.generate_failed', 'æŠ¥å‘Šç”Ÿæˆå¤±è´¥')}</div>
                <div class="empty-state-description">${error.message}</div>
            </div>
        `;
        addSyncLog(`âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ${error.message}`);
    });
}

// åŠ è½½æŠ¥å‘Šæ•°æ®
function loadReportData(startDate, endDate) {
    return new Promise((resolve, reject) => {
        const promises = [];
        const reportData = {};
        
        const current = new Date(startDate);
        const end = new Date(endDate);
        
        while (current <= end) {
            const dateStr = current.toISOString().split('T')[0];
            
            if (attendanceData[dateStr]) {
                reportData[dateStr] = attendanceData[dateStr];
            } else {
                const promise = database.ref(`attendanceData/${dateStr}`).once('value')
                    .then(snapshot => {
                        reportData[dateStr] = snapshot.val() || {};
                    })
                    .catch(error => {
                        console.warn(`åŠ è½½ ${dateStr} æ•°æ®å¤±è´¥:`, error);
                        reportData[dateStr] = {};
                    });
                promises.push(promise);
            }
            
            current.setDate(current.getDate() + 1);
        }
        
        Promise.all(promises).then(() => {
            resolve(reportData);
        }).catch(reject);
    });
}

// ç”Ÿæˆç¦»çº¿æŠ¥å‘Š
function generateOfflineReport(startDate, endDate) {
    const reportData = {};
    const current = new Date(startDate);
    const end = new Date(endDate);
    
    while (current <= end) {
        const dateStr = current.toISOString().split('T')[0];
        const localData = localStorage.getItem(`attendance_${dateStr}`);
        reportData[dateStr] = localData ? JSON.parse(localData) : {};
        current.setDate(current.getDate() + 1);
    }
    
    displayReport(reportData, startDate, endDate);
    addSyncLog(`ğŸ“Š å·²ç”Ÿæˆç¦»çº¿æŠ¥å‘Š ${startDate} è‡³ ${endDate}`);
}

// æ˜¾ç¤ºæŠ¥å‘Š
function displayReport(data, startDate, endDate) {
    const reportContent = document.getElementById('reportContent');
    
    const analysis = analyzeReportData(data);
    const dateRange = calculateDateRange(startDate, endDate);
    
    let html = `
        <div class="card">
            <h4>${t('report.analysis_title', 'ğŸ“Š è€ƒå‹¤åˆ†ææŠ¥å‘Š')}</h4>
            <div class="student-details">
                <div class="detail-item">
                    <div class="detail-label">${t('report.period', 'ç»Ÿè®¡å‘¨æœŸ')}</div>
                    <div class="detail-value">${startDate} ${t('report.to', 'è‡³')} ${endDate} (${dateRange}${t('report.days', 'å¤©')})</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${t('report.participants', 'å‚ä¸å­¦ç”Ÿ')}</div>
                    <div class="detail-value">${analysis.totalStudents}${t('report.people', 'äºº')}</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card present">
                <div class="stat-number">${analysis.totalPresent}</div>
                <div class="stat-label">${t('stats.present', 'æ­£å¸¸å‡ºå‹¤')}</div>
                <div class="stat-description">${analysis.presentRate}%</div>
            </div>
            <div class="stat-card absent">
                <div class="stat-number">${analysis.totalAbsent}</div>
                <div class="stat-label">${t('stats.absent', 'ç¼ºå‹¤')}</div>
                <div class="stat-description">${analysis.absentRate}%</div>
            </div>
            <div class="stat-card excused">
                <div class="stat-number">${analysis.totalExcused}</div>
                <div class="stat-label">${t('stats.excused', 'è¯·å‡')}</div>
                <div class="stat-description">${analysis.excusedRate}%</div>
            </div>
            <div class="stat-card total">
                <div class="stat-number">${analysis.totalRecords}</div>
                <div class="stat-label">${t('report.total_records', 'æ€»è®°å½•æ•°')}</div>
                <div class="stat-description">${t('report.all_data', 'å…¨éƒ¨æ•°æ®')}</div>
            </div>
        </div>

        <div class="card">
            <h4>${t('report.daily_trend', 'ğŸ“ˆ æ¯æ—¥è€ƒå‹¤è¶‹åŠ¿')}</h4>
            <div class="data-table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>${t('report.date', 'æ—¥æœŸ')}</th>
                            <th>${t('report.total', 'æ€»äººæ•°')}</th>
                            <th>${t('stats.present', 'æ­£å¸¸å‡ºå‹¤')}</th>
                            <th>${t('stats.absent', 'ç¼ºå‹¤')}</th>
                            <th>${t('stats.excused', 'è¯·å‡')}</th>
                            <th>${t('attendance.rate', 'å‡ºå‹¤ç‡')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.dailyStats.map(day => `
                            <tr>
                                <td>${day.date}</td>
                                <td>${day.total}</td>
                                <td>${day.present}</td>
                                <td>${day.absent}</td>
                                <td>${day.excused}</td>
                                <td>${day.rate}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h4>${t('report.student_stats', 'ğŸ‘¥ å­¦ç”Ÿè€ƒå‹¤ç»Ÿè®¡')}</h4>
            <div class="data-table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>${t('student.name', 'å§“å')}</th>
                            <th>${t('student.major', 'ä¸“ä¸š')}</th>
                            <th>${t('stats.present', 'æ­£å¸¸å‡ºå‹¤')}</th>
                            <th>${t('stats.absent', 'ç¼ºå‹¤')}</th>
                            <th>${t('stats.excused', 'è¯·å‡')}</th>
                            <th>${t('attendance.rate', 'å‡ºå‹¤ç‡')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.studentStats.map(student => `
                            <tr>
                                <td>${student.name}</td>
                                <td>${student.major}</td>
                                <td>${student.present}</td>
                                <td>${student.absent}</td>
                                <td>${student.excused}</td>
                                <td>${student.rate}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="export-options">
            <button class="btn btn-primary" onclick="generateReport()">
                <span>ğŸ”„</span> ${t('report.regenerate', 'é‡æ–°ç”Ÿæˆ')}
            </button>
        </div>
    `;
    
    reportContent.innerHTML = html;
}

// åˆ†ææŠ¥å‘Šæ•°æ®
function analyzeReportData(data) {
    const studentStats = {};
    const dailyStats = [];
    let totalRecords = 0;
    let totalPresent = 0;
    let totalAbsent = 0;
    let totalExcused = 0;
    
    // æŒ‰æ—¥æœŸæ’åº
    const sortedDates = Object.keys(data).sort();
    
    sortedDates.forEach(date => {
        const dayData = data[date];
        const students = Object.values(dayData);
        
        const dayPresent = students.filter(s => s.finalAttendanceStatus === 'present').length;
        const dayAbsent = students.filter(s => s.finalAttendanceStatus === 'absent').length;
        const dayExcused = students.filter(s => s.finalAttendanceStatus === 'excused').length;
        const dayTotal = students.length;
        const dayRate = dayTotal > 0 ? Math.round((dayPresent / dayTotal) * 100) : 0;
        
        dailyStats.push({
            date: date,
            total: dayTotal,
            present: dayPresent,
            absent: dayAbsent,
            excused: dayExcused,
            rate: dayRate
        });
        
        totalRecords += dayTotal;
        totalPresent += dayPresent;
        totalAbsent += dayAbsent;
        totalExcused += dayExcused;
        
        // ç»Ÿè®¡æ¯ä¸ªå­¦ç”Ÿçš„æ•°æ®
        students.forEach(student => {
            if (!studentStats[student.name]) {
                studentStats[student.name] = {
                    name: student.name,
                    major: student.major || t('student.unknown_major', 'æœªçŸ¥ä¸“ä¸š'),
                    present: 0,
                    absent: 0,
                    excused: 0,
                    total: 0
                };
            }
            
            const stats = studentStats[student.name];
            stats.total++;
            
            switch (student.finalAttendanceStatus) {
                case 'present':
                    stats.present++;
                    break;
                case 'absent':
                    stats.absent++;
                    break;
                case 'excused':
                    stats.excused++;
                    break;
            }
        });
    });
    
    // è®¡ç®—å­¦ç”Ÿå‡ºå‹¤ç‡
    const studentStatsArray = Object.values(studentStats).map(student => ({
        ...student,
        rate: student.total > 0 ? Math.round((student.present / student.total) * 100) : 0
    })).sort((a, b) => b.rate - a.rate);
    
    const totalStudents = Object.keys(studentStats).length;
    const presentRate = totalRecords > 0 ? Math.round((totalPresent / totalRecords) * 100) : 0;
    const absentRate = totalRecords > 0 ? Math.round((totalAbsent / totalRecords) * 100) : 0;
    const excusedRate = totalRecords > 0 ? Math.round((totalExcused / totalRecords) * 100) : 0;
    
    return {
        totalStudents,
        totalRecords,
        totalPresent,
        totalAbsent,
        totalExcused,
        presentRate,
        absentRate,
        excusedRate,
        dailyStats,
        studentStats: studentStatsArray
    };
}

// è®¡ç®—æ—¥æœŸèŒƒå›´
function calculateDateRange(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    return diffDays;
}

// åŒæ­¥ç®¡ç†åŠŸèƒ½
function updateSyncStatus() {
    const statusEl = document.getElementById('syncStatusText');
    
    if (isOnline) {
        statusEl.innerHTML = `
            <div style="color: #27ae60; margin-bottom: 10px;">
                âœ… ${t('sync.connected', 'å·²è¿æ¥åˆ°Firebaseæ•°æ®åº“')}
            </div>
            <div style="color: #666; font-size: 14px;">
                ${t('sync.realtime', 'æ•°æ®æ­£åœ¨å®æ—¶åŒæ­¥ä¸­...')}
            </div>
            <div style="color: #666; font-size: 12px; margin-top: 5px;">
                ${t('sync.last_sync', 'æœ€ååŒæ­¥æ—¶é—´: ')}${new Date().toLocaleString()}
            </div>
        `;
    } else {
        statusEl.innerHTML = `
            <div style="color: #e74c3c; margin-bottom: 10px;">
                âŒ ${t('sync.disconnected', 'æœªè¿æ¥åˆ°æ•°æ®åº“')}
            </div>
            <div style="color: #f39c12; font-size: 14px;">
                ${t('sync.offline_mode', 'å½“å‰å¤„äºç¦»çº¿æ¨¡å¼ï¼Œéƒ¨åˆ†åŠŸèƒ½å—é™')}
            </div>
            <div style="color: #666; font-size: 12px; margin-top: 5px;">
                ${t('sync.check_network', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')}
            </div>
        `;
    }
}

// å¼ºåˆ¶åŒæ­¥æ•°æ®
function forceSyncData() {
    if (!isOnline) {
        alert(t('msg.sync_required', 'éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½åŒæ­¥æ•°æ®'));
        return;
    }
    
    addSyncLog('ğŸ”„ ' + t('sync.force_start', 'å¼€å§‹å¼ºåˆ¶åŒæ­¥...'));
    
    // æ¸…é™¤æœ¬åœ°ç¼“å­˜
    Object.keys(localStorage).forEach(key => {
        if (key.startsWith('attendance_') || key === 'realTimePracticeStatus') {
            localStorage.removeItem(key);
        }
    });
    
    // é‡æ–°åˆå§‹åŒ–æ•°æ®
    attendanceData = { realTimePractice: {} };
    studentData = {};
    excuseData = {};
    
    // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰æ•°æ®
    forceRefreshAllData();
    
    addSyncLog('âœ… ' + t('sync.force_complete', 'å¼ºåˆ¶åŒæ­¥å®Œæˆ'));
}

// æ¸…é™¤æœ¬åœ°ç¼“å­˜
function clearLocalCache() {
    if (!confirm(t('msg.clear_cache_confirm', 'ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç¦»çº¿æ•°æ®ã€‚'))) {
        return;
    }
    
    // ğŸ”¥ ä¿®æ”¹ï¼šæ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®ï¼ˆä½†å®æ—¶ç»ƒç´æ•°æ®æœ¬æ¥å°±ä¸åœ¨æœ¬åœ°å­˜å‚¨ä¸­ï¼‰
    const keysToRemove = [];
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (
            key.startsWith('attendance_') ||
            key === 'studentData' ||
            key === 'excuseData'
            // æ³¨æ„ï¼šä¸åŒ…å«å®æ—¶ç»ƒç´ç›¸å…³çš„é”®ï¼Œå› ä¸ºå®ƒä»¬å·²ç»ä¸å­˜å‚¨åœ¨æœ¬åœ°äº†
        )) {
            keysToRemove.push(key);
        }
    }
    
    // æ‰¹é‡åˆ é™¤
    keysToRemove.forEach(key => {
        localStorage.removeItem(key);
    });
    
    // ğŸ”¥ é‡ç½®æ•°æ®
    studentData = {};
    excuseData = {};
    // æ¸…ç©ºè€ƒå‹¤å†å²æ•°æ®ï¼Œä½†ä¿ç•™å®æ—¶ç»ƒç´æ•°æ®ï¼ˆå› ä¸ºå®ƒåœ¨å†…å­˜ä¸­ï¼‰
    const realTimePractice = attendanceData.realTimePractice; // å¤‡ä»½
    attendanceData = { realTimePractice }; // é‡ç½®ä½†ä¿ç•™å®æ—¶æ•°æ®
    
    // æ¸…ç©ºæ˜¾ç¤º
    document.getElementById('todaySnapshot').innerHTML = '';
    document.getElementById('studentList').innerHTML = '';
    // ä¸æ¸…ç©ºç»ƒç´çŠ¶æ€æ˜¾ç¤ºï¼Œå› ä¸ºæ•°æ®ä»åœ¨å†…å­˜ä¸­
    
    addSyncLog(`ğŸ—‘ï¸ å·²æ¸…é™¤ ${keysToRemove.length} ä¸ªæœ¬åœ°ç¼“å­˜é¡¹ï¼ˆå®æ—¶ç»ƒç´æ•°æ®ä¿ç•™åœ¨å†…å­˜ä¸­ï¼‰`);
    alert(t('msg.cache_cleared', 'æœ¬åœ°ç¼“å­˜å·²æ¸…é™¤'));
    
    // å¦‚æœåœ¨çº¿ï¼Œé‡æ–°åŠ è½½æ•°æ®
    if (isOnline) {
        setTimeout(() => {
            forceRefreshAllData();
        }, 1000);
    }
}


// ğŸ”¥ ä¿ç•™ï¼šé¢„åŠ è½½æœ€è¿‘çš„è€ƒå‹¤æ•°æ®ï¼ˆè¿™ä¸ªåŠŸèƒ½ä¿æŒä¸å˜ï¼‰
function preloadRecentAttendanceData() {
    if (!isOnline) return;
    
    const promises = [];
    const today = new Date();
    
    // é¢„åŠ è½½æœ€è¿‘7å¤©çš„æ•°æ®
    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        if (!attendanceData[dateStr]) {
            const promise = database.ref(`attendanceData/${dateStr}`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val() || {};
                    attendanceData[dateStr] = data;
                    
                    // ğŸ”¥ ä¿ç•™ï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    try {
                        localStorage.setItem(`attendance_${dateStr}`, JSON.stringify(data));
                    } catch (e) {
                        console.warn('æœ¬åœ°å­˜å‚¨ç©ºé—´ä¸è¶³:', e);
                    }
                })
                .catch((error) => {
                    console.warn(`é¢„åŠ è½½ ${dateStr} æ•°æ®å¤±è´¥:`, error);
                });
            promises.push(promise);
        }
    }
    
    Promise.all(promises).then(() => {
        addSyncLog(`ğŸ“¥ å·²é¢„åŠ è½½æœ€è¿‘7å¤©çš„è€ƒå‹¤æ•°æ®`);
    });
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading(containerId) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <div style="margin-top: 10px; color: #666;">${t('msg.loading', 'åŠ è½½ä¸­...')}</div>
            </div>
        `;
    }
}

// æ˜¾ç¤ºç©ºçŠ¶æ€
function showEmptyState(containerId, title, description) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <div class="empty-state-title">${title}</div>
                <div class="empty-state-description">${description}</div>
            </div>
        `;
    }
}

// é”™è¯¯å¤„ç†
window.addEventListener('error', (event) => {
    console.error('å…¨å±€é”™è¯¯:', event.error);
    addSyncLog(`âŒ ç³»ç»Ÿé”™è¯¯: ${event.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
    addSyncLog(`âŒ Promiseé”™è¯¯: ${event.reason?.message || 'æœªçŸ¥é”™è¯¯'}`);
});

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ é¡µé¢å¼€å§‹åˆå§‹åŒ–...');
    
    // æ¢å¤è¯­è¨€åå¥½
    const savedLanguage = localStorage.getItem('preferred_language');
    if (savedLanguage && savedLanguage !== currentLanguage) {
        switchLanguage(savedLanguage);
    } else {
        updatePageLanguage();
    }
    
    // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = today;
    
    // ğŸ”¥ ä¿®æ”¹ï¼šæ¢å¤å…¶ä»–æœ¬åœ°æ•°æ®ï¼Œä½†ä¸æ¢å¤å®æ—¶ç»ƒç´çŠ¶æ€
    restoreOtherLocalData();
    
    // ğŸ”¥ å®æ—¶ç»ƒç´çŠ¶æ€åˆå§‹åŒ–ä¸ºç©ºï¼ˆä¸ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰
    attendanceData.realTimePractice = {};
    realTimePracticeStatus = {};
    lastRealTimePracticeHash = '';
    console.log('ğŸ“± å®æ—¶ç»ƒç´çŠ¶æ€å·²åˆå§‹åŒ–ä¸ºç©ºçŠ¶æ€ï¼ˆä¸ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰');
    
    // åˆå§‹åŒ–Firebase
    initFirebase();
    
    // åˆå§‹åŒ–å®æ—¶ç»ƒç´çŠ¶æ€æ˜¾ç¤º
    initPracticeStatusDisplay();
    
    // æ›´æ–°è¿æ¥çŠ¶æ€
    updateConnectionStatus();
    
    // æ›´æ–°åŒæ­¥çŠ¶æ€
    updateSyncStatus();
    
    // åˆå§‹åŒ–åŒæ­¥æ—¥å¿—æ˜¾ç¤º
    updateSyncLogsDisplay();
    
    // æ·»åŠ åˆå§‹åŒ–æ—¥å¿—
    addSyncLog('ğŸ¼ é’å²›æ¢…çº½å› å­¦æ ¡ç»ƒç´è·Ÿè¸ªç³»ç»Ÿå·²å¯åŠ¨');
    addSyncLog(`ğŸŒ å½“å‰è¯­è¨€: ${currentLanguage === 'zh' ? 'ä¸­æ–‡' : 'English'}`);
    addSyncLog('ğŸ“± å®æ—¶ç»ƒç´æ•°æ®ä»…å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè€ƒå‹¤å†å²æ•°æ®æ­£å¸¸ç¼“å­˜');
    
    console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
});

/**
 * æ¢å¤å…¶ä»–æœ¬åœ°æ•°æ®ï¼ˆä¿ç•™è€ƒå‹¤å†å²ç­‰ï¼‰
 */
function restoreOtherLocalData() {
    try {
        // ğŸ”¥ ä¿ç•™ï¼šæ¢å¤å­¦ç”Ÿæ•°æ®
        const savedStudentData = localStorage.getItem('studentData');
        if (savedStudentData) {
            const studentDataParsed = JSON.parse(savedStudentData);
            if (studentDataParsed && typeof studentDataParsed === 'object') {
                studentData = studentDataParsed;
                console.log('ğŸ“š å·²æ¢å¤å­¦ç”Ÿæ•°æ®');
            }
        }
        
        // ğŸ”¥ ä¿ç•™ï¼šæ¢å¤è¯·å‡æ•°æ®
        const savedExcuseData = localStorage.getItem('excuseData');
        if (savedExcuseData) {
            const excuseDataParsed = JSON.parse(savedExcuseData);
            if (excuseDataParsed && typeof excuseDataParsed === 'object') {
                excuseData = excuseDataParsed;
                console.log('ğŸ“ å·²æ¢å¤è¯·å‡æ•°æ®');
            }
        }
        
        // ğŸ”¥ ä¿ç•™ï¼šæ¢å¤è€ƒå‹¤å†å²æ•°æ®
        let restoredDates = 0;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('attendance_')) {
                try {
                    const dateStr = key.replace('attendance_', '');
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data && typeof data === 'object') {
                        attendanceData[dateStr] = data;
                        restoredDates++;
                    }
                } catch (error) {
                    console.warn(`æ¢å¤è€ƒå‹¤æ•°æ®å¤±è´¥ ${key}:`, error);
                }
            }
        }
        
        if (restoredDates > 0) {
            console.log(`ğŸ“… å·²æ¢å¤ ${restoredDates} å¤©çš„è€ƒå‹¤å†å²æ•°æ®`);
        }
        
    } catch (error) {
        console.warn('æ¢å¤æœ¬åœ°æ•°æ®å¤±è´¥:', error);
    }
}


// é¡µé¢å¸è½½æ—¶çš„æ¸…ç†
window.addEventListener('beforeunload', () => {
    // æ¸…ç†å®šæ—¶å™¨
    syncTimers.forEach(timer => clearTimeout(timer));
    syncTimers.clear();
    
    if (practiceStatusUpdateTimeout) {
        clearTimeout(practiceStatusUpdateTimeout);
        practiceStatusUpdateTimeout = null;
    }
    
    // ğŸ”¥ ç§»é™¤ï¼šä¸å†ä¿å­˜å®æ—¶ç»ƒç´çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
    
    console.log('ğŸ§¹ é¡µé¢å¸è½½ï¼Œå®æ—¶ç»ƒç´æ•°æ®å·²æ¸…ç†ï¼ˆä¸ä¿å­˜åˆ°æœ¬åœ°ï¼‰');
});


// ç½‘ç»œçŠ¶æ€ç›‘å¬
window.addEventListener('online', () => {
    console.log('ğŸŒ ç½‘ç»œå·²è¿æ¥');
    addSyncLog('ğŸŒ ç½‘ç»œè¿æ¥å·²æ¢å¤');
    
    // å»¶è¿Ÿé‡æ–°åˆå§‹åŒ–Firebaseè¿æ¥
    setTimeout(() => {
        if (!isOnline) {
            initFirebase();
        }
    }, 2000);
});

window.addEventListener('offline', () => {
    console.log('ğŸ“± ç½‘ç»œå·²æ–­å¼€');
    addSyncLog('ğŸ“± ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œåˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼');
    isOnline = false;
    updateConnectionStatus();
    updateSyncStatus();
});

// å¯¼å‡ºå…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
window.switchTab = switchTab;
window.switchLanguage = switchLanguage;
window.loadAttendanceData = loadAttendanceData;
window.refreshData = refreshData;
window.refreshPracticeStatus = refreshPracticeStatus;
window.filterStudents = filterStudents;
window.showStudentDetail = showStudentDetail;
window.closeModal = closeModal;
window.generateReport = generateReport;
window.forceSyncData = forceSyncData;
window.clearLocalCache = clearLocalCache;
window.updateSyncStatus = updateSyncStatus;
window.getStudentRealTimePracticeStatus = getStudentRealTimePracticeStatus;
window.checkAndUpdateRealTimePracticeStatus = checkAndUpdateRealTimePracticeStatus;
window.triggerRealTimePracticeStatusUpdate = triggerRealTimePracticeStatusUpdate;
window.cleanupEndedPracticeStatus = cleanupEndedPracticeStatus;
window.filterPracticeStatus = filterPracticeStatus;
window.setQuickFilter = setQuickFilter;
window.clearPracticeFilters = clearPracticeFilters;


console.log('ğŸ“œ è„šæœ¬åŠ è½½å®Œæˆï¼Œç­‰å¾…DOMåˆå§‹åŒ–...');

</script>
</body>
</html>
