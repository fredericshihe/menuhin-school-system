<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- 关键资源预加载：提高首屏渲染速度 -->
  <link rel="preload" as="style" href="./index.css" onload="this.rel='stylesheet'">
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
  <!-- 字体显示策略：若有自定义字体文件，可在此添加 preload + font-display:swap -->
  <!-- <link rel="preload" as="font" href="/fonts/YourFont.woff2" type="font/woff2" crossorigin> -->
  <meta http-equiv="Cache-Control" content="max-age=3600, stale-while-revalidate=600" />
  <meta name="color-scheme" content="light dark">
<meta charset="UTF-8">
<title>青岛梅纽因音乐学校练琴跟踪系统</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<style>
/* ===============================================
   青岛梅纽因音乐学校练琴跟踪系统 - 完整优化样式文件
   =============================================== */

/* ===== 1. CSS变量定义 ===== */
:root {
  /* 日间模式显式状态渐变（浅色变体） */
  --gradient-present-light: linear-gradient(135deg, #e6f9ef, #d1f2e0);
  --gradient-absent-light: linear-gradient(135deg, #ffecec, #ffd6d6);
  --gradient-excused-light: linear-gradient(135deg, #fff6e6, #ffe9c7);
  --gradient-primary-light: linear-gradient(135deg, #eef6ff, #dbeeff);
  --gradient-weekend-light: linear-gradient(135deg, #f5f7fa, #eef1f6);

    /* 主色调 */
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --success-color: #27ae60;
    
    /* 背景和文本 */
    --background-color: #f8f9fa;
    --card-bg: #ffffff;
    --card-hover-bg: #f8f9fa;
    --text-color: #2c3e50;
    --text-secondary: #6c757d;
    --text-muted: #adb5bd;
    --border-color: #dee2e6;
    --light-gray: #f1f3f4;
    --medium-gray: #6c757d;
    --dark-gray: #495057;
    --shadow-color: rgba(0,0,0,0.1);
    
    /* 阴影和圆角 */
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-hover: 0 5px 20px rgba(0,0,0,0.15);
    --radius: 12px;
    --radius-small: 6px;
    --radius-large: 20px;
  --primary-faint: rgba(52, 152, 219, 0.08);
  --muted-gray: #95a5a6;
    
    /* 移动端适配 */
    --mobile-padding: 15px;
    --mobile-font-size: 16px;
    --touch-target-size: 44px;
    
    /* 渐变色 */
    --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    --gradient-card: linear-gradient(135deg, #f8f9fa, #ffffff);
  /* 状态卡片与模态变量（便于主题切换覆盖） */
  --gradient-present: linear-gradient(135deg, #d4edda, #c3e6cb);
  --gradient-absent: linear-gradient(135deg, #f8d7da, #f5c6cb);
  --gradient-excused: linear-gradient(135deg, #fff3cd, #ffeaa7);
  --gradient-rate: linear-gradient(135deg, #cce7ff, #b3d9ff);
  --gradient-header: linear-gradient(135deg, #f8f9fa, #ffffff);
  --modal-backdrop: rgba(0,0,0,0.5);
  --modal-shadow: 0 20px 50px rgba(0,0,0,0.35);
  --accent-faint: rgba(88, 166, 255, 0.1);
  --overlay-faint: rgba(255,255,255,0.7);
  --accent-faint-2: rgba(88, 166, 255, 0.3);
  --accent-faint-3: rgba(88, 166, 255, 0.4);
  --overlay-faint-strong: rgba(255,255,255,0.8);
  --warning-faint: rgba(243, 156, 18, 0.1);
  --overlay-faint-text: rgba(240, 246, 252, 0.9);
  --modal-backdrop-strong: rgba(0,0,0,0.8);
  --danger-faint: rgba(231, 76, 60, 0.1);
  --danger-faint-2: rgba(231, 76, 60, 0.2);
  --amber-faint: rgba(187, 128, 9, 0.15);
  --overlay-very-faint: rgba(255,255,255,0.1);
  --overlay-faint-2: rgba(240,246,252,0.1);
  /* Hover variants */
  --primary-hover: #2980b9;
  --success-hover: #229954;
  --warning-hover: #e67e22;
  --danger-hover: #c0392b;
  --secondary-hover: #5a6268;
  --on-accent-text: #0d1117;
  --purple-strong: #8250df;
  --amber-strong: #9a6700;
  --muted-dark: #6e7681;
  --muted-light: #8b949e;
}

/* ===== 剔除 & 段外 统一居中模态弹窗（浅色/深色自适应） ===== */
.mini-help-btn{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:4px;border:1px solid var(--border-color,#ccc);background:var(--primary-faint,#eef);color:#007bff;font-size:12px;line-height:1;cursor:pointer;padding:0;margin-left:4px;transition:.15s;}
.mini-help-btn:hover{background:#007bff;color:#fff;border-color:#007bff;}
.mini-help-btn:active{transform:scale(.94);} 

/* 历史排行榜样式 */
.history-modal-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
}

.history-date-select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  background: #fff;
  color: #333;
}

.history-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  table-layout: fixed; /* 🔧 修复：固定表格布局 */
}

.history-table thead tr {
  background: rgba(0,0,0,0.05);
}

.history-table th, .history-table td {
  padding: 8px 6px;
  border: 1px solid #ddd;
  text-align: center;
  vertical-align: middle; /* 🔧 修复：垂直居中对齐 */
  line-height: 1.3; /* 🔧 修复：设置行高 */
}

.history-table th {
  font-weight: 600;
  color: #333;
  white-space: nowrap; /* 🔧 修复：防止表头换行 */
  overflow: hidden;
  text-overflow: ellipsis;
}

/* 历史表格前三名：避免继承主榜样式 */
.history-table tr.rank-1 td { background: rgba(255,215,0,0.15); color: #d1b000; }
.history-table tr.rank-2 td { background: rgba(192,192,192,0.15); color: #b5b5b5; }
.history-table tr.rank-3 td { background: rgba(205,127,50,0.15); color: #b07730; }
/* 去掉历史表格的 position/伪元素影响 */
.history-table tr.rank-1::before, .history-table tr.rank-2::before, .history-table tr.rank-3::before { content: none !important; }
/* 调整历史表格第一列(排名)固定宽度并居中 */
.history-table td:first-child, .history-table th:first-child { width:50px; min-width:50px; text-align:center; }
.center-pop-modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:10000;opacity:0;transition:opacity .18s ease;backdrop-filter:blur(2px);}
.center-pop-modal-overlay.show{opacity:1;}
.center-pop-modal{background:#1f2429;color:#f0f6fc;border:1px solid #30363d;border-radius:14px;box-shadow:0 12px 36px rgba(0,0,0,.45);padding:18px 20px 20px;width:min(460px,90vw);max-height:70vh;display:flex;flex-direction:column;position:relative;font-size:13px;line-height:1.55;animation:cpScaleIn .22s cubic-bezier(.32,.72,.33,1);}
.center-pop-modal h4{margin:0 0 10px;font-size:15px;font-weight:600;display:flex;align-items:center;gap:6px;line-height:1.3;}
.center-pop-modal table{width:100%;border-collapse:collapse;margin:0;font-size:13px;table-layout:fixed;}
.center-pop-modal th,.center-pop-modal td{padding:6px 6px;text-align:left;font-weight:400;word-wrap:break-word;hyphens:auto;}
.center-pop-modal th{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.center-pop-modal tr:nth-child(even){background:rgba(255,255,255,0.04);} 
.center-pop-modal .close-btn{position:absolute;top:8px;right:10px;background:transparent;border:none;color:#8b949e;cursor:pointer;font-size:18px;line-height:1;padding:2px;border-radius:6px;}
.center-pop-modal .close-btn:hover{color:#fff;background:rgba(255,255,255,0.08);} 
.center-pop-modal-body{flex:1;min-height:0;overflow:auto;padding-right:2px;}
@keyframes cpScaleIn{from{opacity:0;transform:translateY(6px) scale(.95);}to{opacity:1;transform:translateY(0) scale(1);} }
@media (prefers-color-scheme: light){
  .center-pop-modal{background:#ffffff;color:#24292f;border:1px solid #d0d7de;box-shadow:0 4px 24px rgba(0,0,0,.08),0 0 0 1px rgba(0,0,0,.03);} 
  .center-pop-modal tr:nth-child(even){background:#f6f8fa;} 
  .center-pop-modal .close-btn{color:#666;}
  .center-pop-modal .close-btn:hover{color:#000;background:rgba(0,0,0,0.06);} 
}
/* 小屏适配 */
@media (max-width:520px){
  .center-pop-modal{width:92vw;padding:16px 16px 18px;border-radius:12px;}
  .center-pop-modal h4{font-size:14px;margin-bottom:8px;}
  .center-pop-modal th,.center-pop-modal td{padding:5px 6px;}
}

/* ===== 🏅 排行榜样式 ===== */
.leaderboard-container {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  position: relative;
  overflow: hidden;
}

.leaderboard-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.05"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.05"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.03"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
  pointer-events: none;
}

.leaderboard-title {
  color: white;
  font-size: 28px;
  font-weight: 800;
  margin: 0;
  text-align: center;
  text-shadow: 0 3px 6px rgba(0,0,0,0.4);
  background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
  background-size: 200% 200%;
  animation: goldShimmer 3s ease-in-out infinite;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  position: relative;
}

.leaderboard-title-container {
  text-align: center;
  margin-bottom: 20px;
  position: relative;
}

.leaderboard-title-container::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, rgba(255,215,0,0.6), transparent);
  transform: translateY(-50%);
  z-index: 0;
}

/* 排行榜右上角历史按钮 */
.leaderboard-history-btn {
  position: absolute;
  top: 0;
  right: 0;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  border: 1px solid rgba(255,152,0,0.3);
  background: linear-gradient(135deg,rgba(255,152,0,0.85),rgba(251,140,0,0.7));
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  z-index: 10;
}

.leaderboard-history-btn:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 4px 8px rgba(0,0,0,0.25);
  background: linear-gradient(135deg,rgba(255,152,0,0.95),rgba(251,140,0,0.8));
}

.leaderboard-history-btn:active {
  transform: translateY(0) scale(0.98);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.leaderboard-subtitle {
  color: rgba(255,255,255,0.9);
  font-size: 14px;
  font-weight: 500;
  margin-top: 8px;
  text-shadow: 0 1px 3px rgba(0,0,0,0.3);
  letter-spacing: 1px;
  position: relative;
  z-index: 1;
  background: rgba(255,255,255,0.1);
  padding: 4px 12px;
  border-radius: 12px;
  display: inline-block;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
}

@keyframes goldShimmer {
  0%, 100% { 
    background-position: 0% 50%; 
    text-shadow: 0 3px 6px rgba(0,0,0,0.4), 0 0 20px rgba(255,215,0,0.3);
  }
  50% { 
    background-position: 100% 50%; 
    text-shadow: 0 3px 6px rgba(0,0,0,0.4), 0 0 30px rgba(255,215,0,0.6);
  }
}

/* 442测评体系特色样式 */
.evaluation-system-btn {
    background: rgba(255,255,255,0.1) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15) !important;
}

.evaluation-system-btn:hover {
    background: rgba(255,255,255,0.2) !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.25) !important;
}

/* 排行榜按钮区域（单行自适应） */
.leaderboard-action-bar {
  display:flex;
  align-items:stretch;
  justify-content:space-between;
  gap:16px;
  margin-bottom:14px;
  flex-wrap:nowrap;
}
.leaderboard-action-bar .lb-left,
.leaderboard-action-bar .lb-center,
.leaderboard-action-bar .lb-right {display:flex;align-items:stretch;}
.leaderboard-action-bar .lb-left {flex:0 0 auto;}
.leaderboard-action-bar .lb-center {flex:1 1 auto;justify-content:center;}
.leaderboard-action-bar .lb-right {flex:0 0 auto;gap:12px;}

.leaderboard-status {display:flex;align-items:center;padding:0 14px;font-size:13px;color:rgba(255,255,255,0.85);}
.leaderboard-status.minimal {padding:4px 2px 6px 2px;background:none;border:none;backdrop-filter:none;height:auto;justify-content:flex-start;margin:0 0 2px 2px;}

.leaderboard-btn {display:inline-flex;align-items:center;justify-content:center;gap:4px;padding:0 22px;height:42px;font-size:14px;font-weight:600;border-radius:6px;transition:all .25s ease;border:1px solid rgba(255,255,255,.3);background:linear-gradient(135deg,rgba(33,150,243,0.85),rgba(63,81,181,0.65));color:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.25);} 
.leaderboard-btn.lb-refresh {background:linear-gradient(135deg,rgba(0,172,193,0.85),rgba(0,121,161,0.65));}
.leaderboard-btn.lb-info {background:linear-gradient(135deg,rgba(255,255,255,0.18),rgba(255,255,255,0.08));border:1px solid rgba(255,255,255,0.35);backdrop-filter:blur(6px);min-width:230px;}
.leaderboard-btn.lb-expand {background:linear-gradient(135deg,rgba(142,36,170,0.85),rgba(106,27,154,0.7));}
.leaderboard-btn:hover {transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.35);} 
.leaderboard-btn:active {transform:translateY(0);box-shadow:0 1px 3px rgba(0,0,0,0.4);} 

/* 中等及以下宽度：允许换行但保持说明按钮居中 */
@media (max-width: 880px){
  .leaderboard-action-bar {flex-wrap:wrap;justify-content:center;}
  .leaderboard-action-bar .lb-left {order:1;}
  .leaderboard-action-bar .lb-center {order:2;width:100%;justify-content:center;}
  .leaderboard-action-bar .lb-right {order:3;width:100%;justify-content:space-between;}
  .leaderboard-status {flex:1;justify-content:center;height:42px;margin-right:8px;}
  .leaderboard-btn {flex:0 0 auto;}
  
  /* 移动端历史按钮调整 */
  .leaderboard-history-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
}
@media (max-width: 560px){
  .leaderboard-action-bar {gap:10px;}
  .leaderboard-action-bar .lb-right {flex-direction:column;align-items:stretch;gap:8px;}
  .leaderboard-status {width:100%;margin:0;}
  .leaderboard-btn {width:100%;height:44px;font-size:13px;padding:0 16px;}
  .leaderboard-btn.lb-info {min-width:0;}
  
  /* 小屏幕下历史按钮进一步调整 */
  .leaderboard-history-btn {
    width: 28px;
    height: 28px;
    font-size: 12px;
    top: -2px;
    right: -2px;
  }
}
@media (max-width: 380px){
  .leaderboard-btn {font-size:12px;height:40px;padding:0 12px;}
  .leaderboard-status {font-size:12px;padding:0 10px;height:40px;}
  
  /* 超小屏幕历史按钮 */
  .leaderboard-history-btn {
    width: 26px;
    height: 26px;
    font-size: 11px;
  }
}
.system-highlight {
  background: linear-gradient(45deg, rgba(255,215,0,0.15), rgba(255,165,0,0.1));
  border: 1px solid rgba(255,215,0,0.3);
  border-radius: 8px;
  padding: 12px 16px;
  margin: 8px 0;
  position: relative;
  overflow: hidden;
}

.system-highlight::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,215,0,0.1), transparent);
  animation: sweep 3s ease-in-out infinite;
}

@keyframes sweep {
  0% { left: -100%; }
  50% { left: 100%; }
  100% { left: 100%; }
}

.leaderboard-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: rgba(255,255,255,0.95);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  position: relative;
  z-index: 1;
}

.leaderboard-table thead {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.leaderboard-table th {
  padding: 16px 12px;
  font-weight: 600;
  color: white;
  text-align: center;
  font-size: 14px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  border: none;
}

.leaderboard-table tbody tr {
  transition: all 0.3s ease;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}

.leaderboard-table tbody tr:hover {
  background: rgba(102,126,234,0.08);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.leaderboard-table td {
  padding: 16px 12px;
  text-align: center;
  font-size: 14px;
  border: none;
  position: relative;
}

/* 排名样式 */
.rank-cell {
  font-weight: 700;
  font-size: 18px;
  width: 80px;
}

/* 修改：限定主排行榜金银铜样式作用域，避免影响历史表格 */
.leaderboard-table .rank-1 { /* 原 .rank-1 */
  background: linear-gradient(135deg, #ffd700, #ffed4e);
  color: #b8860b;
  position: relative;
}
.leaderboard-table .rank-1::before { /* 原 ::before 保持 */
  content: '👑';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 12px;
  margin-top: -12px;
}
.leaderboard-table .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); color:#808080; }
.leaderboard-table .rank-3 { background: linear-gradient(135deg, #cd7f32, #daa520); color:#8b4513; }

/* 金银铜牌整行效果 */
.leaderboard-table tbody tr.top-1 {
  background: linear-gradient(90deg, rgba(255,215,0,0.15), rgba(255,237,78,0.1));
  box-shadow: 0 0 20px rgba(255,215,0,0.3);
}

.leaderboard-table tbody tr.top-2 {
  background: linear-gradient(90deg, rgba(192,192,192,0.15), rgba(229,229,229,0.1));
  box-shadow: 0 0 15px rgba(192,192,192,0.2);
}

.leaderboard-table tbody tr.top-3 {
  background: linear-gradient(90deg, rgba(205,127,50,0.15), rgba(218,165,32,0.1));
  box-shadow: 0 0 15px rgba(205,127,50,0.2);
}

/* 分数样式 */
.score-cell {
  font-weight: 700;
  font-size: 16px;
  position: relative;
}

.score-excellent {
  color: #10b981;
  text-shadow: 0 1px 2px rgba(16,185,129,0.2);
}

.score-good {
  color: #3b82f6;
}

.score-average {
  color: #f59e0b;
}

.score-poor {
  color: #ef4444;
}

/* 高分段特效 */
.top-1 .score-cell::after {
  content: '✨';
  position: absolute;
  right: -20px;
  top: 50%;
  transform: translateY(-50%);
  animation: sparkle 2s ease-in-out infinite;
}

@keyframes sparkle {
  0%, 100% { opacity: 0.6; transform: translateY(-50%) scale(1); }
  50% { opacity: 1; transform: translateY(-50%) scale(1.2); }
}

/* 姓名样式 */
.name-cell {
  font-weight: 600;
  text-align: left;
}

.top-1 .name-cell {
  color: #b8860b;
  font-weight: 700;
}

.top-2 .name-cell {
  color: #708090;
  font-weight: 700;
}

.top-3 .name-cell {
  color: #8b4513;
  font-weight: 700;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .leaderboard-container {
    padding: 16px;
    border-radius: 12px;
  }
  
  .leaderboard-title-container {
    margin-bottom: 16px;
  }
  
  .leaderboard-title {
    font-size: 22px;
  }
  
  .leaderboard-subtitle {
    font-size: 12px;
    padding: 3px 8px;
  }
  
  .leaderboard-title-container {
    margin-bottom: 16px;
  }
  
  .leaderboard-table th,
  .leaderboard-table td {
    padding: 12px 8px;
    font-size: 13px;
  }
  
  .rank-cell {
    font-size: 16px;
    width: 60px;
  }
  
  .score-cell {
    font-size: 14px;
  }
}

@media (prefers-color-scheme: dark) {
  /* 排行榜容器深色模式 */
  .leaderboard-container {
    background: linear-gradient(135deg, #1a1f3a 0%, #2d1b69 100%);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  
  /* 排行榜标题深色模式 */
  .leaderboard-title {
    background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 3px 6px rgba(0,0,0,0.6);
  }
  
  .leaderboard-subtitle {
    color: rgba(255,255,255,0.85);
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
  }
  
  /* 排行榜表格深色模式 */
  .leaderboard-table {
    background: rgba(15,20,25,0.95);
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  
  .leaderboard-table thead {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  }
  
  .leaderboard-table th {
    color: #f0f6fc;
    text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  }
  
  .leaderboard-table tbody tr {
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  
  .leaderboard-table tbody tr:hover {
    background: rgba(59,130,246,0.12);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .leaderboard-table td {
    color: #f0f6fc;
  }
  
  /* 排名单元格深色模式 */
  .rank-1 {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #451a03;
  }
  
  .rank-2 {
    background: linear-gradient(135deg, #9ca3af, #d1d5db);
    color: #374151;
  }
  
  .rank-3 {
    background: linear-gradient(135deg, #d97706, #ea580c);
    color: #431407;
  }
  
  /* 前三名行效果深色模式 */
  .leaderboard-table tbody tr.top-1 {
    background: linear-gradient(90deg, rgba(251,191,36,0.15), rgba(245,158,11,0.08));
    box-shadow: 0 0 20px rgba(251,191,36,0.2);
  }
  
  .leaderboard-table tbody tr.top-2 {
    background: linear-gradient(90deg, rgba(156,163,175,0.15), rgba(209,213,219,0.08));
    box-shadow: 0 0 15px rgba(156,163,175,0.15);
  }
  
  .leaderboard-table tbody tr.top-3 {
    background: linear-gradient(90deg, rgba(217,119,6,0.15), rgba(234,88,12,0.08));
    box-shadow: 0 0 15px rgba(217,119,6,0.15);
  }
  
  /* 姓名单元格深色模式 */
  .name-cell {
    color: #f0f6fc;
  }
  
  .top-1 .name-cell {
    color: #fbbf24;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  
  .top-2 .name-cell {
    color: #d1d5db;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  
  .top-3 .name-cell {
    color: #ea580c;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  
  /* 分数单元格深色模式 */
  .score-excellent {
    color: #10b981;
    text-shadow: 0 1px 2px rgba(16,185,129,0.3);
  }
  
  .score-good {
    color: #60a5fa;
  }
  
  .score-average {
    color: #fbbf24;
  }
  
  .score-poor {
    color: #f87171;
  }
  
  /* 按钮区域深色模式 */
  .leaderboard-btn {
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 2px 4px rgba(0,0,0,0.4);
  }
  
  .leaderboard-btn.lb-info {
    background: linear-gradient(135deg,rgba(255,255,255,0.12),rgba(255,255,255,0.06));
    border: 1px solid rgba(255,255,255,0.25);
  }
  
  .leaderboard-btn.lb-expand {
    background: linear-gradient(135deg,rgba(147,51,234,0.85),rgba(124,58,237,0.7));
  }
  
  .leaderboard-btn.lb-history {
    background: linear-gradient(135deg,rgba(255,152,0,0.9),rgba(251,140,0,0.8));
  }
  
  /* 排行榜右上角历史按钮深色模式 */
  .leaderboard-history-btn {
    background: linear-gradient(135deg,rgba(255,152,0,0.9),rgba(251,140,0,0.8));
    border: 1px solid rgba(255,152,0,0.4);
  }
  
  .leaderboard-history-btn:hover {
    background: linear-gradient(135deg,rgba(255,152,0,1),rgba(251,140,0,0.9));
  }
  
  .leaderboard-btn:hover {
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }
  
  /* 状态文字深色模式 */
  .leaderboard-status {
    color: rgba(255,255,255,0.75);
  }
  
  .leaderboard-status.minimal {
    color: rgba(255,255,255,0.65);
  }
  
  /* 帮助按钮深色模式 */
  .mini-help-btn {
    background: rgba(255,255,255,0.12) !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    color: rgba(255,255,255,0.85) !important;
  }
  
  /* 历史排行榜深色模式 */
  .history-modal-label {
    color: rgba(255,255,255,0.9);
  }
  
  .history-date-select {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.9);
  }
  
  .history-table th {
    color: rgba(255,255,255,0.9);
    background: rgba(255,255,255,0.08);
  }
  
  .history-table th, .history-table td {
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.85);
    padding: 8px 6px; /* 🔧 修复：确保深色模式下的内边距一致 */
  }
  
  .history-table .rank-1 {
    background: rgba(255, 215, 0, 0.25); /* 🔧 修复：增强对比度 */
    color: rgba(255,255,255,0.95);
  }
  
  .history-table .rank-2 {
    background: rgba(192, 192, 192, 0.25); /* 🔧 修复：增强对比度 */
    color: rgba(255,255,255,0.95);
  }
  
  .history-table .rank-3 {
    background: rgba(205, 127, 50, 0.25); /* 🔧 修复：增强对比度 */
    color: rgba(255,255,255,0.95);
  }
  
  .mini-help-btn:hover {
    background: rgba(255,255,255,0.18) !important;
    border-color: rgba(255,255,255,0.3) !important;
  }
}

/* ===== 🔥 全局性能优化 - 移动端动画性能 ===== */
@media (max-width: 768px) {
  /* 全局GPU加速 */
  * {
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }
  
  /* 优化模态框动画元素 */
  .modal,
  .modal-content {
    will-change: transform, opacity;
    transform: translateZ(0);
    -webkit-perspective: 1000px;
    perspective: 1000px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  /* 🔥 移动端完全禁用遮罩效果 */
  .modal.show {
    background: transparent !important;
    backdrop-filter: none !important;
  }
  
  .modal.hiding {
    background: transparent !important;
    backdrop-filter: none !important;
  }
}

@media (max-width: 480px) {
  /* 🔥 小屏幕完全无遮罩 */
  .modal.show {
    backdrop-filter: none !important;
    background: transparent !important;
  }
  
  .modal.hiding {
    backdrop-filter: none !important;
    background: transparent !important;
  }
}

/* ===== 🔥 低性能设备优化 ===== */
@media (prefers-reduced-motion: reduce) {
  .modal,
  .modal-content {
    animation-duration: 0.2s !important;
    transition-duration: 0.2s !important;
  }
}

/* 日间模式 - 强化状态卡片颜色（更明显的色块/渐变） */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  /* 更明显的色块与渐变，增强可视区分 */
  :root {
    --status-present-bg: #e9faf0;
    --status-present-accent: #27ae60;
    --status-present-gradient-strong: linear-gradient(135deg, #e9faf0, #c9f2d6);
    --status-absent-bg: #fff0f0;
    --status-absent-accent: #e74c3c;
    --status-absent-gradient-strong: linear-gradient(135deg, #fff0f0, #ffd6d6);
    --status-excused-bg: #fff9ed;
    --status-excused-accent: #f39c12;
    --status-excused-gradient-strong: linear-gradient(135deg, #fff9ed, #ffecce);
    --status-low-eff-bg: #fff8e6;
    --status-low-eff-accent: #dbae00;
    --status-low-eff-gradient-strong: linear-gradient(135deg, #fff8e6, #ffe8b3);
  }

  /* 强制颜色按需求匹配 */
  .today-status-card.present { background: #e9faf0 !important; border-left-color: #27ae60 !important; color: var(--text-color) !important; }
  .today-status-card.absent { background: #fff0f0 !important; border-left-color: #e74c3c !important; color: var(--text-color) !important; }
  .today-status-card.low-efficiency { background: #fff8e6 !important; border-left-color: #dbae00 !important; color: var(--text-color) !important; }
  .today-status-card.excused { background: #fff9ed !important; border-left-color: #f39c12 !important; color: var(--text-color) !important; }
  .today-status-card.pending, .today-status-card.waiting { background: #f5f7fa !important; border-left-color: #dfe6ec !important; color: var(--text-color) !important; }

  .status-badge.present { background: #e9faf0 !important; color: #27ae60 !important; border-color: transparent !important; }
  .status-badge.absent { background: #fff0f0 !important; color: #e74c3c !important; border-color: transparent !important; }
  .status-badge.excused { background: #fff9ed !important; color: #f39c12 !important; border-color: transparent !important; }
  .status-badge.low-efficiency { background: #fff8e6 !important; color: #dbae00 !important; border-color: transparent !important; }
  .status-badge.pending, .status-badge.waiting { background: #f5f7fa !important; color: #6c757d !important; border-color: transparent !important; }

  /* 仅修改统计汇总容器的背景与形状，不修改文本颜色或边框 */
  .stats-grid-detailed .stat-item.present { background: #e9faf0 !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.absent { background: #fff0f0 !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.excused { background: #fff9ed !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.low-efficiency { background: #fff8e6 !important; border-radius: 12px !important; }
}

/* ===== 2. 基础重置和全局样式 ===== */
/* 日间模式：强化出勤/缺勤/低效/请假四类卡片，增加边框、图标和数字强调 */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  /* 出勤 - 绿色 */
  .stats-grid-detailed .stat-item.present,
  .today-status-card.present {
    background: var(--status-present-gradient-strong);
    box-shadow: 0 6px 18px rgba(39,174,96,0.04);
  }
  .stats-grid-detailed .stat-item.present .stat-icon,
  .today-status-card.present .metric-icon {
    background: rgba(39,174,96,0.08);
    color: var(--status-present-accent);
  }
  .stats-grid-detailed .stat-item.present .stat-number {
    color: var(--status-present-accent);
  }

  /* 缺勤 - 红色 */
  .stats-grid-detailed .stat-item.absent,
  .today-status-card.absent {
    background: var(--status-absent-gradient-strong);
    box-shadow: 0 6px 18px rgba(231,76,60,0.04);
  }
  .stats-grid-detailed .stat-item.absent .stat-icon,
  .today-status-card.absent .metric-icon {
    background: rgba(231,76,60,0.06);
    color: var(--status-absent-accent);
  }
  .stats-grid-detailed .stat-item.absent .stat-number {
    color: var(--status-absent-accent);
  }

  /* 低效 - 黄色/橙色 */
  .stats-grid-detailed .stat-item.low-efficiency,
  .today-status-card.low-efficiency {
    background: var(--status-low-eff-gradient-strong);
    box-shadow: 0 6px 18px rgba(219,150,0,0.04);
  }
  .stats-grid-detailed .stat-item.low-efficiency .stat-icon,
  .today-status-card.low-efficiency .metric-icon {
    background: rgba(219,150,0,0.06);
    color: var(--status-low-eff-accent);
  }
  .stats-grid-detailed .stat-item.low-efficiency .stat-number {
    color: var(--status-low-eff-accent);
  }

  /* 请假 - 橙黄 (excused) */
  .stats-grid-detailed .stat-item.excused,
  .today-status-card.excused {
    background: var(--status-excused-gradient-strong);
    box-shadow: 0 6px 18px rgba(243,156,18,0.04);
  }
  .stats-grid-detailed .stat-item.excused .stat-icon,
  .today-status-card.excused .metric-icon {
    background: rgba(243,156,18,0.06);
    color: var(--status-excused-accent);
  }
  .stats-grid-detailed .stat-item.excused .stat-number {
    color: var(--status-excused-accent);
  }

  /* Badge 强化 */
  .status-badge { border: none; }
  .status-badge.present { box-shadow: none; }
}

/* ===== 额外：规范化统计卡片布局与排版（出勤/缺勤/请假/待考勤） ===== */
.stats-grid-detailed {
  display: grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap: 12px;
  align-items: stretch;
}
.stats-grid-detailed .stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 14px 12px;
  border-radius: 12px;
  min-height: 92px;
  box-shadow: 0 2px 8px var(--shadow-color);
  text-align: center;
}
.stats-grid-detailed .stat-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}
.stats-grid-detailed .stat-content {
  display: flex;
  flex-direction: column;
  gap: 4px;
  align-items: center;
  min-width: 0;
}
.stats-grid-detailed .stat-label {
  font-size: 13px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}
.stats-grid-detailed .stat-number {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-color);
  line-height: 1;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 24px;
}
.stats-grid-detailed .stat-desc {
  font-size: 12px;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* 保证图标和数字在日/夜模式下的对比 */
.stats-grid-detailed .stat-item .stat-icon { background: var(--overlay-faint-2); }
.stats-grid-detailed .stat-item.present .stat-icon { background: rgba(39,174,96,0.08); color: var(--status-present-accent); }
.stats-grid-detailed .stat-item.absent .stat-icon { background: rgba(231,76,60,0.06); color: var(--status-absent-accent); }
.stats-grid-detailed .stat-item.excused .stat-icon { background: rgba(243,156,18,0.06); color: var(--status-excused-accent); }
.stats-grid-detailed .stat-item.pending .stat-icon { background: rgba(108,117,125,0.06); color: var(--medium-gray); }

/* 响应式：窄屏时改为两列或单列 */
@media (max-width: 900px) {
  .stats-grid-detailed { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 480px) {
  .stats-grid-detailed { grid-template-columns: 1fr; }
  .stats-grid-detailed .stat-item { padding: 10px; }
}

/* 日间模式：强化“加载更多/左右滑动查看更多”提示的浅色背景，提升选择器优先级以避免被暗色覆盖 */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  /* 使用父容器限定选择器以提高优先级，同时不使用 !important */
  .attendance-history .load-more-hint,
  .practice-history .load-more-hint,
  .recent-practices .load-more-hint,
  .load-more-hint {
    background: var(--light-gray);
    color: var(--text-secondary);
    border-top-color: var(--border-color);
    transition: background-color 0.18s ease;
  }

  .attendance-history .load-more-hint:hover,
  .practice-history .load-more-hint:hover,
  .recent-practices .load-more-hint:hover,
  .load-more-hint:hover {
    background: var(--card-hover-bg);
  }
}
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    overflow-x: hidden;
}

/* ===== 3. 容器和布局 ===== */
.container {
    width: 100%;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom);
    box-sizing: border-box;
}

/* 🔥 新增：确保实时练琴状态区域没有额外的内边距 */
.container .card {
    margin-left: 0;
    margin-right: 0;
}

/* 🔥 新增：确保学生网格从最左侧开始 */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(12px, 2vw, 20px);
    width: 100%;
    padding: 0;
    margin: 0;
    padding-left: 0 !important;
}

/* 响应式容器 */
@media (min-width: 1500px) {
    .container {
        max-width: none;
        padding: 20px 40px;
    }
}

@media (min-width: 1800px) {
    .container {
        padding: 20px 60px;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 10px;
    }
}

/* ===== 4. 练琴状态紧凑布局样式 ===== */
.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: stretch;
}

.metric-item {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 8px;
    padding: 20px 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    height: 100%;
    box-sizing: border-box;
    text-align: center;
    min-height: 120px;
}

.metric-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    height: 100%;
    align-items: center;
    text-align: center;
    justify-content: center;
    gap: 6px;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
    color: var(--medium-gray);
    flex-shrink: 0;
    text-align: center;
    width: 100%;
    order: 2;
    margin-top: 4px;
}

.metric-value {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    width: 100%;
    order: 1;
}

/* 练琴状态紧凑布局样式优化 */
.metric-value.practice-status-compact {
    line-height: 1.4;
    font-size: 15px;
    min-height: 95px;
    padding: 4px 0;
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* 练琴状态容器特殊布局 */
.practice-status-container.metric-item {
    flex-direction: row;
    align-items: flex-start;
    text-align: left;
    gap: 12px;
    padding: 16px;
    justify-content: flex-start;
}

.practice-status-container .metric-content {
    display: flex;
    flex-direction: column;
    gap: 6px;
    width: 100%;
    text-align: left;
}

.practice-status-container .metric-label {
    text-align: left;
    order: 1;
    margin-bottom: 8px;
}

.practice-status-container .metric-value {
    order: 2;
    text-align: left;
}

.practice-info-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    min-height: 20px;
    justify-content: flex-start;
    padding: 2px 0 2px 12px;
    width: 100%;
    gap: 8px;
}

.practice-info-row:last-child {
    margin-bottom: 0;
}

.practice-info-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.practice-label {
    color: #666;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    min-width: 70px;
    flex-shrink: 0;
    text-align: left;
}

.practice-value {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-color);
    text-align: left;
    flex: 1;
}

/* 考勤详情模态中使用的状态类，避免内联样式以便主题切换 */
.stats-grid-detailed .stat-item.low-efficiency{background: var(--gradient-excused); color: var(--text-color);}
.stats-grid-detailed .stat-item.pending{background: var(--gradient-card); color: var(--text-color);}

.practice-value.current-practice {
    color: #2196F3;
    font-size: 14px;
    text-align: left;
}

.practice-value.total-practice {
    color: var(--primary-color);
    font-size: 1.2rem;
    font-weight: 700;
    text-align: left;
}

/* 时间段容器对齐优化 */
.time-slots-container .metric-value {
    margin-top: 0;
    line-height: 1.4;
    min-height: 95px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding: 4px 0;
}

.time-slots-wrapper {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    gap: 4px;
    margin-top: 4px;
    flex: 1;
}

/* 移动端优化 */
@media (max-width: 768px) {
    .status-metrics {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .metric-value.practice-status-compact {
        min-height: 85px;
        font-size: 14px;
        padding: 3px 0;
    }
    
    .time-slots-container .metric-value {
        min-height: 85px;
        padding: 3px 0;
    }
    
    .practice-info-row {
        margin-bottom: 6px;
        min-height: 20px;
        padding: 1px 0;
    }
    
    .practice-label {
        font-size: 12px;
        min-width: 55px;
        font-weight: 500;
    }
    
    .practice-value {
        font-size: 13px;
    }
    
    .practice-value.total-practice {
        font-size: 14px;
        font-weight: 700;
    }
    
    .metric-item {
        padding: 12px;
    }
    
    .metric-label {
        margin-bottom: 4px;
    }
    
    .time-slots-wrapper {
        gap: 3px;
        margin-top: 3px;
    }
}

@media (max-width: 480px) {
    .metric-value.practice-status-compact {
        min-height: 75px;
        font-size: 13px;
        padding: 2px 0;
    }
    
    .time-slots-container .metric-value {
        min-height: 75px;
        padding: 2px 0;
    }
    
    .practice-info-row {
        margin-bottom: 5px;
        min-height: 18px;
    }
    
    .practice-label {
        font-size: 11px;
        min-width: 50px;
        font-weight: 500;
    }
    
    .practice-value {
        font-size: 12px;
    }
    
    .practice-value.total-practice {
        font-size: 13px;
        font-weight: 700;
    }
    
    .metric-item {
        padding: 10px;
    }
    
    .time-slots-wrapper {
        gap: 2px;
        margin-top: 2px;
    }
}

/* ===== 5. 语言切换器 ===== */
.language-switcher {
    position: fixed;
    bottom: max(20px, env(safe-area-inset-bottom) + 10px);
    left: 20px;
    z-index: 1001;
  display: flex;
  background: var(--card-bg);
    border-radius: var(--radius-large);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.lang-btn {
    padding: 8px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 40px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lang-btn.active {
    background: var(--primary-color);
    color: white;
}

.lang-btn:hover:not(.active) {
  background: var(--primary-faint);
}

/* 移动端语言切换器 */
@media (max-width: 768px) {
    .language-switcher {
        bottom: max(10px, env(safe-area-inset-bottom) + 5px);
        left: 10px;
        border-radius: 16px;
    }
    
    .lang-btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 35px;
        height: 28px;
    }
}

/* ===== 6. 头部样式 ===== */
.header {
    background: var(--gradient-primary);
    color: white;
    padding: max(30px, env(safe-area-inset-top) + 20px) 20px 30px 20px;
    margin-bottom: 30px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
}

.header h1 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    margin-bottom: 10px;
    font-weight: 300;
    line-height: 1.2;
}

.header .subtitle {
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    opacity: 0.9;
    line-height: 1.3;
}

@media (max-width: 768px) {
    .header {
        padding: max(25px, env(safe-area-inset-top) + 15px) 15px 25px 15px;
        margin-bottom: 20px;
    }
}

/* ===== 7. 连接状态指示器 ===== */
.connection-status {
    position: fixed;
    top: max(20px, env(safe-area-inset-top) + 10px);
    right: 20px;
    padding: 8px 12px;
    border-radius: var(--radius-large);
    font-size: 13px;
    font-weight: 600;
    z-index: 1000;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.connection-status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--danger-color);
}

.connection-status.online::before {
    background: var(--success-color);
}

.connection-status.syncing::before {
    background: var(--warning-color);
    animation: pulse 1.5s infinite;
}

.connection-status.online {
  background: var(--card-bg);
  color: var(--success-color);
  border: 1px solid var(--success-color);
}

.connection-status.offline {
  background: var(--card-bg);
  color: var(--danger-color);
  border: 1px solid var(--danger-color);
}

.connection-status.syncing {
  background: var(--card-bg);
  color: var(--warning-color);
  border: 1px solid var(--warning-color);
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@media (max-width: 768px) {
    .connection-status {
        top: max(15px, env(safe-area-inset-top) + 5px);
        right: 15px;
        padding: 6px 10px;
        font-size: 12px;
        min-height: 36px;
    }
}

/* ===== 8. 主导航标签 ===== */
.nav-tabs {
  display: flex;
  background: var(--card-bg);
    border-radius: var(--radius);
    padding: 5px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.nav-tabs::-webkit-scrollbar {
    display: none;
}

.nav-tab {
    flex: 1;
    padding: 12px 16px;
    text-align: center;
    background: transparent;
    border: none;
    border-radius: calc(var(--radius) - 5px);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: clamp(14px, 3vw, 16px);
    font-weight: 500;
    white-space: nowrap;
    min-width: 120px;
    min-height: var(--touch-target-size);
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
}

.nav-tab:hover {
  background: var(--primary-faint);
}

.nav-tab.active {
    background: var(--primary-color);
    color: white;
}

@media (max-width: 768px) {
    .nav-tabs {
        margin-bottom: 20px;
        padding: 3px;
    }
    
    .nav-tab {
        padding: 10px 12px;
        font-size: 14px;
        min-width: 100px;
        min-height: 40px;
    }
}

/* ===== 9. 卡片容器基础样式 ===== */
.card {
  background: var(--card-bg);
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.card.success {
    border-left-color: var(--success-color);
}

.card.warning {
    border-left-color: var(--warning-color);
}

.card.danger {
    border-left-color: var(--danger-color);
}

@media (max-width: 768px) {
    .card {
        padding: 20px 15px;
        margin-bottom: 20px;
    }
}

/* ===== 10. 统计面板 ===== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
  background: var(--card-bg);
  padding: 25px;
    border-radius: var(--radius);
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.stat-card:hover::before {
    left: 100%;
}

.stat-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 8px;
    line-height: 1;
    text-align: center;
    display: block;
    width: 100%;
    order: 1;
}

.stat-label {
    font-size: 1.1rem;
    color: var(--medium-gray);
    margin-bottom: 2px;
    font-weight: 600;
    text-align: center;
    display: block;
    width: 100%;
    order: 2;
}

.stat-description {
    font-size: 0.9rem;
    color: #999;
    line-height: 1.3;
    text-align: center;
    display: block;
    width: 100%;
    order: 3;
    margin-top: 2px;
}

/* 统计卡片颜色主题 */
.stat-card.present .stat-number { color: var(--success-color); }
.stat-card.absent .stat-number { color: var(--danger-color); }
.stat-card.excused .stat-number { color: var(--warning-color); }
.stat-card.unscheduled .stat-number { color: #9b59b6; }
.stat-card.weekend .stat-number { color: var(--muted-gray); }
.stat-card.pending .stat-number { color: var(--text-secondary); }
.stat-card.self-practice { background: linear-gradient(135deg,#7e3ff2,#a16bff); box-shadow: 0 4px 12px rgba(126,63,242,0.35); }
.stat-card.self-practice .stat-number { color:#fff; }
.stat-card.self-practice .stat-label, .stat-card.self-practice .stat-description { color:#f3e9ff; }

/* 自主练琴状态徽章（学生卡） */
.student-status-compact.self-practice, .student-status.self-practice {
  background: linear-gradient(135deg,#7e3ff2,#a16bff);
  color:#fff;
  border:none;
}
.practice-status-card.self-practice { border:1px solid rgba(126,63,242,0.4); }

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        padding: 18px 12px;
        min-height: 120px;
    }
    
    .stat-number {
        font-size: 2.2rem;
        margin-bottom: 6px;
    }
    
    .stat-label {
        font-size: 1rem;
        margin-bottom: 2px;
    }
    
    .stat-description {
        font-size: 0.8rem;
    }
    
    .stat-description {
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        gap: 8px;
    }
    
    .stat-card {
        padding: 15px 10px;
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
}

/* ===== 11. 学生网格布局系统 ===== */
.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(12px, 2vw, 20px);
    width: 100%;
    padding: 0;
}

/* 限制最大列数为4列 */
@media (min-width: 1400px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
        margin: 0 auto;
        gap: 24px;
    }
}

/* 不同屏幕宽度的响应式设置 */
@media (max-width: 1399px) and (min-width: 1100px) {
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }
}

@media (max-width: 1099px) and (min-width: 800px) {
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
}

@media (max-width: 799px) {
    .student-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

/* 小屏幕优化 */
@media (max-width: 599px) {
    .student-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (max-width: 360px) {
    .student-grid {
        gap: 8px;
    }
}

/* 大屏幕优化 */
@media (min-width: 1600px) {
    .student-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
        gap: 24px;
    }
}

/* ===== 12. 学生卡片和练琴状态卡片 ===== */
.student-card,
.practice-status-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
  border-left: 4px solid var(--border-color);
    cursor: pointer;
    width: 100%;
    max-width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    height: auto;
    min-height: 280px;
    box-sizing: border-box;
    justify-self: stretch;
    align-self: stretch;
    color: var(--text-color);
}

/* 可复用左侧强调条：主色调（用于学生详情各容器统一风格） */
.edge-accent-primary {
  border-left-width: 4px !important;
  border-left-style: solid !important;
  border-left-color: var(--primary-color) !important;
}

/* 把 edge-accent-primary 应用到学生详情常用容器 */
.student-card.edge-accent-primary,
.practice-status-card.edge-accent-primary,
.student-header.edge-accent-primary,
.student-details.edge-accent-primary,
.student-grid.edge-accent-primary {
  /* 保持现有背景与阴影，仅统一左侧颜色 */
  box-shadow: inherit; /* keep inherited shadow, prevents empty rule warnings */
}

.student-card:hover,
.practice-status-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
    background: var(--card-hover-bg);
}

.practice-status-card.compact {
    min-height: 120px;
    padding: 10px 12px;
    margin-bottom: 8px;
}

/* 待考勤状态样式 */
.student-status.pending,
.student-status-compact.pending,
.table-status-badge.pending,
.status-badge.pending {
  background: var(--gradient-card);
  color: var(--text-secondary);
  border-color: var(--border-color);
}

.table-status-badge.low_efficiency { 
  background: var(--gradient-excused); 
  color: var(--text-color); 
  border-color: transparent;
}

.practice-status-card.pending,
.student-card.pending {
  border-left-color: var(--medium-gray);
}

/* 待考勤状态的卡片 */
.practice-status-card.pending,
.student-card.pending {
    background: var(--card-bg);
    border-left-color: var(--medium-gray);
}

.compact-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
}

.student-name-compact {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 2px;
}

.student-info-row {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    color: var(--medium-gray);
    flex-wrap: wrap;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 2px;
}

.info-divider {
    opacity: 0.6;
    margin: 0 2px;
}

.status-duration-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
    gap: 10px;
}

.practice-duration-large {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary-color);
  background: var(--primary-faint);
    padding: 3px 6px;
    border-radius: var(--radius-small);
}

/* === 休息倒计时美化组件 === */
.break-badge{position:relative;display:inline-flex;flex-direction:column;align-items:flex-start;justify-content:center;gap:2px;padding:6px 10px 8px;border-radius:10px;background:linear-gradient(135deg,#f6f8fa,#e9eef5);color:#0d1117;font-size:11px;font-weight:600;line-height:1.2;min-width:118px;box-shadow:0 2px 6px rgba(0,0,0,.08);border:1px solid #d0d7de;overflow:hidden;}
@media (prefers-color-scheme: dark){
  .break-badge{background:linear-gradient(135deg,#21262d,#2d333b);color:#f0f6fc;border:1px solid #30363d;box-shadow:0 2px 6px rgba(0,0,0,.35);} 
}
.break-badge[data-break-type="lunch"], .break-badge[data-label-key*="lunch"]{background:linear-gradient(135deg,#fff4e0,#ffe1b0);border-color:#ffd79a;}
.break-badge[data-break-type="concert"], .break-badge[data-label-key*="concert"]{background:linear-gradient(135deg,#efe7ff,#dccfff);border-color:#c7b5ff;}
.break-badge[data-break-type="large"], .break-badge[data-label-key*="large"]{background:linear-gradient(135deg,#e0f7ff,#b9ebff);border-color:#a1def5;}
.break-badge[data-break-type="recess"], .break-badge[data-label-key*="recess"]{background:linear-gradient(135deg,#e8f7ee,#c9efd9);border-color:#b2e6c6;}
.break-badge .bb-head{display:flex;align-items:center;gap:4px;width:100%;}
.break-badge .bb-icon{font-size:14px;filter:saturate(1.2);} 
.break-badge .bb-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.break-badge .bb-remain{font-variant-numeric:tabular-nums;font-weight:700;font-size:11px;letter-spacing:.5px;}
.break-badge .bb-remain.urgent{color:#d92c2c;animation:pulseRemain 1s infinite alternate;} 
.break-badge .bb-line{width:100%;height:6px;border-radius:4px;background:rgba(0,0,0,.08);overflow:hidden;position:relative;margin-top:4px;}
@media (prefers-color-scheme: dark){.break-badge .bb-line{background:rgba(255,255,255,.12);} }
.break-badge .bb-fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#56ccf2,#2f80ed);transition:width .6s cubic-bezier(.4,.6,.3,1);} 
.break-badge[data-break-type="lunch"] .bb-fill{background:linear-gradient(90deg,#f2994a,#f2c94c);} 
.break-badge[data-break-type="concert"] .bb-fill{background:linear-gradient(90deg,#bb6bd9,#845ef7);} 
.break-badge[data-break-type="large"] .bb-fill{background:linear-gradient(90deg,#2d9cdb,#56ccf2);} 
.break-badge[data-break-type="recess"] .bb-fill{background:linear-gradient(90deg,#27ae60,#6fcf97);} 
@keyframes pulseRemain{from{opacity:1;}to{opacity:.55;}}

/* 移动端卡片优化 */
@media (max-width: 768px) {
    .student-card,
    .practice-status-card {
        min-height: 140px;
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .practice-status-card.compact {
        min-height: 120px;
        padding: 10px;
    }
    
    .student-name-compact {
        font-size: 1rem;
    }
    
    .student-info-row {
        font-size: 0.75rem;
        gap: 6px;
    }
    
    .practice-duration-large {
        font-size: 1rem;
        padding: 3px 6px;
    }
}

@media (max-width: 480px) {
    .student-card,
    .practice-status-card {
        min-height: 120px;
        padding: 8px;
    }
    
    .practice-status-card.compact {
        min-height: 100px;
        padding: 8px;
    }
    
    .student-name-compact {
        font-size: 0.95rem;
    }
    
    .student-info-row {
        font-size: 0.7rem;
        gap: 4px;
    }
    
    .practice-duration-large {
        font-size: 0.9rem;
        padding: 2px 4px;
    }
}

/* ===== 13. 卡片边框颜色 ===== */
.practice-status-card { 
  border-left-color: var(--secondary-color); 
  background: var(--card-bg);
}

.student-card.weekend,
.practice-status-card.weekend { 
  border-left-color: var(--muted-gray);
  background: var(--gradient-card);
}

.practice-status-card.present,
.student-card.present { 
    border-left-color: var(--success-color); 
}

.practice-status-card.absent,
.student-card.absent { 
    border-left-color: var(--danger-color); 
}

.practice-status-card.excused,
.student-card.excused { 
    border-left-color: var(--warning-color); 
}

.practice-status-card.low-efficiency,
.student-card.low-efficiency { 
  border-left-color: var(--warning-color); 
}

.practice-status-card.practicing-unscheduled,
.student-card.practicing-unscheduled { 
  border-left-color: var(--secondary-color); 
}

/* 自主练琴统一：使用与成功/缺勤同级的左侧色条（紫色） */
.practice-status-card.self-practice,
.student-card.self-practice {
  border-left-color: #8f53ff;
  background: var(--card-bg);
}

/* 自主练琴徽章（已在上方添加基础渐变，这里强化可读性） */
.student-status.self-practice,
.student-status-compact.self-practice {
  background: linear-gradient(135deg,#7e3ff2,#a16bff) !important;
  color:#fff !important;
  border:none !important;
  text-shadow:0 1px 2px rgba(0,0,0,0.25);
}

/* 紧凑卡片边框加轻微发光与 hover 效果 */
.practice-status-card.self-practice { 
  position:relative; 
  border-left:4px solid #8f53ff; 
  transition:box-shadow .25s, transform .25s; 
}
.practice-status-card.self-practice:hover { 
  box-shadow:0 4px 14px rgba(126,63,242,0.3); 
  transform:translateY(-2px); 
}

/* 性能模式降级：去除渐变与阴影，统一为纯色 */
html.performance-mode .student-status.self-practice,
html.performance-mode .student-status-compact.self-practice {
  background:#7e3ff2 !important;
  box-shadow:none !important;
}
html.performance-mode .practice-status-card.self-practice:hover { box-shadow:none; transform:none; }

/* ===== 14. 卡片内容样式（续） ===== */
.student-details,
.practice-details {
    width: 100%;
    margin-bottom: 15px;
}

/* 学生详情头部（使用变量以便主题切换） */
.student-header {
  margin-bottom: 15px;
  padding: 20px;
  border-radius: var(--radius-large);
  background: var(--gradient-header);
  color: var(--text-color);
}


/* 在更大屏幕上使用两列，但学生区域仍然全宽 */
@media (min-width: 1200px) {
    .student-details,
    .practice-details {
        grid-template-columns: 1fr 1fr;
    }
    
    /* 学生卡片区域跨越两列 */
    .student-grid,
    .department-section,
    .room-section {
        grid-column: 1 / -1;
    }
}

.detail-item {
    display: flex;
    flex-direction: column;
    padding: 4px 0;
}

.detail-label {
    font-size: 0.75rem;
    color: var(--medium-gray);
    margin-bottom: 2px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-color);
    line-height: 1.3;
}

/* 状态标签样式 */
.student-status,
.student-status-compact,
.practice-duration {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    white-space: nowrap;
    text-align: center;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    transition: all 0.15s ease-in-out;
}

/* 学生状态颜色 */
.student-status.present,
.student-status-compact.present { 
  background: var(--gradient-present);
  color: var(--text-color);
  border-color: transparent;
}

.student-status.absent,
.student-status-compact.absent { 
  background: var(--gradient-absent);
  color: var(--text-color);
  border-color: transparent;
}

.student-status.excused,
.student-status-compact.excused { 
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.student-status.low-efficiency,
.student-status-compact.low-efficiency { 
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.student-status.practicing-unscheduled,
.student-status-compact.practicing-unscheduled { 
  background: var(--gradient-primary);
  color: var(--text-color);
  border-color: transparent;
}

.student-status.weekend,
.student-status-compact.weekend { 
  background: var(--gradient-card);
  color: var(--text-color);
  border-color: transparent;
}

/* 练琴时长标签颜色 */
.practice-duration {
  background: var(--gradient-primary);
  color: var(--text-color);
  border-color: transparent;
}

@media (max-width: 768px) {
    .student-header {
        margin-bottom: 8px;
    }
    
    .student-name {
        font-size: 1.3rem;
    }
    .practice-details {
        grid-template-columns: 1fr;
        gap: 6px;
        margin-bottom: 10px;
    }
    
    .detail-label {
        font-size: 0.7rem;
    }
    
    .detail-value {
        font-size: 0.8rem;
    }
    
    .student-status,
    .student-status-compact,
    .practice-duration {
        padding: 3px 8px;
        font-size: 0.7rem;
        border-radius: 12px;
    }
}

/* ===== 15. 实时练琴指示器 ===== */
.practice-indicator {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    background: var(--success-color);
    border-radius: 50%;
    animation: pulse 2s infinite;
    box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
}

.practice-status-card.compact .practice-indicator {
    top: 12px;
    right: 12px;
    width: 10px;
    height: 10px;
}

@keyframes pulse {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
    }
    
    70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(39, 174, 96, 0);
    }
    
    100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0);
    }
}

@media (max-width: 768px) {
    .practice-indicator {
        width: 8px;
        height: 8px;
        top: 10px;
        right: 10px;
    }
    
    .practice-status-card.compact .practice-indicator {
        width: 6px;
        height: 6px;
        top: 8px;
        right: 8px;
    }
}

/* ===== 16. 考勤历史时间轴（修复移动端变形） ===== */
.attendance-history {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}

.history-title {
  font-size: 0.9rem;
  color: var(--medium-gray);
  margin-bottom: 10px;
  font-weight: 500;
}

.history-timeline {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 10px 0;
  justify-content: center;
  align-items: center;
  /* 🔥 防止容器被压缩 */
  min-height: 60px;
}

.history-timeline-container {
  padding: 15px 0;
  /* 🔥 确保容器有足够空间 */
  min-height: 80px;
}

.history-day {
  /* 🔥 核心修复：使用固定尺寸和防压缩属性 */
  width: 40px;
  height: 40px;
  min-width: 40px !important;
  min-height: 40px !important;
  max-width: 40px !important;
  max-height: 40px !important;
  flex: 0 0 40px; /* 🔥 关键：flex-basis固定，不允许伸缩 */
  
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  border: 2px solid transparent;
  box-sizing: border-box;
  
  /* 🔥 防止被任何布局影响 */
  flex-shrink: 0;
  flex-grow: 0;
  aspect-ratio: 1 / 1; /* 🔥 现代浏览器支持：强制1:1比例 */
}

.history-day:hover {
  transform: scale(1.15);
  z-index: 1;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* 状态颜色保持不变 */
.history-day.present { 
  background: var(--success-color); 
  color: white; 
  border-color: var(--success-color);
}

.history-day.absent { 
  background: var(--danger-color); 
  color: white; 
  border-color: var(--danger-color);
}

.history-day.excused { 
  background: var(--warning-color); 
  color: white; 
  border-color: var(--warning-color);
}

.history-day.no-data { 
  background: #f0f0f0; 
  color: #999999; 
  border-color: #f0f0f0;
}

.history-day.pending { 
  background: #f0f0f0; 
  color: #999999; 
  border-color: #f0f0f0;
}

.history-day.low-efficiency {
  background: var(--warning-color);
  border-color: var(--warning-color);
  color: white;
}

.history-day.practicing-unscheduled {
  background: var(--secondary-color);
  border-color: var(--secondary-color);
  color: white;
}

.history-day.weekend {
  background: var(--light-gray);
  border-color: var(--light-gray);
  color: var(--text-color);
}

/* 🔥 移动端优化 - 强制保持圆形 */
@media (max-width: 768px) {
  .attendance-history {
    margin-top: 10px;
    padding-top: 10px;
  }
  
  .history-timeline {
    gap: 6px;
    padding: 8px 0;
    min-height: 55px;
    /* 🔥 移动端使用更安全的布局 */
    justify-content: space-around;
  }
  
  .history-timeline-container {
    min-height: 70px;
  }
  
  .history-day {
    width: 35px;
    height: 35px;
    min-width: 35px !important;
    min-height: 35px !important;
    max-width: 35px !important;
    max-height: 35px !important;
    flex: 0 0 35px; /* 🔥 固定basis */
    font-size: 0.8rem;
    aspect-ratio: 1 / 1;
  }
  
  .history-day:hover {
    transform: scale(1.1);
  }
}

@media (max-width: 480px) {
  .history-timeline {
    gap: 4px;
    padding: 6px 0;
    min-height: 50px;
    justify-content: space-around;
  }
  
  .history-timeline-container {
    min-height: 65px;
  }
  
  .history-day {
    width: 32px;
    height: 32px;
    min-width: 32px !important;
    min-height: 32px !important;
    max-width: 32px !important;
    max-height: 32px !important;
    flex: 0 0 32px;
    font-size: 0.75rem;
    aspect-ratio: 1 / 1;
  }
  
  .history-day:hover {
    transform: scale(1.05);
  }
}

/* 🔥 超小屏幕保护 */
@media (max-width: 360px) {
  .history-timeline {
    gap: 3px;
    justify-content: space-around;
    min-height: 45px;
  }
  
  .history-timeline-container {
    min-height: 60px;
  }
  
  .history-day {
    width: 30px;
    height: 30px;
    min-width: 30px !important;
    min-height: 30px !important;
    max-width: 30px !important;
    max-height: 30px !important;
    flex: 0 0 30px;
    font-size: 0.7rem;
    aspect-ratio: 1 / 1;
  }
}

/* 🔥 确保在所有设备上都是完美圆形 */
@supports (aspect-ratio: 1 / 1) {
  .history-day {
    aspect-ratio: 1 / 1;
  }
}

/* 🔥 为不支持aspect-ratio的老浏览器提供后备 */
@supports not (aspect-ratio: 1 / 1) {
  .history-day::before {
    content: '';
    display: block;
    width: 100%;
    height: 0;
    padding-bottom: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
  }
}

/* ===== 17. 空状态样式 ===== */
.practice-empty-state,
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--medium-gray);
}

.practice-empty-state-icon,
.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.practice-empty-state-title,
.empty-state-title {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--text-color);
    font-weight: 600;
}

.practice-empty-state-description,
.empty-state-description {
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--medium-gray);
}

.empty-state {
    padding: 60px 20px;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.empty-state-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
}

.empty-state-description {
    font-size: 1rem;
    line-height: 1.6;
}

/* 移动端空状态优化 */
@media (max-width: 768px) {
    .empty-state {
        padding: 40px 15px;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .empty-state-title {
        font-size: 1.2rem;
        margin-bottom: 8px;
    }
    
    .empty-state-description {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .practice-empty-state {
        padding: 30px 15px;
    }
    
    .practice-empty-state-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
    }
    
    .practice-empty-state-title {
        font-size: 1.1rem;
        margin-bottom: 6px;
    }
    
    .practice-empty-state-description {
        font-size: 0.85rem;
    }
}

/* ===== 18. 筛选器样式 ===== */
.filters,
.practice-filters {
  background: var(--card-bg);
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 25px;
    box-shadow: var(--shadow);
}

.filter-row,
.practice-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
}

.practice-filter-row {
    gap: 12px;
}

.filter-group,
.practice-filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
    flex: 1;
}

.practice-filter-group {
    min-width: 120px;
}

.filter-label,
.practice-filter-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    margin-bottom: 5px;
    font-weight: 500;
}

.practice-filter-label {
    font-size: 0.85rem;
    margin-bottom: 4px;
}

.filter-select, 
.filter-input,
.practice-filter-select,
.practice-filter-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-small);
    font-size: 14px;
  transition: all 0.3s ease;
  background: var(--card-bg);
    color: var(--text-color);
}

.practice-filter-select,
.practice-filter-input {
    padding: 8px 10px;
}

.filter-select:focus, 
.filter-input:focus,
.practice-filter-select:focus,
.practice-filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

.filter-select:hover,
.filter-input:hover,
.practice-filter-select:hover,
.practice-filter-input:hover {
    border-color: var(--primary-color);
}

/* 快速筛选标签 */
.quick-filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
    justify-content: flex-start;
}

.quick-filter-tag {
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 20px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    background: var(--light-gray);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    min-width: auto;
}

.quick-filter-tag:hover {
  background: var(--light-gray);
    transform: translateY(-1px);
}

.quick-filter-tag.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* 移动端筛选器优化 */
@media (max-width: 768px) {
    .filters {
        padding: 15px;
        margin: 0 -5px 20px -5px;
    }
    
    .practice-filters {
        padding: 12px;
        margin: 0 -5px 15px -5px;
    }
    
    .filter-row,
    .practice-filter-row {
        flex-direction: column;
        gap: 12px;
    }
    
    .practice-filter-row {
        gap: 10px;
    }
    
    .filter-group,
    .practice-filter-group {
        min-width: auto;
        width: 100%;
    }
    
    .filter-select,
    .filter-input,
    .practice-filter-select,
    .practice-filter-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }
    
    .practice-filter-select,
    .practice-filter-input {
        padding: 10px 12px;
    }
    
    .filter-select:focus,
    .filter-input:focus,
    .practice-filter-select:focus,
    .practice-filter-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .quick-filter-tags {
        justify-content: center;
        margin-top: 12px;
    }
    
    .quick-filter-tag {
        padding: 6px 12px;
        font-size: 13px;
        height: 32px;
    }
}

/* 筛选器内的学生网格样式调整 */
.practice-filters .student-grid {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

/* 移动端优化 */
@media (max-width: 768px) {
    .practice-filters .student-grid {
        margin-top: 15px;
        padding-top: 15px;
    }
}

/* ===== 19. 操作按钮样式 ===== */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: var(--mobile-font-size);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: var(--touch-target-size);
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  appearance: none;
  -webkit-appearance: none;
    text-decoration: none;
    line-height: 1;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.btn:active {
    transform: scale(0.95);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* 按钮颜色变体 - 强制显示 */
.btn-primary {
    background: #3498db !important;
    color: white !important;
    border: 1px solid #3498db !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.btn-primary:hover {
  background: #2980b9 !important;
}

.btn-success {
    background: #27ae60 !important;
    color: white !important;
    border: 1px solid #27ae60 !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.btn-success:hover {
  background: #229954 !important;
}

.btn-warning {
    background: #f39c12 !important;
    color: white !important;
    border: 1px solid #f39c12 !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.btn-warning:hover {
  background: #e67e22 !important;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
  background: var(--danger-hover);
}

.btn-secondary {
    background: var(--medium-gray);
    color: white;
}

.btn-secondary:hover {
  background: var(--secondary-hover);
}

.btn-outline {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

/* 导出选项 */
.export-options {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

/* 移动端按钮优化 */
@media (max-width: 768px) {
  .action-buttons {
    position: sticky;
    bottom: 0;
    background: var(--card-bg);
    padding: 15px;
    margin: 20px -15px -15px -15px;
    border-top: 1px solid #eee;
    z-index: 10;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
  }
    
    .export-options {
        flex-direction: column;
        gap: 8px;
        margin-top: 15px;
    }
    
    .export-options .btn {
        width: 100%;
    }
    
    .btn {
        padding: 14px 20px;
        font-size: 16px;
        border-radius: 10px;
    }
}

/* ===== 20. 🔥 统一表格样式系统 ===== */
/* 🔥 核心：统一的表格容器样式 */
.data-table-container,
.table-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: auto;
  border-radius: 8px;
  border: 1px solid #e9ecef;
  background: var(--card-bg);
    position: relative;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    /* 🔥 统一最大高度 */
    max-height: 400px;
}

/* 🔥 核心：统一的表格样式 */
.data-table,
.detail-table {
    width: 100%;
    min-width: 500px; /* 🔥 统一最小宽度，确保表格完整显示 */
    border-collapse: collapse;
  margin: 0;
  background: var(--card-bg);
    font-size: 0.9rem; /* 🔥 统一字体大小 */
    border-radius: 0;
    overflow: hidden;
    box-shadow: none;
}

.data-table th,
.data-table td,
.detail-table th,
.detail-table td {
    padding: 12px 15px; /* 🔥 统一内边距 */
    text-align: left;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    vertical-align: middle;
    min-width: 80px; /* 🔥 统一最小列宽 */
    box-sizing: border-box;
}

.data-table th,
.detail-table th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 2px solid var(--border-color);
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
    z-index: 10;
}

.data-table tr:hover,
.detail-table tr:hover {
    background: var(--light-gray);
}

.data-table tr:last-child td,
.detail-table tr:last-child td {
    border-bottom: none;
}

/* 🔥 移动端表格适配 - 保持桌面端体验 */
@media (max-width: 768px) {
    .data-table-container,
    .table-container {
        /* 🔥 关键：移动端不改变容器样式，保持一致 */
        max-height: 350px; /* 稍微减少高度适应小屏幕 */
        border-radius: 8px;
        margin: 0; /* 🔥 不使用负边距 */
    }
    
    .data-table,
    .detail-table {
        min-width: 450px; /* 🔥 移动端稍微减少但保持足够宽度 */
        font-size: 0.85rem;
    }
    
    .data-table th,
    .data-table td,
    .detail-table th,
    .detail-table td {
        padding: 10px 12px; /* 🔥 移动端稍微减少内边距 */
        min-width: 70px;
    }
    
    .data-table th,
    .detail-table th {
        font-size: 0.75rem;
    }
}

@media (max-width: 480px) {
    .data-table-container,
    .table-container {
        max-height: 300px;
    }
    
    .data-table,
    .detail-table {
        min-width: 400px; /* 🔥 超小屏幕保持最小宽度 */
        font-size: 0.8rem;
    }
    
    .data-table th,
    .data-table td,
    .detail-table th,
    .detail-table td {
        padding: 8px 10px;
        min-width: 60px;
    }
    
    .data-table th,
    .detail-table th {
        font-size: 0.7rem;
    }
}

/* 🔥 滚动条美化 */
.data-table-container::-webkit-scrollbar,
.table-container::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

.data-table-container::-webkit-scrollbar-track,
.table-container::-webkit-scrollbar-track {
  background: var(--card-hover-bg);
    border-radius: 3px;
}

.data-table-container::-webkit-scrollbar-thumb,
.table-container::-webkit-scrollbar-thumb {
  background: var(--text-muted);
    border-radius: 3px;
}

.data-table-container::-webkit-scrollbar-thumb:hover,
.table-container::-webkit-scrollbar-thumb:hover {
  background: var(--medium-gray);
}

/* 🔥 滚动提示 */
.data-table-container::after,
.table-container::after {
  /* removed: visual '左右滑动查看更多' hint */
  content: none !important;
  display: none !important;
  position: absolute;
  bottom: 8px;
  right: 8px;
  pointer-events: none !important;
  opacity: 0 !important;
  transition: none !important;
  z-index: 0 !important;
}

.data-table-container:hover::after,
.table-container:hover::after {
  /* no-op when hidden */
  opacity: 0 !important;
}

/* 🔥 移动端滚动提示 */
@media (max-width: 768px) {
    .data-table-container::after,
    .table-container::after {
  /* mobile hint removed */
  content: none !important;
  display: none !important;
  font-size: 0.65rem;
  padding: 0;
  bottom: 6px;
    }
}

/* 🔥 特定表格样式 */
.history-table-card .table-container {

    /* 日间模式：确保伪元素提示已移除 */
    @media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
      .data-table-container::after,
      .table-container::after {
        content: none !important;
        display: none !important;
      }
    }
    max-height: 300px;
}

/* 全局强制隐藏旧版或备用实现的加载更多提示（以防同时存在 .load-more-hint 元素） */
.load-more-hint {
  display: none !important;
  visibility: hidden !important;
  pointer-events: none !important;
}

/* 表格单元格样式 */
.date-cell {
    font-weight: 500;
    color: var(--dark-gray);
    min-width: 100px;
}

.table-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    display: inline-block;
    border: 1px solid transparent;
}

.table-status-badge.present {
  background: var(--gradient-present);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.absent {
  background: var(--gradient-absent);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.excused {
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.low-efficiency {
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.practicing-unscheduled {
  background: var(--gradient-primary);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.weekend {
  background: var(--gradient-card);
  color: var(--text-color);
  border-color: transparent;
}

.table-status-badge.no-data { 
    background: #666666; 
    color: white; 
    border-color: #666666;
}

.duration-cell {
    color: var(--medium-gray);
    font-weight: 500;
    text-align: right;
    min-width: 80px;
}

.total-duration-cell {
    font-weight: 600;
    color: var(--primary-color);
    text-align: right;
    min-width: 90px;
}

/* 表格空状态 */
.table-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--medium-gray);
}

.table-empty-state-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    opacity: 0.5;
}

.table-empty-state-title {
    font-size: 1rem;
    margin-bottom: 5px;
    color: var(--text-color);
    font-weight: 600;
}

.table-empty-state-description {
    font-size: 0.85rem;
    line-height: 1.4;
}

/* 今日行样式 */
.today-row {
  background: var(--overlay-faint-strong);
}

/* ===== 21. 模态框样式优化（移动端流畅动画 - 向下关闭） ===== */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    /* 🔥 iOS风格：初始状态透明无模糊 */
    background: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    z-index: 2000;
    align-items: flex-start;
    justify-content: center;
    /* 🔥 桌面端：弹窗显示在屏幕下方约2/3位置 */
    padding-top: 20vh;
    /* 🔥 性能优化：GPU加速 */
    will-change: background, backdrop-filter;
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    /* 🔥 iOS风格过渡：与内容动画时间匹配 */
    transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* 🔥 桌面端显示遮罩 */
@media (min-width: 769px) {
    .modal.show {
        display: flex;
        /* 🔥 桌面端：显示时有半透明背景和模糊 */
        background: var(--modal-backdrop);
        backdrop-filter: blur(10px);
    }
}

/* 🔥 移动端性能优化：完全移除遮罩效果 */
@media (max-width: 768px) {
    .modal.show {
        /* 🔥 移动端完全移除背景遮罩 */
        background: transparent !important;
        backdrop-filter: none !important;
    }
    
    .modal.hiding {
        /* 🔥 移动端关闭时也无遮罩 */
        background: transparent !important;
        backdrop-filter: none !important;
    }
}

@media (max-width: 480px) {
    .modal.show {
        /* 🔥 小屏幕完全无遮罩 */
        background: transparent !important;
        backdrop-filter: none !important;
    }
    
    .modal.hiding {
        /* 🔥 小屏幕关闭时也无遮罩 */
        background: transparent !important;
        backdrop-filter: none !important;
    }
}

.modal.hiding {
    /* 🔥 iOS风格快速背景消失 */
    background: rgba(0, 0, 0, 0) !important;
    backdrop-filter: blur(0px) !important;
    transition: all 0.3s cubic-bezier(0.32, 0.0, 0.67, 0.0) !important;
}

.modal-content {
  background: var(--card-bg);
    border-radius: var(--radius-large);
    padding: 25px;
    max-width: min(800px, 95vw);
    width: 95%;
    max-height: 75vh;
    overflow-y: auto;
    position: relative;
  box-shadow: var(--modal-shadow, 0 20px 50px rgba(0,0,0,0.35));
    /* 🔥 桌面端：从上方滑入 */
    transform: translateZ(0) translateY(-50px) scale(0.94);
    opacity: 0;
    /* 🔥 性能优化：GPU加速 */
    will-change: transform, opacity;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    -webkit-perspective: 1000px;
    perspective: 1000px;
    /* 🔥 移除过渡，完全依赖动画 */
}

.modal.show .modal-content {
    /* 🔥 桌面端：从上方淡入弹出 */
    animation: slideInFromTop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.modal.hiding .modal-content {
    /* 🔥 桌面端：向上淡出关闭 */
    animation: slideOutToTop 0.18s cubic-bezier(0.32, 0.0, 0.67, 0.0) forwards !important;
}

/* 🔥 移动端iOS风格动画 */
@media (max-width: 768px) {
    .modal {
        align-items: flex-end;
        justify-content: center;
        padding-top: 0;
        /* 🔥 移动端无遮罩，无过渡效果 */
        transform: translateZ(0);
        transition: none;
    }
    
    .modal.show {
        display: flex;
        /* 🔥 移动端完全无遮罩 */
        background: transparent !important;
        backdrop-filter: none !important;
    }
    
    .modal-content {
        width: 100%;
        max-width: 100%;
        max-height: 100vh;
        /* 🔥 修复：完全覆盖底部，无圆角 */
        border-radius: var(--radius-large) var(--radius-large) 0 0;
        margin: 0;
        /* 🔥 修复：确保窗口从完全底部开始，无空白 */
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        /* 🔥 iOS移动端：初始状态在屏幕外底部 */
        transform: translateZ(0) translateY(100%);
        opacity: 1;
        /* 🔥 移动端性能优化 */
        will-change: transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        -webkit-perspective: 1000px;
        perspective: 1000px;
        /* 🔥 移动端渲染优化 */
        -webkit-transform: translateZ(0) translateY(100%);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    .modal.show .modal-content {
        /* 🔥 iOS移动端弹出动画 - 性能优化 */
        animation: slideUpBounce 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }
    
    .modal.hiding .modal-content {
        /* 🔥 iOS移动端超快关闭动画 - 性能优化 */
        animation: slideDownGesture 0.18s cubic-bezier(0.4, 0, 1, 1) forwards !important;
    }
}

/* 🔥 超小屏幕iOS优化 */
@media (max-width: 480px) {
    .modal-content {
        /* 🔥 超小屏幕：更小的顶部圆角 */
        border-radius: 12px 12px 0 0;
        max-height: 100vh;
        /* 🔥 确保完全贴底 */
        padding-bottom: env(safe-area-inset-bottom, 20px);
    }
    
    .modal.show .modal-content {
        /* 🔥 超小屏幕iOS弹出：性能优化 */
        animation: slideUpBounceSmall 0.35s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }
    
    .modal.hiding .modal-content {
        /* 🔥 超小屏幕超快关闭 - 性能优化 */
        animation: slideDownGestureSmall 0.15s cubic-bezier(0.4, 0, 1, 1) forwards !important;
    }
}

/* 🔥 桌面端iOS风格关闭动画 */
@media (min-width: 769px) {
    .modal.hiding .modal-content {
        /* 🔥 桌面端向上淡出关闭 */
        animation: slideOutToTop 0.18s cubic-bezier(0.32, 0.0, 0.67, 0.0) forwards !important;
    }
    
    .modal.hiding {
        /* 🔥 桌面端超快背景消失 */
        transition: all 0.18s cubic-bezier(0.32, 0.0, 0.67, 0.0) !important;
    }
}


/* 🔥 重新设计：iOS风格动画关键帧 - GPU优化 */
@keyframes slideUpBounce {
    0% {
        transform: translateZ(0) translateY(100%);
    }
    60% {
        transform: translateZ(0) translateY(-1%);
    }
    100% {
        transform: translateZ(0) translateY(0);
    }
}

/* 🔥 新增：桌面端从上方淡入动画 */
@keyframes slideInFromTop {
    0% {
        transform: translateZ(0) translateY(-50px) scale(0.94);
        opacity: 0;
    }
    60% {
        transform: translateZ(0) translateY(5px) scale(1.01);
        opacity: 0.9;
    }
    100% {
        transform: translateZ(0) translateY(0) scale(1);
        opacity: 1;
    }
}

/* 🔥 新增：桌面端向上淡出动画 */
@keyframes slideOutToTop {
    0% {
        transform: translateZ(0) translateY(0) scale(1);
        opacity: 1;
    }
    100% {
        transform: translateZ(0) translateY(-50px) scale(0.94);
        opacity: 0;
    }
}

/* 🔥 iOS风格关闭动画 - 纯位移无渐隐 */
@keyframes slideDownSmooth {
    0% {
        transform: translateY(0);
    }
    100% {
        transform: translateY(100%);
    }
}

/* 🔥 新增：iOS手势风格关闭动画 - GPU优化 */
@keyframes slideDownGesture {
    0% {
        transform: translateZ(0) translateY(0);
    }
    100% {
        transform: translateZ(0) translateY(100%);
    }
}

/* 🔥 小屏幕iOS风格动画 */
@keyframes slideDownSmoothSmall {
    0% {
        transform: translateY(0);
    }
    100% {
        transform: translateY(100%);
    }
}

@keyframes slideUpBounceSmall {
    0% {
        transform: translateZ(0) translateY(100%);
    }
    60% {
        transform: translateZ(0) translateY(-0.5%);
    }
    100% {
        transform: translateZ(0) translateY(0);
    }
}

/* 🔥 新增：超小屏幕手势关闭动画 - GPU优化 */
@keyframes slideDownGestureSmall {
    0% {
        transform: translateZ(0) translateY(0);
    }
    100% {
        transform: translateZ(0) translateY(100%);
    }
}

/* 🔥 添加触摸反馈 */
@media (max-width: 768px) {
    .modal-close {
        transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        transform: scale(1);
    }
    
    .modal-close:active {
        transform: scale(0.9);
        background: var(--danger-color);
        color: #fff;
    }
}


/* ===== 22. 模态框头部和关闭按钮优化 ===== */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding: 15px 0 15px 0;
    border-bottom: 2px solid var(--light-gray);
    position: relative;
    min-height: 60px;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
    flex: 1;
    line-height: 1.3;
    padding-right: 60px;
    padding-top: 5px;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 44px;
    height: 44px;
    background: transparent;
    border: none;
    font-size: 28px;
    font-weight: 300;
    color: var(--medium-gray);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
    z-index: 10;
    line-height: 1;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

.modal-close:hover {
  background: var(--danger-faint);
    color: var(--danger-color);
    transform: scale(1.1);
}

.modal-close:active {
    transform: scale(0.95);
  background: var(--danger-faint-2);
}

/* 🔥 移动端优化 */
@media (max-width: 768px) {
    .modal-header {
        padding: 10px 0 12px 0;
        min-height: 50px;
    }
    
    .modal-title {
        font-size: 1.3rem;
        padding-right: 50px;
        padding-top: 3px;
    }
    
    .modal-close {
        width: 40px;
        height: 40px;
        font-size: 24px;
        top: 8px;
        right: 8px;
    }
    
    .modal-content {
        padding: 15px;
        width: 100%;
        max-width: 100%;
        border-radius: var(--radius-large) var(--radius-large) 0 0;
        margin: 0;
    }
}

@media (max-width: 480px) {
    .modal-header {
        padding: 8px 0 10px 0;
        min-height: 45px;
    }
    
    .modal-title {
        font-size: 1.2rem;
        padding-right: 45px;
        padding-top: 2px;
    }
    
    .modal-close {
        width: 36px;
        height: 36px;
        font-size: 22px;
        top: 6px;
        right: 6px;
    }
    
    .modal-content {
        padding: 12px;
    }
}

/* ===== 23. 加载动画 ===== */
.loading {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--light-gray);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 15px;
    color: var(--medium-gray);
    font-size: 0.9rem;
}

/* 移动端加载动画优化 */
@media (max-width: 768px) {
    .loading {
        padding: 30px 20px;
    }
    
    .spinner {
        width: 35px;
        height: 35px;
        border-width: 3px;
    }
    
    .loading-text {
        margin-top: 12px;
        font-size: 0.85rem;
    }
}

/* ===== 24. 日期选择器样式 ===== */
.date-picker {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.date-input {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-small);
    font-size: 14px;
    color: var(--text-color);
  background: var(--card-bg);
    transition: all 0.3s ease;
}

.date-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

/* 移动端日期选择器优化 */
@media (max-width: 768px) {
    .date-picker {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 15px;
  background: var(--card-bg);
        border-radius: var(--radius);
  box-shadow: var(--shadow);
        margin-bottom: 20px;
    }
    
    .date-input {
        width: 100%;
        padding: 12px 15px;
        font-size: 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
    }
    
    .date-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
}

/* ===== 25. 学生详情页面特殊样式 ===== */
.student-detail-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 800px;
    margin: 0 auto;
}

/* 学生档案卡片 */
.student-profile-card {
  /* 添加渐变背景来凸显学生姓名卡片 */
  background: linear-gradient(135deg, var(--primary-color), #58a6ff);
  color: white;
  padding: 22px 24px;
  border-radius: var(--radius-large);
  text-align: center;
  box-shadow: var(--shadow-hover);
  border: none;
  position: relative;
  overflow: hidden;
}

.profile-info {
    width: 100%;
}

.profile-name {
  font-size: 2.2rem;
  font-weight: 700;
  margin: 0 0 8px 0;
  color: white;
  line-height: 1.1;
  text-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.profile-meta {
  display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 12px;
  font-size: 0.98rem;
  color: var(--text-secondary);
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.meta-icon {
    font-size: 1rem;
}

.meta-divider {
    opacity: 0.6;
    margin: 0 4px;
    font-size: 1.2rem;
}

/* 今日状态卡片 */
.today-status-card {
  background: var(--card-bg);
  border-radius: 14px;
  padding: 18px;
  box-shadow: var(--shadow);
  border-left: 6px solid var(--primary-color);
}

.today-status-card.present { border-left-color: var(--success-color); }
.today-status-card.absent { border-left-color: var(--danger-color); }
.today-status-card.excused { border-left-color: var(--warning-color); }
.today-status-card.low-efficiency { border-left-color: #f39c12; }
.today-status-card.practicing-unscheduled { border-left-color: #9b59b6; }
.today-status-card.weekend { border-left-color: var(--muted-gray); }

.status-header {
    display: flex;
  font-weight: 700;
  color: var(--text-color);
  margin: 0;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.status-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: var(--radius-large);
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid transparent;
    color: var(--text-color);
    background: var(--overlay-faint-strong);
}

/* responsive tweak for small screens */
@media (max-width: 480px) {
  .today-status-card { padding: 14px; }
  .status-title { font-size: 1.05rem; }
  .status-badge { font-size: 0.9rem; padding: 5px 8px; }
}

.status-badge.present { background: var(--gradient-present); color: var(--text-color); border-color: transparent; }
.status-badge.absent { background: var(--gradient-absent); color: var(--text-color); border-color: transparent; }
.status-badge.excused { background: var(--gradient-excused); color: var(--text-color); border-color: transparent; }
.status-badge.low-efficiency { background: var(--gradient-excused); color: var(--text-color); border-color: transparent; }
.status-badge.practicing-unscheduled { background: var(--gradient-primary); color: var(--text-color); border-color: transparent; }
.status-badge.self-practice,
.status-badge.practicing-unscheduled { 
  background: linear-gradient(135deg,#7e3ff2,#a16bff) !important; 
  color:#fff !important; 
  border-color:transparent !important; 
}
.status-badge.weekend { background: var(--gradient-card); color: var(--text-color); border-color: transparent; }

.metric-icon {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  background: var(--overlay-faint-strong);
    border-radius: 50%;
}

/* 日间模式：为今日卡片和徽章应用浅色渐变以增强区分度 */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  .today-status-card.present { background: var(--gradient-present-light); }
  .today-status-card.absent { background: var(--gradient-absent-light); }
  .today-status-card.excused { background: var(--gradient-excused-light); }
  .today-status-card.practicing-unscheduled { background: var(--gradient-primary-light); }
  .today-status-card.weekend { background: var(--gradient-weekend-light); }

  .status-badge.present { background: var(--gradient-present-light); color: var(--text-color); border-color: transparent; }
  .status-badge.absent { background: var(--gradient-absent-light); color: var(--text-color); border-color: transparent; }
  .status-badge.excused { background: var(--gradient-excused-light); color: var(--text-color); border-color: transparent; }
  .status-badge.practicing-unscheduled { background: var(--gradient-primary-light); color: var(--text-color); border-color: transparent; }
  .status-badge.self-practice { background:#8f53ff; color:#fff; }
  .status-badge.weekend { background: var(--gradient-weekend-light); color: var(--text-color); border-color: transparent; }
}

.status-metrics .metric-item {
  padding: 14px;
  gap: 12px;
  align-items: center;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
}

.status-metrics .metric-item:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-hover);
}

.metric-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-color);
  line-height: 1.05;
}

.metric-label {
  font-size: 0.92rem;
  color: var(--text-secondary);
}

@media (max-width: 480px) {
  .status-metrics .metric-item { padding: 12px; }
  .metric-value { font-size: 1.25rem; }
}

/* 请假信息 */
.excuse-info {
    margin-top: 20px;
    padding: 16px;
  background: var(--warning-faint);
    border-radius: var(--radius);
    border-left: 4px solid #f39c12;
}

.excuse-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.excuse-icon {
    font-size: 1.2rem;
}

.excuse-title {
    font-weight: 600;
    color: #b06000;
}

.excuse-content {
    padding-left: 28px;
}

.excuse-reason {
    margin: 0 0 4px 0;
    color: #856404;
    font-weight: 500;
}

.excuse-approver {
    margin: 0;
    font-size: 0.9rem;
    color: #6c5700;
}

/* 通用卡片样式 */
.card-header {
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--light-gray);
}

.card-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.title-icon {
    font-size: 1.3rem;
}

.title-subtitle {
    font-size: 0.85rem;
    font-weight: 400;
    color: var(--medium-gray);
    margin-left: 4px;
}

/* 统计网格详细版 */
.stats-grid-detailed {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    max-width: 100%;
}

.stats-grid-detailed .stat-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px;
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    min-height: 80px;
}

.stats-grid-detailed .stat-item:hover {
    transform: translateY(-3px);
}

.stats-grid-detailed .stat-item.present { 
  background: var(--gradient-present);
}

.stats-grid-detailed .stat-item.absent { 
  background: var(--gradient-absent);
}

.stats-grid-detailed .stat-item.excused { 
  background: var(--gradient-excused);
}

.stats-grid-detailed .stat-item.rate { 
  background: var(--gradient-rate);
}

.stats-grid-detailed .stat-icon {
    font-size: 1.5rem;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
  background: var(--overlay-faint-strong);
    border-radius: 50%;
    flex-shrink: 0;
}

.stats-grid-detailed .stat-content {
    flex: 1;
    min-width: 0;
}

.stats-grid-detailed .stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
    color: var(--text-color);
}

.stats-grid-detailed .stat-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    font-weight: 500;
    line-height: 1.2;
}

/* 移动端学生详情页面优化 */
@media (max-width: 768px) {
    .student-detail-content {
        gap: 16px;
    }
    
    .student-profile-card {
        padding: 25px 20px;
    }
    
    .profile-name {
        font-size: 2rem;
    }
    
    .profile-meta {
        font-size: 1rem;
        gap: 10px;
    }
    
    .status-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .status-metrics {
        grid-template-columns: 1fr;
    }
    
    .stats-grid-detailed {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 16px;
        min-height: 70px;
    }
    
    .stats-grid-detailed .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1.3rem;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.5rem;
    }
    
    .stats-grid-detailed .stat-label {
        font-size: 0.85rem;
    }
}

@media (max-width: 480px) {
    .student-detail-content {
        gap: 16px;
    }
    
    .card {
        padding: 20px 16px;
    }
    
    .profile-name {
        font-size: 1.8rem;
    }
    
    .profile-meta {
        font-size: 0.9rem;
        gap: 8px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 14px;
        min-height: 60px;
        gap: 10px;
    }
    
    .stats-grid-detailed .stat-icon {
        width: 35px;
        height: 35px;
        font-size: 1.2rem;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.3rem;
    }
    
    .stats-grid-detailed .stat-label {
        font-size: 0.8rem;
    }
}

/* 中等屏幕统计网格优化 */
@media (min-width: 769px) and (max-width: 1024px) {
    .stats-grid-detailed {
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
    }
    
    .stats-grid-detailed .stat-item {
        padding: 18px;
    }
    
    .stats-grid-detailed .stat-number {
        font-size: 1.6rem;
    }
}

/* 大屏幕统计网格优化 */
@media (min-width: 1200px) {
    .stats-grid-detailed {
        max-width: 600px;
        margin: 0 auto;
    }
}

/* ===== 26. 时间段标签美化样式 ===== */
.time-slot-tag {
    display: inline-block;
    background: transparent;
  color: var(--medium-gray);
    border: none;
    padding: 2px 4px;
    margin: 2px 4px 2px 0;
    border-radius: 0;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: none;
    transition: all 0.2s ease;
    white-space: nowrap;
}

time-slot-tag:hover {
  color: var(--text-color);
    transform: none;
    box-shadow: none;
    background: transparent;
}

.time-slots-wrapper {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    justify-content: flex-start;
    gap: 0;
    margin-top: 4px;
    width: 100%;
    margin-left: 0;
    padding-left: 0;
}

.time-slots-container {
    width: 100%;
}

.time-slots-container .metric-value {
    line-height: 1.4;
    text-align: left;
    width: 100%;
    margin-left: 0;
    padding-left: 0;
}

.time-slots-container.metric-item {
    justify-content: flex-start;
    align-items: flex-start;
    flex-direction: row;
    text-align: left;
    gap: 12px;
    padding: 16px;
}

.time-slots-container .metric-content {
    width: 100%;
    text-align: left;
    margin-left: 0;
    padding-left: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.metric-content .metric-label {
    margin-left: 0;
    padding-left: 0;
    text-align: left;
    order: 1;
    font-size: 0.9rem;
    color: var(--medium-gray);
    margin-bottom: 6px;
}

.metric-content .metric-value.time-slots-wrapper {
    margin-left: 0 !important;
    padding-left: 0 !important;
    text-align: left;
    justify-content: flex-start !important;
    order: 2;
    margin-top: 0;
}

/* 当前时间段高亮 - 只有这个状态才有背景和形状 */
.time-slot-tag.current {
    background: linear-gradient(135deg, #d1ecf1, #bee5eb);
    color: #0c5460;
    border: 1px solid #b8daff;
    padding: 6px 14px;
    border-radius: 18px;
    font-weight: 600;
    font-size: 0.95rem;
    box-shadow: 0 1px 3px rgba(12, 84, 96, 0.2);
    animation: pulse-glow 2s infinite;
}

.time-slot-tag.current:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(12, 84, 96, 0.3);
}

@keyframes pulse-glow {
    0%, 100% { 
        box-shadow: 0 1px 3px rgba(12, 84, 96, 0.2);
    }
    50% { 
        box-shadow: 0 2px 8px rgba(12, 84, 96, 0.3);
    }
}

.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: start;
}

.status-metrics .metric-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--radius);
    transition: transform 0.2s ease;
    text-align: left;
}

.status-metrics .time-slots-container.metric-item .metric-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
}

.status-metrics .time-slots-container.metric-item .metric-label {
    align-self: flex-start;
    margin-left: 0;
    padding-left: 0;
}

.status-metrics .time-slots-container.metric-item .metric-value {
    align-self: flex-start;
    width: 100%;
    margin-left: 0;
    padding-left: 0;
}

/* 移动端优化 */
@media (max-width: 768px) {
    .time-slot-tag {
        font-size: 0.85rem;
        padding: 3px 4px;
        margin: 1px 3px 1px 0;
        font-weight: 500;
    }
    
    .time-slot-tag.current {
        padding: 5px 12px;
        font-size: 0.9rem;
    }
    
    .time-slots-container .metric-value {
        line-height: 1.5;
        text-align: left;
        margin-left: 0;
        padding-left: 0;
    }
    
    .time-slots-wrapper {
        justify-content: flex-start;
        margin-left: 0;
        padding-left: 0;
    }
    
    .status-metrics {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (max-width: 480px) {
    .time-slot-tag {
        font-size: 0.8rem;
        padding: 2px 3px;
        margin: 1px 2px 1px 0;
    }
    
    .time-slot-tag.current {
        padding: 4px 10px;
        font-size: 0.85rem;
    }
    
    .time-slots-wrapper {
        margin-top: 2px;
        justify-content: flex-start;
        margin-left: 0;
        padding-left: 0;
    }
    
    .time-slots-container .metric-value {
        margin-left: 0;
        padding-left: 0;
    }
}

/* ===== 27. 加载更多提示 ===== */
.load-more-hint {
    text-align: center;
    padding: 15px;
    color: var(--medium-gray);
    font-size: 0.85rem;
    border-top: 1px solid #eee;
    background: var(--light-gray);
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.load-more-hint:hover {
  background: var(--light-gray);
}

.load-more-hint.loading {
    color: var(--primary-color);
    cursor: not-allowed;
}

/* ===== 28. 触摸优化 ===== */
.student-card, 
.practice-status-card, 
.stat-card, 
.btn, 
.nav-tabs {
  display: flex;
  background: var(--card-bg);
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
}

.student-card:active, 
.practice-status-card:active, 
.stat-card:active {
    transform: scale(0.98);
}

.btn:active {
    transform: scale(0.95);
}

.quick-filter-tag:active,
.history-day:active {
    transform: scale(0.95);
}

/* ===== 29. iOS安全区域适配 ===== */
@supports (padding: max(0px)) {
    .container {
        padding-left: max(20px, env(safe-area-inset-left));
        padding-right: max(20px, env(safe-area-inset-right));
    }
    
    @media (max-width: 768px) {
        .container {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }
    }
}

/* ===== 30. 横屏模式优化 ===== */
@media (max-width: 768px) and (orientation: landscape) {
    .header {
        padding: max(15px, env(safe-area-inset-top) + 10px) 20px 15px 20px;
    }
    
    .header h1 {
        font-size: 1.8rem;
        margin-bottom: 5px;
    }
    
    .header .subtitle {
        font-size: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .modal-content {
        max-height: 80vh;
    }
    
    .student-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* ===== 31. iOS Safari 特殊优化 ===== */
@supports (-webkit-touch-callout: none) {
    .nav-tabs {
        -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
        -webkit-overflow-scrolling: touch;
    }
    
    input, select, textarea {
  appearance: none;
  -webkit-appearance: none;
  border-radius: 8px;
    }
    
  .btn {
    appearance: none;
    -webkit-appearance: none;
  }
}

/* ===== 32. 滚动条样式 ===== */
* {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

*::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

*::-webkit-scrollbar-track {
    background: transparent;
}

*::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

*::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0, 0, 0, 0.4);
}

/* 移动端滚动条 */
@media (max-width: 768px) {
    *::-webkit-scrollbar {
        width: 3px;
        height: 3px;
    }
}

/* ===== 33. 可访问性优化 ===== */
.student-card:focus,
.practice-status-card:focus,
.btn:focus,
.nav-tab:focus,
.quick-filter-tag:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

button:focus,
input:focus,
select:focus,
textarea:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 1px;
}

/* 高对比度模式支持 */
@media (prefers-contrast: high) {
    :root {
        --border-color: #000;
        --text-color: #000;
        --background-color: #fff;
    }
    
    .card {
        border: 2px solid #000;
    }
    
    .btn {
        border: 2px solid currentColor;
    }
}

/* 减少动画偏好 */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .practice-indicator {
        animation: none;
    }
    
    .spinner {
        animation: none;
    }
}

/* ===== 34. 打印样式优化 ===== */
@media print {
    .language-switcher,
    .connection-status,
    .nav-tabs,
    .action-buttons,
    .btn,
    .modal,
    .practice-indicator {
        display: none !important;
    }
    
    .container {
        max-width: none;
        padding: 0;
    }
    
    .card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
        margin-bottom: 15px;
    }
    
    .student-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .student-card,
    .practice-status-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .header {
        background: none !important;
        color: #000 !important;
        box-shadow: none;
    }
    
    body {
        background: white !important;
        color: black !important;
    }
}

/* ===== 35. 统一的状态颜色系统（变量驱动） ===== */
.present,
.student-status.present,
.student-status-compact.present,
.table-status-badge.present,
.status-badge.present {
  background: var(--gradient-present);
  color: var(--text-color);
  border-color: transparent;
}

.absent,
.student-status.absent,
.student-status-compact.absent,
.table-status-badge.absent,
.status-badge.absent {
  background: var(--gradient-absent);
  color: var(--text-color);
  border-color: transparent;
}

.pending,
.student-status.pending,
.student-status-compact.pending,
.table-status-badge.pending,
.status-badge.pending {
  background: var(--gradient-card);
  color: var(--text-secondary);
  border-color: transparent;
}

.excused,
.student-status.excused,
.student-status-compact.excused,
.table-status-badge.excused,
.status-badge.excused {
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.low-efficiency,
.student-status.low-efficiency,
.student-status-compact.low-efficiency,
.table-status-badge.low-efficiency,
.status-badge.low-efficiency {
  background: var(--gradient-excused);
  color: var(--text-color);
  border-color: transparent;
}

.practicing-unscheduled,
.student-status.practicing-unscheduled,
.student-status-compact.practicing-unscheduled,
.table-status-badge.practicing-unscheduled,
.status-badge.practicing-unscheduled {
  background: var(--gradient-primary);
  color: var(--text-color);
  border-color: transparent;
}

.weekend,
.student-status.weekend,
.student-status-compact.weekend,
.table-status-badge.weekend,
.status-badge.weekend {
  background: var(--gradient-card);
  color: var(--text-color);
  border-color: transparent;
}

/* ===== 36. 文本和排版优化 ===== */
p, div, span {
    line-height: 1.5;
}

h1, h2, h3, h4, h5, h6 {
    line-height: 1.2;
    margin-bottom: 0.5em;
    font-weight: 600;
}

/* 确保所有文本输入框在iOS上不会被缩放 */
input, select, textarea, button {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

/* 确保触摸目标足够大 */
.nav-tab,
.btn,
.lang-btn,
.connection-status,
.student-card,
.practice-status-card,
.history-day,
.quick-filter-tag {
    min-height: 44px;
    min-width: 44px;
}

/* 小屏幕下的触摸目标调整 */
@media (max-width: 480px) {
    .nav-tab,
    .btn {
        min-height: 40px;
    }
    
    .lang-btn {
        min-height: 32px;
        min-width: 32px;
    }
    
    .history-day {
        min-height: 32px;
        min-width: 32px;
    }
}

/* ===== 37. 特殊内容处理 ===== */
.detail-item[style*="grid-column: 1 / -1"] .detail-value {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-top: 2px;
}

.detail-item .detail-value[style*="color: #f39c12"] {
  background: var(--warning-faint);
    padding: 6px 8px;
    border-radius: var(--radius-small);
    font-size: 0.8rem;
    line-height: 1.3;
}

/* ===== 38. 防止模态框背景滚动 ===== */
body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
}

/* 移动端防滚动优化 */
@media (max-width: 768px) {
    body.modal-open {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        -webkit-overflow-scrolling: none;
    }
}

/* ===== 39. 新增：目前未练琴状态样式 ===== */
.student-status.not-practicing,
.student-status-compact.not-practicing,
.table-status-badge.not-practicing,
.status-badge.not-practicing {
  background: var(--card-bg);
  color: var(--text-secondary);
  border-color: var(--border-color);
}

.practice-status-card.not-practicing,
.student-card.not-practicing {
  border-left-color: var(--medium-gray);
}

/* 考勤历史时间轴样式 */
.history-day.not-practicing {
  background: var(--medium-gray);
  border-color: var(--medium-gray);
    color: white;
}

/* ===== 40. 深色模式完整适配 ===== */
@media (prefers-color-scheme: dark) {
    :root {
        /* 深色模式颜色变量重定义 */
        --background-color: #0d1117;
        --card-bg: #21262d;
        --card-hover-bg: #30363d;
        --text-color: #f0f6fc;
        --text-secondary: #8b949e;
        --text-muted: #6e7681;
        --border-color: #30363d;
        --light-gray: #21262d;
        --medium-gray: #8b949e;
        --dark-gray: #f0f6fc;
        --shadow-color: rgba(0,0,0,0.4);
        
        /* 深色模式下的主色调调整 */
        --primary-color: #58a6ff;
        --secondary-color: #3fb950;
        --warning-color: #d29922;
        --danger-color: #f85149;
        --success-color: #3fb950;
        
        /* 深色模式渐变色 */
        --gradient-primary: linear-gradient(135deg, #58a6ff, #3fb950);
        --gradient-card: linear-gradient(135deg, #21262d, #30363d);
  /* 深色模式状态卡片渐变覆盖 */
  --gradient-present: linear-gradient(135deg, #0d2818, #238636);
  --gradient-absent: linear-gradient(135deg, #2c0e0e, #da3633);
  --gradient-excused: linear-gradient(135deg, #2d1b00, #bb8009);
  --gradient-low-efficiency: rgba(243,156,18,0.75);
  --gradient-rate: linear-gradient(135deg, #0c1929, #1f6feb);
  --gradient-header: linear-gradient(135deg, #1f2937, #374151);
  --modal-backdrop: rgba(0,0,0,0.6);
  --modal-shadow: 0 20px 50px rgba(0,0,0,0.5);
        
        /* 深色模式阴影 */
        --shadow: 0 2px 10px rgba(0,0,0,0.4);
        --shadow-hover: 0 5px 20px rgba(0,0,0,0.6);
    }
    
    /* 基础元素深色适配 */
    body {
        background: var(--background-color);
        color: var(--text-color);
    }

  /* 深色模式 - 使用纯色而非渐变来区分状态卡片 */
  .stats-grid-detailed .stat-item.present,
  .today-status-card.present { background: rgba(30,95,63,0.65) !important; }

  .stats-grid-detailed .stat-item.absent,
  .today-status-card.absent { background: rgba(122,31,31,0.6) !important; }

  .stats-grid-detailed .stat-item.low-efficiency,
  .today-status-card.low-efficiency { background: rgba(243,156,18,0.6) !important; }

  .stats-grid-detailed .stat-item.excused,
  .today-status-card.excused { background: rgba(139,95,34,0.6) !important; }

  /* 状态标签与表格内状态也使用纯色背景 */
  .table-status-badge.present,
  .status-badge.present,
  .student-status.present { background: rgba(30,95,63,0.6) !important; color: var(--text-color) !important; }

  .table-status-badge.absent,
  .status-badge.absent,
  .student-status.absent { background: rgba(122,31,31,0.55) !important; color: var(--text-color) !important; }

  .table-status-badge.excused,
  .status-badge.excused,
  .student-status.excused { background: rgba(139,95,34,0.55) !important; color: var(--text-color) !important; }

  .table-status-badge.low-efficiency,
  .status-badge.low-efficiency,
  .student-status.low-efficiency { background: rgba(243,156,18,0.55) !important; color: var(--text-color) !important; }

  .table-status-badge.practicing-unscheduled,
  .status-badge.practicing-unscheduled,
  .student-status.practicing-unscheduled,
  .student-status-compact.practicing-unscheduled { background: rgba(88,166,255,0.6) !important; color: var(--text-color) !important; }

  .table-status-badge.weekend,
  .status-badge.weekend,
  .student-status.weekend,
  .student-status-compact.weekend { background: rgba(139,149,158,0.6) !important; color: var(--text-color) !important; }

  .table-status-badge.pending,
  .status-badge.pending,
  .student-status.pending,
  .student-status-compact.pending { background: rgba(108,117,125,0.6) !important; color: var(--text-color) !important; }

  .table-status-badge.not-practicing,
  .status-badge.not-practicing,
  .student-status.not-practicing,
  .student-status-compact.not-practicing { background: rgba(139,149,158,0.5) !important; color: var(--text-color) !important; }

  .table-status-badge.no-data,
  .status-badge.no-data,
  .student-status.no-data { background: #cccccc !important; color: #333333 !important; }

  /* 练琴时长标签深色适配 - 也使用纯色 */
  .practice-duration,
  .practice-duration-large { background: rgba(155,89,182,0.6) !important; color: var(--text-color) !important; }
    
    /* 卡片和容器深色适配 */
    .card,
    .student-card,
    .practice-status-card,
    .stat-card,
    .today-status-card {
        background: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .card:hover,
    .student-card:hover,
    .practice-status-card:hover {
        background: var(--card-hover-bg);
    }
    
    /* 导航和标签深色适配 */
    .nav-tabs {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .nav-tab {
        color: var(--medium-gray);
    }
    
  .nav-tab:hover {
    background: var(--accent-faint);
    color: var(--primary-color);
  }
    
    .nav-tab.active {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 语言切换器深色适配 */
    .language-switcher {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .lang-btn {
        color: var(--medium-gray);
    }
    
  .lang-btn:hover:not(.active) {
    background: var(--accent-faint);
    color: var(--primary-color);
  }
    
    .lang-btn.active {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 连接状态指示器深色适配 */
    .connection-status.online {
        background: var(--card-bg);
        color: var(--success-color);
        border-color: var(--success-color);
    }
    
    .connection-status.offline {
        background: var(--card-bg);
        color: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .connection-status.syncing {
        background: var(--card-bg);
        color: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    /* 筛选器深色适配 */
    .filters,
    .practice-filters {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .practice-filter-label,
    .filter-label {
        color: var(--medium-gray);
    }
    
    .filter-select,
    .filter-input,
    .practice-filter-select,
    .practice-filter-input,
    .date-input {
        background: var(--background-color);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .filter-select:focus,
    .filter-input:focus,
    .practice-filter-select:focus,
    .practice-filter-input:focus,
    .date-input:focus {
        border-color: var(--primary-color);
  box-shadow: 0 0 0 2px var(--accent-faint);
    }
    
    .filter-select:hover,
    .filter-input:hover,
    .practice-filter-select:hover,
    .practice-filter-input:hover,
    .date-input:hover {
        border-color: var(--primary-color);
    }
    
    /* 快速筛选标签深色适配 */
    .quick-filter-tag {
        background: var(--card-hover-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .quick-filter-tag:hover {
  background: var(--dark-gray);
        transform: translateY(-1px);
    }
    
    .quick-filter-tag.active {
        background: var(--primary-color);
        color: #0d1117;
        border-color: var(--primary-color);
    }
    
    /* 按钮深色适配 */
    .btn-primary {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    .btn-primary:hover {
  background: var(--primary-hover);
    }
    
    .btn-success {
        background: var(--success-color);
        color: #0d1117;
    }
    
    .btn-success:hover {
  background: var(--success-hover);
    }
    
    .btn-warning {
        background: var(--warning-color);
        color: #0d1117;
    }
    
    .btn-warning:hover {
  background: var(--warning-hover);
    }
    
    .btn-danger {
        background: var(--danger-color);
        color: #0d1117;
    }
    
    .btn-danger:hover {
  background: var(--danger-hover);
    }
    
    .btn-secondary {
        background: var(--medium-gray);
        color: #0d1117;
    }
    
    .btn-secondary:hover {
  background: var(--secondary-hover);
    }
    
    .btn-outline {
        background: transparent;
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-outline:hover {
        background: var(--primary-color);
        color: #0d1117;
    }
    
    /* 模态框深色适配 */
    .modal {
  background: var(--modal-backdrop-strong);
    }
    
    .modal-content {
        background: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    .modal-close {
        background: var(--card-hover-bg);
        color: var(--medium-gray);
    }
    
    .modal-close:hover {
        background: var(--danger-color);
        color: #0d1117;
    }
    
    /* 表格深色适配 */
    .data-table,
    .detail-table {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
    .data-table th,
    .data-table td,
    .detail-table th,
    .detail-table td {
        border-bottom-color: var(--border-color);
        color: var(--text-color);
    }
    
    .data-table th,
    .detail-table th {
        background: var(--card-hover-bg);
        color: var(--text-color);
        border-bottom-color: var(--border-color);
    }
    
    .data-table tr:hover,
    .detail-table tr:hover {
        background: var(--card-hover-bg);
    }
    
    .data-table-container,
    .table-container {
        background: var(--card-bg);
        border-color: var(--border-color);
    }
    
  /* 状态标签深色模式适配（使用深色变量） */
  .student-status.present,
  .student-status-compact.present,
  .table-status-badge.present,
  .status-badge.present {
    background: var(--gradient-present);
    color: var(--text-color);
    border-color: transparent;
  }

  .student-status.absent,
  .student-status-compact.absent,
  .table-status-badge.absent,
  .status-badge.absent {
    background: var(--gradient-absent);
    color: var(--text-color);
    border-color: transparent;
  }

  .student-status.excused,
  .student-status-compact.excused,
  .table-status-badge.excused,
  .status-badge.excused {
    background: var(--gradient-excused);
    color: var(--text-color);
    border-color: transparent;
  }

  .student-status.low-efficiency,
  .student-status-compact.low-efficiency,
  .table-status-badge.low-efficiency,
  .table-status-badge.low_efficiency,
  .status-badge.low-efficiency {
    background: var(--gradient-absent);
    color: var(--text-color);
    border-color: transparent;
  }

  /* 移除这些深色模式下的渐变样式，使用上面的纯色替代 */

  .student-status.pending,
  .student-status-compact.pending,
  .table-status-badge.pending,
  .status-badge.pending {
    background: var(--card-bg);
    color: var(--text-secondary);
    border-color: transparent;
  }

  /* 这个样式已被上面的纯色覆盖 */
    
  /* 移除这些注释，因为上面已经用纯色覆盖了 */
    
    /* 考勤历史时间轴深色适配 */
    .history-day.present {
        background: var(--success-color);
        border-color: var(--success-color);
    }
    
    .history-day.absent {
        background: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .history-day.excused {
        background: var(--warning-color);
        border-color: var(--warning-color);
    }
    
    .history-day.no-data {
        background: #cccccc;
        color: #333333;
        border-color: #cccccc;
    }

    .history-day.pending {
        background: #cccccc;
        color: #333333;
        border-color: #cccccc;
    }
    
    .history-day.low-efficiency {
  background: var(--amber-strong);
        border-color: #bb8009;
    }
    
    .history-day.practicing-unscheduled {
  background: var(--purple-strong);
        border-color: #a475f9;
    }
    
    .history-day.weekend {
  background: var(--muted-dark);
        border-color: #8b949e;
    }
    
    .history-day.not-practicing {
  background: var(--muted-dark);
        border-color: #8b949e;
    }
    
    /* 卡片边框颜色深色适配 */
    .practice-status-card.present,
    .student-card.present {
        border-left-color: var(--success-color);
    }
    
    .practice-status-card.absent,
    .student-card.absent {
        border-left-color: var(--danger-color);
    }
    
    .practice-status-card.excused,
    .student-card.excused {
        border-left-color: var(--warning-color);
    }
    
    .practice-status-card.low-efficiency,
    .student-card.low-efficiency {
        border-left-color: #bb8009;
    }
    
    .practice-status-card.practicing-unscheduled,
    .student-card.practicing-unscheduled {
        border-left-color: #8250df;
    }
    
    .practice-status-card.weekend,
    .student-card.weekend {
        border-left-color: #6e7681;
        background: var(--gradient-card);
    }
    
    .practice-status-card.pending,
    .student-card.pending {
        border-left-color: var(--medium-gray);
    }
    
    .practice-status-card.not-practicing,
    .student-card.not-practicing {
        border-left-color: #8b949e;
    }
    
    /* 同步状态文本深色适配 */
    #syncStatusText {
        color: var(--text-color);
    }
    
    /* 同步日志区域深色适配 */
    #syncLogs {
        background: var(--background-color) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--border-color) !important;
        scrollbar-color: var(--medium-gray) var(--background-color);
    }
    
    /* 同步日志滚动条深色适配 */
    #syncLogs::-webkit-scrollbar {
        width: 8px;
        background: var(--background-color);
    }
    
    #syncLogs::-webkit-scrollbar-track {
        background: var(--card-hover-bg);
        border-radius: 4px;
    }
    
    #syncLogs::-webkit-scrollbar-thumb {
        background: var(--medium-gray);
        border-radius: 4px;
    }
    
    #syncLogs::-webkit-scrollbar-thumb:hover {
  background: var(--muted-light);
    }
    
    /* 同步状态卡片深色适配 */
    #syncStatus {
        background: var(--card-bg);
        color: var(--text-color);
        border-left-color: var(--success-color);
    }
    
    #syncStatus h4 {
        color: var(--text-color);
    }
    
    /* 操作按钮区域深色适配 */
    .action-buttons {
        background: var(--card-bg);
        border-top-color: var(--border-color);
    }
    
    /* 移动端操作按钮深色适配 */
    @media (max-width: 768px) {
        .action-buttons {
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }
    }
    
    /* 确保所有卡片标题在深色模式下正确显示 */
    .card h3,
    .card h4,
    .card h5 {
        color: var(--text-color);
    }
    
    /* 同步页面特定的文本颜色 */
    #syncTab .card p {
        color: var(--text-color);
    }
    
    /* 同步日志文本样式优化 */
    #syncLogs {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Consolas', 'Courier New', monospace !important;
        font-size: 12px !important;
        line-height: 1.4 !important;
        white-space: pre-line !important;
        word-wrap: break-word !important;
        background: var(--background-color) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: var(--radius-small);
        padding: 12px;
    }
    
    /* 同步日志中的时间戳和消息颜色区分 */
    #syncLogs {
        /* 使用CSS变量来确保文本颜色正确 */
        --log-timestamp-color: var(--medium-gray);
        --log-success-color: var(--success-color);
        --log-warning-color: var(--warning-color);
        --log-error-color: var(--danger-color);
        --log-info-color: var(--primary-color);
    }
}

  /* 统计卡片样式：使用语义变量以支持日/夜间主题切换 */
  .stats-grid-detailed .stat-item.present {
    background: var(--gradient-present);
  }

  .stats-grid-detailed .stat-item.absent {
    background: var(--gradient-absent);
  }

  .stats-grid-detailed .stat-item.excused {
    background: var(--gradient-excused);
  }

  .stats-grid-detailed .stat-item.rate {
    background: var(--gradient-rate);
  }
    
    /* 统计图标背景深色适配 */
    .stats-grid-detailed .stat-icon,
    .metric-icon {
  background: var(--overlay-faint-2);
    }
    
    /* 请假信息深色适配 */
    .excuse-info {
  background: var(--amber-faint);
        border-left-color: var(--warning-color);
    }
    
    .excuse-title {
        color: var(--warning-color);
    }
    
    .excuse-reason {
        color: #f2cc60;
    }
    
    .excuse-approver {
        color: #d29922;
    }
    
    /* 空状态深色适配 */
    .empty-state,
    .practice-empty-state,
    .table-empty-state {
        color: var(--medium-gray);
    }
    
    .empty-state-title,
    .practice-empty-state-title,
    .table-empty-state-title {
        color: var(--text-color);
    }
    
    /* 加载动画深色适配 */
    .spinner {
        border-color: var(--card-hover-bg);
        border-top-color: var(--primary-color);
    }
    
    .loading-text {
        color: var(--medium-gray);
    }
    
    /* 滚动条深色适配 */
    *::-webkit-scrollbar-track {
        background: var(--background-color);
    }
    
    *::-webkit-scrollbar-thumb {
        background-color: var(--card-hover-bg);
    }
    
    *::-webkit-scrollbar-thumb:hover {
        background-color: #484f58;
    }
    
    /* 表格滚动提示深色适配 */
    .data-table-container::after,
    .table-container::after {
  background: var(--modal-backdrop-strong);
        color: var(--text-color);
    }
    
    /* 详情标签深色适配 */
    .detail-label {
        color: var(--medium-gray);
    }
    
    .detail-value {
        color: var(--text-color);
    }
    
    /* 特殊内容处理深色适配 */
    .detail-item .detail-value[style*="color: #f39c12"] {
  background: var(--amber-faint) !important;
        color: #f2cc60 !important;
    }
    
    /* 同步日志深色适配 */
    #syncLogs {
        background: var(--background-color) !important;
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    /* 日期选择器深色适配 */
    .date-picker {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    
  /* 学生档案卡片：在深色模式变量中会被覆盖为深色，这里使用语义变量以避免强制深色 */
  .student-profile-card {
    background: var(--gradient-header);
  }
    
    /* 今日状态卡片深色适配 */
    .today-status-card.present { border-left-color: var(--success-color); }
    .today-status-card.absent { border-left-color: var(--danger-color); }
    .today-status-card.excused { border-left-color: var(--warning-color); }
    .today-status-card.low-efficiency { border-left-color: #bb8009; }
    .today-status-card.practicing-unscheduled { border-left-color: #8250df; }
    .today-status-card.weekend { border-left-color: #6e7681; }
    
    /* 时间段标签深色适配 */
    .time-slot-tag {
        color: var(--medium-gray);
    }
    
    .time-slot-tag:hover {
        color: var(--text-color);
    }
    
    .time-slot-tag.current {
        background: linear-gradient(135deg, #0c4a6e, #0369a1);
        color: #7dd3fc;
        border-color: #0284c7;
    }
    
    .time-slot-tag.current:hover {
        box-shadow: 0 2px 6px rgba(2, 132, 199, 0.4);
    }
    
    @keyframes pulse-glow {
        0%, 100% { 
            box-shadow: 0 1px 3px rgba(2, 132, 199, 0.3);
        }
        50% { 
            box-shadow: 0 2px 8px rgba(2, 132, 199, 0.5);
        }
    }
    
    /* 指标项深色适配 */
    .metric-item {
        background: var(--card-hover-bg);
        border: 1px solid var(--border-color);
    }
    
    .metric-label {
        color: var(--medium-gray);
    }
    
    .metric-value {
        color: var(--text-color);
    }
    
    .practice-label {
        color: var(--medium-gray);
    }
    
    .practice-value {
        color: var(--text-color);
    }
    
    .practice-value.current-practice {
        color: var(--primary-color);
    }
    
    .practice-value.total-practice {
        color: var(--primary-color);
    }
    
    /* 加载更多提示深色适配 */
    .load-more-hint {
        background: var(--card-hover-bg);
        color: var(--medium-gray);
        border-top-color: var(--border-color);
    }
    
  .load-more-hint:hover {
    background: var(--dark-gray);
  }
    
    .load-more-hint.loading {
        color: var(--primary-color);
    }
    
    /* 考勤历史深色适配 */
    .attendance-history {
        border-top-color: var(--border-color);
    }
    
    .history-title {
        color: var(--medium-gray);
    }
    
    /* 卡片标题深色适配 */
    .card-title {
        color: var(--text-color);
    }
    
    .title-subtitle {
        color: var(--medium-gray);
    }
    
    /* 状态标题深色适配 */
    .status-title {
        color: var(--text-color);
    }
    
    /* 学生姓名深色适配 */
    .student-name,
    .student-name-compact,
    .profile-name {
        color: var(--text-color);
    }
    
    /* 学生信息行深色适配 */
    .student-info-row {
        color: var(--medium-gray);
    }
    
    /* 日期单元格深色适配 */
    .date-cell {
        color: var(--text-color);
    }
    
    /* 时长单元格深色适配 */
    .duration-cell {
        color: var(--medium-gray);
    }
    
    .total-duration-cell {
        color: var(--primary-color);
    }
    
    /* 今日行深色适配 */
    .today-row {
  background: var(--accent-faint);
    }
    
    /* 个人资料元数据深色适配 */
  .profile-meta {
    color: var(--overlay-faint-text);
  }
    
    /* 统计项内容深色适配 */
    .stats-grid-detailed .stat-number,
    .stats-grid-detailed .stat-label {
        color: var(--text-color);
    }
    
    /* 统计卡片数字颜色深色适配 */
    .stat-card.present .stat-number { color: var(--success-color); }
    .stat-card.absent .stat-number { color: var(--danger-color); }
    .stat-card.excused .stat-number { color: var(--warning-color); }
    .stat-card.unscheduled .stat-number { color: #a475f9; }
    .stat-card.weekend .stat-number { color: #8b949e; }
    .stat-card.pending .stat-number { color: var(--medium-gray); }
    
    /* 统计标签和描述深色适配 */
    .stat-label {
        color: var(--medium-gray);
    }
    
  .stat-description {
    color: var(--text-muted);
  }

/* ===== 41. 最终优化和兼容性修复 ===== */

/* 确保所有文本选择颜色一致 */
  ::selection {
  background: var(--accent-faint-2);
    color: inherit;
  }
    
  ::-moz-selection {
  background: var(--accent-faint-2);
    color: inherit;
  }

/* 深色模式下的文本选择 */
@media (prefers-color-scheme: dark) {
    ::selection {
  background: var(--accent-faint-3);
        color: inherit;
    }
    
    ::-moz-selection {
  background: var(--accent-faint-3);
        color: inherit;
    }
}

/* 确保所有交互元素都有适当的焦点样式 */
*:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* 移除默认焦点样式 */
*:focus:not(:focus-visible) {
    outline: none;
}

/* 确保在所有设备上都有良好的触摸体验 */
@media (pointer: coarse) {
    .student-card,
    .practice-status-card,
    .btn,
    .nav-tab,
    .quick-filter-tag,
    .history-day {
        min-height: 48px;
    }
    
    .lang-btn,
    .connection-status {
        min-height: 40px;
    }
}

/* 确保在高分辨率屏幕上的清晰度 */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .practice-indicator {
        border: 0.5px solid transparent;
    }
    
    .history-day {
        border-width: 1.5px;
    }
    
    .card {
        border-left-width: 3px;
    }
}

/* 最终的响应式断点优化 */
@media (min-width: 320px) and (max-width: 374px) {
    .container {
        padding: 8px;
    }
    
    .student-grid {
        gap: 8px;
    }
    
    .card {
        padding: 12px;
    }
}

@media (min-width: 375px) and (max-width: 413px) {
    .container {
        padding: 10px;
    }
    
    .student-grid {
        gap: 10px;
    }
}

@media (min-width: 414px) and (max-width: 767px) {
    .container {
        padding: 12px;
    }
    
    .student-grid {
        gap: 12px;
    }
}

/* 确保在所有浏览器中都有一致的渲染 */
* {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}

/* 最后的性能优化 */
.student-card,
.practice-status-card,
.stat-card {
    will-change: transform;
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
}

/* 确保动画在所有设备上都流畅 */
@media (max-width: 768px) {
    .student-card,
    .practice-status-card,
    .stat-card {
        transition: transform 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    
    .btn {
        transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    
    .nav-tab {
        transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
}

/* 确保在所有设备上都有适当的间距 */
.container > *:last-child {
    margin-bottom: 0;
}

/* 最终的可访问性确保 */
@media (prefers-reduced-motion: reduce) {
    .student-card,
    .practice-status-card,
    .stat-card,
    .btn,
    .nav-tab,
    .quick-filter-tag {
        transition: none;
    }
    
    .modal-content {
        transition: none;
        animation: none;
    }
    
    .modal {
        transition: none;
    }
}

/* 确保在所有浏览器中都正确显示 */
@supports not (display: grid) {
    .student-grid {
        display: flex;
        flex-wrap: wrap;
    }
    
    .student-card,
    .practice-status-card {
        flex: 1 1 280px;
        margin: 10px;
    }
    
    .stats-grid {
        display: flex;
        flex-wrap: wrap;
    }
    
    .stat-card {
        flex: 1 1 200px;
        margin: 8px;
    }
}

/* 最终确保所有元素都有正确的盒模型 */
*,
*::before,
*::after {
    box-sizing: border-box;
}

/* 确保在所有设备上都有适当的字体大小 */
html {
    font-size: 16px;
}

@media (max-width: 320px) {
    html {
        font-size: 15px;
    }
}

@media (min-width: 1200px) {
    html {
        font-size: 17px;
    }
}

/* 最终的打印优化 */
@media print {
    * {
        color: black !important;
        background: white !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }
    
    .student-grid {
        display: block !important;
    }
    
    .student-card,
    .practice-status-card {
        display: block !important;
        width: 100% !important;
        margin: 10px 0 !important;
        page-break-inside: avoid;
    }
    
    .modal,
    .language-switcher,
    .connection-status {
        display: none !important;
    }
}
/* ===== 模态框下滑手势支持 ===== */
.modal-content {
    /* 现有样式保持不变 */
    touch-action: pan-y; /* 🔥 允许垂直滑动 */
    user-select: none; /* 🔥 防止文本选择干扰手势 */
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

/* 🔥 拖拽状态下的视觉反馈 */
.modal-content.dragging {
    transition: none !important;
    /* 🔥 硬件加速优化下拉手势性能 */
    will-change: transform;
    transform-origin: center top;
}

.modal.dragging {
    transition: none !important;
    /* 🔥 背景透明度变化的硬件加速 */
    will-change: background-color;
}

/* 🔥 iOS风格下拉手势优化 */
@media (max-width: 768px) {
    .modal-content {
        /* 🔥 确保触摸事件正确响应 */
        touch-action: pan-y;
        /* 🔥 优化下拉手势的触摸响应 */
        -webkit-overflow-scrolling: touch;
    }
}

/* 🔥 移动端模态框头部增加拖拽指示器 */
@media (max-width: 768px) {
    .modal-content::before {
        content: '';
        display: block; /* 🔥 显示iOS风格拖拽指示器 */
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 36px;
        height: 4px;
        background: var(--text-secondary, #999);
        border-radius: 2px;
        opacity: 0.6;
        z-index: 1000;
    }
    
    .modal-header {
        padding-top: 20px; /* 🔥 为拖拽指示器留出空间 */
    }
}

/* 🔥 深色模式下的拖拽指示器 */
@media (prefers-color-scheme: dark) and (max-width: 768px) {
    .modal-content::before {
        background: var(--text-secondary, #666);
        opacity: 0.8;
    }
}


/* ===============================================
   样式文件结束
   青岛梅纽因音乐学校练琴跟踪系统
   版本: 4.0 完整优化版
   =============================================== */

/* ===== 强制日间模式：覆盖潜在晚声明的深色规则 ===== */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  /* 学生详情头部应使用浅色卡片背景 */
  .student-header {
    background: var(--gradient-header) !important;
    color: var(--text-color) !important;
  }

  /* 考勤/统计卡片使用浅色变量 */
  .stats-grid-detailed .stat-item.present,
  .stats-grid-detailed .stat-item.absent,
  .stats-grid-detailed .stat-item.excused,
  .stats-grid-detailed .stat-item.rate {
    background: var(--gradient-card) !important;
    color: var(--text-color) !important;
  }

  /* 状态徽章与学生状态在日间应使用浅色变量 */
  .status-badge,
  .student-status,
  .student-status-compact {
    background: var(--card-bg) !important;
    color: var(--text-color) !important;
    border-color: var(--border-color) !important;
  }
  
  /* 个人资料元数据（学院/班级）在日间应更显眼 */
  .profile-meta {
    color: var(--text-secondary) !important;
    opacity: 1 !important;
  }
}

</style>
<style id="performance-mode-style">
/* ================= 性能模式覆盖（仅在 html.performance-mode 下生效） ================= */
html.performance-mode {
  --shadow: 0 1px 2px rgba(0,0,0,0.08) !important;
  --shadow-hover: 0 2px 4px rgba(0,0,0,0.14) !important;
}
html.performance-mode .modal.show { backdrop-filter: none !important; }
html.performance-mode .modal-content { box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important; }
html.performance-mode [data-anim="loop"],
html.performance-mode .pulse,
html.performance-mode .glow { animation-play-state: paused !important; }
html.performance-mode .anim-paused { animation-play-state: paused !important; }
html.performance-mode * { transition-duration: .18s !important; }
/* 减少复杂阴影 */
html.performance-mode .card, 
html.performance-mode .panel, 
html.performance-mode .student-status,
html.performance-mode .status-badge { box-shadow: var(--shadow) !important; }
/* 移除不必要 will-change */
html.performance-mode * { will-change: auto !important; }
/* 关闭过冲弹性动画改为简单淡入 */
html.performance-mode .modal.show .modal-content { animation: fadeInUpSimple .22s ease-out forwards !important; }
html.performance-mode .modal.hiding .modal-content { animation: fadeOutDownSimple .15s ease-in forwards !important; }
@keyframes fadeInUpSimple {from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
@keyframes fadeOutDownSimple {from{opacity:1;transform:translateY(0);}to{opacity:0;transform:translateY(10px);} }
/* 表格闪烁优化 */
html.performance-mode table td, html.performance-mode table th { backface-visibility:hidden; }
/* 降低频繁更新数字的绘制权重 */
html.performance-mode .dynamic-number { will-change: contents !important; }
</style>

<style>
/* 最后覆盖：确保统计汇总容器在日间模式下显示指定背景（只影响容器背景与形状） */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  /* 深一些的浅色变体以增强可读性 */
  .stats-grid-detailed .stat-item.present { background: linear-gradient(135deg,#dff5e6,#bff0cf) !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.absent { background: linear-gradient(135deg,#ffecec,#ffcfcf) !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.low-efficiency { background: linear-gradient(135deg,#fff4d9,#ffe3a8) !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.excused { background: linear-gradient(135deg,#fff6e6,#ffe4be) !important; border-radius: 12px !important; }
  .stats-grid-detailed .stat-item.pending { background: #eef0f3 !important; border-radius: 12px !important; }

  /* 隐藏待考勤的数量，仅在统计汇总中隐藏 .stat-number */
  .stats-grid-detailed .stat-item.pending .stat-number { display: none !important; }
}

/* 日间模式专用：确保当前时间段标签使用浅色高亮，优先覆盖深色样式 */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  .time-slot-tag.current {
    background: linear-gradient(135deg, #d1ecf1, #bee5eb) !important;
    color: #0c5460 !important;
    border: 1px solid #b8daff !important;
    box-shadow: 0 1px 3px rgba(12, 84, 96, 0.2) !important;
  }
  .time-slot-tag.current:hover {
    box-shadow: 0 2px 6px rgba(12,84,96,0.3) !important;
    transform: translateY(-1px) !important;
  }
}

/* 进一步细化：确保数字居中、文本规整、说明省略溢出 */
.stats-grid-detailed .stat-item {
  justify-content: center;
}
.stats-grid-detailed .stat-left {
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 0;
}
.stats-grid-detailed .stat-content {
  min-width: 0;
  text-align: center;
}
.stats-grid-detailed .stat-label,
.stats-grid-detailed .stat-desc {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.stats-grid-detailed .stat-number {
  text-align: center;
  width: 100%;
}

</style>
</head>
<body>
<!-- ===== 页面主体（与你原始版本一致，这里保持不动） ===== -->
<div class="container">
  <div class="language-switcher">
    <button class="lang-btn" onclick="switchLanguage('zh')" data-lang="zh">中文</button>
    <button class="lang-btn" onclick="switchLanguage('en')" data-lang="en">EN</button>
  </div>
  <div id="connectionStatus" class="connection-status offline">
    <span data-i18n="status.offline">🔴 离线模式</span>
  </div>
  <div class="header">
    <h1><span data-i18n="header.title">🎼 青岛耶胡迪梅纽因学校</span></h1>
    <div class="subtitle" data-i18n="header.subtitle">实时练琴跟踪系统</div>
  </div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('dashboard')"><span data-i18n="nav.dashboard">📊 考勤概览</span></button>
    <button class="nav-tab" onclick="switchTab('students')"><span data-i18n="nav.students">👥 学生详情</span></button>
  <button class="nav-tab" onclick="switchTab('leaderboard')"><span data-i18n="nav.leaderboard">🏆 442排行榜</span></button>
    <button class="nav-tab" onclick="switchTab('sync')"><span data-i18n="nav.sync">🔄 数据同步</span></button>
  </div>

  <div id="dashboardTab" class="tab-content">
    <div class="stats-grid">
      <div class="stat-card present">
        <div class="stat-number" id="presentCount">0</div>
        <div class="stat-label" data-i18n="stats.present">出勤</div>
        <div class="stat-description" data-i18n="stats.present.desc">当前在琴房</div>
      </div>
      <div class="stat-card absent">
        <div class="stat-number" id="absentCount">0</div>
        <div class="stat-label" data-i18n="stats.absent">缺勤</div>
        <div class="stat-description" data-i18n="stats.absent.desc">应到未到</div>
      </div>
      <div class="stat-card excused">
        <div class="stat-number" id="excusedCount">0</div>
        <div class="stat-label" data-i18n="stats.excused">请假</div>
        <div class="stat-description" data-i18n="stats.excused.desc">已批准请假</div>
      </div>
      <div class="stat-card self-practice">
        <div class="stat-number" id="pendingCount">0</div>
        <div class="stat-label" data-i18n="stats.self_practice">自主练琴</div>
        <div class="stat-description" data-i18n="stats.self_practice.desc">非规定时间段练琴</div>
      </div>
    </div>
    <div class="card" id="excuseInfoPanel" style="display:none;">
      <h3 data-i18n="excuse.title">📝 今日请假信息</h3>
      <div id="excuseInfoContainer"></div>
    </div>
    <div class="card">
      <h3 data-i18n="practice.title">🎹 实时练琴状态</h3>
      <div class="date-picker">
        <span class="current-time-display">
          <span data-i18n="practice.current_time">当前时间：</span>
          <span id="currentTime"></span>
        </span>
      </div>
      <div id="practiceStatusContainer"></div>
    </div>
  </div>

  <div id="studentsTab" class="tab-content" style="display:none;">
    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.major">专业筛选</label>
          <select id="majorFilter" class="filter-select" onchange="filterStudents()">
            <option value="" data-i18n="filter.all_majors">所有专业</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.grade">年级筛选</label>
          <select id="gradeFilter" class="filter-select" onchange="filterStudents()">
            <option value="" data-i18n="filter.all_grades">所有年级</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.status">考勤状态</label>
          <select id="statusFilter" class="filter-select" onchange="filterStudents()">
            <option value="" data-i18n="filter.all_status">所有状态</option>
            <option value="present" data-i18n="status.present">出勤</option>
            <option value="absent" data-i18n="status.absent">缺勤</option>
            <option value="excused" data-i18n="status.excused">请假</option>
            <option value="practicing-unscheduled" data-i18n="status.practicing_unscheduled">自主练琴</option>
            <option value="not-practicing" data-i18n="status.not_practicing">未练琴</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" data-i18n="filter.search">搜索学生</label>
          <input type="text" id="studentSearch" class="filter-input" data-i18n-placeholder="filter.search_placeholder" placeholder="输入学生姓名..." oninput="filterStudents()">
        </div>
      </div>
    </div>
    <div id="studentList" class="student-grid"></div>
  </div>

  <!-- 排行榜 Tab（替换原历史报告） -->
  <div id="leaderboardTab" class="tab-content" style="display:none;">
    <div class="leaderboard-container" id="leaderboard-section">
      <div class="leaderboard-title-container">
        <h3 class="leaderboard-title">🏆 442练琴排行榜</h3>
        <div class="leaderboard-subtitle">442测评体系 · 革命性练琴质量评估框架</div>
        <button onclick="showHistoryLeaderboard()" class="leaderboard-history-btn" title="查看历史排行榜">📅</button>
      </div>
      
      <!-- 排行榜按钮区域（去除刷新按钮） -->
      <div class="leaderboard-action-bar">
  <div class="lb-left">
    <div id="leaderboard-refresh-status" class="leaderboard-status minimal" data-mode="idle">尚未计算</div>
  </div>
        <div class="lb-center">
          <button onclick="showLeaderboardDetail()" class="leaderboard-btn lb-info" title="查看442测评体系规则">📊 442测评体系规则说明</button>
        </div>
        <div class="lb-right">
          <button class="leaderboard-btn lb-expand" id="lb-toggle-more" style="display:none;" data-i18n="leaderboard.expand">展开全部</button>
        </div>
      </div>
      
      <div class="table-responsive" style="overflow-x:auto;">
        <table class="leaderboard-table" id="leaderboard-table">
          <thead>
            <tr>
              <th style="width:80px;">排名</th>
              <th data-i18n="student.name">姓名</th>
              <th data-i18n="student.grade">年级</th>
              <th data-i18n="student.major">专业</th>
              <th style="width:120px;">总分</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="syncTab" class="tab-content" style="display:none;">
    <div class="card">
      <h3 data-i18n="sync.title">🔄 数据同步管理</h3>
      <div class="card success" id="syncStatus">
        <h4 data-i18n="sync.status">同步状态</h4>
        <p id="syncStatusText" data-i18n="sync.checking">正在检查连接状态...</p>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="forceSync()"><span>🔄</span><span data-i18n="btn.force_sync">强制同步</span></button>
          <button class="btn btn-warning" onclick="clearLocalCache()"><span>🗑️</span><span data-i18n="btn.clear_cache">清除缓存</span></button>
        </div>
      </div>
      <div class="card">
        <h4 data-i18n="sync.logs">📋 同步日志</h4>
        <div id="syncLogs" style="max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px;white-space:pre-line;"></div>
      </div>
    </div>
  </div>
</div>

<!-- 学生详情模态 -->
<div id="studentDetailModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="studentDetailTitle" data-i18n="student.detail.title">学生详情</h3>
      <button class="modal-close" onclick="closeModal('studentDetailModal')">&times;</button>
    </div>
    <div id="studentDetailContent"></div>
  </div>
</div>

<!-- 考勤详情模态（动态创建时也会使用这个ID） -->
<div id="attendanceDetailModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:800px;"></div>
</div>

<script>
// ================== 练琴质量排行榜核心逻辑（新增） ==================
// 依赖：studentDatabase, studentTimeSlots, 已有的获取学生实际练琴区间/统计函数（需复用）

// 全局禁用（新增位置，确保位于首次调用前）
if(typeof window!=='undefined' && window.ALLOW_SUMMARY_RECONSTRUCT===undefined){
  window.ALLOW_SUMMARY_RECONSTRUCT=false;
}

let leaderboardState = {
  lastCompute: 0,
  raw: [],
  expanded: false,
  pending: false
};

// === 每日历史排行榜快照保障机制 ===
(function setupDailySnapshotGuard(){
  const SNAPSHOT_GUARD_FLAG_KEY = 'leaderboard_history_guard_saved_date';
  function todayKey(){
    return formatDate(new Date()).replace(/\//g,'-');
  }
  function hasTodaySnapshot(){
    try {
      const snapshots = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      return !!snapshots[todayKey()];
    } catch { return false; }
  }
  function markGuard(){
    localStorage.setItem(SNAPSHOT_GUARD_FLAG_KEY, todayKey());
  }
  function guardShouldRun(){
    return localStorage.getItem(SNAPSHOT_GUARD_FLAG_KEY)!==todayKey();
  }
  function attemptGuardSave(reason){
    const now = new Date();
    const freezeMin = getTodayFreezeMinutes(now);
    const curMin = now.getHours()*60 + now.getMinutes();
    const pastCutoff = curMin >= (freezeMin + 1); // 冻结后+1分钟
    if(!pastCutoff) return; // 未到时间
    if(hasTodaySnapshot()){ markGuard(); return; }
    if(!guardShouldRun()) return;
    // 需要当前的 rows 数据，如果尚未计算则计算一次
    if(!leaderboardState.raw || !leaderboardState.raw.length){
      console.log('[快照保障] 触发重算以保存快照');
      computeLeaderboard();
    } else {
      console.log('[快照保障] 直接保存快照 (原因:'+reason+')');
      saveLeaderboardSnapshot(leaderboardState.raw);
    }
    if(hasTodaySnapshot()){
      console.log('[快照保障] 成功补保存今日快照');
      markGuard();
    }
  }
  // 每分钟检查一次
  setInterval(()=>attemptGuardSave('interval'), 60*1000);
  // 页面重新可见时检查
  document.addEventListener('visibilitychange',()=>{ if(!document.hidden) attemptGuardSave('visibility'); });
  // 页面加载完成后延迟 10 秒执行一次（防止初始未过21:30误触发）
  setTimeout(()=>attemptGuardSave('initial'), 10*1000);
})();

function getTodayWeekdayKey(){
  const wd = new Date().getDay();
  const map = {1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  return map[wd]||null;
}

// === 新增：排行榜活动日期逻辑（早上8点前显示前一天 ===）
let __activeLeaderboardDate = null; // YYYY-MM-DD (基于 serverNowMs)
function getServerDateParts(d){return {y:d.getFullYear(),m:d.getMonth(),day:d.getDate()};}
function dateToKey(y,m,day){return `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;}
function getActiveLeaderboardDate(){
  const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
  const hour = now.getHours();
  const {y,m,day} = getServerDateParts(now);
  if(hour < 8){
    // 前一天
    const prev = new Date(now.getTime()-24*60*60*1000);
    const {y:py,m:pm,day:pd} = getServerDateParts(prev);
    return dateToKey(py,pm,pd);
  }
  return dateToKey(y,m,day);
}
function ensureActiveLeaderboardDate(){
  const key = getActiveLeaderboardDate();
  if(__activeLeaderboardDate!==key){
    __activeLeaderboardDate = key;
    console.log('[Leaderboard] 活动日期切换为', key);
  }
  return __activeLeaderboardDate;
}

// 早晨校验：若 <08:00 ，对昨天快照进行一致性检查
(function morningSnapshotFix(){
  const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
  if(now.getHours()>=8) return; // 仅在早上8点前
  try {
    const todayKey = formatDate(now).replace(/\//g,'-');
    const yesterday = new Date(now.getTime()-24*60*60*1000);
    const yKey = formatDate(yesterday).replace(/\//g,'-');
    const snapshots = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
    let snap = snapshots[yKey];
    const missing = !snap;
    if(missing){
      console.warn('[晨间修复] 昨日快照缺失，尝试重建');
    }
    // 重新计算昨天 (最简：复用今日计算逻辑假设数据仍可还原) —— 标记临时 override
    window.__computeDateOverride = yKey; // YYYY-MM-DD
    window.__skipSnapshotOnce = true; // 计算时不自动保存普通快照
    computeLeaderboard();
    delete window.__computeDateOverride;
    const rows = (leaderboardState.raw||[]);
  if(!rows.length){ console.log('[晨间修复] 重新计算无数据，跳过'); return; }
    // 生成 hash 对比
    function hashString(str){ let h=5381,i=str.length; while(i) h=(h*33)^str.charCodeAt(--i); return (h>>>0).toString(16); }
    const compact = rows.slice(0,20).map(r=>({n:r.name,t:r.total,d1:r.dim1.score,d2:r.dim2.score,d3:r.dim3.score}));
    const newHash = hashString(JSON.stringify(compact));
  const oldHash = snap && snap.meta && snap.meta.rowsHash;
  if(!missing && oldHash && oldHash === newHash){ console.log('[晨间修复] 昨日快照一致，无需覆盖'); return; }
  console.warn(`[晨间修复] ${missing? '缺失重建':'哈希不一致覆盖'}`);
  window.__snapshotSourceOverride = missing? 'morning-rebuild':'final-morning-fix';
    saveLeaderboardSnapshot(rows); // 使用昨天 dateKey 覆盖 => 需临时修改保存逻辑的日期键? 简化: 直接手动写入
    // 手动写入指定键（覆盖 save 默认今天）
    try {
      const all = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      const nowMs = (window.serverNowMs?window.serverNowMs():Date.now());
      all[yKey] = {
        date: yKey,
        timestamp: nowMs,
        data: rows.slice(0,20),
        totalCount: rows.length,
        isTestData: false,
        meta: {version:1,source:'final-morning-fix',computedAt:new Date(nowMs).toISOString(),offsetMs:window.__serverTimeOffsetMs||0,rowsHash:newHash}
      };
      localStorage.setItem('leaderboard_history', JSON.stringify(all));
      console.log('[晨间修复] 已覆盖昨日快照');
    } catch(e){ console.error('[晨间修复] 覆盖失败', e); }
  } catch(e){ console.error('[晨间修复] 错误', e); }
})();

// 获取某学生今天的标准练琴段数组 [{startMinute,endMinute}]
function getStudentTodaySlots(name){
  const key = getTodayWeekdayKey();
  if(!key||!studentTimeSlots[name]||!Array.isArray(studentTimeSlots[name][key])) {
    console.debug(`[getStudentTodaySlots] ${name}: no slots for ${key}`);
    return [];
  }
  const slots = studentTimeSlots[name][key].map(s=>({
    start: s.start||s.startTime||s.s||s.begin,
    end: s.end||s.endTime||s.e||s.finish,
    startMinute: toMinute(s.start||s.startTime||s.s||s.begin),
    endMinute: toMinute(s.end||s.endTime||s.e||s.finish)
  })).filter(x=>Number.isFinite(x.startMinute)&&Number.isFinite(x.endMinute)&&x.endMinute>x.startMinute);
  console.debug(`[getStudentTodaySlots] ${name}: ${slots.length} slots for ${key}:`, slots);
  return slots;
}

function toMinute(str){
  if(typeof str==='number') return str;
  if(!str||typeof str!=='string') return NaN;
  const m = str.trim();
  const mt = m.match(/^(\d{1,2}):(\d{1,2})$/);
  if(!mt) return NaN;return parseInt(mt[1])*60+parseInt(mt[2]);
}

// 维度1：段完成率（覆盖 >=60% 视为完成）
function computeDimension1(slots, practiceIntervals, dateStr){
  if(!slots.length) return {completed:0,total:0,rate:0,score:0};
  let completed = 0;
  
  for(const slot of slots){
    const slotStartMs = new Date(`${dateStr}T${slot.start}:00`).getTime();
    const slotEndMs = new Date(`${dateStr}T${slot.end}:00`).getTime();
    const slotDurSec = (slotEndMs - slotStartMs) / 1000;
    
    // practiceIntervals 已经是毫秒时间戳格式，直接使用
    const overlapSec = calcOverlapSeconds(practiceIntervals, slotStartMs, slotEndMs);
    const coverage = slotDurSec > 0 ? (overlapSec / slotDurSec) : 0;
    
    console.debug(`[dim1] ${slot.start}-${slot.end}: ${overlapSec}s/${slotDurSec}s = ${(coverage*100).toFixed(1)}%`);
    
    if(coverage >= 0.6) completed++;
  }
  const rate = completed / slots.length;
  const score = +(rate * 40).toFixed(2);
  return {completed,total:slots.length,rate,score};
}

// 维度2：段内时长比（新规则：前15分钟基础分1.65分+剩余按实际时长百分比）
function computeDimension2(slots, practiceIntervals, dateStr){
  if(!slots.length) return {actual:0,required:0,ratio:0,score:0,details:[]};
  
  let totalRequired = 0; // 总时间段长度（秒）
  let totalPractice = 0; // 总练习时长（秒）
  let totalExtraPractice = 0; // 超过15分钟的练习时长（秒）
  let totalExtraRequired = 0; // 超过15分钟的时间段长度（秒）
  let slotsWithPractice = 0; // 有练琴的时间段数量
  const details = [];
  
  // 第一遍：计算每个时间段的练习时长和总计
  for(const slot of slots){
    const slotStartMs = new Date(`${dateStr}T${slot.start}:00`).getTime();
    const slotEndMs = new Date(`${dateStr}T${slot.end}:00`).getTime();
    const slotDurSec = (slotEndMs - slotStartMs) / 1000;
    if(slotDurSec <= 0) continue;
    
    totalRequired += slotDurSec;
    const overlapSec = calcOverlapSeconds(practiceIntervals, slotStartMs, slotEndMs);
    
    if(overlapSec > 0){
      slotsWithPractice++;
      totalPractice += overlapSec;
      
      // 计算超过15分钟的部分
      if(slotDurSec > 15 * 60) {
        totalExtraRequired += slotDurSec - 15 * 60;
        if(overlapSec > 15 * 60) {
          totalExtraPractice += overlapSec - 15 * 60;
        }
      }
      
      details.push({slot, duration: slotDurSec, practice: overlapSec});
    } else {
      // 没有练琴的时间段，但仍计入超过15分钟的要求时长
      if(slotDurSec > 15 * 60) {
        totalExtraRequired += slotDurSec - 15 * 60;
      }
      details.push({slot, duration: slotDurSec, practice: 0});
    }
    console.debug(`[dim2] ${slot.start}-${slot.end}: practice=${overlapSec}s, slotDur=${slotDurSec}s`);
  }
  
  // 计算得分：基础分(每个有练琴的段前15分钟1.65分) + 剩余分数按超过15分钟的练习时长百分比分配
  const baseScorePerSlot = 40 * 0.04125; // 1.65分 = 40 * 0.04125
  const baseScore = slotsWithPractice * baseScorePerSlot;
  const maxBaseScore = slots.length * baseScorePerSlot; // 所有段都有练琴时的最大基础分
  const remainingScore = 40 - maxBaseScore; // 剩余可分配分数
  const extraPracticeRatio = totalExtraRequired > 0 ? Math.min(totalExtraPractice / totalExtraRequired, 1) : 0;
  const practiceScore = remainingScore * extraPracticeRatio;
  
  const totalScore = Math.min(baseScore + practiceScore, 40);
  const overallRatio = totalRequired > 0 ? totalScore / 40 : 0;
  
  console.debug(`[dim2] 有练琴段数:${slotsWithPractice}/${slots.length}, 基础分:${baseScore.toFixed(2)}, 超时练习分:${practiceScore.toFixed(2)}, 总分:${totalScore.toFixed(2)}`);
  console.debug(`[dim2] 超时练习时长:${Math.floor(totalExtraPractice/60)}min/${Math.floor(totalExtraRequired/60)}min, 超时比例:${(extraPracticeRatio*100).toFixed(1)}%`);
  
  return {
    actual: Math.floor(totalPractice/60),
    required: Math.floor(totalRequired/60), 
    ratio: overallRatio,
    score: +totalScore.toFixed(2),
    details
  };
}

// 维度3：段外分层得分（过滤晚间）
function computeDimension3(outsideMinutes){
  // outsideMinutes 已过滤晚间 & 非负
  const m = Math.max(0, outsideMinutes);
  // 分段分钟数（每段最多60分钟）
  const h1 = Math.min(m,60);                 // 第1小时 0-60
  const h2 = Math.min(Math.max(m-60,0),60);   // 第2小时 60-120
  const h3 = Math.min(Math.max(m-120,0),60);  // 第3小时 120-180
  const h4 = Math.min(Math.max(m-180,0),60);  // 第4小时 180-240
  const remain = Math.max(m-240,0);           // 第5小时及以上（可能部分小时）

  // 规则：
  // 第1小时：0-20 分线性
  // 第2小时：0-15 分线性
  // 第3小时：0-10 分线性
  // 第4小时：0-8  分线性
  // 第5小时及以上：每满60分钟 +5 分，未满按比例 (分钟/60*5)
  const p1 = (h1/60)*20;
  const p2 = (h2/60)*15;
  const p3 = (h3/60)*10;
  const p4 = (h4/60)*8;
  const p5 = (remain/60)*5; // 线性延伸
  const raw = p1+p2+p3+p4+p5;
  const capped = Math.min(raw,60); // 上限60分
  let score = +(capped*0.33).toFixed(2); // 60 -> 19.8
  if(score >= 19.8) score = 20.0; // 近似满分修正
  return {outsideMinutes:m, rawPoints:raw, capped, score};
}

// 计算 slot 内覆盖分钟（合并 practiceIntervals 后计算交集）
function coveredMinutesInSlot(slot, intervals){
  if(!intervals||!intervals.length) return 0;
  let total=0;
  for(const it of intervals){
    const s = Math.max(it.start, slot.startMinute);
    const e = Math.min(it.end, slot.endMinute);
    if(e>s) total += (e-s);
  }
  return total;
}

// 合并 & 规范 interval 数组，期望元素: {start,end} (分钟)
function mergeIntervals(intervals){
  if(!intervals||!intervals.length) return [];
  const arr = intervals.filter(i=>Number.isFinite(i.start)&&Number.isFinite(i.end)&&i.end>i.start)
    .sort((a,b)=>a.start-b.start);
  const res=[];let cur=arr[0];
  for(let i=1;i<arr.length;i++){
    const x=arr[i];
    if(x.start<=cur.end){
      cur.end = Math.max(cur.end,x.end);
    } else { res.push(cur); cur=x; }
  }
  res.push(cur);return res;
}

// 统一包装：获取今日练琴（段内/段外）分钟区间，用于排行榜
function getTodayPracticeForLeaderboard(name){
  const todayStr = new Date().toISOString().slice(0,10);
  let cleaned=[], outIntervals=[];
  try{
    const dio = computeDayInOut(name, todayStr);
    cleaned = dio.cleanIntervals||[];      // [{start,end} ms]
    outIntervals = dio.outIntervals||[];   // [{start,end,durationSec}]
  }catch(e){ console.warn('[leaderboard] computeDayInOut error', name, e); }
  // 注意：维度1和2需要原始ms时间戳用于calcOverlapSeconds，这里不转换
  return {cleanIntervals: cleaned, outIntervals, todayStr};
}

// 获取段外练琴分钟（过滤晚间）
function computeOutsideMinutes(practiceIntervals, slotIntervals){
  // 健壮性 & 早退
  if(!Array.isArray(practiceIntervals) || !practiceIntervals.length) return 0;
  slotIntervals = Array.isArray(slotIntervals)? slotIntervals: [];

  // 规范化 -> 合并
  const mergedPractice = mergeIntervals(practiceIntervals).filter(iv=>iv && Number.isFinite(iv.start) && Number.isFinite(iv.end));
  const mergedSlots = mergeIntervals(slotIntervals.map(s=>s?{start:s.startMinute,end:s.endMinute}:null).filter(s=>s && Number.isFinite(s.start) && Number.isFinite(s.end)));
  if(!mergedPractice.length) return 0;

  // 生成段外区间列表（而不是直接加分钟，便于后续裁剪 cutoff）
  const outsideSegments=[];
  for(const p of mergedPractice){
    if(!p) continue;
    let cursor=p.start;
    for(const sl of mergedSlots){
      if(!sl) continue;
      if(sl.end <= cursor) continue;      // slot 在当前指针左侧
      if(sl.start >= p.end) break;        // slot 在区间右侧 -> 结束
      if(sl.start > cursor){              // 存在一段 outside
        outsideSegments.push({start:cursor,end:Math.min(sl.start,p.end)});
      }
      cursor = Math.max(cursor, sl.end);
      if(cursor >= p.end) break;          // 区间已耗尽
    }
    if(cursor < p.end){
      outsideSegments.push({start:cursor,end:p.end});
    }
  }
  if(!outsideSegments.length) return 0;

  // 晚间截断：使用动态冻结时间
  const cutoff = getTodayFreezeMinutes(new Date());
  let minutes=0;
  for(const seg of outsideSegments){
    if(!seg) continue;
    if(seg.start >= cutoff) continue;
    const span = Math.max(0, Math.min(seg.end, cutoff) - seg.start);
    if(span>0) minutes += span;
  }
  return minutes;
}

function computeLeaderboard(){
  leaderboardState.dirty=false; // 进入计算清除脏标记
  if(leaderboardState.pending) return; // 防重入
  const startTs=Date.now();
  // 早晨活动日期逻辑
  ensureActiveLeaderboardDate();
  const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
  const isMorningPrev = now.getHours() < 8 && !window.__computeDateOverride; // 早上展示昨日
  // 若已过当日冻结时间并且不是晨间回看昨日且没有final锁定，则避免频繁重算（仅第一次算完后静止）
  const freezeMin = getTodayFreezeMinutes(now);
  const nowMin = now.getHours()*60 + now.getMinutes();
  const afterFreeze = nowMin >= freezeMin;
  if(afterFreeze && leaderboardState.raw && leaderboardState.raw.length && !window.__forcePostFreeze){
    // 已冻结且已有结果，直接渲染不再重新计算
    renderLeaderboard();
    return;
  }
  const key = getTodayWeekdayKey(); // 课表仍基于星期
  if(!key){ leaderboardState.raw=[]; renderLeaderboard(); return; }
  const students = flattenStudents();
  const rows=[];
  for(const stu of students){
    // 排除G12年级学生
    if(stu.grade === 'G12') {
      console.debug(`[leaderboard] 跳过G12学生: ${stu.name}`);
      continue;
    }
    
    const name = stu.name;
    const slots = getStudentTodaySlots(name);
    const {cleanIntervals, outIntervals, todayStr} = getTodayPracticeForLeaderboard(name);
    
    console.debug(`[leaderboard] ${name}: ${slots.length} slots, ${cleanIntervals.length} intervals`);
    console.debug(`[leaderboard] ${name} cleanIntervals:`, cleanIntervals);
    
    // 转换为分钟区间用于维度1和2计算（传入ms时间戳给calcOverlapSeconds）
    const practiceIntervals = cleanIntervals; // 保持ms格式
    
    const dim1 = computeDimension1(slots, practiceIntervals, todayStr);
    const dim2 = computeDimension2(slots, practiceIntervals, todayStr);
    
    // outside 直接用 outIntervals（再做晚间截断）
  const nowDate = new Date();
  const cutoff = getTodayFreezeMinutes(nowDate); // 动态冻结时间
    const dayStart = new Date(`${todayStr}T00:00:00`).getTime();
    let outsideMinutes = 0;
    outIntervals.forEach(iv=>{
      const startMin = Math.max(0, Math.floor((iv.start - dayStart) / 60000));
      const endMin = Math.max(0, Math.floor((iv.end - dayStart) / 60000));
  if(startMin < cutoff){
        outsideMinutes += Math.max(0, Math.min(endMin, cutoff) - startMin);
      }
    });
    
    const dim3 = computeDimension3(outsideMinutes);
    const total = +(dim1.score + dim2.score + dim3.score).toFixed(2);
    console.debug(`[leaderboard] ${name}: dim1=${dim1.score}, dim2=${dim2.score}, dim3=${dim3.score}, total=${total}`);
    rows.push({name,grade:stu.grade||'',major:stu.major||'',dim1,dim2,dim3,total});
  }
  rows.sort((a,b)=>{
    if(b.total!==a.total) return b.total-a.total;
    if(b.dim1.score!==a.dim1.score) return b.dim1.score-a.dim1.score;
    if(b.dim2.score!==a.dim2.score) return b.dim2.score-a.dim2.score;
    if(b.dim3.score!==a.dim3.score) return b.dim3.score-a.dim3.score;
    return a.name.localeCompare(b.name,'zh');
  });
  leaderboardState.raw = rows;
  leaderboardState.lastCompute = Date.now();
  
  // 保存历史快照（如果当日数据有效且过了21:30）-- 早晨查看昨日时不保存
  if(!isMorningPrev){
    if(!window.__skipSnapshotOnce){
      saveLeaderboardSnapshot(rows);
    } else {
      window.__skipSnapshotOnce=false;
    }
  }
  
  renderLeaderboard();
  const cost = Date.now()-startTs;
  if(window.setUpdateStatus) window.setUpdateStatus('updated', {rows: rows.length, cost});
}

function renderLeaderboard(){
  const section = document.getElementById('leaderboard-section');
  if(!section) return;
  const tbody = document.querySelector('.leaderboard-table tbody');
  if(!tbody){ section.style.display='none'; return; }
  const rows = leaderboardState.raw || [];
  section.style.display = rows.length? 'block':'none';
  // 已定格标识
  const statusEl = document.getElementById('leaderboard-refresh-status');
  if(statusEl){
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const freezeMin = getTodayFreezeMinutes(now);
    const curMin = now.getHours()*60+now.getMinutes();
    if(curMin >= freezeMin){
      const hh = String(Math.floor(freezeMin/60)).padStart(2,'0');
      const mm = String(freezeMin%60).padStart(2,'0');
      if(window.setUpdateStatus) window.setUpdateStatus('frozen', {time:`${hh}:${mm}`}); else statusEl.innerHTML = `🔒 已定格 (${hh}:${mm})`;
    }
  }
  const showAll = leaderboardState.expanded;
  const displayRows = showAll? rows: rows.slice(0,10);
  
  tbody.innerHTML = displayRows.map((r,i)=>{
    const rank = i+1;
    let rowClass = '';
    let rankClass = 'rank-cell';
    let scoreClass = 'score-cell';
    let nameClass = 'name-cell';
    
    // 排名样式
    if(rank === 1) {
      rowClass = 'top-1';
      rankClass += ' rank-1';
    } else if(rank === 2) {
      rowClass = 'top-2';
      rankClass += ' rank-2';
    } else if(rank === 3) {
      rowClass = 'top-3';
      rankClass += ' rank-3';
    }
    
    // 分数颜色
    const score = r.total;
    if(score >= 90) {
      scoreClass += ' score-excellent';
    } else if(score >= 80) {
      scoreClass += ' score-good';
    } else if(score >= 70) {
      scoreClass += ' score-average';
    } else {
      scoreClass += ' score-poor';
    }
    
    return `<tr class="${rowClass}">
      <td class="${rankClass}">${rank}</td>
      <td class="${nameClass}">${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.grade||'')}</td>
      <td>${escapeHtml(r.major||'')}</td>
      <td class="${scoreClass}">${r.total.toFixed(2)} <button class="mini-help-btn" onclick="showStudentLeaderboardDetail('${escapeHtml(r.name)}')" title="查看详细得分">?</button></td>
    </tr>`;
  }).join('');
  
  const toggleBtn = document.getElementById('lb-toggle-more');
  if(toggleBtn){
    if(rows.length>10){
      toggleBtn.style.display='inline-block';
      toggleBtn.textContent = showAll? '收起' : `展开全部 (${rows.length})`;
    } else toggleBtn.style.display='none';
  }
}

function escapeHtml(str){
  if(str==null) return '';
  return String(str).replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
}

// ===== 排行榜刷新统一状态显示 =====
// 状态类型: idle | detecting | updating | final | frozen
window.setUpdateStatus = function(type, extra){
  const el = document.getElementById('leaderboard-refresh-status');
  if(!el) return;
  el.dataset.mode = type;
  const map = {
    idle: '尚未计算',
    detecting: '检测到新数据，稍后自动刷新…',
    updating: '计算中…',
    updated: (extra && extra.rows!=null && extra.cost!=null) ? `已更新 (${extra.rows}人, ${extra.cost}ms)` : '已更新',
    frozen: (extra && extra.time) ? `🔒 已定格 (${extra.time})` : '🔒 已定格'
  };
  el.textContent = map[type] || type;
};

// 供数据监听/推送调用：标记有新数据并延迟触发重新计算
window.leaderboardMarkDataChanged = function(reason){
  // 若已冻结则不再提示检测（但仍可最终重新计算）
  try {
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const freezeMin = getTodayFreezeMinutes(now);
    const curMin = now.getHours()*60 + now.getMinutes();
    if(curMin >= freezeMin){
      // 冻结后忽略“检测到”提示，直接走即时重算（可能用于补写 final）
      computeLeaderboard();
      return;
    }
  } catch(e){ /* 忽略 */ }
  if(window.setUpdateStatus) window.setUpdateStatus('detecting');
  if(window.__leaderboardRecomputeScheduled) return; // 已排队
  window.__leaderboardRecomputeScheduled = true;
  setTimeout(()=>{
    window.__leaderboardRecomputeScheduled = false;
    window.setUpdateStatus && window.setUpdateStatus('updating');
    try { computeLeaderboard(); } catch(e){ console.error('[leaderboard] 自动刷新失败', e); }
  }, 1200); // 1.2s 合并抖动
};

// 显示整体排行榜规则详情
function showLeaderboardDetail(){
  const content = `
    <div style="margin:8px 0;padding:12px 16px;background:linear-gradient(135deg,rgba(255,193,7,0.15),rgba(255,165,0,0.1));border-left:4px solid #ffc107;border-radius:8px;">
      <p style="margin:0 0 6px;font-weight:700;color:#d4930f;font-size:15px;">🎯 442测评体系</p>
      <p style="margin:0 0 4px;font-weight:600;color:#e6940a;font-size:13px;">源于音乐标准音La(442Hz) · 和谐精准的练琴评估</p>
      <div style="margin:6px 0 0;font-size:12px;color:#b8860b;line-height:1.5;">
        <span style="display:inline-block;margin-right:12px;">🎼 <strong>音乐理念</strong>融合</span>
        <span style="display:inline-block;margin-right:12px;">⚖️ <strong>三权重</strong>平衡(4:4:2)</span>
        <span style="display:inline-block;">🎯 <strong>双层次</strong>评估</span>
      </div>
    </div>
    <table style="width:100%;margin:10px 0;table-layout:fixed;">
      <thead><tr><th style="width:15%;">维度</th><th style="width:15%;">权重</th><th style="width:70%;">计算规则</th></tr></thead>
      <tbody>
        <tr><td>维度1</td><td>40分</td><td>段完成率：单段覆盖率≥60%记为完成，完成率×40分</td></tr>
        <tr><td>维度2</td><td>40分</td><td>段内时长比：每个时间段练琴即得1.65分保底分，超过15分钟部分按实际练习时间比例加分</td></tr>
  <tr><td>维度3</td><td>20分</td><td>段外：第1~4小时最多加≈6.6 / 5.0 / 3.3 / 2.6 分；之后每多1小时≈+1.65 分（不足按比例），总上限20分。</td></tr>
      </tbody>
    </table>
    <div style="margin:12px 0;padding:10px;background:rgba(33,150,243,0.1);border-left:3px solid #2196f3;border-radius:4px;">
      <p style="margin:0;"><strong>📋 排序规则：</strong>总分 → 维度1 → 维度2 → 维度3 → 姓名</p>
    </div>
    <div style="margin:12px 0;padding:10px;background:rgba(76,175,80,0.1);border-left:3px solid #4caf50;border-radius:4px;">
  <p style="margin:0;font-weight:600;color:#2e7d32;"><strong>⏰ 截止时间：工作日18:00（周三18:30）/ 周末21:30</strong></p>
      <p style="margin:4px 0 0;font-size:12px;color:#666;">排行榜按此时间节点统计当日练琴数据，截止后自动保存历史排行</p>
    </div>
    <div style="margin:12px 0;padding:10px;background:rgba(255,87,34,0.1);border-left:3px solid #ff5722;border-radius:4px;">
      <p style="margin:0;font-weight:600;color:#d84315;"><strong>⚠️ 重要说明：G12年级学生不参与442测评体系排行榜排名</strong></p>
      <p style="margin:4px 0 0;font-size:12px;color:#666;">G12学生数据仅用于个人练琴记录，不纳入竞争性排名评估</p>
    </div>
  `;
  createCenterModal(content, '442测评体系规则说明');
}

// 显示单个学生的详细得分
function showStudentLeaderboardDetail(studentName){
  const student = leaderboardState.raw.find(r => r.name === studentName);
  if(!student){
    alert('未找到该学生的数据');
    return;
  }
  
  const content = `
    <h4>🎯 ${escapeHtml(studentName)} 详细得分</h4>
    <table style="width:100%;margin:10px 0;table-layout:fixed;">
      <thead><tr><th style="width:20%;">维度</th><th style="width:20%;">得分</th><th style="width:30%;">详细数据</th><th style="width:30%;">说明</th></tr></thead>
      <tbody>
        <tr>
          <td>维度1<br><small>段完成率</small></td>
          <td><strong>${student.dim1.score.toFixed(2)}</strong>/40</td>
          <td>完成${student.dim1.completed}/${student.dim1.total}段<br><small>${(student.dim1.rate*100).toFixed(1)}%</small></td>
          <td>单段覆盖率≥60%视为完成</td>
        </tr>
        <tr>
          <td>维度2<br><small>段内时长</small></td>
          <td><strong>${student.dim2.score.toFixed(2)}</strong>/40</td>
          <td>实际${student.dim2.actual}分钟<br>应练${student.dim2.required}分钟<br><small>${(student.dim2.ratio*100).toFixed(1)}%</small></td>
          <td>每个时间段练琴即得1.65分保底分，超过15分钟部分按实际时间比例加分</td>
        </tr>
        <tr>
          <td>维度3<br><small>段外练琴</small></td>
          <td><strong>${student.dim3.score.toFixed(2)}</strong>/20</td>
          <td>${student.dim3.outsideMinutes}分钟段外练琴<br><small>原始${student.dim3.rawPoints.toFixed(1)}点</small></td>
          <td>段外加分：1~4小时分别最多≈6.6 / 5.0 / 3.3 / 2.6，之后每小时≈1.65（按分钟累积），封顶20分。</td>
        </tr>
        <tr style="background:var(--primary-faint);">
          <td colspan="2"><strong>总分</strong></td>
          <td colspan="2"><strong>${student.total.toFixed(2)}分</strong></td>
        </tr>
      </tbody>
    </table>
  `;
  createCenterModal(content, `${studentName} 排行榜得分详情`);
}

function initLeaderboardEvents(){
  const toggle = document.getElementById('lb-toggle-more');
  if(toggle) toggle.addEventListener('click',()=>{leaderboardState.expanded=!leaderboardState.expanded;renderLeaderboard();});
}

// 历史快照功能
function saveLeaderboardSnapshot(rows) {
  if (!rows || rows.length === 0) return;
  const nowMs = (window.serverNowMs ? window.serverNowMs() : Date.now());
  const now = new Date(nowMs);
  const dateKey = formatDate(now).replace(/\//g,'-');
  const hour = now.getHours();
  const minute = now.getMinutes();
  const isTestMode = window.location.search.includes('test') || localStorage.getItem('leaderboard_test_mode') === 'true';
  const freezeMin = getTodayFreezeMinutes(now);
  const curMin = hour*60 + minute;
  const isPastCutoff = curMin >= freezeMin; // 使用新的冻结分钟
  const pendingSource = window.__snapshotSourceOverride || null; // 外部强制来源
  window.__snapshotSourceOverride = null;
  if (!isPastCutoff && !isTestMode && !pendingSource) return; // final/guard 可绕过
  try {
    const snapshots = JSON.parse(localStorage.getItem('leaderboard_history') || '{}');
    const existing = snapshots[dateKey];
    // 已有 final 则不覆写（除测试）
    if (existing && existing.meta && /^final/.test(existing.meta.source) && !pendingSource && !isTestMode) return;
    // 普通自动保存若已存在普通快照直接跳过
    if (!pendingSource && existing && !isTestMode) return;
    function hashString(str){ let h=5381,i=str.length; while(i) h=(h*33)^str.charCodeAt(--i); return (h>>>0).toString(16); }
    const compactRows = rows.slice(0,20).map(r=>({n:r.name,t:r.total,d1:r.dim1.score,d2:r.dim2.score,d3:r.dim3.score}));
    const rowsHash = hashString(JSON.stringify(compactRows));
    // 记录是否已保存冻结快照，避免重复
    const freezeFlagKey = 'freeze_snapshot_done_'+dateKey;
    if(!pendingSource && isPastCutoff && localStorage.getItem(freezeFlagKey) && !(existing && existing.meta && /^final/.test(existing.meta.source))){
      // 已有冻结时间的第一次保存且非 final，不重复
      return;
    }
    const source = pendingSource || (isTestMode ? 'test-manual' : 'auto-freeze');
    snapshots[dateKey] = {
      date: dateKey,
      timestamp: now.getTime(),
      data: rows.slice(0,20),
      totalCount: rows.length,
      isTestData: isTestMode,
      meta: {
        version:1,
        source,
        computedAt: now.toISOString(),
        offsetMs: window.__serverTimeOffsetMs || 0,
        rowsHash
      }
    };
    const cutoffTime = now.getTime() - (30*24*60*60*1000);
    Object.keys(snapshots).forEach(k=>{ if(snapshots[k].timestamp < cutoffTime) delete snapshots[k]; });
    localStorage.setItem('leaderboard_history', JSON.stringify(snapshots));
  if(isPastCutoff && source==='auto-freeze') localStorage.setItem(freezeFlagKey,'1');
    console.log(`[历史快照] 已保存 ${dateKey} (${source}) ${isTestMode?'(测试)':''}`);

    // ===== 新增：保存后触发云端上传检查 =====
    try { if(window.__attemptCloudPersistDailySnapshot) window.__attemptCloudPersistDailySnapshot('after-save'); } catch(e){ console.warn('[云端快照] 触发失败', e); }
  } catch(e){ console.error('[历史快照] 保存失败:', e); }
}

// ================= 云端快照持久化 =================
// 需求：历史排行榜要确保数据存在云端，每天18:00(工作日)/18:30(周末)以后上传一次；失败重试直至成功或跨日。
// 配置方式：
//   localStorage.setItem('leaderboard_cloud_endpoint', 'https://example.com/api/leaderboardSnapshot');
//   可选鉴权：localStorage.setItem('leaderboard_cloud_token', 'Bearer xxx');
// 关闭上传：删除 endpoint 配置。
(function initCloudSnapshotPersistence(){
  const LS_FLAG_PREFIX = 'cloud_snapshot_uploaded_';
  const LS_RETRY_STATE = 'cloud_snapshot_retry_state';
  const MAX_RETRY_ATTEMPTS = 8; // 当天最多 8 次（约 40 分钟若 5min 间隔）
  const RETRY_INTERVAL_MS = 5*60*1000;
  const MIN_GAP_BETWEEN_ATTEMPTS_MS = 60*1000; // 防抖

  function getUploadStartMinutes(now){
    const d = now.getDay(); // 0=周日 6=周六
    return (d===0 || d===6) ? (18*60+30) : (18*60); // 周末 18:30, 工作日 18:00
  }

  function loadSnapshots(){
    try { return JSON.parse(localStorage.getItem('leaderboard_history')||'{}'); } catch { return {}; }
  }
  function pickSnapshotForDate(dateKey){
    const snaps = loadSnapshots();
    const snap = snaps[dateKey];
    if(!snap) return null;
    // 如后续需要区分 final，可在此添加选择逻辑（当前存的是覆盖式，已有 final 时不覆写）
    return snap;
  }
  function buildPayload(dateKey, snapshot){
    return {
      date: dateKey,
      generatedAt: snapshot.meta && snapshot.meta.computedAt || new Date(snapshot.timestamp).toISOString(),
      uploadAt: new Date((window.serverNowMs?window.serverNowMs():Date.now())).toISOString(),
      source: snapshot.meta && snapshot.meta.source,
      totalCount: snapshot.totalCount,
      rows: snapshot.data.map(r=>({
        name: r.name,
        total: r.total,
        dim1: r.dim1 && r.dim1.score,
        dim2: r.dim2 && r.dim2.score,
        dim3: r.dim3 && r.dim3.score
      }))
    };
  }
  function loadRetryState(){
    try { return JSON.parse(localStorage.getItem(LS_RETRY_STATE)||'{}'); } catch { return {}; }
  }
  function saveRetryState(st){ localStorage.setItem(LS_RETRY_STATE, JSON.stringify(st)); }

  async function upload(dateKey, snapshot){
    const endpoint = localStorage.getItem('leaderboard_cloud_endpoint') || '';
    if(!endpoint){ console.info('[云端快照] 未配置 endpoint, 跳过'); return {skipped:true}; }
    const token = localStorage.getItem('leaderboard_cloud_token');
    const payload = buildPayload(dateKey, snapshot);
    console.log('[云端快照] 开始上传', dateKey, payload);
    const resp = await fetch(endpoint, {
      method: 'POST',
      headers: Object.assign({'Content-Type':'application/json'}, token?{'Authorization':token}:{ }),
      body: JSON.stringify(payload)
    });
    if(!resp.ok){ throw new Error('HTTP '+resp.status); }
    const json = await resp.json().catch(()=>({}));
    console.log('[云端快照] 上传成功', dateKey, json);
    return {ok:true, json};
  }

  function markUploaded(dateKey){
    localStorage.setItem(LS_FLAG_PREFIX+dateKey, '1');
  }
  function isUploaded(dateKey){ return !!localStorage.getItem(LS_FLAG_PREFIX+dateKey); }

  async function attempt(dateKey, reason){
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const curMin = now.getHours()*60 + now.getMinutes();
    const startMin = getUploadStartMinutes(now);
    if(curMin < startMin){ return; }
    if(isUploaded(dateKey)){ return; }
    const retryState = loadRetryState();
    const st = retryState[dateKey] || {attempts:0,lastAttempt:0};
    const nowMs = now.getTime();
    if(nowMs - st.lastAttempt < MIN_GAP_BETWEEN_ATTEMPTS_MS){ return; }
    if(st.attempts >= MAX_RETRY_ATTEMPTS){ console.warn('[云端快照] 达到最大重试次数, 停止', dateKey); return; }
    const snapshot = pickSnapshotForDate(dateKey);
    if(!snapshot){ console.warn('[云端快照] 无本地快照可上传', dateKey); return; }
    st.attempts += 1; st.lastAttempt = nowMs; retryState[dateKey]=st; saveRetryState(retryState);
    try {
      const res = await upload(dateKey, snapshot);
      if(res.skipped) return; // 无 endpoint
      markUploaded(dateKey);
      console.info('[云端快照] 标记完成', dateKey, '尝试次数:', st.attempts);
    } catch(e){ console.error('[云端快照] 上传失败', dateKey, e); }
  }

  // 向外暴露：用于保存后立即触发
  window.__attemptCloudPersistDailySnapshot = function(reason){
    try {
      const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
      const dateKey = formatDate(now).replace(/\//g,'-');
      attempt(dateKey, reason);
    } catch(e){ console.error('[云端快照] immediate 调用异常', e); }
  };

  // ====== 补传历史缺失日期 ======
  // 外部调用：window.backfillCloudSnapshots({start:'2025-09-01', end:'2025-09-10', parallel:2})
  // 省略 start/end 则对本地所有未标记上传且非当天日期执行。
  window.backfillCloudSnapshots = async function(opts){
    opts = opts || {};
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const todayKey = formatDate(now).replace(/\//g,'-');
    const snaps = loadSnapshots();
    let keys = Object.keys(snaps).filter(k=>k!==todayKey);
    keys.sort();
    if(opts.start) keys = keys.filter(k=>k>=opts.start);
    if(opts.end) keys = keys.filter(k=>k<=opts.end);
    keys = keys.filter(k=>!isUploaded(k));
    if(!keys.length){ console.info('[云端快照][补传] 无需补传'); return {done:true, count:0}; }
    console.warn('[云端快照][补传] 待补传数量:', keys.length, keys);
    const endpoint = localStorage.getItem('leaderboard_cloud_endpoint') || '';
    if(!endpoint){ console.error('[云端快照][补传] 未配置 endpoint'); return {error:'no-endpoint'}; }
    const token = localStorage.getItem('leaderboard_cloud_token');
    const parallel = Math.max(1, Math.min( (opts.parallel||1), 5));
    let success=0, failed=0;
    async function uploadOne(dateKey){
      const snapshot = pickSnapshotForDate(dateKey);
      if(!snapshot){ console.warn('[云端快照][补传] 跳过无本地数据', dateKey); return; }
      const payload = buildPayload(dateKey, snapshot);
      try {
        const resp = await fetch(endpoint, { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, token?{'Authorization':token}:{}), body: JSON.stringify(payload)});
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        await resp.json().catch(()=>({}));
        markUploaded(dateKey);
        success++;
        console.log('[云端快照][补传] 成功', dateKey);
      } catch(e){ failed++; console.error('[云端快照][补传] 失败', dateKey, e); }
    }
    // 简单并发控制
    for(let i=0;i<keys.length;i+=parallel){
      const slice = keys.slice(i,i+parallel);
      await Promise.all(slice.map(k=>uploadOne(k)));
    }
    console.info('[云端快照][补传] 完成 成功/失败:', success,'/',failed);
    return {success, failed};
  };

  // 定时器：每 5 分钟检查一次当天
  setInterval(()=>{ window.__attemptCloudPersistDailySnapshot('interval'); }, RETRY_INTERVAL_MS);
  // 初次延迟启动（页面加载后 10 秒）
  setTimeout(()=>window.__attemptCloudPersistDailySnapshot('initial'), 10*1000);

  // 页面重新可见时也尝试
  document.addEventListener('visibilitychange',()=>{ if(!document.hidden) window.__attemptCloudPersistDailySnapshot('visibility'); });

  // 如果 ?cloudTest=1 强制立即尝试（无视时间窗口）
  if(window.location.search.includes('cloudTest=1')){
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const dateKey = formatDate(now).replace(/\//g,'-');
    console.warn('[云端快照] cloudTest=1 强制尝试上传');
    // 临时放宽时间限制
    attempt(dateKey, 'cloudTest');
  }
})();

function showHistoryLeaderboard() {
  try {
    let snapshots = JSON.parse(localStorage.getItem('leaderboard_history') || '{}');
    let dates = Object.keys(snapshots).sort().reverse(); // 最新日期在前
    // 夜间/凌晨缺失时尝试即时重建昨日
    if (dates.length === 0) {
      const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
      if(now.getHours() < 8){
        console.warn('[历史排行榜] 无记录，尝试重建昨日快照');
        // 触发一次昨日重建
        const yesterday = new Date(now.getTime()-24*60*60*1000);
        const yKey = formatDate(yesterday).replace(/\//g,'-');
        window.__computeDateOverride = yKey;
        window.__skipSnapshotOnce = true;
        computeLeaderboard();
        delete window.__computeDateOverride;
        const rows = (leaderboardState.raw||[]);
        if(rows.length){
          window.__snapshotSourceOverride='morning-rebuild-open';
          saveLeaderboardSnapshot(rows);
          snapshots = JSON.parse(localStorage.getItem('leaderboard_history') || '{}');
          dates = Object.keys(snapshots).sort().reverse();
        }
      }
      if(dates.length===0){
        alert('暂无历史排行榜记录');
        return;
      }
    }
    
    let content = `
      <div style="margin-bottom: 16px;">
        <label for="history-date-select" class="history-modal-label">选择日期：</label>
        ${now.getHours() < 8 ? '<small style="color: #666; margin-left: 8px;">(凌晨模式：默认显示昨日)</small>' : ''}
        <select id="history-date-select" class="history-date-select">
    `;
    
    // 确定默认选中的日期：凌晨时优先选择昨日
    const now = new Date(window.serverNowMs?window.serverNowMs():Date.now());
    const expectedDate = now.getHours() < 8 ? 
      formatDate(new Date(now.getTime()-24*60*60*1000)).replace(/\//g,'-') : 
      formatDate(now).replace(/\//g,'-');
    
    // 检查期望日期是否存在
    const hasExpectedDate = dates.includes(expectedDate);
    const defaultDate = hasExpectedDate ? expectedDate : (dates.length > 0 ? dates[0] : null);
    
    dates.forEach(date => {
      const snapshot = snapshots[date];
      // 🔧 修复：添加数据安全检查
      if (!snapshot || !snapshot.data) {
        console.warn(`[历史排行榜] 跳过无效快照: ${date}`);
        return;
      }
      
      try {
        const displayDate = new Date(snapshot.timestamp).toLocaleDateString('zh-CN', {
          year: 'numeric', month: 'short', day: 'numeric', weekday: 'short'
        });
        const testMark = snapshot.isTestData ? ' [测试]' : '';
        const totalCount = snapshot.totalCount || snapshot.data.length || 0;
        const selected = date === defaultDate ? ' selected' : '';
        content += `<option value="${date}"${selected}>${displayDate} (${totalCount}人)${testMark}</option>`;
      } catch (dateError) {
        console.error(`[历史排行榜] 日期格式化失败: ${date}`, dateError);
        // 使用原始日期作为备用
        const testMark = snapshot.isTestData ? ' [测试]' : '';
        const totalCount = snapshot.totalCount || snapshot.data.length || 0;
        const selected = date === defaultDate ? ' selected' : '';
        content += `<option value="${date}"${selected}>${date} (${totalCount}人)${testMark}</option>`;
      }
    });
    
    content += `
        </select>
      </div>
      <div id="history-leaderboard-content" style="max-height: 400px; overflow-y: auto;">
        <!-- 排行榜内容将在这里显示 -->
      </div>
    `;
    
    const modal = createCenterModal(content, '📅 历史排行榜');
    
    // 🔧 修复：添加安全检查
    if (!modal) {
      console.error('[历史排行榜] 模态框创建失败');
      alert('模态框创建失败，请刷新页面重试');
      return;
    }
    
    // 添加日期选择事件
    const select = modal.querySelector('#history-date-select');
    const contentDiv = modal.querySelector('#history-leaderboard-content');
    
    // 🔧 修复：添加元素检查
    if (!select || !contentDiv) {
      console.error('[历史排行榜] 模态框元素查找失败', { select: !!select, contentDiv: !!contentDiv });
      alert('模态框元素加载失败，请刷新页面重试');
      return;
    }
    
    function renderHistoryData(dateKey) {
      try {
        const snapshot = snapshots[dateKey];
        if (!snapshot || !snapshot.data || !Array.isArray(snapshot.data)) {
          contentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">该日期的数据已损坏或不完整</div>';
          return;
        }
        
        let html = `
          <table class="history-table">
            <thead>
              <tr>
                <th style="width: 50px; min-width: 50px;">排名</th>
                <th style="min-width: 80px;">姓名</th>
                <th style="width: 80px; min-width: 80px;">总分</th>
                <th style="width: 70px; min-width: 70px;">维度1</th>
                <th style="width: 70px; min-width: 70px;">维度2</th>
                <th style="width: 70px; min-width: 70px;">维度3</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        snapshot.data.forEach((row, index) => {
          try {
            const rank = index + 1;
            let rowClass = '';
            if (rank === 1) rowClass = 'rank-1';
            else if (rank === 2) rowClass = 'rank-2';
            else if (rank === 3) rowClass = 'rank-3';
            
            // 🔧 修复：添加数据安全检查和格式化
            const name = row.name || '未知学生';
            const total = typeof row.total === 'number' ? row.total.toFixed(2) : '0.00';
            const dim1Score = (row.dim1 && typeof row.dim1.score === 'number') ? row.dim1.score.toFixed(1) : '0.0';
            const dim2Score = (row.dim2 && typeof row.dim2.score === 'number') ? row.dim2.score.toFixed(1) : '0.0';
            const dim3Score = (row.dim3 && typeof row.dim3.score === 'number') ? row.dim3.score.toFixed(1) : '0.0';
            
            html += `
              <tr class="${rowClass}">
                <td style="font-weight: 600; text-align: center; white-space: nowrap;">${rank}</td>
                <td style="text-align: left; padding-left: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(name)}</td>
                <td style="font-weight: 600; text-align: center; white-space: nowrap;">${total}</td>
                <td style="text-align: center; white-space: nowrap;">${dim1Score}</td>
                <td style="text-align: center; white-space: nowrap;">${dim2Score}</td>
                <td style="text-align: center; white-space: nowrap;">${dim3Score}</td>
              </tr>
            `;
          } catch (rowError) {
            console.error(`[历史排行榜] 渲染行数据失败: ${index}`, rowError, row);
            // 跳过有问题的行，继续处理其他行
          }
        });
        
        html += '</tbody></table>';
        contentDiv.innerHTML = html;
        
      } catch (renderError) {
        console.error(`[历史排行榜] 渲染数据失败: ${dateKey}`, renderError);
        contentDiv.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 20px;">🚫 数据渲染失败，请检查控制台</div>';
      }
    }
    
    // 初始显示期望日期的数据（凌晨时为昨日，否则为最新）
    const initialDate = select.value || defaultDate;
    if (initialDate) {
      renderHistoryData(initialDate);
      console.info(`[历史排行榜] 显示日期: ${initialDate} (期望: ${expectedDate}, 存在: ${hasExpectedDate})`);
    }
    
    // 监听日期选择变化
    select.addEventListener('change', () => {
      renderHistoryData(select.value);
    });
    
  } catch (e) {
    console.error('[历史排行榜] 显示失败:', e);
    alert(`显示历史排行榜时发生错误: ${e.message}\n\n请查看浏览器控制台了解详细信息`);
  }
}

// 调度：可在相关数据 ready 后调用 init + 首次 compute
window.addEventListener('DOMContentLoaded',()=>{initLeaderboardEvents();});

// === 服务器时间同步 & 终局快照调度 ===
(function initTimeAndFinalSnapshot(){
  window.__serverTimeOffsetMs = Number(localStorage.getItem('leaderboard_time_offset_ms')||0);
  window.serverNowMs = ()=> Date.now() + (window.__serverTimeOffsetMs||0);
  async function syncServerTime(){
    try {
      const t0=Date.now();
      const resp = await fetch('https://worldtimeapi.org/api/ip',{cache:'no-store'});
      const json = await resp.json();
      if(json && json.unixtime){
        const serverMs = json.unixtime*1000;
        const rtt = (Date.now()-t0)/2;
        const offset = (serverMs + rtt) - Date.now();
        window.__serverTimeOffsetMs = offset;
        localStorage.setItem('leaderboard_time_offset_ms', String(offset));
        console.log('[时间同步] offset(ms)=', offset);
      }
    } catch(e){ console.warn('[时间同步] 失败，使用本地时间', e); }
  }
  syncServerTime();
  setInterval(syncServerTime, 10*60*1000);
  function hasFinalSnapshot(){
    try {
      const snapshots = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      const now = new Date(window.serverNowMs());
      const dk = formatDate(now).replace(/\//g,'-');
      const s = snapshots[dk];
      return !!(s && s.meta && /^final/.test(s.meta.source));
    } catch { return false; }
  }
  function attemptFinalSnapshot(reason){
    const now = new Date(window.serverNowMs());
    const freezeMin = getTodayFreezeMinutes(now);
    const h = now.getHours();
    const m = now.getMinutes();
    const curMin = h*60+m;
    if(curMin >= freezeMin + 2){ // 冻结后 +2 分钟生成终局快照
      if(hasFinalSnapshot()) return;
      console.log('[终局快照] 尝试生成 (原因:'+reason+')');
      window.__snapshotSourceOverride='final-freeze';
      window.__skipSnapshotOnce=false;
      computeLeaderboard();
    }
  }
  setInterval(()=>attemptFinalSnapshot('interval'), 60*1000);
  document.addEventListener('visibilitychange',()=>{ if(!document.hidden) attemptFinalSnapshot('visibility'); });
  setTimeout(()=>attemptFinalSnapshot('initial'), 15000);

  // ================= 晨间历史补写：保证昨天结果 08:00 前可见 =================
  function morningHistoryEnsure(){
    try {
      const now = new Date(window.serverNowMs());
      if(now.getHours()>=8) return; // 仅 08:00 前执行
      if(window.__morningHistoryEnsured) return; // 防重入
      window.__morningHistoryEnsured=true;
      const yesterday = new Date(now.getTime()-24*60*60*1000);
      const yKey = formatDate(yesterday).replace(/\//g,'-');
      const snaps = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      const ySnap = snaps[yKey];
      if(ySnap && ySnap.meta && ySnap.meta.rowsHash){
        console.info('[晨间历史] 昨日已有快照', ySnap.meta.source);
        return;
      }
      console.warn('[晨间历史] 缺失昨日快照，开始重建', yKey);
      // 计算昨日排行榜
      window.__computeDateOverride = yKey;
      window.__skipSnapshotOnce = true; // 避免在 compute 内误保存到今天键
      computeLeaderboard();
      delete window.__computeDateOverride;
      const rows = (leaderboardState.raw||[]);
      if(rows.length){
        window.__snapshotSourceOverride = 'morning-history-fix';
        saveLeaderboardSnapshot(rows); // 写入昨天键
        console.info('[晨间历史] 已补写昨日快照');
      } else {
        console.error('[晨间历史] 重建失败，无 rows');
      }
    } catch(e){ console.error('[晨间历史] 异常', e); }
  }
  setTimeout(morningHistoryEnsure, 5000); // 页面加载后短延迟
  // 每 2 分钟再尝试一次直到 >=08:00
  const morningTimer = setInterval(()=>{ const h=new Date(window.serverNowMs()).getHours(); if(h>=8){clearInterval(morningTimer);} else morningHistoryEnsure(); }, 2*60*1000);

  // ================= 冻结后延迟终局补写：防止页面未开导致 final 缺失 =================
  function lateFinalSnapshotFix(){
    try {
      const now = new Date(window.serverNowMs());
      const freezeMin = getTodayFreezeMinutes(now);
      const curMin = now.getHours()*60 + now.getMinutes();
      if(curMin < freezeMin + 15) return; // 冻结 +15 以后才检查
      const dk = formatDate(now).replace(/\//g,'-');
      const snaps = JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
      const s = snaps[dk];
      if(s && s.meta && /^final/.test(s.meta.source)) return; // 已有终局
      if(window.__lateFinalFixed) return;
      window.__lateFinalFixed=true;
      console.warn('[终局补写] 缺失 final，尝试补写');
      window.__snapshotSourceOverride='final-late-fix';
      window.__skipSnapshotOnce=false;
      computeLeaderboard();
    } catch(e){ console.error('[终局补写] 异常', e); }
  }
  setInterval(lateFinalSnapshotFix, 5*60*1000); // 每 5 分钟检查一次
})();

// 对比工具
function compareSnapshotWithCurrent(dateKey){
  try {
    const snapshots=JSON.parse(localStorage.getItem('leaderboard_history')||'{}');
    const snap=snapshots[dateKey];
    if(!snap){ console.warn('[对比] 无快照', dateKey); return; }
    window.__skipSnapshotOnce=true;
    computeLeaderboard();
    const current=(leaderboardState.raw||[]).slice(0,snap.data.length);
    const diffs=[];const mapNow=new Map(current.map(r=>[r.name,r]));const mapSnap=new Map(snap.data.map(r=>[r.name,r]));
    snap.data.forEach(r=>{const live=mapNow.get(r.name);if(!live) diffs.push({name:r.name,type:'missingNow',snapTotal:r.total}); else {const delta=+(live.total-r.total).toFixed(2); if(Math.abs(delta)>0.009) diffs.push({name:r.name,type:'scoreChanged',snapTotal:r.total,nowTotal:live.total,delta});}});
    current.forEach(r=>{ if(!mapSnap.has(r.name)) diffs.push({name:r.name,type:'newInCurrent',nowTotal:r.total}); });
    console.group('[对比结果]',dateKey);console.table(diffs);console.groupEnd();
    return diffs;
  }catch(e){console.error('[对比] 失败',e);}
}

// 🔧 新增：历史排行榜数据诊断工具
function debugLeaderboardHistory() {
  console.log('🔍 历史排行榜数据诊断：');
  console.log('=====================================');
  
  try {
    const snapshots = JSON.parse(localStorage.getItem('leaderboard_history') || '{}');
    const dates = Object.keys(snapshots);
    
    console.log(`📊 历史记录总数：${dates.length}`);
    
    if (dates.length === 0) {
      console.log('❌ 没有找到历史排行榜数据');
      return;
    }
    
    dates.sort().forEach(date => {
      const snapshot = snapshots[date];
      console.log(`\n📅 日期：${date}`);
      
      // 检查基础结构
      console.log(`   ✅ 时间戳：${snapshot.timestamp ? new Date(snapshot.timestamp).toLocaleString() : '❌ 缺失'}`);
      console.log(`   ✅ 总人数：${snapshot.totalCount || '❌ 缺失'}`);
      console.log(`   ✅ 测试数据：${snapshot.isTestData ? '是' : '否'}`);
      
      // 检查数据结构
      if (!snapshot.data) {
        console.log('   ❌ 数据缺失：data 字段不存在');
      } else if (!Array.isArray(snapshot.data)) {
        console.log('   ❌ 数据格式错误：data 不是数组');
      } else {
        console.log(`   ✅ 数据条数：${snapshot.data.length}`);
        
        // 检查前几条数据的结构
        const sampleSize = Math.min(3, snapshot.data.length);
        for (let i = 0; i < sampleSize; i++) {
          const row = snapshot.data[i];
          console.log(`     样本 ${i + 1}:`);
          console.log(`       姓名：${row.name || '❌ 缺失'}`);
          console.log(`       总分：${row.total !== undefined ? row.total : '❌ 缺失'}`);
          console.log(`       维度1：${row.dim1 && typeof row.dim1.score === 'number' ? row.dim1.score.toFixed(1) : '❌ 缺失或格式错误'}`);
          console.log(`       维度2：${row.dim2 && typeof row.dim2.score === 'number' ? row.dim2.score.toFixed(1) : '❌ 缺失或格式错误'}`);
          console.log(`       维度3：${row.dim3 && typeof row.dim3.score === 'number' ? row.dim3.score.toFixed(1) : '❌ 缺失或格式错误'}`);
        }
      }
    });
    
  } catch (e) {
    console.error('❌ 诊断过程中发生错误：', e);
  }
  
  console.log('=====================================');
  console.log('💡 如需清理损坏的数据，请运行：cleanupLeaderboardHistory()');
}

// 🔧 新增：清理损坏的历史排行榜数据
function cleanupLeaderboardHistory() {
  try {
    const snapshots = JSON.parse(localStorage.getItem('leaderboard_history') || '{}');
    const dates = Object.keys(snapshots);
    let cleaned = 0;
    let total = dates.length;
    
    console.log('🧹 开始清理历史排行榜数据...');
    
    dates.forEach(date => {
      const snapshot = snapshots[date];
      
      // 检查数据完整性
      if (!snapshot.data || !Array.isArray(snapshot.data) || !snapshot.timestamp) {
        console.log(`🗑️ 删除损坏的数据：${date}`);
        delete snapshots[date];
        cleaned++;
        return;
      }
      
      // 检查数据项的完整性
      const validData = snapshot.data.filter(row => {
        return row.name && 
               row.total !== undefined && 
               row.dim1 && typeof row.dim1.score === 'number' &&
               row.dim2 && typeof row.dim2.score === 'number' &&
               row.dim3 && typeof row.dim3.score === 'number';
      });
      
      if (validData.length !== snapshot.data.length) {
        console.log(`🔧 修复 ${date}：从 ${snapshot.data.length} 条修复为 ${validData.length} 条`);
        snapshot.data = validData;
        snapshot.totalCount = validData.length;
      }
    });
    
    localStorage.setItem('leaderboard_history', JSON.stringify(snapshots));
    
    console.log(`✅ 清理完成：删除 ${cleaned} 个损坏数据，剩余 ${total - cleaned} 个有效数据`);
    
    if (cleaned > 0) {
      alert(`已清理 ${cleaned} 个损坏的历史记录，剩余 ${total - cleaned} 个有效记录`);
    } else {
      alert('所有历史记录都是完整的，无需清理');
    }
    
  } catch (e) {
    console.error('清理失败：', e);
    alert('清理历史数据时发生错误，请查看控制台');
  }
}

// 🔧 新增：测试模态框功能
function testModal() {
  try {
    console.log('🧪 测试模态框功能...');
    
    const testContent = `
      <div style="padding: 20px; text-align: center;">
        <p>这是一个测试模态框</p>
        <p>如果您能看到这个内容，说明模态框功能正常</p>
        <button id="test-button" style="padding: 8px 16px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
          测试按钮
        </button>
      </div>
    `;
    
    const modal = createCenterModal(testContent, '🧪 模态框测试');
    
    if (modal) {
      console.log('✅ 模态框创建成功');
      
      const testButton = modal.querySelector('#test-button');
      if (testButton) {
        console.log('✅ 按钮元素查找成功');
        testButton.addEventListener('click', () => {
          alert('按钮点击事件正常！');
        });
      } else {
        console.error('❌ 按钮元素查找失败');
      }
    } else {
      console.error('❌ 模态框创建失败');
    }
    
  } catch (e) {
    console.error('❌ 测试过程中发生错误：', e);
  }
}
// 后续：在 studentTimeSlots / practice interval 更新处调用 computeLeaderboard() 节流即可。

// 排行榜节流刷新：相关数据变更时调用
let scheduleLeaderboardUpdate = (function(){
  let timer=null; return function(){
    if(timer) return; timer=setTimeout(()=>{timer=null; computeLeaderboard();}, 600); // 600ms 去抖
  };
})();

// 数据监听挂钩（在现有监听成功回调尾部调用）示例：
// 在 studentTimeSlots on('value') 与 考勤/练琴记录变更后添加 scheduleLeaderboardUpdate();
// 下面演示性地对 window 暴露一个触发方法方便手动调试。
window.forceLeaderboardRecompute = computeLeaderboard;

// 测试工具：启用测试模式（可以在任何时间保存快照）
window.enableLeaderboardTestMode = function() {
  localStorage.setItem('leaderboard_test_mode', 'true');
  console.log('[测试模式] 已启用排行榜测试模式，将在下次计算时保存快照');
};

// 测试工具：禁用测试模式
window.disableLeaderboardTestMode = function() {
  localStorage.removeItem('leaderboard_test_mode');
  console.log('[测试模式] 已禁用排行榜测试模式');
};

// 测试工具：清除所有历史快照
window.clearLeaderboardHistory = function() {
  localStorage.removeItem('leaderboard_history');
  console.log('[测试工具] 已清除所有历史快照');
};

// 初始化：等核心数据 ready 后首次计算（依赖 existing ready.* 结构）
(function waitCore(){
  if(typeof ready==='object' && ready.students && ready.slots){
    computeLeaderboard();
  } else { setTimeout(waitCore, 500); }
})();

/* =============================
   1. 国际化配置（保留原结构）
   ============================= */
const i18n = {
  zh: {
    // 头部
    'header.title': '🎼 青岛耶胡迪梅纽因学校',
    'header.subtitle': '实时练琴跟踪系统',


    
    // 导航
    'nav.dashboard': '📊 考勤概览',
    'nav.students': '👥 学生详情', 
  // 导航替换：排行榜
  'nav.leaderboard': '🏅排行榜',
  'leaderboard.title': '🏆 442练琴排行榜',
  'leaderboard.refresh': '刷新',
  'leaderboard.expand': '展开全部',
  'leaderboard.collapse': '收起',
    'nav.sync': '🔄 数据同步',
    
    // 连接状态
    'status.online': '🟢 已连接',
    'status.offline': '🔴 离线模式',
    'status.syncing': '🟡 同步中',
    
    // 考勤状态
    'status.present': '出勤',
    'status.absent': '缺勤',
    'status.excused': '请假',
    'status.pending': '待考勤',
    'status.low_efficiency': '低效',
    'stats.absent.desc': '应到未到',
  'status.practicing_unscheduled': '自主练琴',
  'status.not_practicing': '目前未练琴',


    // 统计
    'stats.total': '总学生数',
    'stats.total.desc': '已登记学生',
    'stats.present': '出勤',
    'stats.present.desc': '当前在琴房',
    'stats.absent': '缺勤',
    'stats.absent.desc': '应到未到',
    'stats.excused': '请假',
    'stats.excused.desc': '已批准请假',
    'stats.pending': '待考勤',
    'stats.pending.desc': '非练琴时间',
  'stats.self_practice': '自主练琴',
  'stats.self_practice.desc': '非规定时间段练琴',

    
    // 练琴相关
    'practice.title': '🎹 实时练琴状态',
    'practice.current_time': '当前时间：',
    'practice.empty.title': '当前没有学生在练琴',
    'practice.empty.desc.weekday': '等待学生开始练琴',
    'practice.in_slot': '段内',
    'practice.out_slot': '段外',
    'practice.recent_7days': '🗓️ 最近7天练琴明细',
    'practice.time_slot_desc': '段内=规定练琴时段 | 段外=非规定时段',
    'practice.data_source': '• 数据来源：实时计算',
    'practice.status': '练琴状态',
    'practice.start_time': '开始时间:',
    'practice.room': '琴房:',
    'practice.current_practice': '当前练习:',
    'practice.today_total': '今日总计:',
    'practice.out_slot_segments': '段外练琴区间',
  'break.short.recess':'课间休息',
  'break.short.large':'大课间休息',
  'break.short.lunch':'午餐时间',
  'break.short.lunch_concert':'午餐时间+午间音乐会',
  'break.short.dinner':'晚餐时间',
  'break.night':'夜间',
  'break.excluded_minutes':'剔除分钟',
  'break.remaining':'剩余',
    
    // 考勤相关
    'attendance.title': '📅 今日考勤快照',
    'attendance.select_date': '选择日期：',
    'attendance.history': '最近7天考勤',
    'attendance.rate': '出勤率',
    'attendance.detail.suffix': '考勤详情',
    'attendance.summary': '考勤汇总',
    'attendance.detailed_records': '详细记录',
    'attendance.remarks': '备注',
    
    // 筛选器
    'filter.major': '专业筛选',
    'filter.grade': '年级筛选',
    'filter.status': '考勤状态',
    'filter.search': '搜索学生',
    'filter.all_majors': '所有专业',
    'filter.all_grades': '所有年级',
    'filter.all_status': '所有状态',
    'filter.search_placeholder': '输入学生姓名...',
    'filter.no_results': '没有符合条件的学生',
    'filter.try_different': '请尝试调整筛选条件',
    'filter.clear': '清除',
    
    // 学生信息
    'student.name': '姓名',
    'student.major': '专业',
    'student.grade': '年级',
    'student.room': '所在琴房',
    'student.time_slot': '时间段',
    'student.practice_duration': '练琴时长',
    'student.start_time': '最近开始',
    'student.not_in_room': '不在琴房',
    'student.not_started': '未开始',
    'student.not_set': '未设置',
    'student.unknown_major': '未知专业',
    'student.detail.title': '学生详情',
    'student.today_attendance': '今日考勤',
    'student.today_practice': '今日练琴时长',
    
    // 时间相关
    'time.hours': '小时',
    'time.minutes': '分钟',
    'time.seconds': '秒',
    'time.no_practice': '0分钟',
    'time.preparing': '准备中',
    'time.preparing_formal': '准备中(正式时段)',
    'time.buffer_observation': '缓冲观察',
    'time.today': '今天',
    'time.no_records': '无记录',
    
    // 请假相关
    'excuse.title': '📝 今日请假信息',
    'excuse.reason': '请假原因',
    'excuse.duration_text': '请假时长',
    'excuse.end_date': '结束日期',
    'excuse.not_filled': '未填写',
    
    // 报告相关
    'report.title': '📈 考勤历史分析',
    'report.start_date': '开始日期：',
    'report.end_date': '结束日期：',
    'report.empty.title': '选择日期范围生成报告',
    'report.empty.desc': '选择开始和结束日期，然后点击"生成报告"',
    'report.analysis_title': '📊 考勤分析报告',
    'report.period': '统计周期',
    'report.to': '至',
    'report.days': '天',
    'report.participants': '参与学生',
    'report.people': '人',
    'report.daily_trend': '📈 每日考勤趋势',
    'report.date': '日期',
    'report.total': '合计',
    'report.student_stats': '👥 学生考勤统计',
    'report.regenerate': '重新生成',
    
    // 同步相关
    'sync.title': '🔄 数据同步管理',
    'sync.status': '同步状态',
    'sync.checking': '正在检查连接状态...',
    'sync.logs': '📋 同步日志',
    'sync.force_sync': '强制同步',
    
    // 按钮
    'btn.generate_report': '生成报告',
    'btn.force_sync': '强制同步',
    'btn.clear_cache': '清除缓存',
    
    // 消息提示
    'msg.loading': '加载中...',
    'msg.no_data': '暂无数据',
    'msg.select_dates': '请选择开始和结束日期',
    'msg.date_range_error': '开始日期不能晚于结束日期',
    'msg.sync_required': '需要网络连接才能同步数据',
    'msg.clear_cache_confirm': '确定要清除本地缓存吗？',
    'msg.cache_cleared': '本地缓存已清除',
    
    // 空状态
    'empty.no_students': '暂无学生数据',
    'empty.no_attendance': '还没有考勤记录',
    'empty.load_failed': '加载失败',
    
    // 房间相关
    'room.practice_room': '练琴房',
    'room.in_room': '在琴房',
    'room.not_in_room': '不在琴房',
    'room.historical_rebuild': '（历史重建）',
    'room.no_arrangement': '无安排',
    'room.weekend': '周末',
    
    // 状态文本
    'status.present_out_slot': '出勤(段外)',
    'status.pending_attendance': '待考勤',
    'status.absent_text': '缺勤',
    'status.present_text': '出勤',
    'status.low_efficiency_text': '低效',
    'status.absent_buffer': '缺勤(缓冲期)',
    'status.absent_not_started': '缺勤(未开始)',
    'status.absent_ended': '缺勤(已结束)'
  },
  
  en: {
    // 头部
    'header.title': '🎼 Qingdao Menuhin School',
    'header.subtitle': 'Practice Tracking System',
    
    // 导航
    'nav.dashboard': '📊 Overview',
    'nav.students': '👥 Students', 
    'nav.reports': '📈 Reports',
    'nav.sync': '🔄 Sync',
    
    // 连接状态
    'status.online': '🟢 Online',
    'status.offline': '🔴 Offline',
    'status.syncing': '🟡 Syncing',
    
    // 考勤状态
    'status.present': 'Present',
    'status.absent': 'Absent',
    'status.excused': 'Excused',
    'status.pending': 'Pending',
    'status.low_efficiency': 'Low Efficiency',
    'stats.absent.desc': 'Should be Present',
  'status.practicing_unscheduled': 'Self Practice',
  'status.not_practicing': 'Not Practicing',
    
    // 统计
    'stats.total': 'Total',
    'stats.total.desc': 'Registered',
    'stats.present': 'Present',
    'stats.present.desc': 'In Rooms',
    'stats.absent': 'Absent',
    'stats.absent.desc': 'Should be Present',
    'stats.excused': 'Excused',
    'stats.excused.desc': 'Approved Leave',
    'stats.pending': 'Pending',
    'stats.pending.desc': 'Non-practice Time',
  'stats.self_practice': 'Self Practice',
  'stats.self_practice.desc': 'Out-of-slot practice',

    
    // 练琴相关
    'practice.title': '🎹 Practice Status',
    'practice.current_time': 'Time: ',
    'practice.empty.title': 'No students practicing',
    'practice.empty.desc.weekday': 'Waiting for students',    
    'practice.in_slot': 'In-Slot',
    'practice.out_slot': 'Out-Slot',
    'practice.recent_7days': '🗓️ Recent 7 Days Practice Details',
    'practice.time_slot_desc': 'In-Slot=Scheduled Time | Out-Slot=Non-scheduled Time',
    'practice.data_source': '• Data Source: Real-time Calculation',
    'practice.status': 'Practice Status',
    'practice.start_time': 'Start Time:',
    'practice.room': 'Room:',
    'practice.current_practice': 'Current:',
    'practice.today_total': 'Today Total:',
    'practice.out_slot_segments': 'Out-of-slot Intervals',
  'break.short.recess':'Recess',
  'break.short.large':'Long Break',
  'break.short.lunch':'Lunch',
  'break.short.lunch_concert':'Lunch + Noon Concert',
  'break.short.dinner':'Dinner',
  'break.night':'Night',
  'break.excluded_minutes':'Excluded Min',
  'break.remaining':'Remain',
    // 考勤相关
    'attendance.title': '📅 Today\'s Attendance',
    'attendance.select_date': 'Date: ',
    'attendance.history': 'Last 7 Days',
    'attendance.rate': 'Rate',
    'attendance.detail.suffix': ' Details',
    'attendance.summary': 'Summary',
    'attendance.detailed_records': 'Records',
    'attendance.remarks': 'Remarks',

    
    // 筛选器
    'filter.major': 'Major',
    'filter.grade': 'Grade',
    'filter.status': 'Status',
    'filter.search': 'Search',
    'filter.all_majors': 'All Majors',
    'filter.all_grades': 'All Grades',
    'filter.all_status': 'All Status',
    'filter.search_placeholder': 'Enter name...',
    'filter.no_results': 'No matches',
    'filter.try_different': 'Try different filters',
    'filter.clear': 'Clear',
    
    // 学生信息
    'student.name': 'Name',
    'student.major': 'Major',
    'student.grade': 'Grade',
    'student.room': 'Room',
    'student.time_slot': 'Time Slot',
    'student.practice_duration': 'Duration',
    'student.start_time': 'Start',
    'student.not_in_room': 'Not in Room',
    'student.not_started': 'Not Started',
    'student.not_set': 'Not Set',
    'student.unknown_major': 'Unknown',
    'student.detail.title': 'Details',
    'student.today_attendance': 'Today\'s Attendance',
    'student.today_practice': 'Today\'s Practice',
    
    // 时间相关
    'time.hours': 'h',
    'time.minutes': 'min',
    'time.seconds': 's',
    'time.no_practice': '0 min',
    'time.preparing': 'Preparing',
    'time.preparing_formal': 'Preparing (Formal)',
    'time.buffer_observation': 'Buffer Observation',
    'time.today': 'Today',
    'time.no_records': 'No Records',
    
    // 请假相关
    'excuse.title': '📝 Today\'s Leave Info',
    'excuse.reason': 'Reason',
    'excuse.duration_text': 'Duration',
    'excuse.end_date': 'End Date',
    'excuse.not_filled': 'Not Filled',
    
    // 报告相关
    'report.title': '📈 Analysis',
    'report.start_date': 'Start: ',
    'report.end_date': 'End: ',
    'report.empty.title': 'Select dates to generate',
    'report.empty.desc': 'Choose dates, then click "Generate"',
    'report.analysis_title': '📊 Analysis Report',
    'report.period': 'Period',
    'report.to': 'to',
    'report.days': ' days',
    'report.participants': 'Students',
    'report.people': ' students',
    'report.daily_trend': '📈 Daily Trend',
    'report.date': 'Date',
    'report.total': 'Total',
    'report.student_stats': '👥 Student Stats',
    'report.regenerate': 'Regenerate',
    
    // 同步相关
    'sync.title': '🔄 Data Sync',
    'sync.status': 'Status',
    'sync.checking': 'Checking...',
    'sync.logs': '📋 Logs',
    'sync.force_sync': 'Force Sync',
    
    // 按钮
    'btn.generate_report': 'Generate',
    'btn.force_sync': 'Force Sync',
    'btn.clear_cache': 'Clear Cache',
    
    // 消息提示
    'msg.loading': 'Loading...',
    'msg.no_data': 'No Data',
    'msg.select_dates': 'Select start and end dates',
    'msg.date_range_error': 'Start date cannot be later than end',
    'msg.sync_required': 'Network required for sync',
    'msg.clear_cache_confirm': 'Clear local cache?',
    'msg.cache_cleared': 'Cache cleared',
    
    // 空状态
    'empty.no_students': 'No student data',
    'empty.no_attendance': 'No records yet',
    'empty.load_failed': 'Load failed',
    
    // 房间相关
    'room.practice_room': 'Practice Room',
    'room.in_room': 'In Room',
    'room.not_in_room': 'Not in Room',
    'room.historical_rebuild': '(Historical)',
    'room.no_arrangement': 'No Schedule',
    'room.weekend': 'Weekend',
    
    // 状态文本
    'status.present_out_slot': 'Present(Out-Slot)',
    'status.pending_attendance': 'Pending',
    'status.absent_text': 'Absent',
    'status.present_text': 'Present',
    'status.low_efficiency_text': 'Low Efficiency',
    'status.absent_buffer': 'Absent(Buffer)',
    'status.absent_not_started': 'Absent(Not Started)',
    'status.absent_ended': 'Absent(Ended)'
  }
};

let currentLanguage='zh';
function t(k,f=''){const p=i18n[currentLanguage]||{};return p[k]||f||k;}

// 🔥 新增：同步语言按钮状态
function syncLanguageButtons(){
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.dataset.lang===currentLanguage));
}

function switchLanguage(lang){if(lang===currentLanguage)return;currentLanguage=lang;syncLanguageButtons();updatePageLanguage();localStorage.setItem('preferred_language',lang);addSyncLog(`🌐 ${lang==='zh'?'语言切换为中文':'Language switched to English'}`);refreshCurrentTabContent();}
function updatePageLanguage(){const pack=i18n[currentLanguage]||{};document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(pack[k]) el.textContent=pack[k];});document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{const k=el.getAttribute('data-i18n-placeholder');if(pack[k]) el.placeholder=pack[k];});document.title=currentLanguage==='zh'?'青岛梅纽因音乐学校练琴跟踪系统':'Qingdao Menuhin Music School Practice Tracking System';}

/* =============== Firebase =============== */
const firebaseConfig={
  apiKey:"AIzaSyBfRjrAKsVUAHBl5WbBl96YONrkRe1UWUo",
  authDomain:"menuhin-studio-system.firebaseapp.com",
  databaseURL:"https://menuhin-studio-system-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"menuhin-studio-system",
  storageBucket:"menuhin-studio-system.firebasestorage.app",
  messagingSenderId:"218592951152",
  appId:"1:218592951152:web:650d080726b6c44f5a2db5",
  measurementId:"G-P49SZQTLT7"
};
let database=null,isOnline=false;

/* =============== 全局数据结构 =============== */
let rooms=[];
let studentDatabase={};
let excuseData={};
let attendanceRecordsCache={};
let realTimePracticeMap={};
let syncLogs=[];
let currentTab='dashboard';

let studentTimeSlots={};
let dailyPracticeRecords={};
// === 排行榜自动刷新状态 ===
leaderboardState.dirty=false;
let _lbAutoTimer=null;
function setLeaderboardDirty(){
  leaderboardState.dirty=true;
  const hint=document.getElementById('leaderboard-auto-hint');
  if(hint) hint.style.display='inline';
  scheduleLeaderboardAutoRecalc();
}
function scheduleLeaderboardAutoRecalc(){
  // 如果当前 Tab 不是 leaderboard，等切换时已有逻辑会触发；仍保持脏标记
  if(_lbAutoTimer) clearTimeout(_lbAutoTimer);
  _lbAutoTimer=setTimeout(()=>{
    if(currentTab==='leaderboard'){ computeLeaderboard(); }
    else {
      // 未在排行榜页，延长等待（再次设定定时器）
      scheduleLeaderboardAutoRecalc();
    }
  },3000); // 3秒防抖
}
let practiceSessionTracker=new Map();
let lastPracticeSessionSweep=0;
const PRACTICE_UPDATE_INTERVAL_MS=60000;
// 练琴统计日窗口（只统计此时间范围内的练琴；以前夜间 21:30-24:00 作为“剔除”，现在直接不纳入原始统计）
const PRACTICE_DAY_START_MINUTES = 6*60;   // 06:00
const PRACTICE_DAY_END_MINUTES   = 21*60+30; // 备用默认 21:30

// 动态每日截断（冻结）时间：周一/二/四/五 18:00，周三 18:30，其它保留默认21:30
function getTodayFreezeMinutes(dateObj=new Date()){
  const wd = dateObj.getDay(); // 0=周日
  if(wd===1||wd===2||wd===4||wd===5) return 18*60;      // 18:00
  if(wd===3) return 18*60+30;                            // 18:30
  return PRACTICE_DAY_END_MINUTES;                       // 周末/周日用原值
}

/* ==== 休息时间配置（课间/午餐/大课间/晚餐 + 夜间）==== */
const BREAK_SCHEDULE={
  monTueThuFri:[
    {start:8*60+50,end:9*60,labelKey:'break.short.recess'},
    {start:9*60+50,end:10*60,labelKey:'break.short.recess'},
    {start:10*60+50,end:11*60,labelKey:'break.short.recess'},
    // 周一二四五：11:50-13:00 仅午餐
    {start:11*60+50,end:13*60,labelKey:'break.short.lunch'},
  // 新增 午后短休 13:50-14:00
  {start:13*60+50,end:14*60,labelKey:'break.short.recess'},
    {start:14*60+50,end:15*60+10,labelKey:'break.short.large'},
    {start:16*60,end:16*60+10,labelKey:'break.short.recess'},
    {start:17*60,end:17*60+10,labelKey:'break.short.recess'},
    {start:18*60,end:19*60,labelKey:'break.short.dinner'}
  ],
  wed:[
    {start:8*60+50,end:9*60,labelKey:'break.short.recess'},
    {start:9*60+50,end:10*60,labelKey:'break.short.recess'},
    {start:10*60+50,end:11*60,labelKey:'break.short.recess'},
    // 周三：11:50-13:30 午餐时间+午间音乐会
    {start:11*60+50,end:13*60+30,labelKey:'break.short.lunch_concert'},
  // 新增 周三午后短休 14:20-14:30
  {start:14*60+20,end:14*60+30,labelKey:'break.short.recess'},
    {start:15*60+20,end:15*60+40,labelKey:'break.short.large'},
    {start:16*60+30,end:16*60+40,labelKey:'break.short.recess'},
    {start:17*60+30,end:17*60+40,labelKey:'break.short.recess'},
    {start:18*60+30,end:19*60+30,labelKey:'break.short.dinner'}
  ],
  common:[]
};
function currentBreakInfo(now=new Date()){
  const wd=now.getDay();
  const m=now.getHours()*60+now.getMinutes();
  let segs=[...BREAK_SCHEDULE.common];
  if(wd===3) segs.push(...BREAK_SCHEDULE.wed); else if(wd>=1&&wd<=5) segs.push(...BREAK_SCHEDULE.monTueThuFri);
  for(const s of segs){ if(m>=s.start && m<s.end){
    const remain=(s.end-m)*60; // 秒
    const label=t(s.labelKey,s.labelKey);
    return {labelKey:s.labelKey,label,labelRaw:s.labelKey,endMinute:s.end,remainSec:remain,startMinute:s.start};
  }}
  return null;
}

// 计算某时间段(开始->当前)剔除休息后的有效练琴秒数
function computeEffectivePracticeSeconds(startTimeMs, nowMs=new Date().getTime()){
  if(!startTimeMs || nowMs<=startTimeMs) return 0;
  const startDate=new Date(startTimeMs);
  const nowDate=new Date(nowMs);
  // 仅当日场景；若跨日简单截断到今日0点
  const dayStart=new Date(nowDate.getFullYear(),nowDate.getMonth(),nowDate.getDate()).getTime();
  let segStart=Math.max(startTimeMs, dayStart);
  const totalSec=Math.floor((nowMs - segStart)/1000);
  if(totalSec<=0) return 0;
  const wd=nowDate.getDay();
  let segs=[...BREAK_SCHEDULE.common];
  if(wd===3) segs.push(...BREAK_SCHEDULE.wed); else if(wd>=1&&wd<=5) segs.push(...BREAK_SCHEDULE.monTueThuFri);
  if(!segs.length) return totalSec;
  // 转成分钟便于重叠：休息段 start/end 分钟，同一天
  const startMin=Math.floor((segStart - dayStart)/60000);
  const nowMin=Math.floor((nowMs - dayStart)/60000);
  let deducted=0;
  for(const b of segs){
    // 与 [startMin, nowMin) 重叠
    const ovStart=Math.max(startMin, b.start);
    const ovEnd=Math.min(nowMin, b.end);
    if(ovEnd>ovStart){
      deducted += (ovEnd-ovStart)*60; // 秒
    }
  }
  const effective=Math.max(0, totalSec - deducted);
  return effective;
}

/* ==== 增量练琴写入节流 ==== */
const SYNC_INCREMENT_INTERVAL_MS=90000; // 90秒写云端一次（可调）
let lastIncrementSync=0;

/* ==== Snapshot 过期阈值 ==== */
const SNAPSHOT_STALE_MS=2*60*1000; // 2分钟

/* =============== 工具函数 =============== */
function addSyncLog(msg){const time=new Date().toLocaleString();syncLogs.unshift(`[${time}] ${msg}`);if(syncLogs.length>300)syncLogs.length=300;const box=document.getElementById('syncLogs');if(box) box.textContent=syncLogs.join('\n');}
function updateConnectionStatus(){const el=document.getElementById('connectionStatus');if(!el)return;if(isOnline){el.className='connection-status online';el.innerHTML='<span>'+t('status.online','已连接')+'</span>';}else{el.className='connection-status offline';el.innerHTML='<span>'+t('status.offline','离线模式')+'</span>';}}
function formatDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function initClock(){(function loop(){const now=new Date();const el=document.getElementById('currentTime');if(el)el.textContent=now.toLocaleString(currentLanguage==='zh'?'zh-CN':'en-US');setTimeout(loop,1000);})();}
function setText(id,v){const el=document.getElementById(id);if(el)el.textContent=v;}
function timeToMinutes(str){if(!str||typeof str!=='string')return 0;const p=str.split(':');if(p.length!==2)return 0;const h=parseInt(p[0],10),m=parseInt(p[1],10);if(isNaN(h)||isNaN(m))return 0;return h*60+m;}
function getTodayDateString(){return formatDate(new Date());}
function flattenStudents(){const arr=[];Object.keys(studentDatabase).forEach(major=>{const list=studentDatabase[major];if(Array.isArray(list)){list.forEach(s=>{if(typeof s==='string')arr.push({name:s,major});else if(s&&typeof s==='object')arr.push({name:s.name,major,grade:s.grade||''});});}});return arr;}
function getStudentInfo(name){for(const [major,arr] of Object.entries(studentDatabase)){if(Array.isArray(arr)){for(const s of arr){if(typeof s==='string'&&s===name)return {name,major,grade:''};if(typeof s==='object'&&s.name===name)return {name,major,grade:s.grade||''};}}}return {name,major:t('student.unknown_major','未知专业'),grade:''};}

// 将原始练琴区间裁剪到日窗口 (06:00 <= t < 21:30)，去除跨午夜残片与 21:30 以后部分
function clipPracticeIntervals(dateStr, intervals){
  if(!Array.isArray(intervals)||!intervals.length) return [];
  const dayStart=new Date(`${dateStr}T00:00:00`).getTime();
  const freezeMin = getTodayFreezeMinutes(new Date(dayStart));
  const winStart=dayStart + PRACTICE_DAY_START_MINUTES*60000;
  const winEnd  =dayStart + freezeMin*60000; // 动态截断
  const out=[];
  for(const iv of intervals){
    if(!iv||!iv.start||!iv.end) continue;
    let s=iv.start,e=iv.end;
    if(e<=winStart || s>=winEnd) continue; // 完全在窗口外
    if(s<winStart) s=winStart;
    if(e>winEnd)   e=winEnd;
    if(e-s>=1000) out.push({...iv,start:s,end:e});
  }
  return out;
}

/* ==== 休息时间剔除与统一计算 ==== */
function subtractExcludedFromIntervals(dateStr, intervals){
  if(!Array.isArray(intervals)||!intervals.length) return [];
  const result=[];
  const dayStart=new Date(`${dateStr}T00:00:00`).getTime();
  const wd=new Date(dateStr).getDay();
  const segs=[...BREAK_SCHEDULE.common];
  if(wd===3) segs.push(...BREAK_SCHEDULE.wed); else if(wd>=1&&wd<=5) segs.push(...BREAK_SCHEDULE.monTueThuFri);
  // (已移除夜间段: 21:30 以后直接不计入 raw，不再作为“剔除来源”)
  const exclude=segs.map(s=>({start:dayStart+s.start*60000,end:dayStart+s.end*60000}));
  intervals.forEach(iv=>{
    let parts=[{start:iv.start,end:iv.end}];
    exclude.forEach(ex=>{
      const next=[];
      parts.forEach(seg=>{
        if(seg.end<=ex.start || seg.start>=ex.end){ next.push(seg); }
        else {
          if(seg.start<ex.start) next.push({start:seg.start,end:ex.start});
          if(seg.end>ex.end) next.push({start:ex.end,end:seg.end});
        }
      });
      parts=next;
    });
    parts.forEach(seg=>{ if(seg.end-seg.start>=1000) result.push({...iv,start:seg.start,end:seg.end}); });
  });
  result.sort((a,b)=>a.start-b.start);
  const merged=[];let cur=result[0];
  for(let i=1;i<result.length;i++){const n=result[i];if(n.start<=cur.end+1000 && n.room===cur.room){cur.end=Math.max(cur.end,n.end);}else{merged.push(cur);cur=n;}}
  if(cur) merged.push(cur);
  return merged;
}

// 计算剔除来源明细：返回数组 [{labelKey,label,start,end,removedSec}]
function buildExcludedBreakdown(dateStr, rawIntervals){
  const d=new Date(dateStr+"T00:00:00");
  if(isNaN(d)) return [];
  const wd=d.getDay();
  let segs=[...BREAK_SCHEDULE.common];
  if(wd===3) segs.push(...BREAK_SCHEDULE.wed); else if(wd>=1&&wd<=5) segs.push(...BREAK_SCHEDULE.monTueThuFri);
  const dayStart=d.getTime();
  // 合并原始区间，避免重复累计（出现 20 -> 40 分钟等翻倍问题）
  const merged=(function(){
    if(!rawIntervals||!rawIntervals.length) return [];
    const arr=rawIntervals.slice().sort((a,b)=>a.start-b.start);
    const out=[{start:arr[0].start,end:arr[0].end}];
    for(let i=1;i<arr.length;i++){
      const last=out[out.length-1],cur=arr[i];
      if(cur.start<=last.end){ if(cur.end>last.end) last.end=cur.end; }
      else out.push({start:cur.start,end:cur.end});
    }
    return out;
  })();
  const breakAbs=segs.map(s=>({
    labelKey:s.labelKey,label:t(s.labelKey,s.labelKey),
    start:dayStart+s.start*60000,
    end:dayStart+s.end*60000,
    segMinutes:s.end-s.start
  }));
  // 夜间不再加入剔除统计（21:30 后不采集 / 已被裁剪）
  const result=[];
  breakAbs.forEach(seg=>{
    let removed=0;
    merged.forEach(iv=>{const s=Math.max(iv.start,seg.start);const e=Math.min(iv.end,seg.end); if(e>s) removed+=e-s;});
    if(removed>0){
      const removedSec=Math.floor(removed/1000);
      result.push({...seg,removedSec,mergedCount:merged.length});
      // 如果未达到整个休息段长度，记录调试提示
      const fullMs=seg.segMinutes*60000;
      if(removed<fullMs){
        console.debug('[ExcludedBreakdown][partial]', {date:dateStr,label:seg.labelKey,expectedMin:seg.segMinutes,actualMin:(removedSec/60).toFixed(2)});
      }
    }
  });
  return result.sort((a,b)=>a.start-b.start);
}
function getCleanedIntervals(studentName,dateStr){
  const isToday=dateStr===formatDate(new Date());
  let original = isToday? getStudentTodayIntervals(studentName): getHistoryIntervals(studentName,dateStr);
  // 过滤遗留 summary 重建伪区间：有 type inSlot/outSlot 且无 __sourceTag
  if(original && original.length){
    const before=original.length;
    original = original.filter(iv=>{
      if((iv.type==='inSlot'||iv.type==='outSlot') && !iv.__sourceTag){ return false; }
      return true;
    });
    if(before!==original.length){
      console.warn('[filter-summary-rebuild] removed legacy intervals', {student:studentName,date:dateStr,before,after:original.length});
    }
  }
  const clipped = clipPracticeIntervals(dateStr, original||[]);
  return {raw:clipped, cleaned: subtractExcludedFromIntervals(dateStr, clipped)};
}
function calcOverlapSeconds(intervals, slotStartMs, slotEndMs){
  if(!intervals||!intervals.length) return 0;
  const merged=[]; // merge overlapping parts inside slot window
  for(const iv of intervals){
    const st=Math.max(iv.start,slotStartMs);const en=Math.min(iv.end,slotEndMs);if(en<=st) continue;merged.push({start:st,end:en});
  }
  if(!merged.length) return 0;
  merged.sort((a,b)=>a.start-b.start);
  const stack=[merged[0]];
  for(let i=1;i<merged.length;i++){const cur=merged[i],last=stack[stack.length-1];if(cur.start<=last.end){last.end=Math.max(last.end,cur.end);}else stack.push(cur);} 
  let ms=0;stack.forEach(m=>ms+=m.end-m.start);
  const slotMs=slotEndMs-slotStartMs; if(ms>slotMs) ms=slotMs; return Math.floor(ms/1000);
}
// 计算区间并集秒数（避免重叠双计）
function calcUnionSeconds(intervals){
  if(!intervals||!intervals.length) return 0;
  const list=intervals.map(iv=>({start:iv.start,end:iv.end})).sort((a,b)=>a.start-b.start);
  let total=0;let cur=list[0];
  for(let i=1;i<list.length;i++){
    const n=list[i];
    if(n.start<=cur.end){ if(n.end>cur.end) cur.end=n.end; }
    else { total+=Math.max(0,cur.end-cur.start); cur={start:n.start,end:n.end}; }
  }
  total+=Math.max(0,cur.end-cur.start);
  return Math.floor(total/1000);
}
function computeDayInOut(studentName,dateStr){
  const {raw,cleaned}=getCleanedIntervals(studentName,dateStr);
  const __rawSource = (raw && raw.length && raw[0].__sourceTag) ? raw[0].__sourceTag : undefined;
  const wd=new Date(dateStr).getDay();
  const map={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};const key=map[wd];
  const slots=(key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key])? studentTimeSlots[studentName][key]:[];
  // 1) 计算段内秒(inSec)
  let inSec=0;const slotWindows=slots.map(sl=>({start:new Date(`${dateStr}T${sl.start}:00`).getTime(),end:new Date(`${dateStr}T${sl.end}:00`).getTime()}));
  slotWindows.forEach(sw=>{inSec+=calcOverlapSeconds(cleaned,sw.start,sw.end);});
  // 2) totalSec 使用 cleaned 区间并集（避免重叠）
  const totalSec=calcUnionSeconds(cleaned);
  // 3) 计算 outIntervals = cleaned 区间差集 slotWindows 并集
  function diffIntervals(base, subtract){
    if(!base.length) return [];
    const sub = (function(){
      if(!subtract.length) return [];
      const arr=[...subtract].sort((a,b)=>a.start-b.start);
      const merged=[{start:arr[0].start,end:arr[0].end}];
      for(let i=1;i<arr.length;i++){const last=merged[merged.length-1],cur=arr[i];if(cur.start<=last.end){ if(cur.end>last.end) last.end=cur.end; } else merged.push({start:cur.start,end:cur.end});}
      return merged;
    })();
    if(!sub.length) return base.map(iv=>({start:iv.start,end:iv.end}));
    const result=[];
    base.forEach(iv=>{
      let segments=[{start:iv.start,end:iv.end}];
      sub.forEach(rm=>{
        const next=[];segments.forEach(seg=>{
          if(seg.end<=rm.start || seg.start>=rm.end) { next.push(seg); }
          else {
            if(seg.start<rm.start) next.push({start:seg.start,end:rm.start});
            if(seg.end>rm.end) next.push({start:rm.end,end:seg.end});
          }
        });segments=next; if(!segments.length) return;});
      segments.forEach(sg=>{ if(sg.end-sg.start>=1000) result.push(sg); });
    });
    // merge result
    if(!result.length) return [];
    result.sort((a,b)=>a.start-b.start);
    const merged=[result[0]];for(let i=1;i<result.length;i++){const last=merged[merged.length-1],cur=result[i];if(cur.start<=last.end){ if(cur.end>last.end) last.end=cur.end; } else merged.push(cur);}return merged;
  }
  const cleanedUnion=(function(){ if(!cleaned.length) return []; const arr=cleaned.map(iv=>({start:iv.start,end:iv.end})).sort((a,b)=>a.start-b.start); const merged=[arr[0]]; for(let i=1;i<arr.length;i++){const last=merged[merged.length-1],cur=arr[i]; if(cur.start<=last.end){ if(cur.end>last.end) last.end=cur.end; } else merged.push(cur);} return merged; })();
  const outIntervals=diffIntervals(cleanedUnion,slotWindows).map(m=>({start:m.start,end:m.end,durationSec:Math.floor((m.end-m.start)/1000)}));
  const outSec=outIntervals.reduce((s,iv)=>s+iv.durationSec,0);
  // 一致性检查
  const expectOut=Math.max(0,totalSec-inSec);
  if(Math.abs(expectOut-outSec)>5){
    console.debug('[computeDayInOut][mismatch]', {student:studentName,date:dateStr,inSec,totalSec,outSec,expectOut,slots:slotWindows.length,cleaned:cleanedUnion});
  }
  if(wd>=1&&wd<=5 && totalSec>0 && slots.length===0){console.warn('[computeDayInOut] slots 缺失，全部成为段外', {student:studentName,date:dateStr,totalSec});}
  const breakdown=buildExcludedBreakdown(dateStr, raw);
  const rawUnionSec=calcUnionSeconds(raw);
  const cleanUnionSec=calcUnionSeconds(cleaned);
  const excludedSecUnion=Math.max(0,rawUnionSec-cleanUnionSec);
  return {inSec,outSec,totalSec,rawIntervals:raw,cleanIntervals:cleaned,excludedBreakdown:breakdown,outIntervals,excludedSecUnion,source:__rawSource};
}

// 调试：输出某学生某日原始/清洗区间与来源
window.debugStudentDayRaw = function(name,dateStr){
  try{
    const dio = computeDayInOut(name,dateStr);
    console.group(`[debugStudentDayRaw] ${name} ${dateStr}`);
    console.log('source', dio.source);
    console.log('rawIntervals', dio.rawIntervals);
    console.log('cleanIntervals', dio.cleanIntervals);
    console.log('outIntervals', dio.outIntervals);
    console.log('excludedBreakdown', dio.excludedBreakdown);
    console.log('inSec/outSec/totalSec', dio.inSec, dio.outSec, dio.totalSec);
    console.groupEnd();
    return dio;
  }catch(e){console.error('[debugStudentDayRaw] error', e);}
}

// 显示某日剔除来源明细
function createCenterModal(contentHTML, title){
  // 若已有同类型 modal 先移除
  const existing=document.querySelector('.center-pop-modal-overlay');
  if(existing) existing.remove();
  const overlay=document.createElement('div');
  overlay.className='center-pop-modal-overlay';
  overlay.innerHTML=`<div class="center-pop-modal" role="dialog" aria-modal="true">\n    <button class='close-btn' aria-label='close'>&times;</button>\n    <h4>${title}</h4>\n    <div class='center-pop-modal-body'>${contentHTML}</div>\n  </div>`;
  document.body.appendChild(overlay);
  requestAnimationFrame(()=>overlay.classList.add('show'));
  const close=()=>{overlay.classList.remove('show');setTimeout(()=>overlay.remove(),180);} ;
  overlay.addEventListener('click',e=>{ if(e.target===overlay) close(); });
  overlay.querySelector('.close-btn').addEventListener('click',close);
  document.addEventListener('keydown',function esc(e){ if(e.key==='Escape'){close();document.removeEventListener('keydown',esc);} });
  
  // 🔧 修复：返回模态框内容容器，以便外部可以操作
  const modal = overlay.querySelector('.center-pop-modal');
  return modal;
}
function showExcludedBreakdown(_anchor,dateStr){
  const name=window.__currentDetailStudent||''; if(!name) return;
  try{
    const dio=computeDayInOut(name,dateStr);const list=dio.excludedBreakdown||[];
  const totalMin=Math.round((dio.excludedSecUnion/60)*10)/10;
  const rows=list.map(seg=>{const start=new Date(seg.start),end=new Date(seg.end);const fmt=(d)=>`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;let mm=Math.round(seg.removedSec/60*10)/10; if(Math.abs(mm-Math.round(mm))<0.05) mm=Math.round(mm);return `<tr><td>${t(seg.labelKey,seg.label)}</td><td style='white-space:nowrap;'>${fmt(start)} - ${fmt(end)}</td><td style='text-align:right;'>${mm}min</td></tr>`;}).join('') || `<tr><td colspan='3' style='text-align:center;color:#888;'>0</td></tr>`;
  const note=`<div style='font-size:12px;line-height:1.5;margin:0 0 8px;color:#888;'>说明：剔除时间 = 课间 / 大课间 / 午餐${t('break.short.lunch_concert','午餐时间+午间音乐会')?'/午间音乐会':''} / 晚餐 等不计入练琴统计的时间。<br>本日剔除合计：<b>${totalMin} min</b></div>`;
  createCenterModal(`${note}<table>${rows}</table>`, `${dateStr} ${t('break.excluded_minutes','剔除分钟')}`);
  }catch(e){console.error('showExcludedBreakdown error',e);}
}
function showOutSlotBreakdown(_anchor,dateStr){
  const name=window.__currentDetailStudent||''; if(!name) return;
  try{
    const dio=computeDayInOut(name,dateStr);const list=dio.outIntervals||[];
    const rows=list.map(iv=>{const s=new Date(iv.start),e=new Date(iv.end);const fmt=(d)=>`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;const mm=Math.round(iv.durationSec/60*10)/10;return `<tr><td>${fmt(s)} - ${fmt(e)}</td><td style='text-align:right;'>${mm%1===0?mm:mm.toFixed(1)}min</td></tr>`;}).join('') || `<tr><td colspan='2' style='text-align:center;color:#888;'>0</td></tr>`;
    createCenterModal(`<table>${rows}</table>`, `${dateStr} ${t('practice.out_slot_segments','段外练琴区间')}`);
  }catch(e){console.error('showOutSlotBreakdown error',e);}
}


/* =============== 模态框优化控制（增强版：支持外部点击、下滑关闭和丝滑向下关闭） =============== */

// 🔥 全局变量：触摸相关
let modalTouchStartY = 0;
let modalTouchStartTime = 0;
let modalInitialScrollTop = 0;
let isModalDragging = false;
let modalTouchStartX = 0;

function closeModal(id) {
  const ids = id ? [id] : ['studentDetailModal', 'attendanceDetailModal'];
  let closed = false;
  let maxDelay = 0;
  ids.forEach(cid => {
    const el = document.getElementById(cid);
    if (el && el.classList.contains('show')) {
      el.classList.remove('show');
      el.classList.add('hiding');
      const isMobile = window.innerWidth <= 768;
      const delay = isMobile ? 200 : 180;
      if (delay > maxDelay) maxDelay = delay;
      setTimeout(() => {
        el.style.display = 'none';
        el.classList.remove('hiding');
        cleanupModalEventListeners(el);
        const modalContent = el.querySelector('.modal-content');
        if (modalContent) modalContent.style.cssText = '';
        el.style.cssText = '';
      }, delay);
      closed = true;
    }
  });
  if (closed) {
    // 仅当没有其它仍在显示/关闭动画中的模态框时才恢复 body，避免叠加关闭出现闪烁
    setTimeout(() => {
      const anyActive = Array.from(document.querySelectorAll('.modal'))
        .some(m => m.classList.contains('show') || m.classList.contains('hiding'));
      if (!anyActive) {
        document.body.classList.remove('modal-open');
        if (document.body.dataset.scrollY) {
          const scrollY = document.body.dataset.scrollY;
          document.body.style.cssText = '';
          window.scrollTo(0, parseInt(scrollY));
          delete document.body.dataset.scrollY;
        }
      }
    }, maxDelay + 20); // 等待最长关闭动画结束
  }
}

// 🔥 增强版：支持iOS风格下拉手势关闭
function setupModalEventListeners(modal) {
    const modalContent = modal.querySelector('.modal-content');
    
    // 外部点击关闭
    const handleBackdropClick = (e) => {
        if (e.target === modal) {
            closeModal(modal.id);
        }
    };
    
    // ESC键关闭
    const handleKeyDown = (e) => {
        if (e.key === 'Escape') {
            closeModal(modal.id);
        }
    };
    
    // 🔥 iOS风格下拉手势关闭
    let touchStartY = 0;
    let touchStartTime = 0;
    let isDragging = false;
    let initialModalTop = 0;
    
    const handleTouchStart = (e) => {
        if (!modalContent.contains(e.target)) return;
        
        const modalTop = modalContent.scrollTop;
        // 只有在模态框内容滚动到顶部时才开始下拉检测
        if (modalTop > 0) return;
        
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
        isDragging = false;
        initialModalTop = 0;
        
        modalContent.style.transition = 'none';
    };
    
    const handleTouchMove = (e) => {
        if (!modalContent.contains(e.target)) return;
        if (modalContent.scrollTop > 0) return;
        
        const currentY = e.touches[0].clientY;
        const deltaY = currentY - touchStartY;
        
        // 只响应向下拖拽
        if (deltaY > 10) {
            isDragging = true;
            e.preventDefault(); // 防止页面滚动
            
            // iOS风格阻尼效果：下拉距离随着拖拽距离增加而减缓
            const dampedDelta = Math.pow(deltaY * 0.6, 0.8);
            const scale = Math.max(0.95, 1 - dampedDelta * 0.0003);
            const opacity = Math.max(0.3, 1 - dampedDelta * 0.002);
            
            modalContent.style.transform = `translateY(${dampedDelta}px) scale(${scale})`;
            modal.style.backgroundColor = `rgba(0, 0, 0, ${0.5 * opacity})`;
        }
    };
    
    const handleTouchEnd = (e) => {
        if (!isDragging) return;
        
        const currentY = e.changedTouches[0].clientY;
        const deltaY = currentY - touchStartY;
        const deltaTime = Date.now() - touchStartTime;
        const velocity = deltaY / deltaTime; // px/ms
        
        // iOS风格关闭判断：下拉距离 > 120px 或 速度 > 0.5px/ms
        const shouldClose = deltaY > 120 || velocity > 0.5;
        
        if (shouldClose) {
            // 触发关闭动画
            closeModal(modal.id);
        } else {
            // 回弹到原位
            modalContent.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            modalContent.style.transform = 'translateY(0) scale(1)';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            // 清理过渡效果
            setTimeout(() => {
                modalContent.style.transition = '';
            }, 300);
        }
        
        isDragging = false;
    };
    
    // 添加事件监听器
    modal.addEventListener('click', handleBackdropClick);
    document.addEventListener('keydown', handleKeyDown);
    
    // 🔥 添加触摸事件（仅移动端）
    if ('ontouchstart' in window) {
        modalContent.addEventListener('touchstart', handleTouchStart, { passive: false });
        modalContent.addEventListener('touchmove', handleTouchMove, { passive: false });
        modalContent.addEventListener('touchend', handleTouchEnd, { passive: false });
    }
    
    // 🔥 存储事件处理器引用
    modal._eventHandlers = {
        handleBackdropClick,
        handleKeyDown,
        handleTouchStart,
        handleTouchMove,
        handleTouchEnd
    };
}


// openModalSmooth 和 cleanupModalEventListeners 函数保持不变
function openModalSmooth(modalId, contentHtml) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    if (contentHtml) {
        modal.querySelector('.modal-content').innerHTML = contentHtml;
    }
    
    if (!document.body.classList.contains('modal-open')) {
        const scrollY = window.scrollY;
        document.body.dataset.scrollY = scrollY;
        document.body.style.cssText = `
            position: fixed !important;
            top: -${scrollY}px !important;
            width: 100% !important;
            overflow: hidden !important;
        `;
    }
    document.body.classList.add('modal-open');
    
    modal.style.display = 'flex';
    setupModalEventListeners(modal);
    
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            modal.classList.add('show');
        });
    });
}

function cleanupModalEventListeners(modal) {
    if (!modal._eventHandlers) return;
    
    const {
        handleBackdropClick,
        handleKeyDown,
        handleTouchStart,
        handleTouchMove,
        handleTouchEnd
    } = modal._eventHandlers;
    
    const modalContent = modal.querySelector('.modal-content');
    
    modal.removeEventListener('click', handleBackdropClick);
    document.removeEventListener('keydown', handleKeyDown);
    
    // 🔥 清理触摸事件
    if (modalContent && 'ontouchstart' in window) {
        modalContent.removeEventListener('touchstart', handleTouchStart);
        modalContent.removeEventListener('touchmove', handleTouchMove);
        modalContent.removeEventListener('touchend', handleTouchEnd);
    }
    
    delete modal._eventHandlers;
    
    // 🔥 清理样式
    modal.style.transition = '';
    modal.style.backgroundColor = '';
    if (modalContent) {
        modalContent.style.transition = '';
        modalContent.style.transform = '';
        modalContent.style.opacity = '';
    }
}


/* =============== Firebase 初始化与监听 =============== */
function initFirebase(){
  try{
    firebase.initializeApp(firebaseConfig);
    database=firebase.database();
    database.ref('.info/connected').on('value',snap=>{
      isOnline=snap.val()===true;
      updateConnectionStatus();
      if(isOnline){addSyncLog('✅ 已连接云端');loadAllCoreData();}else addSyncLog('⚠️ 已离线');
    });
    database.ref('rooms').on('value',snap=>{
      const v=snap.val();if(Array.isArray(v)){rooms=v;buildRealTimePracticeFromRooms();if(currentTab==='dashboard')renderPracticeArea();updateStatsPanel();}
    });
    database.ref('studentDatabase').on('value',snap=>{
      const v=snap.val();if(v){studentDatabase=v;populateFilters();if(currentTab==='students')renderStudentList();updateStatsPanel();}
    });
    database.ref('excuseData').on('value',snap=>{
      const v=snap.val();if(v){excuseData=v;if(currentTab==='dashboard')renderExcusePanel();updateStatsPanel();}
    });
    database.ref('studentTimeSlots').on('value',snap=>{
      const raw = snap.val()||{};
      const beforeCnt = Object.values(raw).reduce((sum,s)=>sum + (s&&s.monday? s.monday.length:0)+(s&&s.tuesday? s.tuesday.length:0)+(s&&s.wednesday? s.wednesday.length:0)+(s&&s.thursday? s.thursday.length:0)+(s&&s.friday? s.friday.length:0),0);
      studentTimeSlots = normalizeStudentTimeSlots(raw);
      const afterCnt = Object.values(studentTimeSlots).reduce((sum,s)=>sum + (s&&s.monday? s.monday.length:0)+(s&&s.tuesday? s.tuesday.length:0)+(s&&s.wednesday? s.wednesday.length:0)+(s&&s.thursday? s.thursday.length:0)+(s&&s.friday? s.friday.length:0),0);
      addSyncLog(`📥 已同步 studentTimeSlots (归一化 ${beforeCnt} -> ${afterCnt})`);
      // 如果学生详情已开并存在段外异常（初次为空），尝试刷新
      const modal=document.getElementById('studentDetailModal');
      if(modal&&modal.style.display==='flex'){
        // 取标题里的姓名（格式: name - 学生详情）
        const title=document.getElementById('studentDetailTitle');
        if(title){
          const nm=title.textContent.split(' - ')[0];
          if(nm){
            console.log('[studentTimeSlots] refresh detail for',nm);
            openStudentDetail(nm);
          }
        }
      }
  // 🔥 修复：学生时间段同步后立即刷新统计（解决首屏缺少 timeSlots 导致的出勤/状态错误）
  updateStatsPanel();
    });
    database.ref('attendanceRecords').on('value',snap=>{
      const v=snap.val();if(v&&typeof v==='object'){const cutoff=new Date();cutoff.setDate(cutoff.getDate()-30);const cutoffStr=formatDate(cutoff);Object.keys(v).forEach(d=>{if(d>=cutoffStr)attendanceRecordsCache[d]=v[d];});addSyncLog('📥 已同步考勤记录');if(currentTab==='students')renderStudentList();}
    });
    database.ref('practiceRecords').on('value',snap=>{
      const v=snap.val();if(v&&typeof v==='object'){Object.keys(v).forEach(dateKey=>{if(!dailyPracticeRecords[dateKey])dailyPracticeRecords[dateKey]={};Object.keys(v[dateKey]).forEach(student=>{const cloud=v[dateKey][student];const local=dailyPracticeRecords[dateKey][student];if(!local||cloud.lastUpdated>local.lastUpdated){dailyPracticeRecords[dateKey][student]=cloud;try{localStorage.setItem('practiceRecords_'+dateKey,JSON.stringify(dailyPracticeRecords[dateKey]));}catch(e){}}});});addSyncLog('📥 已同步练琴记录');}
  try{ setLeaderboardDirty(); }catch(e){}
    });

    // 定期清理过期本地缓存
    setInterval(()=>{
      const cutoff=new Date();cutoff.setDate(cutoff.getDate()-30);const cut=formatDate(cutoff);
      Object.keys(attendanceRecordsCache).forEach(d=>{if(d<cut)delete attendanceRecordsCache[d];});
      Object.keys(dailyPracticeRecords).forEach(d=>{if(d<cut){delete dailyPracticeRecords[d];localStorage.removeItem('practiceRecords_'+d);}});
      addSyncLog('🧹 已清理过期数据');
    },24*60*60*1000);
  }catch(e){addSyncLog('❌ Firebase 初始化失败: '+e.message);console.error(e);}
}

/* =============== 练琴实时/会话 =============== */
function buildRealTimePracticeFromRooms(){
  const now=Date.now(),map={},active=new Set();
  rooms.forEach(r=>{
    if(r&&r.student&&r.registerTime){
      const reg=Number(r.registerTime);
      if(!isNaN(reg)&&reg>0&&(now-reg)<12*3600*1000){
        const sec=Math.max(0,Math.floor((now-reg)/1000));
        map[r.student]={room:r.name,startTime:reg,currentSec:sec};
        const sid=`${r.student}__${r.name}__${r.registerTime}`;
        active.add(sid);
        if(!practiceSessionTracker.has(sid)) startPracticeSession(r.student,r.name,r.registerTime);
      }
    }
  });
  for(const [sid,sess] of practiceSessionTracker.entries()){
    if(!active.has(sid)) endPracticeSession(sid,Date.now(),'房间释放');
  }
  realTimePracticeMap=map;
}
function getStudentTodaySlots(name){
  const wd=new Date().getDay();
  const M={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const key=M[wd];if(!key||!studentTimeSlots[name])return [];
  return studentTimeSlots[name][key]||[];
}
// 🔧 统一时间格式 -> 合并重叠/相邻 -> 去重 -> 重新计算分钟
function normalizeStudentTimeSlots(raw){
  if(!raw||typeof raw!=="object") return raw;
  const dayKeys=['monday','tuesday','wednesday','thursday','friday'];
  const pad=t=>t.replace(/^\s+/,'').replace(/\s+$/,'').split(':').map(x=>x.padStart(2,'0')).join(':');
  function normList(list){
    if(!Array.isArray(list)) return [];
    // 1. 规范化 start/end
    const arr=list.map(s=>({
      name: s.name || `${s.start||''}-${s.end||''}`,
      start: pad(String(s.start||'')),
      end: pad(String(s.end||''))
    })).filter(s=>/^\d{2}:\d{2}$/.test(s.start)&&/^\d{2}:\d{2}$/.test(s.end)&&s.start<s.end);
    // 2. 转为分钟并排序
    const items=arr.map(s=>({
      name:s.name,
      sm: timeToMinutes(s.start),
      em: timeToMinutes(s.end)
    })).sort((a,b)=>a.sm-b.sm || a.em-b.em);
    // 3. 合并
    const merged=[];
    for(const it of items){
      const last=merged[merged.length-1];
      if(!last){merged.push({...it});continue;}
      if(it.sm<=last.em){ // 重叠或相邻（如 480 与 480, 也合并）
        if(it.em>last.em) last.em=it.em;
      }else{
        merged.push({...it});
      }
    }
    // 4. 生成最终结构并计算 totalPlannedMinutes
    return merged.map(m=>({
      start: minutesToHHMM(m.sm),
      end: minutesToHHMM(m.em),
      totalPlannedMinutes: m.em - m.sm
    }));
  }
  function minutesToHHMM(m){
    const hh=String(Math.floor(m/60)).padStart(2,'0');
    const mm=String(m%60).padStart(2,'0');
    return `${hh}:${mm}`;
  }
  const out={};
  Object.keys(raw).forEach(student=>{
    const conf=raw[student];
    if(!conf||typeof conf!=='object'){ out[student]=conf; return; }
    out[student]={};
    dayKeys.forEach(d=>{
      if(conf[d]) out[student][d]=normList(conf[d]);
    });
  });
  return out;
}
function findCurrentTimeSlot(slots,ts){
  const d=new Date(ts);
  const m=d.getHours()*60+d.getMinutes();
  const weekday = d.getDay(); // 0=周日, 1=周一, ..., 6=周六
  
  // 检查是否在排除时间内
  if (isExcludedTime(m, weekday)) {
    return null; // 排除时间不算在时间段内
  }
  
  return slots.find(s=>{const sm=timeToMinutes(s.start),em=timeToMinutes(s.end);return m>=sm&&m<em;})||null;
}

// 🔥 判断是否为排除时间的函数（已有）
function isExcludedTime(minutes, weekday, dateObj=new Date()) {
  // 动态冻结：超过当日冻结时间一律排除
  const freezeMin = getTodayFreezeMinutes(dateObj);
  if (minutes >= freezeMin) return true;
  // 用餐等固定排除（保持原逻辑）
  if (weekday === 1 || weekday === 2 || weekday === 4 || weekday === 5) {
    if (minutes >= 12 * 60 && minutes < 13 * 60) return true; // 午餐
    if (minutes >= 18 * 60 && minutes < 19 * 60) return true; // 晚餐
  }
  if (weekday === 3) {
    if (minutes >= 12 * 60 && minutes < 13 * 60 + 30) return true; // 午餐+音乐会
    if (minutes >= 18 * 60 + 30 && minutes < 19 * 60 + 30) return true; // 晚餐
  }
  return false;
}

// ================= 诊断：检测是否仍有冻结后分钟进入统计 =================
function debugFreezeOverflow(targetDateStr=formatDate(new Date())){
  try{
    const dateObj=new Date(targetDateStr+"T00:00:00");
    if(isNaN(dateObj)) { console.warn('[debugFreezeOverflow] 日期无效', targetDateStr); return; }
    const freezeMin=getTodayFreezeMinutes(dateObj);
    const dayStart=dateObj.getTime();
    const dayEnd=dayStart+24*60*60*1000;
    const offenders=[];
    const students=flattenStudents().map(s=>s.name);
    students.forEach(stu=>{
      // 获取原始区间（未剔除休息但已裁剪日窗口）
      const original=isTodayDate(targetDateStr)? getStudentTodayIntervals(stu): getHistoryIntervals(stu,targetDateStr);
      if(!original||!original.length) return;
      original.forEach(iv=>{
        const mStart=Math.floor((iv.start-dayStart)/60000);
        const mEnd=Math.floor((iv.end-dayStart)/60000);
        if(mEnd>freezeMin){
          // 若区间跨越冻结点，截断前半仍保留，但后半应被裁剪；记录违规部分
            const overStart=Math.max(freezeMin,mStart);
            if(overStart<mEnd){
              offenders.push({student:stu,room:iv.room,start:new Date(iv.start).toLocaleTimeString('zh-CN',{hour12:false}),end:new Date(iv.end).toLocaleTimeString('zh-CN',{hour12:false}),overMinutes:mEnd-freezeMin,totalMinutes:mEnd-mStart});
            }
        }
      });
    });
    if(!offenders.length){
      console.info(`[debugFreezeOverflow] OK: ${targetDateStr} 无超过冻结(${freezeMin}min)的练琴片段`);
    }else{
      console.group(`[debugFreezeOverflow] 发现 ${offenders.length} 个超出冻结片段 @${targetDateStr} freeze=${freezeMin}`);
      offenders.slice(0,50).forEach(o=>console.warn(o));
      if(offenders.length>50) console.warn('...(更多省略)', offenders.length-50);
      console.groupEnd();
    }
    return offenders;
  }catch(e){console.error('[debugFreezeOverflow] 失败',e);}
}
function isTodayDate(str){
  const now=new Date();
  return str===formatDate(now);
}

// 🔥 按分钟分析会话时间分布
function analyzeSessionTimeDistribution(sess) {
  if (!sess.actualStartTime) {
    return {
      inSlotValid: 0,
      outSlotValid: 0,
      excludedTime: 0,
      breakdown: []
    };
  }
  
  const endTime = sess.endTime || Date.now();
  const startMin = Math.floor(sess.actualStartTime / 60000) * 60000;
  const endMin = Math.floor(endTime / 60000) * 60000;
  const slots = getStudentTodaySlots(sess.studentName);
  
  let inSlotValid = 0;
  let outSlotValid = 0;
  let excludedTime = 0;
  const breakdown = [];
  
  // 🔥 按分钟遍历分析
  for(let t = startMin; t < endMin; t += 60000) {
    const currentDate = new Date(t);
    const currentMinutes = currentDate.getHours() * 60 + currentDate.getMinutes();
    const currentWeekday = currentDate.getDay();
    const isExcluded = isExcludedTime(currentMinutes, currentWeekday);
    const slot = findCurrentTimeSlot(slots, t);
    
    const minuteInfo = {
      time: t,
      timeStr: currentDate.toLocaleTimeString('zh-CN', {hour12: false}).substring(0, 5),
      isExcluded,
      inSlot: !!slot,
      slotName: slot ? slot.name : null
    };
    
    if (isExcluded) {
      excludedTime += 60;
      minuteInfo.category = '排除时间';
    } else if (slot) {
      inSlotValid += 60;
      minuteInfo.category = '段内有效';
    } else {
      outSlotValid += 60;
      minuteInfo.category = '段外有效';
    }
    
    breakdown.push(minuteInfo);
  }
  
  return {
    inSlotValid,
    outSlotValid,
    excludedTime,
    breakdown
  };
}



// 🔥 统一的练琴会话创建函数
function startPracticeSession(student, room, registerTime){
  if(!student || !room) {
    console.error('创建练琴会话失败：学生名或房间名为空');
    return null;
  }
  
  const sid = `${student}__${room}__${registerTime}`;
  if(practiceSessionTracker.has(sid)) {
    console.log(`练琴会话已存在: ${sid}`);
    return practiceSessionTracker.get(sid);
  }
  
  const now = Date.now();
  const slots = getStudentTodaySlots(student);
  const cur = findCurrentTimeSlot(slots, now);
  
  const sess = {
    sessionId: sid,
    studentName: student,
    roomName: room,
    startTime: Number(registerTime) || now, // 🔥 确保是数字
    prepEndTime: (Number(registerTime) || now) + 60000,
    actualStartTime: null,
    endTime: null,
    inSlotTime: 0,        // 🔥 明确初始化为 0
    outSlotTime: 0,       // 🔥 明确初始化为 0
    currentSlot: cur,
    slotTransitions: [],
    isActive: true,
    _lastTick: now
  };
  
  practiceSessionTracker.set(sid, sess);
  console.log(`开始练琴会话: ${student} 在 ${room}`);
  return sess;
}


function endPracticeSession(sid, endTime, reason = '结束'){
  const sess = practiceSessionTracker.get(sid);
  if(!sess || !sess.isActive) return;
  
  sess.isActive = false;
  sess.endTime = Number(endTime) || Date.now(); // 🔥 确保是数字
  sess.endReason = reason;
  
  // 🔥 如果练琴时间太短（小于1分钟），直接删除不记录
  if(sess.endTime < sess.prepEndTime) {
    console.log(`练琴时间过短，不记录: ${sess.studentName}`);
    practiceSessionTracker.delete(sid);
    return;
  }
  
  // 🔥 设置实际开始时间
  if(!sess.actualStartTime) {
    sess.actualStartTime = sess.prepEndTime;
  }
  
  // 🔥 重新计算时长
  try {
    recalcSessionTimes(sess);
    
    // 🔥 最终验证
    if(isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
      console.error(`结束会话时发现NaN: ${sess.studentName}`);
      sess.inSlotTime = 0;
      sess.outSlotTime = 0;
    }
    
    // 🔥 只有有效时长才记录
    if(sess.inSlotTime > 0 || sess.outSlotTime > 0) {
      recordDailyPractice(sess);
    } else {
      console.log(`无有效练琴时长，不记录: ${sess.studentName}`);
    }
  } catch(e) {
    console.error(`结束会话时出错: ${sess.studentName}`, e);
  }
  
  practiceSessionTracker.delete(sid);
}

function recordDailyPractice(sess){
  try {
    const dk = formatDate(new Date(sess.startTime));
    
    // 🔥 验证输入数据
    if(!sess.studentName || !dk) {
      console.error('无效的会话数据:', sess);
      return;
    }
    
    // 🔥 验证时长数据
    let inSlotTime = Number(sess.inSlotTime) || 0;
    let outSlotTime = Number(sess.outSlotTime) || 0;
    
    if(isNaN(inSlotTime) || isNaN(outSlotTime)) {
      console.error(`时长数据为NaN: ${sess.studentName}, in=${sess.inSlotTime}, out=${sess.outSlotTime}`);
      inSlotTime = 0;
      outSlotTime = 0;
    }
    
    // 🔥 合理性检查（不超过24小时）
    const maxSeconds = 24 * 60 * 60;
    if(inSlotTime > maxSeconds || outSlotTime > maxSeconds) {
      console.error(`时长数据异常: ${sess.studentName}, in=${inSlotTime}, out=${outSlotTime}`);
      return;
    }
    
    // 🔥 如果时长为0，不记录
    if(inSlotTime === 0 && outSlotTime === 0) {
      console.log(`无有效时长，跳过记录: ${sess.studentName}`);
      return;
    }
    
    // 🔥 初始化数据结构
    if(!dailyPracticeRecords[dk]) {
      dailyPracticeRecords[dk] = {};
    }
    
    if(!dailyPracticeRecords[dk][sess.studentName]) {
      dailyPracticeRecords[dk][sess.studentName] = {
        inSlot: 0,
        outSlot: 0,
        totalSessions: 0,
        sessions: [],
        lastUpdated: 0
      };
    }
    
    const rec = dailyPracticeRecords[dk][sess.studentName];
    
    // 🔥 确保 sessions 数组存在
    if(!Array.isArray(rec.sessions)) {
      rec.sessions = [];
    }
    
    // 🔥 更新累计数据
    rec.inSlot = (Number(rec.inSlot) || 0) + inSlotTime;
    rec.outSlot = (Number(rec.outSlot) || 0) + outSlotTime;
    rec.totalSessions = (Number(rec.totalSessions) || 0) + 1;
    rec.lastUpdated = Date.now();
    
    // 🔥 添加会话记录
    rec.sessions.push({
      room: sess.roomName || t('room.practice_room', '练琴房'),
      start: sess.startTime || Date.now(),
      end: sess.endTime || Date.now(),
      inSlot: inSlotTime,
      outSlot: outSlotTime,
      endReason: sess.endReason || '正常'
    });
    
    // 🔥 保存到本地存储
    try {
      localStorage.setItem('practiceRecords_' + dk, JSON.stringify(dailyPracticeRecords[dk]));
  // 标记排行榜需要自动刷新
  try{ setLeaderboardDirty(); }catch(e){ console.debug('setLeaderboardDirty failed',e); }
    } catch(e) {
      console.error('保存本地存储失败:', e);
    }
    
    // 🔥 同步到云端
    if(isOnline && database) {
      const cloudData = {
        inSlotSeconds: Math.floor(rec.inSlot),
        outSlotSeconds: Math.floor(rec.outSlot),
        totalSessions: Math.floor(rec.totalSessions),
        sessions: rec.sessions,
        lastUpdated: rec.lastUpdated,
        running: false
      };
      
      // 🔥 最终NaN检查
      Object.keys(cloudData).forEach(key => {
        if(typeof cloudData[key] === 'number' && (isNaN(cloudData[key]) || !isFinite(cloudData[key]))) {
          console.error(`发现无效数值 ${key}: ${cloudData[key]}`);
          if(key === 'inSlotSeconds' || key === 'outSlotSeconds') {
            cloudData[key] = 0;
          } else if(key === 'totalSessions') {
            cloudData[key] = 1;
          } else if(key === 'lastUpdated') {
            cloudData[key] = Date.now();
          }
        }
      });
      
      database.ref(`practiceRecords/${dk}/${sess.studentName}`).set(cloudData)
        .then(() => {
          console.log(`云端同步成功: ${sess.studentName}, 段内${Math.round(inSlotTime/60)}分钟, 段外${Math.round(outSlotTime/60)}分钟`);
        })
        .catch(e => {
          console.error('云端同步失败:', e);
        });
    }
    
    addSyncLog(`📝 记录练琴: ${sess.studentName} 段内${Math.round(inSlotTime/60)}分钟 段外${Math.round(outSlotTime/60)}分钟`);
    
  } catch(e) {
    console.error('recordDailyPractice 出错:', e, sess);
  }
}

function getStudentPracticeRecord(name,dk){
  if(!dk)dk=getTodayDateString();
  if(dailyPracticeRecords[dk]&&dailyPracticeRecords[dk][name])return dailyPracticeRecords[dk][name];
  if(!dailyPracticeRecords[dk]){
    const raw=localStorage.getItem('practiceRecords_'+dk);
    if(raw){try{dailyPracticeRecords[dk]=JSON.parse(raw);}catch(e){dailyPracticeRecords[dk]={};}}
  }
  if(dailyPracticeRecords[dk]&&dailyPracticeRecords[dk][name])return dailyPracticeRecords[dk][name];
  // 触发一次异步获取（不阻塞）
  if(isOnline&&database){
    database.ref(`practiceRecords/${dk}/${name}`).once('value').then(s=>{
      const v=s.val();if(v){if(!dailyPracticeRecords[dk])dailyPracticeRecords[dk]={};dailyPracticeRecords[dk][name]=v;
        try{localStorage.setItem('practiceRecords_'+dk,JSON.stringify(dailyPracticeRecords[dk]));}catch(e){}
      }
    });
  }
  return {inSlot:0,outSlot:0,totalSessions:0,sessions:[],lastUpdated:0};
}
function estimateLiveSessionInOut(sess){
  if(!sess.isActive)return null;
  const now=Date.now();if(now<sess.prepEndTime)return {tempIn:0,tempOut:0};
  const baseIn=sess.inSlotTime,baseOut=sess.outSlotTime;
  let extra=0;
  if(sess._lastTick){
    const dt=Math.floor((now-sess._lastTick)/1000);
    if(dt>0&&dt<900)extra=dt;
  }
  const cur=findCurrentTimeSlot(getStudentTodaySlots(sess.studentName),now);
  if(cur)return {tempIn:baseIn+extra,tempOut:baseOut};
  return {tempIn:baseIn,tempOut:baseOut+extra};
}

/* =============== ✅ 实时考勤增强：增量练琴时长同步 =============== */
// 🔥 修复 5: 增强 syncActiveSessionsIncrement 函数
function syncActiveSessionsIncrement(){
  const now = Date.now();
  if(now - lastIncrementSync < SYNC_INCREMENT_INTERVAL_MS) return;
  lastIncrementSync = now;
  const today = getTodayDateString();
  
  practiceSessionTracker.forEach(sess => {
    if(!sess.isActive) return;
    if(Date.now() < sess.prepEndTime) return;
    
    try {
      // 🔥 临时计算当前时长
      const tempEndTime = sess.endTime;
      sess.endTime = now;
      recalcSessionTimes(sess);
      sess.endTime = tempEndTime; // 恢复原值
      
      // 🔥 验证计算结果
      if(isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
        console.error(`增量同步时发现NaN: ${sess.studentName}`);
        return;
      }
      
      if(!dailyPracticeRecords[today]) {
        dailyPracticeRecords[today] = {};
      }
      
      if(!dailyPracticeRecords[today][sess.studentName]) {
        dailyPracticeRecords[today][sess.studentName] = {
          inSlot: 0,
          outSlot: 0,
          totalSessions: 0,
          sessions: [],
          lastUpdated: 0
        };
      }
      
      const rec = dailyPracticeRecords[today][sess.studentName];
      
      // 🔥 更新累计时长
      rec.inSlot = Math.max(0, Math.floor(sess.inSlotTime));
      rec.outSlot = Math.max(0, Math.floor(sess.outSlotTime));
      rec.lastUpdated = now;
      
      // 🔥 保存到本地
      try {
        localStorage.setItem('practiceRecords_' + today, JSON.stringify(dailyPracticeRecords[today]));
      } catch(e) {
        console.error('增量同步本地存储失败:', e);
      }
      
      // 🔥 同步到云端
      if(isOnline && database) {
        const updateData = {
          inSlotSeconds: rec.inSlot,
          outSlotSeconds: rec.outSlot,
          lastUpdated: rec.lastUpdated,
          totalSessions: rec.totalSessions || 0,
          running: true
        };
        
        // 🔥 验证数据
        Object.keys(updateData).forEach(key => {
          if(typeof updateData[key] === 'number' && (isNaN(updateData[key]) || !isFinite(updateData[key]))) {
            console.error(`增量同步发现无效数值 ${key}: ${updateData[key]}`);
            updateData[key] = 0;
          }
        });
        
        database.ref(`practiceRecords/${today}/${sess.studentName}`).update(updateData)
          .catch(e => console.error('增量同步失败:', e));
      }
      
    } catch(e) {
      console.error(`增量同步出错: ${sess.studentName}`, e);
    }
  });
}
/* =============== 出勤状态 / 统计 =============== */
function shouldStudentBePresent(name,wd,curMin){
  if(wd===0||wd===6)return false;
  const map={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const key=map[wd];
  if(!key||!studentTimeSlots[name]||!studentTimeSlots[name][key])return false;
  return studentTimeSlots[name][key].some(s=>{
    const sm=timeToMinutes(s.start),em=timeToMinutes(s.end);
    return curMin>=sm&&curMin<em;
  });
}
function getStudentCurrentStatus(name,presentSet,excuses,wd,curMin){
  // 语义：
  // present: 在规定时间段内练琴
  // absent: 在规定时间段内但未练琴
  // practicing-unscheduled: 不在规定时间段内但在练琴（自主练琴）
  // not-practicing: 不在规定时间段内且未练琴
  // excused: 请假优先级最高
  if(excuses[name]) return 'excused';
  const practicing = presentSet.has(name);
  const map={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const key=map[wd];
  let inSlot=false;
  if(key && studentTimeSlots[name] && studentTimeSlots[name][key]){
    inSlot = studentTimeSlots[name][key].some(sl=>{
      const sm=timeToMinutes(sl.start),em=timeToMinutes(sl.end);
      return curMin>=sm && curMin<em;
    });
  }
  if(inSlot){
    return practicing ? 'present' : 'absent';
  } else {
    return practicing ? 'practicing-unscheduled' : 'not-practicing';
  }
}
function getStatusClass(s){
  switch(s){
    case 'present':return 'present';
    case 'absent':return 'absent';
    case 'excused':return 'excused';
    case 'practicing-unscheduled':return 'self-practice'; // 改为紫色类
    case 'not-practicing':return 'not-practicing';
    default:return 'pending';
  }
}
function getStatusText(s){
  switch(s){
    case 'present':return t('status.present','出勤');
    case 'absent':return t('status.absent','缺勤');
    case 'excused':return t('status.excused','请假');
    case 'practicing-unscheduled':return t('status.practicing_unscheduled','自主练琴');
    case 'not-practicing':return t('status.not_practicing','未练琴');
    default:return t('status.pending','待考勤');
  }
}
function updateStatsPanel(){
  // 🔒 数据就绪保护：若关键数据尚未同步，避免首屏误判
  if(!studentDatabase || Object.keys(studentDatabase).length===0) return;
  // 至少等待 studentTimeSlots 首次加载（防止所有学生误判为缺勤/未练琴）
  if(!studentTimeSlots || Object.keys(studentTimeSlots).length===0) return;
  const students=flattenStudents();
  const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
  const today=formatDate(new Date());
  const excuses=excuseData[today]||{};
  const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
  let present=0,absent=0,excused=0,selfPractice=0;
  let excludedTotalSec=0;
  students.forEach(s=>{
    const st=getStudentCurrentStatus(s.name,presentSet,excuses,wd,curMin);
    if(st==='present')present++;
    else if(st==='absent')absent++;
    else if(st==='excused')excused++;
    else if(st==='practicing-unscheduled')selfPractice++;
    // 聚合今日剔除秒 (仅对有记录的学生尝试)
    try{
      const dio=computeDayInOut(s.name,today);
      if(dio && typeof dio.excludedSecUnion==='number') excludedTotalSec+=dio.excludedSecUnion;
    }catch(_e){}
  });
  setText('presentCount',present);
  setText('absentCount',absent);
  setText('excusedCount',excused);
  setText('pendingCount',selfPractice);
  const excludedMin=Math.round(excludedTotalSec/60);
  const excludedElId='excludedMinutesStat';
  let statHost=document.getElementById(excludedElId);
  if(!statHost){
    const container=document.getElementById('statsPanel');
    if(container){
      const div=document.createElement('div');div.className='stat-card';div.id=excludedElId;container.appendChild(div);statHost=div;
    }
  }
  if(statHost){ statHost.textContent=t('break.excluded_minutes','剔除分钟')+': '+excludedMin; }
}

/* =============== 实时练琴列表 =============== */
function formatDuration(sec, mode='auto'){
  // mode = 'auto' | 'minuteOnly'
  if(sec==null || isNaN(sec)) return currentLanguage==='en' ? '0min' : '0分钟';
  sec = Math.max(0, Math.floor(sec)); // 统一转为整数秒
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;

  if(currentLanguage === 'en'){
    if(h){
      if(m) return `${h}h ${m}m`;
      return `${h}h`;
    }
    if(m){
      if(s && mode!=='minuteOnly') return `${m}m ${s}s`;
      return `${m}m`;
    }
    return `${s}s`;
  }else{
    if(h){
      if(m) return `${h}小时${m}分钟`;
      return `${h}小时`;
    }
    if(m){
      if(s && mode!=='minuteOnly') return `${m}分钟${s}秒`;
      return `${m}分钟`;
    }
    return `${s}秒`;
  }
}

function renderPracticeArea(){
  const el=document.getElementById('practiceStatusContainer');if(!el)return;
  const names=Object.keys(realTimePracticeMap);
  if(!names.length){
    el.innerHTML=`<div class="practice-filters"><div class="practice-filter-row">
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.major','专业筛选')}</label>
      <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
        <option value="">${t('filter.all_majors','所有专业')}</option></select></div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.grade','年级筛选')}</label>
      <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
        <option value="">${t('filter.all_grades','所有年级')}</option></select></div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.search','搜索学生')}</label>
      <input id="practiceStudentSearch" class="practice-filter-input" placeholder="${t('filter.search_placeholder','输入学生姓名...')}" oninput="filterPracticeStatus()"></div>
    </div>
    <div id="practiceStudentList" class="student-grid" style="margin-top:20px;">
      <div class="practice-empty-state" style="grid-column:1/-1;">
        <div class="practice-empty-state-icon">🎵</div>
        <div class="practice-empty-state-title">${t('practice.empty.title','当前没有学生在练琴')}</div>
        <div class="practice-empty-state-description">${t('practice.empty.desc.weekday','等待学生开始练琴')}</div>
      </div>
    </div></div>`;
    return;
  }
  names.sort((a,b)=>realTimePracticeMap[b].currentSec-realTimePracticeMap[a].currentSec);
  const majors=new Set(),grades=new Set();
  names.forEach(n=>{const info=getStudentInfo(n);if(info.major)majors.add(info.major);if(info.grade)grades.add(info.grade);});
  let mf=[...majors].sort().map(m=>`<option value="${m}">${m}</option>`).join('');
  let gf=[...grades].sort().map(g=>`<option value="${g}">${g}</option>`).join('');
  let cards=names.map(n=>{
      const info=getStudentInfo(n),p=realTimePracticeMap[n];
      const st=new Date(p.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'});
      // 🔥 获取当前时间信息用于状态判断
      const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
      const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
      const todayExcuses=excuseData[getTodayDateString()]||{};
      const currentStatus=getStudentCurrentStatus(n,presentSet,todayExcuses,wd,curMin);
      const statusText=getDetailedStatusText(n,currentStatus,p,wd,curMin);
      const statusClass=getStatusClass(currentStatus);
          const br=currentBreakInfo(now);
          const breakBadge = br ? `<div class=\"break-badge\" data-break=\"1\" data-label-key=\"${br.labelKey}\" data-end-minute=\"${br.endMinute}\">${br.label}</div>` : '';
      
  const todayTotalMin = getTodayTotalPracticeMinutes(n);
  const todayTotalText = formatTotalPracticeTime(todayTotalMin);
  return `<div class="practice-status-card compact ${statusClass}" onclick="openStudentDetail('${n}')">
        <div class="practice-indicator"></div>
        <div class="compact-content">
          <div class="student-name-compact">${n}</div>
          <div class="student-info-row"><span>${info.major||''}</span><span class="info-divider">•</span><span>${info.grade||t('student.not_set','未设置')}</span></div>
          <div class="student-info-row"><span>🕐 ${st}</span><span class="info-divider">•</span><span>🏠 ${p.room}</span></div>
          <div class="status-duration-row">
            <div class="student-status-compact ${statusClass}">${statusText}</div>
            ${breakBadge}
            <div class="practice-duration-large" title="今日总计">${todayTotalText}</div>
          </div>
        </div></div>`;
    }).join('');
  el.innerHTML=`
  <div class="practice-filters">
    <div class="practice-filter-row">
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.major','专业筛选')}</label>
        <select id="practiceMajorFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
          <option value="">${t('filter.all_majors','所有专业')}</option>${mf}
        </select>
      </div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.grade','年级筛选')}</label>
        <select id="practiceGradeFilter" class="practice-filter-select" onchange="filterPracticeStatus()">
          <option value="">${t('filter.all_grades','所有年级')}</option>${gf}
        </select>
      </div>
      <div class="practice-filter-group"><label class="practice-filter-label">${t('filter.search','搜索学生')}</label>
        <input type="text" id="practiceStudentSearch" class="practice-filter-input" placeholder="${t('filter.search_placeholder','输入学生姓名...')}" oninput="filterPracticeStatus()">
      </div>
    </div>
    <div id="practiceStudentList" class="student-grid" style="margin-top:20px;">${cards}</div>
  </div>`;
}

// ===== 休息倒计时刷新 =====
function updateBreakCountdowns(){
  const badges=document.querySelectorAll('.break-badge[data-break="1"]');
  if(!badges.length) return;
  const now=new Date();
  const info=currentBreakInfo(now);
  badges.forEach(b=>{
    if(!info){ b.remove(); return; }
    const total=(info.endMinute-info.startMinute)*60; // 秒
    const remain=info.remainSec; // 秒
    const passed=Math.max(0,total-remain);
    const pct= total>0 ? Math.min(100,Math.max(0, (passed/total)*100)) : 0;
    const mm=Math.floor(remain/60),ss=remain%60;
    const label=t(info.labelKey,info.label);
    // 识别类型
    let type='recess';
    if(/lunch_concert/.test(info.labelKey)) type='concert';
    else if(/lunch/.test(info.labelKey)) type='lunch';
    else if(/large/.test(info.labelKey)) type='large';
    else if(/recess/.test(info.labelKey)) type='recess';
    b.dataset.breakType=type;
    // 构造内部结构（若第一次）
    if(!b._enhanced){
      b.innerHTML=`<div class="bb-head"><span class="bb-icon">⏱️</span><span class="bb-title"></span><span class="bb-remain"></span></div><div class="bb-line"><div class="bb-fill"></div></div>`;
      b._enhanced=true;
    }
    const titleEl=b.querySelector('.bb-title');
    const remainEl=b.querySelector('.bb-remain');
    const fillEl=b.querySelector('.bb-fill');
    if(titleEl) titleEl.textContent=label;
    if(remainEl){
      remainEl.textContent=`${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
      remainEl.classList.toggle('urgent', remain<=60);
    }
    if(fillEl){ fillEl.style.width=pct.toFixed(1)+'%'; }
  });
}
setInterval(()=>{
  try{updateBreakCountdowns();}catch(e){console.warn('updateBreakCountdowns error',e);}
},1000);
function filterPracticeStatus(){
  const major=document.getElementById('practiceMajorFilter')?.value||'';
  const grade=document.getElementById('practiceGradeFilter')?.value||'';
  const kw=document.getElementById('practiceStudentSearch')?.value.trim().toLowerCase()||'';
  const list=document.getElementById('practiceStudentList');
  if(!list)return;
  let names=Object.keys(realTimePracticeMap);
  names=names.filter(n=>{
    const info=getStudentInfo(n);
    if(major && info.major!==major) return false;
    if(grade && info.grade!==grade) return false;
    if(kw && !n.toLowerCase().includes(kw)) return false;
    return true;
  });
  if(!names.length){
    list.innerHTML=`<div class="practice-empty-state" style="grid-column:1/-1;">
      <div class="practice-empty-state-icon">🔍</div>
      <div class="practice-empty-state-title">${t('filter.no_results','没有符合条件的学生')}</div>
      <div class="practice-empty-state-description">${t('filter.try_different','请尝试调整筛选条件')}</div>
    </div>`;
    return;
  }
  names.sort((a,b)=>realTimePracticeMap[b].currentSec-realTimePracticeMap[a].currentSec);
  list.innerHTML=names.map(n=>{
    const info=getStudentInfo(n),p=realTimePracticeMap[n];
    const st=new Date(p.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'});
  const todayTotalMin = getTodayTotalPracticeMinutes(n);
  const todayTotalText = formatTotalPracticeTime(todayTotalMin);
  return `<div class="practice-status-card compact" onclick="openStudentDetail('${n}')">
      <div class="practice-indicator"></div>
      <div class="compact-content">
        <div class="student-name-compact">${n}</div>
        <div class="student-info-row"><span>${info.major||''}</span><span class="info-divider">•</span><span>${info.grade||''}</span></div>
        <div class="student-info-row"><span>🕐 ${st}</span><span class="info-divider">•</span><span>🏠 ${p.room}</span></div>
  <div class="practice-duration-large" title="今日总计">${todayTotalText}</div>
      </div></div>`;
  }).join('');
}

/* =============== 学生列表 =============== */
function populateFilters(){
  const majorSel=document.getElementById('majorFilter');
  const gradeSel=document.getElementById('gradeFilter');
  if(majorSel){
    const cur=majorSel.value;
    majorSel.innerHTML=`<option value="">${t('filter.all_majors','所有专业')}</option>`+
      Object.keys(studentDatabase).sort().map(m=>`<option value="${m}">${m}</option>`).join('');
    if(cur && Object.keys(studentDatabase).includes(cur))majorSel.value=cur;
  }
  if(gradeSel){
    const set=new Set();flattenStudents().forEach(s=>{if(s.grade)set.add(s.grade);});
    const cur=gradeSel.value;
    gradeSel.innerHTML=`<option value="">${t('filter.all_grades','所有年级')}</option>`+
      [...set].sort().map(g=>`<option value="${g}">${g}</option>`).join('');
    if(cur && set.has(cur))gradeSel.value=cur;
  }
}
function renderStudentList(){
  const container=document.getElementById('studentList');if(!container)return;
  const all=flattenStudents();
  if(!all.length){container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">📂</div><div class="empty-state-title">${t('empty.no_students','暂无学生数据')}</div></div>`;return;}
  const major=document.getElementById('majorFilter').value;
  const grade=document.getElementById('gradeFilter').value;
  const status=document.getElementById('statusFilter').value;
  const kw=document.getElementById('studentSearch').value.trim().toLowerCase();
  const today=formatDate(new Date());
  const excuses=excuseData[today]||{};
  const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
  const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
  let list = all.filter(s => {
    if (major && s.major !== major) return false;
    if (grade && s.grade !== grade) return false;
    if (kw && !s.name.toLowerCase().includes(kw)) return false;
    
    const p = realTimePracticeMap[s.name];
    const basicStatus = getStudentCurrentStatus(s.name, presentSet, excuses, wd, curMin);
    const detailedStatus = getDetailedStatus(s.name, basicStatus, p, wd, curMin);
    
    s._status = basicStatus;        // 用于样式类
    s._detailedStatus = detailedStatus; // 用于筛选
    
    // 🔥 修正：统一使用基础状态进行筛选，确保缺勤判断一致
    // 缺勤 = 在时间段内但没有练琴
    if (status && status !== basicStatus) return false;
    return true;
  });

  if(!list.length){container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">🔍</div><div class="empty-state-title">${t('filter.no_results','没有符合条件的学生')}</div></div>`;return;}
  list.sort((a,b)=>a.name.localeCompare(b.name,'zh-CN'));

  // 轻量虚拟化：首批 + 分块 append，降低主线程长任务
  const BATCH=40; // 首批渲染数量
  const CHUNK=50; // 后续每批
  const INTERVAL=16; // 每帧或空闲间隔（ms）
  function cardHTML(s){
    const p = realTimePracticeMap[s.name];
  const room = p ? p.room : t('student.not_in_room','不在琴房');
  const todayTotalMin = getTodayTotalPracticeMinutes(s.name);
  const dur = formatTotalPracticeTime(todayTotalMin);
    const detailedStatus = getDetailedStatus(s.name, s._status, p, wd, curMin);
    const cls = getStatusClass(detailedStatus);
    const statusText = getDetailedStatusText(s.name, s._status, p, wd, curMin);
    return `<div class="practice-status-card compact ${cls}" onclick="openStudentDetail('${s.name}')">
      ${p ? '<div class="practice-indicator"></div>' : ''}
      <div class="compact-content">
        <div class="student-name-compact">${s.name}</div>
        <div class="student-info-row"><span>${s.major||''}</span><span class="info-divider">•</span><span>${s.grade||t('student.not_set','未设置')}</span></div>
        <div class="student-info-row"><span>${room}</span></div>
        <div class="status-duration-row">
          <div class="student-status-compact ${cls}">${statusText}</div>
          <div class="practice-duration-large" title="今日总计">${dur}</div>
        </div>
      </div></div>`;
  }
  // 首批
  const first=list.slice(0,BATCH);
  container.innerHTML=first.map(cardHTML).join('');
  if(list.length<=BATCH)return;
  // 后续批次
  let index=BATCH;
  function appendChunk(){
    if(index>=list.length)return;
    const frag=document.createDocumentFragment();
    const end=Math.min(index+CHUNK,list.length);
    for(let i=index;i<end;i++){
      const div=document.createElement('div');
      div.innerHTML=cardHTML(list[i]);
      frag.appendChild(div.firstChild);
    }
    queueDomUpdate(()=>container.appendChild(frag));
    index=end;
    if(index<list.length){
      if('requestIdleCallback' in window){requestIdleCallback(appendChunk,{timeout:200});}
      else setTimeout(appendChunk,INTERVAL);
    }
  }
  if('requestIdleCallback' in window){requestIdleCallback(appendChunk,{timeout:300});}
  else setTimeout(appendChunk,INTERVAL);
}
function filterStudents(){renderStudentList();}
function getDetailedStatus(studentName, currentStatus, practice, weekday, currentMinute) {
  // 详细状态此处与基础状态一致（保留扩展点）
  return currentStatus;
}

/* =============== 请假面板 =============== */
function renderExcusePanel(){
  const today=formatDate(new Date());
  const data=excuseData[today]||{};
  const keys=Object.keys(data);
  const panel=document.getElementById('excuseInfoPanel');
  const box=document.getElementById('excuseInfoContainer');
  if(!keys.length){panel.style.display='none';return;}
  panel.style.display='block';
  box.innerHTML='<div class="student-grid">'+keys.map(n=>{
    const ex=data[n];
    return `<div class="student-card excused" style="min-height:180px;">
      <div class="student-header">
        <div class="student-name">${n}</div>
        <div class="student-status excused">${t('status.excused','请假')}</div>
      </div>
      <div class="student-details">
        <div class="detail-item"><div class="detail-label">${t('excuse.reason','请假原因')}</div><div class="detail-value">${ex.reason||t('excuse.not_filled','未填写')}</div></div>
        ${ex.durationText?`<div class="detail-item"><div class="detail-label">${t('excuse.duration_text','请假时长')}</div><div class="detail-value">${ex.durationText}</div></div>`:''}
        ${ex.endDate?`<div class="detail-item"><div class="detail-label">${t('excuse.end_date','结束日期')}</div><div class="detail-value">${ex.endDate}</div></div>`:''}
      </div></div>`;
  }).join('')+'</div>';
}

/* =============== ✅ 实时考勤增强：实时 / 快照 / 合并构建函数 =============== */

/**** ======= 新增辅助函数 开始 ======= ****/

/**
 * 获取学生今天所有练琴区间（含正在进行的）
 * 每个区间：{ start: ms, end: ms, room: string }
 * prep 时间（首分钟）不计入正式时长：start 用 prepEndTime
 */
function getStudentTodayIntervals(studentName){
  const todayKey = getTodayDateString();
  const intervals = [];

  // 1. 已结束会话（优先使用详细的 sessions 数据）
  const rec = dailyPracticeRecords[todayKey] && dailyPracticeRecords[todayKey][studentName];
  if(rec && Array.isArray(rec.sessions)){
    rec.sessions.forEach(s=>{
      if(!s.start || !s.end) return;
      const start = s.start + 60000; // 去除1分钟准备
      if(start >= s.end) return;
      intervals.push({
        start,
        end: s.end,
        room: s.room || t('room.practice_room', '练琴房')
      });
    });
  }

  // 2. 正在进行的会话（practiceSessionTracker）
  practiceSessionTracker.forEach(sess=>{
    if(!sess.isActive) return;
    if(sess.studentName !== studentName) return;
    const activeStart = Math.max(sess.prepEndTime, sess.startTime + 60000);
    const end = Date.now();
    if(activeStart < end){
      intervals.push({
        start: activeStart,
        end,
        room: sess.roomName
      });
    }
  });

  // 3. 如果没有详细会话数据，尝试根据汇总数据和排课时段重建
  if (intervals.length === 0) {
    const today = getTodayDateString();
    const rec = dailyPracticeRecords[today] && dailyPracticeRecords[today][studentName];
    if (rec && (rec.inSlotSeconds || rec.inSlot)) {
      // 根据今日排课拆分
      const wd = new Date().getDay();
      const map = {1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
      const key = map[wd];
      const slots = (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) ? studentTimeSlots[studentName][key] : [];
      let remain = rec.inSlotSeconds || rec.inSlot || 0;
      
      slots.forEach(slot=>{
        if (remain <= 0) return;
        const slotStart = new Date(`${today}T${slot.start}:00`).getTime();
        const slotEnd   = new Date(`${today}T${slot.end}:00`).getTime();
        const slotSec   = (slotEnd - slotStart)/1000;
        const use = Math.min(remain, slotSec);
        if (use > 0) {
          intervals.push({
            start: slotStart,
            end: slotStart + use*1000,
            room: t('room.historical_rebuild', '（历史重建）')
          });
          remain -= use;
        }
      });
    }
  }

  return intervals;
}


// 🔥 新增：数据一致性检查函数
function validatePracticeData(studentName, date) {
  const rec = dailyPracticeRecords[date] && dailyPracticeRecords[date][studentName];
  if(!rec) return false;
  
  // 检查是否有详细会话记录
  if(!rec.sessions || !Array.isArray(rec.sessions) || rec.sessions.length === 0) {
    console.warn(`${studentName} ${date} 缺少详细会话记录`);
    return false;
  }
  
  // 检查累计时长是否与会话记录匹配
  let totalInSlot = 0, totalOutSlot = 0;
  rec.sessions.forEach(s => {
    totalInSlot += (s.inSlot || 0);
    totalOutSlot += (s.outSlot || 0);
  });
  
  const recordedInSlot = rec.inSlotSeconds || rec.inSlot || 0;
  const recordedOutSlot = rec.outSlotSeconds || rec.outSlot || 0;
  
  if(Math.abs(totalInSlot - recordedInSlot) > 60 || Math.abs(totalOutSlot - recordedOutSlot) > 60) {
    console.warn(`${studentName} ${date} 数据不一致: 会话累计(${totalInSlot},${totalOutSlot}) vs 记录(${recordedInSlot},${recordedOutSlot})`);
    return false;
  }
  
  return true;
}

/**
 * 计算一个区间数组与目标(timeStart,timeEnd) 的总重叠秒数
 */
function calcOverlapSeconds(intervals, slotStartMs, slotEndMs){
  // 保护：无区间 / 逆序时间段
  if(!Array.isArray(intervals) || intervals.length===0) return 0;
  if(slotEndMs <= slotStartMs) return 0;

  // 1. 先裁剪到 slot 边界，并过滤无效 / 结束早于开始的
  const clipped = [];
  for(const it of intervals){
    if(!it || typeof it.start!== 'number' || typeof it.end!== 'number') continue;
    let st = Math.max(it.start, slotStartMs);
    let en = Math.min(it.end, slotEndMs);
    if(en - st >= 1000) { // 至少 1 秒
      clipped.push({start: st, end: en});
    }
  }
  if(clipped.length===0) return 0;

  // 2. 按开始时间排序
  clipped.sort((a,b)=>a.start-b.start);

  // 3. 合并重叠/相邻(<=1s 视为相邻) 区间，避免重复计时
  const merged=[];
  let cur = clipped[0];
  for(let i=1;i<clipped.length;i++){
    const nxt = clipped[i];
    if(nxt.start <= cur.end + 1000){ // 有重叠或几乎相邻
      cur.end = Math.max(cur.end, nxt.end);
    } else {
      merged.push(cur);
      cur = nxt;
    }
  }
  merged.push(cur);

  // 4. 计算合并后总毫秒
  let totalMs=0;
  for(const m of merged){ totalMs += (m.end - m.start); }

  // 5. clamp 到 slot 长度，防止边界误差导致超过
  const slotMs = slotEndMs - slotStartMs;
  if(totalMs > slotMs) {
    // 记录一次调试日志，便于后续排查原始 intervals 是否越界
    if(window && window.debugOverlap) {
      console.warn('[calcOverlapSeconds] totalMs 超出 slotMs, 已 clamp', {slotStart:new Date(slotStartMs).toLocaleTimeString(), slotEnd:new Date(slotEndMs).toLocaleTimeString(), totalMs, slotMs, merged});
    }
    totalMs = slotMs;
  }

  return Math.floor(totalMs/1000);
}


/**
 * 选取与该 slot 重叠时长最多的房间（用于历史已结束 slot 的房间显示）
 */
function pickDominantRoom(intervals, slotStartMs, slotEndMs){
  const map = new Map();
  intervals.forEach(it=>{
    const st = Math.max(it.start, slotStartMs);
    const en = Math.min(it.end, slotEndMs);
    if(en > st){
      const sec = (en - st)/1000;
      map.set(it.room, (map.get(it.room)||0)+sec);
    }
  });
  let bestRoom = '';
  let maxSec = 0;
  for(const [room,sec] of map.entries()){
    if(sec > maxSec){
      maxSec = sec;
      bestRoom = room;
    }
  }
  return bestRoom;
}

/**** ======= 新增辅助函数 结束 ======= ****/


/**
 * 替换后的 buildRealtimeAttendanceDetail
 * 实现：利用当天所有练琴区间对每个排课 slot 做重叠计算
 */
function buildRealtimeAttendanceDetail(studentName, date){
  const detail = {present:0, absent:0, excused:0, lowEfficiency:0, pending:0, details:[]};
  
  // 1. 检查请假状态
  const excuses = excuseData[date] || {};
  if(excuses[studentName]){
    detail.excused++;
    detail.details.push({
      timeSlot: '全天',
      status: 'excused',
      practiceTime: t('status.excused', '请假'),
      room: t('status.excused', '请假'),
      statusText: t('status.excused', '请假'),
      excuseReason: excuses[studentName].reason || ''
    });
    return detail;
  }

  // 2. 获取日期信息
  const target = new Date(date);
  const wd = target.getDay();
  const map = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = map[wd];
  const isToday = (date === getTodayDateString());

  // 3. 获取学生当天的时间段安排
  const slots = (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) 
                  ? studentTimeSlots[studentName][key] : [];

  // 4. 🔥 修复：获取练琴区间（支持历史日期）
  let intervals = isToday ? getStudentTodayIntervals(studentName) : getHistoryIntervals(studentName, date);
  
  // 已移除 summary 补偿：不再根据累计时长虚构区间
  
  const now = isToday ? Date.now() : new Date(date + 'T23:59:59').getTime();

  // 5. 考勤判断的阈值常量
  const MIN_PRESENT_SEC = 5 * 60;         // >=5分钟才认可基本出勤
  const EFFICIENCY_RATIO = 0.6;           // 60% 时长达到才是"出勤"
  const MIN_ACTIVE_SEC_FOR_ONGOING = 60;  // 正在进行的段内重叠 < 60秒仍显示 pending

  // 6. 处理无时间段安排的情况
  if(!slots.length){
    detail.pending++;
    const activeRoom = intervals.length ? (intervals[intervals.length-1].room || t('room.in_room', '在琴房')) : t('room.no_arrangement', '无安排');
    const totalPracticeTime = intervals.length ? 
      formatDuration(calcOverlapSeconds(intervals, new Date(date).getTime(), now)) : '—';
    
    detail.details.push({
      timeSlot: (wd === 0 || wd === 6) ? t('room.weekend', '周末') : t('room.no_arrangement', '无安排'),
      status: intervals.length ? 'present' : 'pending',
      practiceTime: totalPracticeTime,
      room: intervals.length ? activeRoom : t('room.no_arrangement', '无安排'),
      statusText: intervals.length ? t('status.present_out_slot', '出勤(段外)') : t('status.pending_attendance', '待考勤')
    });
    
    if(intervals.length){
      detail.present++;
      detail.pending--;
    }
    return detail;
  }

  // 7. 处理每个时间段
  slots.forEach(slot => {
    const slotLabel = `${slot.start} - ${slot.end}`;
    const slotStartMs = new Date(`${date}T${slot.start}:00`).getTime();
    const slotEndMs = new Date(`${date}T${slot.end}:00`).getTime();
    const slotDurSec = (slotEndMs - slotStartMs) / 1000;

    let status = 'pending';
    let statusText = t('status.pending_attendance', '待考勤');
    let practiceTime = '--';
    let room = '--';

  // 计算该时间段内的练琴重叠时长（含防护 clamp）
  let overlapSec = calcOverlapSeconds(intervals, slotStartMs, slotEndMs);
  const slotMaxSecClamp = Math.floor((slotEndMs - slotStartMs)/1000);
  if(overlapSec > slotMaxSecClamp) overlapSec = slotMaxSecClamp;

    if(!isToday){
      // 历史日期：根据实际练琴时长判断
      if(overlapSec >= slotDurSec * EFFICIENCY_RATIO){
        status = 'present';
        statusText = t('status.present_text', '出勤');
      } else if(overlapSec >= MIN_PRESENT_SEC){
        status = 'low_efficiency';
        statusText = t('status.low_efficiency_text', '低效');
      } else {
        status = 'absent';
        statusText = t('status.absent_text', '缺勤');
      }
      
      practiceTime = overlapSec > 0 ? formatDuration(overlapSec, 'minuteOnly') : t('time.no_practice', '0分钟');
      
      if(overlapSec > 0){
        room = pickDominantRoom(intervals, slotStartMs, slotEndMs) || t('room.in_room', '在琴房');
      } else {
        room = t('room.not_in_room', '不在琴房');
      }
    } else {
      // 今日实时判断
      if(now < slotStartMs){
        // 未来时间段
        status = 'pending';
        statusText = t('status.pending_attendance', '待考勤');
      } else if(now >= slotEndMs){
        // 已结束时间段
        if(overlapSec >= slotDurSec * EFFICIENCY_RATIO){
          status = 'present';
          statusText = t('status.present_text', '出勤');
        } else if(overlapSec >= MIN_PRESENT_SEC){
          status = 'low_efficiency';
          statusText = t('status.low_efficiency_text', '低效');
        } else {
          status = 'absent';
          statusText = t('status.absent_text', '缺勤');
        }
        
        practiceTime = overlapSec > 0 ? formatDuration(overlapSec, 'minuteOnly') : t('time.no_practice', '0分钟');
        
        if(overlapSec > 0){
          room = pickDominantRoom(intervals, slotStartMs, slotEndMs) || t('room.in_room', '在琴房');
        } else {
          room = t('room.not_in_room', '不在琴房');
        }
      } else {
        // 正在进行中的时间段
        const expectedSec = (now - slotStartMs) / 1000;
        
        if(overlapSec < MIN_ACTIVE_SEC_FOR_ONGOING){
          status = 'pending';
          statusText = t('status.pending_attendance', '待考勤'); // 刚开始不立刻判缺勤
        } else {
          if(overlapSec >= expectedSec * EFFICIENCY_RATIO){
            status = 'present';
            statusText = t('status.present_text', '出勤');
          } else {
            status = 'low_efficiency';
            statusText = t('status.low_efficiency_text', '低效');
          }
        }
        
        practiceTime = overlapSec > 0 ? formatDuration(overlapSec, 'minuteOnly') : '--';
        
        // 当前房间：取 active interval 最后一个房间
        const activeInterval = intervals[intervals.length - 1];
        room = activeInterval ? activeInterval.room : (overlapSec > 0 ? t('room.in_room', '在琴房') : t('room.not_in_room', '不在琴房'));
      }
    }

    // 统计各状态数量
    switch(status){
      case 'present': detail.present++; break;
      case 'absent': detail.absent++; break;
      case 'excused': detail.excused++; break;
      case 'low_efficiency': detail.lowEfficiency++; break;
      case 'pending': detail.pending++; break;
    }

    // 添加详情记录
    detail.details.push({
      timeSlot: slotLabel,
      status,
      practiceTime,
      room,
      statusText
    });
  });

  return detail;
}



/**
 * 构造 snapshot 视图
 */
function buildSnapshotAttendanceDetail(studentName,date,rec){
  const detail={present:0,absent:0,excused:0,lowEfficiency:0,pending:0,details:[]};
  if(!rec){detail.pending++;detail.details.push({timeSlot:t('time.no_records', '无记录'),status:'pending',practiceTime:'--',room:'--',statusText:t('status.pending_attendance', '待考勤')});return detail;}
  const all=[...(rec.students||[]),...(rec.endedSlots||[])];
  const seg=all.filter(s=>s.name===studentName);
  if(!seg.length){
    detail.pending++;
    detail.details.push({timeSlot:t('time.no_records', '无记录'),status:'pending',practiceTime:'--',room:'--',statusText:t('status.pending_attendance', '待考勤')});
    return detail;
  }
  seg.forEach(s=>{
    const stat=s.finalAttendanceStatus||'absent';
    let text=getStatusText(stat);
    if(stat==='present')detail.present++;
    else if(stat==='excused')detail.excused++;
    else if(stat==='absent')detail.absent++;
    else if(stat==='low_efficiency')detail.lowEfficiency++;
    else detail.pending++;
    detail.details.push({
      timeSlot:`${s.start}-${s.end}`,
      status:stat,
      practiceTime:s.practicedText||t('time.no_practice', '0分钟'),
      room:s.room|| (stat==='present'? t('room.in_room', '在琴房') : t('room.not_in_room', '不在琴房')),
      statusText:text
    });
  });
  return detail;
}

// =====================
// 合并 snapshot 与 realtime
// 规则：
//  1. realtime present / low_efficiency 永远覆盖
//  2. snapshot 是积极(present/low_efficiency) 而 realtime 退化(absent/pending) -> 保留 snapshot
//  3. realtime under_review 可以把 snapshot 的 absent/pending 提升为 under_review
//  4. 其它保持 snapshot
// =====================
// =====================
// 计算单个时间段考勤状态（低于 60% 即低效；0 秒才缺勤）
// status: present | absent | low_efficiency | pending | under_review
// =====================
// 🔥 统一的考勤状态计算函数
function calculateAttendanceStatus(student, slot, realtimeStatus, practicedSec, opts = {}) {
  practicedSec = Number(practicedSec); if(isNaN(practicedSec)||practicedSec<0) practicedSec=0;
  const { lowEffImmediate=false, lowEffReviewRatio=0.3 } = opts;
  const now=Date.now();
  const slotStartMs=new Date(`${getTodayDateString()}T${slot.start}:00`).getTime();
  const slotEndMs=new Date(`${getTodayDateString()}T${slot.end}:00`).getTime();
  const effectiveTotalSec=(slot.effectiveTotalSec&&slot.effectiveTotalSec>0)?slot.effectiveTotalSec:((slot.totalPlannedMinutes||0)*60);
  const efficiencyThresholdSec=Math.floor(effectiveTotalSec*0.6);
  const practicedMin=Math.floor(practicedSec/60);
  const practicedText=`${practicedMin}分钟`;
  let practiceRatio=0; if(effectiveTotalSec>0) practiceRatio=practicedSec/effectiveTotalSec;
  const isFinished = now>=slotEndMs || slot.slotPhase==='ended';
  const pack=(status,text)=>({finalAttendanceStatus:status,finalStatusText:text,practiceRatio,practicedText,practiceDetails:`${practicedMin}分钟 / ${slot.totalPlannedMinutes}分钟`});
  if(!isFinished){
    if(practicedSec<=0) return pack('under_review','进行中');
    if(practicedSec < efficiencyThresholdSec){
      if(lowEffImmediate) return pack('low_efficiency',`低效(进行中 ${(practiceRatio*100).toFixed(1)}%)`);
      if(practiceRatio < lowEffReviewRatio) return pack('under_review','进行中');
      return pack('low_efficiency',`低效(进行中 ${(practiceRatio*100).toFixed(1)}%)`);
    }
    return pack('present',`已完成 ${(practiceRatio*100).toFixed(1)}% (进行中)`);
  }
  if(practicedSec<=0) return pack('absent','缺勤(已结束)');
  if(practicedSec >= efficiencyThresholdSec) return pack('present',`已完成 ${(practiceRatio*100).toFixed(1)}%`);
  return pack('low_efficiency',`低效 ${(practiceRatio*100).toFixed(1)}%`);
}


// 🔥 统一的 helper 函数：检查某个时间点是否在准备期
function isInPreparingPeriod(timeMs, registerTimeMs) {
  if (!registerTimeMs || isNaN(registerTimeMs)) {
    return false;
  }
  const prepEnd = registerTimeMs + 60000; // 1分钟准备期
  return timeMs >= registerTimeMs && timeMs < prepEnd;
}

// 🔥 统一的 helper 函数：获取有效练琴开始时间
function getEffectivePracticeStart(registerTimeMs, slotStartMs) {
  if (!registerTimeMs || isNaN(registerTimeMs)) {
    return null;
  }
  const prepEnd = registerTimeMs + 60000; // 1分钟准备期
  return Math.max(prepEnd, slotStartMs || 0);
}

// 🔥 统一的 helper 函数：计算时间点的练琴状态
function getPracticeStatusAtTime(timeMs, studentName, registerTimeMs, dateStr) {
  const currentDate = new Date(timeMs);
  const currentMinutes = currentDate.getHours() * 60 + currentDate.getMinutes();
  const currentWeekday = currentDate.getDay();
  
  // 检查是否在排除时间
  if (isExcludedTime(currentMinutes, currentWeekday)) {
    return {
      isValid: false,
      reason: 'excluded',
      inSlot: false,
      inPreparingSlot: false
    };
  }
  
  // 检查是否在准备期
  if (isInPreparingPeriod(timeMs, registerTimeMs)) {
    const slots = getStudentTodaySlots(studentName);
    const slot = findCurrentTimeSlot(slots, timeMs);
    return {
      isValid: false,
      reason: 'preparing',
      inSlot: !!slot,
      inPreparingSlot: !!slot
    };
  }
  
  // 检查是否在时间段内
  const slots = getStudentTodaySlots(studentName);
  const slot = findCurrentTimeSlot(slots, timeMs);
  
  return {
    isValid: true,
    reason: 'valid',
    inSlot: !!slot,
    inPreparingSlot: false,
    slot: slot
  };
}

// 🔥 重构后的 getStudentPracticeTimeInSlot
function getStudentPracticeTimeInSlot(studentName, slot, dateStr, registerTimeMs) {
  try {
    if (!slot || !slot.start || !slot.end) {
      return { seconds: 0, inPreparingSlot: false };
    }

    // 当前时间（只用于当天；历史回放可根据需要传入一个固定时间）
    const now = Date.now();
    const todayStr = getTodayDateString();
    const isToday = (dateStr === todayStr);

    // 如果不是今天，我们用该日 slot 结束时间做"观察时间点"
    const observeNow = isToday ? now : new Date(dateStr + 'T' + slot.end + ':00').getTime();

    // 没有 registerTime（不在房间 / 没开始）
    if (!registerTimeMs || isNaN(registerTimeMs)) {
      return { seconds: 0, inPreparingSlot: false };
    }

    const slotStartMs = new Date(`${dateStr}T${slot.start}:00`).getTime();
    const slotEndMs = new Date(`${dateStr}T${slot.end}:00`).getTime();

    // 未进入该时间段
    if (observeNow <= slotStartMs) {
      return { seconds: 0, inPreparingSlot: false };
    }

    // 已经过了时间段
    if (observeNow >= slotEndMs && registerTimeMs >= slotEndMs) {
      return { seconds: 0, inPreparingSlot: false };
    }

    // 🔥 使用统一的状态检查
    const statusAtObserve = getPracticeStatusAtTime(observeNow, studentName, registerTimeMs, dateStr);
    
    // 情形一：进入段内但仍在准备期
    if (statusAtObserve.inPreparingSlot) {
      return { seconds: 0, inPreparingSlot: true };
    }

    // 🔥 使用统一的有效开始时间计算
    const effectiveStart = getEffectivePracticeStart(registerTimeMs, slotStartMs);
    if (!effectiveStart) {
      return { seconds: 0, inPreparingSlot: false };
    }

    // 观察点不应超过 slotEnd
    const effectiveObserve = Math.min(observeNow, slotEndMs);

    if (effectiveObserve <= effectiveStart) {
      // 可能是：准备期还没结束 或 slot 很短
      return {
        seconds: 0,
        inPreparingSlot: (observeNow > slotStartMs && observeNow <= effectiveStart)
      };
    }

    // 🔥 按分钟计算，排除排除时间
    let validSeconds = 0;
    const startMin = Math.floor(effectiveStart / 60000) * 60000;
    const endMin = Math.floor(effectiveObserve / 60000) * 60000;
    
    for(let t = startMin; t < endMin; t += 60000) {
      const status = getPracticeStatusAtTime(t, studentName, registerTimeMs, dateStr);
      if (status.isValid && status.inSlot) {
        validSeconds += 60;
      }
    }

    return {
      seconds: Math.max(0, validSeconds),
      inPreparingSlot: false
    };
    
  } catch (e) {
    console.error('getStudentPracticeTimeInSlot 错误', e);
    return { seconds: 0, inPreparingSlot: false };
  }
}

// 🔥 重构后的 recalcSessionTimes
function recalcSessionTimes(sess) {
  if (!sess || !sess.studentName) {
    console.error('会话对象无效或缺少学生姓名');
    return;
  }
  
  // 🔥 初始化默认值
  sess.inSlotTime = 0;
  sess.outSlotTime = 0;
  
  const endTime = sess.endTime || Date.now();
  
  if (!sess.actualStartTime || sess.actualStartTime >= endTime) {
    console.log(`会话时间无效: ${sess.studentName}, start=${sess.actualStartTime}, end=${endTime}`);
    return;
  }
  
  // 🔥 确保时间范围合理（不超过24小时）
  const maxDuration = 24 * 60 * 60 * 1000; // 24小时
  const actualEndTime = Math.min(endTime, sess.actualStartTime + maxDuration);
  
  const startMin = Math.floor(sess.actualStartTime / 60000) * 60000;
  const endMin = Math.floor(actualEndTime / 60000) * 60000;
  
  let inSeconds = 0;
  let outSeconds = 0;
  
  // 🔥 获取日期字符串用于状态检查
  const dateStr = formatDate(new Date(sess.actualStartTime));
  
  // 🔥 按分钟遍历时间段，使用统一的状态检查
  for (let t = startMin; t < endMin; t += 60000) {
    try {
      // 🔥 使用统一的练琴状态检查函数
      const status = getPracticeStatusAtTime(t, sess.studentName, sess.actualStartTime, dateStr);
      
      // 只有有效时间才计入练琴时长
      if (status.isValid) {
        if (status.inSlot) {
          inSeconds += 60;
        } else {
          outSeconds += 60;
        }
      }
      // 排除时间和准备期都不计入任何时长
      
    } catch (e) {
      console.error(`计算时间段出错: ${new Date(t)}, 错误:`, e);
      break;
    }
  }
  
  // 🔥 最终验证和赋值
  sess.inSlotTime = Math.max(0, Math.floor(inSeconds));
  sess.outSlotTime = Math.max(0, Math.floor(outSeconds));
  
  // 🔥 验证结果
  if (isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
    console.error(`计算结果为NaN: ${sess.studentName}, in=${inSeconds}, out=${outSeconds}`);
    sess.inSlotTime = 0;
    sess.outSlotTime = 0;
  }
  
  console.log(`重新计算时长: ${sess.studentName}, 段内=${Math.round(sess.inSlotTime/60)}分钟, 段外=${Math.round(sess.outSlotTime/60)}分钟`);
}

// 🔥 额外的 helper：获取学生某天的时间段（优化版）
function getStudentTodaySlots(studentName, dateStr = null) {
  const targetDate = dateStr ? new Date(dateStr) : new Date();
  const wd = targetDate.getDay();
  const map = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = map[wd];
  
  if (!key || !studentTimeSlots[studentName] || !studentTimeSlots[studentName][key]) {
    return [];
  }
  
  return studentTimeSlots[studentName][key] || [];
}

/**
 * 决定使用何种构造逻辑并展示
 */
function showDayAttendanceDetail(studentName, date, dayNumber){
  // 防止冒泡（若不是事件触发可忽略）
  if (typeof event !== 'undefined' && event.stopPropagation) {
    event.stopPropagation();
  }

  const isToday = (date === getTodayDateString());
  const rec = attendanceRecordsCache[date];
  const realtime = buildRealtimeAttendanceDetail(studentName, date);
  let finalDetail;

  if (isToday) {
    // 今日完全使用实时
    finalDetail = realtime;
  } else {
    // 历史：优先 snapshot，过期或不存在用 realtime
    let stale = false;
    if (rec && rec.lastUpdated) {
      if (Date.now() - rec.lastUpdated > SNAPSHOT_STALE_MS) stale = true;
    } else if (rec && !rec.lastUpdated) {
      stale = true;
    }
    
    if (!rec || stale) {
      // 🔥 修复：直接使用实时数据
      finalDetail = realtime;
    } else {
      // 🔥 修复：使用快照数据，移除不存在的 merge 函数
      finalDetail = buildSnapshotAttendanceDetail(studentName, date, rec);
    }
  }

  // 仅今天做缓冲期缺勤纠正
  if (isToday) {
    postFixEarlyBufferAbsents(finalDetail, studentName);
  }

  showAttendanceDetailModal(studentName, date, dayNumber, finalDetail);
}


// =====================
// 二次修正：把“缓冲期缺勤”纠正成实时状态
// 仅针对当天且 status='absent' 且 statusText 含“缓冲/准备”
// =====================
function postFixEarlyBufferAbsents(detailObj, studentName) {
  if (!detailObj || !Array.isArray(detailObj.details)) return;
  const today = getTodayDateString();

  // 用最新实时重新跑一次
  const realtime = buildRealtimeAttendanceDetail(studentName, today);

  detailObj.details.forEach(d => {
    if (
      d.status === 'absent' &&
      /缓冲|准备/.test(d.statusText)
    ) {
      const same = realtime.details.find(x => x.timeSlot === d.timeSlot);
      if (same && (same.status === 'present' || same.status === 'low_efficiency' || same.status === 'under_review')) {
        d.status = same.status;
        d.statusText =
          same.status === 'present'
            ? '出勤'
            : same.status === 'low_efficiency'
              ? '低效'
              : '进行中';
        d.practiceTime = same.practiceTime || same.practicedText || d.practiceTime;
        d.room = same.room || d.room;
      }
    }
  });

  // 重新汇总
  detailObj.present = 0;
  detailObj.absent = 0;
  detailObj.excused = 0;
  detailObj.lowEfficiency = 0;
  detailObj.pending = 0;
  detailObj.underReview = 0;
  detailObj.details.forEach(d => {
    switch (d.status) {
      case 'present': detailObj.present++; break;
      case 'excused': detailObj.excused++; break;
      case 'absent': detailObj.absent++; break;
      case 'low_efficiency': detailObj.lowEfficiency++; break;
      case 'under_review': detailObj.underReview++; break;
      default: detailObj.pending++; break;
    }
  });
}


/* =============== ✅ 可选：生成今日 attendance snapshot（含 lastUpdated） =============== */
/* 你可以在某个管理按钮或定时器调用 snapshotTodayAttendance() 以写入云端“阶段性快照” */
function snapshotTodayAttendance(){
  if(!isOnline || !database){
    addSyncLog('⚠️ 无法生成快照（离线）');
    return;
  }
  const today = getTodayDateString();
  const students = flattenStudents();
  const now = new Date();
  const wd = now.getDay();
  const curMin = now.getHours()*60 + now.getMinutes();
  const presentSet = new Set();
  rooms.forEach(r => { if(r.student) presentSet.add(r.student); });
  const excuses = excuseData[today] || {};
  const map = {1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
  const dayKey = map[wd];

  const records = [];

  students.forEach(s=>{
    if(excuses[s.name]) return; // 请假不细分 slot
    const slots = (dayKey && studentTimeSlots[s.name] && studentTimeSlots[s.name][dayKey]) ? studentTimeSlots[s.name][dayKey] : [];
    if(!slots.length){
      const st = getStudentCurrentStatus(s.name, presentSet, excuses, wd, curMin);
      records.push({
        name: s.name,
        start: '--',
        end: '--',
        finalAttendanceStatus: st,
        practicedText: '--',
        room: presentSet.has(s.name)? (rooms.find(r=>r.student===s.name)?.name || '在琴房') : '',
        major: s.major,
        lastUpdated: Date.now()
      });
    }else{
      // 简单按当前分钟判断：已过 && 人不在房间 -> absent；在且在房间 -> present；未到 -> pending
      slots.forEach(slot=>{
        const sm = timeToMinutes(slot.start);
        const em = timeToMinutes(slot.end);
        let st='pending';
        if(curMin >= em){
          // 已结束：用 realTime 判断（粗糙版，可后续换成 buildRealtimeAttendanceDetail）
          st = presentSet.has(s.name)? 'present' : 'absent';
        }else if(curMin >= sm && curMin < em){
          st = presentSet.has(s.name)? 'present' : 'absent';
        }else if(curMin < sm){
          st = 'pending';
        }
        records.push({
          name: s.name,
            start: slot.start,
            end: slot.end,
            finalAttendanceStatus: st,
            practicedText: '-',
            room: presentSet.has(s.name)? (rooms.find(r=>r.student===s.name)?.name || '在琴房') : '',
            major: s.major,
            lastUpdated: Date.now()
        });
      });
    }
  });

  const snapshot = {
    students: records,
    endedSlots: [], // 你若有已结束 slot 结构可填
    lastUpdated: Date.now()
  };

  database.ref(`attendanceRecords/${today}`)
    .update(snapshot)
    .then(()=> addSyncLog('📤 已写入今日考勤快照'))
    .catch(e => addSyncLog('❌ 快照失败 '+e.message));
}

/* =============== 显示考勤详情模态框（保持原格式） =============== */
function getDayDescription(dayNumber){
  if(currentLanguage==='en'){
    const desc={1:'Today',2:'Yesterday',3:'2 days ago',4:'3 days ago',5:'4 days ago',6:'5 days ago',7:'6 days ago'};
    return desc[dayNumber]||`${dayNumber-1} days ago`;
  }else{
    const desc={1:'今天',2:'昨天',3:'前天',4:'第4天前',5:'第5天前',6:'第6天前',7:'第7天前'};
    return desc[dayNumber]||`第${dayNumber}天`;
  }
}
function showAttendanceDetailModal(studentName,date,dayNumber,detailInfo){
  const modal=document.getElementById('attendanceDetailModal');
  const content=`<div class="modal-header">
    <h3 class="modal-title">${studentName} - ${getDayDescription(dayNumber)}${t('attendance.detail.suffix','考勤详情')}</h3>
    <button class="modal-close" onclick="closeModal('attendanceDetailModal')">&times;</button>
  </div>
  <div style="padding:25px 20px 20px 20px;">
    <div class="card" style="margin-bottom:25px;">
      <h4 style="margin-bottom:20px;">📅 ${date} ${t('attendance.summary','考勤汇总')}</h4>
      <div class="stats-grid-detailed" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;">
        <div class="stat-item present"><div class="stat-icon">✅</div><div class="stat-content"><div class="stat-number">${detailInfo.present}</div><div class="stat-label">${t('stats.present','出勤')}</div></div></div>
        <div class="stat-item absent"><div class="stat-icon">❌</div><div class="stat-content"><div class="stat-number">${detailInfo.absent}</div><div class="stat-label">${t('stats.absent','缺勤')}</div></div></div>
  <div class="stat-item low-efficiency"><div class="stat-icon">⚠️</div><div class="stat-content"><div class="stat-number">${detailInfo.lowEfficiency}</div><div class="stat-label">${t('status.low_efficiency','低效')}</div></div></div>
        <div class="stat-item excused"><div class="stat-icon">📝</div><div class="stat-content"><div class="stat-number">${detailInfo.excused}</div><div class="stat-label">${t('stats.excused','请假')}</div></div></div>
  
      </div>
    </div>
    <div class="card">
      <h4 style="margin-bottom:20px;">📋 ${t('attendance.detailed_records','详细记录')}</h4>
      <div class="data-table-container" style="max-height:300px;overflow-y:auto;">
        <table class="data-table">
          <thead><tr>
            <th>${t('student.time_slot','时间段')}</th>
            <th>${t('filter.status','状态')}</th>
            <th>${t('student.practice_duration','练琴时长')}</th>
            <th>${t('student.room','琴房')}</th>
            ${detailInfo.details.some(d=>d.excuseReason)?`<th>${t('attendance.remarks','备注')}</th>`:''}
          </tr></thead>
          <tbody>
            ${detailInfo.details.map(d=>`<tr>
              <td>${d.timeSlot}</td>
              <td><span class="table-status-badge ${d.status}">${d.statusText}</span></td>
              <td>${d.practiceTime||'--'}</td>
              <td>${d.room||''}</td>
              ${detailInfo.details.some(x=>x.excuseReason)?(`<td>${d.excuseReason||'-'}</td>`):''}
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>`;
  openModalSmooth('attendanceDetailModal', content);
}

/* =============== 学生详情（复用原逻辑 + 修正） =============== */
function getStudentPracticeStats(name,days=7){
  const stats={totalDays:0,totalInSlot:0,totalOutSlot:0,totalSessions:0,dailyDetails:[]};
  const today=new Date();
  for(let i=0;i<days;i++){
    const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
    const dk=formatDate(d);
    const rec=getStudentPracticeRecord(name,dk);
    const inSlot=Number(rec.inSlotSeconds||rec.inSlot||0);
    const outSlot=Number(rec.outSlotSeconds||rec.outSlot||0);
    const sessions=Number(rec.totalSessions||0);
    if(sessions>0){stats.totalDays++;stats.totalInSlot+=inSlot;stats.totalOutSlot+=outSlot;stats.totalSessions+=sessions;}
    stats.dailyDetails.push({date:dk,inSlot,outSlot,sessions});
  }
  return stats;
}
function aggregateDailyStatus(records){
  // records: 同一天该学生所有 slot 或快照条目
  let hasExcused=false,hasPresent=false,hasLow=false,hasPending=false,hasAbsent=false;
  let totalSlots = 0, presentSlots = 0;
  
  records.forEach(r=>{
    const s=r.finalAttendanceStatus || r.status;
    totalSlots++;
    
    if(s==='excused') hasExcused=true;
    else if(s==='present') {
      hasPresent=true;
      presentSlots++;
    }
    else if(s==='low_efficiency') hasLow=true;
    else if(s==='pending') hasPending=true;
    else if(s==='absent') hasAbsent=true;
  });
  
  // 🔥 新逻辑：如果有任何出勤记录，优先显示积极状态
  // 只有当所有时间段都是缺勤时，才显示缺勤
  if(hasExcused && !hasPresent && !hasLow && !hasAbsent && !hasPending) return 'excused'; // 全天请假
  if(hasPresent && presentSlots >= totalSlots * 0.5) return 'present'; // 超过一半时间段出勤
  if(hasPresent || hasLow) return hasPresent ? 'present' : 'low_efficiency'; // 有出勤或低效
  if(hasAbsent && !hasPending) return 'absent'; // 明确缺勤且无待考勤
  if(hasPending) return 'pending'; // 待考勤
  if(hasAbsent) return 'absent'; // 缺勤
  if(hasExcused) return 'excused'; // 请假
  return 'no-data';
}

// 🔥 新增：专门用于练琴明细表格的时间格式化函数
function formatPracticeMinutes(minutes) {
  if (!minutes || minutes === 0) {
    return currentLanguage === 'zh' ? '0分钟' : '0min';
  }
  
  if (minutes >= 60) {
    const hours = (minutes / 60).toFixed(1);
    return currentLanguage === 'zh' ? `${hours}小时` : `${hours}h`;
  }
  
  return currentLanguage === 'zh' ? `${minutes}分钟` : `${minutes}min`;
}

// 🔥 新增：专门用于今日总计的时间格式化函数（显示小时分钟格式）
function formatTotalPracticeTime(minutes) {
  if (!minutes || minutes === 0) {
    return currentLanguage === 'zh' ? '0分钟' : '0min';
  }
  
  const hours = Math.floor(minutes / 60);
  const remainingMinutes = minutes % 60;
  
  if (currentLanguage === 'zh') {
    if (hours > 0) {
      return `${hours}小时${remainingMinutes}分钟`;
    }
    return `${remainingMinutes}分钟`;
  } else {
    if (hours > 0 && remainingMinutes > 0) {
      return `${hours}h ${remainingMinutes}min`;
    } else if (hours > 0) {
      return `${hours}h`;
    } else {
      return `${remainingMinutes}min`;
    }
  }
}

// ===== 今日总计练琴时间获取（供学生卡 & 实时练琴卡统一显示）=====
// 说明：与详情弹窗“今日总计”保持一致，包含段内+段外（已按排除规则扣除）
// 为避免重复 heavy 计算，做简单缓存；数据更新时可调用 window.invalidateTodayPracticeTotals()
window.__todayPracticeTotalsCache = { dateKey:null, map:{} };
window.invalidateTodayPracticeTotals = function(){ window.__todayPracticeTotalsCache.dateKey=null; window.__todayPracticeTotalsCache.map={}; };
function getTodayTotalPracticeMinutes(studentName){
  try {
    const todayKey = getTodayDateString();
    const cache = window.__todayPracticeTotalsCache;
    if(cache.dateKey !== todayKey){ cache.dateKey = todayKey; cache.map = {}; }
    if(cache.map[studentName] != null) return cache.map[studentName];
    const { totalSec } = computeDayInOut(studentName, todayKey);
    const totalMin = Math.floor(totalSec / 60);
    cache.map[studentName] = totalMin;
    return totalMin;
  } catch(e){ console.warn('[todayTotal] 计算失败', studentName, e); return 0; }
}

function openStudentDetail(name){
  // 设置当前学生名称用于后续剔除来源按钮引用
  window.__currentDetailStudent=name;
  // 预加载最近7天（异步）
  const today=new Date();
  const preload=[];
  for(let i=0;i<7;i++){
    const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
    const ds=formatDate(d);
    if(!attendanceRecordsCache[ds]&&isOnline&&database){
      preload.push(database.ref(`attendanceRecords/${ds}`).once('value').then(s=>{attendanceRecordsCache[ds]=s.val()||null;}));
    }
    if(!dailyPracticeRecords[ds]&&isOnline&&database){
      preload.push(database.ref(`practiceRecords/${ds}`).once('value').then(s=>{
        const v=s.val();if(v){dailyPracticeRecords[ds]=v;try{localStorage.setItem('practiceRecords_'+ds,JSON.stringify(v));}catch(e){}}
      }));
    }
  }
  Promise.all(preload).finally(()=>{
  const info=getStudentInfo(name);
    const practice=realTimePracticeMap[name];
    const todayKey=getTodayDateString();
    const excuse=(excuseData[todayKey]||{})[name];
    const now=new Date(),wd=now.getDay(),curMin=now.getHours()*60+now.getMinutes();
    const presentSet=new Set();rooms.forEach(r=>{if(r.student)presentSet.add(r.student);});
    const todayExcuses=excuseData[todayKey]||{};
    const currentStatus=getStudentCurrentStatus(name,presentSet,todayExcuses,wd,curMin);
    
    // 🔥 考勤历史记录
    const history=[];
    for(let i=0;i<7;i++){
      const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
      const ds=formatDate(d);
      
      const isToday=(ds===getTodayDateString());
      let st = 'no-data';
      
      if(isToday){
        // 今日：使用实时数据
        const realtimeDetail = buildRealtimeAttendanceDetail(name, ds);
        if(realtimeDetail.excused > 0) st = 'excused';
        else if(realtimeDetail.present > 0) st = 'present';
        else if(realtimeDetail.lowEfficiency > 0) st = 'low_efficiency';
        else if(realtimeDetail.absent > 0) st = 'absent';
        else st = 'pending';
      } else {
        // 🔥 历史日：直接使用详细记录构建函数的结果
        const isToday_check = (ds === getTodayDateString());
        const rec = attendanceRecordsCache[ds];
        let realtime = buildRealtimeAttendanceDetail(name, ds);
        let finalDetail;
        
        if(isToday_check){
          finalDetail = realtime;
        } else {
          let stale = false;
          if(rec && rec.lastUpdated){
            if(Date.now() - rec.lastUpdated > SNAPSHOT_STALE_MS) stale = true;
          } else if(rec && !rec.lastUpdated){
            stale = true;
          }
          
          if(!rec || stale){
            finalDetail = realtime;
          } else {
            const snapDetail = buildSnapshotAttendanceDetail(name, ds, rec);
            finalDetail = mergeAttendanceDetail(snapDetail, realtime);
          }
        }
        
        // 🔥 直接根据详细记录的状态分布来判断整体状态
        if(finalDetail.excused > 0 && finalDetail.present === 0 && finalDetail.lowEfficiency === 0 && finalDetail.absent === 0) {
          st = 'excused'; // 全天请假
        } else if(finalDetail.present > 0) {
          st = 'present'; // 有出勤
        } else if(finalDetail.lowEfficiency > 0) {
          st = 'low_efficiency'; // 有低效
        } else if(finalDetail.absent > 0) {
          st = 'absent'; // 🔥 有缺勤记录就显示缺勤
        } else if(finalDetail.pending > 0) {
          st = 'pending'; // 待考勤
        } else {
          st = 'no-data'; // 无数据
        }
      }
      
      history.push({date:ds,status:st});
    }

    // 🔥 练琴明细：使用与考勤详情相同的数据源和计算逻辑
    const practiceRows=(function(){
      const rows=[];let aggExcluded=0;
      function mergeIntervalsBasic(arr){
        if(!arr||!arr.length) return [];
        const list=arr.map(iv=>({start:iv.start,end:iv.end})).sort((a,b)=>a.start-b.start);
        const merged=[list[0]];
        for(let i=1;i<list.length;i++){
          const last=merged[merged.length-1],cur=list[i];
            if(cur.start<=last.end){ if(cur.end>last.end) last.end=cur.end; }
            else merged.push({...cur});
        }
        return merged;
      }
      for(let i=0;i<7;i++){
        const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
        const dateStr=formatDate(d);const isToday=dateStr===todayKey;
        const {inSec,outSec,totalSec,rawIntervals,cleanIntervals,excludedBreakdown,outIntervals}=computeDayInOut(name,dateStr);
        // 使用并集方式计算剔除秒，避免重叠区间导致 rawTotal 过大
        const rawUnion=mergeIntervalsBasic(rawIntervals);
        const cleanUnion=mergeIntervalsBasic(cleanIntervals);
        const rawUnionSec=rawUnion.reduce((s,iv)=>s+Math.floor((iv.end-iv.start)/1000),0);
        const cleanUnionSec=cleanUnion.reduce((s,iv)=>s+Math.floor((iv.end-iv.start)/1000),0);
        let excludedSec=Math.max(0,rawUnionSec-cleanUnionSec);
        // 理论上上限：全部休息+夜间(150)；粗略保护：若超过 450 记录日志
        if(excludedSec>450*60){ console.warn('[practiceRows] excludedSec unusually large', {student:name,date:dateStr,excludedSec}); }
        const excludedMin=Math.floor(excludedSec/60);aggExcluded+=excludedMin;
  rows.push({date:dateStr,isToday,inMin:Math.floor(inSec/60),outMin:Math.floor(outSec/60),total:Math.floor(totalSec/60),excludedMin,excludedBreakdown,outIntervals});
      }
      window.__lastPracticeExcludedAgg=aggExcluded;
      return rows.sort((a,b)=>b.date.localeCompare(a.date));
    })();

    // 🔥 修改：使用新的时间格式化函数
    const practiceRowsHtml = practiceRows.map(row => {
  const breakdownBtn = row.excludedBreakdown && row.excludedBreakdown.length ? `<button class=\"mini-help-btn\" onclick=\"showExcludedBreakdown(this,'${row.date}')\" title=\"${t('break.excluded_minutes','剔除分钟')}\">?</button>`:'';
      return `<tr ${row.isToday ? 'class=\"today-row\"' : ''}>
        <td class=\"date-cell\">${row.date}${row.isToday ? `<small style=\"color:#007bff;\">(${t('time.today', '今天')})</small>` : ''}<div style=\"font-size:10px;color:#888;\">${t('break.excluded_minutes','剔除分钟')}: ${row.excludedMin} ${breakdownBtn}</div></td>
        <td>${formatPracticeMinutes(row.inMin)}</td>
  <td>${formatPracticeMinutes(row.outMin)}${`<span data-outbtn='1'>${row.outMin>0?`<button class=\"mini-help-btn\" onclick=\"showOutSlotBreakdown(this,'${row.date}')\" title=\"${t('practice.out_slot_segments','段外练琴区间')}\">?</button>`:''}</span>`}</td>
        <td class=\"total-duration-cell\">${formatPracticeMinutes(row.total)}</td>
      </tr>`;
    }).join('') || `<tr><td colspan=\"4\" style=\"text-align:center;color:#999;\">${t('time.no_records', '无记录')}</td></tr>`;

    // 🔥 今日总时长也使用统一的格式化函数
    const todayRow = practiceRows.find(r => r.isToday);
    const todayTotalMin = todayRow ? todayRow.total : 0;
    const todayTotalHourText = formatTotalPracticeTime(todayTotalMin);

    const historyHtml=history.map((h,i)=>{
      const cls=(function(st){
        switch(st){
          case 'present':return 'present';
          case 'absent':return 'absent';
          case 'excused':return 'excused';
          case 'low_efficiency':return 'low-efficiency';
          case 'pending':return 'pending';
          default:return 'no-data';
        }
      })(h.status);
      const day=i+1;
      return `<div class="history-day ${cls}" onclick="showDayAttendanceDetail('${name}','${h.date}',${day})">${day}</div>`;
    }).join('');

    const statusNow=getStatusText(currentStatus);
    const dur=practice ? (() => {
      // 计算去除准备时间的当前练习时长
      const currentSess = practiceSessionTracker.get(`${practice.name}__${practice.room}__${practice.startTime}`);
      if (currentSess && currentSess.isActive) {
        const now = Date.now();
        const activeStart = Math.max(currentSess.prepEndTime, currentSess.startTime + 60000);
        const effectiveSec = Math.max(0, Math.floor((now - activeStart) / 1000));
        return formatDuration(effectiveSec);
      }
      // 如果找不到会话追踪器，回退到原逻辑但减去1分钟
      const adjustedSec = Math.max(0, practice.currentSec - 60);
      return formatDuration(adjustedSec);
    })() : t('time.no_practice','0分钟');
    const practiceStartText = practice
      ? new Date(practice.startTime).toLocaleTimeString(currentLanguage==='zh'?'zh-CN':'en-US',{hour:'2-digit',minute:'2-digit'})
      : '--';

    const slotDayMap={1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
    const key=slotDayMap[wd];
    let timeSlotInfo='';
    if(currentStatus!=='excused'){
      if(key && studentTimeSlots[name] && studentTimeSlots[name][key] && studentTimeSlots[name][key].length){
        const slots=studentTimeSlots[name][key];
        const slotHtml=slots.map(s=>{
          const sm=timeToMinutes(s.start),em=timeToMinutes(s.end);
          const isCur=curMin>=sm&&curMin<em;
          return `<span class="time-slot-tag${isCur?' current':''}">${isCur?'🎵 ':''}${s.start}-${s.end}</span>`;
        }).join('');
        timeSlotInfo=`<div class="metric-item time-slots-container">
          <div class="metric-icon">📅</div>
          <div class="metric-content">
            <div class="metric-label">${t('student.time_slot', '考勤时间段')}</div>
            <div class="metric-value time-slots-wrapper">${slotHtml}</div>
          </div>
        </div>`;
      }else{
        timeSlotInfo=`<div class="metric-item">
          <div class="metric-icon">📅</div>
          <div class="metric-content">
            <div class="metric-label">${t('student.time_slot', '考勤时间段')}</div>
            <div class="metric-value">${(wd===0||wd===6)?t('room.weekend', '周末'):t('room.no_arrangement', '无安排')}</div>
          </div>
        </div>`;
      }
    }
    
    // 🔥 设置模态框内容
    document.getElementById('studentDetailTitle').textContent=name+' - '+t('student.detail.title','学生详情');
    document.getElementById('studentDetailContent').innerHTML=`
      <div class="student-detail-content">
        <div class="student-profile-card">
          <h2 class="profile-name">${name}</h2>
          <div class="profile-meta">
            <span>${info.major||''}</span><span class="meta-divider">•</span>
            <span>${info.grade||t('student.not_set','未设置')}</span>
          </div>
        </div>
        <div class="today-status-card ${getStatusClass(currentStatus)}">
          <div class="status-header">
            <h3 class="status-title">${t('student.today_attendance','今日考勤')}</h3>
            <div class="status-badge ${getStatusClass(currentStatus)}">${getDetailedStatusText(name, currentStatus, practice, wd, curMin)}</div>
          </div>
          <div class="status-metrics">
            ${timeSlotInfo}
            <div class="metric-item practice-status-container">
              <div class="metric-icon">🎵</div>
              <div class="metric-content">
                <div class="metric-label">${t('practice.status', '练琴状态')}</div>
                <div class="metric-value practice-status-compact">
                  <div class="practice-info-row"><span class="practice-label">${t('practice.start_time', '开始时间:')}</span><strong class="practice-value">${practiceStartText}</strong></div>
                  <div class="practice-info-row"><span class="practice-label">${t('practice.room', '琴房:')}</span><strong class="practice-value">${practice?practice.room:t('student.not_in_room','不在琴房')}</strong></div>
                  <div class="practice-info-row"><span class="practice-label">${t('practice.current_practice', '当前练习:')}</span><strong class="practice-value current-practice">${dur}</strong></div>
                  <div class="practice-info-row"><span class="practice-label">${t('practice.today_total', '今日总计:')}</span><strong class="practice-value total-practice">${todayTotalHourText}</strong></div>
                </div>
              </div>
            </div>
          </div>
          ${excuse?`<div class="excuse-info">
            <div class="excuse-header"><i class="excuse-icon">📝</i><span class="excuse-title">${t('excuse.reason','请假原因')}</span></div>
            <div class="excuse-content">
              <p class="excuse-reason">${excuse.reason||''}</p>
              ${excuse.durationText?`<p class="excuse-approver">${t('excuse.duration_text','请假时长')}: ${excuse.durationText}</p>`:''}
              ${excuse.endDate?`<p class="excuse-approver">${t('excuse.end_date','结束日期')}: ${excuse.endDate}</p>`:''}
            </div>
          </div>`:''}
        </div>
        <div class="card attendance-history">
          <div class="history-title">${t('attendance.history','最近7天考勤')}</div>
          <div class="history-timeline">${historyHtml}</div>
        </div>
        <div class="card">
          <div class="card-header">
            <h4 class="card-title">${t('practice.recent_7days','🗓️ 最近7天练琴明细')}</h4>
            <p style="font-size:.75rem;color:var(--medium-gray);margin:8px 0 0;">
              ${t('practice.time_slot_desc','段内=规定练琴时段 | 段外=非规定时段')} 
              <span style="color:#007bff;">${t('practice.data_source','• 数据来源：实时计算')}</span>
            </p>
          </div>
          <div class="data-table-container" style="max-height:230px;overflow-y:auto;">
            <table class="data-table">
              <thead><tr><th>${t('report.date','日期')}</th><th>${t('practice.in_slot','段内')}</th><th>${t('practice.out_slot','段外')}</th><th>${t('report.total','总计')}</th></tr></thead>
              <tbody>${practiceRowsHtml}</tbody>
            </table>
          </div>
        </div>
      </div>`;
    
    // 🔥 使用新的流畅模态框打开函数
    openModalSmooth('studentDetailModal');

  });
}
function updatePracticeSessions(){
  const now = Date.now();
  let updatedCount = 0;
  
  practiceSessionTracker.forEach(sess => {
    if(!sess.isActive) return;
    
    try {
      // 🔥 更新 _lastTick
      sess._lastTick = now;
      
      // 🔥 如果超过准备时间，开始正式计时
      if(now >= sess.prepEndTime && !sess.actualStartTime) {
        sess.actualStartTime = sess.prepEndTime;
        console.log(`开始正式计时: ${sess.studentName}`);
      }
      
      // 🔥 实时更新时长（不修改 endTime）
      if(sess.actualStartTime && now > sess.actualStartTime) {
        const originalEndTime = sess.endTime;
        sess.endTime = now;
        recalcSessionTimes(sess);
        sess.endTime = originalEndTime; // 恢复原值
        
        // 🔥 验证结果
        if(isNaN(sess.inSlotTime) || isNaN(sess.outSlotTime)) {
          console.error(`更新会话时发现NaN: ${sess.studentName}`);
          sess.inSlotTime = 0;
          sess.outSlotTime = 0;
        }
        
        updatedCount++;
      }
    } catch(e) {
      console.error(`更新会话出错: ${sess.studentName}`, e);
    }
  });
  
  if(updatedCount > 0) {
    addSyncLog(`🔄 更新了 ${updatedCount} 个活跃会话`);
  }
}
function getDetailedStatusText(studentName, currentStatus, practice, weekday, currentMinute) {
  // 如果是请假，直接返回请假状态
  if (currentStatus === 'excused') {
    return t('status.excused', '请假');
  }
  
  // 获取学生今天的时间段
  const slotDayMap = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = slotDayMap[weekday];
  
  // 检查是否在时间段内
  let inTimeSlot = false;
  if (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) {
    const slots = studentTimeSlots[studentName][key];
    inTimeSlot = slots.some(slot => {
      const startMin = timeToMinutes(slot.start);
      const endMin = timeToMinutes(slot.end);
      return currentMinute >= startMin && currentMinute < endMin;
    });
  }
  
  if (inTimeSlot) {
    // 在时间段内：根据是否在琴房判断状态
    if (practice) {
      // 在琴房练琴
      return t('status.present', '出勤');
    } else {
      // 不在琴房
      return t('status.absent', '缺勤');
    }
  } else {
    // 不在时间段内：根据是否在琴房显示自主练琴状态
    if (practice) {
      return currentLanguage === 'zh' ? '自主练琴' : 'Self Practice';
    } else {
      return currentLanguage === 'zh' ? '目前未练琴' : 'Not Practicing';
    }
  }
}
// 🆕 应用排除时间到时间区间
function applyExclusionToInterval(startMs, endMs) {
  const res = [];
  let cursor = startMs;
  
  while(cursor < endMs) {
    const d = new Date(cursor);
    const min = d.getHours() * 60 + d.getMinutes();
    const wd = d.getDay();
    const next = Math.min(endMs, cursor + 60000);
    
    if(!isExcludedTime(min, wd)) {
      res.push([cursor, next]);
    }
    cursor = next;
  }
  
  return res;
}

// 🆕 合并连续的时间片段
function mergeConsecutiveSegments(segments) {
  if(segments.length === 0) return [];
  
  // 按开始时间排序
  segments.sort((a, b) => a[0] - b[0]);
  
  const merged = [];
  let current = segments[0];
  
  for(let i = 1; i < segments.length; i++) {
    const next = segments[i];
    
    // 如果当前段的结束时间等于下一段的开始时间，合并它们
    if(current[1] === next[0]) {
      current[1] = next[1];
    } else {
      merged.push(current);
      current = next;
    }
  }
  
  merged.push(current);
  return merged;
}

// 🆕 共享函数：从汇总数据重建时间区间（增强版）
function reconstructIntervalsFromSummary(studentName, date, rec, isToday = false) {
  const intervals = [];
  
  const inSlotSec = rec.inSlotSeconds || rec.inSlot || 0;
  const outSlotSec = rec.outSlotSeconds || rec.outSlot || 0;
  
  console.log(`${studentName} ${date} 使用累计时长重构: 段内${Math.round(inSlotSec/60)}分钟, 段外${Math.round(outSlotSec/60)}分钟`);
  
  if(inSlotSec === 0 && outSlotSec === 0) {
    return intervals;
  }
  
  // 获取学生当天的时间段安排
  const target = new Date(date);
  const wd = target.getDay();
  const map = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = map[wd];
  const slots = (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) 
                  ? studentTimeSlots[studentName][key] : [];
  
  // 🔥 重构段内练琴区间（应用排除时间）
  if(inSlotSec > 0 && slots.length > 0) {
    let remainingSec = inSlotSec;
    
    slots.forEach(slot => {
      if(remainingSec <= 0) return;
      
      const slotStartMs = new Date(`${date}T${slot.start}:00`).getTime();
      const slotEndMs = new Date(`${date}T${slot.end}:00`).getTime();
      
      // 🔥 应用排除时间过滤
      const validSegments = applyExclusionToInterval(slotStartMs, slotEndMs);
      const totalValidMs = validSegments.reduce((sum, seg) => sum + (seg[1] - seg[0]), 0);
      const totalValidSec = Math.floor(totalValidMs / 1000);
      
      if(totalValidSec > 0) {
        // 计算这个时间段应该使用多少秒
        const useSec = Math.min(remainingSec, totalValidSec);
        
        if(useSec > 0) {
          // 🔥 按比例分配到有效时间段
          let allocatedSec = 0;
          const mergedSegments = mergeConsecutiveSegments(validSegments);
          
          mergedSegments.forEach((segment, idx) => {
            if(allocatedSec >= useSec) return;
            
            const segmentDurMs = segment[1] - segment[0];
            const segmentDurSec = Math.floor(segmentDurMs / 1000);
            
            // 计算这个片段应该分配多少时间
            let segmentUseSec;
            if(idx === mergedSegments.length - 1) {
              // 最后一个片段，使用剩余时间
              segmentUseSec = useSec - allocatedSec;
            } else {
              // 按比例分配
              segmentUseSec = Math.min(
                Math.floor(useSec * segmentDurSec / totalValidSec),
                useSec - allocatedSec,
                segmentDurSec
              );
            }
            
            if(segmentUseSec > 0) {
              intervals.push({
                start: segment[0],
                end: segment[0] + segmentUseSec * 1000,
                room: isToday ? t('room.historical_rebuild', '（历史重建）') : t('room.practice_room', '练琴房'),
                slotName: slot.name || `${slot.start}-${slot.end}`,
                type: 'inSlot'
              });
              
              allocatedSec += segmentUseSec;
              console.log(`添加段内区间: ${slot.start}-${slot.end}, 使用${segmentUseSec}秒 (排除后)`);
            }
          });
          
          remainingSec -= allocatedSec;
        }
      }
    });
    
    // 如果还有剩余的段内时间没有分配完
    if(remainingSec > 0) {
      console.warn(`段内时间未完全分配，剩余${remainingSec}秒`);
    }
  }
  
  // 🔥 重构段外练琴区间（应用排除时间）
  if(outSlotSec > 0) {
    // 选择一个段外时间进行重构，比如11:30开始
    const baseTime = new Date(`${date}T11:30:00`).getTime();
    const estimatedEndTime = baseTime + outSlotSec * 2000; // 预估需要2倍时间来容纳排除时间
    
    // 🔥 应用排除时间过滤
    const validSegments = applyExclusionToInterval(baseTime, estimatedEndTime);
    
    let allocatedSec = 0;
    const mergedSegments = mergeConsecutiveSegments(validSegments);
    
    mergedSegments.forEach(segment => {
      if(allocatedSec >= outSlotSec) return;
      
      const segmentDurMs = segment[1] - segment[0];
      const segmentDurSec = Math.floor(segmentDurMs / 1000);
      const needSec = outSlotSec - allocatedSec;
      const useSec = Math.min(needSec, segmentDurSec);
      
      if(useSec > 0) {
        intervals.push({
          start: segment[0],
          end: segment[0] + useSec * 1000,
          room: isToday ? t('room.historical_rebuild', '（历史重建）') : t('room.practice_room', '练琴房'),
          type: 'outSlot'
        });
        
        allocatedSec += useSec;
        console.log(`添加段外区间: ${new Date(segment[0]).toLocaleTimeString()}, 使用${useSec}秒 (排除后)`);
      }
    });
    
    // 如果11:30开始的时间不够，尝试其他时间点
    if(allocatedSec < outSlotSec) {
      const remainingOutSec = outSlotSec - allocatedSec;
      console.log(`11:30时段不够，尝试其他时间分配剩余${remainingOutSec}秒`);
      
      // 尝试早上10:00
      const morningTime = new Date(`${date}T10:00:00`).getTime();
      const morningEndTime = morningTime + remainingOutSec * 2000;
      const morningSegments = applyExclusionToInterval(morningTime, morningEndTime);
      const morningMerged = mergeConsecutiveSegments(morningSegments);
      
      let morningAllocated = 0;
      morningMerged.forEach(segment => {
        if(morningAllocated >= remainingOutSec) return;
        
        const segmentDurSec = Math.floor((segment[1] - segment[0]) / 1000);
        const needSec = remainingOutSec - morningAllocated;
        const useSec = Math.min(needSec, segmentDurSec);
        
        if(useSec > 0) {
          intervals.push({
            start: segment[0],
            end: segment[0] + useSec * 1000,
            room: isToday ? t('room.historical_rebuild', '（历史重建）') : t('room.practice_room', '练琴房'),
            type: 'outSlot'
          });
          
          morningAllocated += useSec;
          console.log(`添加早间段外区间: ${new Date(segment[0]).toLocaleTimeString()}, 使用${useSec}秒 (排除后)`);
        }
      });
    }
  }
  
  // 🔥 按时间排序
  intervals.sort((a, b) => a.start - b.start);
  
  console.log(`最终生成${intervals.length}个练琴区间 (已应用排除时间过滤)`);
  return intervals;
}


// 🔥 修复：获取历史日期的练琴区间
function getHistoryIntervals(studentName, date){
  const intervals = [];
  
  // 1. 首先尝试从 dailyPracticeRecords 获取详细会话记录
  const rec = dailyPracticeRecords[date] && dailyPracticeRecords[date][studentName];
  
  if(rec && Array.isArray(rec.sessions) && rec.sessions.length > 0) {
    // 使用详细的会话记录重构区间
    rec.sessions.forEach(session => {
      if(session.start && session.end) {
        const start = session.start + 60000; // 去除1分钟准备时间
        if(start < session.end) {
          intervals.push({
            start,
            end: session.end,
            room: session.room || t('room.practice_room', '练琴房')
          });
        }
      }
    });
    
    console.log(`${studentName} ${date} 使用详细会话记录，生成${intervals.length}个区间`);
    return intervals;
  }
  
  if(!rec) { console.log(`没有找到 ${studentName} 在 ${date} 的数据`); return intervals; }
  // 不再 summary 重建
  return intervals;
}

// 修改 getStudentTodayIntervals 函数
function getStudentTodayIntervals(studentName){
  const todayKey = getTodayDateString();
  const intervals = [];

  // 1. 已结束会话（优先使用详细的 sessions 数据）
  const rec = dailyPracticeRecords[todayKey] && dailyPracticeRecords[todayKey][studentName];
  if(rec && Array.isArray(rec.sessions)){
    rec.sessions.forEach(s=>{
      if(!s.start || !s.end) return;
      const start = s.start + 60000; // 去除1分钟准备
      if(start >= s.end) return;
      intervals.push({
        start,
        end: s.end,
        room: s.room || t('room.practice_room', '练琴房')
      });
    });
  }

  // 2. 正在进行的会话（practiceSessionTracker）
  practiceSessionTracker.forEach(sess=>{
    if(!sess.isActive) return;
    if(sess.studentName !== studentName) return;
    const activeStart = Math.max(sess.prepEndTime, sess.startTime + 60000);
    const end = Date.now();
    if(activeStart < end){
      intervals.push({
        start: activeStart,
        end,
        room: sess.roomName
      });
    }
  });

  // 不再 summary 重建

  return intervals;
}


/* =============== 报告 =============== */
function getDateSpan(start,end){const res=[];let d=new Date(start),ed=new Date(end);while(d<=ed){res.push(formatDate(d));d.setDate(d.getDate()+1);}return res;}
function loadAttendanceRange(start,end){
  if(!isOnline)return Promise.resolve();
  const dates=getDateSpan(start,end);
  const tasks=[];
  dates.forEach(d=>{
    if(!attendanceRecordsCache[d]){
      tasks.push(database.ref(`attendanceRecords/${d}`).once('value').then(s=>{attendanceRecordsCache[d]=s.val()||null;}));
    }
  });
  return Promise.all(tasks);
}
function collectReportData(start,end){
  const dates=getDateSpan(start,end);
  const daily=[],agg=new Map();
  dates.forEach(date=>{
    const rec=attendanceRecordsCache[date];
    if(!rec){daily.push({date,total:0,present:0,absent:0,excused:0,rate:0});return;}
    const all=[...(rec.students||[]),...(rec.endedSlots||[])];
    let present=0,excused=0,absent=0,total=all.length;
    all.forEach(s=>{
      const st=s.finalAttendanceStatus;
      if(st==='present')present++;
      else if(st==='excused')excused++;
      else if(st==='absent')absent++;
      if(!agg.has(s.name))agg.set(s.name,{name:s.name,major:s.major||'',present:0,absent:0,excused:0,total:0});
      const a=agg.get(s.name);
      a.total++;
      if(st==='present')a.present++;
      else if(st==='excused')a.excused++;
      else if(st==='absent')a.absent++;
    });
    const rate=total?((present+excused)/total*100).toFixed(1):'0';
    daily.push({date,total,present,absent,excused,rate});
  });
  const students=[...agg.values()].map(s=>{
    s.rate=s.total?((s.present+s.excused)/s.total*100).toFixed(1):'0.0';return s;
  }).sort((a,b)=>b.rate-a.rate);
  return {daily,students};
}
function renderReportHTML(data,start,end){
  return `
  <div class="card">
    <h4>${t('report.analysis_title','📊 考勤分析报告')}</h4>
    <div class="student-details">
      <div class="detail-item"><div class="detail-label">${t('report.period','统计周期')}</div><div class="detail-value">${start} ${t('report.to','至')} ${end} (${data.daily.length}${t('report.days','天')})</div></div>
      <div class="detail-item"><div class="detail-label">${t('report.participants','参与学生')}</div><div class="detail-value">${data.students.length}${t('report.people','人')}</div></div>
    </div>
  </div>
  <div class="card">
    <h4>${t('report.daily_trend','📈 每日考勤趋势')}</h4>
    <div class="data-table-container" style="max-height:300px;overflow-y:auto;">
      <table class="data-table daily-trend">
        <thead><tr>
          <th>${t('report.date','日期')}</th>
          <th>${t('report.total','合计')}</th>
          <th>${t('stats.present','出勤')}</th>
          <th>${t('stats.absent','缺勤')}</th>
          <th>${t('stats.excused','请假')}</th>
          <th>${t('attendance.rate','出勤率')}</th>
        </tr></thead>
        <tbody>${data.daily.map(d=>`<tr>
          <td>${d.date}</td><td>${d.total}</td><td>${d.present}</td><td>${d.absent}</td><td>${d.excused}</td><td>${d.rate}%</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <h4>${t('report.student_stats','👥 学生考勤统计')}</h4>
    <div class="data-table-container" style="max-height:400px;overflow-y:auto;">
      <table class="data-table student-stats">
        <thead><tr>
          <th>${t('student.name','姓名')}</th>
          <th>${t('student.major','专业')}</th>
          <th>${t('stats.present','出勤')}</th>
          <th>${t('stats.absent','缺勤')}</th>
          <th>${t('stats.excused','请假')}</th>
          <th>${t('attendance.rate','出勤率')}</th>
        </tr></thead>
        <tbody>${data.students.map(s=>`<tr>
          <td>${s.name}</td><td>${s.major}</td><td>${s.present}</td><td>${s.absent}</td><td>${s.excused}</td><td>${s.rate}%</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>
    <div class="export-options">
      <button class="btn btn-primary" onclick="generateReport()"><span>🔄</span>${t('report.regenerate','重新生成')}</button>
    </div>
  </div>`;
}
function generateReport(){
  const s=document.getElementById('startDate').value;
  const e=document.getElementById('endDate').value;
  if(!s||!e){alert(t('msg.select_dates','请选择开始和结束日期'));return;}
  if(new Date(s)>new Date(e)){alert(t('msg.date_range_error','开始日期不能晚于结束日期'));return;}
  const cont=document.getElementById('reportContent');
  cont.innerHTML='<div class="loading"><div class="spinner"></div></div>';
  loadAttendanceRange(s,e).then(()=>{
    const data=collectReportData(s,e);
    cont.innerHTML=renderReportHTML(data,s,e);
  }).catch(err=>{
    cont.innerHTML=`<div class="empty-state"><div class="empty-state-icon">⚠️</div><div class="empty-state-title">${t('empty.load_failed','加载失败')}</div><div class="empty-state-description">${err.message}</div></div>`;
  });
}

/* =============== 同步 / 缓存 =============== */
function loadAllCoreData(){
  if(!database)return;
  const ready={rooms:false,students:false,excuses:false,slots:false};
  function maybeInitialRender(){
    if(Object.values(ready).every(v=>v)){
      addSyncLog('✅ 首屏数据就绪，执行初次渲染');
  updateStatsPanel();
  renderPracticeArea();
  renderExcusePanel();
  if(currentTab==='students')renderStudentList();
  // 首屏完成后立即计算排行榜（避免“尚未计算”停留）
  if(typeof computeLeaderboard==='function') computeLeaderboard();
    }
  }
  Promise.all([
  database.ref('rooms').once('value').then(s=>{if(Array.isArray(s.val())){rooms=s.val();buildRealTimePracticeFromRooms();}ready.rooms=true;maybeInitialRender();}),
  database.ref('studentDatabase').once('value').then(s=>{if(s.val())studentDatabase=s.val();ready.students=true;maybeInitialRender(); scheduleLeaderboardUpdate&&scheduleLeaderboardUpdate();}),
  database.ref('excuseData').once('value').then(s=>{if(s.val())excuseData=s.val();ready.excuses=true;maybeInitialRender();}),
  database.ref('studentTimeSlots').once('value').then(s=>{const raw=s.val()||{};const before=Object.values(raw).reduce((sum,x)=>sum + (x?.monday?.length||0)+(x?.tuesday?.length||0)+(x?.wednesday?.length||0)+(x?.thursday?.length||0)+(x?.friday?.length||0),0);studentTimeSlots=normalizeStudentTimeSlots(raw);const after=Object.values(studentTimeSlots).reduce((sum,x)=>sum + (x?.monday?.length||0)+(x?.tuesday?.length||0)+(x?.wednesday?.length||0)+(x?.thursday?.length||0)+(x?.friday?.length||0),0);addSyncLog(`🧮 首次加载 timeSlots 归一化 ${before} -> ${after}`);ready.slots=true;maybeInitialRender(); scheduleLeaderboardUpdate&&scheduleLeaderboardUpdate();})
  ]).catch(e=>addSyncLog('❌ 加载失败 '+e.message));
}
function forceSync(){
  if(!isOnline){alert(t('msg.sync_required','需要网络连接才能同步数据'));return;}
  addSyncLog('🔄 '+t('sync.force_sync','强制同步'));
  loadAllCoreData();
}
function clearLocalCache(){
  if(!confirm(t('msg.clear_cache_confirm','确定要清除本地缓存吗？')))return;
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith('practiceRecords_'))localStorage.removeItem(k);
  });
  addSyncLog('🗑️ '+t('msg.cache_cleared','本地缓存已清除'));
  alert(t('msg.cache_cleared','本地缓存已清除'));
}

/* =============== Tab 切换 =============== */
function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick').includes(tab)));
  document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
  const host = document.getElementById(tab+'Tab');
  if(host) host.style.display='block';
  if(tab==='dashboard'){
    updateStatsPanel();
    renderPracticeArea();
    renderExcusePanel();
  } else if(tab==='students'){
    renderStudentList();
  } else if(tab==='leaderboard'){
    // 进入排行榜时若数据为空或超过5分钟，重新计算
    const now=Date.now();
    if(!leaderboardState.raw.length || (now - leaderboardState.lastCompute > 5*60*1000)){
      computeLeaderboard();
    }
  }
}
function refreshCurrentTabContent(){
  if(currentTab==='dashboard'){updateStatsPanel();renderPracticeArea();renderExcusePanel();}
  else if(currentTab==='students'){renderStudentList();}
}
/* ===== 性能：渲染函数去抖与合批 ===== */
;(function(){
  const DEBOUNCE_MS=120; // 足够短，不影响体验
  function debounce(fn,delay){let t;return function(){const ctx=this,args=arguments;clearTimeout(t);t=setTimeout(()=>fn.apply(ctx,args),delay);};}
  // 如果原函数已经存在，则替换为去抖包装版本（保留名称用于栈追踪）
  if(typeof window.renderPracticeArea==='function') window.renderPracticeArea = debounce(window.renderPracticeArea,DEBOUNCE_MS);
  if(typeof window.renderStudentList==='function') window.renderStudentList = debounce(window.renderStudentList,DEBOUNCE_MS);
  if(typeof window.updateStatsPanel==='function') window.updateStatsPanel = debounce(window.updateStatsPanel,DEBOUNCE_MS);
  if(typeof window.renderExcusePanel==='function') window.renderExcusePanel = debounce(window.renderExcusePanel,DEBOUNCE_MS);
})();

/* ===== 性能：数据更新合批调度 ===== */
;(function(){
  const pendingKeys=new Set();
  let scheduled=false;
  function flush(){scheduled=false;const keys=[...pendingKeys];pendingKeys.clear();
    // 简单策略：按键触发对应渲染
    if(keys.includes('practice')){ if(currentTab==='dashboard'){renderPracticeArea();} }
    if(keys.includes('students')){ if(currentTab==='students'){renderStudentList();} }
    if(keys.includes('stats')){ if(currentTab==='dashboard'){updateStatsPanel();} }
    if(keys.includes('excuse')){ if(currentTab==='dashboard'){renderExcusePanel();} }
  }
  window.scheduleDataUpdate=function(key){pendingKeys.add(key);if(!scheduled){scheduled=true;queueDomUpdate(flush);}}
})();
/* =============== 调试函数 =============== */
function debugStudentData(studentName, date) {
  console.log(`=== 调试学生数据: ${studentName} ${date} ===`);
  
  // 检查原始数据
  const rec = dailyPracticeRecords[date] && dailyPracticeRecords[date][studentName];
  console.log('原始练琴记录:', rec);
  
  // 检查重构的区间
  const intervals = getHistoryIntervals(studentName, date);
  console.log('重构区间:', intervals);
  intervals.forEach((interval, index) => {
    const startTime = new Date(interval.start).toLocaleTimeString();
    const endTime = new Date(interval.end).toLocaleTimeString();
    const duration = Math.round((interval.end - interval.start) / 60000);
    console.log(`  区间${index + 1}: ${startTime} - ${endTime} (${duration}分钟) 房间: ${interval.room}`);
  });
  
  // 检查时间段安排
  const target = new Date(date);
  const wd = target.getDay();
  const map = {1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday'};
  const key = map[wd];
  const slots = (key && studentTimeSlots[studentName] && studentTimeSlots[studentName][key]) 
                  ? studentTimeSlots[studentName][key] : [];
  console.log('时间段安排:', slots);
  
  // 检查每个时间段的重叠计算
  if (slots.length > 0) {
    slots.forEach((slot, index) => {
      const slotStartMs = new Date(`${date}T${slot.start}:00`).getTime();
      const slotEndMs = new Date(`${date}T${slot.end}:00`).getTime();
      const slotDurSec = (slotEndMs - slotStartMs) / 1000;
      const overlapSec = calcOverlapSeconds(intervals, slotStartMs, slotEndMs);
      
      console.log(`时间段${index + 1}: ${slot.start}-${slot.end}`);
      console.log(`  时间段长度: ${Math.round(slotDurSec/60)}分钟`);
      console.log(`  重叠时长: ${Math.round(overlapSec/60)}分钟`);
      console.log(`  出勤阈值: ${Math.round(slotDurSec * 0.6/60)}分钟`);
      console.log(`  判断结果: ${overlapSec >= slotDurSec * 0.6 ? '出勤' : overlapSec >= 300 ? '低效' : '缺勤'}`);
    });
  }
  
  return {rec, intervals, slots};
}
/* =============== 暴露函数 =============== */
window.switchLanguage=switchLanguage;
window.switchTab=switchTab;
window.filterPracticeStatus=filterPracticeStatus;
window.clearPracticeFilters=()=>{document.getElementById('practiceMajorFilter').value='';document.getElementById('practiceGradeFilter').value='';document.getElementById('practiceStudentSearch').value='';filterPracticeStatus();};
window.openStudentDetail=openStudentDetail;
window.closeModal=closeModal;
window.generateReport=generateReport;
window.forceSync=forceSync;
window.clearLocalCache=clearLocalCache;
window.filterStudents=renderStudentList;
window.showDayAttendanceDetail=showDayAttendanceDetail;
window.snapshotTodayAttendance=snapshotTodayAttendance;
window.updatePracticeSessions = updatePracticeSessions; // 🔥 新增

/* =============== 初始化 =============== */
document.addEventListener('DOMContentLoaded',()=>{
  const saved=localStorage.getItem('preferred_language');if(saved)currentLanguage=saved;
  // 🔥 修复：同步按钮状态和页面语言
  syncLanguageButtons();
  updatePageLanguage();
  initFirebase();
  initClock();
  addSyncLog('🚀 系统启动');
});

/* =============== 定时任务 =============== */
// （已迁移到统一调度器）原 30s / 10s setInterval 已禁用，避免重复执行
// 保留代码位置作为文档参考，如需恢复可解开下面注释
/*
// setInterval(()=>{ // 30s 刷新  
//   ...
// },30000);
// setInterval(()=>{ // 10s 会话检查  
//   ...
// },10000);
*/

/* ================= 性能优化内核插入开始 ================= */
// 🔧 统一调度器（替代分散的 setInterval）
;(function(){
  const tasks=[]; // {interval,lastRun,fn}
  function addTask(interval,fn){tasks.push({interval,lastRun:performance.now(),fn});}
  // 注册原有两个周期任务（保持逻辑不变）
  // 30秒任务：练琴UI刷新（替换原 setInterval）
  const old30 = ()=>{
    const now=Date.now();
    Object.keys(realTimePracticeMap).forEach(n=>{const p=realTimePracticeMap[n];p.currentSec=Math.floor((now-p.startTime)/1000);});
    if(currentTab==='dashboard')renderPracticeArea();
    if(currentTab==='students')renderStudentList();
  };
  // 10秒任务：会话检查 + 增量同步（替换原 setInterval）
  const old10 = ()=>{
    const now=Date.now();
    if(now-lastPracticeSessionSweep>=PRACTICE_UPDATE_INTERVAL_MS-500){
      updatePracticeSessions();
      lastPracticeSessionSweep=now;
    }
    syncActiveSessionsIncrement();
  };
  // 停用上面的 setInterval（保留原实现已执行一次，不再继续）
  // 使用统一心跳 1000ms（足够低开销）
  addTask(10000, old10);
  addTask(30000, old30);
  let running=false;
  function heartbeat(){
    const now=performance.now();
    for(const t of tasks){
      if(now - t.lastRun >= t.interval){
        try{t.fn();}catch(e){console.error('[Scheduler]',e);}finally{t.lastRun=now;}
      }
    }
    if(running) setTimeout(heartbeat,1000); // 用 setTimeout 降低与 rAF 的竞争
  }
  running=true;heartbeat();
  window.__perfSchedulerAdd = addTask;
})();

// 🔧 DOM 更新批处理层 queueDomUpdate
;(function(){
  const q=[];let scheduled=false;
  function flush(){scheduled=false;const copy=q.splice(0);for(const job of copy){try{job();}catch(e){console.error('[DOMQ]',e);}}}
  window.queueDomUpdate=function(fn){q.push(fn);if(!scheduled){scheduled=true;requestAnimationFrame(flush);}}
})();

// 🔧 FPS 监控与自动性能模式
;(function(){
  let frames=0;let last=performance.now();
  const history=[]; // 记录最近 N 秒平均FPS
  let perfMode=false;let lastSwitch=0;
  function tick(){
    frames++;
    const now=performance.now();
    if(now-last>=1000){
      const fps=frames*1000/(now-last);
      history.push(fps);if(history.length>15)history.shift();
      frames=0;last=now;
      evaluate(fps);
    }
    requestAnimationFrame(tick);
  }
  function avg(){return history.reduce((a,b)=>a+b,0)/history.length||60;}
  function evaluate(cur){
    const a=avg();
    const now=performance.now();
    // 进入条件：平均 < 47 且 当前 < 50 且 距上次切换 > 5s
    if(!perfMode && history.length>=5 && a<47 && cur<50 && now-lastSwitch>5000){
      enablePerfMode();lastSwitch=now;}
    // 退出条件：平均 > 55 持续（最近 8 次都 > 55）
    if(perfMode && history.slice(-8).every(v=>v>55) && now-lastSwitch>8000){
      disablePerfMode();lastSwitch=now;}
  }
  function enablePerfMode(){perfMode=true;document.documentElement.classList.add('performance-mode');console.log('[Perf] performance-mode enabled');}
  function disablePerfMode(){perfMode=false;document.documentElement.classList.remove('performance-mode');console.log('[Perf] performance-mode disabled');}
  requestAnimationFrame(tick);
})();

// 🔧 可视区域动画暂停（节能）
;(function(){
  if(!('IntersectionObserver' in window)) return;
  const animatedSel='[data-anim="loop"], .pulse, .glow';
  function refresh(){
    document.querySelectorAll(animatedSel).forEach(el=>observer.observe(el));
  }
  const observer=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){e.target.classList.remove('anim-paused');}
      else {e.target.classList.add('anim-paused');}
    });
  },{root:null,threshold:0});
  document.addEventListener('DOMContentLoaded',refresh);
  setTimeout(refresh,2000);
})();

// 🔧 被动事件优化
;(function(){
  const origAdd=EventTarget.prototype.addEventListener;
  EventTarget.prototype.addEventListener=function(type,listener,options){
    // 仅对触摸/滚动缺省注入 passive:true
    if((type==='touchstart'||type==='touchmove'||type==='wheel') ){
      if(options===undefined) options={passive:true};
      else if(typeof options==='boolean') options={capture:options, passive:true};
      else if(options && options.passive===undefined) options.passive=true;
    }
    return origAdd.call(this,type,listener,options);
  };
})();

// 🔧 统一数字渐进更新（示例：可用 queueDomUpdate 包装 setText）
window.safeSetText=function(id,val){queueDomUpdate(()=>{const el=document.getElementById(id);if(el&&el.textContent!==val)el.textContent=val;});};

// 可扩展接口
window.__perfAPI={queueDomUpdate, addPeriodicTask:window.__perfSchedulerAdd};
/* ================= 性能优化内核插入结束 ================= */

/* ===== 自动循环动画打标：为动态生成的元素添加 data-anim="loop"，便于统一暂停/恢复 ===== */
;(function(){
  const LOOP_SELECTOR='.practice-indicator, .time-slot-tag.current, .connection-status.syncing';
  function tag(el){ if(!el || el.dataset.anim==='loop') return; el.dataset.anim='loop'; }
  function scan(root){ (root||document).querySelectorAll(LOOP_SELECTOR).forEach(tag); }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',()=>scan(document)); else scan(document);
  const mo=new MutationObserver(list=>{
    for(const m of list){
      if(m.type==='childList'){
        m.addedNodes.forEach(n=>{ if(n.nodeType===1){ if(n.matches && n.matches(LOOP_SELECTOR)) tag(n); if(n.querySelectorAll) n.querySelectorAll(LOOP_SELECTOR).forEach(tag);} });
      } else if(m.type==='attributes' && m.target && m.target.nodeType===1){
        const el=m.target; if(el.matches && el.matches(LOOP_SELECTOR)) tag(el);
      }
    }
  });
  mo.observe(document.documentElement,{subtree:true,childList:true,attributes:true,attributeFilter:['class']});
})();

</script>
</body>
</html>
<!-- 手动性能模式按钮与脚本 -->
<style id="perf-toggle-style">
.perf-toggle-btn{position:fixed;z-index:2500;right:14px;bottom:14px;width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,#1f6feb,#388bfd);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;cursor:pointer;user-select:none;box-shadow:0 4px 12px rgba(0,0,0,.25);transition:box-shadow .25s,transform .25s;}
.perf-toggle-btn:hover{box-shadow:0 6px 18px rgba(0,0,0,.35);}
.perf-toggle-btn:active{transform:scale(.92);} 
.perf-toggle-btn small{display:block;font-size:9px;line-height:10px;font-weight:500;opacity:.85;}
html.performance-mode .perf-toggle-btn{background:linear-gradient(135deg,#6e7681,#484f58);} 
html.performance-mode .perf-toggle-btn::after{content:'LOW';position:absolute;bottom:-14px;font-size:10px;color:#888;}
@media (max-width:768px){.perf-toggle-btn{right:10px;bottom:10px;width:42px;height:42px;font-size:11px;}}
</style>
<div class="perf-toggle-btn" id="perfToggle" title="性能模式切换 / Performance Mode">FPS</div>
<script>
(function(){
  const btn=document.getElementById('perfToggle');if(!btn)return;
  let manual=false; // 手动锁定状态
  btn.addEventListener('click',()=>{
    manual=!manual;
    if(manual){
      if(!document.documentElement.classList.contains('performance-mode')){
        document.documentElement.classList.add('performance-mode');
      } else {
        document.documentElement.classList.remove('performance-mode');
      }
      btn.classList.add('manual');
    } else {
      btn.classList.remove('manual');
    }
  });
  // 动态显示当前平均FPS（复用前面监控，如未暴露则自行简单统计）
  let last=performance.now(),frames=0,fps=60;function loop(){frames++;const now=performance.now();if(now-last>=1000){fps=Math.round(frames*1000/(now-last));frames=0;last=now;btn.textContent=fps;}
    requestAnimationFrame(loop);}requestAnimationFrame(loop);
})();
</script>
</html>
<!-- 状态徽章深色模式纯色覆盖：防止残留渐变 -->
<style id="status-badge-override">
/* 浅色模式：状态徽章颜色区分 */
.student-status.present, .student-status-compact.present, .status-badge.present { 
  background: #d4edda !important; 
  color: #155724 !important; 
  border: 1px solid #c3e6cb !important; 
  background-image: none !important; 
}
.student-status.absent, .student-status-compact.absent, .status-badge.absent { 
  background: #f8d7da !important; 
  color: #721c24 !important; 
  border: 1px solid #f5c6cb !important; 
  background-image: none !important; 
}
.student-status.practicing-unscheduled, .student-status-compact.practicing-unscheduled, .status-badge.practicing-unscheduled { 
  background: #d1ecf1 !important; 
  color: #0c5460 !important; 
  border: 1px solid #bee5eb !important; 
  background-image: none !important; 
}
.student-status.not-practicing, .student-status-compact.not-practicing, .status-badge.not-practicing { 
  background: #e2e3e5 !important; 
  color: #383d41 !important; 
  border: 1px solid #d6d8db !important; 
  background-image: none !important; 
}
.student-status.excused, .student-status-compact.excused, .status-badge.excused { 
  background: #fff3cd !important; 
  color: #856404 !important; 
  border: 1px solid #ffeaa7 !important; 
  background-image: none !important; 
}
.student-status.pending, .student-status-compact.pending, .status-badge.pending { 
  background: #f8f9fa !important; 
  color: #6c757d !important; 
  border: 1px solid #dee2e6 !important; 
  background-image: none !important; 
}
.student-status.weekend, .student-status-compact.weekend, .status-badge.weekend { 
  background: #e9ecef !important; 
  color: #495057 !important; 
  border: 1px solid #ced4da !important; 
  background-image: none !important; 
}
.student-status.low-efficiency, .student-status-compact.low-efficiency, .status-badge.low-efficiency { 
  background: #ffeaa7 !important; 
  color: #6c5ce7 !important; 
  border: 1px solid #fdcb6e !important; 
  background-image: none !important; 
}

/* 🔥 浅色模式下学生详情中学生姓名卡片为浅灰色 */
@media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
  .student-profile-card {
    background: #f8f9fa !important;
    background-image: none !important;
    color: #333 !important;
    border: 1px solid #e9ecef !important;
  }
  
  .profile-name {
    color: #333 !important;
  }
  
  .profile-details {
    color: #666 !important;
  }
}

@media (prefers-color-scheme: dark) {
  /* 统一纯色（半透明） */
  .student-status.present, .student-status-compact.present, .status-badge.present, .table-status-badge.present { background: rgba(30,95,63,0.65) !important; background-image: none !important; }
  .student-status.absent, .student-status-compact.absent, .status-badge.absent, .table-status-badge.absent { background: rgba(122,31,31,0.6) !important; background-image: none !important; }
  .student-status.practicing-unscheduled, .student-status-compact.practicing-unscheduled, .status-badge.practicing-unscheduled, .table-status-badge.practicing-unscheduled { background: rgba(88,166,255,0.6) !important; background-image: none !important; }
  .student-status.excused, .student-status-compact.excused, .status-badge.excused, .table-status-badge.excused { background: rgba(139,95,34,0.55) !important; background-image: none !important; }
  .student-status.low-efficiency, .student-status-compact.low-efficiency, .status-badge.low-efficiency, .table-status-badge.low-efficiency { background: rgba(243,156,18,0.75) !important; background-image: none !important; }
  .student-status.pending, .student-status-compact.pending, .status-badge.pending, .table-status-badge.pending { background: rgba(108,117,125,0.55) !important; background-image: none !important; }
  .student-status.not-practicing, .student-status-compact.not-practicing, .status-badge.not-practicing, .table-status-badge.not-practicing { background: rgba(139,149,158,0.5) !important; background-image: none !important; }
  .student-status.weekend, .student-status-compact.weekend, .status-badge.weekend, .table-status-badge.weekend { background: rgba(139,149,158,0.5) !important; background-image: none !important; }
  .practice-duration, .practice-duration-large { background: rgba(155,89,182,0.55) !important; background-image: none !important; }
  
  /* 🔥 深色模式下所有状态标签的文字颜色统一为白色 */
  .student-status, .student-status-compact, .status-badge, .table-status-badge,
  .student-status.present, .student-status-compact.present, .status-badge.present, .table-status-badge.present,
  .student-status.absent, .student-status-compact.absent, .status-badge.absent, .table-status-badge.absent,
  .student-status.practicing-unscheduled, .student-status-compact.practicing-unscheduled, .status-badge.practicing-unscheduled, .table-status-badge.practicing-unscheduled,
  .student-status.excused, .student-status-compact.excused, .status-badge.excused, .table-status-badge.excused,
  .student-status.low-efficiency, .student-status-compact.low-efficiency, .status-badge.low-efficiency, .table-status-badge.low-efficiency,
  .student-status.pending, .student-status-compact.pending, .status-badge.pending, .table-status-badge.pending,
  .student-status.not-practicing, .student-status-compact.not-practicing, .status-badge.not-practicing, .table-status-badge.not-practicing,
  .student-status.weekend, .student-status-compact.weekend, .status-badge.weekend, .table-status-badge.weekend {
    color: #ffffff !important;
  }
  
  /* 移除任何由 gradient 变量带来的背景 */
  .student-status[class*="present"], .status-badge[class*="present"], .table-status-badge[class*="present"] { box-shadow: none !important; }
  
  /* 🔥 特别确保表格中的低效状态为橙色纯色背景 */
  .table-status-badge.low-efficiency {
    background: rgba(243,156,18,0.75) !important;
    background-image: none !important;
    color: #ffffff !important;
  }
  
  /* 同时确保所有其他使用 gradient-excused 的低效状态元素 */
  .status-badge.low-efficiency,
  .student-status.low-efficiency,
  .student-status-compact.low-efficiency {
    background: rgba(243,156,18,0.75) !important;
    background-image: none !important;
    color: #ffffff !important;
  }
  
  /* 最高优先级：确保表格状态标签的橙色 */
  .data-table .table-status-badge.low-efficiency,
  .data-table-container .table-status-badge.low-efficiency,
  table .table-status-badge.low-efficiency,
  tbody .table-status-badge.low-efficiency {
    background: rgba(243,156,18,0.8) !important;
    background-image: none !important;
    background-color: rgba(243,156,18,0.8) !important;
    color: #ffffff !important;
  }
}

/* 额外：如果仍有内联或更早定义的渐变，通过属性选择器兜底去除 */
[class*="status"], [class*="student-status"], [class*="status-badge"] {
  background-repeat: no-repeat;
}

/* 🔥 当前时间显示：纯文本样式，无背景无容器 */
.current-time-display {
  color: #666 !important;
  font-size: 14px !important;
  background: none !important;
  border: none !important;
  padding: 0 !important;
  margin: 0 !important;
  box-shadow: none !important;
}

/* 深色模式下的当前时间 */
@media (prefers-color-scheme: dark) {
  .current-time-display {
    color: #aaa !important;
  }
}

/* 确保当前时间所在的date-picker容器在移动端不影响时间显示 */
@media (max-width: 768px) {
  .date-picker {
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
  }
}

/* 🔥 统一最近七天考勤的文字样式，与练琴明细保持一致 */
.history-title {
  display: flex !important;
  align-items: center !important;
  gap: 8px !important;
  font-size: 1.2rem !important;
  font-weight: 600 !important;
  color: var(--text-color) !important;
  margin: 0 0 15px 0 !important;
}

/* 🔥 考勤时段标签增强显示效果 */
.time-slot-tag {
  background: #f8f9fa !important;
  color: #495057 !important;
  border: 1px solid #dee2e6 !important;
  padding: 4px 8px !important;
  margin: 2px 4px 2px 0 !important;
  border-radius: 4px !important;
  font-size: 0.85rem !important;
  font-weight: 500 !important;
  transition: all 0.2s ease !important;
}

.time-slot-tag:hover {
  background: #e9ecef !important;
  color: #212529 !important;
  border-color: #adb5bd !important;
}

/* 🔥 当前时间段高亮增强 */
.time-slot-tag.current {
  background: linear-gradient(135deg, #cfe2ff, #b6d4fe) !important;
  color: #084298 !important;
  border: 1px solid #0d6efd !important;
  padding: 6px 12px !important;
  border-radius: 16px !important;
  font-weight: 600 !important;
  font-size: 0.9rem !important;
  box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2) !important;
}

/* 🔥 深色模式下的考勤时段和练琴状态 */
@media (prefers-color-scheme: dark) {
  .time-slot-tag {
    background: #343a40 !important;
    color: #adb5bd !important;
    border: 1px solid #495057 !important;
  }
  
  .time-slot-tag:hover {
    background: #495057 !important;
    color: #f8f9fa !important;
    border-color: #6c757d !important;
  }
  
  .time-slot-tag.current {
    background: linear-gradient(135deg, #1e3a5f, #2c5282) !important;
    color: #cfe2ff !important;
    border: 1px solid #4dabf7 !important;
    box-shadow: 0 2px 4px rgba(77, 171, 247, 0.3) !important;
  }
}
</style>

<!-- 🔥 强制修复深色模式低效状态样式 -->
<style>
@media (prefers-color-scheme: dark) {
  .table-status-badge.low-efficiency {
    background: rgba(243,156,18,0.8) !important;
    background-color: rgba(243,156,18,0.8) !important;
    background-image: none !important;
    color: #ffffff !important;
  }
  
  /* 增加更高特异性的选择器 */
  .data-table .table-status-badge.low-efficiency,
  tbody .table-status-badge.low-efficiency,
  tr .table-status-badge.low-efficiency {
    background: rgba(243,156,18,0.8) !important;
    background-color: rgba(243,156,18,0.8) !important;
    background-image: none !important;
    color: #ffffff !important;
  }
}
</style>

<script>
// 🔥 强制修复深色模式下的低效状态样式
document.addEventListener('DOMContentLoaded', function() {
  function fixLowEfficiencyStyles() {
    console.log('执行低效状态样式修复...');
    
    // 检查是否为深色模式
    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    console.log('当前是否为深色模式:', isDarkMode);
    
    if (isDarkMode) {
      // 查找所有低效状态的表格标签
      const lowEfficiencyBadges = document.querySelectorAll('.table-status-badge.low-efficiency');
      console.log('找到低效状态标签数量:', lowEfficiencyBadges.length);
      
      lowEfficiencyBadges.forEach((badge, index) => {
        console.log(`修复第${index + 1}个低效状态标签:`, badge);
        badge.style.setProperty('background', 'rgba(243,156,18,0.8)', 'important');
        badge.style.setProperty('background-image', 'none', 'important');
        badge.style.setProperty('background-color', 'rgba(243,156,18,0.8)', 'important');
        badge.style.setProperty('color', '#ffffff', 'important');
        
        // 验证样式是否应用成功
        const computedStyle = window.getComputedStyle(badge);
        console.log(`第${index + 1}个标签最终背景色:`, computedStyle.backgroundColor);
      });
      
      // 同时处理可能的其他命名方式
      const altBadges = document.querySelectorAll('.table-status-badge.low_efficiency');
      console.log('找到备用命名的低效状态标签数量:', altBadges.length);
      
      altBadges.forEach((badge, index) => {
        console.log(`修复第${index + 1}个备用低效状态标签:`, badge);
        badge.style.setProperty('background', 'rgba(243,156,18,0.8)', 'important');
        badge.style.setProperty('background-image', 'none', 'important');
        badge.style.setProperty('background-color', 'rgba(243,156,18,0.8)', 'important');
        badge.style.setProperty('color', '#ffffff', 'important');
      });
    }
  }
  
  // 立即执行一次
  console.log('页面加载完成，开始修复样式...');
  fixLowEfficiencyStyles();
  
  // 延迟再执行一次，确保所有内容都已渲染
  setTimeout(() => {
    console.log('延迟执行样式修复...');
    fixLowEfficiencyStyles();
  }, 500);
  
  // 监听页面内容变化（如果使用动态加载）
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
        // 检查是否有新的表格状态标签
        const hasNewBadges = Array.from(mutation.addedNodes).some(node => 
          node.nodeType === 1 && (
            node.querySelector && node.querySelector('.table-status-badge') ||
            node.classList && node.classList.contains('table-status-badge')
          )
        );
        
        if (hasNewBadges) {
          console.log('检测到新的状态标签，重新执行修复...');
          setTimeout(fixLowEfficiencyStyles, 50);
        }
      }
    });
  });
  
  // 开始观察文档变化
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
  
  // 监听系统主题变化
  if (window.matchMedia) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function() {
      console.log('系统主题发生变化，重新执行修复...');
      setTimeout(fixLowEfficiencyStyles, 100);
    });
  }
});
</script>